# LEGO Catalog (каталог-lego)

Одностраничное веб‑приложение для локального просмотра и ведения собственной коллекции деталей, наборов и минифигурок LEGO.

- Каталог деталей/наборов/минифигурок
- Фильтры, сортировки, поиск
- Модальные карточки с изображениями, цветами и количеством в коллекции
- Коллекция пользователя (детали, наборы, минифигурки) хранится локально
- Полноэкранный просмотр изображений (image viewer)
- Импорт/экспорт коллекции в CSV
- Экспорт и «Поделиться» всей коллекцией (CSV-файл через Web Share API или скачивание)
  - «Поделиться» выбранными карточками (мультивыбор) с генерацией CSV
  - CSV включает дополнительные поля (темы наборов, категории деталей, цвета и пр.) для корректного последующего импорта
  - Текст шаринга содержит ссылку на сайт: https://zeka3535.github.io/LEGO-Part-Catalog/
- Мультивыбор карточек в коллекции и (опционально) в каталоге
  - Переключатели мультивыбора вынесены в Настройки → «Мультивыбор» (каталог/коллекция настраиваются отдельно)
  - В каталоге мультивыбор добавляет выбранные элементы в коллекцию (наборы и минифигурки — с полным инвентарём)
  - В коллекции мультивыбор удаляет выбранные элементы
  - Состояние мультивыбора кэшируется в localStorage
- Индикатор вертикальной прокрутки, прилегающий к правому краю (главный экран и модалки)
- Автозагрузка и разбиение CSV (Python‑утилита/EXE) — см. раздел «Загрузка CSV автоматически (Python-утилита)»
- Динамическая загрузка `inventory_parts_part_XXX.csv` (любое количество частей) и адаптивный прогресс загрузки
- Offline/кеширование через Service Worker, включая динамическое кэширование частей `inventory_parts_part_XXX.csv`
- Защита от случайного закрытия/перезагрузки (переключатель «Подтверждать перезагрузку/закрытие»)

## Демо и запуск

Приложение статическое и работает прямо из браузера. Достаточно открыть `index.html` в корне проекта. Для корректной работы некоторых браузеров и загрузки локальных CSV рекомендуется запускать через простой локальный сервер.

Примеры запуска локального сервера:

- Python 3
  ```bash
  python -m http.server 8080
  # затем открыть в браузере: http://localhost:8080/
  ```
- Node.js (serve)
  ```bash
  npx serve -p 8080 .
  # затем открыть: http://localhost:8080/
  ```

## Структура проекта

```
каталог-lego/
├── Data/                       # CSV и вспомогательные данные
│   ├── colors.csv
│   ├── parts.csv
│   ├── sets.csv
│   ├── themes.csv
│   ├── inventories.csv
│   ├── inventory_sets.csv
│   ├── inventory_minifigs.csv
│   └── inventory_parts_split/  # шардирование инвентарей деталей (кол-во частей динамическое)
├── rebrickable_downloader/     # Python-утилита для загрузки/разбивки CSV
│   ├── downloader.py
│   ├── splitter.py
│   ├── urls.py
│   ├── requirements.txt
│   └── README.md
├── dist/                       # артефакты сборки EXE (опционально)
│   └── rebrickable_downloader.exe
├── Downloads/                  # папка вывода по умолчанию для утилиты (создаётся при запуске)
│   └── rebrickable_YYYY-MM-DD_HH-MM-SS/
├── index.html                  # всё приложение (HTML + CSS + JS)
└── service-worker.js           # offline/кеширование (опционально)
```

## Источники данных

- Основной источник — локальные CSV из директории `Data/`.
- Дополнительно для отсутствующих изображений/деталей используются вызовы Rebrickable API.

Сайт не поддерживается и не утверждается Rebrickable. См. `https://rebrickable.com/api/`.

## Загрузка CSV автоматически (Python-утилита)

В репозитории есть утилита для автоматической загрузки свежих CSV с Rebrickable, распаковки и разбиения большого файла `inventory_parts.csv` на части.

- Папка: `rebrickable_downloader/`
- Результат: создаётся папка вида `rebrickable_YYYY-MM-DD_HH-MM-SS/` с CSV и `inventory_parts_split/` (части примерно по 20 МБ), плюс `parts_info.txt`.
- После успешного разбиения исходный `inventory_parts.csv` автоматически удаляется (чтобы не дублировать объём).

Запуск (Windows PowerShell):

```powershell
pip install -r rebrickable_downloader/requirements.txt
python -m rebrickable_downloader.downloader .\DataDownloads
```

- Если путь не указан, файлы попадут в `./Downloads/rebrickable_YYYY-MM-DD_HH-MM-SS/`.
- EXE-версия (если собрана):

```powershell
.\dist\rebrickable_downloader.exe .\DataDownloads
```

Опционально: сборка EXE у себя

```powershell
pip install pyinstaller
pyinstaller --clean --noconfirm --onefile --name rebrickable_downloader --icon favicon.ico rebrickable_downloader\downloader.py
```

## Динамическая загрузка частей `inventory_parts`

- Сайт больше не привязан к фиксированному числу файлов `inventory_parts_part_00N.csv`.
- В `index.html` части обнаруживаются автоматически:
  - сначала парсится `Data/inventory_parts_split/parts_info.txt`;
  - если файла нет, выполняется HEAD‑проверка последовательных имён `001..050` и берутся существующие.
- Индикатор прогресса подстраивается под фактическое количество частей.

### Сервис‑воркер

- `service-worker.js` кэширует части динамически при установке: сначала пытается прочитать `parts_info.txt`, при его отсутствии делает HEAD‑проверку.
- После обновления репозитория рекомендуется перезагрузить страницу (иногда дважды) для активации нового Service Worker.

## Переменные/ключи API

Для более устойчивой работы при дозагрузке отсутствующих данных используется массив ключей API Rebrickable. Ключи задаются в `index.html` в константе `REBRICKABLE_API_KEYS`. По умолчанию проект может работать только на локальных CSV; API используется ограниченно (например, для отдельных изображений/деталей, когда их нет в CSV).

```js
// В index.html (фрагмент)
const REBRICKABLE_API_URL = 'https://rebrickable.com/api/v3';
const REBRICKABLE_API_KEYS = [
  // Добавьте свои ключи API (один или несколько)
  // 'YOUR_REBRICKABLE_API_KEY'
];
```

Если не указывать ключи, приложение продолжит работать на локальных данных, но некоторые дополнительные функции (например, дозагрузка отдельных изображений) могут быть недоступны.

## Режимы и возможности

- Каталог: просмотр деталей/наборов/минифигурок, поиск, сортировка
- Коллекция: управление собственной коллекцией, фильтры (включая цвета), импорт/экспорт CSV
- Модальные окна: управление количеством, цвета деталей, быстрые переходы
- Инвентари наборов и минифигурок, клики по элементам инвентаря открывают соответствующие карточки
- Мультивыбор: пакетные операции удаления (в коллекции) и добавления (в каталоге)
- Полноэкранный просмотр изображений

## Предупреждение при закрытии/перезагрузке

- В настройках есть переключатель «Подтверждать перезагрузку/закрытие».
- По умолчанию включено, состояние сохраняется в `localStorage` (`preventAccidentalExit`).
- При активной опции браузер перед закрытием/обновлением вкладки покажет стандартный диалог подтверждения, чтобы избежать случайной потери незаписанных изменений.
- Примечание: при обновлении Service Worker (после публикации новых файлов) может появиться диалог подтверждения один раз при перезагрузке.

## Импорт/экспорт CSV

В настройках доступен импорт и экспорт коллекции. Экспорт формирует CSV-файл с текущими данными коллекции пользователя. Импорт объединяет данные с существующей коллекцией (не перезаписывает полностью, а агрегирует).

## Разработка

В проекте всё собрано в `index.html` (HTML/CSS/JS). Рекомендуемый рабочий процесс:

1. Запуск локального сервера (см. выше)
2. Открыть `index.html` в браузере
3. Вносить изменения и проверять сразу в UI

### Линтинг/форматирование
Так как проект без сборки, линтеры не настроены. Следуем существующему стилю кода и форматированию.

## Offline/кеширование

`service-worker.js` может использоваться для кеширования статических ресурсов (иконки, CSV) и офлайн-режима. По умолчанию может быть отключён, так как потребности зависят от окружения.

## Известные ограничения

- Работа напрямую с локальными CSV зависит от настроек браузера (рекомендуется запускать через локальный сервер).
- API Rebrickable имеет лимиты запросов; в коде предусмотрены задержки/повторные попытки и ротация ключей, но при большом количестве операций возможны паузы.
- Необходима очистка кэша после каждого обновления .html файлов в репозитории.

## Лицензия

Этот проект предоставляется «как есть» для личного использования. Все торговые марки LEGO® принадлежат The LEGO Group. Проект не аффилирован с The LEGO Group или Rebrickable.

