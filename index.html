<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>LEGO Catalog</title>

  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="shortcut icon" href="favicon.ico">
  <meta name="msapplication-TileColor" content="#1a202c">
  <meta name="theme-color" content="#1a202c">

  <meta property="og:title" content="LEGO Catalog">
  <meta property="og:description" content="–°–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∏–∑–∞—Ü–∏–∏ –≤–∞—à–µ–π –ª–∏—á–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ LEGO. –í–∫–ª—é—á–∞–µ—Ç –¥–µ—Ç–∞–ª–∏, –Ω–∞–±–æ—Ä—ã –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –≤ –µ–¥–∏–Ω–æ–º —É–¥–æ–±–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.">
  <meta property="og:image" content="ogimage.png">
  <meta property="og:type" content="website">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
    window.remoteStorageAvailable = false;
    window.zxingAvailable = false;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º RemoteStorage —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    window.loadRemoteStorage = async function() {
      if (window.remoteStorageAvailable) {
        console.log('‚úÖ RemoteStorage already loaded');
        return true;
      }
      
      try {
        console.log('üîÑ Loading RemoteStorage library...');
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/remotestoragejs/release/remotestorage.js';
        script.async = true;
        script.crossOrigin = 'anonymous';
        document.head.appendChild(script);
        
        await new Promise((resolve, reject) => {
          const timeout = setTimeout(() => {
            reject(new Error('RemoteStorage loading timeout'));
          }, 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
          
          script.onload = () => {
            clearTimeout(timeout);
            window.remoteStorageAvailable = true;
            console.log('‚úÖ RemoteStorage library loaded successfully');
            resolve();
          };
          script.onerror = (error) => {
            clearTimeout(timeout);
            reject(error);
          };
        });
        
        return true;
      } catch (e) {
        console.warn('‚ö†Ô∏è RemoteStorage not loaded, using fallback:', e);
        window.remoteStorageAvailable = false;
        return false;
      }
    };
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º ZXing —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    window.loadZXing = async function() {
      if (window.zxingAvailable) return;
      try {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/@zxing/library@latest/umd/index.min.js';
        script.async = true;
        document.head.appendChild(script);
        await new Promise((resolve, reject) => {
          script.onload = () => {
            window.zxingAvailable = true;
            resolve();
          };
          script.onerror = reject;
        });
      } catch (e) {
        console.warn('‚ö†Ô∏è ZXing not loaded');
      }
    };
  </script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
            'mono': ['JetBrains Mono', 'SF Mono', 'Monaco', 'Cascadia Code', 'Roboto Mono', 'Consolas', 'Courier New', 'monospace'],
          },
          letterSpacing: {
            'tighter': '-0.05em',
            'tight': '-0.025em',
            'normal': '0em',
            'wide': '0.025em',
            'wider': '0.05em',
            'widest': '0.1em',
          }
        }
      }
    }
  </script>

      <style>
    /* –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ ¬´—Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ¬ª –∏ pull-to-refresh */
    html, body {
        overscroll-behavior-y: contain;
        overscroll-behavior-x: none;
    }
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        /* –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è */
        touch-action: manipulation;
        font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    /* –ö–ª–∞—Å—Å –¥–ª—è –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–æ—Ç–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ—Ç–µ–∫–∞–Ω–∏–µ –∂–µ—Å—Ç–æ–≤) */
    .scrollable {
        overscroll-behavior: contain;
        touch-action: pan-y;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    @media (max-width: 768px) {
        body {
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
    }
    
    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –∫—Ä—É–ø–Ω—ã—Ö —Å–µ–∫—Ü–∏–π */
    .content-section {
        content-visibility: auto;
        contain-intrinsic-size: 0 500px;
    }
    
    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    .modal-content {
        content-visibility: auto;
        contain-intrinsic-size: 0 400px;
    }
    
    /* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ */
    .list-container {
        content-visibility: auto;
        contain-intrinsic-size: 0 300px;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏ */
    @keyframes pulse {
        0% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.2);
            opacity: 0.7;
        }
        100% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 768px) {
        .scanner-video {
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */
    #scanner-video {
        /* –†–∞–∑–º–µ—Ä—ã —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Tailwind –∫–ª–∞—Å—Å—ã */
        object-fit: cover;
        border-radius: 18px;
    }
    
    #scanner-canvas {
        /* –†–∞–∑–º–µ—Ä—ã —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Tailwind –∫–ª–∞—Å—Å—ã */
        border-radius: 18px;
    }
    
    #scanner-placeholder {
        /* –†–∞–∑–º–µ—Ä—ã —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Tailwind –∫–ª–∞—Å—Å—ã */
        border-radius: 18px;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - —Ä–∞–∑–º–µ—Ä—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Tailwind –∫–ª–∞—Å—Å—ã */
    /* @media (max-width: 480px) - —Ä–∞–∑–º–µ—Ä—ã —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Tailwind –∫–ª–∞—Å—Å—ã w-64 h-64 sm:w-80 sm:h-80 */
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ - —Ä–∞–∑–º–µ—Ä—ã —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Tailwind –∫–ª–∞—Å—Å—ã */
    /* @media (max-width: 360px) - —Ä–∞–∑–º–µ—Ä—ã —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Tailwind –∫–ª–∞—Å—Å—ã w-64 h-64 sm:w-80 sm:h-80 */
    
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    #search-input::-webkit-search-cancel-button {
        -webkit-appearance: none;
        appearance: none;
        display: none;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–æ–∏—Å–∫–∞ –∏ AI –∫–∞–º–µ—Ä—ã - –¥–µ–ª–∞–µ–º –∫—Ä—É–≥–ª—ã–º–∏ */
    #search-button,
    #ai-search-button {
        height: 40px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–æ–∫ */
        min-height: 40px;
        width: 40px; /* –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫—Ä—É–≥–ª—ã–º–∏ */
        min-width: 40px;
        border-radius: 50%; /* –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫—Ä—É–≥–ª—ã–º–∏ */
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∂–∞—Ç–∏–µ */
        padding: 0; /* –£–±–∏—Ä–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        background-color: #4b5563; /* bg-gray-600 */
        border: none;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    #search-button:hover,
    #ai-search-button:hover {
        background-color: #6b7280; /* bg-gray-500 */
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    #search-button:active,
    #ai-search-button:active {
        transform: scale(0.95);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –¥–µ–ª–∞–µ–º –∫—Ä—É–≥–ª–æ–π */
    #filter-button {
        height: 40px;
        min-height: 40px;
        width: 40px;
        min-width: 40px;
        border-radius: 50%; /* –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –∫—Ä—É–≥–ª–æ–π */
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∂–∞—Ç–∏–µ */
        padding: 0; /* –£–±–∏—Ä–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        background-color: #4b5563; /* bg-gray-600 */
        border: none;
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    #filter-button:hover {
        background-color: #6b7280; /* bg-gray-500 */
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    #filter-button:active {
        transform: scale(0.95);
    }
    
    /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–æ–∫ */
    #search-button.hidden,
    #ai-search-button.hidden,
    #clear-search.hidden,
    #search-icon.hidden {
        display: none !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–∫–∏ –ø–æ–∏—Å–∫–∞ */
    #search-icon {
        height: 40px;
        min-height: 40px;
        width: 40px;
        min-width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none; /* –ù–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–∫–∏ */
    }
    
    #clear-search {
        height: 40px;
        min-height: 40px;
        width: 40px; /* –®–∏—Ä–∏–Ω–∞ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ */
        min-width: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∂–∞—Ç–∏–µ */
        right: 0;
        top: 0;
        bottom: 0;
    }
    
    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
    #search-input {
        height: 40px; /* –¢–∞–∫–∞—è –∂–µ –≤—ã—Å–æ—Ç–∞ –∫–∞–∫ —É –∫–Ω–æ–ø–æ–∫ */
        min-height: 40px;
        box-sizing: border-box;
        padding-top: 0.5rem; /* 8px */
        padding-bottom: 0.5rem; /* 8px */
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –ø–æ–∏—Å–∫–∞ */
    .flex.items-center.space-x-2.w-full.max-w-sm {
        align-items: center; /* –í–æ–∑–≤—Ä–∞—â–∞–µ–º center –≤–º–µ—Å—Ç–æ stretch */
    }
    
    /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    .card-image-container {
        border-bottom-left-radius: 18px;
        border-bottom-right-radius: 18px;
    }
    
    /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ –±–ª–æ–∫–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    .card-info-container {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è –ø–∞–ø–æ–∫ –¥–µ—Ç–∞–ª–µ–π */
    .folder-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    
    /* –ù–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–¥–æ 640px) - –º–∏–Ω–∏–º—É–º 2 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —à–∏—Ä–∏–Ω—É */
    @media (max-width: 640px) {
        .folder-grid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ç–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞ */
    h1, h2, h3, h4, h5, h6 {
        line-height: 1.2;
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    .card-title {
        line-height: 1.3;
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
    p, span, div {
        line-height: 1.5;
        text-rendering: optimizeLegibility;
    }
    
    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    .main-title {
        line-height: 1.1;
    }
    
    /* –ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö */
    .font-mono, code, pre {
        font-weight: 500;
        letter-spacing: 0.025em;
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —á–∏—Ç–∞–µ–º–æ—Å—Ç—å –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ */
    p, span, div {
        line-height: 1.5;
        text-rendering: optimizeLegibility;
    }
    
    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    .main-title {
        font-weight: 800;
        letter-spacing: -0.05em;
        line-height: 1.1;
    }
    
    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–¥–æ 480px) - –º–∏–Ω–∏–º—É–º 2 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —à–∏—Ä–∏–Ω—É */
    @media (max-width: 480px) {
        .folder-grid {
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        }
    }
    

    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–µ—Ç–∞–ª–µ–π */
    .parts-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    
    /* –ù–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–¥–æ 640px) - –º–∏–Ω–∏–º—É–º 2 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —à–∏—Ä–∏–Ω—É */
    @media (max-width: 640px) {
        .parts-grid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }
    }
    
    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–¥–æ 480px) - –º–∏–Ω–∏–º—É–º 2 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —à–∏—Ä–∏–Ω—É */
    @media (max-width: 480px) {
        .parts-grid {
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        }
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ */
    .sets-minifigs-grid {
        display: grid;
        gap: 1rem;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    }
    
    /* –ù–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–¥–æ 640px) - –º–∏–Ω–∏–º—É–º 2 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —à–∏—Ä–∏–Ω—É */
    @media (max-width: 640px) {
        .sets-minifigs-grid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }
    }
    
    /* –ù–∞ –æ—á–µ–Ω—å –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö (–¥–æ 480px) - –º–∏–Ω–∏–º—É–º 2 –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ —à–∏—Ä–∏–Ω—É */
    @media (max-width: 480px) {
        .sets-minifigs-grid {
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        }
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    .card-info-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* –ù–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –¥–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç –µ—â–µ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º */
    @media (max-width: 480px) {
        .card-info-text {
            font-size: 0.65rem;
        }
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫ */
.card-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
.truncate {
    white-space: normal;
    word-wrap: break-word;
    word-break: break-word;
    line-height: 1.2;
    overflow-wrap: break-word;
}

/* –ù–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –¥–µ–ª–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏ */
@media (max-width: 480px) {
    .card-title {
        font-size: 0.75rem;
        line-height: 1.2;
    }
    
    /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∑–∞–≥–æ–ª–æ–≤–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ */
    .truncate {
        white-space: normal;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
    }
}

/* –ù–∞ —Å—Ä–µ–¥–Ω–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö (–ø–ª–∞–Ω—à–µ—Ç—ã) –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ */
@media (min-width: 481px) and (max-width: 768px) {
    .truncate {
        white-space: normal;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
    }
}

/* –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –¥–µ—Ç–∞–ª–∏ */
.color-palette-container {
    max-height: 13rem; /* —É–≤–µ–ª–∏—á–µ–Ω–æ –¥–ª—è –∑–∞–∑–æ—Ä–∞ —Å–Ω–∏–∑—É, –±—ã–ª–æ 12rem (192px) */
    overflow-y: auto;
    /* –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã—Ö —É–≥–ª–æ–≤ –∏ –∑–∞–∑–æ—Ä–∞ –æ—Ç –∫—Ä—É–∂–∫–æ–≤ */
    padding-bottom: 0.75rem; /* –±—ã–ª–æ 0.5rem */
    /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã—Ö —É–≥–ª–æ–≤ */
    border-bottom-left-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
}

/* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –Ω–∏–∂–Ω–∏—Ö —É–≥–ª–æ–≤ –±–ª–æ–∫–∞ –ø–∞–ª–∏—Ç—Ä—ã */
.color-palette-wrapper {
    border-bottom-left-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
    /* –ö–ª–∏–ø —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ, —á—Ç–æ–±—ã –∫—Ä—É–∂–∫–∏ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–∏ –∑–∞ –∫—Ä–∞–π –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
    overflow: hidden;
}

/* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –Ω–∏–∂–Ω–∏—Ö —É–≥–ª–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π */
.color-palette-container {
    border-bottom-left-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
}

/* –°–∫—Ä—É–≥–ª–µ–Ω–∏–µ –Ω–∏–∂–Ω–∏—Ö —É–≥–ª–æ–≤ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ü–≤–µ—Ç–∞–º–∏ */
.color-palette-inner {
    border-bottom-left-radius: 0.5rem;
    border-bottom-right-radius: 0.5rem;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ */
.color-palette-gradient {
    border-bottom-left-radius: 18px;
    border-bottom-right-radius: 18px;
    /* –ì—Ä–∞–¥–∏–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–∞–ª–∏—Ç—Ä—ã */
    z-index: 20;
}

/* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–∞–ª–∏—Ç—Ä—ã —Ü–≤–µ—Ç–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –¥–æ 3 —Ä—è–¥–æ–≤ (—Å –Ω–µ–±–æ–ª—å—à–∏–º –∑–∞–∑–æ—Ä–æ–º —Å–Ω–∏–∑—É) */
@media (max-width: 768px) {
    .color-palette-container {
        max-height: 8rem; /* –±—ã–ª–æ 7.5rem; –¥–æ–±–∞–≤–ª–µ–Ω –∑–∞–∑–æ—Ä —Å–Ω–∏–∑—É */
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤ –ø–∞–ª–∏—Ç—Ä–µ —Ü–≤–µ—Ç–æ–≤ */
.indicator-white {
    width: 0.5rem;
    height: 0.5rem;
    background-color: white;
    border-radius: 9999px;
}

.indicator-white-with-border {
    width: 0.5rem;
    height: 0.5rem;
    background-color: white;
    border-radius: 9999px;
    border: 1px solid black;
    box-shadow: 0 0 0 1px black;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–Ω–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
.bg-gradient-to-r {
    background: linear-gradient(to right, var(--tw-gradient-stops));
}

/* –°—Ç–∏–ª–∏ –¥–ª—è drag-and-drop –≤ —Å–ø–∏—Å–∫–∞—Ö –∂–µ–ª–∞–Ω–∏–π */
.wishlist-item {
    transition: all 0.2s ease-out;
}

.wishlist-item:hover {
    transform: translateY(-6px) scale(1.03) !important;
    box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.08) !important;
}

.wishlist-item:active {
    transform: scale(0.98);
}

.wishlist-drop-zone {
    transition: all 0.2s ease-out;
}

.wishlist-drop-zone.drag-over {
    background-color: rgba(245, 158, 11, 0.05) !important;
}

.wishlist-folder.drag-over {
    border-color: #f59e0b !important;
    background-color: rgba(245, 158, 11, 0.05) !important;
}

/* –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ - —Ç–µ–ø–µ—Ä—å –≤ –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
.wishlist-move-buttons {
    display: flex;
    flex-direction: row;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 10;
}

.wishlist-item:hover .wishlist-move-buttons {
    opacity: 1;
}

/* –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
@media (max-width: 768px) {
    .wishlist-move-buttons {
        opacity: 1;
    }
}

.wishlist-move-btn {
    width: 24px;
    height: 24px;
    border: 1px solid rgba(55, 65, 81, 0.5); /* border-gray-700/50 */
    border-radius: 18px;
    background: rgba(17, 24, 39, 0.4);
    color: rgba(255, 255, 255, 0.8);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    font-size: 0.875rem;
    font-weight: bold;
    backdrop-filter: blur(4px);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.wishlist-move-btn:hover {
    background: rgba(17, 24, 39, 0.6);
    color: white;
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    border-color: rgba(75, 85, 99, 0.7); /* border-gray-600/70 */
}

.wishlist-move-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    transform: none;
    background: rgba(17, 24, 39, 0.2);
    border-color: rgba(55, 65, 81, 0.2); /* border-gray-700/20 */
}

.wishlist-move-btn:disabled:hover {
    background: rgba(17, 24, 39, 0.2);
    color: rgba(255, 255, 255, 0.3);
    transform: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    border-color: rgba(55, 65, 81, 0.2); /* border-gray-700/20 */
}

.wishlist-move-btn.opacity-50 {
    opacity: 0.5;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
.wishlist-item .remove-from-wishlist {
    transition: all 0.2s ease-out;
}

.wishlist-item:hover .remove-from-wishlist {
    opacity: 1;
    transform: scale(1.1);
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π */
@keyframes wishlistItemAppear {
    from {
        opacity: 0;
        transform: translateY(20px) scale(0.9);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

.wishlist-item {
    animation: wishlistItemAppear 0.4s ease-out;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π */
.wishlist-empty-state {
    background: linear-gradient(135deg, rgba(55, 65, 81, 0.3), rgba(75, 85, 99, 0.2));
    border: 2px dashed rgba(156, 163, 175, 0.4);
    border-radius: 18px;
    transition: all 0.3s ease;
}

.wishlist-empty-state:hover {
    border-color: rgba(234, 179, 8, 0.6);
    background: linear-gradient(135deg, rgba(234, 179, 8, 0.1), rgba(251, 191, 36, 0.05));
}

/* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
.wishlist-item {
    transition: all 0.3s ease;
}

/* Hover —ç—Ñ—Ñ–µ–∫—Ç—ã –∫–∞–∫ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ */
.wishlist-item:hover {
    transform: translateY(-6px) scale(1.03) !important;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1) !important;
}

/* –û—Ç–∫–ª—é—á–∞–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
@media (max-width: 768px) {
    .wishlist-item:hover {
        transform: none !important;
        box-shadow: none !important;
    }
}

/* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
@keyframes moveUp {
    0% { 
        transform: translateY(0) scale(1);
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    50% { 
        transform: translateY(-60px) scale(1.05);
        z-index: 100;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    }
    100% { 
        transform: translateY(0) scale(1);
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
}

@keyframes moveDown {
    0% { 
        transform: translateY(0) scale(1);
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    50% { 
        transform: translateY(60px) scale(1.05);
        z-index: 100;
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    }
    100% { 
        transform: translateY(0) scale(1);
        z-index: 100;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
}

/* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ —Å–¥–≤–∏–≥–∞—é—Ç—Å—è –≤ —Å—Ç–æ—Ä–æ–Ω—É */
@keyframes slideLeft {
    0% { 
        transform: translateX(0) scale(1);
        opacity: 1;
        z-index: 1;
    }
    50% { 
        transform: translateX(-60px) scale(0.98);
        opacity: 0.9;
        z-index: 1;
    }
    100% { 
        transform: translateX(0) scale(1);
        opacity: 1;
        z-index: 1;
    }
}

@keyframes slideRight {
    0% { 
        transform: translateX(0) scale(1);
        opacity: 1;
        z-index: 1;
    }
    50% { 
        transform: translateX(60px) scale(0.98);
        opacity: 0.9;
        z-index: 1;
    }
    100% { 
        transform: translateX(0) scale(1);
        opacity: 1;
        z-index: 1;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –æ—Ç–∫–ª—é—á–µ–Ω—ã - –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∞ */

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±—Ä–µ–π–∫–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ª—É—á—à–µ–π –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
@media (min-width: 475px) {
    .xs\:grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
    }
}

/* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π - —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω */
.wishlist-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    backdrop-filter: blur(10px);
}

.wishlist-item:hover {
    transform: translateY(-4px) scale(1.02) !important;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1) !important;
    border-color: rgba(156, 163, 175, 0.3) !important;
}

/* –û—Ç–∫–ª—é—á–∞–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
@media (max-width: 768px) {
    .wishlist-item:hover {
        transform: none !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–∫–∏ —Ç–∏–ø–∞ */
.wishlist-item .absolute:first-child {
    transition: transform 0.2s ease;
}

.wishlist-item:hover .absolute:first-child {
    transform: scale(1.05);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è */
.wishlist-item button[data-action="remove-from-wishlist"] {
    transition: all 0.2s ease;
    backdrop-filter: blur(4px);
}

.wishlist-item button[data-action="remove-from-wishlist"]:hover {
    transform: scale(1.05);
}

/* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
@media (max-width: 768px) {
    .wishlist-item button[data-action="remove-from-wishlist"] {
        opacity: 1 !important;
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è */
.wishlist-move-btn {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(4px);
    border: 1px solid rgba(55, 65, 81, 0.5); /* border-gray-700/50 */
}

.wishlist-move-btn:hover:not(:disabled) {
    transform: scale(1.1);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    border-color: rgba(75, 85, 99, 0.7); /* border-gray-600/70 */
}

.wishlist-move-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
    transform: none !important;
    border-color: rgba(55, 65, 81, 0.2); /* border-gray-700/20 */
}


/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ */
.export-wishlist {
    min-width: 32px;
    min-height: 32px;
    flex-shrink: 0;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ */
.import-wishlist {
    min-width: 32px;
    min-height: 32px;
    flex-shrink: 0;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞ */
@media (max-width: 640px) {
    .export-wishlist {
        padding: 0.375rem 0.5rem;
        min-width: 28px;
        min-height: 28px;
        font-size: 0.75rem;
    }
    
    .export-wishlist span:first-child {
        margin-right: 0.25rem;
    }
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ */
@media (max-width: 640px) {
    .import-wishlist {
        padding: 0.375rem 0.5rem;
        min-width: 28px;
        min-height: 28px;
        font-size: 0.75rem;
    }
    
    .import-wishlist span:first-child {
        margin-right: 0.25rem;
    }
}

@media (min-width: 640px) and (max-width: 768px) {
    .export-wishlist {
        padding: 0.5rem 0.75rem;
        min-width: 32px;
        min-height: 32px;
    }
    
    .import-wishlist {
        padding: 0.5rem 0.75rem;
        min-width: 32px;
        min-height: 32px;
    }
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ hover —ç—Ñ—Ñ–µ–∫—Ç—ã */
.export-wishlist:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.export-wishlist:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

.import-wishlist:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.import-wishlist:active {
    transform: translateY(0);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

/* –û—Ç–∫–ª—é—á–∞–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
@media (max-width: 768px) {
    .wishlist-item:hover {
        transform: none !important;
        box-shadow: none !important;
    }
}

.from-blue-400 {
    --tw-gradient-from: #60a5fa;
    --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(96, 165, 250, 0));
}

.via-blue-500 {
    --tw-gradient-stops: var(--tw-gradient-from), #3b82f6, var(--tw-gradient-to, rgba(59, 130, 246, 0));
}

.to-blue-600 {
    --tw-gradient-to: #2563eb;
}

.bg-clip-text {
    background-clip: text;
    -webkit-background-clip: text;
}

.text-transparent {
    color: transparent;
}

/* –û—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –±–ª–æ–∫–∞–º–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –¥–µ—Ç–∞–ª–∏ */
.modal-section-spacing {
    margin-bottom: 1.5rem; /* 24px */
}

/* –û—Ç—Å—Ç—É–ø—ã –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö —Å–µ–∫—Ü–∏–π */
.modal-section-title {
    margin-bottom: 0.75rem; /* 12px */
}
    
    /* –ò—Å–ø—Ä–∞–≤–ª—è–µ–º layout –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    @media (max-width: 640px) {
        .flex.justify-between.items-center.gap-4 {
            gap: 1rem !important;
        }
    }
    
    /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –≤—ã—Å–æ—Ç—É –¥–ª—è –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –ø–∞–Ω–µ–ª–∏ –ø–æ–∏—Å–∫–∞ */
    #search-input,
    #search-button,
    #ai-search-button,
    #filter-button {
        box-sizing: border-box;
    }
    
    /* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –ø–æ–ª–µ–º –ø–æ–∏—Å–∫–∞ –∏ –∫–Ω–æ–ø–∫–∞–º–∏ */
    .flex.items-center.space-x-2 > * + * {
        margin-left: 0.5rem !important; /* 8px - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ space-x-2 */
    }
    
    /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    @media (max-width: 640px) {
        /* –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ max-w-sm –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        .flex.items-center.space-x-2.w-full.max-w-sm {
            max-width: none !important;
            width: 100% !important;
        }
        
        /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ */
        .flex.items-center.space-x-2.w-full.max-w-sm .relative.flex-grow {
            flex-grow: 1 !important;
            min-width: 0 !important;
        }
        
        /* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        .flex.items-center.space-x-2 > * + * {
            margin-left: 0.5rem !important;
        }
        
        /* –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã –∫–Ω–æ–ø–∫–∏ sidebar-toggle –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        .sidebar-toggle-btn {
            margin-left: -0.5rem !important; /* –ü–µ—Ä–µ–º–µ—â–∞–µ–º –±–ª–∏–∂–µ –∫ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
            margin-right: 1rem !important;
        }
        
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã —É –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
        .flex.items-center h1 {
            margin-left: 0 !important;
        }
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    @media (max-width: 640px) {
        #search-input {
            font-size: 13px;
        }
    }
    
    @media (max-width: 480px) {
        #search-input {
            font-size: 12px;
        }
    }
    
    /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 640px) {
        #search-button,
        #ai-search-button {
            height: 40px;
            min-height: 40px;
            width: 40px;
            min-width: 40px;
            border-radius: 50%;
        }
        
        #filter-button {
            height: 40px;
            min-height: 40px;
            width: 40px;
            min-width: 40px;
            border-radius: 50%;
        }
        
        #clear-search {
            height: 40px;
            min-height: 40px;
            width: 36px;
            min-width: 36px;
        }
        
        /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–∞–≤—ã–π –æ—Ç—Å—Ç—É–ø –ø–æ–ª—è –≤–≤–æ–¥–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ */
        #search-input {
            padding-right: 2.5rem; /* 40px - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ */
        }
    }
    
    .checkerboard {
        background-image: linear-gradient(45deg, #374151 25%, transparent 25%), 
                          linear-gradient(-45deg, #374151 25%, transparent 25%), 
                          linear-gradient(45deg, transparent 75%, #374151 75%), 
                          linear-gradient(-45deg, transparent 75%, #374151 75%);
        background-size: 8px 8px;
        background-position: 0 0, 0 4px, 4px -4px, -4px 0;
    }
    
    .modal-hidden {
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }
    
    .viewer-hidden {
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    .modal-close-btn {
        position: relative;
        width: 32px;
        height: 32px;
        background: #dc2626;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .modal-close-btn:hover {
        background: #b91c1c;
        transform: scale(1.1) rotate(2deg);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    
    .modal-close-btn:active {
        transform: scale(0.95) rotate(0deg);
    }
    
    .modal-close-btn svg {
        width: 16px;
        height: 16px;
        stroke-width: 2.5;
        transition: transform 0.3s ease;
    }
    
    .modal-close-btn:hover svg {
        transform: scale(1.1);
    }
    
    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    .modal-close-btn.lg\:hidden {
        background: transparent;
        color: #6b7280;
        box-shadow: none;
        border: none;
        width: 40px;
        height: 40px;
    }
    
    .modal-close-btn.lg\:hidden:hover {
        background: transparent;
        color: #9ca3af;
        transform: none;
    }
    
    .modal-close-btn.lg\:hidden svg {
        width: 24px;
        height: 24px;
        stroke-width: 2;
        transition: color 0.2s ease;
    }
    
    .modal-close-btn.lg\:hidden:hover svg {
        transform: none;
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    @media (min-width: 1024px) {
        .modal-close-btn.lg\:hidden {
            display: none !important;
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    .sidebar-toggle-btn {
        position: relative;
        width: 48px;
        height: 48px;
        background: transparent;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        transition: color 0.2s ease;
        cursor: pointer;
        margin-right: 1rem;
        margin-left: -0.5rem; /* –ü–µ—Ä–µ–º–µ—â–∞–µ–º –±–ª–∏–∂–µ –∫ –ª–µ–≤–æ–º—É –∫—Ä–∞—é */
        border-radius: 18px;
        padding: 12px;
    }
    
    .sidebar-toggle-btn:hover {
        color: #9ca3af;
        background: rgba(107, 114, 128, 0.1);
        transform: none;
    }
    
    .sidebar-toggle-btn:active {
        transform: scale(0.95);
        background: rgba(107, 114, 128, 0.2);
    }
    
    .sidebar-toggle-btn svg {
        width: 24px;
        height: 24px;
        stroke-width: 2.5;
        transition: color 0.2s ease;
    }
    
    .sidebar-toggle-btn:hover svg {
        transform: none;
    }
    
    .sidebar-toggle-btn:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        background: rgba(107, 114, 128, 0.1);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è */
    .modal-close-btn:not(.lg\:hidden) {
        animation: buttonAppear 0.4s ease-out;
    }
    /* –í –º–æ–¥–∞–ª–∫–∞—Ö –æ—Ç–∫–ª—é—á–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö */
    #minifig-modal-content .modal-close-btn:not(.animate-once),
    #set-modal-content .modal-close-btn {
        animation: none !important;
    }
    
    /* –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ –Ω–∞–±–æ—Ä–∞ */
    #set-modal-close {
        animation: none !important;
    }
    
  
    .sidebar-hint-close {
        animation: buttonAppear 0.4s ease-out 0.2s both;
    }
    
    @keyframes buttonAppear {
        0% {
            opacity: 0;
            transform: scale(0.8) rotate(-10deg);
        }
        50% {
            transform: scale(1.05) rotate(2deg);
        }
        100% {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }
    }
    
    /* –ü—É–ª—å—Å–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ sidebar-toggle –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –ø–æ–∫–∞–∑–µ */
    .sidebar-toggle-btn.pulse {
        animation: buttonPulse 1s ease-in-out infinite;
    }
    
    @keyframes buttonPulse {
        0%, 100% {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 0 0 rgba(107, 114, 128, 0.7);
        }
        50% {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 0 0 10px rgba(107, 114, 128, 0);
        }
    }
    
    .loader {
        border: 4px solid #4a5568;
        border-top: 4px solid #4299e1;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    
    @keyframes scaleIn {
        from { 
            opacity: 0; 
            transform: scale(0.9) translateY(10px); 
        }
        to { 
            opacity: 1; 
            transform: scale(1) translateY(0); 
        }
    }
    
    @keyframes scaleOut {
        from { 
            opacity: 1; 
            transform: scale(1) translateY(0); 
        }
        to { 
            opacity: 0; 
            transform: scale(0.9) translateY(-10px); 
        }
    }
    
    /* –£–±—Ä–∞–ª–∏ @keyframes –¥–ª—è backdrop, —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º transition */
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —É–∫–∞–∑–∞—Ç–µ–ª—è sidebar-toggle */
    .sidebar-hint {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        color: white;
        padding: 20px 24px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.5;
        text-align: center;
        z-index: 1000;
        max-width: 320px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(59, 130, 246, 0.1);
        animation: hintFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: auto;
        border: 1px solid rgba(59, 130, 246, 0.2);
        backdrop-filter: blur(10px);
    }
    
    .sidebar-hint::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
        border-radius: 18px;
        z-index: -1;
    }
    
    .sidebar-hint::after {
        content: '';
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-bottom: 10px solid #1f2937;
        filter: drop-shadow(0 -2px 4px rgba(0, 0, 0, 0.3));
    }
    
    .sidebar-hint-icon {
        display: inline-block;
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        border-radius: 18px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        animation: iconPulse 2s ease-in-out infinite;
    }
    
    .sidebar-hint-title {
        font-size: 16px;
        font-weight: 600;
        color: #f3f4f6;
        margin-bottom: 8px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .sidebar-hint-text {
        color: #d1d5db;
        font-size: 13px;
        line-height: 1.4;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }
    
    .sidebar-hint-close {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        background: #6b7280;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        font-size: 14px;
        font-weight: bold;
        line-height: 1;
    }
    
    .sidebar-hint-close:hover {
        background: #4b5563;
        transform: scale(1.1) rotate(2deg);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    
    .sidebar-hint-close:active {
        transform: scale(0.95) rotate(0deg);
    }
    
    @keyframes hintFadeIn {
        from { 
            opacity: 0; 
            transform: translate(-50%, -50%) scale(0.9) translateY(10px);
        }
        to { 
            opacity: 1; 
            transform: translate(-50%, -50%) scale(1) translateY(0);
        }
    }
    
    @keyframes iconPulse {
        0%, 100% { 
            transform: scale(1) rotate(0deg);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        50% { 
            transform: scale(1.05) rotate(2deg);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
    }
    
    .sidebar-hint-close {
        position: absolute;
        top: -12px;
        right: -12px;
        width: 28px;
        height: 28px;
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        pointer-events: auto;
        font-size: 18px;
        font-weight: bold;
        color: white;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4), 0 0 0 2px rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease;
        border: 2px solid rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-hint-close:hover {
        background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(239, 68, 68, 0.5), 0 0 0 3px rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-hint-close:active {
        transform: scale(0.95);
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    @media (min-width: 1024px) {
        .sidebar-hint {
            display: none !important;
        }
    }
    /* –¢—É–º–±–ª–µ—Ä—ã (–∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–∞–π–¥–µ—Ä) */
    .toggle-switch {
        position: relative;
        width: 42px;
        height: 22px;
        border-radius: 9999px;
        background: #374151; /* gray-700 - –±–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ */
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.1), 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: all .2s ease;
        outline: none;
        cursor: pointer;
    }
    
    .toggle-switch:hover {
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.15), 0 4px 8px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .toggle-switch:active {
        transform: scale(0.98);
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.1), 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .toggle-switch .knob {
        position: absolute;
        top: 2px; left: 2px;
        width: 18px; height: 18px;
        border-radius: 9999px;
        background: #f3f4f6; /* gray-100 - –±–æ–ª–µ–µ –º—è–≥–∫–∏–π –±–µ–ª—ã–π */
        box-shadow: 0 2px 6px rgba(0,0,0,.4);
        transition: all .2s ease;
    }
    
    .toggle-switch.on { 
        background: #2563eb; /* blue-600 - –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç —Å–∞–π—Ç–∞ */
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.1), 0 2px 4px rgba(37, 99, 235, 0.3), 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    .toggle-switch.on:hover {
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.15), 0 4px 8px rgba(37, 99, 235, 0.4), 0 0 0 3px rgba(37, 99, 235, 0.15);
    }
    
    .toggle-switch.on .knob { 
        transform: translateX(20px);
        box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
    }
    
    .toggle-switch:focus-visible { 
        box-shadow: 0 0 0 3px rgba(59,130,246,.45);
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
    .settings-modal .toggle-switch,
    #settings-modal-container .toggle-switch {
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.1), 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }
    
    .settings-modal .toggle-switch:hover,
    #settings-modal-container .toggle-switch:hover {
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.15), 0 4px 8px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
    }
    
    .settings-modal .toggle-switch.on,
    #settings-modal-container .toggle-switch.on {
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.1), 0 2px 4px rgba(37, 99, 235, 0.3), 0 0 0 3px rgba(37, 99, 235, 0.1) !important;
    }
    
    .settings-modal .toggle-switch.on:hover,
    #settings-modal-container .toggle-switch.on:hover {
        box-shadow: inset 0 0 0 2px rgba(255,255,255,0.15), 0 4px 8px rgba(37, 99, 235, 0.4), 0 0 0 3px rgba(37, 99, 235, 0.15) !important;
    }
    
    /* –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #settings-modal-container {
        transform: none !important;
        transition: none !important;
    }
    
    #settings-modal-content {
        transform: none !important;
        transition: none !important;
        animation: none !important;
    }
    
    /* –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è */
    #settings-modal-close {
        transform: none !important;
        transition: none !important;
        animation: none !important;
    }
    
    /* –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ */
    #import-export-status {
        min-height: auto !important;
        transition: none !important;
        animation: none !important;
        border-radius: 18px !important;
        font-weight: 500 !important;
        margin: 0 0.75rem !important;
        white-space: pre-line !important;
        overflow: visible !important;
        max-width: 200px !important;
        line-height: 1.1 !important;
        font-size: 12px !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö */
    #import-export-status.bg-red-900\/50 {
        border: 2px solid rgba(239, 68, 68, 0.8) !important;
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3) !important;
        font-weight: 600 !important;
        background-color: rgba(239, 68, 68, 0.25) !important;
        z-index: 1000 !important;
        position: relative !important;
        min-width: 80px !important;
        max-width: 120px !important;
        font-size: 9px !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± —É—Å–ø–µ—Ö–µ */
    #import-export-status.bg-green-900\/50 {
        border: 2px solid rgba(34, 197, 94, 0.8) !important;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3) !important;
        font-weight: 600 !important;
        background-color: rgba(34, 197, 94, 0.25) !important;
        z-index: 1000 !important;
        position: relative !important;
        min-width: 80px !important;
        max-width: 140px !important;
        font-size: 10px !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π */
    #import-export-status.bg-blue-900\/50 {
        border: 2px solid rgba(59, 130, 246, 0.8) !important;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3) !important;
        font-weight: 600 !important;
        background-color: rgba(59, 130, 246, 0.25) !important;
        z-index: 1000 !important;
        position: relative !important;
        min-width: 100px !important;
        max-width: 180px !important;
        font-size: 10px !important;
    }
    
    /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
    #settings-modal-scroll {
        transform: none !important;
        transition: none !important;
        animation: none !important;
    }
    
    /* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–Ω–∏–º–∞—Ü–∏–π –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #settings-modal-container *,
    #settings-modal-container *::before,
    #settings-modal-container *::after {
        animation: none !important;
        transition: none !important;
        transform: none !important;
    }
    
    /* –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π - –∏–º –Ω—É–∂–Ω—ã –∞–Ω–∏–º–∞—Ü–∏–∏ */
    #settings-modal-container .toggle-switch,
    #settings-modal-container .toggle-switch * {
        animation: none !important;
        transition: all 0.2s ease !important;
        transform: none !important;
    }
    
    #settings-modal-container .toggle-switch:hover {
        transform: none !important;
    }
    
    #settings-modal-container .toggle-switch.on .knob {
        transform: translateX(20px) !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è —Ç–∏–ø–æ–≤ –ø–æ–∏—Å–∫–∞ */
    .search-type-btn {
        transition: all 0.2s ease;
    }
    
    .search-type-btn:hover {
        background-color: rgba(59, 130, 246, 0.1);
    }
    
    .search-type-btn.active {
        background-color: #2563eb;
        color: white;
    }
    
    .search-type-btn.active:hover {
        background-color: #1d4ed8;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞ */
    @keyframes msSlideFadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes msSlideFadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(-10px); }
    }
    
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(0.1rem) scale(0.995); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ */
    .minifig-parts-container {
        overflow: hidden;
        background-color: transparent;
    }
    
    
    /* –°—Ç–∞—Ç–∏—á–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —Ä–∞—Å–∫—Ä—ã—Ç–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è - —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–µ –∞–Ω–∏–º–∏—Ä—É—é—â–∏—Ö—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
    .minifig-parts-container.expanded {
        background-color: rgba(55, 65, 81, 0.4); /* bg-gray-700/40 */
    }
    
    /* –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
    .minifig-parts-container.hidden {
        animation: none !important;
        background-color: transparent !important;
    }
    
    
    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ - –í–ê–ñ–ù–û: –Ω–µ –æ—Ç–∫–ª—é—á–∞—Ç—å! */
    #modal-container,
    #filter-modal-container,
    #set-modal-container,
    #settings-modal-container,
    #minifig-modal-container,
    #colors-modal-container,
    #related-sets-modal-container,
    #camera-selection-modal,
    #photo-camera-selection-modal,
    #image-viewer-container,
    #universal-search-modal,
    #search-type-selection-modal {
        opacity: 0;
        transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1), backdrop-filter 0.25s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        backdrop-filter: blur(0px);
        visibility: hidden;
        pointer-events: none;
    }
    
    #modal-container.visible,
    #filter-modal-container.visible,
    #set-modal-container.visible,
    #settings-modal-container.visible,
    #minifig-modal-container.visible,
    #colors-modal-container.visible,
    #related-sets-modal-container.visible,
    #camera-selection-modal.visible,
    #photo-camera-selection-modal.visible,
    #image-viewer-container.visible,
    #universal-search-modal.visible,
    #search-type-selection-modal.visible {
        opacity: 1;
        backdrop-filter: blur(4px);
        visibility: visible;
        pointer-events: auto;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ø–∞–Ω–µ–ª–µ–π */
    .collapse-panel {
        overflow: hidden !important;
        max-height: 0 !important;
        opacity: 0 !important;
        padding: 0 !important; /* —É–±–∏—Ä–∞–µ–º –ø–∞–¥–¥–∏–Ω–≥–∏, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –ª–∏—à–Ω–µ–≥–æ –æ—Ç—Å—Ç—É–ø–∞ –≤ —Å–≤–µ—Ä–Ω—É—Ç–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ */
        transition: max-height 0.25s ease, opacity 0.2s ease, padding 0.2s ease !important;
    }
    .collapse-panel.open {
        max-height: 5000px !important; /* –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
        opacity: 1 !important;
        padding: 0.75rem !important; /* —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–ª–∞—Å—Å—É p-3 */
    }
    
    /* –ë–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –ø–∞–Ω–µ–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
    #settings-stats-panel.collapse-panel {
        overflow: hidden !important;
        max-height: 0 !important;
        opacity: 0 !important;
        padding: 0 !important;
        transition: max-height 0.25s ease, opacity 0.2s ease, padding 0.2s ease !important;
    }
    #settings-stats-panel.collapse-panel.open {
        max-height: 5000px !important;
        opacity: 1 !important;
        padding: 0.75rem !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π */
    #technologies-panel.collapse-panel {
        overflow: hidden !important;
        max-height: 0 !important;
        opacity: 0 !important;
        padding: 0 !important;
        transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1), padding 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    #technologies-panel.collapse-panel.open {
        max-height: none !important;
        opacity: 1 !important;
        padding: 0.75rem !important;
        overflow: visible !important;
    }
    
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–∞–Ω–µ–ª–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π */
    #technologies-panel.collapse-panel > div {
        transition: opacity 0.2s ease, transform 0.2s ease;
        transform: translateY(5px);
        opacity: 0;
    }
    
    #technologies-panel.collapse-panel.open > div {
        transform: translateY(0);
        opacity: 1;
    }
    
    /* –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å–µ–∫—Ü–∏–π –ø–∞–Ω–µ–ª–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π */
    #technologies-panel.collapse-panel.open > div:nth-child(1) { transition-delay: 0.1s; } /* –û–ø–∏—Å–∞–Ω–∏–µ */
    #technologies-panel.collapse-panel.open > div:nth-child(2) { transition-delay: 0.15s; } /* –ö–∞–º–µ—Ä–∞ */
    #technologies-panel.collapse-panel.open > div:nth-child(3) { transition-delay: 0.2s; } /* AI */
    #technologies-panel.collapse-panel.open > div:nth-child(4) { transition-delay: 0.25s; } /* API */
    #technologies-panel.collapse-panel.open > div:nth-child(5) { transition-delay: 0.3s; } /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ */
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ "–û —Å–∞–π—Ç–µ" —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π */
    #about-panel.collapse-panel {
        overflow: hidden !important;
        max-height: 0 !important;
        opacity: 0 !important;
        padding: 0 !important;
        margin-top: 0 !important;
        transform: translateY(-10px) !important;
        transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1), 
                   opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1), 
                   padding 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                   margin-top 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                   transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    #about-panel.collapse-panel.open {
        max-height: none !important;
        opacity: 1 !important;
        padding: 0.75rem !important;
        margin-top: 0.5rem !important;
        transform: translateY(0) !important;
    }
    
    /* –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    @media (max-width: 768px) {
        #settings-modal-content {
            max-height: 95vh !important;
        }
    }
    
    @media (max-width: 480px) {
        #settings-modal-content {
            max-height: 98vh !important;
        }
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π */
    #technologies-panel.collapse-panel.open {
        max-height: none !important;
        opacity: 1 !important;
        padding: 0.75rem !important;
        overflow: visible !important;
        margin-bottom: 1rem !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #settings-modal-scroll::-webkit-scrollbar {
        width: 8px;
    }
    
    #settings-modal-scroll::-webkit-scrollbar-track {
        background: rgba(55, 65, 81, 0.3);
        border-radius: 4px;
    }
    
    #settings-modal-scroll::-webkit-scrollbar-thumb {
        background: rgba(107, 114, 128, 0.6);
        border-radius: 4px;
    }
    
    #settings-modal-scroll::-webkit-scrollbar-thumb:hover {
        background: rgba(107, 114, 128, 0.8);
    }
    
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–∞–Ω–µ–ª–∏ "–û —Å–∞–π—Ç–µ" */
    #about-panel.collapse-panel p,
    #about-panel.collapse-panel ul,
    #about-panel.collapse-panel li {
        transition: opacity 0.2s ease, transform 0.2s ease;
        transform: translateY(5px);
        opacity: 0;
    }
    
    #about-panel.collapse-panel.open p,
    #about-panel.collapse-panel.open ul,
    #about-panel.collapse-panel.open li {
        transform: translateY(0);
        opacity: 1;
    }
    
    /* –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞ */
    #about-panel.collapse-panel.open li:nth-child(1) { transition-delay: 0.1s; }
    #about-panel.collapse-panel.open li:nth-child(2) { transition-delay: 0.15s; }
    #about-panel.collapse-panel.open li:nth-child(3) { transition-delay: 0.2s; }
    #about-panel.collapse-panel.open li:nth-child(4) { transition-delay: 0.25s; }
    #about-panel.collapse-panel.open li:nth-child(5) { transition-delay: 0.3s; }
    #about-panel.collapse-panel.open li:nth-child(6) { transition-delay: 0.35s; }
    #about-panel.collapse-panel.open li:nth-child(7) { transition-delay: 0.4s; }
    #about-panel.collapse-panel.open li:nth-child(8) { transition-delay: 0.45s; }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û —Å–∞–π—Ç–µ" */
    button[data-action="toggle-about"] {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 18px;
        padding: 0.5rem;
    }
    
    button[data-action="toggle-about"]:hover {
        background-color: rgba(55, 65, 81, 0.3);
        transform: translateX(2px);
    }
    
    button[data-action="toggle-about"]:active {
        transform: translateX(1px) scale(0.98);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏" */
    button[data-action="toggle-technologies"] {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 18px;
        padding: 0.5rem;
    }
    
    button[data-action="toggle-technologies"]:hover {
        background-color: rgba(55, 65, 81, 0.3);
        transform: translateX(2px);
    }
    
    button[data-action="toggle-technologies"]:active {
        transform: translateX(1px) scale(0.98);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏" */
    button[data-action="toggle-settings-stats"] {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 18px;
        padding: 0.5rem;
    }
    
    button[data-action="toggle-settings-stats"]:hover {
        background-color: rgba(55, 65, 81, 0.3);
        transform: translateX(2px);
    }
    
    button[data-action="toggle-settings-stats"]:active {
        transform: translateX(1px) scale(0.98);
    }
    
    /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö */
    .settings-button-container {
        margin-bottom: 0.5rem !important;
    }
    
    .settings-button-container + div {
        margin-top: 0.5rem !important;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã –≤ DataMatrix –∏ AI –∫–∞–º–µ—Ä–µ */
    details.group {
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    details.group summary {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ details */
    details.group > div {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(-10px);
        opacity: 0;
        max-height: 0;
        overflow: hidden;
    }
    
    details.group[open] > div {
        transform: translateY(0);
        opacity: 1;
        max-height: 1000px;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã */
    details.group[open] > div > div {
        transition: opacity 0.2s ease, transform 0.2s ease;
        transform: translateY(5px);
        opacity: 0;
    }
    
    details.group[open] > div > div:nth-child(1) { transition-delay: 0.1s; }
    details.group[open] > div > div:nth-child(2) { transition-delay: 0.15s; }
    
    details.group[open] > div > div {
        transform: translateY(0);
        opacity: 1;
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è —à–µ–≤—Ä–æ–Ω–∞ –≤ details */
    details.group summary .text-gray-400 {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    details.group[open] summary .text-gray-400 {
        transform: rotate(180deg);
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —à–µ–≤—Ä–æ–Ω–æ–≤ –≤ –º–æ–¥–∞–ª–∫–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #about-chevron,
    #technologies-chevron,
    #settings-stats-chevron,
    .rotate {
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
    }
    #about-chevron.rotate-180,
    #technologies-chevron.rotate-180,
    #settings-stats-chevron.rotate-180,
    .rotate.rotate-180,
    .rotate-180 {
        transform: rotate(180deg) !important;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é */
    #sidebar-container button {
        transition: background-color 0.12s ease, color 0.12s ease, box-shadow 0.12s ease;
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
    }
    /* hover/active –±–µ–∑ –ø–æ–¥—ä—ë–º–∞/—Å–∫–µ–π–ª–∞ ‚Äî —Ü–≤–µ—Ç –º–µ–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ transition-colors */
    
    /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–¥—ë—Ä–≥–∏–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
    button[data-view] {
        backface-visibility: hidden;
        -webkit-backface-visibility: hidden;
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
        /* –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ—Ö–æ–¥—ã */
        transition: all 0.2s ease-in-out;
    }
    #sidebar-container button:focus-visible {
        outline: none;
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
    }
    /* –õ–µ–≥–∫–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∫–æ–Ω–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é */
    #sidebar-container [data-action="toggle-favorite-theme"],
    #sidebar-container [data-action="toggle-favorite-category"] {
        transition: transform 0.15s ease;
    }
    #sidebar-container [data-action="toggle-favorite-theme"]:active,
    #sidebar-container [data-action="toggle-favorite-category"]:active {
        transform: scale(0.9);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    #sidebar-container {
        transition: transform 0.25s ease-in-out;
        will-change: transform;
    }
    #sidebar-backdrop {
        transition: opacity 0.2s ease-in-out;
    }
    
    /* –ö–Ω–æ–ø–æ—á–Ω—ã–π –≤–∏–¥ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–æ–≤ –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
    #sidebar-container nav ul li > button {
        background-color: rgba(55, 65, 81, 0.20); /* bg-gray-700/20 */
        border: 1px solid rgba(75, 85, 99, 0.50); /* border-gray-700/50 */
        box-shadow: 0 1px 1px rgba(0,0,0,0.20);
        border-radius: 18px; /* rounded-[18px] */
        display: flex;
        align-items: center;
        justify-content: space-between;
        line-height: 1.2;
    }
    #sidebar-container nav ul li > button > span,
    #sidebar-container nav ul li > button > span.truncate { align-self: center; display: inline-flex; align-items: center; }
    #sidebar-container nav ul li > button > div { align-items: center; }
    #sidebar-container nav ul li > button:hover {
        background-color: rgba(55, 65, 81, 0.40); /* bg-gray-700/40 */
        box-shadow: 0 2px 4px rgba(0,0,0,0.25);
    }
    /* –õ–µ–≤–∞—è –ø–æ–ª–æ—Å–∞ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ –¢–û–õ–¨–ö–û –≤ —Å–ø–∏—Å–∫–∞—Ö –ø–æ–¥ –≤–µ—Ä—Ö–Ω–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏ */
    #sidebar-scroll-container button { overflow: hidden; transition: box-shadow .38s cubic-bezier(0.22, 1, 0.36, 1); }
    /* –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–µ–∂–Ω–∏–µ –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç—ã –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ inset-—Ç–µ–Ω—å */
    #sidebar-scroll-container button::before,
    #sidebar-scroll-container button::after { content: none !important; }

    /* –ê–∫—Ç–∏–≤–Ω—ã–π –ø—É–Ω–∫—Ç: —Ç–æ–Ω–∫–∞—è —è—Ä–∫–∞—è –≥—Ä–∞–Ω—å –∏ –º—è–≥–∫–æ–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–≤–µ—á–µ–Ω–∏–µ —Å–ª–µ–≤–∞ */
    #sidebar-scroll-container button[class*="bg-blue-600"] {
        box-shadow:
            inset 2px 0 0 rgba(147,197,253,0.78),          /* —Ç–æ–Ω—å—à–µ –∏ —Å–ª–µ–≥–∫–∞ –ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è –≥—Ä–∞–Ω—å */
            inset 14px 0 24px -14px rgba(59,130,246,0.28); /* –º—è–≥–∫–æ–µ –ª–µ–≤–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ */
        animation: sidebarActiveIn .38s cubic-bezier(0.22, 1, 0.36, 1) both;
    }

    @keyframes sidebarActiveIn {
        0% {
            box-shadow:
                inset 2px 0 0 rgba(147,197,253,0),
                inset 14px 0 24px -14px rgba(59,130,246,0);
        }
        100% {
            box-shadow:
                inset 2px 0 0 rgba(147,197,253,0.78),
                inset 14px 0 24px -14px rgba(59,130,246,0.28);
        }
    }
    /* –û—Ç–∫–ª—é—á–∞–µ–º —Å–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–í—Å–µ" */
    #sidebar-scroll-container button[data-action="show-all-collection-items"],
    #sidebar-scroll-container button[data-action="show-all-items-sets"],
    #sidebar-scroll-container button[data-action="show-all-items-parts"] {
        box-shadow: none !important;
    }
    /* –û—Ç–∫–ª—é—á–∞–µ–º —Å–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ */
    #sidebar-scroll-container #sidebar-fav-list button { box-shadow: none !important; }
    /* –õ—ë–≥–∫–∞—è –∑–µ–±—Ä–∞ –¥–ª—è –º–æ–Ω–æ—Ç–æ–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–≥–æ —É—Ä–æ–≤–Ω—è) */
    #sidebar-container nav > ul > li:nth-child(odd) > button {
        background-color: rgba(55, 65, 81, 0.16); /* –Ω–µ–º–Ω–æ–≥–æ —Å–≤–µ—Ç–ª–µ–µ */
    }
    /* –ö–µ–±–∞–±-–º–µ–Ω—é: –ø–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –±–µ–∑ –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    .overflow-menu {
        transform-origin: top right;
        transition: opacity 0.14s ease, transform 0.14s ease;
        opacity: 0;
        transform: scale(0.96);
        pointer-events: none;
    }
    .overflow-menu.visible {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto;
    }
    
    /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
    #image-viewer-container {
        cursor: default;
    }
    
    /* –°—Ç–∏–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —á–µ–∫–±–æ–∫—Å—ã –∏ —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ */
    input[type="checkbox"],
    input[type="radio"] {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid #4b5563; /* border-gray-600 */
        border-radius: 18px;
        background-color: #1f2937; /* bg-gray-800 */
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        /* –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
        vertical-align: middle;
        margin: 0;
        flex-shrink: 0;
    }
    
    input[type="radio"] {
        border-radius: 50%;
    }
    
    input[type="checkbox"]:hover,
    input[type="radio"]:hover {
        border-color: #6b7280; /* border-gray-500 */
        background-color: #374151; /* bg-gray-700 */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15), 0 0 0 3px rgba(59, 130, 246, 0.1);
        transform: translateY(-1px);
    }
    
    input[type="checkbox"]:checked,
    input[type="radio"]:checked {
        border-color: #2563eb; /* border-blue-600 */
        background-color: #2563eb; /* bg-blue-600 */
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3), 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    input[type="checkbox"]:checked:hover,
    input[type="radio"]:checked:hover {
        background-color: #1d4ed8; /* bg-blue-700 */
        border-color: #1d4ed8; /* border-blue-700 */
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.4), 0 0 0 3px rgba(37, 99, 235, 0.15);
        transform: translateY(-1px);
    }
    
    input[type="checkbox"]:focus,
    input[type="radio"]:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
    }
    
    input[type="checkbox"]:disabled,
    input[type="radio"]:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: #374151; /* bg-gray-700 */
        border-color: #6b7280; /* border-gray-500 */
    }
    
    /* –ò–∫–æ–Ω–∫–∞ –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞ */
    input[type="checkbox"]:checked::after {
        content: '';
        position: absolute;
        left: 5px;
        top: 2px;
        width: 4px;
        height: 8px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
        animation: checkmark 0.2s ease-in-out;
    }
    
    /* –ò–∫–æ–Ω–∫–∞ –¥–ª—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–∫–∏ */
    input[type="radio"]:checked::after {
        content: '';
        position: absolute;
        left: 4px;
        top: 4px;
        width: 6px;
        height: 6px;
        background-color: white;
        border-radius: 50%;
        animation: radioDot 0.2s ease-in-out;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ */
    @keyframes checkmark {
        from {
            opacity: 0;
            transform: rotate(45deg) scale(0.8);
        }
        to {
            opacity: 1;
            transform: rotate(45deg) scale(1);
        }
    }
    
    @keyframes radioDot {
        from {
            opacity: 0;
            transform: scale(0.5);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è —Ä–∞–¥–∏–æ–∫–Ω–æ–ø–æ–∫ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ö */
    label:has(input[type="radio"]),
    label:has(input[type="checkbox"]) {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    label:has(input[type="radio"]) input[type="radio"],
    label:has(input[type="checkbox"]) input[type="checkbox"] {
        margin: 0;
        align-self: center;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    
    /* –°—á—ë—Ç—á–∏–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    .bg-blue-600.text-white.text-xs.font-bold.rounded-full {
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3), 0 2px 4px rgba(37, 99, 235, 0.2) !important;
        transition: all 0.2s ease !important;
        /* animation: pulse 2s infinite !important; */ /* –û–¢–ö–õ–Æ–ß–ï–ù–û: –º–æ—Ä–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ */
    }
    
    .set-card:hover .bg-blue-600.text-white.text-xs.font-bold.rounded-full,
    .minifig-card:hover .bg-blue-600.text-white.text-xs.font-bold.rounded-full,
    .part-card:hover .bg-blue-600.text-white.text-xs.font-bold.rounded-full {
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.4), 0 4px 8px rgba(37, 99, 235, 0.3) !important;
        transform: scale(1.05) !important;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å—á—ë—Ç—á–∏–∫–æ–≤ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ */
    .set-card .bg-blue-600.text-white.text-xs.font-bold.rounded-full,
    .minifig-card .bg-blue-600.text-white.text-xs.font-bold.rounded-full {
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3), 0 2px 4px rgba(37, 99, 235, 0.2) !important;
        transition: all 0.2s ease !important;
        /* animation: pulse 2s infinite !important; */ /* –û–¢–ö–õ–Æ–ß–ï–ù–û: –º–æ—Ä–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ */
    }
    
    .set-card:hover .bg-blue-600.text-white.text-xs.font-bold.rounded-full,
    .minifig-card:hover .bg-blue-600.text-white.text-xs.font-bold.rounded-full {
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.4), 0 4px 8px rgba(37, 99, 235, 0.3) !important;
        transform: scale(1.05) !important;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ (–∫–æ—Ä–∑–∏–Ω–∞) –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    button[data-action="toggle-select"] {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
        transition: all 0.2s ease !important;
    }
    
    button[data-action="toggle-select"]:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
        transform: scale(1.1) !important;
    }
    
    button[data-action="toggle-select"]:active {
        transform: scale(0.95) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∫–æ—Ä–∑–∏–Ω—ã –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ */
    .set-card button[data-action="toggle-select"],
    .minifig-card button[data-action="toggle-select"] {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
        transition: all 0.2s ease !important;
    }
    
    .set-card button[data-action="toggle-select"]:hover,
    .minifig-card button[data-action="toggle-select"]:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3), 0 0 0 3px rgba(59, 130, 246, 0.2) !important;
        transform: scale(1.1) !important;
    }
    
    .set-card button[data-action="toggle-select"]:active,
    .minifig-card button[data-action="toggle-select"]:active {
        transform: scale(0.95) !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
    }
    
    /* –¶–≤–µ—Ç–æ–≤—ã–µ –∫—Ä—É–∂–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –¥–µ—Ç–∞–ª–µ–π */
    .w-4.h-4.rounded-full.border {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        transition: all 0.2s ease !important;
    }
    
    .part-card:hover .w-4.h-4.rounded-full.border {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important;
        transform: scale(1.1) !important;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤ - –û–¢–ö–õ–Æ–ß–ï–ù–ê */
    /*
    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3), 0 2px 4px rgba(37, 99, 235, 0.2);
        }
        50% {
            box-shadow: 0 6px 12px rgba(37, 99, 235, 0.4), 0 4px 8px rgba(37, 99, 235, 0.3);
        }
    }
    */
    
    /* –°—á–µ—Ç—á–∏–∫–∏ –≤ –ø–∞–ø–∫–∞—Ö –∏ –¥—Ä—É–≥–∏—Ö —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö */
    .part-card[data-folder="true"] .bg-blue-600.text-white.text-xs.font-bold.rounded-full {
        box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3), 0 2px 4px rgba(37, 99, 235, 0.2) !important;
        transition: all 0.2s ease !important;
        /* animation: pulse 2s infinite !important; */ /* –û–¢–ö–õ–Æ–ß–ï–ù–û: –º–æ—Ä–≥–∞–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ */
    }
    
    .part-card[data-folder="true"]:hover .bg-blue-600.text-white.text-xs.font-bold.rounded-full {
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.4), 0 4px 8px rgba(37, 99, 235, 0.3) !important;
        transform: scale(1.05) !important;
    }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .set-card,
    .minifig-card,
    .part-card {
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    }
    
    .set-card:hover,
    .minifig-card:hover,
    .part-card:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ */
    .set-card,
    .minifig-card {
        transition: all 0.3s ease !important;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
    }
    
    .set-card:hover,
    .minifig-card:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* –¶–≤–µ—Ç–æ–≤—ã–µ –∫—Ä—É–∂–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ö */
    .modal-content .w-6.h-6.rounded-full.border,
    .filter-modal .w-6.h-6.rounded-full.border,
    .w-8.h-8.rounded-full.border-2 {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }
    
    .modal-content .w-6.h-6.rounded-full.border:hover,
    .filter-modal .w-6.h-6.rounded-full.border:hover,
    .w-8.h-8.rounded-full.border-2:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        transform: scale(1.05);
    }
    
    /* –¶–≤–µ—Ç–æ–≤—ã–µ –∫—Ä—É–∂–∫–∏ –≤ –ø–∞–ª–∏—Ç—Ä–µ —Ü–≤–µ—Ç–æ–≤ */
    .color-palette-inner button,
    .color-palette-inner span {
        transition: all 0.2s ease;
    }
    
    .color-palette-inner button:hover,
    .color-palette-inner span:hover {
        transform: scale(1.1);
    }
    
    /* –ö–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    button[data-action="delete-from-collection"],
    button[data-action="delete-set-from-collection"],
    button[data-action="delete-minifig-from-collection"] {
        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2) !important;
        transition: all 0.2s ease !important;
    }
    
    button[data-action="delete-from-collection"]:hover,
    button[data-action="delete-set-from-collection"]:hover,
    button[data-action="delete-minifig-from-collection"]:hover {
        box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3), 0 0 0 3px rgba(220, 38, 38, 0.1) !important;
        transform: scale(1.1) !important;
    }
    
    button[data-action="delete-from-collection"]:active,
    button[data-action="delete-set-from-collection"]:active,
    button[data-action="delete-minifig-from-collection"]:active {
        transform: scale(0.95) !important;
        box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2) !important;
    }
    
    /* –¢–µ–Ω–∏ –¥–ª—è –±–µ–ª—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö */
    .card-image-container .bg-white {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* –¢–µ–Ω–∏ –¥–ª—è –±–µ–ª—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö */
    .modal-content .bg-white[class*="rounded-"],
    [id*="modal"] .bg-white[class*="rounded-"] {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* –¢–µ–Ω–∏ –¥–ª—è –±–µ–ª—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è—Ö */
    .inventory-container .bg-white[class*="rounded-"],
    .collection-container .bg-white[class*="rounded-"] {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* –û–±—â–∏–µ —Ç–µ–Ω–∏ –¥–ª—è –≤—Å–µ—Ö –±–µ–ª—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏ */
    .bg-white[class*="rounded-"] {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –±–µ–ª—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –∫–∞—Ä—Ç–∏–Ω–∫–∞–º–∏ - —É–±–∏—Ä–∞–µ–º —Å–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –º–æ–¥–∞–ª–∫–∞—Ö */
    .bg-white[class*="rounded-"] img {
        border-radius: 0;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ–Ω–∏ –¥–ª—è —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    #set-modal-container .bg-white[class*="rounded-"],
    #minifig-modal-container .bg-white[class*="rounded-"],
    #modal-container .bg-white[class*="rounded-"],
    #related-sets-modal-container .bg-white[class*="rounded-"],
    #image-viewer-container .bg-white[class*="rounded-"],
    #image-viewer-container .bg-white[class*="rounded-"] {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
    }
    
    #image-viewer-container.zoomed {
        cursor: default;
    }
    
    #fullscreen-image {
        transition: all 0.3s ease-out;
        cursor: default;
        max-width: 100%;
        max-height: 100%;
        border-radius: 18px;
    }
    
    #fullscreen-image.zoomed {
        cursor: default;
        /* –£–±–∏—Ä–∞–µ–º transform, —Ç–∞–∫ –∫–∞–∫ –æ–Ω —Ç–µ–ø–µ—Ä—å –Ω–∞ –æ–±–µ—Ä—Ç–∫–µ */
        max-width: 90%;
        max-height: 90%;
        object-fit: contain;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –æ—Ç—Å—Ç—É–ø–∞–º–∏ */
    #image-viewer-container > div {
        transition: padding 0.3s ease-out;
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        padding: 0;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –æ–±–µ—Ä—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    .image-wrapper {
        border-radius: 18px;
        overflow: hidden;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ */
    .image-wrapper img {
        border-radius: 18px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    #sidebar-search {
        min-width: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ */
        flex-shrink: 1; /* –ü–æ–∑–≤–æ–ª—è–µ–º —Å–∂–∏–º–∞—Ç—å—Å—è */
        padding-right: 2.5rem; /* 40px - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ */
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
    #sidebar-search-icon,
    #sidebar-search-clear {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        width: 40px; /* –®–∏—Ä–∏–Ω–∞ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ */
        min-width: 40px;
        height: 40px;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∂–∞—Ç–∏–µ */
        z-index: 10; /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –Ω–∞–ª–æ–∂–µ–Ω–∏–µ */
        cursor: pointer;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–∏—Å–∫–∞ */
    #sidebar-search-clear {
        background-color: transparent;
        border: none;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–∫–∏ –ø–æ–∏—Å–∫–∞ */
    #sidebar-search-icon {
        background-color: transparent;
        border: none;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    @media (max-width: 640px) {
        #sidebar-search-icon,
        #sidebar-search-clear {
            width: 36px;
            min-width: 36px;
            height: 36px;
            min-height: 36px;
        }
        
        #sidebar-search {
            padding-right: 2.25rem; /* 36px - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        }
    }
    
    
    #image-viewer-container.zoomed > div {
        padding: 5% !important;
    }
    
    /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –æ–±–µ—Ä—Ç–∫—É –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ */
    #image-viewer-container {
        display: flex;
        align-items: center;
        justify-content: center;
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
        padding: 0;
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
        align-content: center;
        /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ */
        text-align: center;
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Å–∫—Ä–æ–ª–ª–∏—Ä–æ–≤–∞–Ω–∏–µ */
        overflow: hidden;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã—Ö –∫—Ä–∞–µ–≤ */
    .image-wrapper {
        /* –û–±–µ—Ä—Ç–∫–∞ —Ç–æ—á–Ω–æ –ø–æ —Ä–∞–∑–º–µ—Ä—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
        display: inline-block;
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–µ */
        width: fit-content;
        height: fit-content;
        /* –°–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ –∫—Ä–∞—è */
        border-radius: 18px;
        /* –¢–µ–Ω—å */
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        /* –ü–µ—Ä–µ—Ö–æ–¥—ã */
        transition: all 0.3s ease-out;
        /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è —Ñ–æ–Ω–∞ */
        padding: 8px;
        /* –ü—Ä–æ—Å—Ç–æ–π –±–µ–ª—ã–π —Ñ–æ–Ω –±–µ–∑ —à–∞—Ö–º–∞—Ç–∫–∏ */
        background-color: white;
        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è */
        max-width: none;
        max-height: none;
        /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ */
        position: relative;
        /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ */
        text-align: center;
        /* –û–±—Ä–µ–∑–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –∑–∞–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–º —É–≥–ª–∞–º */
        overflow: hidden;
    }

    /* –ß—É—Ç—å –±–æ–ª–µ–µ –∫—Ä—É–ø–Ω—ã–µ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö */
    @media (min-width: 1024px) {
        .image-wrapper {
            border-radius: 18px;
        }
    }
    
    /* –ü—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ —É–ª—É—á—à–∞–µ–º —Ç–µ–Ω—å –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –æ–±–µ—Ä—Ç–∫—É */
    .image-wrapper.zoomed {
        box-shadow: 0 35px 60px -15px rgba(0, 0, 0, 0.3);
        transform: scale(1.5);
        transition: transform 0.3s ease-out;
        /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –ø—Ä–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ */
        padding: 12px;
        /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –æ–±–µ—Ä—Ç–∫–∏ */
        transform-origin: center;
        /* –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
        width: fit-content;
        height: fit-content;
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ */
        position: relative;
    }
    
    #fullscreen-image {
        /* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–º–µ—â–∞–µ—Ç—Å—è –≤ —ç–∫—Ä–∞–Ω */
        max-width: 90vw;
        max-height: 90vh;
        width: auto;
        height: auto;
        /* –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ */
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        /* –î–æ–±–∞–≤–ª—è–µ–º border-radius –¥–ª—è —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è —É–≥–ª–æ–≤ */
        border-radius: 18px;
        /* –û–±—ä–µ–∫—Ç-—Ñ–∏—Ç –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è */
        object-fit: contain;
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤–ª–∏—è–Ω–∏–µ –Ω–∞ —Ä–∞–∑–º–µ—Ä –æ–±–µ—Ä—Ç–∫–∏ */
        flex-shrink: 0;
        /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –æ–±–µ—Ä—Ç–∫–µ */
        display: block;
        margin: 0 auto;
    }
    
    /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö */
    #modal-container,
    #set-modal-container,
    #minifig-modal-container,
    #filter-modal-container,
    #settings-modal-container,
    #camera-selection-modal,
    #photo-camera-selection-modal {
        z-index: 50 !important;
        pointer-events: auto !important;
        overflow: hidden; /* –ö–ª–∏–ø—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–∏ –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–∫—Ä—ã—Ç–∏—è */
    }
    /* –ú–æ–¥–∞–ª–∫–∞ –¥–µ—Ç–∞–ª–µ–π –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π –Ω–∞–±–æ—Ä–æ–≤/–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ */
    #modal-container { z-index: 60 !important; }
    /* –ú–æ–¥–∞–ª–∫–∞ –Ω–∞–±–æ—Ä–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ */
    /* z-index —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è ModalManager */
    
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä) */
    #scroll-progress {
        position: fixed;
        right: 2px;
        top: 12px;
        bottom: 12px;
        width: 5px;
        background: rgba(255,255,255,0.08);
        border-radius: 9999px;
        overflow: hidden;
        opacity: 0;
        transform: translateX(8px);
        transition: opacity .2s ease, transform .2s ease;
        z-index: 45;
        pointer-events: none;
    }
    #scroll-progress.visible { opacity: .9; transform: translateX(0); }
    #scroll-progress .bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px; /* —Ä–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞ */
        background: linear-gradient(180deg, #60a5fa, #3b82f6);
        box-shadow: 0 0 10px rgba(59,130,246,.35);
        border-radius: inherit;
        transform: translateY(0);
    }
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –Ω–∞–±–æ—Ä–∞ */
    #set-scroll-progress {
        position: absolute;
        right: 2px;
        top: 12px; /* –±—É–¥–µ—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Å–∫—Ä–∏–ø—Ç–æ–º –ø–æ–¥ –≤—ã—Å–æ—Ç—É —à–∞–ø–∫–∏ –º–æ–¥–∞–ª–∫–∏ */
        bottom: 12px;
        width: 5px;
        background: rgba(255,255,255,0.08);
        border-radius: 9999px;
        overflow: hidden;
        opacity: 0;
        transform: translateX(8px);
        transition: opacity .2s ease, transform .2s ease;
        z-index: 15;
        pointer-events: none;
    }
    #set-scroll-progress.visible { opacity: .9; transform: translateX(0); }
    #set-scroll-progress .bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px;
        background: linear-gradient(180deg, #60a5fa, #3b82f6);
        box-shadow: 0 0 10px rgba(59,130,246,.35);
        border-radius: inherit;
        transform: translateY(0);
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ */
    #minifig-scroll-progress {
        position: absolute;
        right: 2px;
        top: 12px; /* –±—É–¥–µ—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Å–∫—Ä–∏–ø—Ç–æ–º –ø–æ–¥ –≤—ã—Å–æ—Ç—É —à–∞–ø–∫–∏ –º–æ–¥–∞–ª–∫–∏ */
        bottom: 12px;
        width: 5px;
        background: rgba(255,255,255,0.08);
        border-radius: 9999px;
        overflow: hidden;
        opacity: 0;
        transform: translateX(8px);
        transition: opacity .2s ease, transform .2s ease;
        z-index: 15;
        pointer-events: none;
    }
    #minifig-scroll-progress.visible { opacity: .9; transform: translateX(0); }
    #minifig-scroll-progress .bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px; /* —Ä–∞–∑–º–µ—Ä –º–∞—Ä–∫–µ—Ä–∞ */
        background: linear-gradient(180deg, #60a5fa, #3b82f6);
        box-shadow: 0 0 10px rgba(59,130,246,.35);
        border-radius: inherit;
        transform: translateY(0);
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ */
    #related-sets-scroll-progress {
        position: absolute;
        right: 2px;
        top: 12px; /* –±—É–¥–µ—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω —Å–∫—Ä–∏–ø—Ç–æ–º –ø–æ–¥ –≤—ã—Å–æ—Ç—É —à–∞–ø–∫–∏ –º–æ–¥–∞–ª–∫–∏ */
        bottom: 12px;
        width: 5px;
        background: rgba(255,255,255,0.08);
        border-radius: 9999px;
        overflow: hidden;
        opacity: 0;
        transform: translateX(8px);
        transition: opacity .2s ease, transform .2s ease;
        z-index: 15;
        pointer-events: none;
    }
    #related-sets-scroll-progress.visible { opacity: .9; transform: translateX(0); }
    #related-sets-scroll-progress .bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px;
        background: linear-gradient(180deg, #60a5fa, #3b82f6);
        box-shadow: 0 0 10px rgba(59,130,246,.35);
        border-radius: inherit;
        transform: translateY(0);
    }
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ü–≤–µ—Ç–æ–≤ –¥–µ—Ç–∞–ª–∏ */
    #colors-scroll-progress {
        position: absolute;
        right: 2px;
        top: 12px;
        bottom: 12px;
        width: 5px;
        background: rgba(255,255,255,0.08);
        border-radius: 9999px;
        overflow: hidden;
        opacity: 0;
        transform: translateX(8px);
        transition: opacity .2s ease, transform .2s ease;
        z-index: 15;
        pointer-events: none;
    }
    #colors-scroll-progress.visible { opacity: .9; transform: translateX(0); }
    #colors-scroll-progress .bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px;
        background: linear-gradient(180deg, #60a5fa, #3b82f6);
        box-shadow: 0 0 10px rgba(59,130,246,.35);
        border-radius: inherit;
        transform: translateY(0);
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø–æ–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π */
    #part-search-scroll-progress {
        position: absolute;
        right: 2px;
        top: 12px;
        bottom: 12px;
        width: 5px;
        background: rgba(55, 65, 81, 0.3);
        border-radius: 18px;
        opacity: 0;
        transform: translateX(8px);
        transition: opacity .2s ease, transform .2s ease;
        z-index: 15;
        pointer-events: none;
    }
    #part-search-scroll-progress.visible { opacity: .9; transform: translateX(0); }
    #part-search-scroll-progress .bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px;
        background: linear-gradient(180deg, #3b82f6, #1d4ed8);
        box-shadow: 0 0 10px rgba(59,130,246,.35);
        border-radius: inherit;
        transform: translateY(0);
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö –ø–æ–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ */
    #sets-search-scroll-progress, #minifigs-search-scroll-progress {
        position: absolute;
        right: 2px;
        top: 12px;
        bottom: 12px;
        width: 5px;
        background: rgba(55, 65, 81, 0.3);
        border-radius: 18px;
        opacity: 0;
        transform: translateX(8px);
        transition: opacity .2s ease, transform .2s ease;
        z-index: 15;
        pointer-events: none;
    }
    #sets-search-scroll-progress.visible, #minifigs-search-scroll-progress.visible { 
        opacity: .9; 
        transform: translateX(0); 
    }
    #sets-search-scroll-progress .bar, #minifigs-search-scroll-progress .bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px;
        background: linear-gradient(180deg, #3b82f6, #1d4ed8);
        box-shadow: 0 0 10px rgba(59,130,246,.35);
        border-radius: inherit;
        transform: translateY(0);
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å–∫–∞–Ω–µ—Ä–∞ –∫–∞–º–µ—Ä—ã */
    #photo-camera-scroll-progress {
        position: absolute;
        right: 2px;
        top: 12px;
        bottom: 12px;
        width: 5px;
        background: rgba(75, 85, 99, .3);
        border-radius: 18px;
        opacity: 0;
        transform: translateX(8px);
        transition: opacity .2s ease, transform .2s ease;
        z-index: 15;
        pointer-events: none;
    }
    #photo-camera-scroll-progress.visible { 
        opacity: .9; 
        transform: translateX(0); 
    }
    #photo-camera-scroll-progress .bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px;
        background: linear-gradient(180deg, #3b82f6, #1d4ed8);
        box-shadow: 0 0 10px rgba(59,130,246,.35);
        border-radius: inherit;
        transform: translateY(0);
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å–∫–∞–Ω–µ—Ä–∞ DataMatrix */
    #camera-scroll-progress {
        position: absolute;
        right: 2px;
        top: 12px;
        bottom: 12px;
        width: 5px;
        background: rgba(75, 85, 99, .3);
        border-radius: 18px;
        opacity: 0;
        transform: translateX(8px);
        transition: opacity .2s ease, transform .2s ease;
        z-index: 15;
        pointer-events: none;
    }
    #camera-scroll-progress.visible { 
        opacity: .9; 
        transform: translateX(0); 
    }
    #camera-scroll-progress .bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 48px;
        background: linear-gradient(180deg, #3b82f6, #1d4ed8);
        box-shadow: 0 0 10px rgba(59,130,246,.35);
        border-radius: inherit;
        transform: translateY(0);
    }
    /* Image viewer –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–≤–µ—Ä—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    #image-viewer-container.visible {
        pointer-events: auto !important;
        opacity: 1 !important;
    }
    
    /* –°–∫—Ä—ã—Ç—ã–π image viewer –Ω–µ –¥–æ–ª–∂–µ–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–∫–∏ */
    #image-viewer-container.viewer-hidden {
        z-index: -1 !important;
        pointer-events: none !important;
        opacity: 0 !important;
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö –∏ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞ */
    #image-viewer-close {
        pointer-events: auto !important;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä-–ø–æ–ª–æ—Ç–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    .image-canvas {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.2s ease-out;
        will-change: transform;
        transform-style: preserve-3d;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∑—É–º–∞ –∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    #image-viewer-container.zoom-mode {
        cursor: grab;
    }
    
    #image-viewer-container.zoom-mode:active {
        cursor: grabbing;
    }
    
    #image-viewer-container.zoom-mode .image-canvas {
        cursor: grab;
        transition: transform 0.2s ease-out;
        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ø–æ–ª–æ—Ç–Ω–∞ */
        will-change: transform;
        transform-style: preserve-3d;
    }
    
    #image-viewer-container.zoom-mode .image-canvas:active {
        cursor: grabbing;
    }
    
    #image-viewer-container.zoom-mode .image-canvas.dragging {
        cursor: grabbing;
        transition: none;
        /* –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –ø–æ–ª–æ—Ç–Ω–∞ */
        will-change: transform;
        transform-style: preserve-3d;
    }
    
    .image-canvas .image-wrapper {
        /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –ø–æ–ª–æ—Ç–Ω–µ */
        max-width: 90%;
        max-height: 90%;
        width: auto;
        height: auto;
    }
    
    #image-viewer-container.zoom-mode .image-wrapper {
        transition: transform 0.2s ease-out;
        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
        will-change: transform;
        transform-style: preserve-3d;
    }
    
    /* –û—Ç–∫–ª—é—á–∞–µ–º –¥–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –Ω–∞ —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    @media (hover: none) and (pointer: coarse) {
        #image-viewer-container {
            touch-action: manipulation;
        }
        
        #image-viewer-container * {
            touch-action: manipulation;
        }
        
        /* –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ touch —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .zoom-btn:disabled {
            pointer-events: none;
            touch-action: none;
            -webkit-touch-callout: none;
            /* –°–∫—Ä—ã–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            display: none !important;
        }
        
        /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .zoom-controls {
            justify-content: center !important;
            left: 50% !important;
            right: auto !important;
            transform: translateX(-50%) !important;
        }
        
        /* –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ—Ç–∑—ã–≤—á–∏–≤–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –Ω–∞ —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        .zoom-btn {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –∫–∞—Å–∞–Ω–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .zoom-btn::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            z-index: -1;
        }
    }
    
    /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑—É–º–æ–º */
    .zoom-controls {
        position: absolute;
        top: 60px;
        right: 16px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 100;
    }
    
    .zoom-btn {
        width: 32px;
        height: 32px;
        background: rgba(0, 0, 0, 0.8);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∫–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É –ø–æ —Ü–µ–Ω—Ç—Ä—É */
    @media (max-width: 768px) {
        .zoom-controls {
            top: auto;
            bottom: 40px;
            right: auto;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: row;
            gap: 15px;
        }
        
        .zoom-btn {
            width: 50px;
            height: 50px;
            /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è */
            pointer-events: auto;
            position: relative;
            z-index: 10;
        }
        
        .zoom-btn:active {
            transform: scale(0.9);
            background: rgba(0, 0, 0, 0.9);
        }
        
        .zoom-btn:disabled {
            pointer-events: none !important;
            touch-action: none !important;
        }
        
        .zoom-btn:disabled:active {
            transform: none !important;
            background: rgba(255, 255, 255, 0.1) !important;
        }
        
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–∞—Å–∞–Ω–∏–π */
        .zoom-controls {
            pointer-events: auto;
            z-index: 100;
        }
    }
    
    .zoom-btn:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.05);
    }
    
    .zoom-btn:active {
        transform: scale(0.95);
    }
    
    .zoom-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
        /* –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —Å –ø–æ–Ω–∏–∂–µ–Ω–Ω–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å—é */
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ */
    .zoom-btn[data-processing="true"] {
        opacity: 0.7;
        pointer-events: none;
        transform: scale(0.95);
        transition: all 0.1s ease;
    }
    
    /* –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    @media (max-width: 768px) {
        .zoom-btn:disabled {
            display: none !important;
        }
        
        /* –û—Ç–∫–ª—é—á–∞–µ–º –¥–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ –∏ –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        .viewer,
        .viewer *,
        .image-canvas,
        .image-wrapper,
        .fullscreen-image {
            touch-action: manipulation !important;
            -webkit-tap-highlight-color: transparent !important;
            -webkit-user-select: none !important;
            -moz-user-select: none !important;
            -ms-user-select: none !important;
            user-select: none !important;
            pointer-events: auto !important;
        }
        
        /* –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ */
        .fullscreen-image {
            pointer-events: none !important;
        }
        
        /* –†–∞–∑—Ä–µ—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑—É–º–∞ */
        .zoom-controls,
        .zoom-controls * {
            pointer-events: auto !important;
        }
        
        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è */
        .viewer * {
            touch-action: manipulation !important;
            -webkit-tap-highlight-color: transparent !important;
        }
    }
    
    .zoom-btn:disabled:hover {
        background-color: rgba(255, 255, 255, 0.1);
        transform: none;
    }
    
    .zoom-btn:disabled:active {
        transform: none;
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .zoom-btn svg {
        width: 16px;
        height: 16px;
    }
    
    /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    @media (max-width: 768px) {
        .zoom-btn svg {
            width: 24px;
            height: 24px;
        }
    }
    
    .zoom-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    .zoom-btn:disabled:hover {
        background: rgba(0, 0, 0, 0.7);
        transform: none;
    }
    
    /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pointer-events –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
    #modal-container:not(.modal-hidden),
    #set-modal-container:not(.modal-hidden),
    #minifig-modal-container:not(.modal-hidden),
    #filter-modal-container:not(.modal-hidden),
    #settings-modal-container:not(.modal-hidden),
    #camera-selection-modal:not(.modal-hidden),
    #photo-camera-selection-modal:not(.modal-hidden) {
        pointer-events: auto !important;
    }
    

    
    .modal-content-enter {
        animation: scaleIn 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .modal-content-leave {
        animation: scaleOut 0.25s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    /* –ö–ª–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø—Ä–∏ –∞–Ω–∏–º–∞—Ü–∏—è—Ö –º–æ–¥–∞–ª–æ–∫ */
    #modal-content,
    #set-modal-content,
    #minifig-modal-content,
    #filter-modal-content,
    #settings-modal-content {
        overflow: hidden;            /* —á—Ç–æ–±—ã —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–µ –≤—ã—Ö–æ–¥–∏–ª–æ –∑–∞ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è */
        will-change: transform, opacity;
        contain: paint;              /* –∏–∑–æ–ª—è—Ü–∏—è —Å–ª–æ—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ */
    }
    .modal-content-enter,
    .modal-content-leave {
        transform-origin: center;
    }
    .modal-content-leave {
        box-shadow: none !important; /* —É–±–∏—Ä–∞–µ–º —Ç–µ–Ω—å –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ø–∏—Ä–∞–ª–∞ */
    }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö (–±–µ–∑ –ø–µ—Ä–µ—Å—Ç—Ä–æ–π–∫–∏ UI) */
    @media (max-width: 480px), (max-height: 700px) {
        /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã —Å–∞–º–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–æ–¥–∞–ª–∫–∏ */
        #modal-content,
        #set-modal-content,
        #minifig-modal-content {
            width: calc(100% - 1rem) !important;
            max-height: calc(100vh - 1rem) !important;
            height: auto !important;
            border-radius: 18px;
        }

        /* –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è —à–∞–ø–∫–∞ –º–æ–¥–∞–ª–∫–∏ */
        #modal-content > div:first-child,
        #set-modal-content > div:first-child,
        #minifig-modal-content > div:first-child {
            gap: 0.5rem !important;
        }
        #modal-content h2,
        #set-modal-content h2,
        #minifig-modal-content h2 {
            font-size: 0.95rem !important;
            line-height: 1.2 !important;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —á—É—Ç—å –º–µ–Ω—å—à–µ */
        .modal-close-btn {
            width: 28px;
            height: 28px;
        }
        .modal-close-btn svg {
            width: 14px;
            height: 14px;
        }

        /* –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª–∫–∏ –¥–µ—Ç–∞–ª–∏: —É–º–µ–Ω—å—à–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –ø–∞–¥–¥–∏–Ω–≥–∏ */
        #modal-content #modal-image-container {
            width: 9rem;
            height: 9rem;
        }
        #modal-scroll-area > div:first-child {
            padding: 0.5rem !important;
        }
        #modal-scroll-area > div:last-child {
            padding: 0.75rem !important;
        }

        /* –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ —É–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –∏ –ø—Ä–æ–º–µ–∂—É—Ç–∫–∏ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª–æ–∫ */
        #set-modal-content .p-4,
        #minifig-modal-content .p-4,
        #modal-content .p-4 {
            padding: 0.75rem !important;
        }
        #set-modal-content .gap-4,
        #minifig-modal-content .gap-4,
        #modal-content .gap-4 {
            gap: 0.5rem !important;
        }
        #set-modal-content .space-y-6,
        #minifig-modal-content .space-y-6,
        #modal-content .space-y-6 {
            row-gap: 0.75rem !important;
        }
        .modal-section-spacing {
            margin-bottom: 0.75rem;
        }
        .modal-section-title {
            margin-bottom: 0.5rem;
        }

        /* –ü–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤ ‚Äì –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤–∏–¥ */
        #color-selector-container {
            min-height: 96px !important;
        }
        .color-palette-inner button.w-8.h-8 {
            width: 1.75rem !important;
            height: 1.75rem !important;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–æ–≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è/–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ ‚Äì –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –ø—Ä–µ–≤—å—é –∏ —Ç–µ–∫—Å—Ç */
        #set-modal-content .w-12.h-12,
        #minifig-modal-content .w-12.h-12 {
            width: 2.5rem !important;
            height: 2.5rem !important;
        }
        #set-modal-content .w-5.h-5,
        #minifig-modal-content .w-5.h-5 {
            width: 1rem !important;
            height: 1rem !important;
        }
        #set-modal-content .text-lg,
        #minifig-modal-content .text-lg {
            font-size: 0.95rem !important;
        }
        #set-modal-content .text-sm,
        #minifig-modal-content .text-sm,
        #modal-content .text-sm {
            font-size: 0.8rem !important;
        }
        #modal-content .text-md {
            font-size: 0.9rem !important;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ ‚Äì —á—É—Ç—å —É–∂–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        #set-scroll-progress,
        #minifig-scroll-progress {
            right: 1px;
            width: 4px;
        }
    }
    
    /* –ü–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–∑–º—ã—Ç–∏—è —Ñ–æ–Ω–∞ —Ç–µ–ø–µ—Ä—å —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ transition –≤—ã—à–µ */
    
    /* Image viewer —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ —Ä–∞–∑–º—ã—Ç–∏—è —á–µ—Ä–µ–∑ transition –≤—ã—à–µ */
    
    /* Transition –¥–ª—è backdrop-filter —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤—ã—à–µ, –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Å—Ç–∞—é—Ç—Å—è */
    
    .part-card.animate-in,
    .set-card.animate-in,
    .minifig-card.animate-in {
        opacity: 0;
        animation: fadeInUp 0.1s ease-out forwards;
    }

/* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤ - –ú–ò–ù–ò–ú–ê–õ–¨–ù–´–ï */
.part-card.animate-in,.set-card.animate-in,.minifig-card.animate-in {
    animation-duration: 0.1s;
    animation-timing-function: ease-out;
    opacity: 0;
    animation-fill-mode: forwards;
}

/* –ö–Ω–æ–ø–∫–∏ –≥–∞–ª–µ—Ä–µ–∏: –ø–æ–ª–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π/—Å–º–µ—â–µ–Ω–∏–π –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
.set-gallery-btn {
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    transform: translateY(-50%) !important;
}
.set-gallery-btn:active, .set-gallery-btn:focus:active, .set-gallery-btn:focus {
    transform: translateY(-50%) !important;
    transition: none !important;
}
/* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ª—é–±—ã—Ö –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–Ω—ã—Ö transforms –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ */
.set-gallery-btn *, .set-gallery-btn svg { pointer-events: none; }

/* –ú–∞–ª—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è (–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–≤–∞–π–ø—ã –∏ —Ç–æ—á–∫–∏) */
@media (max-width: 640px) {
    .set-gallery-btn,
    #set-modal-content [data-action="set-gallery-prev"],
    #set-modal-content [data-action="set-gallery-next"],
    /* –ö–Ω–æ–ø–∫–∏ –≥–∞–ª–µ—Ä–µ–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ —Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    #minifig-modal-content [data-action="minifig-gallery-prev"],
    #minifig-modal-content [data-action="minifig-gallery-next"],
    /* –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∞—Ä–∏–∞—Ü–∏–π –¥–µ—Ç–∞–ª–∏ —Å–∫—Ä—ã–≤–∞–µ–º –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    #modal-content [data-action="part-variant-prev"],
    #modal-content [data-action="part-variant-next"] {
        display: none !important;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã - –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø */
@keyframes pageLoad {
    from {
        opacity: 0;
        transform: translateY(0.1rem) scale(0.995);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø–æ–ª–æ—Å—ã –∑–∞–≥—Ä—É–∑–∫–∏ */
@keyframes progressShimmer {
    0% {
        background-position: -200% 0;
    }
    100% {
        background-position: 200% 0;
    }
}

/* –ú–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    .modal-title-multiline {
        white-space: normal !important;
        text-overflow: ellipsis !important;
        display: -webkit-box !important;
        -webkit-line-clamp: 2 !important;
        line-clamp: 2 !important;
        -webkit-box-orient: vertical !important;
        line-height: 1.2 !important;
        max-height: calc(1.2em * 2) !important;
        word-wrap: break-word !important;
        word-break: break-word !important;
        hyphens: auto !important;
    }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π */
    #part-search-title {
        font-size: 1rem !important;
        line-height: 1.25 !important;
    }
    
    /* –ó–∞—â–∏—Ç–∞ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –æ—Ç —Å–∂–∞—Ç–∏—è */
    #close-part-search-modal {
        flex-shrink: 0 !important;
        min-width: 2rem !important;
        min-height: 2rem !important;
        width: 2rem !important;
        height: 2rem !important;
    }
}

/* –û–±—â–∞—è –∑–∞—â–∏—Ç–∞ –∫–Ω–æ–ø–æ–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –æ—Ç —Å–∂–∞—Ç–∏—è */
.modal-close-btn {
    flex-shrink: 0 !important;
    min-width: 2rem !important;
    min-height: 2rem !important;
    border-radius: 50% !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

#loading-progress {
    background: linear-gradient(90deg, #3b82f6, #1d4ed8, #3b82f6) !important;
    background-size: 200% 100% !important;
    animation: progressShimmer 2s ease-in-out infinite !important;
}

.page-loading .part-card.animate-in,
.page-loading .set-card.animate-in,
.page-loading .minifig-card.animate-in {
    animation: pageLoad 0.1s ease-out forwards;
}

/* –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
.sidebar-open-large .part-card.animate-in,
.sidebar-open-large .set-card.animate-in,
.sidebar-open-large .minifig-card.animate-in {
    /* animation-duration: 0.2s; */
    opacity: 1 !important;
    transform: none !important;
}
/* –ê–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫ */
body.tab-switching .part-card,
body.tab-switching .set-card,
body.tab-switching .minifig-card {
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
}

/* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–¥—ë—Ä–≥–∏–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫ */
body.tab-switching button[data-view] {
    transition: none !important;
    transform: translateZ(0) !important;
    backface-visibility: hidden !important;
    -webkit-backface-visibility: hidden !important;
}

/* –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
.search-results .part-card,
.search-results .set-card,
.search-results .minifig-card {
    /* animation-duration: 0.25s; */
    opacity: 1 !important;
    transform: none !important;
}

/* –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –ø—É—Å—Ç—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ */
.empty-results {
    /* animation: fadeInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards; */
    opacity: 1 !important;
    transform: none !important;
}

/* –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞ */
@media (max-width: 768px) {
    .part-card.animate-in,
    .set-card.animate-in,
    .minifig-card.animate-in {
        /* animation-duration: 0.3s; */
        opacity: 1 !important;
        transform: none !important;
    }
}

/* –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 480px) {
    .part-card.animate-in,
    .set-card.animate-in,
    .minifig-card.animate-in {
        /* animation-duration: 0.25s; */
        opacity: 1 !important;
        transform: none !important;
    }
    
    /* –û—Ç–∫–ª—é—á–∞–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã —Ç–æ–ª—å–∫–æ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
    .part-card:hover,
    .set-card:hover,
    .minifig-card:hover {
        transform: none !important;
    }
}

/* –û–ø—Ä–µ–¥–µ–ª—è–µ–º breakpoint xs –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 480px) {
    .xs\:hidden {
        display: none !important;
    }
    
    .xs\:inline {
        display: inline !important;
    }
}

/* –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞—Ä—Ç–æ—á–µ–∫ */
.part-card img,
.set-card img,
.minifig-card img {
    /* will-change: transform; */
    /* backface-visibility: hidden; */
    /* transform: translateZ(0); */
    /* transition: opacity 0.3s ease-in-out; */
    opacity: 1 !important;
}

/* –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π */
.part-card img[loading],
.set-card img[loading],
.minifig-card img[loading] {
    opacity: 1 !important;
}

.part-card img:not([loading]),
.set-card img:not([loading]),
.minifig-card img:not([loading]) {
    opacity: 1 !important;
}

/* –≠—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫: –±–∞–∑–æ–≤—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è hover-–∞–Ω–∏–º–∞—Ü–∏–∏ */
.part-card,
.set-card,
.minifig-card {
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out !important;
    will-change: transform;
}

/* –õ–µ–≥–∫–æ–µ –ø–æ–¥–Ω—è—Ç–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
.part-card:hover,
.set-card:hover,
.minifig-card:hover {
    transform: translateY(-6px) scale(1.03) !important;
    box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.08) !important;
}

/* –§–æ—Ä—Å–∏—Ä—É–µ–º hover-–ø–æ–¥–Ω—è—Ç–∏–µ –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö, –µ—Å–ª–∏ –Ω–µ –∏–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
@media (pointer: fine) and (min-width: 769px) {
    body:not(.scrolling):not(.resizing):not(.tab-switching):not(.searching):not(.filtering):not(.sorting) .part-card:hover,
    body:not(.scrolling):not(.resizing):not(.tab-switching):not(.searching):not(.filtering):not(.sorting) .set-card:hover,
    body:not(.scrolling):not(.resizing):not(.tab-switching):not(.searching):not(.filtering):not(.sorting) .minifig-card:hover {
        transform: translateY(-6px) scale(1.03) !important;
        box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.15), 0 15px 15px -5px rgba(0, 0, 0, 0.08) !important;
    }
}

/* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–æ—Ä–≥–∞–Ω–∏—è */
@media (prefers-reduced-motion: reduce), (max-height: 800px) {
    .part-card.animate-in,
    .set-card.animate-in,
    .minifig-card.animate-in {
        animation: none !important;
        opacity: 1 !important;
        /* –°–æ—Ö—Ä–∞–Ω—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–∞–∂–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∞–Ω–∏–º–∞—Ü–∏–π */
    }
    
    .part-card:not(.animate-in),
    .set-card:not(.animate-in),
    .minifig-card:not(.animate-in) {
        animation: none !important;
        opacity: 1 !important;
        /* –°–æ—Ö—Ä–∞–Ω—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–∞–∂–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∞–Ω–∏–º–∞—Ü–∏–π */
    }
}

/* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
.scrolling .part-card,
.scrolling .set-card,
.scrolling .minifig-card {
    animation: none !important;
    opacity: 1 !important;
    /* –°–æ—Ö—Ä–∞–Ω—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–∞–∂–µ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ - –û–¢–ö–õ–Æ–ß–ï–ù–ê */
.part-card:not(.animate-in),
.set-card:not(.animate-in),
.minifig-card:not(.animate-in) {
    opacity: 1 !important;
    /* –°–æ—Ö—Ä–∞–Ω—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–∞–∂–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∞–Ω–∏–º–∞—Ü–∏–π */
    animation: none !important;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ" - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
#load-more-button-catalog,
#load-more-button-collection {
    transition: all 0.2s ease-out;
    transform: translateY(0);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ - –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø */
.part-card[data-collection-change="added"],
.set-card[data-collection-change="added"],
.minifig-card[data-collection-change="added"] {
    animation: collectionAdd 0.2s ease-out forwards !important;
    will-change: box-shadow, transform, opacity;
}

/* –ú—è–≥–∫–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å */
.part-card.collection-added,
.set-card.collection-added,
.minifig-card.collection-added {
    animation: collectionAdd 0.25s ease-out forwards !important;
    will-change: box-shadow, transform, opacity;
}

.part-card[data-collection-change="removed"],
.set-card[data-collection-change="removed"],
.minifig-card[data-collection-change="removed"] {
    animation: collectionRemove 0.12s ease-in forwards;
}

@keyframes collectionAdd {
    from {
        opacity: 0;
        transform: scale(0.99);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes collectionRemove {
    from {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    to {
        opacity: 0;
        transform: translateY(2px) scale(0.98);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—à–∏–±–æ–∫ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.loading-state {
    animation: loadingPulse 1.5s ease-in-out infinite;
}
.error-state {
    animation: errorShake 0.5s ease-in-out;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ - –û–¢–ö–õ–Æ–ß–ï–ù–ê */
.filter-change .part-card,
.filter-change .set-card,
.filter-change .minifig-card {
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
}

@keyframes filterChange {
    from {
        opacity: 0;
        transform: translateY(0.05rem) scale(0.999);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ - –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø */
.sort-change .part-card,
.sort-change .set-card,
.sort-change .minifig-card {
    animation: sortChange 0.05s ease-out forwards;
}

/*
@keyframes sortChange {
    from {
        opacity: 0;
        transform: translateX(-0.05rem) scale(0.999);
    }
    to {
        opacity: 1;
        transform: translateX(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è - –û–¢–ö–õ–Æ–ß–ï–ù–ê */
.view-change .part-card,
.view-change .set-card,
.view-change .minifig-card {
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
}

/*
@keyframes viewChange {
    from {
        opacity: 0;
        transform: translateY(0.05rem) scale(0.999);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è - –û–¢–ö–õ–Æ–ß–ï–ù–ê */
.subview-change .part-card,
.subview-change .set-card,
.subview-change .minifig-card {
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
}

/*
@keyframes subviewChange {
    from {
        opacity: 0;
        transform: translateY(0.4rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ —Ç–µ–º—ã - –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø */
.category-change .part-card,
.theme-change .set-card {
    animation: categoryChange 0.05s ease-out forwards;
}

/*
@keyframes categoryChange {
    from {
        opacity: 0;
        transform: translateY(0.3rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ - –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø */
.color-change .part-card {
    animation: colorChange 0.05s ease-out forwards;
}

/*
@keyframes colorChange {
    from {
        opacity: 0;
        transform: scale(0.98);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≥–æ–¥–∞ –∏–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–µ—Ç–∞–ª–µ–π - –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø */
.year-change .set-card,
.parts-change .set-card {
    animation: yearPartsChange 0.05s ease-out forwards;
}

/*
@keyframes yearPartsChange {
    from {
        opacity: 0;
        transform: translateY(0.3rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ - –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø */
.popularity-change .part-card,
.popularity-change .set-card {
    animation: popularityChange 0.05s ease-out forwards;
}

/*
@keyframes popularityChange {
    from {
        opacity: 0;
        transform: translateY(0.4rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ - –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø */
.quantity-change .part-card,
.quantity-change .set-card,
.quantity-change .minifig-card {
    animation: quantityChange 0.05s ease-out forwards;
}

/*
@keyframes quantityChange {
    from {
        opacity: 0;
        transform: scale(0.97);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ - –û–¢–ö–õ–Æ–ß–ï–ù–ê */
.search-change .part-card,
.search-change .set-card,
.search-change .minifig-card {
    animation: none !important;
    opacity: 1 !important;
    transform: none !important;
}

/*
@keyframes searchChange {
    from {
        opacity: 0;
        transform: translateY(0.4rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ - –ú–ò–ù–ò–ú–ê–õ–¨–ù–ê–Ø */
.favorite-change .part-card,
.favorite-change .set-card,
.favorite-change .minifig-card {
    animation: favoriteChange 0.05s ease-out forwards;
}

/*
@keyframes favoriteChange {
    from {
        opacity: 0;
        transform: scale(0.97);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.settings-change .part-card,
.settings-change .set-card,
.settings-change .minifig-card {
    animation: settingsChange 0.2s ease-out forwards;
}

@keyframes settingsChange {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–∑—ã–∫–∞ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.language-change .part-card,
.language-change .set-card,
.language-change .minifig-card {
    animation: languageChange 0.2s ease-out forwards;
}

/*
@keyframes languageChange {
    from {
        opacity: 0;
        transform: translateY(0.4rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

    /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–º—ã (—Å–≤–µ—Ç–ª–∞—è/—Ç–µ–º–Ω–∞—è) - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.theme-switch .part-card,
.theme-switch .set-card,
.theme-switch .minifig-card {
    animation: themeSwitch 0.3s ease-out forwards;
}

/* –ü–æ–¥–ª–æ–∂–∫–∞ –¥–ª—è —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è —Å–ø–∏—Å–∫–æ–≤ */
.sidebar-dropdown {
    background: rgba(55, 65, 81, 0.3); /* bg-gray-700/30 */
    border-radius: 12px;
    margin: 4px 0;
    padding: 2px;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(75, 85, 99, 0.2); /* border-gray-600/20 */
}

.sidebar-dropdown ul {
    background: rgba(31, 41, 55, 0.4); /* bg-gray-800/40 */
    border-radius: 8px;
    padding: 4px;
    margin: 0;
}

/*
@keyframes themeSwitch {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ —à—Ä–∏—Ñ—Ç–∞ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.font-size-change .part-card,
.font-size-change .set-card,
.font-size-change .minifig-card {
    animation: fontSizeChange 0.2s ease-out forwards;
}

/*
@keyframes fontSizeChange {
    from {
        opacity: 0;
        transform: scale(0.99);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
*/
/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–µ—Ç–∫–∏ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.grid-change .part-card,
.grid-change .set-card,
.grid-change .minifig-card {
    animation: gridChange 0.2s ease-out forwards;
}

/*
@keyframes gridChange {
    from {
        opacity: 0;
        transform: translateY(0.4rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.order-change .part-card,
.order-change .set-card,
.order-change .minifig-card {
    animation: orderChange 0.2s ease-out forwards;
}

/*
@keyframes orderChange {
    from {
        opacity: 0;
        transform: translateX(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateX(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.pagination-change .part-card,
.pagination-change .set-card,
.pagination-change .minifig-card {
    animation: paginationChange 0.2s ease-out forwards;
}
/*
@keyframes paginationChange {
    from {
        opacity: 0;
        transform: translateY(0.4rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.export-change .part-card,
.export-change .set-card,
.export-change .minifig-card {
    animation: exportChange 0.2s ease-out forwards;
}

/*
@keyframes exportChange {
    from {
        opacity: 0;
        transform: scale(0.98);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–ø–æ—Ä—Ç–∞ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.import-change .part-card,
.import-change .set-card,
.import-change .minifig-card {
    animation: importChange 0.2s ease-out forwards;
}

/*
@keyframes importChange {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}
*/

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.sync-change .part-card,
.sync-change .set-card,
.sync-change .minifig-card {
    animation: syncChange 0.2s ease-out forwards;
}

@keyframes syncChange {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.backup-change .part-card,
.backup-change .set-card,
.backup-change .minifig-card {
    animation: backupChange 0.2s ease-out forwards;
}

@keyframes backupChange {
    from {
        opacity: 0;
        transform: translateY(0.4rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.restore-change .part-card,
.restore-change .set-card,
.restore-change .minifig-card {
    animation: restoreChange 0.2s ease-out forwards;
}

@keyframes restoreChange {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—á–∏—Å—Ç–∫–∏ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.clear-change .part-card,
.clear-change .set-card,
.clear-change .minifig-card {
    animation: clearChange 0.2s ease-out forwards;
}

@keyframes clearChange {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–±—Ä–æ—Å–∞ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.reset-change .part-card,
.reset-change .set-card,
.reset-change .minifig-card {
    animation: resetChange 0.2s ease-out forwards;
}

@keyframes resetChange {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.update-change .part-card,
.update-change .set-card,
.update-change .minifig-card {
    animation: updateChange 0.2s ease-out forwards;
}

@keyframes updateChange {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.reload-change .part-card,
.reload-change .set-card,
.reload-change .minifig-card {
    animation: reloadChange 0.2s ease-out forwards;
}

@keyframes reloadChange {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ - –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø */
.restart-change .part-card,
.restart-change .set-card,
.restart-change .minifig-card {
    animation: restartChange 0.2s ease-out forwards;
}

@keyframes restartChange {
    from {
        opacity: 0;
        transform: translateY(0.5rem) scale(0.99);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è */
.finish-change .part-card,
.finish-change .set-card,
.finish-change .minifig-card {
    animation: finishChange 0.95s cubic-bezier(0.4, 0, 0.2, 1) forwards;
}

@keyframes finishChange {
    from {
        opacity: 0;
        transform: translateY(4.2rem) scale(0.68) rotate(-12deg);
    }
    to {
        opacity: 1;
        transform: translateY(0) scale(1) rotate(0deg);
    }
}

@keyframes loadingPulse {
    0%, 100% {
        opacity: 0.6;
        transform: scale(1);
    }
    50% {
        opacity: 1;
        transform: scale(1.05);
    }
}

@keyframes errorShake {
    0%, 100% {
        transform: translateX(0);
    }
    25% {
        transform: translateX(-5px);
    }
    75% {
        transform: translateX(5px);
    }
}

#load-more-button-catalog:hover,
#load-more-button-collection:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.2);
}

/* Hover —ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∏–ª—è—Ö –≤—ã—à–µ */

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –≤–∞—Ä–∏–∞—Ü–∏–π */
#variation-select-button {
    max-width: 100% !important;
    width: 100% !important;
    box-sizing: border-box;
    text-overflow: ellipsis;
    white-space: nowrap;
    background-color: #374151 !important;
    border: 1px solid #4B5563 !important;
    border-radius: 18px !important;
    color: white !important;
    font-size: 14px !important;
    line-height: 1.5 !important;
    transition: all 0.2s ease !important;
    min-width: 0 !important;
    flex-shrink: 1 !important;
    cursor: pointer !important;
    user-select: none !important;
}

#variation-select-button:hover {
    border-color: #6B7280 !important;
    background-color: #4B5563 !important;
}

#variation-select-button:focus {
    outline: none !important;
    border-color: #6B7280 !important;
    box-shadow: none !important;
}

#variation-select-button.open {
    border-color: #6B7280 !important;
    background-color: #4B5563 !important;
}

#variation-select-button.open svg {
    transform: rotate(180deg) !important;
}

#variation-dropdown {
    position: absolute !important;
    z-index: 99999 !important;
    background-color: #374151 !important;
    border: 1px solid #4B5563 !important;
    border-radius: 18px !important;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
    max-height: 240px !important;
    overflow-y: auto !important;
    transition: all 0.2s ease !important;
    box-sizing: border-box !important;
    min-width: 100% !important;
    max-width: 100% !important;
    top: 100% !important;
    left: 0 !important;
    right: 0 !important;
    margin-top: 4px !important;
    /* –û—Ç–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
    overscroll-behavior: contain !important;
    -webkit-overflow-scrolling: touch !important;
    scrollbar-width: thin !important;
    scrollbar-color: #6B7280 #374151 !important;
    /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
    padding: 8px 6px 8px 0 !important;
}

/* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ */
#variation-dropdown::-webkit-scrollbar {
    width: 4px !important;
    height: 4px !important;
    background: transparent !important;
}

#variation-dropdown::-webkit-scrollbar-track {
    background: transparent !important;
    border-radius: 0 !important;
    margin: 0 !important;
    padding: 0 !important;
}

#variation-dropdown::-webkit-scrollbar-thumb {
    background: #6B7280 !important;
    border-radius: 2px !important;
    min-height: 20px !important;
    border: none !important;
    margin: 8px 0 !important;
}

#variation-dropdown::-webkit-scrollbar-thumb:hover {
    background: #9CA3AF !important;
}

#variation-dropdown::-webkit-scrollbar-corner {
    background: transparent !important;
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è */
div#variation-dropdown::-webkit-scrollbar {
    width: 4px !important;
}

div#variation-dropdown::-webkit-scrollbar-thumb {
    background: #6B7280 !important;
    border-radius: 2px !important;
    margin: 8px 0 !important;
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ */
#variation-dropdown {
    scrollbar-width: thin !important;
    scrollbar-color: #6B7280 transparent !important;
}


.variation-option {
    max-width: 100% !important;
    width: 100% !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    white-space: nowrap !important;
    box-sizing: border-box;
    padding: 8px 12px !important;
    background-color: #374151 !important;
    color: white !important;
    cursor: pointer !important;
    transition: background-color 0.15s ease !important;
    border-bottom: 1px solid #4B5563 !important;
}

.variation-option:last-child {
    border-bottom: none !important;
}

.variation-option:hover {
    background-color: #4B5563 !important;
}

.variation-option.selected {
    background-color: #3B82F6 !important;
}

.variation-option.selected:hover {
    background-color: #2563EB !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
.variation-select-container {
    position: relative !important;
    width: 100% !important;
    max-width: 100% !important;
    overflow: visible !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ */
button[disabled] {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    pointer-events: none !important;
}

button[disabled]:hover {
    background-color: inherit !important;
    transform: none !important;
}

/* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Å—Ç—Ä–µ–ª–∫—É –±—Ä–∞—É–∑–µ—Ä–∞ */
.variation-select-container::after {
    display: none !important;
}

/* –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
@media (max-width: 768px) {
    #variation-select-button {
        font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
    }
    
    /* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    #variation-dropdown::-webkit-scrollbar {
        width: 3px !important;
        height: 3px !important;
    }
    
    #variation-dropdown::-webkit-scrollbar-track {
        background: transparent !important;
        border-radius: 0 !important;
    }
    
    #variation-dropdown::-webkit-scrollbar-thumb {
        background: #6B7280 !important;
        border-radius: 1.5px !important;
        min-height: 15px !important;
        border: none !important;
    }
    
    #variation-dropdown::-webkit-scrollbar-thumb:hover {
        background: #9CA3AF !important;
    }
    
    #variation-dropdown {
        padding: 10px 4px 10px 0 !important;
    }
}
    
    /* Loading indicator styles */
    #loading-container {
        transition: opacity 0.5s ease-out;
        min-height: 400px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–æ—Ä–≥–∞–Ω–∏—è */
    /* #loading-details {
        min-height: 3rem; 
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        white-space: pre-line; 
        line-height: 1.4; 
        padding: 0.5rem 0; 
    } */
    
    /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É —Å—Ç–∞—Ç—É—Å–∞ */
    #loading-status {
        min-height: 1.5rem; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
    .tip-container {
        min-height: 2rem; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
    .loading-progress-container {
        min-height: 2rem; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ø–æ–ª–æ—Å—ã –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 1rem 0;
    }
    
    /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–º–µ—â–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ç–µ–∫—Å—Ç–∞ */
    .loading-content > * {
        transition: none; /* –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ */
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–æ—Ä–≥–∞–Ω–∏—è */
    #loading-container .text-center > * {
        transition: none !important;
        will-change: auto;
    }
    
    /* –§–∏–∫—Å–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –∑–∞–≥–æ–ª–æ–≤–∫–∞ */
    h2 {
        margin: 0 0 0.5rem 0;
        min-height: 2rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* –§–∏–∫—Å–∏—Ä—É–µ–º –ø–æ–∑–∏—Ü–∏—é –ª–æ–∞–¥–µ—Ä–∞ */
    /* .loader {
        position: relative;
        margin: 0 auto 1rem auto;
    } */
    
    #loading-container.hidden {
        opacity: 0;
        pointer-events: none;
    }
    
    .loading-step {
        opacity: 1;
        /* animation: fadeInUp 0.3s ease-out forwards; */
    }
    
    /* .loading-step:nth-child(1) { animation-delay: 0.1s; } */
    /* .loading-step:nth-child(2) { animation-delay: 0.2s; } */
    /* .loading-step:nth-child(3) { animation-delay: 0.3s; } */
    /* .loading-step:nth-child(4) { animation-delay: 0.4s; } */
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ */
    .tip-container {
        position: relative;
        overflow: hidden;
        min-height: 1.5rem;
    }
    
    .tip-text {
        transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(0);
        opacity: 1;
    }
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏ */
    .tip-card {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.75rem;
        background: linear-gradient(135deg, rgba(17,24,39,0.35), rgba(31,41,55,0.35));
        border: 1px solid rgba(59,130,246,0.25);
        border-radius: 18px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.25), inset 0 0 0 1px rgba(255,255,255,0.04);
        color: #93c5fd; /* text-blue-300 */
        backdrop-filter: blur(4px);
    }
    .tip-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.75rem;
        height: 1.75rem;
        border-radius: 9999px;
        background: radial-gradient(circle at 40% 35%, rgba(59,130,246,0.35), rgba(30,64,175,0.15));
        box-shadow: inset 0 0 0 1px rgba(59,130,246,0.35), 0 0 0 1px rgba(255,255,255,0.04);
    }
    .tip-line {
        font-size: 0.8rem;
        line-height: 1.2rem;
        color: #bfdbfe; /* text-blue-200 */
    }
    
    .tip-text.fade-out {
        transform: translateY(-20px);
        opacity: 0;
    }
    
    .tip-text.fade-in {
        transform: translateY(20px);
        opacity: 0;
    }
    
    .tip-text.fade-in.show {
        transform: translateY(0);
        opacity: 1;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
    @keyframes tipSlideIn {
        0% {
            transform: translateY(30px);
            opacity: 0;
        }
        100% {
            transform: translateY(0);
            opacity: 1;
        }
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ */
    @keyframes tipSlideOut {
        0% {
            transform: translateY(0);
            opacity: 1;
        }
        100% {
            transform: translateY(-30px);
            opacity: 0;
        }
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏—è –≤–Ω–∏–º–∞–Ω–∏—è */
    @keyframes tipPulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.02);
        }
    }
    
    .tip-text.pulse { animation: none !important; }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
    .inactivity-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.5s ease-in-out;
    }

    .inactivity-overlay.show {
        opacity: 1;
    }

    .inactivity-content {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.3) 0%, rgba(55, 65, 81, 0.3) 100%);
        border: 2px solid rgba(75, 85, 99, 0.8);
        border-radius: 18px;
        padding: 2rem;
        text-align: center;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        transform: scale(0.9);
        transition: transform 0.5s ease-in-out;
        backdrop-filter: blur(10px);
    }

    .inactivity-overlay.show .inactivity-content {
        transform: scale(1);
    }

    .inactivity-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: bounce 2s ease-in-out infinite;
    }

    .inactivity-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #fbbf24;
        margin-bottom: 1rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .inactivity-text {
        font-size: 1.1rem;
        color: #e5e7eb;
        line-height: 1.6;
        margin-bottom: 1.5rem;
    }

    .inactivity-close {
        position: absolute;
        top: 1rem;
        right: 1rem;
        width: 32px;
        height: 32px;
        background: #dc2626;
        border-radius: 50%;
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: all 0.2s ease;
    }

    .inactivity-close:hover {
        background: #b91c1c;
        transform: scale(1.1) rotate(2deg);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    .inactivity-close:active {
        transform: scale(0.95) rotate(0deg);
    }

    .inactivity-close svg {
        width: 16px;
        height: 16px;
        stroke-width: 2.5;
        transition: transform 0.3s ease;
    }

    .inactivity-close:hover svg {
        transform: scale(1.1);
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {
            transform: translateY(0);
        }
        40% {
            transform: translateY(-10px);
        }
        60% {
            transform: translateY(-5px);
        }
    }

    /* –†–∞–∑–º—ã—Ç–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
    body.inactive #main-content,
    body.inactive #sidebar-container,
    body.inactive #header-container {
        filter: blur(3px);
        transition: filter 0.5s ease-in-out;
    }

    /* –û–≤–µ—Ä–ª–µ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–µ—Ç—Å—è —á–µ—Ç–∫–∏–º */
    .inactivity-overlay {
        filter: blur(0) !important;
    }


    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–Ω—è—Ç—å –Ω–∞ –≤–µ—Ä—Ö" - —Ç–æ—á–Ω–æ –∫–∞–∫ —É –∫–Ω–æ–ø–æ–∫ –≤ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    #scroll-to-top-btn:not(.opacity-0) {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05) !important;
        transition: all 0.15s ease !important;
    }
    
    #scroll-to-top-btn:not(.opacity-0):hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 0 1px rgba(37, 99, 235, 0.25) !important;
    }
    
    #scroll-to-top-btn:active {
        transform: scale(0.98) !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è */
    #autocomplete-dropdown {
        position: absolute;
        top: calc(100% + 4px);
        left: 0;
        right: 0;
        border-radius: 18px;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(8px);
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.95) 0%, rgba(17, 24, 39, 0.95) 100%);
        border: 1px solid rgba(75, 85, 99, 0.3);
        z-index: 50;
        max-height: 16rem;
        overflow-y: auto;
        display: none;
    }
    
    /* –°–∫—Ä—ã–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª–±–∞—Ä—ã –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è */
    #autocomplete-dropdown::-webkit-scrollbar {
        display: none;
    }
    
    #autocomplete-dropdown {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    
    .autocomplete-item {
        padding: 0.875rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid rgba(75, 85, 99, 0.2);
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        position: relative;
        overflow: hidden;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .autocomplete-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        transform: scaleY(0);
        transition: transform 0.2s ease;
    }
    
    .autocomplete-item:hover {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(37, 99, 235, 0.05) 100%);
        transform: translateX(2px);
    }
    
    .autocomplete-item:hover::before {
        transform: scaleY(1);
    }
    
    .autocomplete-item.selected {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.2) 0%, rgba(37, 99, 235, 0.1) 100%);
        transform: translateX(4px);
    }
    
    .autocomplete-item.selected::before {
        transform: scaleY(1);
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
    }
    
    .autocomplete-item-icon {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.375rem;
        flex-shrink: 0;
    }
    
    .autocomplete-item-icon.part {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
    }
    
    .autocomplete-item-icon.set {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
    }
    
    .autocomplete-item-icon.minifig {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        color: white;
        box-shadow: 0 2px 4px rgba(139, 92, 246, 0.3);
    }
    
    .autocomplete-item-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .autocomplete-item-text {
        color: #e5e7eb;
        font-size: 0.875rem;
        line-height: 1.4;
        font-weight: 500;
        word-wrap: break-word;
        hyphens: auto;
        flex: 1;
    }
    
    .autocomplete-item-text .highlight {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: #1f2937;
        font-weight: 700;
        padding: 0.125rem 0.25rem;
        border-radius: 0.25rem;
        box-shadow: 0 1px 2px rgba(251, 191, 36, 0.3);
    }
    
    .autocomplete-item-id {
        font-size: 0.75rem;
        color: #9ca3af;
        font-family: 'Courier New', monospace;
        margin-top: 0.25rem;
        font-weight: 400;
    }
    
    /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞ */
    .animate-dashboardIn {
        animation: dashboardIn 0.6s ease-out;
    }
    
    @keyframes dashboardIn {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    .animate-chartIn {
        animation: chartIn 0.8s ease-out;
    }
    
    @keyframes chartIn {
        from {
            opacity: 0;
            transform: translateY(30px) scale(0.9);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º */
    .pie-chart-container {
        background: linear-gradient(135deg, rgba(31, 41, 55, 0.1) 0%, rgba(17, 24, 39, 0.1) 100%);
        border-radius: 18px;
        padding: 1rem;
        backdrop-filter: blur(8px);
    }
    
    /* –£–±–∏—Ä–∞–µ–º —Ç–µ–Ω–∏ —Å SVG */
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–∞—à–±–æ—Ä–¥–∞ —Å —Ü–≤–µ—Ç–Ω—ã–º —Å–≤–µ—á–µ–Ω–∏–µ–º */
    .group:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 
                    0 4px 6px -2px rgba(0, 0, 0, 0.05),
                    0 0 20px rgba(0, 0, 0, 0.1),
                    0 0 40px color-mix(in srgb, var(--item-color, rgb(107, 114, 128)) 30%, transparent);
    }
    
    .pie-sector-group {
        transition: none;
        transform-origin: center;
    }
    
    .percentage-group {
        transition: none;
        transform-origin: center;
    }
    
    /* hover –±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ ‚Äî –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –æ—Ç–∫–ª—é—á–µ–Ω—ã */
    .pie-sector-group:hover { outline: none; }
    
    /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º (–¥–æ–Ω–∞—Ç-—Å–µ–≥–º–µ–Ω—Ç—ã) */
    .pie-chart-svg { overflow: visible; }
    .pie-base-ring { opacity: 0.25; }
    .pie-segment { pointer-events: none; }
    
    .percentage-container {
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: scale(0.8);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ –∂–µ–ª–∞–Ω–∏–π */
    .wishlist-item-checkbox.selected {
        background-color: rgba(59, 130, 246, 0.7) !important;
        color: white !important;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π */
    .wishlist-image-container {
        position: relative;
        width: 100%;
        height: 10rem; /* 160px */
        background: linear-gradient(135deg, #374151, #1f2937);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem;
    }
    
    .wishlist-image-inner {
        position: relative;
        width: 100%;
        height: 100%;
        background: white;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
    }
    
    .wishlist-type-icon {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        z-index: 20;
    }
    
    .wishlist-item-checkbox {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        z-index: 30;
        background: rgba(17, 24, 39, 0.4);
        color: rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        width: 1.5rem;
        height: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        opacity: 1;
        transition: all 0.15s;
        padding: 0.25rem;
    }
    
    .wishlist-item-checkbox:hover {
        background: rgba(17, 24, 39, 0.6);
        color: white;
    }
    
    .wishlist-item-checkbox.selected {
        background: rgba(59, 130, 246, 0.7) !important;
        color: white !important;
    }
    
    .wishlist-info-section {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .wishlist-title-section {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }
    
    .wishlist-controls {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .wishlist-color-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.25rem 0.5rem;
        background: rgba(55, 65, 81, 0.5);
        border-radius: 0.5rem;
        border: 1px solid rgba(75, 85, 99, 0.5);
    }
    
    .wishlist-color-placeholder {
        flex: 1;
    }
    
    .wishlist-move-buttons {
        display: flex;
        flex-direction: row;
        gap: 0.25rem;
    }
    
    /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 640px) {
        .wishlist-item {
            min-width: 0;
            flex-shrink: 0;
        }
        
        .wishlist-image-container {
            height: 8rem; /* 128px –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        }
        
        .wishlist-item-checkbox {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
        }
        
        .wishlist-item-checkbox svg {
            display: block !important;
            margin: 0 auto !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö */
        .part-card,
        .set-card,
        .minifig-card {
            min-width: 0;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫ –Ω–∞ –∫—Ä–∞—é —ç–∫—Ä–∞–Ω–∞ */
        .part-card .card-image-container,
        .set-card .card-image-container,
        .minifig-card .card-image-container {
            overflow: hidden;
        }
        
        /* –ö–Ω–æ–ø–∫–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö –∫–∞—Ç–∞–ª–æ–≥–∞ –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .part-card button,
        .set-card button,
        .minifig-card button {
            opacity: 1 !important;
        }
    }
    
    /* –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å hover-—Å–æ—Å—Ç–æ—è–Ω–∏–π –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è */
    @media (max-width: 768px), (hover: none), (pointer: coarse) {
        /* –ö–æ–≥–¥–∞ –Ω–∞ <body> –≤–∏—Å–∏—Ç –∫–ª–∞—Å—Å no-hover ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–±–∏—Ä–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã :hover */
        body.no-hover :hover,
        body.no-hover .group:hover,
        body.no-hover .group:hover * {
            transform: none !important;
        }
        
        /* –°–∫—Ä—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É –ª—É–ø—ã –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        #modal-content [data-action="view-image-fullscreen"] .group-hover\:opacity-100,
        #set-modal-content [data-action="view-image-fullscreen"] .group-hover\:opacity-100,
        #minifig-modal-content [data-action="view-image-fullscreen"] .group-hover\:opacity-100 {
            display: none !important;
        }
        
        /* –£–±–∏—Ä–∞–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç—ã –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö –Ω–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
        #modal-content [data-action="view-image-fullscreen"]:hover .group-hover\:opacity-100,
        #set-modal-content [data-action="view-image-fullscreen"]:hover .group-hover\:opacity-100,
        #minifig-modal-content [data-action="view-image-fullscreen"]:hover .group-hover\:opacity-100 {
            opacity: 0 !important;
        }
        
        /* –û—Ç–∫–ª—é—á–∞–µ–º hover –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
        .part-card:hover,
        .set-card:hover,
        .minifig-card:hover,
        .wishlist-item:hover {
            transform: none !important;
            box-shadow: none !important;
        }
  
    }

    /* –û—Ç–∫–ª—é—á–∞–µ–º margin-top —Ç–æ–ª—å–∫–æ –¥–ª—è –±–ª–æ–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
    .flex-shrink-0.mt-4.border-t.border-gray-700.pt-4.space-y-4 {
        margin-top: 0.5 !important;
    }

  </style>
</head>
<body class="bg-gray-900 text-gray-200">
  <div id="scroll-progress"><div class="bar"></div></div>
  <aside id="sidebar-container" role="complementary" aria-label="–ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏" class="w-80 bg-gray-800 p-4 flex flex-col h-full border-r border-gray-700 fixed inset-y-0 left-0 z-40 lg:translate-x-0 -translate-x-full content-section"></aside>
  <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-60 z-30 hidden lg:hidden"></div>
  <div class="lg:ml-80 flex flex-col h-screen">
    <header id="header-container" class="bg-gray-800 sticky top-0 z-20 p-4 border-b border-gray-700"></header>
    <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar content-section">
      
      <div id="loading-container" class="flex flex-col items-center justify-center h-full p-8">
        <div class="text-center">
          <!-- <div class="loader mx-auto mb-4"></div> -->
          <h2 class="text-2xl font-bold text-gray-200 mb-2">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞</h2>
          <p id="loading-status" class="text-gray-400 mb-4">–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ...</p>
          <div class="loading-progress-container">
            <div class="w-64 bg-gray-700 rounded-full h-2 mb-4 mx-auto">
              <div id="loading-progress" class="bg-blue-500 h-2 rounded-full" style="width: 0%"></div>
            </div>
          </div>
          <!-- <div id="loading-details" class="text-sm text-gray-500"></div> -->
          <div class="tip-container max-w-md mx-auto mt-4">
            <div id="loading-tip" class="tip-text text-xs text-white"></div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden modal-content"></div>
          <div id="set-modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden modal-content"></div>
  <div id="minifig-modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden modal-content"></div>
  <div id="colors-modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden modal-content"></div>
  <div id="filter-modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden modal-content"></div>
  <div id="settings-modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden modal-content"></div>
  <div id="related-sets-modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden modal-content"></div>
  <div id="wishlist-modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden modal-content"></div>
  <input type="file" id="import-csv-input" class="hidden" accept=".csv">
  <div id="image-viewer-container" class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center viewer-hidden">
    <div class="relative w-full h-full flex items-center justify-center p-[5%]">
      <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä-–ø–æ–ª–æ—Ç–Ω–æ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è -->
      <div id="image-canvas" class="image-canvas">
      <div class="image-wrapper bg-white rounded-[18px] shadow-2xl overflow-hidden">
        <img id="fullscreen-image" src="" alt="–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä" class="w-full h-full object-contain transition-all duration-300 ease-out rounded-[18px]" loading="lazy" decoding="async">
      </div>
      </div>
    </div>
    <div class="zoom-controls">
      <button id="zoom-in-btn" class="zoom-btn" title="–£–≤–µ–ª–∏—á–∏—Ç—å">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
          <line x1="11" y1="8" x2="11" y2="14"/>
          <line x1="8" y1="11" x2="14" y2="11"/>
        </svg>
      </button>
      <button id="zoom-out-btn" class="zoom-btn" title="–£–º–µ–Ω—å—à–∏—Ç—å">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
          <line x1="8" y1="11" x2="14" y2="11"/>
        </svg>
      </button>
      <button id="zoom-reset-btn" class="zoom-btn" title="–°–±—Ä–æ—Å–∏—Ç—å –∑—É–º">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="currentColor">
          <path d="M125.7 160H176c17.7 0 32 14.3 32 32s-14.3 32-32 32H48c-17.7 0-32-14.3-32-32V64c0-17.7 14.3-32 32-32s32 14.3 32 32v51.2L97.6 97.6c87.6-87.6 229.3-87.6 316.9 0s87.6 229.3 0 316.9s-229.3 87.6-316.9 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3s-163.8-62.5-226.3 0L125.7 160z"/>
        </svg>
      </button>
    </div>
    <button id="image-viewer-close" class="modal-close-btn absolute top-4 right-4 z-[101]">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </button>
  </div>
  <button id="scroll-to-top-btn" class="fixed bottom-6 right-6 bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 opacity-0 pointer-events-none z-40 transform translate-y-4" aria-label="–í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–≤–µ—Ä—Ö" title="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –Ω–∞—á–∞–ª–æ">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7"></path></svg>
  </button>

  <!-- –°–∏—Å—Ç–µ–º–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ -->
  <div id="inactivity-overlay" class="inactivity-overlay hidden">
      <div class="inactivity-content">
          <div class="inactivity-icon">üí°</div>
          <div class="inactivity-title">–ü–æ–ª–µ–∑–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞</div>
          <div class="inactivity-text" id="inactivity-tip"></div>
          <button class="inactivity-close" id="inactivity-close" title="–ó–∞–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É"><svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
      </div>
  </div>

  <script type="module">
// –°–±—Ä–æ—Å hover/–∞–∫—Ç–∏–≤ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –±–µ–∑ –º–æ—Ä–≥–∞–Ω–∏–π –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
(function() {
    const isSmallOrTouch = () => (
        window.matchMedia('(max-width: 768px)').matches ||
        ('ontouchstart' in window) ||
        (navigator.maxTouchPoints || 0) > 0
    );

    if (!isSmallOrTouch()) return;

    let clearTimer = null;
    const addNoHover = () => {
        document.body.classList.add('no-hover');
        clearTimeout(clearTimer);
        clearTimer = setTimeout(() => {
            document.body.classList.remove('no-hover');
        }, 100);
    };

    window.addEventListener('touchstart', addNoHover, { passive: true });
    window.addEventListener('pointerdown', (e) => {
        if (e.pointerType === 'touch' || e.pointerType === 'pen') addNoHover();
    }, { passive: true });
    window.addEventListener('click', addNoHover, { passive: true });
})();

const DEBUG = false;
if (!DEBUG) {
    console.log = () => {};
    console.debug = () => {};
    console.warn = () => {};
}

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è
console.log('üöÄ –°–ö–†–ò–ü–¢ –ó–ê–ì–†–£–ñ–ï–ù! DEBUG =', DEBUG);

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
function testFunction() {
    console.log('üß™ –¢–ï–°–¢–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –í–´–ó–í–ê–ù–ê!');
    return true;
}

// –í—ã–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
testFunction();

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π
window.searchPartInCatalog = function(partNumber, category = '', partName = '') {
    console.log(`searchPartInCatalog –≤—ã–∑–≤–∞–Ω–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:`, { partNumber, category, partName });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
    window.searchData = {
        partNumber: partNumber,
        category: category,
        partName: partName,
        query: partName || partNumber
    };
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
    openSearchTypeSelectionModal();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è AI –ø–æ–∏—Å–∫–∞
window.openAISearch = function() {
    console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º AI –ø–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏');
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ AI –ø–æ–∏—Å–∫
    S.view = 'tools';
    S.toolSubView = 'photo-search';
    
    // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    S.q = '';
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    updateUI();
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    if (window.innerWidth < 1024) {
        setTimeout(() => {
            showPhotoCameraSelectionModal();
        }, 300);
    }
}

// –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
window.openSearchTypeSelectionModal = function() {
    console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞');
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let modalEl = document.getElementById('search-type-selection-modal');
    if (!modalEl) {
        modalEl = document.createElement('div');
        modalEl.id = 'search-type-selection-modal';
        modalEl.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4';
        document.body.appendChild(modalEl);
    }
    
    const searchData = window.searchData || {};
    
    // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalEl.innerHTML = `
        <div class="bg-gray-800 rounded-[18px] shadow-xl w-full max-w-5xl max-h-[95vh] flex flex-col">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl lg:text-2xl font-bold text-white truncate pr-4 modal-title-multiline" title="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–∏—Å–∫–∞: ${searchData.partName || searchData.query}">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –ø–æ–∏—Å–∫–∞: ${(searchData.partName || searchData.query).length > 30 ? (searchData.partName || searchData.query).substring(0, 30) + '...' : (searchData.partName || searchData.query)}</h2>
                <button id="close-search-type-selection-modal" class="modal-close-btn flex-shrink-0" title="–ó–∞–∫—Ä—ã—Ç—å">
                    ${I_X('w-4 h-4')}
                </button>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞–π–¥–µ–Ω–Ω–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700">
                <div class="bg-gray-700/50 rounded-[18px] p-4">
                    <div class="text-center">
                        <p class="text-sm text-gray-300 mb-2">–ù–∞–π–¥–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç:</p>
                        <p class="text-white font-medium text-lg truncate" title="${searchData.partName || searchData.query}">${searchData.partName || searchData.query}</p>
                        ${searchData.category ? `<p class="text-sm text-gray-400 mt-2">${searchData.category}</p>` : ''}
                    </div>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ -->
            <div class="flex-1 p-4 overflow-y-auto">
                <div class="space-y-3">
                    <button 
                        onclick="selectSearchType('parts')" 
                        class="group bg-gray-700 hover:bg-blue-600 text-white rounded-[18px] transition-all duration-200 flex items-center p-3 space-x-3 hover:shadow-lg hover:shadow-blue-500/25 w-full"
                    >
                        <div class="w-10 h-10 bg-blue-500 group-hover:bg-blue-400 rounded-full flex items-center justify-center transition-colors flex-shrink-0">
                            ${I_Brick('w-5 h-5')}
                        </div>
                        <div class="flex-1 text-left min-w-0">
                            <div class="font-semibold text-sm mb-1">–î–µ—Ç–∞–ª–∏</div>
                            <div class="text-xs text-gray-300 group-hover:text-blue-100">–ü–æ–∏—Å–∫ –ø–æ ID</div>
                            <div class="text-xs text-gray-400 mt-1 font-mono truncate">${searchData.partNumber}</div>
                        </div>
                    </button>
                    
                    <button 
                        onclick="selectSearchType('sets')" 
                        class="group bg-gray-700 hover:bg-green-600 text-white rounded-[18px] transition-all duration-200 flex items-center p-3 space-x-3 hover:shadow-lg hover:shadow-green-500/25 w-full"
                    >
                        <div class="w-10 h-10 bg-green-500 group-hover:bg-green-400 rounded-full flex items-center justify-center transition-colors flex-shrink-0">
                            ${I_Set('w-5 h-5')}
                        </div>
                        <div class="flex-1 text-left min-w-0">
                            <div class="font-semibold text-sm mb-1">–ù–∞–±–æ—Ä—ã</div>
                            <div class="text-xs text-gray-300 group-hover:text-green-100">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</div>
                            <div class="text-xs text-gray-400 mt-1 truncate" title="${searchData.partName || searchData.query}">${(searchData.partName || searchData.query).length > 25 ? (searchData.partName || searchData.query).substring(0, 25) + '...' : (searchData.partName || searchData.query)}</div>
                        </div>
                    </button>
                    
                    <button 
                        onclick="selectSearchType('minifigs')" 
                        class="group bg-gray-700 hover:bg-purple-600 text-white rounded-[18px] transition-all duration-200 flex items-center p-3 space-x-3 hover:shadow-lg hover:shadow-purple-500/25 w-full"
                    >
                        <div class="w-10 h-10 bg-purple-500 group-hover:bg-purple-400 rounded-full flex items-center justify-center transition-colors flex-shrink-0">
                            ${I_Dice('w-5 h-5')}
                        </div>
                        <div class="flex-1 text-left min-w-0">
                            <div class="font-semibold text-sm mb-1">–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏</div>
                            <div class="text-xs text-gray-300 group-hover:text-purple-100">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é</div>
                            <div class="text-xs text-gray-400 mt-1 truncate" title="${searchData.partName || searchData.query}">${(searchData.partName || searchData.query).length > 25 ? (searchData.partName || searchData.query).substring(0, 25) + '...' : (searchData.partName || searchData.query)}</div>
                        </div>
                    </button>
                    
                    <button 
                        onclick="selectSearchType('box')" 
                        class="group bg-gray-700 hover:bg-orange-600 text-white rounded-[18px] transition-all duration-200 flex items-center p-3 space-x-3 hover:shadow-lg hover:shadow-orange-500/25 w-full"
                    >
                        <div class="w-10 h-10 bg-orange-500 group-hover:bg-orange-400 rounded-full flex items-center justify-center transition-colors flex-shrink-0">
                            ${I_Square('w-5 h-5')}
                        </div>
                        <div class="flex-1 text-left min-w-0">
                            <div class="font-semibold text-sm mb-1">–ö–æ—Ä–æ–±–∫–∞ –Ω–∞–±–æ—Ä–∞</div>
                            <div class="text-xs text-gray-300 group-hover:text-orange-100">–ü–æ–∏—Å–∫ –ø–æ ID</div>
                            <div class="text-xs text-gray-400 mt-1 font-mono truncate">${searchData.partNumber}</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modalEl.classList.remove('hidden');
    modalEl.classList.add('visible');
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    setupSearchTypeSelectionHandlers();
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
window.closeSearchTypeSelectionModal = function() {
    const modalEl = document.getElementById('search-type-selection-modal');
    if (modalEl) {
        modalEl.classList.add('hidden');
        modalEl.classList.remove('visible');
    }
}

// –í—ã–±–æ—Ä —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
window.selectSearchType = function(type) {
    console.log(`–í—ã–±—Ä–∞–Ω —Ç–∏–ø –ø–æ–∏—Å–∫–∞: ${type}`);
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞
    closeSearchTypeSelectionModal();
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞
    switch(type) {
        case 'parts':
            openPartsSearchModal();
            break;
        case 'sets':
            openSetsSearchModal();
            break;
        case 'minifigs':
            openMinifigsSearchModal();
            break;
        case 'box':
            openBoxSearchModal();
            break;
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
window.setupSearchTypeSelectionHandlers = function() {
    const modalEl = document.getElementById('search-type-selection-modal');
    const closeBtn = document.getElementById('close-search-type-selection-modal');
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (closeBtn) {
        closeBtn.addEventListener('click', closeSearchTypeSelectionModal);
    }
    
    if (modalEl) {
        modalEl.addEventListener('click', (e) => {
            if (e.target === modalEl) {
                closeSearchTypeSelectionModal();
            }
        });
    }
}

// –ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π
window.openPartsSearchModal = function() {
    const searchData = window.searchData || {};
    const searchQuery = searchData.partNumber || searchData.query || '';
    
    console.log(`–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π —Å –∑–∞–ø—Ä–æ—Å–æ–º: ${searchQuery}`);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π
    openPartSearchModal(searchQuery);
}

// –ü–æ–∏—Å–∫ –Ω–∞–±–æ—Ä–æ–≤
window.openSetsSearchModal = function() {
    const searchData = window.searchData || {};
    const searchQuery = searchData.partName || searchData.query || '';
    
    console.log(`–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –Ω–∞–±–æ—Ä–æ–≤ —Å –∑–∞–ø—Ä–æ—Å–æ–º: ${searchQuery}`);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤
    searchInSetsCatalogModal(searchQuery);
}

// –ü–æ–∏—Å–∫ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
window.openMinifigsSearchModal = function() {
    const searchData = window.searchData || {};
    const searchQuery = searchData.partName || searchData.query || '';
    
    console.log(`–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ —Å –∑–∞–ø—Ä–æ—Å–æ–º: ${searchQuery}`);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
    searchInMinifigsCatalogModal(searchQuery);
}

// –ü–æ–∏—Å–∫ –∫–æ—Ä–æ–±–∫–∏ –Ω–∞–±–æ—Ä–∞
window.openBoxSearchModal = function() {
    const searchData = window.searchData || {};
    const searchQuery = searchData.partNumber || searchData.query || '';
    
    console.log(`–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –∫–æ—Ä–æ–±–∫–∏ –Ω–∞–±–æ—Ä–∞ —Å –∑–∞–ø—Ä–æ—Å–æ–º: ${searchQuery}`);
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let modalEl = document.getElementById('box-search-modal');
    if (!modalEl) {
        modalEl = document.createElement('div');
        modalEl.id = 'box-search-modal';
        modalEl.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm';
        document.body.appendChild(modalEl);
    }
    
    // –ò—â–µ–º –Ω–∞–±–æ—Ä –ø–æ —Ç–æ—á–Ω–æ–º—É ID
    const setId = searchQuery.trim();
    const setData = SET_MAP[setId];
    
    let searchResults = [];
    if (setData) {
        searchResults = [setData];
        console.log(`–ù–∞–π–¥–µ–Ω –Ω–∞–±–æ—Ä –ø–æ ID: ${setId} - ${setData.name}`);
    } else {
        console.log(`–ù–∞–±–æ—Ä —Å ID ${setId} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const limitedResults = searchResults.slice(0, 50);
    
    console.log(`–ù–∞–π–¥–µ–Ω–æ ${limitedResults.length} –Ω–∞–±–æ—Ä–æ–≤ –ø–æ ID "${setId}"`);
    
    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalEl.innerHTML = `
        <div class="bg-gray-800 rounded-[18px] shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                <h2 class="text-lg lg:text-xl font-bold text-white truncate flex-1 min-w-0" id="box-search-title">–ü–æ–∏—Å–∫ –∫–æ—Ä–æ–±–∫–∏ –Ω–∞–±–æ—Ä–∞</h2>
                <button id="close-box-search-modal" class="modal-close-btn flex-shrink-0 w-8 h-8 min-w-[2rem] min-h-[2rem] rounded-full" title="–ó–∞–∫—Ä—ã—Ç—å">
                    ${I_X('w-4 h-4')}
                </button>
            </div>
            
            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <label for="box-search-input" class="text-sm font-medium text-gray-300 whitespace-nowrap">ID –Ω–∞–±–æ—Ä–∞:</label>
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="box-search-input" 
                            value="${setId}" 
                            class="w-full px-4 py-2 bg-gray-700 text-white rounded-[18px] border border-gray-600 focus:border-orange-500 focus:ring-2 focus:ring-orange-500/20 focus:outline-none transition-all duration-200"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ ID –Ω–∞–±–æ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞..."
                            autocomplete="off"
                        />
                        <button 
                            id="clear-box-search-input" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-all duration-200"
                            title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ"
                            style="opacity: 0; pointer-events: none;"
                        >
                            ${I_X('w-4 h-4')}
                        </button>
                    </div>
                    <button 
                        id="search-box-btn" 
                        class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-[18px] transition-colors duration-200 flex items-center gap-2"
                        title="–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫"
                    >
                        ${I_Search('w-4 h-4')}
                        <span class="hidden sm:inline">–ü–æ–∏—Å–∫</span>
                    </button>
                </div>
            </div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
            <div class="flex-1 overflow-y-auto p-4">
                ${limitedResults.length > 0 ? `
                    <div class="sets-minifigs-grid">
                        ${limitedResults.map(set => renderSetCard(set)).join('')}
                    </div>
                ` : `
                    <div class="text-center py-12">
                        <div class="text-gray-400 text-lg mb-4">–ö–æ—Ä–æ–±–∫–∞ –Ω–∞–±–æ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</div>
                        <div class="text-gray-500 text-sm">–ù–∞–±–æ—Ä —Å ID "${setId}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</div>
                    </div>
                `}
            </div>
        </div>
    `;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modalEl.classList.remove('hidden');
    modalEl.classList.add('visible');
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    setupBoxSearchModalHandlers();
    
    modalEl.addEventListener('click', (e) => {
        if (e.target === modalEl) {
            modalEl.classList.add('hidden');
            modalEl.classList.remove('visible');
        }
    });
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –∫–æ—Ä–æ–±–∫–∏ –Ω–∞–±–æ—Ä–∞
window.setupBoxSearchModalHandlers = function() {
    const modalEl = document.getElementById('box-search-modal');
    const closeBtn = document.getElementById('close-box-search-modal');
    const searchInput = document.getElementById('box-search-input');
    const clearBtn = document.getElementById('clear-box-search-input');
    const searchBtn = document.getElementById('search-box-btn');
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            modalEl.classList.add('hidden');
            modalEl.classList.remove('visible');
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—è –≤–≤–æ–¥–∞
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
                updateClearButtonVisibility();
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
    function updateClearButtonVisibility() {
        if (clearBtn && searchInput) {
            if (searchInput.value.trim()) {
                clearBtn.style.opacity = '1';
                clearBtn.style.pointerEvents = 'auto';
            } else {
                clearBtn.style.opacity = '0';
                clearBtn.style.pointerEvents = 'none';
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (searchInput) {
        searchInput.addEventListener('input', updateClearButtonVisibility);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
        updateClearButtonVisibility();
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞
    if (searchBtn) {
        searchBtn.addEventListener('click', () => {
            if (searchInput) {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    openBoxSearchModal({ partNumber: searchTerm });
                }
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (searchInput) {
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    openBoxSearchModal({ partNumber: searchTerm });
                }
            }
        });
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        searchInput.focus();
        searchInput.select();
    }
}

// –ï–¥–∏–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ —Å –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–º —Ç–∏–ø–æ–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
window.openUniversalSearchModal = function(searchData = '') {
    // –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç—Ä–æ–∫–æ–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º
    if (typeof searchData === 'string') {
        searchData = { query: searchData, type: 'parts' };
    }
    
    console.log(`–û—Ç–∫—Ä—ã–≤–∞–µ–º –µ–¥–∏–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ —Å –¥–∞–Ω–Ω—ã–º–∏:`, searchData);
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let modalEl = document.getElementById('universal-search-modal');
    if (!modalEl) {
        modalEl = document.createElement('div');
        modalEl.id = 'universal-search-modal';
        modalEl.className = 'fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 hidden p-4';
        document.body.appendChild(modalEl);
    }
    
    // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalEl.innerHTML = `
        <div class="bg-gray-800 rounded-[18px] shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl lg:text-2xl font-bold text-white truncate pr-4 modal-title-multiline" title="–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫: ${searchData.query}">–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫: ${searchData.query.length > 30 ? searchData.query.substring(0, 30) + '...' : searchData.query}</h2>
                <button id="close-universal-search-modal" class="modal-close-btn flex-shrink-0" title="–ó–∞–∫—Ä—ã—Ç—å">
                    ${I_X('w-4 h-4')}
                </button>
            </div>
            
            <!-- –ü–æ–ª–µ –ø–æ–∏—Å–∫–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700 space-y-4">
                <div class="flex items-center space-x-4">
                    <div class="flex-1">
                        <input 
                            type="text" 
                            id="universal-search-input" 
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å..." 
                            value="${searchData.query}"
                            class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-[18px] text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                    </div>
                    <button 
                        onclick="performUniversalSearch()" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-[18px] hover:bg-blue-700 transition-colors font-medium"
                    >
                        –ü–æ–∏—Å–∫
                    </button>
                </div>
                
                <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∏–ø–æ–≤ -->
                <div class="flex space-x-1 bg-gray-700 rounded-[18px] p-1">
                    <button 
                        onclick="switchSearchType('parts')" 
                        id="search-type-parts" 
                        class="flex-1 px-4 py-2 rounded-[18px] text-sm font-medium transition-colors search-type-btn ${searchData.type === 'parts' ? 'active' : ''}"
                    >
                        –î–µ—Ç–∞–ª–∏
                    </button>
                    <button 
                        onclick="switchSearchType('sets')" 
                        id="search-type-sets" 
                        class="flex-1 px-4 py-2 rounded-[18px] text-sm font-medium transition-colors search-type-btn ${searchData.type === 'sets' ? 'active' : ''}"
                    >
                        –ù–∞–±–æ—Ä—ã
                    </button>
                    <button 
                        onclick="switchSearchType('minifigs')" 
                        id="search-type-minifigs" 
                        class="flex-1 px-4 py-2 rounded-[18px] text-sm font-medium transition-colors search-type-btn ${searchData.type === 'minifigs' ? 'active' : ''}"
                    >
                        –ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                    </button>
                </div>
            </div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
            <div class="flex-1 overflow-hidden relative" style="min-height: 500px;">
                <div id="universal-search-scroll-progress"><div class="bar"></div></div>
                <div id="universal-search-results" class="h-full overflow-y-auto no-scrollbar p-4" style="max-height: calc(90vh - 200px);">
                    <div class="text-center text-gray-400 py-8">
                        –í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ "–ü–æ–∏—Å–∫"
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
    window.universalSearchData = searchData;
    console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∞:', window.universalSearchData);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modalEl.classList.remove('hidden');
    modalEl.classList.add('visible');
    
    // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    const input = document.getElementById('universal-search-input');
    if (input) {
        input.focus();
        input.select();
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('universal-search-input');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performUniversalSearch();
            }
        });
    }
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ —Å—Ä–∞–∑—É
    if (searchData.query) {
        setTimeout(() => {
            performUniversalSearch();
        }, 100);
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    setupUniversalSearchModalHandlers();
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
window.setupUniversalSearchModalHandlers = function() {
    const modalEl = document.getElementById('universal-search-modal');
    const closeBtn = document.getElementById('close-universal-search-modal');
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (closeBtn) {
        closeBtn.addEventListener('click', closeUniversalSearchModal);
    }
    
    if (modalEl) {
        modalEl.addEventListener('click', (e) => {
            if (e.target === modalEl) {
                closeUniversalSearchModal();
            }
        });
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–æ–ª–ª-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    const scrollContainer = document.getElementById('universal-search-results');
    const progressBar = document.getElementById('universal-search-scroll-progress');
    
    if (scrollContainer && progressBar) {
        let ticking = false;
        const updateProgress = () => {
            const scrollTop = scrollContainer.scrollTop;
            const scrollHeight = scrollContainer.scrollHeight - scrollContainer.clientHeight;
            const progress = (scrollTop / scrollHeight) * 100;
            progressBar.querySelector('.bar').style.width = `${progress}%`;
            ticking = false;
        };
        
        scrollContainer.addEventListener('scroll', () => {
            if (!ticking) {
                requestAnimationFrame(updateProgress);
                ticking = true;
            }
        }, { passive: true });
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –µ–¥–∏–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞
window.closeUniversalSearchModal = function() {
    const modalEl = document.getElementById('universal-search-modal');
    if (modalEl) {
        modalEl.classList.add('hidden');
        modalEl.classList.remove('visible');
    }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–æ–∏—Å–∫–∞
window.switchSearchType = function(type) {
    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('.search-type-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-blue-600', 'text-white');
        btn.classList.add('text-gray-400', 'hover:text-white');
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
    const activeBtn = document.getElementById(`search-type-${type}`);
    if (activeBtn) {
        activeBtn.classList.add('active', 'bg-blue-600', 'text-white');
        activeBtn.classList.remove('text-gray-400', 'hover:text-white');
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–∏–ø –ø–æ–∏—Å–∫–∞
    window.currentSearchType = type;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    const searchInput = document.getElementById('universal-search-input');
    console.log('–î–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏:', window.universalSearchData);
    
    if (searchInput && window.universalSearchData) {
        let newQuery = '';
        
        switch(type) {
            case 'parts':
                // –î–ª—è –¥–µ—Ç–∞–ª–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º ID
                newQuery = window.universalSearchData.partId || window.universalSearchData.query || '';
                console.log(`–î–ª—è –¥–µ—Ç–∞–ª–µ–π: partId="${window.universalSearchData.partId}", query="${window.universalSearchData.query}"`);
                break;
            case 'sets':
                // –î–ª—è –Ω–∞–±–æ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
                newQuery = window.universalSearchData.setName || window.universalSearchData.query || '';
                console.log(`–î–ª—è –Ω–∞–±–æ—Ä–æ–≤: setName="${window.universalSearchData.setName}", query="${window.universalSearchData.query}"`);
                break;
            case 'minifigs':
                // –î–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
                newQuery = window.universalSearchData.minifigName || window.universalSearchData.query || '';
                console.log(`–î–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫: minifigName="${window.universalSearchData.minifigName}", query="${window.universalSearchData.query}"`);
                break;
        }
        
        // –í—Å–µ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞, –¥–∞–∂–µ –µ—Å–ª–∏ newQuery –ø—É—Å—Ç–æ–π
        searchInput.value = newQuery;
        console.log(`–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ ${type}, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å: "${newQuery}"`);
        
        // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ —Å –Ω–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
        performUniversalSearch();
    } else if (searchInput) {
        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ–∏—Å–∫–∞, –ø—Ä–æ—Å—Ç–æ –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ —Å —Ç–µ–∫—É—â–∏–º –∑–Ω–∞—á–µ–Ω–∏–µ–º
        console.log(`–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ ${type}, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å: "${searchInput.value}"`);
        performUniversalSearch();
    }
}

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
window.performUniversalSearch = function() {
    const searchInput = document.getElementById('universal-search-input');
    const searchTerm = searchInput ? searchInput.value.trim() : '';
    const searchType = window.currentSearchType || 'parts';
    
    if (!searchTerm) {
        return;
    }
    
    console.log(`–í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫: "${searchTerm}" –ø–æ —Ç–∏–ø—É: ${searchType}`);
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    const resultsContainer = document.getElementById('universal-search-results');
    if (resultsContainer) {
        resultsContainer.innerHTML = '<div class="text-center text-gray-400 py-4">–ü–æ–∏—Å–∫...</div>';
    }
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
    setTimeout(() => {
        switch(searchType) {
            case 'parts':
                searchUniversalParts(searchTerm);
                break;
            case 'sets':
                searchUniversalSets(searchTerm);
                break;
            case 'minifigs':
                searchUniversalMinifigs(searchTerm);
                break;
        }
    }, 100);
}

// –ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ (—Ç–æ–ª—å–∫–æ –ø–æ ID)
function searchUniversalParts(searchTerm) {
    if (!searchTerm || searchTerm.trim().length < 1) {
        displayUniversalResults([], 'parts');
        return;
    }
    
    const searchTermLower = searchTerm.toLowerCase().trim();
    console.log(`–ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π –ø–æ ID: ${searchTerm}`);
    
    // –ò—â–µ–º –¥–µ—Ç–∞–ª–∏ —Ç–æ–ª—å–∫–æ –ø–æ —Ç–æ—á–Ω–æ–º—É –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é ID
    let results = Object.values(PART_MAP).filter(part => {
        if (!part || !part.id) return false;
        
        const partId = part.id.toLowerCase();
        // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ID –∏–ª–∏ —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        return partId === searchTermLower || partId.includes(searchTermLower);
    });
    
    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏ ID
    if (results.length === 0) {
        console.log(`–¢–æ—á–Ω—ã–π –ø–æ–∏—Å–∫ –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏: ${searchTerm}`);
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        const numericPart = searchTerm.match(/^\d+/);
        if (numericPart) {
            const numericId = numericPart[0];
            console.log(`–ò—â–µ–º –¥–µ—Ç–∞–ª–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å —Ü–∏—Ñ—Ä: ${numericId}`);
            
            results = Object.values(PART_MAP).filter(part => {
                if (!part || !part.id) return false;
                
                const partId = part.id.toLowerCase();
                // –ò—â–µ–º –¥–µ—Ç–∞–ª–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å —ç—Ç–∏—Ö —Ü–∏—Ñ—Ä
                return partId.startsWith(numericId);
            });
            
            console.log(`–ù–∞–π–¥–µ–Ω–æ ${results.length} –¥–µ—Ç–∞–ª–µ–π –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏ ${numericId}`);
        }
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã: —Å–Ω–∞—á–∞–ª–∞ —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è, –∑–∞—Ç–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ
    results.sort((a, b) => {
        const aId = a.id.toLowerCase();
        const bId = b.id.toLowerCase();
        
        // –¢–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏–¥—É—Ç –ø–µ—Ä–≤—ã–º–∏
        if (aId === searchTermLower && bId !== searchTermLower) return -1;
        if (aId !== searchTermLower && bId === searchTermLower) return 1;
        
        // –ó–∞—Ç–µ–º –ø–æ –¥–ª–∏–Ω–µ ID (–±–æ–ª–µ–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø–µ—Ä–≤—ã–º–∏)
        if (aId.length !== bId.length) return aId.length - bId.length;
        
        // –ó–∞—Ç–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        return aId.localeCompare(bId);
    });
    
    console.log(`–ù–∞–π–¥–µ–Ω–æ ${results.length} –¥–µ—Ç–∞–ª–µ–π –ø–æ ID: ${searchTerm}`);
    displayUniversalResults(results, 'parts');
}

// –ü–æ–∏—Å–∫ –Ω–∞–±–æ—Ä–æ–≤ –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
function searchUniversalSets(searchTerm) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –ø–æ–∏—Å–∫–∞, —á—Ç–æ –∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –Ω–∞–±–æ—Ä–æ–≤
    const keywords = extractKeywords(searchTerm);
    console.log(`–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:`, keywords);
    
    const searchResults = Object.values(SET_MAP).filter(set => {
        if (!set || !set.name) return false;
        
        const setName = set.name.toLowerCase();
        const setTheme = (set.theme_name || '').toLowerCase();
        const setDescription = (set.description || '').toLowerCase();
        
        return keywords.some(keyword => 
            setName.includes(keyword) || 
            setTheme.includes(keyword) ||
            setDescription.includes(keyword)
        );
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    searchResults.sort((a, b) => {
        const aName = a.name.toLowerCase();
        const bName = b.name.toLowerCase();
        
        const aStartsWith = keywords.some(keyword => aName.startsWith(keyword));
        const bStartsWith = keywords.some(keyword => bName.startsWith(keyword));
        
        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;
        
        const aMatches = keywords.filter(keyword => aName.includes(keyword)).length;
        const bMatches = keywords.filter(keyword => bName.includes(keyword)).length;
        
        if (aMatches !== bMatches) return bMatches - aMatches;
        
        return a.name.localeCompare(b.name);
    });
    
    displayUniversalResults(searchResults, 'sets');
}

// –ü–æ–∏—Å–∫ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
function searchUniversalMinifigs(searchTerm) {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É –ø–æ–∏—Å–∫–∞, —á—Ç–æ –∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
    const keywords = extractKeywords(searchTerm);
    console.log(`–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:`, keywords);
    
    const searchResults = Object.values(MINIFIG_MAP).filter(minifig => {
        if (!minifig || !minifig.name) return false;
        
        const minifigName = minifig.name.toLowerCase();
        const minifigSetNum = (minifig.set_num || '').toLowerCase();
        
        return keywords.some(keyword => 
            minifigName.includes(keyword) || 
            minifigSetNum.includes(keyword)
        );
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    searchResults.sort((a, b) => {
        const aName = a.name.toLowerCase();
        const bName = b.name.toLowerCase();
        
        const aStartsWith = keywords.some(keyword => aName.startsWith(keyword));
        const bStartsWith = keywords.some(keyword => bName.startsWith(keyword));
        
        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;
        
        const aMatches = keywords.filter(keyword => aName.includes(keyword)).length;
        const bMatches = keywords.filter(keyword => bName.includes(keyword)).length;
        
        if (aMatches !== bMatches) return bMatches - aMatches;
        
        return a.name.localeCompare(b.name);
    });
    
    displayUniversalResults(searchResults, 'minifigs');
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
function displayUniversalResults(results, type) {
    const resultsContainer = document.getElementById('universal-search-results');
    if (!resultsContainer) return;
    
    if (results.length === 0) {
        resultsContainer.innerHTML = `
            <div class="text-center py-8">
                <div class="text-4xl mb-3">${I_Search('w-12 h-12 mx-auto text-gray-400')}</div>
                <p class="text-sm text-gray-400">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                <p class="text-xs text-gray-500 mt-2">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ —Å–º</p>
            </div>
        `;
        return;
    }
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const limitedResults = results.slice(0, 50);
    
    let html = `<div class="sets-minifigs-grid">`;
    
    limitedResults.forEach((item, index) => {
        if (type === 'parts') {
            html += renderPartCard(item, false, 0, false, index);
        } else if (type === 'sets') {
            html += renderSetCard(item, false, index);
        } else if (type === 'minifigs') {
            html += renderMinifigCard(item, false, index);
        }
    });
    
    html += `</div>`;
    
    if (results.length > 50) {
        html += `<div class="text-center text-gray-400 mt-4">–ü–æ–∫–∞–∑–∞–Ω–æ 50 –∏–∑ ${results.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤</div>`;
    }
    
    resultsContainer.innerHTML = html;
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π —ç–ª–µ–º–µ–Ω—Ç–∞
window.openItemDetails = function(itemId, type) {
    closeUniversalSearchModal();
    
    switch(type) {
        case 'parts':
            openPartSearchModal(itemId);
            break;
        case 'sets':
            openModalForSet(itemId);
            break;
        case 'minifigs':
            openModalForMinifig(itemId);
            break;
    }
}

// –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
window.extractKeywords = function(searchTerm) {
    if (!searchTerm) return [];
    
    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã –∏ —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–ª–æ–≤–∞
    const words = searchTerm
        .toLowerCase()
        .replace(/[^\w\s-]/g, ' ') // –£–±–∏—Ä–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã, –∫—Ä–æ–º–µ –¥–µ—Ñ–∏—Å–æ–≤
        .split(/\s+/)
        .filter(word => word.length > 1) // –£–º–µ–Ω—å—à–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏–Ω—É –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–∏—Å–∫–∞
        .filter(word => !isStopWord(word)); // –£–±–∏—Ä–∞–µ–º —Å—Ç–æ–ø-—Å–ª–æ–≤–∞
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–ª–æ–≤ (—É–±–∏—Ä–∞–µ–º –æ–∫–æ–Ω—á–∞–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω–æ–Ω–∏–º—ã)
    const keywords = new Set();
    
    words.forEach(word => {
        keywords.add(word);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã –±–µ–∑ –æ–∫–æ–Ω—á–∞–Ω–∏–π
        if (word.endsWith('s') && word.length > 3) {
            keywords.add(word.slice(0, -1)); // —É–±–∏—Ä–∞–µ–º 's'
        }
        if (word.endsWith('ing') && word.length > 4) {
            keywords.add(word.slice(0, -3)); // —É–±–∏—Ä–∞–µ–º 'ing'
        }
        if (word.endsWith('ed') && word.length > 3) {
            keywords.add(word.slice(0, -2)); // —É–±–∏—Ä–∞–µ–º 'ed'
        }
        if (word.endsWith('er') && word.length > 3) {
            keywords.add(word.slice(0, -2)); // —É–±–∏—Ä–∞–µ–º 'er'
        }
        if (word.endsWith('ly') && word.length > 3) {
            keywords.add(word.slice(0, -2)); // —É–±–∏—Ä–∞–µ–º 'ly'
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω–æ–Ω–∏–º—ã –¥–ª—è LEGO-—Ç–µ—Ä–º–∏–Ω–æ–≤
        const synonyms = getLegoSynonyms(word);
        synonyms.forEach(synonym => keywords.add(synonym));
    });
    
    return Array.from(keywords);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∏–Ω–æ–Ω–∏–º–æ–≤ LEGO-—Ç–µ—Ä–º–∏–Ω–æ–≤
window.getLegoSynonyms = function(word) {
    const synonyms = {
        'brick': ['block', 'piece', 'element'],
        'block': ['brick', 'piece', 'element'],
        'piece': ['brick', 'block', 'element'],
        'element': ['brick', 'block', 'piece'],
        'minifig': ['minifigure', 'figure', 'character'],
        'minifigure': ['minifig', 'figure', 'character'],
        'figure': ['minifig', 'minifigure', 'character'],
        'character': ['minifig', 'minifigure', 'figure'],
        'set': ['kit', 'model', 'build'],
        'kit': ['set', 'model', 'build'],
        'model': ['set', 'kit', 'build'],
        'build': ['set', 'kit', 'model'],
        'vehicle': ['car', 'truck', 'plane', 'aircraft', 'ship', 'boat'],
        'car': ['vehicle', 'auto', 'automobile'],
        'truck': ['vehicle', 'lorry'],
        'plane': ['aircraft', 'airplane', 'vehicle'],
        'aircraft': ['plane', 'airplane', 'vehicle'],
        'ship': ['boat', 'vessel', 'vehicle'],
        'boat': ['ship', 'vessel', 'vehicle'],
        'building': ['structure', 'house', 'castle', 'tower'],
        'house': ['building', 'home', 'structure'],
        'castle': ['building', 'fortress', 'structure'],
        'tower': ['building', 'structure'],
        'robot': ['android', 'mech', 'mecha'],
        'android': ['robot', 'mech', 'mecha'],
        'mech': ['robot', 'android', 'mecha'],
        'mecha': ['robot', 'android', 'mech'],
        'space': ['cosmic', 'galactic', 'astronaut'],
        'cosmic': ['space', 'galactic', 'astronaut'],
        'galactic': ['space', 'cosmic', 'astronaut'],
        'astronaut': ['space', 'cosmic', 'galactic'],
        'pirates': ['pirate', 'swashbuckler'],
        'pirate': ['pirates', 'swashbuckler'],
        'swashbuckler': ['pirate', 'pirates'],
        'ninja': ['ninjas', 'warrior'],
        'ninjas': ['ninja', 'warrior'],
        'warrior': ['ninja', 'ninjas'],
        'knight': ['knights', 'warrior'],
        'knights': ['knight', 'warrior'],
        'dragon': ['dragons', 'beast'],
        'dragons': ['dragon', 'beast'],
        'beast': ['dragon', 'dragons'],
        'monster': ['monsters', 'creature'],
        'monsters': ['monster', 'creature'],
        'creature': ['monster', 'monsters'],
        'superhero': ['superheroes', 'hero'],
        'superheroes': ['superhero', 'hero'],
        'hero': ['superhero', 'superheroes'],
        'villain': ['villains', 'antagonist'],
        'villains': ['villain', 'antagonist'],
        'antagonist': ['villain', 'villains']
    };
    
    return synonyms[word] || [];
}

// –§—É–Ω–∫—Ü–∏—è –Ω–µ—á–µ—Ç–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ (—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞)
window.fuzzyMatch = function(str1, str2) {
    const len1 = str1.length;
    const len2 = str2.length;
    
    if (len1 === 0) return len2;
    if (len2 === 0) return len1;
    
    const matrix = Array(len2 + 1).fill(null).map(() => Array(len1 + 1).fill(null));
    
    for (let i = 0; i <= len1; i++) matrix[0][i] = i;
    for (let j = 0; j <= len2; j++) matrix[j][0] = j;
    
    for (let j = 1; j <= len2; j++) {
        for (let i = 1; i <= len1; i++) {
            const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;
            matrix[j][i] = Math.min(
                matrix[j][i - 1] + 1,      // deletion
                matrix[j - 1][i] + 1,      // insertion
                matrix[j - 1][i - 1] + cost // substitution
            );
        }
    }
    
    return matrix[len2][len1];
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–µ—á–µ—Ç–∫–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
window.isFuzzyMatch = function(text, keyword, threshold = 0.7) {
    const textLower = text.toLowerCase();
    const keywordLower = keyword.toLowerCase();
    
    // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    if (textLower.includes(keywordLower)) return true;
    
    // –ù–µ—á–µ—Ç–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
    const words = textLower.split(/\s+/);
    for (const word of words) {
        if (word.length < 3) continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–æ—Ä–æ—Ç–∫–∏–µ —Å–ª–æ–≤–∞
        
        const distance = fuzzyMatch(keywordLower, word);
        const similarity = 1 - (distance / Math.max(keywordLower.length, word.length));
        
        if (similarity >= threshold) return true;
    }
    
    return false;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ—Ä–∞–∑–∞–º –∏ —á–∞—Å—Ç–∏—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º
window.searchByPhrase = function(text, searchTerm) {
    const textLower = text.toLowerCase();
    const searchLower = searchTerm.toLowerCase();
    
    // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Ñ—Ä–∞–∑—ã
    if (textLower.includes(searchLower)) {
        return { exact: true, score: 100 };
    }
    
    // –ü–æ–∏—Å–∫ –ø–æ —Å–ª–æ–≤–∞–º —Ñ—Ä–∞–∑—ã
    const searchWords = searchLower.split(/\s+/).filter(word => word.length > 1);
    if (searchWords.length === 0) return { exact: false, score: 0 };
    
    let matchedWords = 0;
    let totalScore = 0;
    
    searchWords.forEach(word => {
        if (textLower.includes(word)) {
            matchedWords++;
            totalScore += 50;
        } else if (isFuzzyMatch(textLower, word, 0.7)) {
            matchedWords++;
            totalScore += 25;
        }
    });
    
    // –ë–æ–Ω—É—Å –∑–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–ª–æ–≤
    if (matchedWords === searchWords.length) {
        totalScore += 50;
    }
    
    // –ë–æ–Ω—É—Å –∑–∞ –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤
    const textWords = textLower.split(/\s+/);
    let orderBonus = 0;
    for (let i = 0; i < searchWords.length - 1; i++) {
        const word1 = searchWords[i];
        const word2 = searchWords[i + 1];
        const pos1 = textWords.indexOf(word1);
        const pos2 = textWords.indexOf(word2);
        
        if (pos1 !== -1 && pos2 !== -1 && pos2 > pos1) {
            orderBonus += 10;
        }
    }
    
    return {
        exact: false,
        score: totalScore + orderBonus,
        matchedWords,
        totalWords: searchWords.length
    };
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞
window.isStopWord = function(word) {
    const stopWords = [
        'the', 'and', 'or', 'but', 'in', 'on', 'at', 'to', 'for', 'of', 'with', 'by',
        'a', 'an', 'is', 'are', 'was', 'were', 'be', 'been', 'being', 'have', 'has', 'had',
        'do', 'does', 'did', 'will', 'would', 'could', 'should', 'may', 'might', 'must',
        'can', 'this', 'that', 'these', 'those', 'i', 'you', 'he', 'she', 'it', 'we', 'they',
        'me', 'him', 'her', 'us', 'them', 'my', 'your', 'his', 'her', 'its', 'our', 'their',
        'holiday', 'sweater', 'shirt', 'jacket', 'costume', 'outfit', 'uniform'
    ];
    return stopWords.includes(word.toLowerCase());
}

// –ü–æ–∏—Å–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∞–±–æ—Ä–æ–≤
window.searchInSetsCatalog = function(searchTerm) {
    console.log(`–ü–æ–∏—Å–∫ –Ω–∞–±–æ—Ä–æ–≤ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É: ${searchTerm}`);
    console.log(`SET_MAP —Å–æ–¥–µ—Ä–∂–∏—Ç ${Object.keys(SET_MAP).length} –Ω–∞–±–æ—Ä–æ–≤`);
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    const keywords = extractKeywords(searchTerm);
    console.log(`–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:`, keywords);
    
    if (keywords.length === 0) return [];
    
    // –ò—â–µ–º –Ω–∞–±–æ—Ä—ã —Å –ø–æ–¥—Å—á–µ—Ç–æ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    const searchResults = Object.values(SET_MAP).map(set => {
        if (!set || !set.name) return null;
        
        const setName = set.name.toLowerCase();
        const setTheme = (set.theme_name || '').toLowerCase();
        const setDescription = (set.description || '').toLowerCase();
        const setYear = set.year || 0;
        
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
        let relevanceScore = 0;
        let matchCount = 0;
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∏—Å–∫ –ø–æ —Ñ—Ä–∞–∑–µ (–¥–ª—è —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π)
        const phraseResult = searchByPhrase(setName, searchTerm);
        if (phraseResult.exact) {
            relevanceScore += 150; // –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ñ—Ä–∞–∑
            matchCount++;
        } else if (phraseResult.score > 0) {
            relevanceScore += phraseResult.score;
            matchCount++;
        }
        
        // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        keywords.forEach(keyword => {
            // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            if (setName.startsWith(keyword)) {
                relevanceScore += 100;
                matchCount++;
            }
            // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
            else if (setName.includes(keyword)) {
                relevanceScore += 50;
                matchCount++;
            }
            // –ù–µ—á–µ—Ç–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
            else if (isFuzzyMatch(setName, keyword, 0.8)) {
                relevanceScore += 25;
                matchCount++;
            }
            // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ —Ç–µ–º–µ
            if (setTheme.includes(keyword)) {
                relevanceScore += 30;
                matchCount++;
            }
            // –ù–µ—á–µ—Ç–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ —Ç–µ–º–µ
            else if (isFuzzyMatch(setTheme, keyword, 0.8)) {
                relevanceScore += 15;
                matchCount++;
            }
            // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
            if (setDescription.includes(keyword)) {
                relevanceScore += 20;
                matchCount++;
            }
            // –ù–µ—á–µ—Ç–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏
            else if (isFuzzyMatch(setDescription, keyword, 0.8)) {
                relevanceScore += 10;
                matchCount++;
            }
        });
        
        // –ë–æ–Ω—É—Å –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        if (matchCount > 0) {
            relevanceScore += matchCount * 10;
        }
        
        // –ë–æ–Ω—É—Å –∑–∞ –Ω–µ–¥–∞–≤–Ω–∏–µ –Ω–∞–±–æ—Ä—ã (–µ—Å–ª–∏ –≥–æ–¥ —É–∫–∞–∑–∞–Ω)
        if (setYear > 2010) {
            relevanceScore += 5;
        }
        
        // –ë–æ–Ω—É—Å –∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã
        const popularThemes = ['star wars', 'marvel', 'dc', 'harry potter', 'friends', 'creator', 'technic', 'city'];
        if (popularThemes.some(theme => setTheme.includes(theme))) {
            relevanceScore += 15;
        }
        
        return matchCount > 0 ? { ...set, relevanceScore, matchCount } : null;
    }).filter(Boolean);
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    searchResults.sort((a, b) => {
        // –°–Ω–∞—á–∞–ª–∞ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        if (a.relevanceScore !== b.relevanceScore) {
            return b.relevanceScore - a.relevanceScore;
        }
        
        // –ó–∞—Ç–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        if (a.matchCount !== b.matchCount) {
            return b.matchCount - a.matchCount;
        }
        
        // –ó–∞—Ç–µ–º –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
        if (a.year !== b.year) {
            return (b.year || 0) - (a.year || 0);
        }
        
        // –ó–∞—Ç–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        return a.name.localeCompare(b.name);
    });
    
    console.log(`–ù–∞–π–¥–µ–Ω–æ ${searchResults.length} –Ω–∞–±–æ—Ä–æ–≤ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É "${searchTerm}"`);
    
    if (searchResults.length > 0) {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–æ–≤ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        S.view = 'sets';
        S.searchQuery = searchTerm;
        renderMainContent();
        console.log(`–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–æ–≤, –Ω–∞–π–¥–µ–Ω–æ ${searchResults.length} –Ω–∞–±–æ—Ä–æ–≤`);
    } else {
        console.log('–ù–∞–±–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        alert(`–ù–∞–±–æ—Ä—ã –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É "${searchTerm}" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`);
    }
}

// –ü–æ–∏—Å–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
window.searchInMinifigsCatalog = function(searchTerm) {
    console.log(`–ü–æ–∏—Å–∫ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É: ${searchTerm}`);
    console.log(`MINIFIG_MAP —Å–æ–¥–µ—Ä–∂–∏—Ç ${Object.keys(MINIFIG_MAP).length} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫`);
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    const keywords = extractKeywords(searchTerm);
    console.log(`–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:`, keywords);
    
    if (keywords.length === 0) return [];
    
    // –ò—â–µ–º –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ —Å –ø–æ–¥—Å—á–µ—Ç–æ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    const searchResults = Object.values(MINIFIG_MAP).map(minifig => {
        if (!minifig || !minifig.name) return null;
        
        const minifigName = minifig.name.toLowerCase();
        const minifigTheme = (minifig.theme_name || '').toLowerCase();
        const minifigYear = minifig.year || 0;
        
        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
        let relevanceScore = 0;
        let matchCount = 0;
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∏—Å–∫ –ø–æ —Ñ—Ä–∞–∑–µ (–¥–ª—è —Ç–æ—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π)
        const phraseResult = searchByPhrase(minifigName, searchTerm);
        if (phraseResult.exact) {
            relevanceScore += 150; // –í—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è —Ç–æ—á–Ω—ã—Ö —Ñ—Ä–∞–∑
            matchCount++;
        } else if (phraseResult.score > 0) {
            relevanceScore += phraseResult.score;
            matchCount++;
        }
        
        // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        keywords.forEach(keyword => {
            // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
            if (minifigName.startsWith(keyword)) {
                relevanceScore += 100;
                matchCount++;
            }
            // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
            else if (minifigName.includes(keyword)) {
                relevanceScore += 50;
                matchCount++;
            }
            // –ù–µ—á–µ—Ç–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
            else if (isFuzzyMatch(minifigName, keyword, 0.8)) {
                relevanceScore += 25;
                matchCount++;
            }
            // –°–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ —Ç–µ–º–µ
            if (minifigTheme.includes(keyword)) {
                relevanceScore += 30;
                matchCount++;
            }
            // –ù–µ—á–µ—Ç–∫–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ —Ç–µ–º–µ
            else if (isFuzzyMatch(minifigTheme, keyword, 0.8)) {
                relevanceScore += 15;
                matchCount++;
            }
        });
        
        // –ë–æ–Ω—É—Å –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        if (matchCount > 0) {
            relevanceScore += matchCount * 10;
        }
        
        // –ë–æ–Ω—É—Å –∑–∞ –Ω–µ–¥–∞–≤–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ (–µ—Å–ª–∏ –≥–æ–¥ —É–∫–∞–∑–∞–Ω)
        if (minifigYear > 2010) {
            relevanceScore += 5;
        }
        
        // –ë–æ–Ω—É—Å –∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã
        const popularThemes = ['star wars', 'marvel', 'dc', 'harry potter', 'friends', 'creator', 'technic', 'city'];
        if (popularThemes.some(theme => minifigTheme.includes(theme))) {
            relevanceScore += 15;
        }
        
        // –ë–æ–Ω—É—Å –∑–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ (—Å–æ–¥–µ—Ä–∂–∞—Ç –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞)
        if (minifigName.includes('(') && minifigName.includes(')')) {
            relevanceScore += 10;
        }
        
        return matchCount > 0 ? { ...minifig, relevanceScore, matchCount } : null;
    }).filter(Boolean);
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    searchResults.sort((a, b) => {
        // –°–Ω–∞—á–∞–ª–∞ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
        if (a.relevanceScore !== b.relevanceScore) {
            return b.relevanceScore - a.relevanceScore;
        }
        
        // –ó–∞—Ç–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        if (a.matchCount !== b.matchCount) {
            return b.matchCount - a.matchCount;
        }
        
        // –ó–∞—Ç–µ–º –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)
        if (a.year !== b.year) {
            return (b.year || 0) - (a.year || 0);
        }
        
        // –ó–∞—Ç–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        return a.name.localeCompare(b.name);
    });
    
    console.log(`–ù–∞–π–¥–µ–Ω–æ ${searchResults.length} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É "${searchTerm}"`);
    
    if (searchResults.length > 0) {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        S.view = 'minifigs';
        S.searchQuery = searchTerm;
        renderMainContent();
        console.log(`–ü–µ—Ä–µ–∫–ª—é—á–∏–ª–∏—Å—å –Ω–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫, –Ω–∞–π–¥–µ–Ω–æ ${searchResults.length} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫`);
    } else {
        console.log('–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        alert(`–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É "${searchTerm}" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`);
    }
}

// –ü–æ–∏—Å–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∞–±–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
window.searchInSetsCatalogModal = function(searchTerm) {
    console.log(`–ü–æ–∏—Å–∫ –Ω–∞–±–æ—Ä–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ: ${searchTerm}`);
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let modalEl = document.getElementById('sets-search-modal');
    if (!modalEl) {
        modalEl = document.createElement('div');
        modalEl.id = 'sets-search-modal';
        modalEl.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm';
        document.body.appendChild(modalEl);
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    const keywords = extractKeywords(searchTerm);
    console.log(`–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:`, keywords);
    
    // –ò—â–µ–º –Ω–∞–±–æ—Ä—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    const searchResults = Object.values(SET_MAP).filter(set => {
        if (!set || !set.name) return false;
        
        const setName = set.name.toLowerCase();
        const setTheme = (set.theme_name || '').toLowerCase();
        const setDescription = (set.description || '').toLowerCase();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        return keywords.some(keyword => 
            setName.includes(keyword) || 
            setTheme.includes(keyword) ||
            setDescription.includes(keyword)
        );
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    searchResults.sort((a, b) => {
        const aName = a.name.toLowerCase();
        const bName = b.name.toLowerCase();
        
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        const aStartsWith = keywords.some(keyword => aName.startsWith(keyword));
        const bStartsWith = keywords.some(keyword => bName.startsWith(keyword));
        
        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;
        
        // –ó–∞—Ç–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        const aMatches = keywords.filter(keyword => aName.includes(keyword)).length;
        const bMatches = keywords.filter(keyword => bName.includes(keyword)).length;
        
        if (aMatches !== bMatches) return bMatches - aMatches;
        
        // –ó–∞—Ç–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        return a.name.localeCompare(b.name);
    });
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const limitedResults = searchResults.slice(0, 50);
    
    console.log(`–ù–∞–π–¥–µ–Ω–æ ${limitedResults.length} –Ω–∞–±–æ—Ä–æ–≤ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É "${searchTerm}"`);
    
    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalEl.innerHTML = `
        <div class="bg-gray-800 rounded-[18px] shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                <h2 class="text-lg lg:text-xl font-bold text-white truncate flex-1 min-w-0" id="sets-search-title">–ü–æ–∏—Å–∫ –Ω–∞–±–æ—Ä–æ–≤</h2>
                <button id="close-sets-search-modal" class="modal-close-btn flex-shrink-0 w-8 h-8 min-w-[2rem] min-h-[2rem] rounded-full" title="–ó–∞–∫—Ä—ã—Ç—å">
                    ${I_X('w-4 h-4')}
                </button>
            </div>
            
            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <label for="sets-search-input" class="text-sm font-medium text-gray-300 whitespace-nowrap">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="sets-search-input" 
                            value="${searchTerm}" 
                            class="w-full px-4 py-2 bg-gray-700 text-white rounded-[18px] border border-gray-600 focus:border-green-500 focus:ring-2 focus:ring-green-500/20 focus:outline-none transition-all duration-200"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞..."
                            autocomplete="off"
                        />
                        <button 
                            id="clear-sets-search-input" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-all duration-200"
                            title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ"
                            style="opacity: 0; pointer-events: none;"
                        >
                            ${I_X('w-4 h-4')}
                        </button>
                    </div>
                    <button 
                        id="search-sets-btn" 
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-[18px] transition-colors duration-200 flex items-center gap-2"
                        title="–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫"
                    >
                        ${I_Search('w-4 h-4')}
                        <span class="hidden sm:inline">–ü–æ–∏—Å–∫</span>
                    </button>
                </div>
            </div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
            <div class="flex-1 overflow-hidden relative" style="min-height: 500px;">
                <div id="sets-search-scroll-progress"><div class="bar"></div></div>
                <div id="sets-search-results" class="h-full overflow-y-auto no-scrollbar p-4" style="max-height: calc(90vh - 200px);">
                    ${limitedResults.length > 0 ? 
                        `<div class="sets-minifigs-grid">
                            ${limitedResults.map(set => renderSetCard(set, false, 0)).join('')}
                        </div>` :
                        `<div class="text-center py-8">
                            <div class="text-4xl mb-3">${I_Search('w-12 h-12 mx-auto text-gray-400')}</div>
                            <p class="text-sm text-gray-400">–ù–∞–±–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p class="text-xs text-gray-500 mt-2">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
                        </div>`
                    }
                </div>
            </div>
        </div>
    `;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modalEl.style.display = 'flex';
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    setupSetsSearchModalHandlers();
}

// –ü–æ–∏—Å–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
window.searchInMinifigsCatalogModal = function(searchTerm) {
    console.log(`–ü–æ–∏—Å–∫ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ: ${searchTerm}`);
    
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let modalEl = document.getElementById('minifigs-search-modal');
    if (!modalEl) {
        modalEl = document.createElement('div');
        modalEl.id = 'minifigs-search-modal';
        modalEl.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm';
        document.body.appendChild(modalEl);
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    const keywords = extractKeywords(searchTerm);
    console.log(`–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:`, keywords);
    
    // –ò—â–µ–º –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    const searchResults = Object.values(MINIFIG_MAP).filter(minifig => {
        if (!minifig || !minifig.name) return false;
        
        const minifigName = minifig.name.toLowerCase();
        const minifigTheme = (minifig.theme_name || '').toLowerCase();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
        return keywords.some(keyword => 
            minifigName.includes(keyword) || 
            minifigTheme.includes(keyword)
        );
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    searchResults.sort((a, b) => {
        const aName = a.name.toLowerCase();
        const bName = b.name.toLowerCase();
        
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        const aStartsWith = keywords.some(keyword => aName.startsWith(keyword));
        const bStartsWith = keywords.some(keyword => bName.startsWith(keyword));
        
        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;
        
        // –ó–∞—Ç–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
        const aMatches = keywords.filter(keyword => aName.includes(keyword)).length;
        const bMatches = keywords.filter(keyword => bName.includes(keyword)).length;
        
        if (aMatches !== bMatches) return bMatches - aMatches;
        
        // –ó–∞—Ç–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        return a.name.localeCompare(b.name);
    });
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const limitedResults = searchResults.slice(0, 50);
    
    console.log(`–ù–∞–π–¥–µ–Ω–æ ${limitedResults.length} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É "${searchTerm}"`);
    
    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalEl.innerHTML = `
        <div class="bg-gray-800 rounded-[18px] shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                <h2 class="text-lg lg:text-xl font-bold text-white truncate flex-1 min-w-0" id="minifigs-search-title">–ü–æ–∏—Å–∫ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫</h2>
                <button id="close-minifigs-search-modal" class="modal-close-btn flex-shrink-0 w-8 h-8 min-w-[2rem] min-h-[2rem] rounded-full" title="–ó–∞–∫—Ä—ã—Ç—å">
                    ${I_X('w-4 h-4')}
                </button>
            </div>
            
            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <label for="minifigs-search-input" class="text-sm font-medium text-gray-300 whitespace-nowrap">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="minifigs-search-input" 
                            value="${searchTerm}" 
                            class="w-full px-4 py-2 bg-gray-700 text-white rounded-[18px] border border-gray-600 focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 focus:outline-none transition-all duration-200"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞..."
                            autocomplete="off"
                        />
                        <button 
                            id="clear-minifigs-search-input" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-all duration-200"
                            title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ"
                            style="opacity: 0; pointer-events: none;"
                        >
                            ${I_X('w-4 h-4')}
                        </button>
                    </div>
                    <button 
                        id="search-minifigs-btn" 
                        class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-[18px] transition-colors duration-200 flex items-center gap-2"
                        title="–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫"
                    >
                        ${I_Search('w-4 h-4')}
                        <span class="hidden sm:inline">–ü–æ–∏—Å–∫</span>
                    </button>
                </div>
            </div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
            <div class="flex-1 overflow-hidden relative" style="min-height: 500px;">
                <div id="minifigs-search-scroll-progress"><div class="bar"></div></div>
                <div id="minifigs-search-results" class="h-full overflow-y-auto no-scrollbar p-4" style="max-height: calc(90vh - 200px);">
                    ${limitedResults.length > 0 ? 
                        `<div class="sets-minifigs-grid">
                            ${limitedResults.map(minifig => renderMinifigCard(minifig, false, 0)).join('')}
                        </div>` :
                        `<div class="text-center py-8">
                            <div class="text-4xl mb-3">${I_Search('w-12 h-12 mx-auto text-gray-400')}</div>
                            <p class="text-sm text-gray-400">–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p class="text-xs text-gray-500 mt-2">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
                        </div>`
                    }
                </div>
            </div>
        </div>
    `;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modalEl.style.display = 'flex';
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    setupMinifigsSearchModalHandlers();
}

// –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π
window.openPartSearchModal = function(partNumber) {
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    let modalEl = document.getElementById('part-search-modal');
    if (!modalEl) {
        modalEl = document.createElement('div');
        modalEl.id = 'part-search-modal';
        modalEl.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 backdrop-blur-sm';
        document.body.appendChild(modalEl);
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalEl.innerHTML = `
        <div class="bg-gray-800 rounded-[18px] shadow-xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                <h2 class="text-lg lg:text-xl font-bold text-white truncate flex-1 min-w-0" id="part-search-title">–ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π</h2>
                <button id="close-part-search-modal" class="modal-close-btn flex-shrink-0 w-8 h-8 min-w-[2rem] min-h-[2rem]" title="–ó–∞–∫—Ä—ã—Ç—å">
                    ${I_X('w-4 h-4')}
                </button>
            </div>
            
            <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700">
                <div class="flex items-center gap-3">
                    <label for="part-search-input" class="text-sm font-medium text-gray-300 whitespace-nowrap">ID –¥–µ—Ç–∞–ª–∏:</label>
                    <div class="flex-1 relative">
                        <input 
                            type="text" 
                            id="part-search-input" 
                            value="${partNumber}" 
                            class="w-full px-4 py-2 bg-gray-700 text-white rounded-[18px] border border-gray-600 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 focus:outline-none transition-all duration-200"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ ID –¥–µ—Ç–∞–ª–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞..."
                            autocomplete="off"
                        />
                        <button 
                            id="clear-part-search-input" 
                            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white transition-all duration-200"
                            title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ"
                            style="opacity: 0; pointer-events: none;"
                        >
                            ${I_X('w-4 h-4')}
                        </button>
                    </div>
                    <button 
                        id="search-parts-btn" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-[18px] transition-colors duration-200 flex items-center gap-2"
                        title="–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫"
                    >
                        ${I_Search('w-4 h-4')}
                        <span class="hidden sm:inline">–ü–æ–∏—Å–∫</span>
                    </button>
                </div>
            </div>
            
            <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
            <div class="flex-1 overflow-hidden relative">
                <div id="part-search-scroll-progress"><div class="bar"></div></div>
                <div id="part-search-results" class="h-full overflow-y-auto no-scrollbar p-4" style="max-height: calc(90vh - 200px);">
                    <div class="text-center text-gray-400 py-8">
                        <div class="text-4xl mb-3">${I_Search('w-12 h-12 mx-auto')}</div>
                        <p>–ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π...</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    modalEl.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–∏—Å–∫
    performPartSearch(partNumber);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    setupPartSearchModalHandlers();
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤
window.setupSetsSearchModalHandlers = function() {
    const modalEl = document.getElementById('sets-search-modal');
    const closeBtn = document.getElementById('close-sets-search-modal');
    const searchInput = document.getElementById('sets-search-input');
    const clearBtn = document.getElementById('clear-sets-search-input');
    const searchBtn = document.getElementById('search-sets-btn');
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    closeBtn.addEventListener('click', closeSetsSearchModal);
    modalEl.addEventListener('click', (e) => {
        if (e.target === modalEl) {
            closeSetsSearchModal();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—è –≤–≤–æ–¥–∞
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
                updateClearButtonVisibility();
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
    function updateClearButtonVisibility() {
        if (clearBtn && searchInput) {
            if (searchInput.value.trim()) {
                clearBtn.style.opacity = '1';
                clearBtn.style.pointerEvents = 'auto';
            } else {
                clearBtn.style.opacity = '0';
                clearBtn.style.pointerEvents = 'none';
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (searchInput) {
        searchInput.addEventListener('input', updateClearButtonVisibility);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
        updateClearButtonVisibility();
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞
    if (searchBtn) {
        searchBtn.addEventListener('click', () => {
            if (searchInput) {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchInSetsCatalogModal(searchTerm);
                }
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (searchInput) {
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchInSetsCatalogModal(searchTerm);
                }
            }
        });
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        searchInput.focus();
        searchInput.select();
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–æ–ª–ª-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∏ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    setTimeout(() => {
        console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ –∏ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤');
        setupSetsSearchScrollProgress();
        setupSetsSearchSwipe();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞–±–æ—Ä–æ–≤
        const scrollContainer = document.getElementById('sets-search-results');
        if (scrollContainer) {
            scrollContainer.addEventListener('click', (e) => {
                const setCard = e.target.closest('.set-card');
                if (setCard) {
                    const setId = setCard.dataset.setNum;
                    if (setId) {
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞
                        closeSetsSearchModal();
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–±–æ—Ä–∞
                        openModalForSet(setId);
                    }
                }
            });
        }
    }, 100);
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
window.setupMinifigsSearchModalHandlers = function() {
    const modalEl = document.getElementById('minifigs-search-modal');
    const closeBtn = document.getElementById('close-minifigs-search-modal');
    const searchInput = document.getElementById('minifigs-search-input');
    const clearBtn = document.getElementById('clear-minifigs-search-input');
    const searchBtn = document.getElementById('search-minifigs-btn');
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    closeBtn.addEventListener('click', closeMinifigsSearchModal);
    modalEl.addEventListener('click', (e) => {
        if (e.target === modalEl) {
            closeMinifigsSearchModal();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—è –≤–≤–æ–¥–∞
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
                updateClearButtonVisibility();
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
    function updateClearButtonVisibility() {
        if (clearBtn && searchInput) {
            if (searchInput.value.trim()) {
                clearBtn.style.opacity = '1';
                clearBtn.style.pointerEvents = 'auto';
            } else {
                clearBtn.style.opacity = '0';
                clearBtn.style.pointerEvents = 'none';
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (searchInput) {
        searchInput.addEventListener('input', updateClearButtonVisibility);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
        updateClearButtonVisibility();
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞
    if (searchBtn) {
        searchBtn.addEventListener('click', () => {
            if (searchInput) {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchInMinifigsCatalogModal(searchTerm);
                }
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (searchInput) {
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    searchInMinifigsCatalogModal(searchTerm);
                }
            }
        });
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        searchInput.focus();
        searchInput.select();
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–æ–ª–ª-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∏ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    setTimeout(() => {
        setupMinifigsSearchScrollProgress();
        setupMinifigsSearchSwipe();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        const scrollContainer = document.getElementById('minifigs-search-results');
        if (scrollContainer) {
            scrollContainer.addEventListener('click', (e) => {
                const minifigCard = e.target.closest('.minifig-card');
                if (minifigCard) {
                    const minifigId = minifigCard.dataset.figNum;
                    if (minifigId) {
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞
                        closeMinifigsSearchModal();
                        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                        openModalForMinifig(minifigId);
                    }
                }
            });
        }
    }, 100);
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤
window.closeSetsSearchModal = function() {
    const modalEl = document.getElementById('sets-search-modal');
    if (modalEl) {
        modalEl.style.display = 'none';
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
window.closeMinifigsSearchModal = function() {
    const modalEl = document.getElementById('minifigs-search-modal');
    if (modalEl) {
        modalEl.style.display = 'none';
    }
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–æ–ª–ª-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤
window.setupSetsSearchScrollProgress = function() {
    const track = document.getElementById('sets-search-scroll-progress');
    const scrollArea = document.getElementById('sets-search-results');
    
    if (!track || !scrollArea) return;
    
    const bar = track.querySelector('.bar');
    if (!bar) return;
    
    const updateScrollProgress = () => {
        const max = scrollArea.scrollHeight - scrollArea.clientHeight;
        if (max <= 0) {
            track.classList.remove('visible');
            return;
        }
        
        const percent = (scrollArea.scrollTop / max) * 100;
        const barHeight = Math.max(48, (scrollArea.clientHeight / scrollArea.scrollHeight) * scrollArea.clientHeight);
        
        bar.style.height = `${barHeight}px`;
        bar.style.transform = `translateY(${percent * (scrollArea.clientHeight - barHeight) / 100}px)`;
        track.classList.add('visible');
    };
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (scrollArea._scrollHandler) {
        scrollArea.removeEventListener('scroll', scrollArea._scrollHandler);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    scrollArea._scrollHandler = updateScrollProgress;
    scrollArea.addEventListener('scroll', updateScrollProgress, { passive: true });
    
    // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    if (scrollArea._resizeObserver) {
        scrollArea._resizeObserver.disconnect();
    }
    
    scrollArea._resizeObserver = new ResizeObserver(updateScrollProgress);
    scrollArea._resizeObserver.observe(scrollArea);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    setTimeout(updateScrollProgress, 100);
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–∫—Ä–æ–ª–ª-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
window.setupMinifigsSearchScrollProgress = function() {
    const track = document.getElementById('minifigs-search-scroll-progress');
    const scrollArea = document.getElementById('minifigs-search-results');
    
    if (!track || !scrollArea) return;
    
    const bar = track.querySelector('.bar');
    if (!bar) return;
    
    const updateScrollProgress = () => {
        const max = scrollArea.scrollHeight - scrollArea.clientHeight;
        if (max <= 0) {
            track.classList.remove('visible');
            return;
        }
        
        const percent = (scrollArea.scrollTop / max) * 100;
        const barHeight = Math.max(48, (scrollArea.clientHeight / scrollArea.scrollHeight) * scrollArea.clientHeight);
        
        bar.style.height = `${barHeight}px`;
        bar.style.transform = `translateY(${percent * (scrollArea.clientHeight - barHeight) / 100}px)`;
        track.classList.add('visible');
    };
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (scrollArea._scrollHandler) {
        scrollArea.removeEventListener('scroll', scrollArea._scrollHandler);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
    scrollArea._scrollHandler = updateScrollProgress;
    scrollArea.addEventListener('scroll', updateScrollProgress, { passive: true });
    
    // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Ä–∞–∑–º–µ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    if (scrollArea._resizeObserver) {
        scrollArea._resizeObserver.disconnect();
    }
    
    scrollArea._resizeObserver = new ResizeObserver(updateScrollProgress);
    scrollArea._resizeObserver.observe(scrollArea);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
    setTimeout(updateScrollProgress, 100);
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤
window.setupSetsSearchSwipe = function() {
    const scrollContainer = document.getElementById('sets-search-results');
    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤:', { scrollContainer });
    if (!scrollContainer) {
        console.log('–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è –Ω–∞–±–æ—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    let startY = 0;
    let startX = 0;
    let isScrolling = false;
    
    const handleTouchStart = (e) => {
        startY = e.touches[0].clientY;
        startX = e.touches[0].clientX;
        isScrolling = false;
    };
    
    const handleTouchMove = (e) => {
        if (!isScrolling) {
            const deltaY = Math.abs(e.touches[0].clientY - startY);
            const deltaX = Math.abs(e.touches[0].clientX - startX);
            isScrolling = deltaY > deltaX;
        }
    };
    
    const handleTouchEnd = (e) => {
        if (!isScrolling) {
            const deltaY = e.changedTouches[0].clientY - startY;
            const threshold = 50;
            
            if (Math.abs(deltaY) > threshold) {
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑
                const scrollAmount = deltaY > 0 ? -300 : 300;
                scrollContainer.scrollBy({
                    top: scrollAmount,
                    behavior: 'smooth'
                });
            }
        }
    };
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (scrollContainer._touchStartHandler) {
        scrollContainer.removeEventListener('touchstart', scrollContainer._touchStartHandler);
        scrollContainer.removeEventListener('touchmove', scrollContainer._touchMoveHandler);
        scrollContainer.removeEventListener('touchend', scrollContainer._touchEndHandler);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    scrollContainer._touchStartHandler = handleTouchStart;
    scrollContainer._touchMoveHandler = handleTouchMove;
    scrollContainer._touchEndHandler = handleTouchEnd;
    
    scrollContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
    scrollContainer.addEventListener('touchmove', handleTouchMove, { passive: true });
    scrollContainer.addEventListener('touchend', handleTouchEnd, { passive: true });
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
window.setupMinifigsSearchSwipe = function() {
    const scrollContainer = document.getElementById('minifigs-search-results');
    if (!scrollContainer) return;
    
    let startY = 0;
    let startX = 0;
    let isScrolling = false;
    
    const handleTouchStart = (e) => {
        startY = e.touches[0].clientY;
        startX = e.touches[0].clientX;
        isScrolling = false;
    };
    
    const handleTouchMove = (e) => {
        if (!isScrolling) {
            const deltaY = Math.abs(e.touches[0].clientY - startY);
            const deltaX = Math.abs(e.touches[0].clientX - startX);
            isScrolling = deltaY > deltaX;
        }
    };
    
    const handleTouchEnd = (e) => {
        if (!isScrolling) {
            const deltaY = e.changedTouches[0].clientY - startY;
            const threshold = 50;
            
            if (Math.abs(deltaY) > threshold) {
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–≤–µ—Ä—Ö –∏–ª–∏ –≤–Ω–∏–∑
                const scrollAmount = deltaY > 0 ? -300 : 300;
                scrollContainer.scrollBy({
                    top: scrollAmount,
                    behavior: 'smooth'
                });
            }
        }
    };
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
    if (scrollContainer._touchStartHandler) {
        scrollContainer.removeEventListener('touchstart', scrollContainer._touchStartHandler);
        scrollContainer.removeEventListener('touchmove', scrollContainer._touchMoveHandler);
        scrollContainer.removeEventListener('touchend', scrollContainer._touchEndHandler);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    scrollContainer._touchStartHandler = handleTouchStart;
    scrollContainer._touchMoveHandler = handleTouchMove;
    scrollContainer._touchEndHandler = handleTouchEnd;
    
    scrollContainer.addEventListener('touchstart', handleTouchStart, { passive: true });
    scrollContainer.addEventListener('touchmove', handleTouchMove, { passive: true });
    scrollContainer.addEventListener('touchend', handleTouchEnd, { passive: true });
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞
window.setupPartSearchModalHandlers = function() {
    const modalEl = document.getElementById('part-search-modal');
    const closeBtn = document.getElementById('close-part-search-modal');
    const searchInput = document.getElementById('part-search-input');
    const clearBtn = document.getElementById('clear-part-search-input');
    const searchBtn = document.getElementById('search-parts-btn');
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    closeBtn.addEventListener('click', closePartSearchModal);
    modalEl.addEventListener('click', (e) => {
        if (e.target === modalEl) {
            closePartSearchModal();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—á–∏—Å—Ç–∫–∏ –ø–æ–ª—è –≤–≤–æ–¥–∞
    if (clearBtn) {
        clearBtn.addEventListener('click', () => {
            if (searchInput) {
                searchInput.value = '';
                searchInput.focus();
                updateClearButtonVisibility();
            }
        });
    }
    
    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
    function updateClearButtonVisibility() {
        if (clearBtn && searchInput) {
            if (searchInput.value.trim()) {
                clearBtn.style.opacity = '1';
                clearBtn.style.pointerEvents = 'auto';
            } else {
                clearBtn.style.opacity = '0';
                clearBtn.style.pointerEvents = 'none';
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (searchInput) {
        searchInput.addEventListener('input', updateClearButtonVisibility);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
        updateClearButtonVisibility();
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞
    if (searchBtn) {
        searchBtn.addEventListener('click', () => {
            if (searchInput) {
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    performPartSearch(searchTerm);
                }
            }
        });
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (searchInput) {
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchTerm = searchInput.value.trim();
                if (searchTerm) {
                    performPartSearch(searchTerm);
                }
            }
        });
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        searchInput.focus();
        searchInput.select();
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    setupPartSearchScrollProgress();
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π
window.setupPartSearchScrollProgress = function() {
    const track = document.getElementById('part-search-scroll-progress');
    const scrollArea = document.getElementById('part-search-results');
    
    if (!track || !scrollArea) return;
    
    const bar = track.querySelector('.bar');
    if (!bar) return;
    
    const updateScrollProgress = () => {
        const max = scrollArea.scrollHeight - scrollArea.clientHeight;
        if (max <= 0) {
            track.classList.remove('visible');
            return;
        }
        
        const percent = Math.min(100, Math.max(0, (scrollArea.scrollTop / max) * 100));
        const containerH = track.clientHeight || 0;
        const barH = bar.clientHeight || 24;
        const maxOffset = Math.max(0, containerH - barH);
        const offset = (percent / 100) * maxOffset;
        
        bar.style.transform = `translateY(${offset}px)`;
        track.classList.add('visible');
    };
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
    scrollArea.addEventListener('scroll', updateScrollProgress, { passive: true });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞
    const resizeObserver = new ResizeObserver(updateScrollProgress);
    resizeObserver.observe(scrollArea);
    
    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    setTimeout(updateScrollProgress, 100);
}

// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π
window.performPartSearch = function(query) {
    const resultsContainer = document.getElementById('part-search-results');
    if (!resultsContainer) return;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    resultsContainer.innerHTML = `
        <div class="text-center text-gray-400 py-8">
            <div class="text-4xl mb-3">${I_Search('w-12 h-12 mx-auto')}</div>
            <p>–ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π...</p>
        </div>
    `;
    
    // –≠—Ç–∞–ø 1: –ü–æ–∏—Å–∫ –ø–æ —Ç–æ—á–Ω–æ–º—É ID
    let searchResults = Object.values(PART_MAP).filter(part => {
        if (!part || !part.name) return false;
        return part.id === query;
    });
    
    // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ç–æ—á–Ω–æ–º—É ID, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
    if (searchResults.length > 0) {
        console.log(`–ù–∞–π–¥–µ–Ω–æ ${searchResults.length} –¥–µ—Ç–∞–ª–µ–π –ø–æ —Ç–æ—á–Ω–æ–º—É ID: ${query}`);
        displayPartSearchResults(searchResults, '–ü–æ ID');
        return;
    }
    
    // –≠—Ç–∞–ø 2: –ü–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É ID
    searchResults = Object.values(PART_MAP).filter(part => {
        if (!part || !part.name) return false;
        return part.id.toLowerCase().includes(query.toLowerCase());
    });
    
    // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É ID, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
    if (searchResults.length > 0) {
        console.log(`–ù–∞–π–¥–µ–Ω–æ ${searchResults.length} –¥–µ—Ç–∞–ª–µ–π –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É ID: ${query}`);
        searchResults.sort((a, b) => a.name.localeCompare(b.name));
        displayPartSearchResults(searchResults, '–ü–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É ID');
        return;
    }
    
    // –≠—Ç–∞–ø 3: Fallback –ø–æ–∏—Å–∫ –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏ ID
    if (searchResults.length === 0) {
        console.log(`–ü–æ–∏—Å–∫ –ø–æ ID –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏: ${query}`);
        
        // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        const numericPart = query.match(/^\d+/);
        if (numericPart) {
            const numericId = numericPart[0];
            console.log(`–ò—â–µ–º –¥–µ—Ç–∞–ª–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å —Ü–∏—Ñ—Ä: ${numericId}`);
            
            searchResults = Object.values(PART_MAP).filter(part => {
                if (!part || !part.name) return false;
                return part.id && part.id.toLowerCase().startsWith(numericId);
            });
            
            if (searchResults.length > 0) {
                console.log(`–ù–∞–π–¥–µ–Ω–æ ${searchResults.length} –¥–µ—Ç–∞–ª–µ–π –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏ ${numericId}`);
                searchResults.sort((a, b) => a.name.localeCompare(b.name));
                displayPartSearchResults(searchResults, '–ü–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏ ID');
                return;
            }
        }
    }
    
    // –≠—Ç–∞–ø 4: –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Å—Ä–µ–¥–∏ –≤—Å–µ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞
    console.log(`–ü–æ–∏—Å–∫ –ø–æ ID –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –∏—â–µ–º –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é: ${query}`);
    searchResults = Object.values(PART_MAP).filter(part => {
        if (!part || !part.name) return false;
        return part.name.toLowerCase().includes(query.toLowerCase());
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    searchResults.sort((a, b) => {
        const queryLower = query.toLowerCase();
        const aNameLower = a.name.toLowerCase();
        const bNameLower = b.name.toLowerCase();
        
        // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ –Ω–∞–∑–≤–∞–Ω–∏—è
        const aStartsWith = aNameLower.startsWith(queryLower);
        const bStartsWith = bNameLower.startsWith(queryLower);
        
        if (aStartsWith && !bStartsWith) return -1;
        if (!aStartsWith && bStartsWith) return 1;
        
        // –ó–∞—Ç–µ–º –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
        return a.name.localeCompare(b.name);
    });
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    if (searchResults.length > 50) {
        searchResults = searchResults.slice(0, 50);
        console.log(`–û–≥—Ä–∞–Ω–∏—á–µ–Ω–æ –¥–æ 50 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ ${searchResults.length} –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö`);
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    displayPartSearchResults(searchResults, '–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é');
}

// –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π
window.displayPartSearchResults = function(parts, searchType = '') {
    const resultsContainer = document.getElementById('part-search-results');
    if (!resultsContainer) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const titleElement = document.getElementById('part-search-title');
    if (titleElement) {
        const count = parts.length;
        const countText = count === 0 ? '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤' : 
                         count === 1 ? '1 –¥–µ—Ç–∞–ª—å' : 
                         `${count} –¥–µ—Ç–∞–ª–µ–π`;
        titleElement.textContent = `–ü–æ–∏—Å–∫ (${countText})`;
    }
    
    if (parts.length === 0) {
        resultsContainer.innerHTML = `
            <div class="text-center text-gray-400 py-8">
                <div class="text-4xl mb-3">${I_Search('w-12 h-12 mx-auto')}</div>
                <p>–î–µ—Ç–∞–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                <p class="text-xs text-gray-500 mt-2">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</p>
            </div>
        `;
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ–∏—Å–∫–µ
    const headerHtml = `
        <div class="mb-4 p-3 bg-gray-800/50 rounded-[18px] border border-gray-700">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="text-green-400">${I_CheckCircle('w-5 h-5')}</div>
                    <span class="text-sm font-medium text-gray-200">
                        –ù–∞–π–¥–µ–Ω–æ: <span class="text-green-400 font-bold">${parts.length}</span> ${parts.length === 1 ? '—ç–ª–µ–º–µ–Ω—Ç' : parts.length < 5 ? '—ç–ª–µ–º–µ–Ω—Ç–∞' : '—ç–ª–µ–º–µ–Ω—Ç–æ–≤'}
                    </span>
                </div>
                ${searchType ? `<span class="text-xs text-gray-400 bg-gray-700 px-2 py-1 rounded">${searchType}</span>` : ''}
            </div>
        </div>
    `;
    
    // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const gridContainer = document.createElement('div');
    gridContainer.className = 'sets-minifigs-grid';
    
    const resultsHtml = parts.map((part, index) => {
        return renderPartCard(part, null, 0, false, index);
    }).join('');
    
    gridContainer.innerHTML = resultsHtml;
    resultsContainer.innerHTML = headerHtml;
    resultsContainer.appendChild(gridContainer);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏
    gridContainer.querySelectorAll('.part-card').forEach((card, index) => {
        const partId = parts[index].id;
        card.addEventListener('click', () => {
            const groupId = getGroupId(partId);
            openModalForPart(partId, groupId, [parts[index]]);
            closePartSearchModal();
        });
    });
}

// –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
window.clearPartSearchResults = function() {
    const resultsContainer = document.getElementById('part-search-results');
    if (resultsContainer) {
        resultsContainer.innerHTML = `
            <div class="text-center text-gray-400 py-8">
                <div class="text-4xl mb-3">${I_Search('w-12 h-12 mx-auto')}</div>
                <p>–ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π...</p>
            </div>
        `;
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞
window.closePartSearchModal = function() {
    const modalEl = document.getElementById('part-search-modal');
    if (modalEl) {
        modalEl.style.display = 'none';
        document.body.style.overflow = '';
    }
}

// –ú–∞—Å—Å–∏–≤ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
const inactivityTips = [
    "üìà –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–¥–µ–ª '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞' –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏",
    "üîÑ –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à",
    "üéØ –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∏ –º—É–ª—å—Ç–∏–∫—Ä–∏—Ç–µ—Ä–∏–∞–ª—å–Ω–æ",
    "üì± –°–∞–π—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - —É–¥–æ–±–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ",
    "üîÑ –£–º–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥–∞–Ω–Ω—ã—Ö",
    "üìä –í –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø–æ —Ü–≤–µ—Ç–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º",
    "üé≤ –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ '–î–µ—Ç–∞–ª–∏', '–ù–∞–±–æ—Ä—ã' –∏–ª–∏ '–§–∏–≥—É—Ä–∫–∏' 1 —Å–µ–∫—É–Ω–¥—É –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞",
    "üîç –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã",
    "üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã",
    "üí° –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã",
    "üåê –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–∫—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ö–æ–¥–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ API –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã",
    "üìã –ü–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ—Å—å –º–µ–∂–¥—É –∫–∞—Ç–∞–ª–æ–≥–æ–º –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á",
    "üé® –§–∏–ª—å—Ç—Ä—É–π—Ç–µ –¥–µ—Ç–∞–ª–∏ –ø–æ —Ü–≤–µ—Ç—É –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ –∫ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
    "‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏",
    "üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –¥–µ—Ç–∞–ª–µ–π",
    "‚òÅÔ∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏",
    "üîß –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–µ–º–∞–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–µ—Ä–∏–∏",
    "üß† –£–º–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ",
    "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ",
    "‚ù§Ô∏è –î–æ–±–∞–≤–ª—è–π—Ç–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞",
    "üíæ –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –±—Ä–∞—É–∑–µ—Ä–∞",
    "ü•ß –ö—Ä—É–≥–æ–≤—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ç–µ–º–∞–º –∏ —Ä–µ–¥–∫–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤",
    "‚ö° –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑",
    "üîê –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
    "üéØ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –Ω—É–∂–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤",
    "üìã –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å–≤–æ—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV",
    "üìà –°—Ç–æ–ª–±—á–∞—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
    "üîÑ –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
    "üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤",
    "üîç –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –Ω—É–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π",
    "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
    "üí° –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã",
    "üîÑ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è",
    "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö",
    "üîç –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é - –Ω–µ –Ω—É–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ",
    "üì± PWA –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω–æ–µ",
    "‚ù§Ô∏è –î–æ–±–∞–≤–ª—è–π—Ç–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ–º—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞",
    "üåê Offline —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö",
    "üìä –í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞",
    "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
    "üñºÔ∏è –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ",
    "üéØ –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑—É—á–∏—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥–∞",
    "üé≤ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
    "üé® –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–µ–ª–∞—é—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–æ–ª–µ–µ –ø—Ä–∏—è—Ç–Ω—ã–º",
    "‚ö° –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ",
    "üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è",
    "üéØ –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é",
    "üìö –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –ø–æ–¥—Å–∫–∞–∑–∫–∞—Ö —Ä–∞—Å—à–∏—Ä—è–µ—Ç –∑–Ω–∞–Ω–∏—è –æ —Ñ—É–Ω–∫—Ü–∏—è—Ö",
    "üîç –§–∏–ª—å—Ç—Ä—ã –º–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤",
    "üé® –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–≤–µ—Ç–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∫ –Ω–∞–±–æ—Ä—É",
    "üìã –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏–∑ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
    "üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤",
    "üé≤ –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É –î–µ—Ç–∞–ª–∏/–ù–∞–±–æ—Ä—ã/–§–∏–≥—É—Ä–∫–∏ 1 —Å–µ–∫—É–Ω–¥—É –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞",
    "üñºÔ∏è –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º",
    "üì± –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤",
    "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏",
    "üì∑ –°–∫–∞–Ω–µ—Ä DataMatrix —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∫–æ–¥—ã —Å–µ—Ä–∏–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ —Å –ø–æ–º–æ—â—å—é –∫–∞–º–µ—Ä—ã",
    "ü§ñ AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Brickognize API –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º",
    "üì∑ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫–∞–Ω–µ—Ä DataMatrix –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é",
    "ü§ñ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –¥–µ—Ç–∞–ª—å, –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É –∏–ª–∏ –¥–∞–∂–µ –Ω–∞–±–æ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ AI",
    "üîç –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–º–æ–≥–∞—é—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã",
    "üì± –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É–¥–æ–±—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ –ª—é–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö",
    "üí° –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã"
];
const REBRICKABLE_API_URL = 'https://rebrickable.com/api/v3/lego';
const REBRICKABLE_API_KEYS = ['20c78cc607d6059c8d2a61338d851590', '04a7405ad41f1dd484a562f6e0c57312', 'd93f5c0989f63afa9b1c29ef8ad66002', 'b4179c1b8bd3c022ec9fc0e713e96b77', 'd32527bc33b575b8825a0ba04ba4add5'];
let currentApiKeyIndex = 0;

// –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ API
const PROXY_CONFIG = {
    currentProxyIndex: 0,
    proxies: [
        // –û—Å–Ω–æ–≤–Ω—ã–µ CORS –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä—ã (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2024)
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://cors.bridged.cc/',
        'https://yacdn.org/proxy/',
        'https://thingproxy.freeboard.io/fetch/',
        'https://api.allorigins.win/get?url=',
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä—ã
        'https://corsproxy.org/?',
        'https://cors-anywhere.herokuapp.com/',
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://cors.eu.org/',
        'https://cors-anywhere.herokuapp.com/',
        'https://api.allorigins.win/get?url=',
        
        // –ù–æ–≤—ã–µ –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä—ã
        'https://corsproxy.io/?',
        'https://api.allorigins.win/raw?url=',
        'https://cors.bridged.cc/',
        'https://yacdn.org/proxy/',
        'https://thingproxy.freeboard.io/fetch/',
        'https://api.codetabs.com/v1/proxy?quest=',
        
        // –†–µ–∑–µ—Ä–≤–Ω—ã–µ –ø—Ä–æ–∫—Å–∏
        'https://cors.eu.org/',
        'https://corsproxy.org/?',
        'https://api.allorigins.win/get?url=',
        'https://corsproxy.io/?',
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://cors.bridged.cc/',
        'https://yacdn.org/proxy/',
        'https://thingproxy.freeboard.io/fetch/',
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –ø—Ä–æ–∫—Å–∏
        'https://api.allorigins.win/raw?url=',
        'https://corsproxy.io/?',
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://cors.bridged.cc/',
        'https://yacdn.org/proxy/',
        'https://thingproxy.freeboard.io/fetch/',
        'https://api.allorigins.win/get?url=',
        'https://cors.eu.org/',
        'https://corsproxy.org/?'
    ],
    maxRetries: 3,
    retryDelay: 1000,
    // –ö—ç—à –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏
    testedProxies: new Map(),
    workingProxies: [],
    lastProxyTest: 0,
    proxyTestInterval: 180000, // 3 –º–∏–Ω—É—Ç—ã (—É–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏)
    maxConcurrentTests: 5, // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    proxyHealthCheck: true // –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∑–¥–æ—Ä–æ–≤—å—è –ø—Ä–æ–∫—Å–∏
};

// –ö—ç—à –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏
const FAILED_PROXIES = new Set();

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∫—Å–∏
const PROXY_STATS = {
    totalRequests: 0,
    successfulRequests: 0,
    failedRequests: 0,
    proxyUsage: new Map(), // –°—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–∫—Å–∏
    lastReset: Date.now()
};

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä–∞
async function testProxyAvailability(proxyUrl, timeout = 5000) {
    const testUrl = 'https://rebrickable.com/api/v3/lego/colors/?page=1&page_size=1';
    const proxyTestUrl = buildProxyUrl(testUrl, proxyUrl);
    
    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);
        
        const response = await fetch(proxyTestUrl, {
            method: 'GET',
            headers: {
                'Authorization': `key ${REBRICKABLE_API_KEYS[0]}`
            },
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (response.ok) {
            const data = await response.json();
            return {
                working: true,
                responseTime: Date.now() - PROXY_CONFIG.testedProxies.get(proxyUrl)?.startTime || 0,
                data: data
            };
        } else {
            return { working: false, error: `HTTP ${response.status}` };
        }
    } catch (error) {
        return { 
            working: false, 
            error: error.name === 'AbortError' ? 'Timeout' : error.message 
        };
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤
async function checkAllProxies(showDetails = false) {
    // –ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏—Ö
    if (!S.proxyEnabled) {
        console.log('üö´ –ü—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É');
        return false;
    }
    
    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤...');
    // updateApiStatus('checking', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫—Å–∏...', 'blue', showDetails);
    
    const testPromises = PROXY_CONFIG.proxies.map(async (proxy, index) => {
        const startTime = Date.now();
        PROXY_CONFIG.testedProxies.set(proxy, { startTime, index });
        
        const result = await testProxyAvailability(proxy);
        
        if (result.working) {
            console.log(`‚úÖ –ü—Ä–æ–∫—Å–∏ ${index + 1} —Ä–∞–±–æ—Ç–∞–µ—Ç: ${proxy} (${result.responseTime}ms)`);
            return { proxy, index, responseTime: result.responseTime };
        } else {
            console.log(`‚ùå –ü—Ä–æ–∫—Å–∏ ${index + 1} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${proxy} (${result.error})`);
            return null;
        }
    });
    
    const results = await Promise.all(testPromises);
    const workingProxies = results.filter(result => result !== null);
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞ (–±—ã—Å—Ç—Ä–µ–µ = –ª—É—á—à–µ)
    workingProxies.sort((a, b) => a.responseTime - b.responseTime);
    
    PROXY_CONFIG.workingProxies = workingProxies.map(r => r.proxy);
    PROXY_CONFIG.lastProxyTest = Date.now();
    
    console.log(`üéØ –ù–∞–π–¥–µ–Ω–æ ${workingProxies.length} —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏ –∏–∑ ${PROXY_CONFIG.proxies.length}`);
    
    if (workingProxies.length > 0) {
        console.log(`üèÜ –õ—É—á—à–∏–π –ø—Ä–æ–∫—Å–∏: ${workingProxies[0].proxy} (${workingProxies[0].responseTime}ms)`);
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å –Ω–∞ –ª—É—á—à–∏–π –ø—Ä–æ–∫—Å–∏
        PROXY_CONFIG.currentProxyIndex = workingProxies[0].index;
        // updateApiStatus('working', `${workingProxies.length} –ø—Ä–æ–∫—Å–∏`, 'green', showDetails);
    } else {
        console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤!');
        // updateApiStatus('error', '–ù–µ—Ç –ø—Ä–æ–∫—Å–∏', 'red', showDetails);
    }
    
    return workingProxies.length > 0;
}

// –ö—ç—à –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö IP
const BLOCKED_IP_CACHE = new Set();
let lastBlockedTime = 0;

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
let forceProxy = false;

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ CORS –æ—à–∏–±–æ–∫
window.addEventListener('error', (event) => {
    if (event.message && event.message.includes('CORS')) {
        console.log('üö´ –ì–ª–æ–±–∞–ª—å–Ω–∞—è CORS –æ—à–∏–±–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞, –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Å–∏');
        lastBlockedTime = Date.now();
        forceProxy = true;
    }
});

// –ü–µ—Ä–µ—Ö–≤–∞—Ç—á–∏–∫ –¥–ª—è unhandled promise rejections
window.addEventListener('unhandledrejection', (event) => {
    if (event.reason && event.reason.message && event.reason.message.includes('CORS')) {
        console.log('üö´ CORS –æ—à–∏–±–∫–∞ –≤ Promise, –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Å–∏');
        lastBlockedTime = Date.now();
        forceProxy = true;
    }
});

function getApiKey() {
    const key = REBRICKABLE_API_KEYS[currentApiKeyIndex];
    currentApiKeyIndex = (currentApiKeyIndex + 1) % REBRICKABLE_API_KEYS.length;
    return key;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –∫ –ø–µ—Ä–≤–æ–º—É API –∫–ª—é—á—É –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
function resetApiKeyOnSuccess() {
    if (currentApiKeyIndex !== 0) {
        console.log('üîÑ –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å API –∫–ª—é—á–∞ –Ω–∞ –ø–µ—Ä–≤—ã–π');
        currentApiKeyIndex = 0;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ API
function isApiBlocked(response, error) {
    if (error) {
        // CORS –æ—à–∏–±–∫–∏, —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏
        if (error.name === 'TypeError' || 
            error.message.includes('CORS') || 
            error.message.includes('NetworkError') ||
            error.message.includes('Failed to fetch') ||
            error.message.includes('blocked by CORS policy') ||
            error.message.includes('ERR_BLOCKED_BY_CLIENT') ||
            error.message.includes('ERR_NETWORK_CHANGED')) {
            console.log('üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ CORS/—Å–µ—Ç–∏:', error.message);
            return true;
        }
        return false;
    }
    
    if (response) {
        // HTTP —Å—Ç–∞—Ç—É—Å—ã, —É–∫–∞–∑—ã–≤–∞—é—â–∏–µ –Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
        const blockedStatuses = [401, 429, 403, 503, 0]; // Unauthorized, Rate limit, Forbidden, Service Unavailable, CORS block
        const isBlocked = blockedStatuses.includes(response.status);
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –æ—Ç–≤–µ—Ç–∞
        if (!isBlocked && response.headers) {
            const retryAfter = response.headers.get('Retry-After');
            const xRateLimitRemaining = response.headers.get('X-RateLimit-Remaining');
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å Retry-After –∑–∞–≥–æ–ª–æ–≤–æ–∫, —ç—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞
            if (retryAfter && parseInt(retryAfter) > 0) {
                console.log(`üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ Retry-After: ${retryAfter} —Å–µ–∫—É–Ω–¥`);
                return true;
            }
            
            // –ï—Å–ª–∏ –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å—á–µ—Ä–ø–∞–Ω
            if (xRateLimitRemaining === '0') {
                console.log('üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞: –∏—Å—á–µ—Ä–ø–∞–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤');
                return true;
            }
        }
        
        if (isBlocked) {
            console.log(`üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø–æ HTTP —Å—Ç–∞—Ç—É—Å—É: ${response.status}`);
        }
        return isBlocked;
    }
    
    return false;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω—É–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏
function shouldUseProxy() {
    // –ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
    if (!S.proxyEnabled) {
        console.log('–ü—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö');
        return false;
    }
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏
    if (forceProxy) {
        console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ –≤–∫–ª—é—á–µ–Ω–æ');
        return true;
    }
    
    // –ï—Å–ª–∏ IP –Ω–µ–¥–∞–≤–Ω–æ –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏
    const timeSinceBlocked = Date.now() - lastBlockedTime;
    const shouldUse = timeSinceBlocked < 300000; // 5 –º–∏–Ω—É—Ç
    
    if (shouldUse) {
        console.log(`IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏. –í—Ä–µ–º—è —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: ${Math.round(timeSinceBlocked / 1000)}—Å`);
    }
    
    return shouldUse;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä—è–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
async function testDirectConnection() {
    const testUrl = `${REBRICKABLE_API_URL}/colors/?page=1&page_size=1`;
    const testOptions = {
        method: 'GET',
        headers: {
            'Authorization': `key ${getApiKey()}`,
            'Accept': 'application/json'
        }
    };
    
    try {
        console.log('üîç –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API...');
        const response = await fetch(testUrl, testOptions);
        
        if (response.ok) {
            console.log('‚úÖ –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            lastBlockedTime = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Ä–µ–º—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
            BLOCKED_IP_CACHE.clear(); // –û—á–∏—â–∞–µ–º –∫—ç—à –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö IP
            return true;
        } else if (isApiBlocked(response)) {
            if (response.status === 401) {
                console.log('‚ùå –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (401 - –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)');
            } else {
                console.log('‚ùå –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ');
            }
            return false;
        } else {
            console.log(`‚ö†Ô∏è –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–µ—Ä–Ω—É–ª–æ —Å—Ç–∞—Ç—É—Å ${response.status}`);
            return false;
        }
    } catch (error) {
        if (isApiBlocked(null, error)) {
            console.log('‚ùå –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ (CORS/—Å–µ—Ç—å)');
            return false;
        } else {
            console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error.message);
            return false;
        }
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ–∫—Å–∏
function getNextProxy() {
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—á–∏–µ –ø—Ä–æ–∫—Å–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö —Å —É–º–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π
    if (PROXY_CONFIG.workingProxies.length > 0) {
        const proxy = PROXY_CONFIG.workingProxies[PROXY_CONFIG.currentProxyIndex % PROXY_CONFIG.workingProxies.length];
        PROXY_CONFIG.currentProxyIndex = (PROXY_CONFIG.currentProxyIndex + 1) % PROXY_CONFIG.workingProxies.length;
        
        // –õ–æ–≥–∏—Ä—É–µ–º –≤—ã–±–æ—Ä –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        console.log(`üîÑ –í—ã–±—Ä–∞–Ω —Ä–∞–±–æ—á–∏–π –ø—Ä–æ–∫—Å–∏: ${proxy} (${PROXY_CONFIG.currentProxyIndex}/${PROXY_CONFIG.workingProxies.length})`);
        return proxy;
    }
    
    // Fallback –Ω–∞ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π —Ä–æ—Ç–∞—Ü–∏–µ–π
    const availableProxies = PROXY_CONFIG.proxies.filter((_, index) => !FAILED_PROXIES.has(index));
    if (availableProxies.length === 0) {
        console.warn('‚ö†Ô∏è –í—Å–µ –ø—Ä–æ–∫—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π');
        FAILED_PROXIES.clear();
        return PROXY_CONFIG.proxies[0];
    }
    
    // –£–º–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è: –≤—ã–±–∏—Ä–∞–µ–º –ø—Ä–æ–∫—Å–∏ —Å —É—á–µ—Ç–æ–º –∏—Ö –∏–Ω–¥–µ–∫—Å–∞ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º —Å–ø–∏—Å–∫–µ
    const proxy = availableProxies[PROXY_CONFIG.currentProxyIndex % availableProxies.length];
    PROXY_CONFIG.currentProxyIndex = (PROXY_CONFIG.currentProxyIndex + 1) % availableProxies.length;
    
    console.log(`üîÑ Fallback –ø—Ä–æ–∫—Å–∏: ${proxy} (${PROXY_CONFIG.currentProxyIndex}/${availableProxies.length})`);
    return proxy;
}

function markProxyAsFailed(proxyUrl) {
    const index = PROXY_CONFIG.proxies.indexOf(proxyUrl);
    if (index !== -1) {
        FAILED_PROXIES.add(index);
        PROXY_STATS.failedRequests++;
        console.warn(`‚ùå –ü—Ä–æ–∫—Å–∏ ${proxyUrl} –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–π`);
        
        // –£–¥–∞–ª—è–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏
        const workingIndex = PROXY_CONFIG.workingProxies.indexOf(proxyUrl);
        if (workingIndex !== -1) {
            PROXY_CONFIG.workingProxies.splice(workingIndex, 1);
            console.log(`üóëÔ∏è –ü—Ä–æ–∫—Å–∏ —É–¥–∞–ª–µ–Ω –∏–∑ —Å–ø–∏—Å–∫–∞ —Ä–∞–±–æ—á–∏—Ö: ${proxyUrl}`);
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∫—Å–∏
function updateProxyStats(proxyUrl, success = true) {
    PROXY_STATS.totalRequests++;
    if (success) {
        PROXY_STATS.successfulRequests++;
    } else {
        PROXY_STATS.failedRequests++;
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–∫—Å–∏
    const currentCount = PROXY_STATS.proxyUsage.get(proxyUrl) || 0;
    PROXY_STATS.proxyUsage.set(proxyUrl, currentCount + 1);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø—Ä–æ–∫—Å–∏
function getProxyStats() {
    const successRate = PROXY_STATS.totalRequests > 0 
        ? (PROXY_STATS.successfulRequests / PROXY_STATS.totalRequests * 100).toFixed(2)
        : 0;
    
    return {
        totalRequests: PROXY_STATS.totalRequests,
        successfulRequests: PROXY_STATS.successfulRequests,
        failedRequests: PROXY_STATS.failedRequests,
        successRate: `${successRate}%`,
        workingProxies: PROXY_CONFIG.workingProxies.length,
        totalProxies: PROXY_CONFIG.proxies.length,
        proxyUsage: Object.fromEntries(PROXY_STATS.proxyUsage)
    };
}

function buildProxyUrl(originalUrl, proxyUrl) {
    if (!proxyUrl) return originalUrl;
    
    // –†–∞–∑–Ω—ã–µ –ø—Ä–æ–∫—Å–∏ —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ URL
    if (proxyUrl.includes('allorigins.win/raw')) {
        return `${proxyUrl}${encodeURIComponent(originalUrl)}`;
    } else if (proxyUrl.includes('allorigins.win/get')) {
        return `${proxyUrl}${encodeURIComponent(originalUrl)}`;
    } else if (proxyUrl.includes('codetabs.com')) {
        return `${proxyUrl}${encodeURIComponent(originalUrl)}`;
    } else if (proxyUrl.includes('thingproxy.freeboard.io')) {
        return `${proxyUrl}${originalUrl}`;
    } else if (proxyUrl.includes('corsproxy.io')) {
        return `${proxyUrl}${originalUrl}`;
    } else if (proxyUrl.includes('yacdn.org')) {
        return `${proxyUrl}${originalUrl}`;
    } else if (proxyUrl.includes('cors.bridged.cc')) {
        return `${proxyUrl}${originalUrl}`;
    } else {
        return `${proxyUrl}${originalUrl}`;
    }
}

async function fetchWithProxy(url, options = {}, retryCount = 0) {
    // –ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
    if (!S.proxyEnabled) {
        console.log('üö´ –ü—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å');
        return await fetch(url, options);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏
    const now = Date.now();
    if (now - PROXY_CONFIG.lastProxyTest > PROXY_CONFIG.proxyTestInterval) {
        console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏...');
        checkAllProxies(false).catch(error => {
            console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ–∫—Å–∏:', error);
        });
    }
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã)
    if (lastBlockedTime > 0 && now - lastBlockedTime > 120000 && now - lastBlockedTime < 300000) {
        console.log('üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä—è–º–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...');
        const directAvailable = await testDirectConnection();
        if (directAvailable) {
            console.log('‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã');
            return await fetch(url, options);
        }
    }
    
    // –ï—Å–ª–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å
    if (retryCount >= PROXY_CONFIG.maxRetries) {
        console.log('–ü—Ä–µ–≤—ã—à–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å:', url);
        // updateApiStatus('error', '–ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ', 'red');
        return await fetch(url, options);
    }

    // –ï—Å–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω –ø—Ä–æ–∫—Å–∏ –∏–ª–∏ IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, —Å—Ä–∞–∑—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏
    if (shouldUseProxy()) {
        console.log('üîÑ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ (IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω)');
    } else if (retryCount === 0) {
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∏ IP –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω, –ø—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å
        try {
            console.log('–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä—è–º–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞:', url);
            const directResponse = await fetch(url, options);
            
            // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            if (directResponse.ok) {
                console.log('‚úì –ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω');
                resetApiKeyOnSuccess(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º API –∫–ª—é—á –Ω–∞ –ø–µ—Ä–≤—ã–π –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                // updateApiStatus('working', '–ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ', 'green', false);
                return directResponse;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ API
            if (isApiBlocked(directResponse)) {
                if (directResponse.status === 401) {
                    console.warn(`üö´ –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401) - –≤–æ–∑–º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ API –∫–ª—é—á–∞, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–æ–∫—Å–∏`);
                } else {
                    console.warn(`–ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (${directResponse.status}), –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–æ–∫—Å–∏`);
                }
                lastBlockedTime = Date.now();
                BLOCKED_IP_CACHE.add(url);
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–æ–∫—Å–∏
                return await fetchWithProxy(url, options, retryCount + 1);
            } else {
                // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ (404, 500 –∏ —Ç.–¥.) –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç –∫–∞–∫ –µ—Å—Ç—å
                console.log(`–ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª ${directResponse.status}, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ç–≤–µ—Ç`);
                return directResponse;
            }
        } catch (error) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π
            if (isApiBlocked(null, error)) {
                console.warn('–ü—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω (CORS/—Å–µ—Ç—å), –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø—Ä–æ–∫—Å–∏:', error.message);
                lastBlockedTime = Date.now();
                BLOCKED_IP_CACHE.add(url);
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–æ–∫—Å–∏
                return await fetchWithProxy(url, options, retryCount + 1);
            } else {
                // –î–ª—è –¥—Ä—É–≥–∏—Ö –æ—à–∏–±–æ–∫ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Ö –¥–∞–ª—å—à–µ
                throw error;
            }
        }
    }

    // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞, –∑–Ω–∞—á–∏—Ç –Ω—É–∂–µ–Ω –ø—Ä–æ–∫—Å–∏
    const proxy = getNextProxy();
    if (!proxy) {
        console.log('–ü—Ä–æ–∫—Å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –∑–∞–ø—Ä–æ—Å:', url);
        return await fetch(url, options);
    }

    const proxyUrl = buildProxyUrl(url, proxy);
    console.log(`–ü–æ–ø—ã—Ç–∫–∞ ${retryCount + 1}: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ ${proxy} –¥–ª—è ${url}`);

    try {
        const response = await fetch(proxyUrl, {
            ...options,
            // –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–∫—Å–∏ —Ç—Ä–µ–±—É—é—Ç –æ—Å–æ–±—ã—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
            headers: {
                ...options.headers,
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        // –ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ –≤–µ—Ä–Ω—É–ª –æ–±–µ—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, allorigins.win/get)
        if (proxy.includes('allorigins.win/get')) {
            const data = await response.json();
            if (data.contents) {
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π Response —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
                return new Response(data.contents, {
                    status: response.status,
                    statusText: response.statusText,
                    headers: response.headers
                });
            }
        }

        console.log('‚úì –ü—Ä–æ–∫—Å–∏ –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω');
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        updateProxyStats(proxy, true);
        console.log(`‚úÖ –£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏: ${proxy}`);
        // updateApiStatus('working', '–ß–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏', 'blue', false);
        return response;
    } catch (error) {
        console.warn(`‚ùå –û—à–∏–±–∫–∞ —Å –ø—Ä–æ–∫—Å–∏ ${proxy}:`, error.message);
        updateProxyStats(proxy, false);
        markProxyAsFailed(proxy);
        
        // –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –≤—ã–∑–æ–≤ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º —Å—á–µ—Ç—á–∏–∫–∞ –ø–æ–ø—ã—Ç–æ–∫
        await new Promise(resolve => setTimeout(resolve, PROXY_CONFIG.retryDelay));
        return await fetchWithProxy(url, options, retryCount + 1);
    }
}
const CACHE_NAME = 'lego-catalog-cache-v37';
const COLOR_COLLAPSE_THRESHOLD = 18;
let COLOR_MAP = {},
    PART_MAP = {},
    SET_MAP = {},
    MINIFIG_MAP = {},
    THEME_MAP = {},
    flatCategories = [];

// –ö—ç—à –¥–ª—è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ü–≤–µ—Ç–æ–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤ API
const COLOR_IMAGE_CACHE = new Map();
// Fetch de-duplication and waiters for set images
const SET_IMAGE_FETCHING = new Set();
const SET_IMAGE_PENDING = new Map(); // set_num -> Promise<string|undefined>
const SET_IMAGE_WAITERS = new Map(); // set_num -> HTMLElement[]
const SET_IMAGE_FAILED = new Set(); // set_num, –≥–¥–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ API —É–∂–µ –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å
let API_IMAGE_FETCH_COUNT = 0;
const API_IMAGE_FETCH_LIMIT = 50; // –ø—Ä–µ–¥–æ—Ö—Ä–∞–Ω–∏—Ç–µ–ª—å –Ω–∞ —Å–µ—Å—Å–∏—é –æ—Ç –∏–∑–±—ã—Ç–æ—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
// –£—Å–∫–æ—Ä—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É -> ~50–º—Å
const API_REQUEST_DELAY = 50;
// –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è –ø–æ–¥–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–µ—Ç–∞–ª–µ–π –ø–æ —Ü–≤–µ—Ç–∞–º
const PART_COLOR_FETCHING = new Set(); // key: `${partNum}:${colorId}`
const PART_COLOR_FAILED = new Set();   // key: `${partNum}:${colorId}`
let API_PART_COLOR_FETCH_COUNT = 0;
const API_PART_COLOR_FETCH_LIMIT = 100;
let lastApiRequestTime = 0;
const I_Cat = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`;
const I_Coll = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polygon points="2 17 12 22 22 17"></polygon><polygon points="2 12 12 17 22 12"></polygon></svg>`;
const I_Analytics = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path></svg>`;
const I_Set = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>`;
const I_Plus = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
const I_Minus = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
const I_X = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
const I_Menu = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;
const I_Kebab = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/></svg>`;
const I_Up = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>`;
const I_Play = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>`;
const I_Square = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
const I_Camera = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>`;
const I_Down = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
const I_Img = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`;
const I_Trash = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
const I_Search = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>`;
const I_Chev = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
const I_Dice = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="M16 8h.01"></path><path d="M12 12h.01"></path><path d="M8 16h.01"></path><path d="M8 8h.01"></path><path d="M16 16h.01"></path></svg>`;
const I_Brick = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="10" rx="2" ry="2"></rect><path d="M7 11V7a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v4"></path><path d="M12 11V7"></path></svg>`;
const I_Plate = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="15" width="18" height="6" rx="1"></rect><circle cx="8" cy="18" r="1"></circle><circle cx="16" cy="18" r="1"></circle></svg>`;
const I_Tech = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20.94c1.5 0 2.85-.93 3.53-2.28a3.99 3.99 0 0 0-7.06 0c.68 1.35 2.03 2.28 3.53 2.28z"></path><path d="M12 3.06c-1.5 0-2.85.93-3.53 2.28a3.99 3.99 0 0 0 7.06 0C14.85 3.99 13.5 3.06 12 3.06z"></path><path d="M3.06 12c0-1.5.93-2.85 2.28-3.53a3.99 3.99 0 0 0 0 7.06C3.99 14.85 3.06 13.5 3.06 12z"></path><path d="M20.94 12c0 1.5-.93 2.85-2.28 3.53a3.99 3.99 0 0 0 0-7.06c1.35.68 2.28 2.03 2.28 3.53z"></path><circle cx="12" cy="12" r="1"></circle></svg>`;
const I_Toolbox = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>`;
const I_Edit = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
const I_Eye = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`;
const I_Download = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
const I_Slope = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 20h18L3 4v16z"></path></svg>`;
const I_Cloud = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path></svg>`;
const I_CloudUpload = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path><polyline points="16 16 12 12 8 16"></polyline><line x1="12" y1="12" x2="12" y2="21"></line></svg>`;
const I_CloudDownload = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path><polyline points="8 12 12 16 16 12"></polyline><line x1="12" y1="16" x2="12" y2="7"></line></svg>`;
const I_Globe = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>`;
const I_Link = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>`;
const I_Unlink = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.84 12.25l1.72-1.71h-.02a5.004 5.004 0 0 0-.12-7.07 5.006 5.006 0 0 0-6.95 0l-1.72 1.71"></path><path d="M5.17 11.75l-1.71 1.71a5.004 5.004 0 0 0 .12 7.07 5.006 5.006 0 0 0 6.95 0l1.71-1.71"></path><line x1="8" y1="2" x2="8" y2="5"></line><line x1="2" y1="8" x2="5" y2="8"></line><line x1="16" y1="19" x2="16" y2="22"></line><line x1="19" y1="16" x2="22" y2="16"></line></svg>`;
const I_Scanner = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><rect x="8" y="8" width="8" height="8" rx="1"></rect><path d="M12 12v4"></path><path d="M12 8v4"></path></svg>`;
const I_Logout = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>`;
const I_Info = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`;
const I_ChevronDown = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>`;
const I_ChevronUp = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>`;
const I_ChevronLeft = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`;
const I_ChevronRight = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>`;
const I_Shield = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`;
const I_Clock = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
const I_History = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M12 7v5l4 2"></path></svg>`;
const I_Archive = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="9" y1="9" x2="15" y2="9"></line><line x1="9" y1="13" x2="15" y2="13"></line></svg>`;
const I_FileText = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>`;
const I_Calendar = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>`;
const I_Tile = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
const I_Win = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"></rect><path d="M3 12h18"></path><path d="M12 3v18"></path></svg>`;
const I_Wheel = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="4"></circle></svg>`;
const I_Minifig = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="3"></circle><path d="M12 11v5"></path><path d="M9 22v-5h6v5"></path><path d="M9 11H5a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h4"></path><path d="M15 11h4a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-4"></path></svg>`;
const I_Bar = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12h16"></path><path d="M4 12a2 2 0 1 0-4 0 2 2 0 0 0 4 0z"></path><path d="M20 12a2 2 0 1 0 4 0 2 2 0 0 0-4 0z"></path></svg>`;
const I_Arch = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 21V11c0-3.87 3.13-7 7-7s7 3.13 7 7v10"></path><path d="M5 21h14"></path></svg>`;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤–∞ "—Ü–≤–µ—Ç"
const getColorWord = (count) => {
    if (count === 1) return "–¶–≤–µ—Ç";
    if (count >= 2 && count <= 4) return "–¶–≤–µ—Ç–∞";
    return "–¶–≤–µ—Ç–æ–≤";
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–∫–æ–Ω–∫–∏ –∫—Ä—É–≥–ª–æ–π –¥–µ—Ç–∞–ª–∏ LEGO 1x1
const I_Lego1x1 = (c, colorHex) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
    <circle cx="12" cy="12" r="10" fill="${colorHex}" stroke="currentColor"/>
    <circle cx="12" cy="12" r="3" fill="rgba(255,255,255,0.3)"/>
    <circle cx="12" cy="12" r="1.5" fill="rgba(255,255,255,0.6)"/>
</svg>`;
const I_Other = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>`;
const I_Filter = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>`;
const I_Theme = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0L12 2.69z"></path></svg>`;
const I_Folder = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>`;
// –ò–∫–æ–Ω–∫–∏ –¥–ª—è –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞
const I_Circle = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle></svg>`;
const I_CheckCircle = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"></circle><path d="M8 12l2.5 2.5L16 9"></path></svg>`;
const I_Share = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><path d="M8.59 13.51l6.83 3.98"></path><path d="M15.41 6.51L8.59 10.49"></path></svg>`;
const I_Settings = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`;
const I_Heart = (c, f = !1) => f ? `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
const I_List = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>`;
const I_Star = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26 12,2"></polygon></svg>`;
const I_Refresh = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M3 21v-5h5"></path></svg>`;
const I_Chart = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"></path><circle cx="18" cy="8" r="2"></circle><circle cx="13" cy="13" r="2"></circle><circle cx="10" cy="10" r="2"></circle><circle cx="7" cy="14" r="2"></circle></svg>`;
const I_Users = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`;
const I_Trophy = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17c0 .55-.47.98-.97 1.21l-1 .5A3 3 0 0 1 5 15.5V14.66"></path><path d="M14 14.66V17c0 .55.47.98.97 1.21l1 .5A3 3 0 0 0 19 15.5V14.66"></path><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path></svg>`;
const I_Puzzle = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19.439 13.269l-1.178-4.24a2.01 2.01 0 0 0-1.901-1.245H5.64a2.01 2.01 0 0 0-1.9 1.245l-1.179 4.24a2.01 2.01 0 0 0 1.9 2.563h12.72a2.01 2.01 0 0 0 1.9-2.563z"></path><path d="M8 12h8"></path><path d="M8 8h8"></path><path d="M8 16h8"></path><path d="M12 2v6"></path><path d="M12 18v4"></path></svg>`;
const I_Package = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>`;
const I_Palette = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle><circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></svg>`;
const I_Tags = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>`;
const I_TrendingUp = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>`;
const I_Calculator = (c) => `<svg xmlns="http://www.w3.org/2000/svg" class="${c}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></svg>`;

// –ö–ª–∞—Å—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
class ModalManager {
    constructor() {
        this.openModals = [];
        this.baseZIndex = 200; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π z-index
    }
    
    openModal(modalId, modalElement) {
        console.log(`ModalManager.openModal: Opening ${modalId}`);
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å modal-hidden –∏–ª–∏ viewer-hidden
        modalElement.classList.remove('modal-hidden', 'viewer-hidden');
        
        // –ù–∞—Ö–æ–¥–∏–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π z-index —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        let maxZIndex = this.baseZIndex;
        if (this.openModals.length > 0) {
            maxZIndex = Math.max(...this.openModals.map(modal => modal.zIndex));
        }
        
        // –î–ª—è image viewer —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º z-index –µ—â–µ –≤—ã—à–µ
        let zIndex;
        if (modalId === 'image-viewer-container') {
            zIndex = maxZIndex + 50; // Image viewer –≤—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö –≤—Å–µ—Ö
        } else {
            zIndex = maxZIndex + 10; // –û–±—ã—á–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        }
        
        console.log(`ModalManager.openModal: Setting z-index ${zIndex} for ${modalId} (max was ${maxZIndex})`);
        modalElement.style.zIndex = zIndex.toString();
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        this.openModals.push({ id: modalId, element: modalElement, zIndex });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        requestAnimationFrame(() => {
            modalElement.classList.add('visible');
            
            // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            const modalContent = modalElement.querySelector('[id$="-content"]') || modalElement.querySelector('.modal-content');
            
            if (modalContent) {
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è
                modalContent.classList.add('modal-content-enter');
                
                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                setTimeout(() => {
                    modalContent.classList.remove('modal-content-enter');
                }, 200);
            } else if (modalId === 'image-viewer-container') {
                // –î–ª—è image viewer –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—ã–π CSS transition
                // –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç—Å—è –∫–ª–∞—Å—Å–æ–º .visible
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
            const closeBtn = modalElement.querySelector('.modal-close-btn');
            if (closeBtn) {
                closeBtn.style.opacity = '0';
                closeBtn.style.transform = 'scale(0.8) rotate(-10deg)';
                
                setTimeout(() => {
                    closeBtn.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                    closeBtn.style.opacity = '1';
                    closeBtn.style.transform = 'scale(1) rotate(0deg)';
                }, 200);
            }
        });
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É body
        document.body.classList.add('overflow-hidden');
        
        console.log(`ModalManager.openModal: After opening ${modalId}, current z-indexes:`);
        this.debugZIndexes();
    }
    
    closeModal(modalId) {
        const modalIndex = this.openModals.findIndex(modal => modal.id === modalId);
        if (modalIndex === -1) return;
        
        const modal = this.openModals[modalIndex];
        
        // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
        const modalContent = modal.element.querySelector('[id$="-content"]') || modal.element.querySelector('.modal-content');
        
        if (modalContent) {
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
            modalContent.classList.add('modal-content-leave');
            
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
            setTimeout(() => {
                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ (visible —É–±–∏—Ä–∞–µ—Ç—Å—è –ø–æ–∑–∂–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏)
                
                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
                modalContent.classList.remove('modal-content-leave');
                
                // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª–∞—Å—Å —Å–∫—Ä—ã—Ç–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                if (modalId === 'image-viewer-container') {
                    // –î–ª—è image viewer —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º, –Ω–æ backdrop-filter –∞–Ω–∏–º–∏—Ä—É–µ—Ç—Å—è
                    modal.element.classList.remove('visible');
                    modal.element.style.transition = 'backdrop-filter 0.25s cubic-bezier(0.4, 0, 0.2, 1)';
                    modal.element.style.backdropFilter = 'blur(0px)';
                    
                    // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ backdrop-filter
                    setTimeout(() => {
                        modal.element.classList.add('viewer-hidden');
                        modal.element.style.transition = '';
                        modal.element.style.backdropFilter = '';
                    }, 250);
                } else {
                    // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º, –Ω–æ backdrop-filter –∞–Ω–∏–º–∏—Ä—É–µ—Ç—Å—è
                    modal.element.classList.remove('visible');
                    modal.element.style.transition = 'backdrop-filter 0.25s cubic-bezier(0.4, 0, 0.2, 1)';
                    modal.element.style.backdropFilter = 'blur(0px)';
                    
                    // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ backdrop-filter
                    setTimeout(() => {
                        modal.element.classList.add('modal-hidden');
                        modal.element.style.transition = '';
                        modal.element.style.backdropFilter = '';
                    }, 250);
                }
                
                // –£–±–∏—Ä–∞–µ–º –∏–∑ —Å–ø–∏—Å–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
                this.openModals.splice(modalIndex, 1);
                
                // –£–±–∏—Ä–∞–µ–º overflow-hidden —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –æ—Ç–∫—Ä—ã—Ç—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
                if (this.openModals.length === 0) {
                    document.body.classList.remove('overflow-hidden');
                }
            }, 200); // –í—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
        } else {
            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π backdrop-filter
            modal.element.classList.remove('visible');
            
            if (modalId === 'image-viewer-container') {
                // –î–ª—è image viewer —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º, –Ω–æ backdrop-filter –∞–Ω–∏–º–∏—Ä—É–µ—Ç—Å—è
                modal.element.classList.remove('visible');
                modal.element.style.transition = 'backdrop-filter 0.25s cubic-bezier(0.4, 0, 0.2, 1)';
                modal.element.style.backdropFilter = 'blur(0px)';
                
                // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ backdrop-filter
                setTimeout(() => {
                    modal.element.classList.add('viewer-hidden');
                    modal.element.style.transition = '';
                    modal.element.style.backdropFilter = '';
                }, 250);
            } else {
                // –î–ª—è –æ–±—ã—á–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω —Å—Ä–∞–∑—É —Å–∫—Ä—ã–≤–∞–µ–º, –Ω–æ backdrop-filter –∞–Ω–∏–º–∏—Ä—É–µ—Ç—Å—è
                modal.element.classList.remove('visible');
                modal.element.style.transition = 'backdrop-filter 0.25s cubic-bezier(0.4, 0, 0.2, 1)';
                modal.element.style.backdropFilter = 'blur(0px)';
                
                // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ backdrop-filter
                setTimeout(() => {
                    modal.element.classList.add('modal-hidden');
                    modal.element.style.transition = '';
                    modal.element.style.backdropFilter = '';
                }, 250);
            }
            
            this.openModals.splice(modalIndex, 1);
            
            if (this.openModals.length === 0) {
                document.body.classList.remove('overflow-hidden');
            }
        }
    }
    
    closeLastModal() {
        if (this.openModals.length === 0) return;
        
        const lastModal = this.openModals[this.openModals.length - 1];
        this.closeModal(lastModal.id);
    }
    
    getOpenModalsCount() {
        return this.openModals.length;
    }
    
    getTopModal() {
        if (this.openModals.length === 0) return null;
        return this.openModals[this.openModals.length - 1];
    }
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    closeAllModals() {
        console.log(`ModalManager.closeAllModals: Closing ${this.openModals.length} modals`);
        
        // –°–æ–∑–¥–∞–µ–º –∫–æ–ø–∏—é –º–∞—Å—Å–∏–≤–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏
        const modalsToClose = [...this.openModals];
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
        modalsToClose.forEach((modal, index) => {
            setTimeout(() => {
                this.closeModal(modal.id);
            }, index * 50); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–∫—Ä—ã—Ç–∏–µ–º –∫–∞–∂–¥–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        });
        
        // –£–±–∏—Ä–∞–µ–º overflow-hidden –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
        setTimeout(() => {
            document.body.classList.remove('overflow-hidden');
        }, modalsToClose.length * 50 + 200);
        
        console.log('ModalManager.closeAllModals: All modals closing with animation');
    }
    
    getMaxZIndex() {
        if (this.openModals.length === 0) return this.baseZIndex;
        return Math.max(...this.openModals.map(modal => modal.zIndex));
    }
    
    debugZIndexes() {
        console.log('Current modal z-indexes:');
        this.openModals.forEach(modal => {
            console.log(`  ${modal.id}: ${modal.zIndex}`);
        });
        console.log(`Max z-index: ${this.getMaxZIndex()}`);
    }
    
    // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ—Ç –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö
    bringToFront(modalId) {
        console.log(`ModalManager.bringToFront: Bringing ${modalId} to front`);
        const modalIndex = this.openModals.findIndex(modal => modal.id === modalId);
        if (modalIndex === -1) {
            console.log(`ModalManager.bringToFront: Modal ${modalId} not found in openModals`);
            return;
        }
        
        const modal = this.openModals[modalIndex];
        
        // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π z-index
        const currentMaxZIndex = this.getMaxZIndex();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º z-index –≤—ã—à–µ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
        const newZIndex = currentMaxZIndex + 20;
        modal.zIndex = newZIndex;
        console.log(`ModalManager.bringToFront: Setting z-index ${newZIndex} for ${modalId} (was ${modal.element.style.zIndex})`);
        modal.element.style.zIndex = newZIndex.toString();
        
        // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ –∫–æ–Ω–µ—Ü –º–∞—Å—Å–∏–≤–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–º –æ—Ç–∫—Ä—ã—Ç—ã–º)
        this.openModals.splice(modalIndex, 1);
        this.openModals.push(modal);
        
        console.log(`ModalManager.bringToFront: After bringing ${modalId} to front:`);
        this.debugZIndexes();
    }
}

// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä ModalManager
const modalManager = new ModalManager();

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±–ª–∞—á–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
let cloudStorageClient = null;
let cloudStorageConnected = false;
let remoteStorageWidget = null;
let disableAutoLoad = false; // –§–ª–∞–≥ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
let isReconnecting = false; // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π

// –ö–ª—é—á–∏ –¥–ª—è localStorage
const REMOTESTORAGE_KEYS = {
    CONNECTION_STATE: 'remotestorage_connection_state',
    USER_ACCOUNT: 'remotestorage_user_account',
    CACHED_DATA: 'remotestorage_cached_data'
};

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
let inactivityOverlay = null;
let inactivityTip = null;
let inactivityCloseBtn = null;
let inactivityTimer = null;
let tipRotationTimer = null;

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å localStorage
function saveRemoteStorageState(connected, account = null) {
    const state = {
        connected: connected,
        account: account,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem(REMOTESTORAGE_KEYS.CONNECTION_STATE, JSON.stringify(state));
    console.log('üíæ RemoteStorage state saved:', state);
}

function loadRemoteStorageState() {
    try {
        const state = localStorage.getItem(REMOTESTORAGE_KEYS.CONNECTION_STATE);
        if (state) {
            const parsed = JSON.parse(state);
            console.log('üìÇ RemoteStorage state loaded:', parsed);
            return parsed;
        }
    } catch (error) {
        console.error('‚ùå Failed to load RemoteStorage state:', error);
    }
    return null;
}

function saveUserAccount(account) {
    localStorage.setItem(REMOTESTORAGE_KEYS.USER_ACCOUNT, account);
    console.log('üë§ User account saved:', account);
}

function loadUserAccount() {
    return localStorage.getItem(REMOTESTORAGE_KEYS.USER_ACCOUNT);
}

async function saveCachedData(data) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–ª—é—á–∏ localStorage (–∫–∞–∫ CSV –∏–º–ø–æ—Ä—Ç)
    if (data.collection) {
        if (data.collection.parts) {
            localStorage.setItem('legoCollection', JSON.stringify(data.collection.parts));
            console.log('üíæ Parts saved to localStorage:', Object.keys(data.collection.parts).length);
        }
        
        if (data.collection.sets) {
            localStorage.setItem('legoSetCollection', JSON.stringify(data.collection.sets));
            console.log('üíæ Sets saved to localStorage:', Object.keys(data.collection.sets).length);
        }
        
        if (data.collection.minifigs) {
            localStorage.setItem('legoMinifigCollection', JSON.stringify(data.collection.minifigs));
            console.log('üíæ Minifigs saved to localStorage:', Object.keys(data.collection.minifigs).length);
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–µ–º—ã
    if (data.favorites) {
        if (data.favorites.categories) {
            localStorage.setItem('favoriteCategoryIds', JSON.stringify(data.favorites.categories));
            console.log('üíæ Favorite categories saved to localStorage:', data.favorites.categories.length);
        }
        
        if (data.favorites.themes) {
            localStorage.setItem('favoriteThemeIds', JSON.stringify(data.favorites.themes));
            console.log('üíæ Favorite themes saved to localStorage:', data.favorites.themes.length);
        }
    }
    
    // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    const cacheData = {
        data: data,
        timestamp: new Date().toISOString()
    };
    localStorage.setItem(REMOTESTORAGE_KEYS.CACHED_DATA, JSON.stringify(cacheData));
    console.log('üíæ Data cached locally:', cacheData.timestamp);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
    await updateCloudBackupInfo();
}

function loadCachedData() {
    try {
        const cached = localStorage.getItem(REMOTESTORAGE_KEYS.CACHED_DATA);
        if (cached) {
            const parsed = JSON.parse(cached);
            console.log('üìÇ Cached data loaded:', parsed.timestamp);
            return parsed.data;
        }
    } catch (error) {
        console.error('‚ùå Failed to load cached data:', error);
    }
    return null;
}



function clearRemoteStorageCache() {
    localStorage.removeItem(REMOTESTORAGE_KEYS.CONNECTION_STATE);
    localStorage.removeItem(REMOTESTORAGE_KEYS.USER_ACCOUNT);
    localStorage.removeItem(REMOTESTORAGE_KEYS.CACHED_DATA);
    console.log('üóëÔ∏è RemoteStorage cache cleared');
}

function clearCollectionCache() {
    // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—ç—à –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –Ω–µ —Ç—Ä–æ–≥–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
    localStorage.removeItem(REMOTESTORAGE_KEYS.CACHED_DATA);
    console.log('üóëÔ∏è Collection cache cleared');
}

function getCacheInfo() {
    const state = loadRemoteStorageState();
    const account = loadUserAccount();
    const cached = loadCachedData();
    
    return {
        connected: state ? state.connected : false,
        account: account,
        hasCachedData: !!cached
    };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–∫–∞–∫ –≤ —Å–≤–æ–¥–∫–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏)
function getCollectionCounts() {
    const totalParts = Object.values(S.coll).reduce((sum, part) => sum + Object.values(part).reduce((partSum, qty) => partSum + qty, 0), 0);
    const uniqueParts = Object.keys(S.coll).reduce((sum, partId) => sum + Object.keys(S.coll[partId]).length, 0);
    const totalSets = Object.values(S.setColl).reduce((sum, set) => sum + set.qty, 0);
    const uniqueSets = Object.keys(S.setColl).length;
    const totalMinifigs = Object.values(S.minifigColl).reduce((sum, minifig) => sum + minifig.qty, 0);
    const uniqueMinifigs = Object.keys(S.minifigColl).length;
    
    return {
        totalParts,
        uniqueParts,
        totalSets,
        uniqueSets,
        totalMinifigs,
        uniqueMinifigs
    };
}

function updateCloudStorageStatus(message, type = 'info') {
    const statusElement = document.getElementById('cloud-backup-status');
    if (!statusElement) return;
    
    // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    if (window.cloudStatusTimer) {
        clearTimeout(window.cloudStatusTimer);
    }
    
    // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    const baseClasses = 'px-2 py-1.5 sm:px-3 sm:py-2 text-xs sm:text-sm rounded-[18px] border break-words leading-tight';
    let statusClasses = '';
    let statusText = message;
    
    // –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç –µ—â–µ –º–µ–Ω—å—à–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
    if (message.includes('–¥–µ—Ç–∞–ª–µ–π') || message.includes('–Ω–∞–±–æ—Ä–æ–≤') || message.includes('–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫')) {
        const mobileOptimizedClasses = 'px-1.5 py-1 sm:px-3 sm:py-2 text-xs sm:text-sm rounded-[18px] border break-words leading-tight';
        switch (type) {
            case 'success':
                statusClasses = `${mobileOptimizedClasses} bg-green-900/50 text-green-200 border-green-600/50`;
                break;
            case 'error':
                statusClasses = `${mobileOptimizedClasses} bg-red-900/50 text-red-200 border-red-600/50`;
                break;
            case 'info':
                statusClasses = `${mobileOptimizedClasses} bg-blue-900/50 text-blue-200 border-blue-600/50`;
                break;
            default:
                statusClasses = `${mobileOptimizedClasses} bg-gray-700/50 text-gray-300 border-gray-600/50`;
        }
    } else {
        switch (type) {
            case 'success':
                statusClasses = `${baseClasses} bg-green-900/50 text-green-200 border-green-600/50`;
                break;
            case 'error':
                statusClasses = `${baseClasses} bg-red-900/50 text-red-200 border-red-600/50`;
                break;
            case 'info':
                statusClasses = `${baseClasses} bg-blue-900/50 text-blue-200 border-blue-600/50`;
                break;
            default:
                statusClasses = `${baseClasses} bg-gray-700/50 text-gray-300 border-gray-600/50`;
        }
    }
    
    statusElement.className = statusClasses;
    statusElement.textContent = statusText;
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    window.cloudStatusTimer = setTimeout(() => {
        // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        const savedState = localStorage.getItem(REMOTESTORAGE_KEYS.CONNECTION_STATE);
        const savedAccount = localStorage.getItem(REMOTESTORAGE_KEYS.USER_ACCOUNT);
        
        if (savedState && savedAccount) {
            try {
                const state = JSON.parse(savedState);
                if (state.connected) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    statusElement.textContent = `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${savedAccount}`;
                    statusElement.className = 'text-xs sm:text-sm text-gray-400 break-words leading-tight';
                } else {
                    statusElement.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    statusElement.className = 'text-xs sm:text-sm text-gray-400 break-words leading-tight';
                }
            } catch (e) {
                statusElement.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
                statusElement.className = 'text-xs sm:text-sm text-gray-400 break-words leading-tight';
            }
        } else {
            statusElement.textContent = '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
            statusElement.className = 'text-xs sm:text-sm text-gray-400 break-words leading-tight';
        }
    }, 3000);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    const reconnectContainer = document.getElementById('reconnect-container');
    if (reconnectContainer) {
        if (message.includes('–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏—Å—Ç–µ–∫–ª–∞') || message.includes('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏—Å—Ç–µ–∫–ª–∞')) {
            reconnectContainer.classList.remove('hidden');
        } else {
            reconnectContainer.classList.add('hidden');
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É
function getCloudStorageConnectionState() {
    const savedState = loadRemoteStorageState();
    const savedAccount = loadUserAccount();
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const hasSavedAccount = !!(savedAccount && savedAccount.trim() !== '');
    const hasSavedConnection = !!(savedState && savedState.connected);
    const isCurrentlyConnected = cloudStorageConnected;
    const isCurrentlyReconnecting = isReconnecting;
    
    // –õ–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
    let isConnected = false;
    let needsReconnection = false;
    let showConnectButton = false;
    let showReconnectButton = false;
    let showMainActions = false;
    let showVersionsBlock = false;
    let showLogoutButton = false;
    
    if (isCurrentlyConnected) {
        // –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ê–∫—Ç–∏–≤–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω
        isConnected = true;
        showMainActions = true;
        showVersionsBlock = true;
        showLogoutButton = true;
    } else if (hasSavedAccount && hasSavedConnection && !isCurrentlyReconnecting) {
        // –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ï—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç, –Ω–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
        needsReconnection = true;
        showReconnectButton = true;
    } else {
        // –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞
        showConnectButton = true;
    }
    
    return {
        isConnected: isConnected,
        account: savedAccount,
        hasSavedState: hasSavedAccount,
        needsReconnection: needsReconnection,
        showConnectButton: showConnectButton,
        showReconnectButton: showReconnectButton,
        showMainActions: showMainActions,
        showVersionsBlock: showVersionsBlock,
        showLogoutButton: showLogoutButton
    };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
function updateCloudStorageUI() {
    // –û–±–Ω–æ–≤–ª—è–µ–º UI —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    if (S.view === 'tools' && S.toolSubView === 'cloud-backup') {
        const mainContent = document.getElementById('main-content');
        if (mainContent) {
            mainContent.innerHTML = renderCloudBackupContent();
            addBackupButtonsHandlers();
        }
    }
    
    // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –µ—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    updateCloudStorageStatusDisplay();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
function updateCloudStorageStatusDisplay() {
    const statusElement = document.getElementById('cloud-backup-status');
    if (statusElement) {
        const connectionState = getCloudStorageConnectionState();
        const cacheInfo = getCacheInfo();
        
        statusElement.textContent = connectionState.isConnected ? 
            `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${connectionState.account || cacheInfo.account || '–ê–∫–∫–∞—É–Ω—Ç'}` : 
            connectionState.needsReconnection ? 
                `–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${connectionState.account}` : 
                '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
function renderCloudBackupContent() {
    const cacheInfo = getCacheInfo();
    const connectionState = getCloudStorageConnectionState();
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ, –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
    if (connectionState.isConnected) {
        debouncedLoadBackupsList(true, 100); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ
    }
    
    return `
        <div class="min-h-full p-4 sm:p-6 lg:p-8">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="text-center mb-6 sm:mb-8">
                <h2 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-200 mb-2 sm:mb-3">–†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –æ–±–ª–∞–∫–æ</h2>
                <p class="text-gray-400 text-sm sm:text-base lg:text-lg max-w-2xl mx-auto px-4">
                    –°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∏ –∑–∞–≥—Ä—É–∂–∞–π—Ç–µ –≤–∞—à—É –∫–æ–ª–ª–µ–∫—Ü–∏—é LEGO –≤ –æ–±–ª–∞—á–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ —Å –ª—é–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                </p>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="max-w-4xl mx-auto space-y-6">
                <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
                <div class="bg-gradient-to-r from-gray-800/60 to-gray-900/60 rounded-[18px] border border-gray-600/40 p-3 sm:p-5 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="p-1.5 sm:p-2 bg-cyan-500/20 rounded-[18px] mr-3 sm:mr-4 flex-shrink-0">
                                <span class="text-cyan-400">${I_Cloud('w-5 h-5 sm:w-6 sm:h-6')}</span>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-sm sm:text-base font-bold text-gray-200 mb-1">–°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                                <p id="cloud-backup-status" class="text-xs sm:text-sm text-gray-400 break-words leading-tight">
                                    ${connectionState.isConnected ? 
                                        `–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${connectionState.account || cacheInfo.account || '–ê–∫–∫–∞—É–Ω—Ç'}` : 
                                        connectionState.needsReconnection ? 
                                            `–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ: ${connectionState.account}` : 
                                            '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ'
                                    }
                                </p>
                            </div>
                        </div>
                        ${connectionState.showLogoutButton ? `
                            <button id="logout-cloud-storage" class="flex items-center px-2 py-1.5 sm:px-4 sm:py-2.5 text-xs sm:text-sm font-semibold rounded-[18px] transition-all duration-200 bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 text-white shadow-lg hover:shadow-orange-500/25 transform hover:scale-105 flex-shrink-0 ml-2">
                                <span class="mr-1 sm:mr-2">${I_Logout('w-4 h-4')}</span>
                                <span class="hidden sm:inline">–í—ã–π—Ç–∏</span>
                            </button>
                        ` : ''}
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
                    <div id="reconnect-container" class="hidden mt-3 sm:mt-4">
                        <button id="reconnect-cloud-storage" class="w-full flex items-center justify-center px-2 py-1.5 sm:px-4 sm:py-3 text-xs sm:text-sm font-semibold rounded-[18px] transition-all duration-200 bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 text-white shadow-lg hover:shadow-orange-500/25">
                            <span class="mr-1 sm:mr-2">${I_Link('w-4 h-4')}</span>
                            <span class="hidden sm:inline">–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</span>
                        </button>
                    </div>
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
                <div class="${connectionState.showMainActions ? 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2' : 'flex justify-center'} gap-3 sm:gap-4">
                    ${connectionState.showConnectButton ? `
                        <button id="connect-cloud-storage" class="group flex items-center justify-center px-6 py-4 sm:px-8 sm:py-5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white rounded-[18px] transition-all duration-200 shadow-lg hover:shadow-blue-500/25 transform hover:scale-105">
                            <span class="mr-2 sm:mr-3">${I_Link('w-4 h-4 sm:w-5 sm:h-5')}</span>
                            <span class="text-sm sm:text-base font-semibold">–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</span>
                        </button>
                    ` : ''}
                    
                    ${connectionState.showReconnectButton ? `
                        <button id="connect-cloud-storage" class="group flex items-center justify-center px-6 py-4 sm:px-8 sm:py-5 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white rounded-[18px] transition-all duration-200 shadow-lg hover:shadow-blue-500/25 transform hover:scale-105">
                            <span class="mr-2 sm:mr-3">${I_Link('w-4 h-4 sm:w-5 sm:h-5')}</span>
                            <span class="text-sm sm:text-base font-semibold">–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</span>
                        </button>
                    ` : ''}
                    
                    ${connectionState.showMainActions ? `
                        <button id="backup-to-cloud" class="group flex items-center justify-center px-4 py-3 sm:px-5 sm:py-3.5 rounded-[18px] transition-all duration-200 shadow-lg bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 text-white hover:shadow-green-500/25 transform hover:scale-105">
                            <span class="mr-2 sm:mr-3">${I_CloudUpload('w-4 h-4 sm:w-5 sm:h-5')}</span>
                            <span class="text-sm sm:text-base font-semibold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</span>
                        </button>
                        
                        <button id="restore-from-cloud" class="group flex items-center justify-center px-4 py-3 sm:px-5 sm:py-3.5 rounded-[18px] transition-all duration-200 shadow-lg bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 text-white hover:shadow-purple-500/25 transform hover:scale-105">
                            <span class="mr-2 sm:mr-3">${I_CloudDownload('w-4 h-4 sm:w-5 sm:h-5')}</span>
                            <span class="text-sm sm:text-base font-semibold">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</span>
                        </button>
                    ` : ''}
                </div>

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è -->
                <div id="cloud-backup-widget-container" class="hidden"></div>
                
                <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏—è–º–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π -->
                ${connectionState.showVersionsBlock ? `
                    <div class="bg-gradient-to-br from-gray-800/60 to-gray-900/60 rounded-[18px] sm:rounded-[18px] border border-gray-600/40 p-3 sm:p-5 lg:p-6 shadow-xl">
                        <div class="flex items-center justify-between mb-4 sm:mb-6">
                            <div class="flex items-center">
                                <div class="p-1.5 sm:p-2 bg-cyan-500/20 rounded-[18px] mr-3 sm:mr-4">
                                    <span class="text-cyan-400">${I_History('w-5 h-5 sm:w-6 sm:h-6')}</span>
                                </div>
                                <div>
                                    <h3 class="text-base sm:text-lg font-bold text-gray-200 mb-0.5 sm:mb-1">–í–µ—Ä—Å–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π</h3>
                                    <p class="text-xs sm:text-sm text-gray-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –≤–µ—Ä—Å–∏—è–º–∏</p>
                                </div>
                            </div>
                            <button id="refresh-backups" class="flex items-center justify-center px-3 py-2.5 sm:px-4 text-sm font-semibold rounded-[18px] transition-all duration-200 bg-gradient-to-r from-cyan-600 to-cyan-500 hover:from-cyan-500 hover:to-cyan-400 text-white shadow-lg hover:shadow-cyan-500/25 transform hover:scale-105">
                                <span class="flex items-center justify-center mr-0 sm:mr-2">${I_Refresh('w-4 h-4')}</span>
                                <span class="hidden sm:inline">–û–±–Ω–æ–≤–∏—Ç—å</span>
                            </button>
                        </div>
                        
                        <div id="backups-list" class="space-y-2 sm:space-y-3">
                            <div class="text-center text-gray-400 py-6">
                                <div class="inline-flex items-center justify-center w-12 h-12 bg-gray-700/50 rounded-full mb-3">
                                    <span class="text-gray-500">${I_Clock('w-6 h-6')}</span>
                                </div>
                                <p class="text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π...</p>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <!-- –ö–Ω–æ–ø–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ -->
                <div class="flex justify-center">
                    <button id="toggle-instruction" class="group flex items-center px-6 py-3 bg-gradient-to-r from-gray-700/60 to-gray-800/60 rounded-[18px] border border-gray-600/50 hover:border-gray-500/50 transition-all duration-200">
                        <span class="mr-3 text-cyan-400">${I_Info('w-5 h-5')}</span>
                        <span class="text-sm font-semibold text-gray-200 mr-2">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é</span>
                        <span class="text-xs text-cyan-400 group-hover:text-cyan-300 transition-colors">
                            –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
                        </span>
                    </button>
                </div>
                
                <!-- –°–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è -->
                <div id="instruction-content" class="hidden bg-gray-800/50 rounded-[18px] border border-gray-700/50 p-4 sm:p-6">
                    <div class="space-y-4 text-sm text-gray-400">
                        <div class="space-y-3">
                            <p class="font-medium text-gray-300 text-base">1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ 5apps.com:</p>
                            <ul class="ml-4 space-y-2 list-disc">
                                <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ <a href="https://5apps.com" target="_blank" class="text-cyan-400 hover:text-cyan-300 underline">5apps.com</a></li>
                                <li>–ù–∞–∂–º–∏—Ç–µ "Sign up" –∏ —Å–æ–∑–¥–∞–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç</li>
                                <li>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ email –∞–¥—Ä–µ—Å</li>
                                <li>–í–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç</li>
                            </ul>
                        </div>
                        <div class="space-y-3">
                            <p class="font-medium text-gray-300 text-base">2. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–∞–π—Ç—É:</p>
                            <ul class="ml-4 space-y-2 list-disc">
                                <li>–ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ" –≤ —Ä–∞–∑–¥–µ–ª–µ –≤—ã—à–µ</li>
                                <li>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à email —Å 5apps.com (–Ω–∞–ø—Ä–∏–º–µ—Ä: user@5apps.com)</li>
                                <li>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–æ–¥–∫–ª—é—á–∏—Ç—å"</li>
                                <li>–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –æ–∫–Ω–µ</li>
                            </ul>
                        </div>
                        <div class="space-y-3">
                            <p class="font-medium text-gray-300 text-base">3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:</p>
                            <ul class="ml-4 space-y-2 list-disc">
                                <li>–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–∞ –∑–∞–ø–æ–º–Ω–∏—Ç –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç</li>
                                <li>–ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
                                <li>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏—è—Ö –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</li>
                            </ul>
                        </div>
                        <div class="space-y-3">
                            <p class="font-medium text-gray-300 text-base">4. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–º–∏ –∫–æ–ø–∏—è–º–∏:</p>
                            <ul class="ml-4 space-y-2 list-disc">
                                <li><strong>–í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö:</strong> –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –∑–∞–≥—Ä—É–∑–∫–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é</li>
                                <li><strong>–í –æ–±–ª–∞—á–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:</strong> –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–µ—Ä—Å–∏–π</li>
                                <li><strong>–†—É—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</strong> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é</li>
                                <li><strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> –í—Å–µ –¥–∞–Ω–Ω—ã–µ —à–∏—Ñ—Ä—É—é—Ç—Å—è –∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞–¥–µ–∂–Ω–æ</li>
                            </ul>
                        </div>
                        <div class="pt-4 border-t border-gray-700">
                            <div class="flex items-center">
                                <span class="text-green-400 mr-2">${I_CheckCircle('w-4 h-4')}</span>
                                <p class="text-gray-300"><strong>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</strong> –î–æ—Å—Ç—É–ø —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, —Ä—É—á–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏—Å—Ç–æ—Ä–∏—è –≤–µ—Ä—Å–∏–π</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderWishlistContent() {
    // –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π
    const singleWishlistId = 'main-wishlist';
    if (!S.wishlists[singleWishlistId]) {
        S.wishlists[singleWishlistId] = {
            id: singleWishlistId,
            name: '–ú–æ–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π',
            description: '–≠–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —è —Ö–æ—á—É –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏',
            items: [],
            created: new Date().toISOString(),
            modified: new Date().toISOString()
        };
    }
    
    const wishlist = S.wishlists[singleWishlistId];
    const items = wishlist.items || [];
    const itemsCount = items.length;
    
    console.log('üìÅ renderWishlistContent called, single wishlist, itemsCount:', itemsCount);
    
    return `
        <div class="min-h-full p-2 sm:p-4 md:p-6 lg:p-8">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ -->
            <div class="text-center mb-4 sm:mb-6 md:mb-8">
                <h2 class="text-lg sm:text-xl md:text-2xl lg:text-3xl font-bold text-gray-200 mb-1 sm:mb-2 md:mb-3">–°–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π</h2>
                <p class="text-gray-400 text-xs sm:text-sm md:text-base lg:text-lg max-w-2xl mx-auto px-2 sm:px-4">
                    –ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –ø–æ–∫—É–ø–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π
                </p>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="max-w-7xl mx-auto space-y-3 sm:space-y-4 md:space-y-6 px-2 sm:px-4">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–ø–∏—Å–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                <div class="bg-gradient-to-r from-gray-800/60 to-gray-900/60 rounded-[18px] sm:rounded-[18px] border border-gray-600/40 p-3 sm:p-4 md:p-6 shadow-lg">
                    <!-- –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è (—Å—Ç–µ–∫) -->
                    <div class="block sm:hidden space-y-3">
                        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∏–∫–æ–Ω–∫–∞ -->
                        <div class="flex items-start gap-3">
                            <div class="p-2 bg-yellow-500/20 rounded-[18px] flex-shrink-0 mt-0.5">
                                <span class="text-yellow-400">${I_Star('w-4 h-4')}</span>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-base font-bold text-gray-200 mb-1">${wishlist.name}</h3>
                                <p class="text-sm text-gray-400 leading-relaxed">
                                    ${wishlist.description}
                                </p>
                            </div>
                        </div>
                        
                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∫–Ω–æ–ø–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ -->
                        <div class="flex items-center justify-between">
                            <div class="flex flex-col gap-1">
                                <span class="text-sm text-orange-400 font-semibold">
                                    ${itemsCount} ${itemsCount === 1 ? '—ç–ª–µ–º–µ–Ω—Ç' : itemsCount < 5 ? '—ç–ª–µ–º–µ–Ω—Ç–∞' : '—ç–ª–µ–º–µ–Ω—Ç–æ–≤'}
                                </span>
                                <span class="text-xs text-gray-500">
                                    –ò–∑–º–µ–Ω–µ–Ω: ${new Date(wishlist.modified).toLocaleDateString('ru-RU')}
                                </span>
                            </div>
                            <div class="flex gap-2">
                                <button class="import-wishlist flex items-center justify-center px-3 py-2 text-sm font-medium rounded-[18px] transition-all duration-200 bg-emerald-700 hover:bg-emerald-600 text-gray-300 hover:text-white shadow-lg" data-wishlist-id="${singleWishlistId}" title="–ò–º–ø–æ—Ä—Ç –∏–∑ CSV">
                                    <span class="mr-2">${I_Up('w-4 h-4')}</span>
                                    <span>–ò–º–ø–æ—Ä—Ç</span>
                                </button>
                                <button class="export-wishlist flex items-center justify-center px-3 py-2 text-sm font-medium rounded-[18px] transition-all duration-200 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white shadow-lg" data-wishlist-id="${singleWishlistId}" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV">
                                    <span class="mr-2">${I_Download('w-4 h-4')}</span>
                                    <span>–≠–∫—Å–ø–æ—Ä—Ç</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è) -->
                    <div class="hidden sm:flex sm:items-center justify-between gap-4">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="p-2 md:p-3 bg-yellow-500/20 rounded-[18px] mr-4 md:mr-6 flex-shrink-0">
                                <span class="text-yellow-400">${I_Star('w-5 h-5 md:w-6 md:h-6')}</span>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h3 class="text-base md:text-lg lg:text-xl font-bold text-gray-200 mb-1">${wishlist.name}</h3>
                                <p class="text-sm md:text-base text-gray-400 mb-2 lg:mb-0">
                                    ${wishlist.description}
                                </p>
                                <div class="flex flex-wrap items-center gap-2 md:gap-4 text-xs md:text-sm text-gray-500">
                                    <span class="inline-flex items-center gap-1">
                                        <span class="text-orange-400 font-semibold">${itemsCount}</span> 
                                        ${itemsCount === 1 ? '—ç–ª–µ–º–µ–Ω—Ç' : itemsCount < 5 ? '—ç–ª–µ–º–µ–Ω—Ç–∞' : '—ç–ª–µ–º–µ–Ω—Ç–æ–≤'}
                                    </span>
                                    <span class="hidden md:inline">‚Ä¢</span>
                                    <span>–ò–∑–º–µ–Ω–µ–Ω: ${new Date(wishlist.modified).toLocaleDateString('ru-RU')}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button class="import-wishlist flex items-center justify-center px-3 md:px-4 py-2 md:py-3 text-sm md:text-base font-medium rounded-[18px] transition-all duration-200 bg-emerald-700 hover:bg-emerald-600 text-gray-300 hover:text-white shadow-lg hover:shadow-emerald-500/25" data-wishlist-id="${singleWishlistId}" title="–ò–º–ø–æ—Ä—Ç –∏–∑ CSV">
                                <span class="mr-2">${I_Up('w-4 h-4 md:w-5 md:h-5')}</span>
                                <span>–ò–º–ø–æ—Ä—Ç</span>
                            </button>
                            <button class="export-wishlist flex items-center justify-center px-3 md:px-4 py-2 md:py-3 text-sm md:text-base font-medium rounded-[18px] transition-all duration-200 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white shadow-lg hover:shadow-gray-500/25" data-wishlist-id="${singleWishlistId}" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ CSV">
                                <span class="mr-2">${I_Download('w-4 h-4 md:w-5 md:h-5')}</span>
                                <span>–≠–∫—Å–ø–æ—Ä—Ç</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –°–µ—Ç–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ -->
                <div class="bg-gradient-to-br from-gray-800/40 to-gray-900/40 rounded-[18px] sm:rounded-[18px] border border-gray-600/30 p-3 sm:p-4 md:p-6 shadow-lg">
                    ${itemsCount === 0 ? `
                        <div class="wishlist-drop-zone wishlist-empty-state text-center py-12 sm:py-16 md:py-20" data-wishlist-id="${singleWishlistId}">
                            <div class="inline-flex items-center justify-center w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 bg-gradient-to-br from-yellow-500/20 to-orange-500/20 rounded-full mb-4 sm:mb-6">
                                <span class="text-yellow-400">${I_Star('w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12')}</span>
                            </div>
                            <h3 class="text-base sm:text-lg md:text-xl font-semibold text-gray-200 mb-2 sm:mb-3">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</h3>
                            <p class="text-gray-400 mb-6 sm:mb-8 text-sm sm:text-base md:text-lg max-w-lg mx-auto leading-relaxed">
                                –î–æ–±–∞–≤—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π"
                            </p>
                            <p class="text-gray-500 mb-4 text-xs sm:text-sm">
                                üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            </p>
                        </div>
                    ` : `
                        <div class="mb-4 sm:mb-6">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-3 sm:mb-4">
                                <h4 class="text-base sm:text-lg font-semibold text-gray-200">–≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø–∏—Å–∫–∞</h4>
                                <div class="flex items-center gap-2 flex-wrap justify-center sm:justify-end">
                                    <button id="select-all-wishlist" class="flex items-center gap-2 bg-blue-600/80 hover:bg-blue-700/90 text-white text-sm font-semibold px-4 py-2 rounded-full transition-all duration-150 shadow-lg hover:shadow-blue-500/25 backdrop-blur-sm" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã">
                                        + –í—Å–µ
                                    </button>
                                    <button id="deselect-all-wishlist" class="flex items-center gap-2 bg-gray-700/80 hover:bg-gray-600/90 text-white text-sm font-semibold px-4 py-2 rounded-full transition-all duration-150 shadow-lg hover:shadow-gray-500/25 backdrop-blur-sm hidden" title="–°–Ω—è—Ç—å –≤—ã–±–æ—Ä —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤">
                                        –°–Ω—è—Ç—å –≤—ã–±–æ—Ä
                                    </button>
                                    <button id="export-selected-wishlist" class="flex items-center gap-2 bg-indigo-600/80 hover:bg-indigo-700/90 text-white text-sm font-semibold px-4 py-2 rounded-full transition-all duration-150 shadow-lg hover:shadow-indigo-500/25 backdrop-blur-sm hidden" title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ CSV">
                                        ${I_Download('w-5 h-5')} <span class="hidden sm:inline">–≠–∫—Å–ø–æ—Ä—Ç</span>
                                    </button>
                                    <button id="share-selected-wishlist" class="flex items-center gap-2 bg-gray-700/80 hover:bg-gray-600/90 text-white text-sm font-semibold px-4 py-2 rounded-full transition-all duration-150 shadow-lg hover:shadow-gray-500/25 backdrop-blur-sm hidden" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —á–µ—Ä–µ–∑ CSV —Ñ–∞–π–ª –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                                        ${I_Share('w-5 h-5')} <span class="hidden sm:inline">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="wishlist-drop-zone grid grid-cols-2 sm:grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-2 sm:gap-4 p-2 sm:p-4 min-h-[200px]" data-wishlist-id="${singleWishlistId}">
                            ${items.map(item => renderWishlistItemCard(item, singleWishlistId)).join('')}
                        </div>
                    `}
                </div>
            </div>
        </div>
    `;
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–∫–∞–Ω–µ—Ä–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
function renderScannerContent() {
    return `
        <div class="min-h-full p-3 sm:p-4 md:p-6 lg:p-8">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="text-center mb-6 sm:mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">–°–∫–∞–Ω–µ—Ä –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫</h1>
                <p class="text-gray-400 text-sm sm:text-base">–î–ª—è –ø–æ–∏—Å–∫–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ DataMatrix –∫–æ–¥ –Ω–∞ –∫–æ—Ä–æ–±–∫–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏</p>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="max-w-7xl mx-auto space-y-4 sm:space-y-6">

                <!-- –û–±–ª–∞—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div class="bg-gradient-to-br from-gray-800/40 to-gray-900/40 rounded-[18px] border border-gray-600/30 p-6 sm:p-8 md:p-10 lg:p-12 shadow-xl">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 bg-green-600/20 rounded-[18px]">
                            ${I_Scanner('w-5 h-5 text-green-400')}
                        </div>
                        <h3 class="text-lg font-semibold text-gray-200">–û–±–ª–∞—Å—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                    </div>
                    <div class="relative flex justify-center">
                        <div class="relative">
                            <video id="scanner-video" class="w-64 h-64 sm:w-80 sm:h-80 rounded-[18px] bg-gray-900 hidden object-cover shadow-lg" autoplay muted playsinline webkit-playsinline></video>
                            <canvas id="scanner-canvas" class="w-64 h-64 sm:w-80 sm:h-80 rounded-[18px] bg-gray-900 hidden shadow-lg"></canvas>
                            <div id="scanner-placeholder" class="w-64 h-64 sm:w-80 sm:h-80 aspect-square bg-gray-900 rounded-[18px] flex items-center justify-center border-2 border-dashed border-gray-600 shadow-lg">
                                <div class="text-center text-gray-400 px-4">
                                    <div class="text-4xl sm:text-5xl mb-3">${I_Scanner('w-12 h-12 mx-auto')}</div>
                                    <p class="text-sm sm:text-base font-medium mb-2">–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞</p>
                                    <p class="text-xs sm:text-sm">1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É –∏–∑ —Å–ø–∏—Å–∫–∞ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–∞–º–µ—Ä—ã</p>
                                    <p class="text-xs sm:text-sm">2. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É"</p>
                                </div>
                            </div>
                            <div id="scanner-overlay" class="absolute inset-0 pointer-events-none hidden">
                                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 sm:w-80 sm:h-80">
                                    <!-- –ó–µ–ª–µ–Ω–∞—è —Ä–∞–º–∫–∞ —Å –æ—Ç—Å—Ç—É–ø–æ–º –≤–Ω—É—Ç—Ä—å -->
                                    <div class="absolute inset-6 border-2 border-green-400 rounded-[18px] transition-all duration-300">
                                        <!-- –£–≥–ª–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã -->
                                        <div class="absolute top-16 left-16 w-6 h-6 border-t-2 border-l-2 border-green-400"></div>
                                        <div class="absolute top-16 right-16 w-6 h-6 border-t-2 border-r-2 border-green-400"></div>
                                        <div class="absolute bottom-16 left-16 w-6 h-6 border-b-2 border-l-2 border-green-400"></div>
                                        <div class="absolute bottom-16 right-16 w-6 h-6 border-b-2 border-r-2 border-green-400"></div>
                                    </div>
                                    
                                    <!-- –°—Ç–∞—Ç—É—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                                    <div id="scan-status" class="absolute top-4 left-1/2 transform -translate-x-1/2 px-3 py-1 bg-green-600 text-white text-xs rounded-full font-medium hidden">
                                        –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
                <div class="bg-gradient-to-br from-gray-800/40 to-gray-900/40 rounded-[18px] border border-gray-600/30 p-4 sm:p-6 shadow-xl">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-blue-600/20 rounded-[18px]">
                                ${I_Search('w-5 h-5 text-blue-400')}
                            </div>
                            <h3 class="text-lg font-semibold text-gray-200">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                        </div>
                        <button id="clear-scan-results" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-sm rounded-[18px] transition-colors">
                            –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                    <div id="scan-results" class="space-y-3">
                        <div class="text-center text-gray-400 py-8">
                            <div class="text-4xl mb-3">${I_Search('w-12 h-12 mx-auto')}</div>
                            <p class="text-sm sm:text-base">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                        </div>
                    </div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã -->
                <div class="bg-gradient-to-r from-gray-800/60 to-gray-900/60 rounded-[18px] border border-gray-600/40 hover:shadow-blue-500/20 hover:shadow-2xl transition-all duration-300">
                    <details class="group" style="box-shadow: none !important;">
                        <summary class="flex items-center justify-between p-4 sm:p-6 cursor-pointer rounded-t-xl" style="box-shadow: none !important;">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-600/20 rounded-[18px]">
                                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-200">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã</h3>
                            </div>
                            <span class="text-gray-400 group-open:rotate-180 transition-transform">${I_ChevronDown('w-5 h-5')}</span>
                        </summary>
                        <div class="px-4 sm:px-6 pb-4 sm:pb-6 space-y-6">
                            <div>
                                <h3 class="text-md font-semibold text-white mb-2">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã</h3>
                                <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                                    <p class="text-xs text-gray-400">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–∞–º–µ—Ä—É –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è DataMatrix –∫–æ–¥–æ–≤</p>
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                                        <div>
                                            <label for="camera-select" class="block text-sm font-medium text-gray-300 mb-2">–ö–∞–º–µ—Ä–∞</label>
                                            <select id="camera-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-[18px] text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="resolution-select" class="block text-sm font-medium text-gray-300 mb-2">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ</label>
                                            <select id="resolution-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-[18px] text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                                <option value="640x640">640x640 (–ö–≤–∞–¥—Ä–∞—Ç)</option>
                                                <option value="800x800">800x800 (–ö–≤–∞–¥—Ä–∞—Ç HD)</option>
                                                <option value="1024x1024">1024x1024 (–ö–≤–∞–¥—Ä–∞—Ç Full HD)</option>
                                                <option value="1280x1280" selected>1280x1280 (–ö–≤–∞–¥—Ä–∞—Ç HD+)</option>
                                                <option value="1536x1536">1536x1536 (–ö–≤–∞–¥—Ä–∞—Ç 2K)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-md font-semibold text-white mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π</h3>
                                <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                <button id="request-permission" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg hover:shadow-yellow-500/25">
                                    ${I_Shield('w-4 h-4 mr-2')} –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                                </button>
                                <button id="start-camera" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-green-600 hover:bg-green-500 text-white shadow-lg hover:shadow-green-500/25">
                                    ${I_Play('w-4 h-4 mr-2')} –ó–∞–ø—É—Å—Ç–∏—Ç—å
                                </button>
                                <button id="stop-camera" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-red-600 hover:bg-red-500 text-white shadow-lg hover:shadow-red-500/25" disabled>
                                    ${I_Square('w-4 h-4 mr-2')} –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                                </button>
                                <button id="refresh-cameras" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-600 hover:bg-gray-500 text-white shadow-lg hover:shadow-gray-500/25">
                                    ${I_Refresh('w-4 h-4 mr-2')} –û–±–Ω–æ–≤–∏—Ç—å
                                </button>
                                    </div>
                                </div>
                            </div>
                                <!-- <button id="reset-camera-flag" class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-[18px] transition-colors text-sm sm:text-base">
                                    <span>${I_Refresh('w-4 h-4')}</span>
                                    <span class="hidden sm:inline">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥</span>
                                    <span class="sm:hidden">–°–±—Ä–æ—Å</span>
                                </button>
                                <button id="test-minifig-scan" class="flex items-center gap-2 px-3 sm:px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-[18px] transition-colors text-sm sm:text-base">
                                    <span>${I_Scanner('w-4 h-4')}</span>
                                    <span class="hidden sm:inline">–¢–µ—Å—Ç –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏</span>
                                    <span class="sm:hidden">–¢–µ—Å—Ç</span>
                                </button> -->
                            </div>
                        </div>
                    </details>
                </div>
                
                <!-- –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (—Å–≤–µ—Ä–Ω—É—Ç—ã–µ) -->
                <!-- <div class="bg-gradient-to-r from-gray-800/60 to-gray-900/60 rounded-[18px] border border-gray-600/40 shadow-xl">
                    <details class="group">
                        <summary class="flex items-center justify-between p-4 sm:p-6 cursor-pointer hover:bg-gray-700/30 transition-colors rounded-t-xl">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-gray-600/20 rounded-[18px]">
                                    ${I_Info('w-5 h-5 text-gray-400')}
                                </div>
                                <h3 class="text-lg font-semibold text-gray-200">–ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –ª–æ–≥–∏</h3>
                            </div>
                            <span class="text-gray-400 group-open:rotate-180 transition-transform">${I_ChevronDown('w-5 h-5')}</span>
                        </summary>
                        <div class="px-4 sm:px-6 pb-4 sm:pb-6">
                            <div class="flex items-center justify-between mb-3">
                                <p class="text-sm text-gray-400">–û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
                                <button id="clear-logs" class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded transition-colors">
                                    –û—á–∏—Å—Ç–∏—Ç—å
                                </button>
                            </div>
                            <div id="console-logs" class="bg-gray-900 rounded-[18px] p-3 h-32 sm:h-48 overflow-y-auto text-xs font-mono text-gray-300 border border-gray-700">
                                <div class="text-gray-500">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>
                            </div>
                        </div>
                    </details>
                </div> -->
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã -->
        <div id="camera-selection-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden">
            <div id="camera-modal-content" class="bg-gray-800 rounded-[18px] shadow-xl w-[calc(100%-2rem)] max-w-md flex flex-col max-h-[calc(100vh-2rem)] transition-all duration-300 relative">
                <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-green-600/20 rounded-[18px]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path><rect x="8" y="8" width="8" height="8" rx="1"></rect><path d="M12 12v4"></path><path d="M12 8v4"></path></svg>
                        </div>
                        <h2 class="text-xl font-bold text-white">–ö–∞–º–µ—Ä–∞ DataMatrix</h2>
                    </div>
                    <button id="close-camera-modal" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∫–∞–Ω–µ—Ä–∞">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="camera-scroll-progress"><div class="bar"></div></div>
                <div class="flex-grow overflow-y-auto no-scrollbar p-4 sm:p-6" style="min-height: 0;">
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-md font-semibold text-gray-300 mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="modal-camera-select" class="block text-sm font-medium text-gray-300 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É</label>
                                    <select id="modal-camera-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-[18px] text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="modal-resolution-select" class="block text-sm font-medium text-gray-300 mb-2">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ</label>
                                    <select id="modal-resolution-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-[18px] text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                        <option value="640x640">640x640 (–ö–≤–∞–¥—Ä–∞—Ç)</option>
                                        <option value="800x800">800x800 (–ö–≤–∞–¥—Ä–∞—Ç HD)</option>
                                        <option value="1024x1024">1024x1024 (–ö–≤–∞–¥—Ä–∞—Ç Full HD)</option>
                                        <option value="1280x1280" selected>1280x1280 (–ö–≤–∞–¥—Ä–∞—Ç HD+)</option>
                                        <option value="1536x1536">1536x1536 (–ö–≤–∞–¥—Ä–∞—Ç 2K)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0 p-4 border-t border-gray-700">
                    <button id="modal-start-camera" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-[18px] transition-colors font-medium shadow-lg hover:shadow-blue-500/25">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É
                    </button>
                </div>
            </div>
        </div>
    `;
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –ø–æ–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π –ø–æ —Ñ–æ—Ç–æ
function renderPhotoSearchContent() {
    return `
        <div class="min-h-full p-3 sm:p-4 md:p-6 lg:p-8">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="text-center mb-6 sm:mb-8">
                <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">–ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ</h1>
                <p class="text-gray-400 text-sm sm:text-base">–°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –¥–µ—Ç–∞–ª—å, –∫–æ—Ä–æ–±–∫—É –Ω–∞–±–æ—Ä–∞ –∏–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</p>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
            <div class="max-w-7xl mx-auto space-y-4 sm:space-y-6">

                <!-- –û–±–ª–∞—Å—Ç—å –∑–∞—Ö–≤–∞—Ç–∞ —Ñ–æ—Ç–æ -->
                <div class="bg-gradient-to-br from-gray-800/40 to-gray-900/40 rounded-[18px] border border-gray-600/30 p-6 sm:p-8 md:p-10 lg:p-12 shadow-xl">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="p-2 bg-blue-600/20 rounded-[18px]">
                            ${I_Camera('w-5 h-5 text-blue-400')}
                        </div>
                        <h3 class="text-lg font-semibold text-gray-200">AI –∫–∞–º–µ—Ä–∞</h3>
                    </div>
                    <div class="relative flex justify-center">
                        <div class="relative">
                            <video id="photo-search-video" class="w-64 h-64 sm:w-80 sm:h-80 rounded-[18px] bg-gray-900 hidden object-cover shadow-lg" autoplay muted playsinline webkit-playsinline></video>
                            <canvas id="photo-search-canvas" class="w-64 h-64 sm:w-80 sm:h-80 rounded-[18px] bg-gray-900 hidden shadow-lg"></canvas>
                            <div id="photo-search-placeholder" class="w-64 h-64 sm:w-80 sm:h-80 aspect-square bg-gray-900 rounded-[18px] flex items-center justify-center border-2 border-dashed border-gray-600 shadow-lg">
                                <div class="text-center text-gray-400 px-4">
                                    <div class="text-4xl sm:text-5xl mb-3">${I_Camera('w-12 h-12 mx-auto')}</div>
                                    <p class="text-sm sm:text-base font-medium mb-2">–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞</p>
                                    <p class="text-xs sm:text-sm">1. –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É –∏–∑ —Å–ø–∏—Å–∫–∞ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–∞–º–µ—Ä—ã</p>
                                    <p class="text-xs sm:text-sm">2. –ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É"</p>
                                </div>
                            </div>
                            <div id="photo-search-overlay" class="absolute inset-0 pointer-events-none hidden">
                                <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-64 h-64 sm:w-80 sm:h-80">
                                    <!-- –°–∏–Ω—è—è —Ä–∞–º–∫–∞ —Å –æ—Ç—Å—Ç—É–ø–æ–º –≤–Ω—É—Ç—Ä—å -->
                                    <div class="absolute inset-6 border-2 border-blue-400 rounded-[18px] transition-all duration-300">
                                        <!-- –£–≥–ª–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã -->
                                        <div class="absolute top-16 left-16 w-6 h-6 border-t-2 border-l-2 border-blue-400"></div>
                                        <div class="absolute top-16 right-16 w-6 h-6 border-t-2 border-r-2 border-blue-400"></div>
                                        <div class="absolute bottom-16 left-16 w-6 h-6 border-b-2 border-l-2 border-blue-400"></div>
                                        <div class="absolute bottom-16 right-16 w-6 h-6 border-b-2 border-r-2 border-blue-400"></div>
                                    </div>
                                    
                                    <!-- –°—Ç–∞—Ç—É—Å –∑–∞—Ö–≤–∞—Ç–∞ -->
                                    <div id="photo-capture-status" class="absolute top-4 left-1/2 transform -translate-x-1/2 px-3 py-1 bg-blue-600 text-white text-xs rounded-full font-medium hidden">
                                        –ó–∞—Ö–≤–∞—Ç —Ñ–æ—Ç–æ...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —Ñ–æ—Ç–æ -->
                    <div class="flex justify-center mt-4">
                        <button id="capture-photo" class="flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-[18px] transition-colors text-lg font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            <span>${I_Camera('w-5 h-5')}</span>
                            <span>–ù–∞—á–∞—Ç—å –ø–æ–∏—Å–∫</span>
                        </button>
                    </div>
                </div>

                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è -->
                <div class="bg-gradient-to-br from-gray-800/40 to-gray-900/40 rounded-[18px] border border-gray-600/30 p-4 sm:p-6 shadow-xl" style="display: none;">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-green-600/20 rounded-[18px]">
                                ${I_Search('w-5 h-5 text-green-400')}
                            </div>
                            <h3 class="text-lg font-semibold text-gray-200">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</h3>
                        </div>
                        <button id="clear-photo-results" class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-sm rounded-[18px] transition-colors">
                            –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                    <div id="photo-search-results" class="space-y-3">
                    </div>
                </div>

                <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã -->
                <div class="bg-gradient-to-r from-gray-800/60 to-gray-900/60 rounded-[18px] border border-gray-600/40 hover:shadow-blue-500/20 hover:shadow-2xl transition-all duration-300">
                    <details class="group" style="box-shadow: none !important;">
                        <summary class="flex items-center justify-between p-4 sm:p-6 cursor-pointer rounded-t-xl" style="box-shadow: none !important;">
                            <div class="flex items-center gap-3">
                                <div class="p-2 bg-blue-600/20 rounded-[18px]">
                                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    </svg>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-200">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã</h3>
                            </div>
                            <span class="text-gray-400 group-open:rotate-180 transition-transform">${I_ChevronDown('w-5 h-5')}</span>
                        </summary>
                        <div class="px-4 sm:px-6 pb-4 sm:pb-6 space-y-6">
                            <div>
                                <h3 class="text-md font-semibold text-white mb-2">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã</h3>
                                <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                                    <p class="text-xs text-gray-400">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–∞–º–µ—Ä—É –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π LEGO</p>
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-3">
                                        <div>
                                            <label for="photo-camera-select" class="block text-sm font-medium text-gray-300 mb-2">–ö–∞–º–µ—Ä–∞</label>
                                            <select id="photo-camera-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-[18px] text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label for="photo-resolution-select" class="block text-sm font-medium text-gray-300 mb-2">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ</label>
                                            <select id="photo-resolution-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-[18px] text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                                <option value="640x640">640x640 (–ö–≤–∞–¥—Ä–∞—Ç)</option>
                                                <option value="800x800">800x800 (–ö–≤–∞–¥—Ä–∞—Ç HD)</option>
                                                <option value="1024x1024">1024x1024 (–ö–≤–∞–¥—Ä–∞—Ç Full HD)</option>
                                                <option value="1280x1280" selected>1280x1280 (–ö–≤–∞–¥—Ä–∞—Ç HD+)</option>
                                                <option value="1536x1536">1536x1536 (–ö–≤–∞–¥—Ä–∞—Ç 2K)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="text-md font-semibold text-white mb-2">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π</h3>
                                <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                                        <button id="photo-request-permission" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-yellow-600 hover:bg-yellow-500 text-white shadow-lg hover:shadow-yellow-500/25">
                                            ${I_Shield('w-4 h-4 mr-2')} –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                                        </button>
                                        <button id="photo-start-camera" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-green-600 hover:bg-green-500 text-white shadow-lg hover:shadow-green-500/25">
                                            ${I_Play('w-4 h-4 mr-2')} –ó–∞–ø—É—Å—Ç–∏—Ç—å
                                        </button>
                                        <button id="photo-stop-camera" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-red-600 hover:bg-red-500 text-white shadow-lg hover:shadow-red-500/25" disabled>
                                            ${I_Square('w-4 h-4 mr-2')} –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
                                        </button>
                                        <button id="photo-refresh-cameras" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-600 hover:bg-gray-500 text-white shadow-lg hover:shadow-gray-500/25">
                                            ${I_Refresh('w-4 h-4 mr-2')} –û–±–Ω–æ–≤–∏—Ç—å
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
                
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ -->
        <div id="photo-camera-selection-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-hidden">
            <div id="photo-camera-modal-content" class="bg-gray-800 rounded-[18px] shadow-xl w-[calc(100%-2rem)] max-w-md flex flex-col max-h-[calc(100vh-2rem)] transition-all duration-300 relative">
                <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                    <div class="flex items-center gap-3">
                        <div class="p-2 bg-blue-600/20 rounded-[18px]">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path>
                                <circle cx="12" cy="13" r="3"></circle>
                            </svg>
                        </div>
                        <h2 class="text-xl font-bold text-white">AI –∫–∞–º–µ—Ä–∞</h2>
                    </div>
                    <button id="close-photo-camera-modal" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–∫–∞–Ω–µ—Ä–∞">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <div id="photo-camera-scroll-progress"><div class="bar"></div></div>
                <div class="flex-grow overflow-y-auto no-scrollbar p-4 sm:p-6" style="min-height: 0;">
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-md font-semibold text-gray-300 mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="photo-modal-camera-select" class="block text-sm font-medium text-gray-300 mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É</label>
                                    <select id="photo-modal-camera-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-[18px] text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                        <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="photo-modal-resolution-select" class="block text-sm font-medium text-gray-300 mb-2">–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ</label>
                                    <select id="photo-modal-resolution-select" class="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-[18px] text-gray-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors">
                                        <option value="640x640">640x640 (–ö–≤–∞–¥—Ä–∞—Ç)</option>
                                        <option value="800x800">800x800 (–ö–≤–∞–¥—Ä–∞—Ç HD)</option>
                                        <option value="1024x1024">1024x1024 (–ö–≤–∞–¥—Ä–∞—Ç Full HD)</option>
                                        <option value="1280x1280" selected>1280x1280 (–ö–≤–∞–¥—Ä–∞—Ç HD+)</option>
                                        <option value="1536x1536">1536x1536 (–ö–≤–∞–¥—Ä–∞—Ç 2K)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0 p-4 border-t border-gray-700">
                    <button id="photo-modal-start-camera" class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-[18px] transition-colors font-medium shadow-lg hover:shadow-blue-500/25">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É
                    </button>
                </div>
            </div>
        </div>
    `;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
function initWishlistMultiselect() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º UI –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞
    setTimeout(() => {
        updateWishlistSelectionUI();
    }, 100);
}

// –§—É–Ω–∫—Ü–∏—è renderWishlistFolderCard –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π

function renderWishlistItemCard(item, wishlistId) {
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç–ª–µ–º–µ–Ω—Ç–µ
    let itemData = null;
    let itemImage = null;
    let itemName = item.name;
    let itemType = 'unknown';
    let itemColor = null;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫
    const wishlist = S.wishlists[wishlistId];
    const itemIndex = wishlist ? wishlist.items.findIndex(i => i.id === item.id) : -1;
    const isFirst = itemIndex === 0;
    const isLast = itemIndex === (wishlist ? wishlist.items.length - 1 : 0);
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —ç–ª–µ–º–µ–Ω—Ç–∞ –∏ –ø–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    if (item.id.startsWith('set:')) {
        itemType = 'set';
        const setId = item.id.split(':')[1];
        itemData = SET_MAP[setId];
        if (itemData) {
            itemImage = itemData.set_img_url;
            itemName = itemData.name;
        }
    } else if (item.id.startsWith('minifig:')) {
        itemType = 'minifig';
        const minifigId = item.id.split(':')[1];
        itemData = MINIFIG_MAP[minifigId];
        if (itemData) {
            itemImage = itemData.minifig_img_url || itemData.set_img_url;
            itemName = itemData.name;
        }
    } else if (item.id.startsWith('part:')) {
        itemType = 'part';
        const partId = item.id.split(':')[1];
        const colorId = item.id.split(':')[2];
        itemData = PART_MAP[partId];
        if (itemData) {
            itemImage = itemData.part_img_url;
            itemName = itemData.name;
        }
        if (colorId && COLOR_MAP[colorId]) {
            itemColor = COLOR_MAP[colorId];
        }
    }
    
    const typeLabels = {
        'set': '–ù–∞–±–æ—Ä',
        'minifig': '–ú–∏–Ω–∏—Ñ–∏–≥',
        'part': '–î–µ—Ç–∞–ª—å'
    };
    
    // SVG –∏–∫–æ–Ω–∫–∏ –¥–ª—è —Ç–∏–ø–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Ü–≤–µ—Ç–∞–º–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∫–æ–Ω–∫–∏ –∏–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
    const typeIcons = {
        'set': (className = 'w-5 h-5') => `
            <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-lg border border-blue-400/30">
                ${I_Set(className + ' text-white')}
            </div>
        `,
        'minifig': (className = 'w-5 h-5') => `
            <div class="w-8 h-8 bg-gradient-to-br from-green-500 to-green-600 rounded-full flex items-center justify-center shadow-lg border border-green-400/30">
                ${I_Minifig(className + ' text-white')}
            </div>
        `,
        'part': (className = 'w-5 h-5') => `
            <div class="w-8 h-8 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-full flex items-center justify-center shadow-lg border border-yellow-400/30">
                ${I_Tile(className + ' text-white')}
            </div>
        `
    };
    
    return `
        <div class="wishlist-item relative bg-gradient-to-br from-gray-800 to-gray-900 rounded-[18px] overflow-hidden group cursor-pointer border border-gray-700/50 shadow-lg hover:shadow-xl transition-all duration-300" data-item-id="${item.id}" data-wishlist-id="${wishlistId}" data-action="open-item-modal" data-item-type="${itemType}" data-item-id-value="${item.id.split(':')[1]}">
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Ä–∞–∑–º–µ—Ä–∞–º–∏ -->
            <div class="wishlist-image-container relative w-full h-40 bg-gradient-to-br from-gray-700 to-gray-800 flex items-center justify-center p-3">
                <!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
                <div class="wishlist-image-inner relative w-full h-full bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-inner">
                    <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ -->
                    <img src="${itemImage || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMzc0MTUxIi8+CjxwYXRoIGQ9Ik0zMiAxNkMyMy4xNjM0IDE2IDE2IDIzLjE2MzQgMTYgMzJDMTYgNDAuODM2NiAyMy4xNjM0IDQ4IDMyIDQ4QzQwLjgzNjYgNDggNDggNDAuODM2NiA0OCAzMkM0OCAyMy4xNjM0IDQwLjgzNjYgMTYgMzIgMTZaIiBmaWxsPSIjNkI3MjgwIi8+CjxwYXRoIGQ9Ik0yNCAyOEgyNEMyMi44OTU1IDI4IDIyIDI4Ljg5NTQgMjIgMzBWMzRIMjZWMzBDMjYgMjguODk1NCAyNS4xMDQ2IDI4IDI0IDI4WiIgZmlsbD0iIzZCNzI4MCIvPgo8cGF0aCBkPSJNMzIgMjhIMzJDMzAuODk1NCAyOCAzMCAyOC44OTU0IDMwIDMwVjM0SDM0VjMwQzM0IDI4Ljg5NTQgMzMuMTA0NiAyOCAzMiAyOFoiIGZpbGw9IiM2QjcyODAiLz4KPHBhdGggZD0iTTI0IDM2SDQwQzQxLjEwNDYgMzYgNDIgMzYuODk1NCA0MiAzOFY0MEg0MlY0MkM0MiA0My4xMDQ2IDQxLjEwNDYgNDQgNDAgNDRIMjRDMjIuODk1NCA0NCAyMiA0My4xMDQ2IDIyIDQyVjQwSDIyVjM4QzIyIDM2Ljg5NTQgMjIuODk1NCAzNiAyNCAzNloiIGZpbGw9IiM2QjcyODAiLz4KPC9zdmc+'}" alt="${itemName}" class="w-full h-full object-contain pointer-events-none" loading="lazy">
                    
                    <!-- –ò–∫–æ–Ω–∫–∞ —Ç–∏–ø–∞ –≤ –ª–µ–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
                    <div class="wishlist-type-icon absolute top-2 left-2 z-20">
                        ${typeIcons[itemType] ? typeIcons[itemType]('w-4 h-4') : ''}
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã–±–æ—Ä–∞ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
                    <button class="wishlist-item-checkbox absolute top-2 right-2 z-30 bg-gray-900/40 hover:bg-gray-900/60 text-white/80 hover:text-white rounded-full w-6 h-6 flex items-center justify-center shadow-md opacity-100 transition-all duration-150 p-1" data-item-id="${item.id}" data-wishlist-id="${wishlistId}" title="–í—ã–±—Ä–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç">
                        ${I_Circle('w-3 h-3')}
                    </button>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É -->
                    <button aria-label="–£–¥–∞–ª–∏—Ç—å ${itemName}" data-action="remove-from-wishlist" data-item-id="${item.id}" data-wishlist-id="${wishlistId}" class="absolute bottom-2 right-2 z-20 bg-red-500/90 hover:bg-red-600 text-white p-2 rounded-full shadow-lg hover:shadow-red-500/25 opacity-0 group-hover:opacity-100 transition-all duration-200" title="–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π">
                        ${I_Trash("w-4 h-4")}
                    </button>
                </div>
            </div>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–µ–∫—Ü–∏—è -->
            <div class="wishlist-info-section p-4 space-y-3">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ ID -->
                <div class="wishlist-title-section space-y-1">
                    <h3 class="text-sm font-semibold text-white truncate pointer-events-none">${itemName}</h3>
                    <p class="text-xs text-gray-400 pointer-events-none font-mono">${item.id.replace(/^(set|minifig|part):/, '')}</p>
                </div>
                
                <!-- –¶–≤–µ—Ç –∏ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="wishlist-controls flex items-center justify-between">
                    ${itemColor ? `
                        <div class="wishlist-color-info flex items-center gap-2 px-2 py-1 bg-gray-700/50 rounded-[18px] border border-gray-600/50">
                            <span class="w-3 h-3 rounded-full border border-gray-500 shadow-sm" style="background-color: ${itemColor.hex || itemColor.rgb};"></span>
                            <span class="text-xs text-gray-300 font-medium">${itemColor.name}</span>
                        </div>
                    ` : '<div class="wishlist-color-placeholder"></div>'}
                    
                    <!-- –ö–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è -->
                    <div class="wishlist-move-buttons flex flex-row gap-1">
                        <button class="wishlist-move-btn move-left" data-item-id="${item.id}" data-wishlist-id="${wishlistId}" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–ª–µ–≤–æ" ${isFirst ? 'disabled' : ''}>
                            ${I_ChevronLeft('w-4 h-4')}
                        </button>
                        <button class="wishlist-move-btn move-right" data-item-id="${item.id}" data-wishlist-id="${wishlistId}" title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–ø—Ä–∞–≤–æ" ${isLast ? 'disabled' : ''}>
                            ${I_ChevronRight('w-4 h-4')}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

async function saveToCloud() {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        console.log('üîÑ Loading state before save...');
        loadState();
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        console.log('üìä S.coll keys:', Object.keys(S.coll).length);
        console.log('üìä S.setColl keys:', Object.keys(S.setColl).length);
        console.log('üìä S.minifigColl keys:', Object.keys(S.minifigColl).length);
        console.log('üìä S.coll sample:', Object.keys(S.coll).slice(0, 3));
        console.log('üìä S.setColl sample:', Object.keys(S.setColl).slice(0, 3));
        console.log('üìä S.minifigColl sample:', Object.keys(S.minifigColl).slice(0, 3));
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const counts = getCollectionCounts();
        console.log('üìä Collection counts:', counts);
        
        const confirmed = confirm(
            `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤ –æ–±–ª–∞–∫–æ?\n\n` +
            `–î–µ—Ç–∞–ª–∏: ${counts.totalParts}\n` +
            `–ù–∞–±–æ—Ä—ã: ${counts.totalSets}\n` +
            `–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏: ${counts.totalMinifigs}\n\n` +
            `–≠—Ç–æ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.`
        );
        
        if (!confirmed) {
            updateCloudStorageStatus('–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'info');
            return;
        }
        
        updateCloudStorageStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...', 'info');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const hasData = Object.keys(S.coll).length > 0 || Object.keys(S.setColl).length > 0 || Object.keys(S.minifigColl).length > 0;
        if (!hasData) {
            console.warn('‚ö†Ô∏è No collection data found! Checking localStorage directly...');
            const directColl = localStorage.getItem('legoCollection');
            const directSetColl = localStorage.getItem('legoSetCollection');
            const directMinifigColl = localStorage.getItem('legoMinifigCollection');
            console.log('üì¶ Direct localStorage check:');
            console.log('  - legoCollection:', directColl ? JSON.parse(directColl) : 'empty');
            console.log('  - legoSetCollection:', directSetColl ? JSON.parse(directSetColl) : 'empty');
            console.log('  - legoMinifigCollection:', directMinifigColl ? JSON.parse(directMinifigColl) : 'empty');
        }
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è - –∫–æ–ª–ª–µ–∫—Ü–∏—è, –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–µ–º—ã
        const backupData = {
            timestamp: new Date().toISOString(),
            version: "1.0",
            collection: {
                parts: S.coll || {},
                sets: S.setColl || {},
                minifigs: S.minifigColl || {}
            },
            favorites: {
                categories: Array.from(S.favCatIds || new Set()),
                themes: Array.from(S.favThemeIds || new Set())
            },
            localStorage: {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage
                coll: S.coll || {},
                setColl: S.setColl || {},
                minifigColl: S.minifigColl || {}
            }
        };
        
        console.log('üíæ Backup data prepared:', {
            partsCount: Object.keys(backupData.collection.parts).length,
            setsCount: Object.keys(backupData.collection.sets).length,
            minifigsCount: Object.keys(backupData.collection.minifigs).length,
            dataSize: JSON.stringify(backupData).length
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É
        if (window.remoteStorageAvailable && cloudStorageClient) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (!cloudStorageConnected || !cloudStorageClient.remote || !cloudStorageClient.remote.userAddress) {
                console.log('‚ö†Ô∏è Not connected to cloud storage, using fallback');
                throw new Error('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É');
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
                const client = cloudStorageClient.scope('/lego-catalog/');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ JSON —Ñ–∞–π–ª —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
                const timestamp = Date.now();
                const jsonData = JSON.stringify(backupData, null, 2);
                console.log('üíæ Saving data type:', typeof jsonData, 'Length:', jsonData.length);
                await client.storeFile('application/json', `backup-${timestamp}.json`, jsonData);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
                saveCachedData(backupData);
                
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                const counts = getCollectionCounts();
                const message = `–ö–æ–ª–ª–µ–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –æ–±–ª–∞–∫–æ –∏ –∫—ç—à (${counts.totalParts} –¥–µ—Ç–∞–ª–µ–π, ${counts.totalSets} –Ω–∞–±–æ—Ä–æ–≤, ${counts.totalMinifigs} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫)`;
                updateCloudStorageStatus(message, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
                debouncedLoadBackupsList(true, 500); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                
            } catch (cloudError) {
                console.error('‚ùå Cloud save failed:', cloudError);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –æ—Ç–∫–ª—é—á–∞–µ–º—Å—è –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback
                if (cloudError.name === 'UnauthorizedError' || cloudError.message.includes('401')) {
                    console.log('üîÑ Authorization expired, disconnecting and using fallback');
                    cloudStorageConnected = false;
                    saveRemoteStorageState(false);
                    updateCloudStorageStatus('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏—Å—Ç–µ–∫–ª–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ', 'info');
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ fallback —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é
                    throw new Error('AUTHORIZATION_EXPIRED');
                } else {
                    throw cloudError;
                }
            }
        } else {
            throw new Error('Cloud storage not available');
        }
        
        setTimeout(() => {
            updateCloudStorageStatus('–ì–æ—Ç–æ–≤–æ', 'success');
        }, 3000);
        
    } catch (error) {
        console.error('Failed to save:', error);
        
        // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ JSON —Ñ–∞–π–ª
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ localStorage –ø–µ—Ä–µ–¥ fallback —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
            loadState();
            
            const backupData = {
                timestamp: new Date().toISOString(),
                version: "1.0",
                collection: {
                    parts: S.coll || {},
                    sets: S.setColl || {},
                    minifigs: S.minifigColl || {}
                },
                localStorage: {
                    coll: S.coll || {},
                    setColl: S.setColl || {},
                    minifigColl: S.minifigColl || {}
                }
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `lego-collection-backup-${backupData.timestamp}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // –¢–∞–∫–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            const backupKey = `collection_backup_${backupData.timestamp}`;
            localStorage.setItem(backupKey, JSON.stringify(backupData));
            
            if (error.message === 'AUTHORIZATION_EXPIRED') {
                updateCloudStorageStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–æ–∫–∞–ª—å–Ω–æ (–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏—Å—Ç–µ–∫–ª–∞)', 'info');
            } else {
                updateCloudStorageStatus('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ —Ñ–∞–π–ª (–æ–±–ª–∞–∫–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ)', 'success');
            }
            
        } catch (fallbackError) {
            console.error('‚ùå Fallback save also failed:', fallbackError);
            updateCloudStorageStatus('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'error');
        }
    }
}

async function loadFromCloud() {
    try {
        updateCloudStorageStatus('–ó–∞–≥—Ä—É–∑–∫–∞...', 'info');
        
        console.log('üîÑ Manual load from cloud requested');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É
        if (window.remoteStorageAvailable && cloudStorageClient) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω –∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (!cloudStorageConnected || !cloudStorageClient.remote || !cloudStorageClient.remote.userAddress) {
                console.log('‚ö†Ô∏è Not connected to cloud storage');
                updateCloudStorageStatus('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É', 'error');
                return;
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
                const client = cloudStorageClient.scope('/lego-catalog/');
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
                const files = await client.getAll('');
                const backupFiles = Object.keys(files).filter(key => key.startsWith('backup-') && key.endsWith('.json'));
                
                if (backupFiles.length === 0) {
                    console.log('üìù No backup files found in cloud');
                    updateCloudStorageStatus('–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'error');
                    return;
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                backupFiles.sort((a, b) => {
                    const timestampA = parseInt(a.match(/backup-(\d+)\.json/)?.[1] || '0');
                    const timestampB = parseInt(b.match(/backup-(\d+)\.json/)?.[1] || '0');
                    return timestampB - timestampA;
                });
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–∞–º—É—é —Å–≤–µ–∂—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                const latestBackupKey = backupFiles[0];
                console.log('üîç Loading latest backup:', latestBackupKey);
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                const timestampMatch = latestBackupKey.match(/backup-(\d+)\.json/);
                const backupTimestamp = timestampMatch ? parseInt(timestampMatch[1]) : Date.now();
                const backupDate = new Date(backupTimestamp).toLocaleString('ru-RU', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const data = files[latestBackupKey];
                console.log('üîç Loaded data type:', typeof data, data);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –∏ –ø–∞—Ä—Å–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ
                let backupData;
                if (typeof data === 'string') {
                    backupData = JSON.parse(data);
                } else if (typeof data === 'object' && data !== null) {
                    // –ï—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º data, –∏–∑–≤–ª–µ–∫–∞–µ–º JSON –∏–∑ –Ω–µ–≥–æ
                    if (data.data && typeof data.data === 'string') {
                        backupData = JSON.parse(data.data);
                    } else {
                        // –ï—Å–ª–∏ —ç—Ç–æ —É–∂–µ –≥–æ—Ç–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é
                        backupData = data;
                    }
                } else {
                    throw new Error('–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö: ' + typeof data);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à
                saveCachedData(backupData);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∫ –≤ —Å–≤–æ–¥–∫–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏)
                const totalParts = Object.values(backupData.collection?.parts || {}).reduce((sum, part) => 
                    sum + Object.values(part).reduce((partSum, qty) => partSum + qty, 0), 0);
                const totalSets = Object.values(backupData.collection?.sets || {}).reduce((sum, set) => sum + set.qty, 0);
                const totalMinifigs = Object.values(backupData.collection?.minifigs || {}).reduce((sum, minifig) => sum + minifig.qty, 0);
                
                const confirmed = confirm(
                    `–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±–ª–∞–∫–∞?\n\n` +
                    `–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${backupDate}\n` +
                    `–î–µ—Ç–∞–ª–∏: ${totalParts}\n` +
                    `–ù–∞–±–æ—Ä—ã: ${totalSets}\n` +
                    `–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏: ${totalMinifigs}\n\n` +
                    `–≠—Ç–æ –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â—É—é –∫–æ–ª–ª–µ–∫—Ü–∏—é!`
                );
                
                if (!confirmed) {
                    updateCloudStorageStatus('–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'info');
                    return;
                }
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é
                if (backupData.collection) {
                    S.coll = backupData.collection.parts || {};
                    S.setColl = backupData.collection.sets || {};
                    S.minifigColl = backupData.collection.minifigs || {};
                } else {
                    // Fallback –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
                    S.coll = backupData.parts || {};
                    S.setColl = backupData.sets || {};
                    S.minifigColl = backupData.minifigs || {};
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                saveState();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                S.gridStale = true;
                updateUI();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
                await updateCloudBackupInfo();
                
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                const counts = getCollectionCounts();
                const message = `–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞ (${backupDate}): ${counts.totalParts} –¥–µ—Ç–∞–ª–µ–π, ${counts.totalSets} –Ω–∞–±–æ—Ä–æ–≤, ${counts.totalMinifigs} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫`;
                updateCloudStorageStatus(message, 'success');
                
            } catch (cloudError) {
                console.error('‚ùå Failed to load from cloud:', cloudError);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –æ—Ç–∫–ª—é—á–∞–µ–º—Å—è
                if (cloudError.name === 'UnauthorizedError' || cloudError.message.includes('401')) {
                    console.log('üîÑ Authorization expired, disconnecting');
                    cloudStorageConnected = false;
                    saveRemoteStorageState(false);
                    updateCloudStorageStatus('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å', 'error');
                } else {
                    updateCloudStorageStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + cloudError.message, 'error');
                }
            }
        } else {
            updateCloudStorageStatus('–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–æ', 'error');
        }
        
    } catch (error) {
        console.error('Failed to load:', error);
        updateCloudStorageStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
    }
}

function initializeCloudStorage() {
    // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ–ø–µ—Ä—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —Ç–∞–∫ –∫–∞–∫ –≤–∏–¥–∂–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
    console.log('Cloud storage initialization handled by widget');
}

function initializeRemoteStorageWidget() {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ RemoteStorage –∑–∞–≥—Ä—É–∂–µ–Ω
        if (typeof RemoteStorage === 'undefined') {
            console.error('‚ùå RemoteStorage library is not loaded');
            showWidgetError('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ RemoteStorage –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return;
        }
        
        const container = document.getElementById('cloud-backup-widget-container');
        if (!container) {
            console.error('‚ùå Widget container not found');
            return;
        }
        
        console.log('üîß Initializing RemoteStorage...');
        
        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container.innerHTML = '';
        
        // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç remoteStorage —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        cloudStorageClient = new RemoteStorage({
            logging: 'warn',
            cache: false,
            // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫
            redirectUri: window.location.origin + window.location.pathname
        });
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        cloudStorageClient.access.claim('lego-catalog', 'rw');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        container.classList.remove('hidden');
        
        // –°–æ–∑–¥–∞–µ–º —Å—Ç–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ —Å—Ç–∏–ª–µ —Å–∞–π—Ç–∞
        container.innerHTML = `
            <div class="bg-gradient-to-br from-gray-800/80 to-gray-900/80 rounded-[18px] border border-gray-600/40 p-6 sm:p-8 shadow-2xl backdrop-blur-sm">
                <div class="text-center text-gray-200 mb-8">
                    <div class="mb-6 text-cyan-400">
                        ${I_Cloud('w-16 h-16 sm:w-20 sm:h-20')}
                    </div>
                    <h4 class="text-xl sm:text-2xl font-bold mb-3 bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É</h4>
                    <p class="text-sm sm:text-base text-gray-400 max-w-md mx-auto">
                        –í–≤–µ–¥–∏—Ç–µ –≤–∞—à email –∞–¥—Ä–µ—Å —Å 5apps.com –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É
                    </p>
                </div>
                
                <div class="space-y-6">
                    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ -->
                    <div class="p-4 bg-gradient-to-r from-green-900/30 to-emerald-900/30 border border-green-600/40 rounded-[18px] shadow-lg">
                        <div class="flex items-center justify-center">
                            <span class="text-green-400 mr-3">${I_Info('w-5 h-5')}</span>
                            <span class="text-sm font-medium text-green-300">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å 5apps.com</span>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <input 
                            type="text" 
                            id="user-address" 
                            placeholder="user@5apps.com" 
                            class="w-full px-6 py-4 bg-gray-700/80 text-white rounded-[18px] border border-gray-600/50 focus:border-cyan-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/20 text-center text-lg font-medium shadow-lg backdrop-blur-sm transition-all duration-200"
                        >
                        <button 
                            id="connect-address" 
                            class="w-full px-6 py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded-[18px] transition-all duration-200 shadow-lg hover:shadow-cyan-500/25 transform hover:scale-105 text-lg"
                        >
                            –ü–æ–¥–∫–ª—é—á–∏—Ç—å
                        </button>
                    </div>
                    
                </div>
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        const connectBtn = document.getElementById('connect-address');
        const addressInput = document.getElementById('user-address');
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        connectBtn.addEventListener('click', () => {
            const address = addressInput.value.trim();
            if (address) {
                connectToRemoteStorage(address);
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å');
            }
        });
        
        
        console.log('‚úÖ RemoteStorage initialized');
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
        cloudStorageClient.on('ready', () => {
            console.log('‚úÖ RemoteStorage ready');
            cloudStorageConnected = true;
            updateCloudStorageStatus('–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
        });
        
        cloudStorageClient.on('connected', () => {
            console.log('‚úÖ RemoteStorage connected');
            cloudStorageConnected = true;
            updateCloudStorageStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ', 'success');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            saveRemoteStorageState(true);
            const account = cloudStorageClient.remote?.userAddress;
            if (account) {
                saveUserAccount(account);
            }
            updateCacheInfo();
            updateCloudBackupInfo();
        });
        
        cloudStorageClient.on('disconnected', () => {
            console.log('‚ö†Ô∏è RemoteStorage disconnected');
            cloudStorageConnected = false;
            updateCloudStorageStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'error');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
            saveRemoteStorageState(false);
            updateCacheInfo();
            updateCloudBackupInfo();
        });
        
        cloudStorageClient.on('error', (error) => {
            console.error('‚ùå RemoteStorage error:', error);
            cloudStorageConnected = false;
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
            if (error.name === 'DiscoveryError') {
                updateCloudStorageStatus('–û—à–∏–±–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞', 'error');
            } else if (error.name === 'UnauthorizedError') {
                updateCloudStorageStatus('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
            } else {
                updateCloudStorageStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            }
        });
        
    } catch (error) {
        console.error('‚ùå Failed to initialize RemoteStorage:', error);
        showWidgetError('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ' + error.message);
    }
}

function connectToRemoteStorage(address) {
    try {
        console.log('üîß Connecting to RemoteStorage with address:', address);
        updateCloudStorageStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
        
        cloudStorageClient.connect(address);
    } catch (error) {
        console.error('‚ùå Failed to connect:', error);
        updateCloudStorageStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
    }
}

function showWidgetError(message) {
    const container = document.getElementById('cloud-backup-widget-container');
    if (container) {
        container.innerHTML = `
            <div class="text-center text-red-400">
                <div class="mb-2">
                    <div class="w-12 h-12 mx-auto text-yellow-400">${I_Info('w-full h-full')}</div>
                </div>
                <p class="text-sm mb-4">${message}</p>
                <div class="space-y-2">
                    <button id="retry-widget-init" class="mt-2 px-3 py-1 bg-red-600 hover:bg-red-500 text-white text-xs rounded">
                        –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                    </button>
                    <div class="text-xs text-gray-400 mt-2">
                        <p>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç CSV —Ñ–∞–π–ª–æ–≤</p>
                    </div>
                </div>
            </div>
        `;
    }
}

function updateCacheInfo() {
    const cacheInfo = getCacheInfo();
    const cacheInfoElement = document.getElementById('cache-info');
    if (cacheInfoElement) {
        if (cacheInfo.hasCachedData) {
            cacheInfoElement.textContent = '–ö—ç—à: –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ';
        } else {
            cacheInfoElement.textContent = '–ö—ç—à –ø—É—Å—Ç';
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
async function checkBackupFreshness() {
    try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –ª–∏ –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É
        if (!cloudStorageConnected || !cloudStorageClient) {
            console.log('üìù Not connected to cloud storage, skipping freshness check');
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à - –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ
        const now = Date.now();
        if (now - lastBackupFreshnessCheck < BACKUP_FRESHNESS_CHECK_INTERVAL) {
            console.log('üìù Backup freshness check too recent, skipping...');
            return false;
        }
        
        lastBackupFreshnessCheck = now;
        console.log('üîÑ Checking backup freshness...');
        
        // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏
        const client = cloudStorageClient.scope('/lego-catalog/');
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
        const files = await client.getAll('');
        const backupFiles = Object.keys(files).filter(key => key.startsWith('backup-') && key.endsWith('.json'));
        
        if (backupFiles.length === 0) {
            console.log('üìù No backup files found in cloud');
            return false;
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        backupFiles.sort((a, b) => {
            const timestampA = parseInt(a.match(/backup-(\d+)\.json/)?.[1] || '0');
            const timestampB = parseInt(b.match(/backup-(\d+)\.json/)?.[1] || '0');
            return timestampB - timestampA;
        });
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–∞–º—É—é —Å–≤–µ–∂—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
        const latestBackupKey = backupFiles[0];
        const latestBackupData = files[latestBackupKey];
        
        if (!latestBackupData) {
            console.log('üìù Latest backup file is empty');
            return false;
        }
        
        // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        let backupData;
        if (typeof latestBackupData === 'string') {
            backupData = JSON.parse(latestBackupData);
        } else if (typeof latestBackupData === 'object' && latestBackupData !== null) {
            if (latestBackupData.data && typeof latestBackupData.data === 'string') {
                backupData = JSON.parse(latestBackupData.data);
            } else {
                backupData = latestBackupData;
            }
        }
        
        if (!backupData || !backupData.timestamp) {
            console.log('üìù Backup data is invalid');
            return false;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const localCached = localStorage.getItem(REMOTESTORAGE_KEYS.CACHED_DATA);
        let localTimestamp = null;
        
        if (localCached) {
            const localParsed = JSON.parse(localCached);
            localTimestamp = localParsed.timestamp;
        }
        
        // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
        const cloudTimestamp = backupData.timestamp;
        const isCloudNewer = !localTimestamp || new Date(cloudTimestamp) > new Date(localTimestamp);
        
        // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        
        // –ï—Å–ª–∏ –æ–±–ª–∞—á–Ω–∞—è –∫–æ–ø–∏—è –Ω–æ–≤–µ–µ, –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à
        if (isCloudNewer) {
            const cacheData = {
                data: backupData,
                timestamp: cloudTimestamp
            };
            localStorage.setItem(REMOTESTORAGE_KEYS.CACHED_DATA, JSON.stringify(cacheData));
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
            await updateCloudBackupInfo();
            
            return true;
        }
        
        return false;
        
    } catch (error) {
        console.error('‚ùå Failed to check backup freshness:', error);
        return false;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –ø–ª–∞—à–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
function updateCloudBackupInfoContent(formattedDate, formattedTime, isError = false, errorMessage = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö') {
    const cloudBackupInfoElement = document.getElementById('cloud-backup-info');
    if (!cloudBackupInfoElement) return;
    
    if (isError) {
        cloudBackupInfoElement.innerHTML = `
            <div class="group bg-gradient-to-r from-red-700/40 to-red-800/40 rounded-[18px] sm:rounded-[18px] border border-red-600/30 p-2 sm:p-3 hover:border-red-500/50 transition-all duration-200 hover:shadow-lg hover:shadow-red-900/20">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="p-1 sm:p-1.5 bg-red-500/20 rounded-[18px] sm:rounded-[18px] mr-2 sm:mr-3 group-hover:bg-red-500/30 transition-colors flex-shrink-0">
                            <span class="text-red-400">${I_Cloud("w-3 h-3 sm:w-4 sm:h-4")}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center mb-0.5 sm:mb-1">
                                <span class="text-xs sm:text-sm font-semibold text-gray-200 truncate">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>
                            </div>
                            <div class="flex items-center text-xs text-gray-400 mb-0.5 sm:mb-1">
                                <span class="mr-1 sm:mr-1.5 p-0.5 bg-gray-600/50 rounded flex-shrink-0">${I_Calendar("w-3 h-3")}</span>
                                <span class="font-medium truncate text-xs">${errorMessage}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else if (formattedDate && formattedTime) {
        cloudBackupInfoElement.innerHTML = `
            <div class="group bg-gradient-to-r from-gray-700/40 to-gray-800/40 rounded-[18px] sm:rounded-[18px] border border-gray-600/30 p-2 sm:p-3 hover:border-gray-500/50 transition-all duration-200 hover:shadow-lg hover:shadow-gray-900/20">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="p-1 sm:p-1.5 bg-cyan-500/20 rounded-[18px] sm:rounded-[18px] mr-2 sm:mr-3 group-hover:bg-cyan-500/30 transition-colors flex-shrink-0">
                            <span class="text-cyan-400">${I_Cloud("w-3 h-3 sm:w-4 sm:h-4")}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center mb-0.5 sm:mb-1">
                                <span class="text-xs sm:text-sm font-semibold text-gray-200 truncate">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</span>
                            </div>
                            <div class="flex items-center text-xs text-gray-400 mb-0.5 sm:mb-1">
                                <span class="mr-1 sm:mr-1.5 p-0.5 bg-gray-600/50 rounded flex-shrink-0">${I_Calendar("w-3 h-3")}</span>
                                <span class="font-medium truncate text-xs">${formattedDate}, ${formattedTime}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    } else {
        cloudBackupInfoElement.innerHTML = `
            <div class="group bg-gradient-to-r from-gray-700/40 to-gray-800/40 rounded-[18px] sm:rounded-[18px] border border-gray-600/30 p-2 sm:p-3 hover:border-gray-500/50 transition-all duration-200 hover:shadow-lg hover:shadow-gray-900/20">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1 min-w-0">
                        <div class="p-1 sm:p-1.5 bg-gray-500/20 rounded-[18px] sm:rounded-[18px] mr-2 sm:mr-3 group-hover:bg-gray-500/30 transition-colors flex-shrink-0">
                            <span class="text-gray-400">${I_Cloud("w-3 h-3 sm:w-4 sm:h-4")}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center mb-0.5 sm:mb-1">
                                <span class="text-xs sm:text-sm font-semibold text-gray-200 truncate">–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</span>
                            </div>
                            <div class="flex items-center text-xs text-gray-400 mb-0.5 sm:mb-1">
                                <span class="mr-1 sm:mr-1.5 p-0.5 bg-gray-600/50 rounded flex-shrink-0">${I_Calendar("w-3 h-3")}</span>
                                <span class="font-medium truncate text-xs">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                            </div>
                            <div class="flex items-center text-xs text-gray-500">
                                <span class="mr-1 sm:mr-1.5 p-0.5 bg-gray-500/20 rounded flex-shrink-0">${I_FileText("w-3 h-3")}</span>
                                <span class="truncate text-xs">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
}

async function updateCloudBackupInfo() {
    const cloudBackupInfoElement = document.getElementById('cloud-backup-info');
    if (!cloudBackupInfoElement) return;
    
    // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–ª–∞—à–∫—É —Å –∑–∞–≥–ª—É—à–∫–æ–π "–ó–∞–≥—Ä—É–∑–∫–∞..."
    cloudBackupInfoElement.innerHTML = `
        <div class="group bg-gradient-to-r from-gray-700/40 to-gray-800/40 rounded-[18px] sm:rounded-[18px] border border-gray-600/30 p-2 sm:p-3 hover:border-gray-500/50 transition-all duration-200 hover:shadow-lg hover:shadow-gray-900/20">
            <div class="flex items-center justify-between">
                <div class="flex items-center flex-1 min-w-0">
                    <div class="p-1 sm:p-1.5 bg-cyan-500/20 rounded-[18px] sm:rounded-[18px] mr-2 sm:mr-3 group-hover:bg-cyan-500/30 transition-colors flex-shrink-0">
                        <span class="text-cyan-400">${I_Cloud("w-3 h-3 sm:w-4 sm:h-4")}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center mb-0.5 sm:mb-1">
                            <span class="text-xs sm:text-sm font-semibold text-gray-200 truncate">–ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è</span>
                        </div>
                        <div class="flex items-center text-xs text-gray-400 mb-0.5 sm:mb-1">
                            <span class="mr-1 sm:mr-1.5 p-0.5 bg-gray-600/50 rounded flex-shrink-0">${I_Calendar("w-3 h-3")}</span>
                            <span class="font-medium truncate text-xs">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    try {
        // –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É, –ø–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        if (cloudStorageConnected && cloudStorageClient) {
            try {
                const client = cloudStorageClient.scope('/lego-catalog/');
                const files = await client.getAll('');
                const backupFiles = Object.keys(files).filter(key => key.startsWith('backup-') && key.endsWith('.json'));
                
                if (backupFiles.length > 0) {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                    backupFiles.sort((a, b) => {
                        const timestampA = parseInt(a.match(/backup-(\d+)\.json/)?.[1] || '0');
                        const timestampB = parseInt(b.match(/backup-(\d+)\.json/)?.[1] || '0');
                        return timestampB - timestampA;
                    });
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Å–∞–º—É—é —Å–≤–µ–∂—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
                    const latestBackupKey = backupFiles[0];
                    const timestampMatch = latestBackupKey.match(/backup-(\d+)\.json/);
                    const backupTimestamp = timestampMatch ? parseInt(timestampMatch[1]) : Date.now();
                    const date = new Date(backupTimestamp);
                    
                    const now = new Date();
                    const diffMs = now - date;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                    const diffMinutes = Math.floor(diffMs / (1000 * 60));
                    
                    let timeText;
                    if (diffDays > 0) {
                        timeText = `${diffDays} –¥–Ω. –Ω–∞–∑–∞–¥`;
                    } else if (diffHours > 0) {
                        timeText = `${diffHours} —á. –Ω–∞–∑–∞–¥`;
                    } else if (diffMinutes > 0) {
                        timeText = `${diffMinutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
                    } else {
                        timeText = '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                    }
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
                    const formattedDate = date.toLocaleDateString('ru-RU', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    const formattedTime = date.toLocaleTimeString('ru-RU', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    updateCloudBackupInfoContent(formattedDate, formattedTime);
                    return;
                }
            } catch (error) {
                console.error('‚ùå Failed to get latest backup info:', error);
            }
        }
        
        // Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const cached = localStorage.getItem(REMOTESTORAGE_KEYS.CACHED_DATA);
        if (cached) {
            const parsed = JSON.parse(cached);
            if (parsed.timestamp && parsed.data) {
                const date = new Date(parsed.timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                
                let timeText;
                if (diffDays > 0) {
                    timeText = `${diffDays} –¥–Ω. –Ω–∞–∑–∞–¥`;
                } else if (diffHours > 0) {
                    timeText = `${diffHours} —á. –Ω–∞–∑–∞–¥`;
                } else if (diffMinutes > 0) {
                    timeText = `${diffMinutes} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
                } else {
                    timeText = '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
                const formattedDate = date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                const formattedTime = date.toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                updateCloudBackupInfoContent(formattedDate, formattedTime);
                return;
            }
        }
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        updateCloudBackupInfoContent();
    } catch (error) {
        console.error('‚ùå Failed to update cloud backup info:', error);
        updateCloudBackupInfoContent(null, null, true, '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
    }
}

function showFallbackSolution() {
    const container = document.getElementById('cloud-backup-widget-container');
    if (container) {
        container.innerHTML = `
            <div class="text-center text-gray-300">
                <div class="text-4xl mb-4">üìÅ</div>
                <h4 class="text-lg font-semibold mb-2">–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</h4>
                <p class="text-sm text-gray-400 mb-4">
                    –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤.
                </p>
                <div class="space-y-3">
                    <button 
                        id="save-local-backup" 
                        class="w-full px-4 py-2 bg-green-600 hover:bg-green-500 text-white text-sm rounded-[18px] transition-colors"
                    >
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —Ñ–∞–π–ª
                    </button>
                    <div class="text-xs text-gray-500">
                        <p>–§–∞–π–ª –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –≤–∞—à–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</p>
                    </div>
                </div>
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const saveBtn = document.getElementById('save-local-backup');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                saveToCloud(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ—É–Ω–∫—Ü–∏—é, –Ω–æ —Å fallback
            });
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏
function logoutFromCloudStorage() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏? –≠—Ç–æ –æ—Ç–∫–ª—é—á–∏—Ç –≤–∞—Å –æ—Ç –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.')) {
        try {
            // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
            if (cloudStorageClient) {
                cloudStorageClient.disconnect();
            }
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            clearRemoteStorageCache();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            cloudStorageConnected = false;
            cloudStorageClient = null;
            isReconnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            
            // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä –∞–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
            if (window.cloudStatusTimer) {
                clearTimeout(window.cloudStatusTimer);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∏ UI
            updateCloudStorageStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏', 'info');
            updateCloudStorageUI();
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                updateCloudStorageStatus('–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ', 'info');
                updateCloudStorageStatusDisplay();
            }, 3000);
            
            console.log('‚úÖ Successfully logged out from cloud storage');
            
        } catch (error) {
            console.error('‚ùå Logout failed:', error);
            updateCloudStorageStatus('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ', 'error');
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
async function checkSavedCloudStorageState() {
    try {
        const savedState = loadRemoteStorageState();
        const savedAccount = loadUserAccount();
        
        if (savedState && savedState.connected && savedAccount) {
            console.log('‚úÖ Found saved cloud storage state for:', savedAccount);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            cloudStorageConnected = true;
            updateCloudStorageStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${savedAccount}`, 'success');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ (–±–µ–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
            if (!cloudStorageClient) {
                cloudStorageClient = new RemoteStorage({
                    logging: 'warn',
                    cache: false,
                    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫
                    redirectUri: window.location.origin + window.location.pathname
                });
                cloudStorageClient.access.claim('lego-catalog', 'rw');
                setupRemoteStorageEventHandlers();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateCloudStorageUI();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
            await updateCloudBackupInfo();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
            debouncedCheckBackupFreshness(500);
            
            return true;
        } else {
            console.log('üìù No saved cloud storage credentials found');
            return false;
        }
    } catch (error) {
        console.error('‚ùå Check saved state failed:', error);
        return false;
    }
}

// –§—É–Ω–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π RemoteStorage
function setupRemoteStorageEventHandlers() {
    cloudStorageClient.on('ready', () => {
        console.log('‚úÖ RemoteStorage ready');
        cloudStorageConnected = true;
        isReconnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–∫–∫–∞—É–Ω—Ç–µ
        const account = cloudStorageClient.remote?.userAddress;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        updateCloudStorageStatus(`–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ: ${account}`, 'success');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤–≤–æ–¥–∞ –ª–æ–≥–∏–Ω–∞
        const container = document.getElementById('cloud-backup-widget-container');
        if (container) {
            container.classList.add('hidden');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateCloudStorageUI();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
        updateCloudBackupInfo(); // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ —Ñ–æ–Ω–µ
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
        debouncedCheckBackupFreshness(500);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
        debouncedLoadBackupsList(true, 1000);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
        startPeriodicVersionsRefresh();
    });
    
    cloudStorageClient.on('connected', () => {
        console.log('‚úÖ RemoteStorage connected');
        cloudStorageConnected = true;
        isReconnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        saveRemoteStorageState(true);
        const account = cloudStorageClient.remote?.userAddress;
        if (account) {
            saveUserAccount(account);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        updateCloudStorageStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${account}`, 'success');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –≤–≤–æ–¥–∞ –ª–æ–≥–∏–Ω–∞
        const container = document.getElementById('cloud-backup-widget-container');
        if (container) {
            container.classList.add('hidden');
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateCloudStorageUI();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
        debouncedLoadBackupsList(true, 1000);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
        startPeriodicVersionsRefresh();
    });
    
    cloudStorageClient.on('disconnected', () => {
        console.log('‚ö†Ô∏è RemoteStorage disconnected');
        cloudStorageConnected = false;
        isReconnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
        stopPeriodicVersionsRefresh();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
        saveRemoteStorageState(false);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        updateCloudStorageStatus('–û—Ç–∫–ª—é—á–µ–Ω–æ', 'error');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateCloudStorageUI();
    });
    
    cloudStorageClient.on('error', (error) => {
        console.error('‚ùå RemoteStorage error:', error);
        cloudStorageConnected = false;
        isReconnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
        stopPeriodicVersionsRefresh();
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
        let errorMessage = '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è';
        if (error.name === 'DiscoveryError') {
            errorMessage = '–û—à–∏–±–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞';
        } else if (error.name === 'UnauthorizedError') {
            errorMessage = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
        } else if (error.message) {
            errorMessage = '–û—à–∏–±–∫–∞: ' + error.message;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
        updateCloudStorageStatus(errorMessage, 'error');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI –ø—Ä–∏ –æ—à–∏–±–∫–µ
        updateCloudStorageUI();
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
    if (typeof cloudStorageClient.on === 'function') {
        try {
            cloudStorageClient.on('sync-done', () => {
                console.log('üîÑ RemoteStorage sync completed');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                if (S.view === 'tools' && S.toolSubView === 'cloud-backup') {
                    debouncedLoadBackupsList(true, 500);
                    updateCloudBackupInfo();
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –æ–±–ª–∞—á–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
            cloudStorageClient.on('change', (event) => {
                console.log('üîÑ RemoteStorage change detected:', event);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞—Å–∞–µ—Ç—Å—è –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—à–∏—Ö —Ñ–∞–π–ª–æ–≤ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
                if (event && event.path && event.path.includes('lego-catalog')) {
                    console.log('üìù Backup files changed, refreshing list');
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
                    if (S.view === 'tools' && S.toolSubView === 'cloud-backup') {
                        debouncedLoadBackupsList(true, 1000);
                        updateCloudBackupInfo();
                    }
                }
            });
        } catch (error) {
            console.log('‚ÑπÔ∏è Some RemoteStorage events not supported:', error.message);
        }
    }
}

// –ö—ç—à –¥–ª—è —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
let backupsListCache = null;
let backupsListCacheTime = 0;
const BACKUPS_CACHE_DURATION = 15000; // 15 —Å–µ–∫—É–Ω–¥ (—É–º–µ–Ω—å—à–µ–Ω–æ –¥–ª—è –±–æ–ª–µ–µ —á–∞—Å—Ç–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è)

// –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
let isLoadingBackupsList = false;
let loadBackupsListTimeout = null;

// –ö—ç—à –¥–ª—è checkBackupFreshness
let lastBackupFreshnessCheck = 0;
const BACKUP_FRESHNESS_CHECK_INTERVAL = 30000; // 30 —Å–µ–∫—É–Ω–¥
let checkBackupFreshnessTimeout = null;

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
let periodicVersionsRefreshInterval = null;
const VERSIONS_REFRESH_INTERVAL = 60000; // 60 —Å–µ–∫—É–Ω–¥

// Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è loadBackupsList
function debouncedLoadBackupsList(forceRefresh = false, delay = 500) {
    if (loadBackupsListTimeout) {
        clearTimeout(loadBackupsListTimeout);
    }
    
    loadBackupsListTimeout = setTimeout(() => {
        loadBackupsList(forceRefresh);
    }, delay);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
function startPeriodicVersionsRefresh() {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
    stopPeriodicVersionsRefresh();
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É
    if (cloudStorageConnected && cloudStorageClient) {
        periodicVersionsRefreshInterval = setInterval(() => {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ –≤–∫–ª–∞–¥–∫–µ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
            if (S.view === 'tools' && S.toolSubView === 'cloud-backup') {
                console.log('üîÑ Periodic versions refresh triggered');
                debouncedLoadBackupsList(true, 100);
                updateCloudBackupInfo();
            }
        }, VERSIONS_REFRESH_INTERVAL);
        
        console.log('‚úÖ Started periodic versions refresh');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π
function stopPeriodicVersionsRefresh() {
    if (periodicVersionsRefreshInterval) {
        clearInterval(periodicVersionsRefreshInterval);
        periodicVersionsRefreshInterval = null;
        console.log('‚èπÔ∏è Stopped periodic versions refresh');
    }
}

// Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è checkBackupFreshness
function debouncedCheckBackupFreshness(delay = 1000) {
    if (checkBackupFreshnessTimeout) {
        clearTimeout(checkBackupFreshnessTimeout);
    }
    
    checkBackupFreshnessTimeout = setTimeout(() => {
        checkBackupFreshness();
    }, delay);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
async function loadBackupsList(forceRefresh = false) {
    try {
        const backupsList = document.getElementById('backups-list');
        if (!backupsList) return;

        // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
        if (isLoadingBackupsList) {
            console.log('üîÑ loadBackupsList already in progress, skipping...');
            return;
        }

        if (!cloudStorageConnected || !cloudStorageClient) {
            console.log('‚ö†Ô∏è Cloud storage not connected');
            backupsList.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-700/50 rounded-full mb-4">
                        <span class="text-gray-400">${I_Cloud('w-8 h-8')}</span>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É</p>
                    <p class="text-gray-500 text-xs mt-1">–¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤–µ—Ä—Å–∏–π —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π</p>
                </div>
            `;
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
        const now = Date.now();
        if (!forceRefresh && backupsListCache && (now - backupsListCacheTime) < BACKUPS_CACHE_DURATION) {
            backupsList.innerHTML = backupsListCache;
            return;
        }

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
        isLoadingBackupsList = true;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
        const currentContent = backupsList.innerHTML.trim();
        const isLoadingIndicator = currentContent.includes('–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π') || 
                                 currentContent.includes('animate-pulse') ||
                                 currentContent === '';
        
        if (isLoadingIndicator) {
            backupsList.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-500/20 rounded-full mb-4 animate-pulse">
                        <span class="text-blue-400">${I_Clock('w-8 h-8')}</span>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π...</p>
                    <p class="text-gray-500 text-xs mt-1">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π</p>
                </div>
            `;
        }

        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –∏–∑ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        const client = cloudStorageClient.scope('/lego-catalog/');
        const files = await client.getAll('');
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
        const backupFiles = Object.keys(files)
            .filter(key => key.startsWith('backup-') && key.endsWith('.json'))
            .map(key => {
                const timestamp = key.replace('backup-', '').replace('.json', '');
                return {
                    key,
                    timestamp,
                    date: new Date(parseInt(timestamp))
                };
            })
            .sort((a, b) => b.date - a.date); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)

        if (backupFiles.length === 0) {
            backupsList.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-gray-700/50 rounded-full mb-4">
                        <span class="text-gray-400">${I_Archive('w-8 h-8')}</span>
                    </div>
                    <p class="text-gray-400 text-sm font-medium">–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <p class="text-gray-500 text-xs mt-1">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</p>
                </div>
            `;
            return;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–π –≤–µ—Ä—Å–∏–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const backupFilesWithInfo = await Promise.all(backupFiles.map(async (file, index) => {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                const backupData = await client.getFile(file.key);
                let elementCounts = { parts: 0, sets: 0, minifigs: 0 };
                
                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                
                if (backupData) {
                    // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ - remoteStorage.js –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö
                    let data;
                    if (typeof backupData === 'string') {
                        data = JSON.parse(backupData);
                    } else if (backupData && typeof backupData === 'object' && backupData.data) {
                        // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –≤ –æ–±—ä–µ–∫—Ç–µ —Å –ø–æ–ª–µ–º data
                        data = typeof backupData.data === 'string' ? JSON.parse(backupData.data) : backupData.data;
                    } else {
                        data = backupData;
                    }
                    
                    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                    
                    // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö (–∫–∞–∫ –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏)
                    if (data.collection && data.collection.parts) {
                        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π —Å —É—á–µ—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ (–∫–∞–∫ –≤ getCollectionCounts)
                        elementCounts.parts = Object.values(data.collection.parts).reduce((sum, part) => 
                            sum + Object.values(part).reduce((partSum, qty) => partSum + qty, 0), 0);
                    }
                    if (data.collection && data.collection.sets) {
                        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–æ—Ä–æ–≤ —Å —É—á–µ—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                        elementCounts.sets = Object.values(data.collection.sets).reduce((sum, set) => sum + set.qty, 0);
                    }
                    if (data.collection && data.collection.minifigs) {
                        // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ —Å —É—á–µ—Ç–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞
                        elementCounts.minifigs = Object.values(data.collection.minifigs).reduce((sum, minifig) => sum + minifig.qty, 0);
                    }
                    
                    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
                }
                
                return { ...file, elementCounts, index };
            } catch (error) {
                console.warn(`‚ö†Ô∏è Could not load backup info for ${file.key}:`, error);
                return { ...file, elementCounts: { parts: 0, sets: 0, minifigs: 0 }, index };
            }
        }));

        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π
        backupsList.innerHTML = backupFilesWithInfo.map((file, index) => {
            const isLatest = index === 0;
            const dateStr = file.date.toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const totalElements = file.elementCounts.parts + file.elementCounts.sets + file.elementCounts.minifigs;
            const elementsInfo = totalElements > 0 ? 
                `${file.elementCounts.parts} –¥–µ—Ç–∞–ª–µ–π, ${file.elementCounts.sets} –Ω–∞–±–æ—Ä–æ–≤, ${file.elementCounts.minifigs} —Ñ–∏–≥—É—Ä–æ–∫` :
                '–ü—É—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const indicatorColor = totalElements === 0 ? 'bg-gray-500/20' : 
                                 totalElements < 10 ? 'bg-yellow-500/20' : 
                                 totalElements < 50 ? 'bg-blue-500/20' : 'bg-green-500/20';
            
            return `
                <div class="group bg-gradient-to-r from-gray-700/40 to-gray-800/40 rounded-[18px] sm:rounded-[18px] border border-gray-600/30 p-2 sm:p-3 hover:border-gray-500/50 transition-all duration-200 hover:shadow-lg hover:shadow-gray-900/20">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center flex-1 min-w-0">
                            <div class="p-1 sm:p-1.5 bg-cyan-500/20 rounded-[18px] sm:rounded-[18px] mr-2 sm:mr-3 group-hover:bg-cyan-500/30 transition-colors flex-shrink-0">
                                <span class="text-cyan-400">${I_FileText('w-3 h-3 sm:w-4 sm:h-4')}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center mb-0.5 sm:mb-1">
                                    <span class="text-xs sm:text-sm font-semibold text-gray-200 truncate">–í–µ—Ä—Å–∏—è ${backupFiles.length - index}</span>
                                    ${totalElements > 0 ? `<span class="ml-1 sm:ml-2 px-1.5 sm:px-2 py-0.5 text-xs font-bold bg-gradient-to-r from-cyan-600 to-cyan-500 text-white rounded-full shadow-lg flex-shrink-0">${totalElements}</span>` : ''}
                                    ${isLatest ? '<span class="ml-1 sm:ml-2 px-1.5 sm:px-2 py-0.5 text-xs font-bold bg-gradient-to-r from-green-600 to-green-500 text-white rounded-full shadow-lg flex-shrink-0">–ü–æ—Å–ª–µ–¥–Ω—è—è</span>' : ''}
                                </div>
                                <div class="flex items-center text-xs text-gray-400 mb-0.5 sm:mb-1">
                                    <span class="mr-1 sm:mr-1.5 p-0.5 bg-gray-600/50 rounded flex-shrink-0">${I_Calendar('w-3 h-3')}</span>
                                    <span class="font-medium truncate text-xs">${dateStr}</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500">
                                    <span class="mr-1 sm:mr-1.5 p-0.5 ${indicatorColor} rounded flex-shrink-0">${I_Archive('w-3 h-3')}</span>
                                    <span class="truncate text-xs">${elementsInfo}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 sm:space-x-1.5 ml-1 sm:ml-2 flex-shrink-0">
                            <button 
                                class="load-backup-btn flex items-center px-1.5 sm:px-2.5 py-1 sm:py-1.5 text-xs font-semibold rounded-[18px] sm:rounded-[18px] transition-all duration-200 bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 text-white shadow-lg hover:shadow-purple-500/25 transform hover:scale-105"
                                data-key="${file.key}"
                            >
                                <span class="mr-0.5 sm:mr-1">${I_CloudDownload('w-3 h-3')}</span>
                                <span class="hidden sm:inline">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
                                <span class="sm:hidden">‚Üì</span>
                            </button>
                            <button 
                                class="delete-backup-btn flex items-center px-1.5 sm:px-2.5 py-1 sm:py-1.5 text-xs font-semibold rounded-[18px] sm:rounded-[18px] transition-all duration-200 ${isLatest ? 'bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 shadow-orange-500/25' : 'bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 shadow-red-500/25'} text-white shadow-lg hover:shadow-lg transform hover:scale-105"
                                data-key="${file.key}"
                                data-is-latest="${isLatest}"
                                title="${isLatest ? '–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)' : '–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é'}"
                            >
                                <span class="mr-0.5 sm:mr-1">${I_Trash('w-3 h-3')}</span>
                                <span class="hidden sm:inline">–£–¥–∞–ª–∏—Ç—å</span>
                                <span class="sm:hidden">√ó</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // –û–±–Ω–æ–≤–ª—è–µ–º HTML —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
        backupsList.innerHTML = backupFilesWithInfo.map((file, index) => {
            const dateStr = file.date.toLocaleString('ru-RU', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const totalElements = file.elementCounts.parts + file.elementCounts.sets + file.elementCounts.minifigs;
            const isLatest = index === 0;
            
            let elementsInfo = '';
            if (file.elementCounts.parts > 0) elementsInfo += `${file.elementCounts.parts} –¥–µ—Ç.`;
            if (file.elementCounts.sets > 0) elementsInfo += (elementsInfo ? ', ' : '') + `${file.elementCounts.sets} –Ω–∞–±.`;
            if (file.elementCounts.minifigs > 0) elementsInfo += (elementsInfo ? ', ' : '') + `${file.elementCounts.minifigs} –º–∏–Ω.`;
            if (!elementsInfo) elementsInfo = '–ü—É—Å—Ç–∞—è –∫–æ–ø–∏—è';
            
            const indicatorColor = totalElements > 0 ? 'bg-green-500/20' : 'bg-gray-500/20';
            
            return `
                <div class="group bg-gradient-to-r from-gray-800/40 to-gray-900/40 hover:from-gray-700/50 hover:to-gray-800/50 rounded-[18px] sm:rounded-[18px] border border-gray-600/30 hover:border-gray-500/50 transition-all duration-200 p-2 sm:p-3 shadow-lg hover:shadow-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center min-w-0 flex-1">
                            <div class="p-1 sm:p-1.5 bg-cyan-500/20 rounded-[18px] mr-2 sm:mr-3 flex-shrink-0">
                                <span class="text-cyan-400">${I_FileText('w-3 h-3 sm:w-4 sm:h-4')}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center mb-0.5 sm:mb-1">
                                    <span class="text-xs sm:text-sm font-semibold text-gray-200 truncate">–í–µ—Ä—Å–∏—è ${backupFiles.length - index}</span>
                                    ${totalElements > 0 ? `<span class="ml-1 sm:ml-2 px-1.5 sm:px-2 py-0.5 text-xs font-bold bg-gradient-to-r from-cyan-600 to-cyan-500 text-white rounded-full shadow-lg flex-shrink-0">${totalElements}</span>` : ''}
                                    ${isLatest ? '<span class="ml-1 sm:ml-2 px-1.5 sm:px-2 py-0.5 text-xs font-bold bg-gradient-to-r from-green-600 to-green-500 text-white rounded-full shadow-lg flex-shrink-0">–ü–æ—Å–ª–µ–¥–Ω—è—è</span>' : ''}
                                </div>
                                <div class="flex items-center text-xs text-gray-400 mb-0.5 sm:mb-1">
                                    <span class="mr-1 sm:mr-1.5 p-0.5 bg-gray-600/50 rounded flex-shrink-0">${I_Calendar('w-3 h-3')}</span>
                                    <span class="font-medium truncate text-xs">${dateStr}</span>
                                </div>
                                <div class="flex items-center text-xs text-gray-500">
                                    <span class="mr-1 sm:mr-1.5 p-0.5 ${indicatorColor} rounded flex-shrink-0">${I_Archive('w-3 h-3')}</span>
                                    <span class="truncate text-xs">${elementsInfo}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-1 sm:space-x-1.5 ml-1 sm:ml-2 flex-shrink-0">
                            <button 
                                class="load-backup-btn flex items-center px-1.5 sm:px-2.5 py-1 sm:py-1.5 text-xs font-semibold rounded-[18px] sm:rounded-[18px] transition-all duration-200 bg-gradient-to-r from-purple-600 to-purple-500 hover:from-purple-500 hover:to-purple-400 text-white shadow-lg hover:shadow-purple-500/25 transform hover:scale-105"
                                data-key="${file.key}"
                            >
                                <span class="mr-0.5 sm:mr-1">${I_CloudDownload('w-3 h-3')}</span>
                                <span class="hidden sm:inline">–ó–∞–≥—Ä—É–∑–∏—Ç—å</span>
                                <span class="sm:hidden">‚Üì</span>
                            </button>
                            <button 
                                class="delete-backup-btn flex items-center px-1.5 sm:px-2.5 py-1 sm:py-1.5 text-xs font-semibold rounded-[18px] sm:rounded-[18px] transition-all duration-200 ${isLatest ? 'bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-500 hover:to-orange-400 shadow-orange-500/25' : 'bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 shadow-red-500/25'} text-white shadow-lg hover:shadow-lg transform hover:scale-105"
                                data-key="${file.key}"
                                data-is-latest="${isLatest}"
                                title="${isLatest ? '–£–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≤–µ—Ä—Å–∏—é (—Ç—Ä–µ–±—É–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è)' : '–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é'}"
                            >
                                <span class="mr-0.5 sm:mr-1">${I_Trash('w-3 h-3')}</span>
                                <span class="hidden sm:inline">–£–¥–∞–ª–∏—Ç—å</span>
                                <span class="sm:hidden">√ó</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ)
        if (backupFilesWithInfo.length > 0) {
            backupsListCache = backupsList.innerHTML;
            backupsListCacheTime = Date.now();
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        addBackupButtonsHandlers();

    } catch (error) {
        console.error('‚ùå Error loading backups list:', error);
        const backupsList = document.getElementById('backups-list');
        if (backupsList) {
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ—à–∏–±–∫–∏ –¥–ª—è –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
            let errorTitle = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≤–µ—Ä—Å–∏–π';
            let errorDetails = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
            
            if (error.name === 'UnauthorizedError' || error.message.includes('401')) {
                errorTitle = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                errorDetails = '–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É';
            } else if (error.name === 'NetworkError' || error.message.includes('network')) {
                errorTitle = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏';
                errorDetails = '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É';
            } else if (error.message.includes('timeout')) {
                errorTitle = '–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è';
                errorDetails = '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥';
            }
            
            backupsList.innerHTML = `
                <div class="text-center py-8">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-red-500/20 rounded-full mb-4">
                        <span class="text-red-400">${I_X('w-8 h-8')}</span>
                    </div>
                    <p class="text-red-400 text-sm font-medium">${errorTitle}</p>
                    <p class="text-gray-500 text-xs mt-1">${errorDetails}</p>
                    <button 
                        id="retry-load-backups" 
                        class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white text-sm rounded-[18px] transition-colors"
                        onclick="debouncedLoadBackupsList(true, 100)"
                    >
                        –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                    </button>
                </div>
            `;
        }
        
        // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        if (error.name === 'UnauthorizedError' || error.message.includes('401')) {
            cloudStorageConnected = false;
            stopPeriodicVersionsRefresh();
        }
    } finally {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏
        isLoadingBackupsList = false;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–Ω–æ–ø–æ–∫ –≤–µ—Ä—Å–∏–π
function addBackupButtonsHandlers() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ–π —Ä–∞–±–æ—Ç—ã
    const backupsList = document.getElementById('backups-list');
    if (!backupsList) {
        return;
    }

    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    backupsList.removeEventListener('click', handleBackupButtonClick);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
    backupsList.addEventListener('click', handleBackupButtonClick);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const refreshBtn = document.getElementById('refresh-backups');
    if (refreshBtn) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        refreshBtn.removeEventListener('click', handleRefreshClick);
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
        refreshBtn.addEventListener('click', handleRefreshClick);
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
function handleRefreshClick(e) {
    e.preventDefault();
    e.stopPropagation();
    debouncedLoadBackupsList(true, 100); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ –≤ —Å–ø–∏—Å–∫–µ –≤–µ—Ä—Å–∏–π
async function handleBackupButtonClick(e) {
    console.log('üîç Button click detected:', e.target);
    
    const target = e.target.closest('.load-backup-btn, .delete-backup-btn');
    if (!target) {
        console.log('‚ùå No target button found');
        return;
    }

    console.log('‚úÖ Target button found:', target.className, 'data-key:', target.getAttribute('data-key'));

    e.preventDefault();
    e.stopPropagation();

    const key = target.getAttribute('data-key');
    if (!key) {
        console.log('‚ùå No data-key found');
        return;
    }

    if (target.classList.contains('load-backup-btn')) {
        console.log('üì• Loading backup:', key);
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–µ—Ä—Å–∏–∏
        await loadSpecificBackup(key);
    } else if (target.classList.contains('delete-backup-btn')) {
        console.log('üóëÔ∏è Deleting backup:', key);
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏
        const isLatest = target.getAttribute('data-is-latest') === 'true';
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏
        if (isLatest) {
            const confirmed = confirm(
                '‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n' +
                '–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –ü–û–°–õ–ï–î–ù–Æ–Æ –≤–µ—Ä—Å–∏—é —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.\n\n' +
                '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!\n\n' +
                '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ?'
            );
            if (!confirmed) return;
        } else {
            const confirmed = confirm(
                '–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –≤–µ—Ä—Å–∏—é —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏?\n\n' +
                '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!'
            );
            if (!confirmed) return;
        }
        
        await deleteBackup(key);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
async function loadSpecificBackup(key) {
    try {
        if (!cloudStorageConnected || !cloudStorageClient) {
            alert('–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
            return;
        }

        updateCloudStorageStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ—Ä—Å–∏–∏...', 'info');

        const client = cloudStorageClient.scope('/lego-catalog/');
        const backupData = await client.getFile(key);
        
        if (!backupData) {
            alert('–§–∞–π–ª —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            updateCloudStorageStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–∞—Ä—Å–∏—Ç—å JSON
        console.log('üì• Backup data type:', typeof backupData);
        console.log('üì• Backup data:', backupData);
        
        let data;
        if (typeof backupData === 'string') {
            console.log('üì• Parsing JSON string');
            data = JSON.parse(backupData);
        } else if (typeof backupData === 'object') {
            console.log('üì• Using object directly');
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª–µ data —Å JSON —Å—Ç—Ä–æ–∫–æ–π
            if (backupData.data && typeof backupData.data === 'string') {
                console.log('üì• Parsing JSON from data field');
                data = JSON.parse(backupData.data);
            } else {
                data = backupData;
            }
        } else {
            console.error('‚ùå Invalid backup data type:', typeof backupData);
            throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏');
        }
        
        console.log('üì• Parsed data:', data);
        
        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const totalParts = Object.values(data.collection?.parts || {}).reduce((sum, part) => 
            sum + Object.values(part).reduce((partSum, qty) => partSum + qty, 0), 0);
        const totalSets = Object.values(data.collection?.sets || {}).reduce((sum, set) => sum + set.qty, 0);
        const totalMinifigs = Object.values(data.collection?.minifigs || {}).reduce((sum, minifig) => sum + minifig.qty, 0);
        
        const confirmMessage = `–ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Ä—Å–∏—é –æ—Ç ${new Date(parseInt(key.replace('backup-', '').replace('.json', ''))).toLocaleString('ru-RU')}?\n\n` +
            `–î–µ—Ç–∞–ª–∏: ${totalParts}\n` +
            `–ù–∞–±–æ—Ä—ã: ${totalSets}\n` +
            `–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏: ${totalMinifigs}\n\n` +
            `–≠—Ç–æ –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.`;
        if (!confirm(confirmMessage)) {
            updateCloudStorageStatus('–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'info');
            return;
        }

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        console.log('üì• Loading data into collection...');
        console.log('üì• Data structure:', data);
        
        if (data.collection) {
            console.log('üì• Found collection data:', data.collection);
            S.coll = data.collection.parts || {};
            S.setColl = data.collection.sets || {};
            S.minifigColl = data.collection.minifigs || {};
            
            console.log('üì• Loaded parts:', Object.keys(S.coll).length);
            console.log('üì• Loaded sets:', Object.keys(S.setColl).length);
            console.log('üì• Loaded minifigs:', Object.keys(S.minifigColl).length);
        } else {
            console.log('‚ùå No collection data found in backup');
            alert('–í —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏');
            return;
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–µ–º—ã
        if (data.favorites) {
            console.log('üì• Found favorites data:', data.favorites);
            
            if (data.favorites.categories) {
                S.favCatIds = new Set(data.favorites.categories);
                console.log('üì• Loaded favorite categories:', S.favCatIds.size);
            }
            
            if (data.favorites.themes) {
                S.favThemeIds = new Set(data.favorites.themes);
                console.log('üì• Loaded favorite themes:', S.favThemeIds.size);
            }
        } else {
            console.log('‚ö†Ô∏è No favorites data found in backup, keeping current favorites');
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à
        console.log('üíæ Saving loaded data to cache...');
        saveCachedData(data);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateUI();
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        const counts = getCollectionCounts();
        const message = `–í–µ—Ä—Å–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –∫—ç—à (${counts.totalParts} –¥–µ—Ç–∞–ª–µ–π, ${counts.totalSets} –Ω–∞–±–æ—Ä–æ–≤, ${counts.totalMinifigs} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫)`;
        updateCloudStorageStatus(message, 'success');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π
        debouncedLoadBackupsList(true, 1000); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

    } catch (error) {
        console.error('‚ùå Error loading specific backup:', error);
        updateCloudStorageStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–µ—Ä—Å–∏–∏', 'error');
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–µ—Ä—Å–∏–∏: ' + error.message);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
async function deleteBackup(key) {
    try {
        if (!cloudStorageConnected || !cloudStorageClient) {
            alert('–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ');
            return;
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–æ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∫–Ω–æ–ø–∫–∏

        updateCloudStorageStatus('–£–¥–∞–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–∏...', 'info');

        const client = cloudStorageClient.scope('/lego-catalog/');
        await client.remove(key);

        updateCloudStorageStatus('–í–µ—Ä—Å–∏—è —É–¥–∞–ª–µ–Ω–∞', 'success');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π
        debouncedLoadBackupsList(true, 500); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

    } catch (error) {
        console.error('‚ùå Error deleting backup:', error);
        updateCloudStorageStatus('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏', 'error');
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤–µ—Ä—Å–∏–∏: ' + error.message);
    }
}

let S = {
    view: 'collection',
    subView: 'parts',
    toolSubView: '',
    catTree: [],
    expCats: new Set,
    selCatId: null,
    selCollCatId: null,
    catGroups: null,
    favCatIds: new Set,
    themeTree: [],
    expThemes: new Set,
    selThemeId: null,
    selCollThemeId: null,
    setRes: null,
    favThemeIds: new Set,
    minifigRes: null,
    q: '',
    searchGroups: null,
    totalPartsInCatalog: 0, // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π –≤ –∫–∞—Ç–∞–ª–æ–≥–µ (–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/—Ç–µ–º—ã)
    totalSetsInCatalog: 0, // –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –Ω–∞–±–æ—Ä–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ (–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã)
    collectionSummaryExpanded: false, // –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ —Å–≤–æ–¥–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    analyticsData: null, // –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    analyticsLoading: false, // –§–ª–∞–≥ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    analyticsSubView: 'dashboard', // –ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: 'dashboard', 'parts', 'sets', 'minifigs'
    analyticsLastUpdate: 0, // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    collectionLastUpdate: 0, // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    tempRarityFilter: null, // –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏
    tempColorFilter: null, // –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ü–≤–µ—Ç—É
    tempCategoryFilter: null, // –í—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    searchSetRes: null,
    searchMinifigRes: null,
    loading: !1,
    sidebarLoading: !1,
    err: null,
    selPartId: null,
    selSetNum: null,
    selFigNum: null,
    showRelatedSets: false, // –§–ª–∞–≥ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ)
    randomMinifigImage: null, // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    lastMinifigNumber: null, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    longPressTriggered: false, // –§–ª–∞–≥ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—ã—á–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
    sidebarOpen: window.innerWidth >= 1024,
    gridStale: !0,
    hasMoreItems: false,
    partModal: {
        groupId: null,
        variants: [],
        selColorId: null,
        qty: 1,
        loadingColors: !1,
        loadingImg: !1,
        imgUrl: null
    },
    setModal: {
        loading: !1,
        inv: [],
        invPage: 1,
        hasNextInv: !1,
        qty: 1,
        bulkUpdate: !1,
        status: '',
        statusType: '',
        view: 'details',
        minifigs: [],
        loadingMinifigs: !1
    },
    minifigModal: {
        loading: !1,
        qty: 1,
        view: 'details',
        inv: null,
        loadingInv: !1,
        invError: !1,
        bulkUpdate: !1,
        status: '',
        statusType: ''
    },
    // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏/–∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏ (–≤–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, —á–∏—Ç–∞–µ–º –∏–∑ –∫—ç—à–∞)
    preventAccidentalExit: (function(){
        try {
            const v = localStorage.getItem('preventAccidentalExit');
            return v === null ? true : v === 'true';
        } catch { return true; }
    })(),
    // –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –∫–Ω–æ–ø–∫—É sidebar-toggle –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    showSidebarHint: (function(){
        try {
            const v = localStorage.getItem('showSidebarHint');
            return v === null ? true : v === 'true';
        } catch { return true; }
    })(),
    filterOpen: !1,
    settingsOpen: !1,
    settingsModal: {
        delConfirm: null,
        status: '',
        statusType: 'info'
    },
    toDisplay: 100,
    increment: 100,
    coll: {},
    setColl: {},
    minifigColl: {},
    filters: {
        colorIds: [],
        inCollectionOnly: !1
    },
    
    // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–¥–µ—Ä–∂–µ–∫ –∞–Ω–∏–º–∞—Ü–∏–π –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞
    getAnimationDelay: function(index) {
        // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –í–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö –¥–ª—è –ª—É—á—à–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞
        // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≤–æ–ª–Ω–æ–≤–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
        // const delay = Math.min(15 * index, 600);
        // return delay > 0 ? `animation-delay: ${delay}ms;` : '';
        return ''; // –ë–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏ –∞–Ω–∏–º–∞—Ü–∏–∏
    },
    

    setFilters: {
        minYear: '',
        maxYear: '',
        minParts: '',
        maxParts: ''
    },
    sortBy: 'popularity',
    // –ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä (—Å–º–µ—à–∞–Ω–Ω—ã–π)
    multiSelect: {
        active: !1,
        items: new Set, // –∫–ª—é—á–∏ –≤–∏–¥–∞: 'sets:1234', 'minifigs:fig-01', 'parts:3001:15' (–ø–æ—Å–ª–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ ‚Äî colorId)
        justActivated: !1
    },
    catalogMultiSelectEnabled: (localStorage.getItem('catalogMultiSelectEnabled') === 'true'),
    collectionMultiSelectEnabled: (localStorage.getItem('collectionMultiSelectEnabled') !== 'false'),
    collectionSummaryExpanded: (localStorage.getItem('collectionSummaryExpanded') === 'true'), // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞
    foldersEnabled: (localStorage.getItem('foldersEnabled') !== 'false'), // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ
    wishlistEnabled: (localStorage.getItem('wishlistEnabled') !== 'false'), // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ
    proxyEnabled: (localStorage.getItem('proxyEnabled') === 'true'), // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
    wishlists: {}, // –°–ø–∏—Å–∫–∏ –∂–µ–ª–∞–Ω–∏–π
    currentWishlist: null, // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    wishlistModal: { open: false, wishlistId: null, wishlist: null }, // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞
    expandedWishlists: [], // –†–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –ø–∞–ø–∫–∏ —Å–ø–∏—Å–∫–æ–≤ –∂–µ–ª–∞–Ω–∏–π
    // –ü–æ–∏—Å–∫ –∏ —Ä–µ–∂–∏–º—ã –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
    sidebarFilter: '',
    sidebarCompact: (function(){
        try { return localStorage.getItem('sidebarCompact') === 'true'; } catch { return false; }
    })(),
    sidebarRecent: [],
    sidebarMode: 'all',
    sidebarFavCollapsed: (function(){
        try { const v = localStorage.getItem('sidebarFavCollapsed'); return v === null ? true : v === 'true'; } catch { return true; }
    })(),
    sidebarFavsVisible: (function(){
        try { const v = localStorage.getItem('sidebarFavsVisible'); return v === 'true'; } catch { return false; }
    })()
};
let tempFilters = {
    filters: { colorIds: [], inCollectionOnly: false },
    setFilters: { minYear: "", maxYear: "", minParts: "", maxParts: "" },
    sortBy: 'popularity'
};

function loadState() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    resetRandomMinifigImage();
    
    console.log('üîÑ Loading state from localStorage...');
    
    const e = localStorage.getItem('legoCollection');
    console.log('üì¶ legoCollection in localStorage:', e ? 'exists' : 'missing', e ? `(${e.length} chars)` : '');
    if (e) try {
        const t = JSON.parse(e);
        "object" == typeof t && null !== t && (S.coll = t)
        console.log('‚úÖ Loaded parts collection:', Object.keys(S.coll).length, 'items');
    } catch (t) {
        console.error("Failed to parse lego collection from localStorage", t), S.coll = {}
    }
    const t = localStorage.getItem('legoSetCollection');
    console.log('üì¶ legoSetCollection in localStorage:', t ? 'exists' : 'missing', t ? `(${t.length} chars)` : '');
    if (t) try {
        const e = JSON.parse(t);
        "object" == typeof e && null !== e && (S.setColl = e)
        console.log('‚úÖ Loaded sets collection:', Object.keys(S.setColl).length, 'items');
    } catch (e) {
        console.error("Failed to parse lego set collection from localStorage", e), S.setColl = {}
    }
    

    // –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞–Ω–æ–≤–æ –∏–∑ CSV —Ñ–∞–π–ª–æ–≤
    console.log('User collections and favorites loaded from localStorage');
    
    const o = localStorage.getItem('legoMinifigCollection');
    console.log('üì¶ legoMinifigCollection in localStorage:', o ? 'exists' : 'missing', o ? `(${o.length} chars)` : '');
    if (o) try {
        const e = JSON.parse(o);
        "object" == typeof e && null !== e && (S.minifigColl = e)
        console.log('‚úÖ Loaded minifigs collection:', Object.keys(S.minifigColl).length, 'items');
    } catch (e) {
        console.error("Failed to parse lego minifig collection from localStorage", e), S.minifigColl = {}
    }
    const l = localStorage.getItem('favoriteCategoryIds');
    if (l) try {
        S.favCatIds = new Set(JSON.parse(l))
    } catch (e) {
        console.error("Failed to parse favorite categories from localStorage", e), S.favCatIds = new Set
    }
    const a = localStorage.getItem('favoriteThemeIds');
    if (a) try {
        S.favThemeIds = new Set(JSON.parse(a))
    } catch (e) {
        console.error("Failed to parse favorite themes from localStorage", e), S.favThemeIds = new Set
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–∫–∏ –∂–µ–ª–∞–Ω–∏–π
    const wishlistsData = localStorage.getItem('wishlists');
    if (wishlistsData) try {
        S.wishlists = JSON.parse(wishlistsData);
        console.log('‚úÖ Loaded wishlists:', Object.keys(S.wishlists).length, 'lists');
    } catch (e) {
        console.error("Failed to parse wishlists from localStorage", e), S.wishlists = {}
    }
    
    const currentWishlistData = localStorage.getItem('currentWishlist');
    if (currentWishlistData) {
        S.currentWishlist = currentWishlistData;
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã–µ –ø–∞–ø–∫–∏ —Å–ø–∏—Å–∫–æ–≤ –∂–µ–ª–∞–Ω–∏–π
    S.expandedWishlists = []; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∫ –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤
    const expandedWishlistsData = localStorage.getItem('expandedWishlists');
    console.log('üìÅ Raw expandedWishlistsData from localStorage:', expandedWishlistsData);
    
    if (expandedWishlistsData) try {
        S.expandedWishlists = JSON.parse(expandedWishlistsData);
        console.log('‚úÖ Loaded expanded wishlists:', S.expandedWishlists.length, 'folders:', S.expandedWishlists);
    } catch (e) {
        console.error("Failed to parse expandedWishlists from localStorage", e);
        S.expandedWishlists = [];
    }
    console.log('üìÅ Final expandedWishlists after load:', S.expandedWishlists);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    window.clearExpandedWishlists = function() {
        S.expandedWishlists = [];
        localStorage.removeItem('expandedWishlists');
        console.log('üßπ Cleared expandedWishlists');
        updateUI();
    };
    
    window.forceCollapseAll = function() {
        S.expandedWishlists = [];
        localStorage.setItem('expandedWishlists', JSON.stringify([]));
        console.log('üßπ Force collapsed all wishlists');
        updateUI();
    };
    
    window.debugWishlistState = function() {
        console.log('üîç Current wishlist state:');
        console.log('S.expandedWishlists:', S.expandedWishlists);
        console.log('localStorage expandedWishlists:', localStorage.getItem('expandedWishlists'));
        console.log('S.wishlists keys:', Object.keys(S.wishlists || {}));
    };
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const foldersEnabled = localStorage.getItem('foldersEnabled');
    if (foldersEnabled !== null) {
        S.foldersEnabled = foldersEnabled === 'true';
    }
}

function saveState() {
    localStorage.setItem('legoCollection', JSON.stringify(S.coll));
    localStorage.setItem('legoSetCollection', JSON.stringify(S.setColl));
    localStorage.setItem('legoMinifigCollection', JSON.stringify(S.minifigColl));
    localStorage.setItem('favoriteCategoryIds', JSON.stringify(Array.from(S.favCatIds)));
    localStorage.setItem('favoriteThemeIds', JSON.stringify(Array.from(S.favThemeIds)));
    try { localStorage.setItem('sidebarCompact', String(!!S.sidebarCompact)); } catch {}
    localStorage.setItem('wishlists', JSON.stringify(S.wishlists));
    localStorage.setItem('currentWishlist', S.currentWishlist);
        
    // –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∑–∞–Ω–æ–≤–æ –∏–∑ CSV —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ
    console.log('User collections and favorites saved to localStorage');
}

// –§—É–Ω–∫—Ü–∏–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–¥–∫–æ—Å—Ç–∏ –¥–µ—Ç–∞–ª–µ–π
// –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–¥–∫–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
function calculatePartRarity(partNum, colorId) {
    if (!PART_MAP[partNum]) {
        return 'unknown';
    }
    
    const part = PART_MAP[partNum];
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–º–±–∏–Ω–∞—Ü–∏—é —Ñ–∞–∫—Ç–æ—Ä–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–µ–¥–∫–æ—Å—Ç–∏
    let rarityScore = 0;
    
    // –§–∞–∫—Ç–æ—Ä 1: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–æ—Ä–æ–≤ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
    const numSets = parseInt(part.num_sets) || 0;
    if (numSets > 0) {
        if (numSets <= 10) rarityScore += 40;      // –û—á–µ–Ω—å —Ä–µ–¥–∫–∏–µ –≤ –Ω–∞–±–æ—Ä–∞—Ö
        else if (numSets <= 50) rarityScore += 30; // –†–µ–¥–∫–∏–µ –≤ –Ω–∞–±–æ—Ä–∞—Ö
        else if (numSets <= 200) rarityScore += 20; // –°—Ä–µ–¥–Ω–∏–µ –≤ –Ω–∞–±–æ—Ä–∞—Ö
        else if (numSets <= 500) rarityScore += 10; // –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –≤ –Ω–∞–±–æ—Ä–∞—Ö
        // –û—á–µ–Ω—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç –æ—á–∫–æ–≤
    }
    
    // –§–∞–∫—Ç–æ—Ä 2: –†–∞–∑–º–µ—Ä –¥–µ—Ç–∞–ª–∏ (–º–∞–ª–µ–Ω—å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –æ–±—ã—á–Ω–æ –±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω—ã)
    const partName = part.name || '';
    if (partName.includes('1 x 1') || partName.includes('1x1')) {
        rarityScore -= 10; // –ú–∞–ª–µ–Ω—å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –º–µ–Ω–µ–µ —Ä–µ–¥–∫–∏–µ
    } else if (partName.includes('1 x 2') || partName.includes('1x2')) {
        rarityScore -= 5; // –°—Ä–µ–¥–Ω–∏–µ –¥–µ—Ç–∞–ª–∏
    } else if (partName.includes('2 x 2') || partName.includes('2x2')) {
        rarityScore += 5; // –ë–æ–ª—å—à–∏–µ –¥–µ—Ç–∞–ª–∏ –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–µ
    } else if (partName.includes('4 x 4') || partName.includes('4x4') || 
               partName.includes('6 x 6') || partName.includes('6x6')) {
        rarityScore += 15; // –û—á–µ–Ω—å –±–æ–ª—å—à–∏–µ –¥–µ—Ç–∞–ª–∏
    }
    
    // –§–∞–∫—Ç–æ—Ä 3: –¢–∏–ø –¥–µ—Ç–∞–ª–∏ (—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–µ)
    if (partName.includes('Tile') || partName.includes('Plate')) {
        rarityScore -= 5; // –ü–ª–∏—Ç–∫–∏ –∏ –ø–ª–∞—Å—Ç–∏–Ω—ã –±–æ–ª–µ–µ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω—ã
    } else if (partName.includes('Brick')) {
        // –ö–∏—Ä–ø–∏—á–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã
    } else if (partName.includes('Technic') || partName.includes('Hinge') || 
               partName.includes('Gear') || partName.includes('Axle')) {
        rarityScore += 10; // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–µ
    } else if (partName.includes('Minifig') || partName.includes('Figure')) {
        rarityScore += 20; // –î–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –æ—á–µ–Ω—å —Ä–µ–¥–∫–∏–µ
    }
    
    // –§–∞–∫—Ç–æ—Ä 4: –¶–≤–µ—Ç (—Ä–µ–¥–∫–∏–µ —Ü–≤–µ—Ç–∞ —É–≤–µ–ª–∏—á–∏–≤–∞—é—Ç —Ä–µ–¥–∫–æ—Å—Ç—å)
    if (COLOR_MAP[colorId]) {
        const colorName = COLOR_MAP[colorId].name || '';
        if (colorName.includes('Trans') || colorName.includes('Chrome') || 
            colorName.includes('Pearl') || colorName.includes('Metallic')) {
            rarityScore += 15; // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –∏ –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ —Ü–≤–µ—Ç–∞ —Ä–µ–¥–∫–∏–µ
        } else if (colorName.includes('Bright') || colorName.includes('Neon')) {
            rarityScore += 5; // –Ø—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞ –Ω–µ–º–Ω–æ–≥–æ –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–µ
        }
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –±–∞–ª–ª–∞
    if (rarityScore >= 50) return 'legendary';    // –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è (‚â•50 –±–∞–ª–ª–æ–≤)
    if (rarityScore >= 30) return 'epic';         // –≠–ø–∏—á–µ—Å–∫–∞—è (30-49 –±–∞–ª–ª–æ–≤)
    if (rarityScore >= 15) return 'rare';         // –†–µ–¥–∫–∞—è (15-29 –±–∞–ª–ª–æ–≤)
    if (rarityScore >= 5) return 'uncommon';      // –ù–µ–æ–±—ã—á–Ω–∞—è (5-14 –±–∞–ª–ª–æ–≤)
    return 'common';                               // –û–±—ã—á–Ω–∞—è (<5 –±–∞–ª–ª–æ–≤)
}

function getRarityColor(rarity) {
    const colors = {
        'legendary': '#FFD700',  // –ó–æ–ª–æ—Ç–æ–π
        'epic': '#9D4EDD',      // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
        'rare': '#0077BE',      // –°–∏–Ω–∏–π
        'uncommon': '#2ECC71',  // –ó–µ–ª–µ–Ω—ã–π
        'common': '#95A5A6',    // –°–µ—Ä—ã–π
        'unknown': '#7F8C8D'    // –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π
    };
    return colors[rarity] || colors['unknown'];
}

function getRarityName(rarity) {
    const names = {
        'legendary': '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è',
        'epic': '–≠–ø–∏—á–µ—Å–∫–∞—è',
        'rare': '–†–µ–¥–∫–∞—è',
        'uncommon': '–ù–µ–æ–±—ã—á–Ω–∞—è',
        'common': '–û–±—ã—á–Ω–∞—è',
        'unknown': '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
    };
    return names[rarity] || names['unknown'];
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–∫–ª–æ–Ω–µ–Ω–∏—è —Å–ª–æ–≤
function pluralize(count, forms) {
    const cases = [2, 0, 1, 1, 1, 2];
    const index = (count % 100 > 4 && count % 100 < 20) ? 2 : cases[Math.min(count % 10, 5)];
    return forms[index];
}

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–∏–∫–∏ —Ä–µ–¥–∫–æ—Å—Ç–∏
function testRarityLogic() {
    console.log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ä–µ–¥–∫–æ—Å—Ç–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...');
    
    // –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    const testMinifigs = [
        {
            name: 'VIP Exclusive Gold Minifigure',
            set_num: 'VIP-001',
            theme_id: 1,
            year: 2010,
            num_parts: 25,
            minifig_img_url: 'test.jpg'
        },
        {
            name: 'Collectible Minifigure Series 1',
            set_num: 'COL-001',
            theme_id: 2,
            year: 2020,
            num_parts: 5,
            minifig_img_url: 'test.jpg'
        },
        {
            name: 'Regular Minifigure',
            set_num: 'REG-123',
            theme_id: 3,
            year: 2023,
            num_parts: 3,
            minifig_img_url: 'test.jpg'
        },
        {
            name: 'Star Wars Darth Vader',
            set_num: 'SW-456',
            theme_id: 4,
            year: 2015,
            num_parts: 8,
            minifig_img_url: 'test.jpg'
        }
    ];
    
    testMinifigs.forEach((minifig, index) => {
        console.log(`\nüß™ –¢–µ—Å—Ç ${index + 1}: ${minifig.name}`);
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        const originalCalculate = calculateMinifigRarity;
        
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –≤–µ—Ä—Å–∏—é
        function testCalculateMinifigRarity(testMinifig) {
            let rarityScore = 0;
            const debugInfo = {
                name: testMinifig.name,
                set_num: testMinifig.set_num,
                theme_id: testMinifig.theme_id,
                year: testMinifig.year,
                num_parts: testMinifig.num_parts,
                factors: {}
            };
            
            // –§–∞–∫—Ç–æ—Ä 1: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π
            const numParts = testMinifig.num_parts || 0;
            if (numParts > 0) {
                if (numParts >= 20) {
                    rarityScore += 30;
                    debugInfo.factors.numParts = { score: 30, reason: '–û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–µ (20+ –¥–µ—Ç–∞–ª–µ–π)' };
                } else if (numParts >= 15) {
                    rarityScore += 25;
                    debugInfo.factors.numParts = { score: 25, reason: '–°–ª–æ–∂–Ω—ã–µ (15-19 –¥–µ—Ç–∞–ª–µ–π)' };
                } else if (numParts >= 10) {
                    rarityScore += 15;
                    debugInfo.factors.numParts = { score: 15, reason: '–°—Ä–µ–¥–Ω–∏–µ (10-14 –¥–µ—Ç–∞–ª–µ–π)' };
                } else if (numParts >= 5) {
                    rarityScore += 5;
                    debugInfo.factors.numParts = { score: 5, reason: '–ü—Ä–æ—Å—Ç—ã–µ (5-9 –¥–µ—Ç–∞–ª–µ–π)' };
                }
            }
            
            // –§–∞–∫—Ç–æ—Ä 2: –ù–∞–∑–≤–∞–Ω–∏–µ
            const minifigName = testMinifig.name || '';
            if (minifigName.includes('VIP') || minifigName.includes('Promotional')) {
                rarityScore += 35;
                debugInfo.factors.name = { score: 35, reason: 'VIP/–ø—Ä–æ–º–æ –Ω–∞–∑–≤–∞–Ω–∏—è' };
            } else if (minifigName.includes('Gold') || minifigName.includes('Silver')) {
                rarityScore += 30;
                debugInfo.factors.name = { score: 30, reason: '–ó–æ–ª–æ—Ç—ã–µ/—Å–µ—Ä–µ–±—Ä—è–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è' };
            } else if (minifigName.includes('Collectible') || minifigName.includes('Collector')) {
                rarityScore += 25;
                debugInfo.factors.name = { score: 25, reason: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è' };
            } else {
                debugInfo.factors.name = { score: 0, reason: '–û–±—ã—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ' };
            }
            
            // –§–∞–∫—Ç–æ—Ä 3: –ì–æ–¥
            const year = testMinifig.year || 0;
            if (year > 0) {
                const currentYear = new Date().getFullYear();
                const age = currentYear - year;
                if (age >= 20) {
                    rarityScore += 20;
                    debugInfo.factors.year = { score: 20, reason: `–û—á–µ–Ω—å —Å—Ç–∞—Ä—ã–µ (${age} –ª–µ—Ç)` };
                } else if (age >= 15) {
                    rarityScore += 15;
                    debugInfo.factors.year = { score: 15, reason: `–°—Ç–∞—Ä—ã–µ (${age} –ª–µ—Ç)` };
                } else if (age >= 10) {
                    rarityScore += 10;
                    debugInfo.factors.year = { score: 10, reason: `–°—Ä–µ–¥–Ω–∏–µ (${age} –ª–µ—Ç)` };
                } else if (age >= 5) {
                    rarityScore += 5;
                    debugInfo.factors.year = { score: 5, reason: `–ù–æ–≤—ã–µ (${age} –ª–µ—Ç)` };
                }
            }
            
            // –§–∞–∫—Ç–æ—Ä 4: –¢–µ–º–∞ (–æ—Ç–∫–ª—é—á–µ–Ω–æ)
            debugInfo.factors.theme = { score: 0, reason: '–¢–µ–º–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è' };
            
            // –§–∞–∫—Ç–æ—Ä 5: –ù–æ–º–µ—Ä —Å–µ—Ä–∏–∏
            const setNum = testMinifig.set_num || '';
            let setNumScore = 0;
            if (setNum.includes('VIP') || setNum.includes('PROMO')) {
                setNumScore += 35;
            } else if (setNum.includes('COL') || setNum.includes('COLLECTIBLE')) {
                setNumScore += 25;
            } else if (setNum.includes('SW')) {
                setNumScore += 10;
            }
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
            if (setNum.match(/^(\d{3,4})$/)) {
                const num = parseInt(setNum.match(/^(\d{3,4})$/)[1], 10);
                if (num === 1 || num === 10 || num === 100 || num === 1000) {
                    setNumScore += 25;
                } else if (num === 2 || num === 20 || num === 200 || num === 2000) {
                    setNumScore += 20;
                }
            }
            
            rarityScore += setNumScore;
            debugInfo.factors.setNum = { score: setNumScore, reason: `–ù–æ–º–µ—Ä: ${setNum}` };
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å
            let rarity;
            if (rarityScore >= 100) rarity = 'legendary';
            else if (rarityScore >= 80) rarity = 'epic';
            else if (rarityScore >= 60) rarity = 'rare';
            else if (rarityScore >= 40) rarity = 'uncommon';
            else rarity = 'common';
            
            debugInfo.totalScore = rarityScore;
            debugInfo.rarity = rarity;
            
            return { rarity, debugInfo };
        }
        
        const result = testCalculateMinifigRarity(minifig);
    });
    
    console.log('\n‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function testUserMinifigs() {
    console.log('üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
    
    // –î–∞–Ω–Ω—ã–µ –∏–∑ CSV –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userMinifigs = [
        { id: 'fig-014293', name: 'Ahsoka Tano', parts: 4 },
        { id: 'fig-014806', name: 'Arc Trooper Fives', parts: 7 },
        { id: 'fig-012921', name: 'Astromech Droid, R4-P17, Light Blue Rectangles', parts: 4 },
        { id: 'fig-015729', name: 'Astromech Droid, R5-D4, Dark Blue Center Panel', parts: 4 },
        { id: 'fig-015705', name: 'Astronomer Kid', parts: 4 },
        { id: 'fig-002330', name: 'Battle Droid, One Bent Arm, One Straight Arm', parts: 5 },
        { id: 'fig-003867', name: 'Clone ARC Trooper / Elite Clone Trooper with Neck Bracket (Commander Hammer)', parts: 8 },
        { id: 'fig-003866', name: 'Clone ARF Trooper / Elite Clone Trooper (Rancor Battalion)', parts: 4 },
        { id: 'fig-014993', name: 'Clone Trooper, 501st Legion, White Arms', parts: 4 },
        { id: 'fig-002506', name: 'Commando Droid', parts: 5 },
        { id: 'fig-015710', name: 'Cupid', parts: 6 },
        { id: 'fig-010514', name: 'Draco Malfoy, Closed Slytherin Robes with Crest, Short Legs', parts: 4 },
        { id: 'fig-015004', name: 'Droideka / Destroyer Droid', parts: 30 },
        { id: 'fig-015902', name: 'Gilderoy Lockhart, Light Bluish Gray Duelling Suit', parts: 5 },
        { id: 'fig-010525', name: 'Grogu / The Child (Baby Yoda)', parts: 2 },
        { id: 'fig-014647', name: 'Harpy', parts: 9 },
        { id: 'fig-011589', name: 'Harry Potter, Gryffindor Robes Open, Short Legs (3626c Head)', parts: 4 },
        { id: 'fig-015064', name: 'Imperial Praetorian Guard', parts: 4 },
        { id: 'fig-015704', name: 'Jetpack Racer', parts: 5 },
        { id: 'fig-015455', name: 'Leia - Ugly Christmas Sweater', parts: 4 },
        { id: 'fig-015457', name: 'Luke Skywalker - Ugly Christmas Sweater', parts: 4 },
        { id: 'fig-001061', name: 'Magician (CMF)', parts: 5 },
        { id: 'fig-012924', name: 'Obi-Wan Kenobi - Reddish Brown Robe, Long Hair', parts: 4 },
        { id: 'fig-015711', name: 'Pirate Quartermaster', parts: 5 },
        { id: 'fig-015094', name: 'Professor Severus Snape, Long Robes over Black Vest', parts: 4 },
        { id: 'fig-010827', name: 'Spider-Man, Printed Arms', parts: 3 },
        { id: 'fig-002118', name: 'Steve', parts: 3 },
        { id: 'fig-004063', name: 'Stormtrooper, Dark Azure Helmet Vents, Angry (Rebels)', parts: 4 },
        { id: 'fig-014665', name: 'Super Battle Droid, Updated Version', parts: 4 },
        { id: 'fig-012922', name: 'Taun We', parts: 3 },
        { id: 'fig-015880', name: 'The Mandalorian / Din Djarin, Dark Brown Outfit, 87610pr0012 Helmet', parts: 5 },
        { id: 'fig-005492', name: 'Venom with Open Mouth', parts: 3 }
    ];
    
    // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É
    const results = userMinifigs.map(minifig => {
        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ CSV
        const testMinifig = {
            name: minifig.name,
            set_num: minifig.id,
            theme_id: undefined, // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ–º–µ
            year: undefined, // –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥–æ–¥–µ
            num_parts: minifig.parts,
            minifig_img_url: 'test.jpg'
        };
        
        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å
        let rarityScore = 0;
        const debugInfo = {
            name: testMinifig.name,
            set_num: testMinifig.set_num,
            theme_id: testMinifig.theme_id,
            year: testMinifig.year,
            num_parts: testMinifig.num_parts,
            factors: {}
        };
        
        // –§–∞–∫—Ç–æ—Ä 1: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π
        const numParts = testMinifig.num_parts || 0;
        if (numParts > 0) {
            if (numParts >= 20) {
                rarityScore += 30;
                debugInfo.factors.numParts = { score: 30, reason: '–û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–µ (20+ –¥–µ—Ç–∞–ª–µ–π)' };
            } else if (numParts >= 15) {
                rarityScore += 25;
                debugInfo.factors.numParts = { score: 25, reason: '–°–ª–æ–∂–Ω—ã–µ (15-19 –¥–µ—Ç–∞–ª–µ–π)' };
            } else if (numParts >= 10) {
                rarityScore += 15;
                debugInfo.factors.numParts = { score: 15, reason: '–°—Ä–µ–¥–Ω–∏–µ (10-14 –¥–µ—Ç–∞–ª–µ–π)' };
            } else if (numParts >= 5) {
                rarityScore += 5;
                debugInfo.factors.numParts = { score: 5, reason: '–ü—Ä–æ—Å—Ç—ã–µ (5-9 –¥–µ—Ç–∞–ª–µ–π)' };
            }
        }
        
        // –§–∞–∫—Ç–æ—Ä 2: –ù–∞–∑–≤–∞–Ω–∏–µ
        const minifigName = testMinifig.name || '';
        if (minifigName.includes('VIP') || minifigName.includes('Promotional')) {
            rarityScore += 35;
            debugInfo.factors.name = { score: 35, reason: 'VIP/–ø—Ä–æ–º–æ –Ω–∞–∑–≤–∞–Ω–∏—è' };
        } else if (minifigName.includes('Gold') || minifigName.includes('Silver')) {
            rarityScore += 30;
            debugInfo.factors.name = { score: 30, reason: '–ó–æ–ª–æ—Ç—ã–µ/—Å–µ—Ä–µ–±—Ä—è–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è' };
        } else if (minifigName.includes('Collectible') || minifigName.includes('Collector') || minifigName.includes('CMF')) {
            rarityScore += 25;
            debugInfo.factors.name = { score: 25, reason: '–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è' };
        } else {
            debugInfo.factors.name = { score: 0, reason: '–û–±—ã—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ' };
        }
        
        // –§–∞–∫—Ç–æ—Ä 3: –ì–æ–¥ (—Å–∏–º—É–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤)
        // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–º–µ—Ä–Ω—ã–µ –≥–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏–π
        let year = 0;
        let yearSource = '—Å–∏–º—É–ª—è—Ü–∏—è';
        
        // –°–∏–º—É–ª–∏—Ä—É–µ–º –≥–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        if (minifigName.includes('Clone') || minifigName.includes('Battle Droid') || minifigName.includes('Commando Droid')) {
            year = 2008; // –°—Ç–∞—Ä—ã–µ Star Wars –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        } else if (minifigName.includes('Harry Potter') || minifigName.includes('Draco') || minifigName.includes('Gilderoy') || minifigName.includes('Severus')) {
            year = 2010; // Harry Potter –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        } else if (minifigName.includes('Spider-Man') || minifigName.includes('Venom')) {
            year = 2012; // Marvel –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        } else if (minifigName.includes('Steve')) {
            year = 2014; // Minecraft –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        } else if (minifigName.includes('The Mandalorian') || minifigName.includes('Grogu')) {
            year = 2020; // –ù–æ–≤—ã–µ Star Wars –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        } else if (minifigName.includes('Christmas') || minifigName.includes('Ugly')) {
            year = 2021; // –ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        } else if (minifigName.includes('CMF') || minifigName.includes('Magician')) {
            year = 2015; // –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        } else {
            year = 2018; // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        }
        
        if (year > 0) {
            const currentYear = new Date().getFullYear();
            const age = currentYear - year;
            if (age >= 20) {
                rarityScore += 20;
                debugInfo.factors.year = { score: 20, reason: `–û—á–µ–Ω—å —Å—Ç–∞—Ä—ã–µ (${age} –ª–µ—Ç, ${yearSource})` };
            } else if (age >= 15) {
                rarityScore += 15;
                debugInfo.factors.year = { score: 15, reason: `–°—Ç–∞—Ä—ã–µ (${age} –ª–µ—Ç, ${yearSource})` };
            } else if (age >= 10) {
                rarityScore += 10;
                debugInfo.factors.year = { score: 10, reason: `–°—Ä–µ–¥–Ω–∏–µ (${age} –ª–µ—Ç, ${yearSource})` };
            } else if (age >= 5) {
                rarityScore += 5;
                debugInfo.factors.year = { score: 5, reason: `–ù–æ–≤—ã–µ (${age} –ª–µ—Ç, ${yearSource})` };
            } else {
                debugInfo.factors.year = { score: 0, reason: `–û—á–µ–Ω—å –Ω–æ–≤—ã–µ (${age} –ª–µ—Ç, ${yearSource})` };
            }
        } else {
            debugInfo.factors.year = { score: 0, reason: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥–æ–¥–µ' };
        }
        
        // –§–∞–∫—Ç–æ—Ä 4: –¢–µ–º–∞ (–æ—Ç–∫–ª—é—á–µ–Ω–æ)
        debugInfo.factors.theme = { score: 0, reason: '–¢–µ–º–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è' };
        
        // –§–∞–∫—Ç–æ—Ä 5: –ù–æ–º–µ—Ä —Å–µ—Ä–∏–∏
        const setNum = testMinifig.set_num || '';
        let setNumScore = 0;
        if (setNum.includes('VIP') || setNum.includes('PROMO')) {
            setNumScore += 35;
        } else if (setNum.includes('COL') || setNum.includes('COLLECTIBLE')) {
            setNumScore += 25;
        } else if (setNum.includes('SW')) {
            setNumScore += 10;
        }
        
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
        if (setNum.match(/^(\d{3,4})$/)) {
            const num = parseInt(setNum.match(/^(\d{3,4})$/)[1], 10);
            if (num === 1 || num === 10 || num === 100 || num === 1000) {
                setNumScore += 25;
            } else if (num === 2 || num === 20 || num === 200 || num === 2000) {
                setNumScore += 20;
            }
        }
        
        rarityScore += setNumScore;
        debugInfo.factors.setNum = { score: setNumScore, reason: `–ù–æ–º–µ—Ä: ${setNum}` };
        
        // –§–∞–∫—Ç–æ—Ä 6: –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        let nameScore = 0;
        if (minifigName.includes('Collectible') || minifigName.includes('Collector')) {
            nameScore += 25;
        } else if (minifigName.includes('Series') || minifigName.includes('Serie')) {
            nameScore += 20;
        } else if (minifigName.includes('Blind') || minifigName.includes('Bag')) {
            nameScore += 15;
        } else if (minifigName.includes('Polybag') || minifigName.includes('Poly')) {
            nameScore += 10;
        }
        
        rarityScore += nameScore;
        debugInfo.factors.nameSeries = { score: nameScore, reason: `–ù–∞–∑–≤–∞–Ω–∏–µ: ${minifigName}` };
        
        // –§–∞–∫—Ç–æ—Ä 7: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        debugInfo.factors.image = { score: 0, reason: '–ï—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' };
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å
        let rarity;
        if (rarityScore >= 100) rarity = 'legendary';
        else if (rarityScore >= 80) rarity = 'epic';
        else if (rarityScore >= 60) rarity = 'rare';
        else if (rarityScore >= 40) rarity = 'uncommon';
        else rarity = 'common';
        
        // –û–±–Ω–æ–≤–ª—è–µ–º debugInfo —Å –∏—Ç–æ–≥–æ–≤—ã–º –±–∞–ª–ª–æ–º
        debugInfo.totalScore = rarityScore;
        debugInfo.rarity = rarity;
        
        return {
            id: minifig.id,
            name: minifig.name,
            parts: minifig.parts,
            rarity: rarity,
            score: rarityScore,
            debugInfo: debugInfo
        };
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ –∏ –±–∞–ª–ª–∞–º
    results.sort((a, b) => {
        const rarityOrder = { 'legendary': 0, 'epic': 1, 'rare': 2, 'uncommon': 3, 'common': 4 };
        const aOrder = rarityOrder[a.rarity] || 999;
        const bOrder = rarityOrder[b.rarity] || 999;
        if (aOrder !== bOrder) return aOrder - bOrder;
        return b.score - a.score;
    });
    
    results.forEach((minifig, index) => {
        console.log(`${index + 1}. ${minifig.name} (${minifig.parts} –¥–µ—Ç–∞–ª–µ–π) - ${minifig.rarity} (${minifig.score} –±–∞–ª–ª–æ–≤)`);
    });
    
    console.log('\nüîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç–æ–ø-5:');
    results.slice(0, 5).forEach((minifig, index) => {
        console.log(`\n${index + 1}. ${minifig.name} (${minifig.parts} –¥–µ—Ç–∞–ª–µ–π):`);
        console.log(`   –ò—Ç–æ–≥–æ–≤—ã–π –±–∞–ª–ª: ${minifig.score}`);
        console.log(`   –†–µ–¥–∫–æ—Å—Ç—å: ${minifig.rarity}`);
        console.log('   –§–∞–∫—Ç–æ—Ä—ã:');
        Object.entries(minifig.debugInfo.factors).forEach(([key, factor]) => {
            console.log(`     ${key}: ${factor.score} –±–∞–ª–ª–æ–≤ - ${factor.reason}`);
        });
    });
    
    return results;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
function forceUpdateAnalytics() {
    console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É...');
    S.analyticsData = null;
    S.analyticsLastUpdate = 0;
    S.analyticsLoading = false;
    analyzeCollection();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
function checkAnalyticsState() {
    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:');
    console.log('S.analyticsData:', S.analyticsData ? '–µ—Å—Ç—å' : '–Ω–µ—Ç');
    console.log('S.analyticsLoading:', S.analyticsLoading);
    console.log('S.analyticsLastUpdate:', S.analyticsLastUpdate);
    
    if (S.analyticsData && S.analyticsData.minifigsStats) {
        S.analyticsData.minifigsStats.topRareMinifigs?.slice(0, 5).forEach((minifig, index) => {
            console.log(`${index + 1}. ${minifig.minifigName} - ${minifig.rarityName} (${minifig.rarity})`);
        });
    }
}

// –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
window.testRarityLogic = testRarityLogic;
window.testUserMinifigs = testUserMinifigs;
window.forceUpdateAnalytics = forceUpdateAnalytics;
window.checkAnalyticsState = checkAnalyticsState;

// –î—É–±–ª–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
window.forceUpdateAnalytics = function() {
    console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É...');
    S.analyticsData = null;
    S.analyticsLastUpdate = 0;
    S.analyticsLoading = false;
    analyzeCollection();
};

window.checkAnalyticsState = function() {
    console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏:');
    console.log('S.analyticsData:', S.analyticsData ? '–µ—Å—Ç—å' : '–Ω–µ—Ç');
    console.log('S.analyticsLoading:', S.analyticsLoading);
    console.log('S.analyticsLastUpdate:', S.analyticsLastUpdate);
    
    if (S.analyticsData && S.analyticsData.minifigsStats) {
        S.analyticsData.minifigsStats.topRareMinifigs?.slice(0, 5).forEach((minifig, index) => {
            console.log(`${index + 1}. ${minifig.minifigName} - ${minifig.rarityName} (${minifig.rarity})`);
        });
    }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–¥–∫–æ—Å—Ç–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
function calculateMinifigRarity(minifigNum) {
    const minifig = MINIFIG_MAP[minifigNum];
    if (!minifig) return 'unknown';
    
    let rarityScore = 0;
    const debugInfo = {
        minifigNum,
        name: minifig.name,
        set_num: minifig.set_num,
        theme_id: minifig.theme_id,
        year: minifig.year,
        num_parts: minifig.num_parts,
        factors: {}
    };
    
    // –§–∞–∫—Ç–æ—Ä 1: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π (–±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π = –±–æ–ª–µ–µ —Ä–µ–¥–∫–∞—è)
    const numParts = minifig.num_parts || 0;
    if (numParts > 0) {
        if (numParts >= 20) {
            rarityScore += 30;      // –û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
            debugInfo.factors.numParts = { score: 30, reason: '–û—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–µ (20+ –¥–µ—Ç–∞–ª–µ–π)' };
        } else if (numParts >= 15) {
            rarityScore += 25;  // –°–ª–æ–∂–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
            debugInfo.factors.numParts = { score: 25, reason: '–°–ª–æ–∂–Ω—ã–µ (15-19 –¥–µ—Ç–∞–ª–µ–π)' };
        } else if (numParts >= 10) {
            rarityScore += 15;  // –°—Ä–µ–¥–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
            debugInfo.factors.numParts = { score: 15, reason: '–°—Ä–µ–¥–Ω–∏–µ (10-14 –¥–µ—Ç–∞–ª–µ–π)' };
        } else if (numParts >= 5) {
            rarityScore += 5;    // –ü—Ä–æ—Å—Ç—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
            debugInfo.factors.numParts = { score: 5, reason: '–ü—Ä–æ—Å—Ç—ã–µ (5-9 –¥–µ—Ç–∞–ª–µ–π)' };
        }
    } else {
        debugInfo.factors.numParts = { score: 0, reason: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ç–∞–ª—è—Ö' };
    }
    
    // –§–∞–∫—Ç–æ—Ä 2: –ù–∞–∑–≤–∞–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ (—Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–µ)
    const minifigName = minifig.name || '';
    if (minifigName.includes('Exclusive') || minifigName.includes('Limited') || minifigName.includes('Special')) {
        rarityScore += 25; // –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        debugInfo.factors.name = { score: 25, reason: '–≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è' };
    } else if (minifigName.includes('Chrome') || minifigName.includes('Metallic') || minifigName.includes('Pearl')) {
        rarityScore += 20; // –ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        debugInfo.factors.name = { score: 20, reason: '–ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è' };
    } else if (minifigName.includes('Transparent') || minifigName.includes('Clear')) {
        rarityScore += 15; // –ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        debugInfo.factors.name = { score: 15, reason: '–ü—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è' };
    } else if (minifigName.includes('Gold') || minifigName.includes('Silver')) {
        rarityScore += 30; // –ó–æ–ª–æ—Ç—ã–µ –∏ —Å–µ—Ä–µ–±—Ä—è–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        debugInfo.factors.name = { score: 30, reason: '–ó–æ–ª–æ—Ç—ã–µ/—Å–µ—Ä–µ–±—Ä—è–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è' };
    } else if (minifigName.includes('VIP') || minifigName.includes('Promotional')) {
        rarityScore += 35; // VIP –∏ –ø—Ä–æ–º–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        debugInfo.factors.name = { score: 35, reason: 'VIP/–ø—Ä–æ–º–æ –Ω–∞–∑–≤–∞–Ω–∏—è' };
    } else {
        debugInfo.factors.name = { score: 0, reason: '–û–±—ã—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ' };
    }
    
    // –§–∞–∫—Ç–æ—Ä 3: –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ (—Å—Ç–∞—Ä—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–µ)
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥–æ–¥ –ø–æ —Å–∞–º–æ–º—É —Å—Ç–∞—Ä–æ–º—É —Å–≤—è–∑–∞–Ω–Ω–æ–º—É –Ω–∞–±–æ—Ä—É
    let year = minifig.year || 0;
    let yearSource = 'API';
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –≥–æ–¥–∞ –∏–∑ API, –∏—â–µ–º –≤ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–∞—Ö
    if (!year) {
        const relatedSets = Object.values(S.setColl).filter(set => 
            set.minifigs && set.minifigs.some(m => m.minifigNum === minifigNum)
        );
        
        if (relatedSets.length > 0) {
            // –ù–∞—Ö–æ–¥–∏–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π –Ω–∞–±–æ—Ä
            const oldestSet = relatedSets.reduce((oldest, current) => {
                const currentYear = parseInt(current.year) || 0;
                const oldestYear = parseInt(oldest.year) || 0;
                return currentYear > 0 && (oldestYear === 0 || currentYear < oldestYear) ? current : oldest;
            });
            
            year = parseInt(oldestSet.year) || 0;
            yearSource = '—Å–≤—è–∑–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä';
            debugInfo.factors.year = { 
                score: 0, 
                reason: `–ì–æ–¥ –Ω–∞–π–¥–µ–Ω –≤ —Å–≤—è–∑–∞–Ω–Ω–æ–º –Ω–∞–±–æ—Ä–µ: ${oldestSet.setNum} (${year})` 
            };
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤, —Å–∏–º—É–ª–∏—Ä—É–µ–º –≥–æ–¥ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–∑–≤–∞–Ω–∏—è
            const minifigName = minifig.name || '';
            if (minifigName.includes('Clone') || minifigName.includes('Battle Droid') || minifigName.includes('Commando Droid')) {
                year = 2008; // –°—Ç–∞—Ä—ã–µ Star Wars –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                yearSource = '—Å–∏–º—É–ª—è—Ü–∏—è (Star Wars)';
            } else if (minifigName.includes('Harry Potter') || minifigName.includes('Draco') || minifigName.includes('Gilderoy') || minifigName.includes('Severus')) {
                year = 2010; // Harry Potter –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                yearSource = '—Å–∏–º—É–ª—è—Ü–∏—è (Harry Potter)';
            } else if (minifigName.includes('Spider-Man') || minifigName.includes('Venom')) {
                year = 2012; // Marvel –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                yearSource = '—Å–∏–º—É–ª—è—Ü–∏—è (Marvel)';
            } else if (minifigName.includes('Steve')) {
                year = 2014; // Minecraft –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                yearSource = '—Å–∏–º—É–ª—è—Ü–∏—è (Minecraft)';
            } else if (minifigName.includes('The Mandalorian') || minifigName.includes('Grogu')) {
                year = 2020; // –ù–æ–≤—ã–µ Star Wars –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                yearSource = '—Å–∏–º—É–ª—è—Ü–∏—è (Mandalorian)';
            } else if (minifigName.includes('Christmas') || minifigName.includes('Ugly')) {
                year = 2021; // –ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                yearSource = '—Å–∏–º—É–ª—è—Ü–∏—è (Christmas)';
            } else if (minifigName.includes('CMF') || minifigName.includes('Magician')) {
                year = 2015; // –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                yearSource = '—Å–∏–º—É–ª—è—Ü–∏—è (CMF)';
            } else {
                year = 2018; // –û—Å—Ç–∞–ª—å–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                yearSource = '—Å–∏–º—É–ª—è—Ü–∏—è (–æ–±—â–∏–µ)';
            }
            
            debugInfo.factors.year = { 
                score: 0, 
                reason: `–ì–æ–¥ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω: ${year} (${yearSource})` 
            };
        }
    }
    
    if (year > 0) {
        const currentYear = new Date().getFullYear();
        const age = currentYear - year;
        if (age >= 20) {
            rarityScore += 20;      // –û—á–µ–Ω—å —Å—Ç–∞—Ä—ã–µ (20+ –ª–µ—Ç)
            debugInfo.factors.year = { score: 20, reason: `–û—á–µ–Ω—å —Å—Ç–∞—Ä—ã–µ (${age} –ª–µ—Ç, ${yearSource})` };
        } else if (age >= 15) {
            rarityScore += 15; // –°—Ç–∞—Ä—ã–µ (15-19 –ª–µ—Ç)
            debugInfo.factors.year = { score: 15, reason: `–°—Ç–∞—Ä—ã–µ (${age} –ª–µ—Ç, ${yearSource})` };
        } else if (age >= 10) {
            rarityScore += 10; // –°—Ä–µ–¥–Ω–∏–µ (10-14 –ª–µ—Ç)
            debugInfo.factors.year = { score: 10, reason: `–°—Ä–µ–¥–Ω–∏–µ (${age} –ª–µ—Ç, ${yearSource})` };
        } else if (age >= 5) {
            rarityScore += 5;   // –ù–æ–≤—ã–µ (5-9 –ª–µ—Ç)
            debugInfo.factors.year = { score: 5, reason: `–ù–æ–≤—ã–µ (${age} –ª–µ—Ç, ${yearSource})` };
        } else {
            debugInfo.factors.year = { score: 0, reason: `–û—á–µ–Ω—å –Ω–æ–≤—ã–µ (${age} –ª–µ—Ç, ${yearSource})` };
        }
    } else {
        debugInfo.factors.year = { score: 0, reason: '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥–æ–¥–µ' };
    }
    
    // –§–∞–∫—Ç–æ—Ä 4: –¢–µ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–¥–∫–æ—Å—Ç—å (–æ—Ç–∫–ª—é—á–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    // –¢–µ–º–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–∞—Å—á–µ—Ç–µ —Ä–µ–¥–∫–æ—Å—Ç–∏
    debugInfo.factors.theme = { score: 0, reason: '–¢–µ–º–∞ –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è' };
    
    // –§–∞–∫—Ç–æ—Ä 5: –ù–æ–º–µ—Ä —Å–µ—Ä–∏–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏
    const setNum = minifig.set_num || '';
    let setNumScore = 0;
    
    if (setNum) {
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ —Å–µ—Ä–∏–π
        if (setNum.includes('VIP') || setNum.includes('PROMO')) {
            setNumScore += 35; // VIP –∏ –ø—Ä–æ–º–æ –Ω–æ–º–µ—Ä–∞
        } else if (setNum.includes('EXCLUSIVE') || setNum.includes('LIMITED')) {
            setNumScore += 30; // –≠–∫—Å–∫–ª—é–∑–∏–≤–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
        } else if (setNum.includes('CONVENTION') || setNum.includes('EVENT')) {
            setNumScore += 40; // –ö–æ–Ω–≤–µ–Ω—Ü–∏–æ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
        } else if (setNum.includes('COLLECTIBLE') || setNum.includes('COLLECTOR')) {
            setNumScore += 25; // –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
        }
        
        // –ù–æ–º–µ—Ä–∞ —Å –æ—Å–æ–±—ã–º–∏ –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏
        if (setNum.startsWith('VIP') || setNum.startsWith('PROMO')) {
            setNumScore += 30; // VIP/PROMO –ø—Ä–µ—Ñ–∏–∫—Å—ã
        } else if (setNum.startsWith('EX') || setNum.startsWith('LIM')) {
            setNumScore += 25; // EXCLUSIVE/LIMITED –ø—Ä–µ—Ñ–∏–∫—Å—ã
        } else if (setNum.startsWith('CON') || setNum.startsWith('EVT')) {
            setNumScore += 35; // CONVENTION/EVENT –ø—Ä–µ—Ñ–∏–∫—Å—ã
        }
        
        // –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        if (setNum.includes('COLLECTIBLE') || setNum.includes('COLLECTOR')) {
            setNumScore += 25; // –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏
        } else if (setNum.includes('SERIES') || setNum.includes('SERIE')) {
            setNumScore += 20; // –°–µ—Ä–∏–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        } else if (setNum.includes('BLIND') || setNum.includes('BAG')) {
            setNumScore += 15; // –°–ª–µ–ø—ã–µ –ø–∞–∫–µ—Ç—ã
        } else if (setNum.includes('POLYBAG') || setNum.includes('POLY')) {
            setNumScore += 10; // –ü–æ–ª–∏–ø–∞–∫–µ—Ç—ã
        }
        
        // –ù–æ–º–µ—Ä–∞ —Å–µ—Ä–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, 001, 002, 003...)
        const seriesMatch = setNum.match(/(\d{3,4})/);
        if (seriesMatch) {
            const seriesNum = parseInt(seriesMatch[1], 10);
            if (seriesNum >= 1 && seriesNum <= 10) {
                setNumScore += 20; // –ü–µ—Ä–≤—ã–µ 10 –Ω–æ–º–µ—Ä–æ–≤ —Å–µ—Ä–∏–∏ (–æ—á–µ–Ω—å —Ä–µ–¥–∫–∏–µ)
            } else if (seriesNum >= 11 && seriesNum <= 20) {
                setNumScore += 15; // –ù–æ–º–µ—Ä–∞ 11-20 (—Ä–µ–¥–∫–∏–µ)
            } else if (seriesNum >= 21 && seriesNum <= 50) {
                setNumScore += 10; // –ù–æ–º–µ—Ä–∞ 21-50 (–Ω–µ–æ–±—ã—á–Ω—ã–µ)
            } else if (seriesNum >= 51 && seriesNum <= 100) {
                setNumScore += 5; // –ù–æ–º–µ—Ä–∞ 51-100 (–æ–±—ã—á–Ω—ã–µ)
            }
        }
        
        // –†–µ–¥–∫–∏–µ –Ω–æ–º–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –æ—Å–æ–±—ã–º–∏ —Ü–∏—Ñ—Ä–∞–º–∏)
        if (setNum.match(/\d{4}/) && setNum.includes('000')) {
            setNumScore += 15; // –ù–æ–º–µ—Ä–∞ —Å –Ω—É–ª—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1000, 2000)
        } else if (setNum.match(/\d{3}/) && setNum.includes('00')) {
            setNumScore += 10; // –ù–æ–º–µ—Ä–∞ —Å –¥–≤–æ–π–Ω—ã–º–∏ –Ω—É–ª—è–º–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 100, 200)
        }
        
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 001, 010, 100, 1000)
        if (setNum.match(/^(\d{3,4})$/)) {
            const num = parseInt(setNum, 10);
            if (num === 1 || num === 10 || num === 100 || num === 1000) {
                setNumScore += 25; // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞
            } else if (num === 2 || num === 20 || num === 200 || num === 2000) {
                setNumScore += 20; // –í—Ç–æ—Ä—ã–µ –Ω–æ–º–µ—Ä–∞
            } else if (num === 3 || num === 30 || num === 300 || num === 3000) {
                setNumScore += 15; // –¢—Ä–µ—Ç—å–∏ –Ω–æ–º–µ—Ä–∞
            }
        }
        
        rarityScore += setNumScore;
        debugInfo.factors.setNum = { score: setNumScore, reason: `–ù–æ–º–µ—Ä: ${setNum}` };
    } else {
        debugInfo.factors.setNum = { score: 0, reason: '–ù–µ—Ç –Ω–æ–º–µ—Ä–∞' };
    }
    
    // –§–∞–∫—Ç–æ—Ä 6: –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
    let nameScore = 0;
    if (minifigName) {
        // –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏
        if (minifigName.includes('Collectible') || minifigName.includes('Collector')) {
            nameScore += 25; // –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏
        } else if (minifigName.includes('Series') || minifigName.includes('Serie')) {
            nameScore += 20; // –°–µ—Ä–∏–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        } else if (minifigName.includes('Blind') || minifigName.includes('Bag')) {
            nameScore += 15; // –°–ª–µ–ø—ã–µ –ø–∞–∫–µ—Ç—ã
        } else if (minifigName.includes('Polybag') || minifigName.includes('Poly')) {
            nameScore += 10; // –ü–æ–ª–∏–ø–∞–∫–µ—Ç—ã
        }
        
        // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ —Å–µ—Ä–∏–∏
        if (minifigName.includes('Minifigure Series') || minifigName.includes('Minifig Series')) {
            nameScore += 30; // –°–µ—Ä–∏–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        } else if (minifigName.includes('Collectible Minifigure') || minifigName.includes('Collector Minifigure')) {
            nameScore += 35; // –ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        } else if (minifigName.includes('Blind Bag') || minifigName.includes('Mystery Bag')) {
            nameScore += 20; // –°–ª–µ–ø—ã–µ –ø–∞–∫–µ—Ç—ã
        } else if (minifigName.includes('Polybag') || minifigName.includes('Poly Bag')) {
            nameScore += 15; // –ü–æ–ª–∏–ø–∞–∫–µ—Ç—ã
        }
        
        // –ù–æ–º–µ—Ä–∞ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Minifigure Series 1", "Collectible Minifigure 001")
        const nameSeriesMatch = minifigName.match(/(\d{1,4})/);
        if (nameSeriesMatch) {
            const seriesNum = parseInt(nameSeriesMatch[1], 10);
            if (seriesNum >= 1 && seriesNum <= 5) {
                nameScore += 25; // –ü–µ—Ä–≤—ã–µ 5 –Ω–æ–º–µ—Ä–æ–≤ —Å–µ—Ä–∏–∏
            } else if (seriesNum >= 6 && seriesNum <= 10) {
                nameScore += 20; // –ù–æ–º–µ—Ä–∞ 6-10
            } else if (seriesNum >= 11 && seriesNum <= 20) {
                nameScore += 15; // –ù–æ–º–µ—Ä–∞ 11-20
            } else if (seriesNum >= 21 && seriesNum <= 50) {
                nameScore += 10; // –ù–æ–º–µ—Ä–∞ 21-50
            }
        }
        
        rarityScore += nameScore;
        debugInfo.factors.nameSeries = { score: nameScore, reason: `–ù–∞–∑–≤–∞–Ω–∏–µ: ${minifigName}` };
    } else {
        debugInfo.factors.nameSeries = { score: 0, reason: '–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è' };
    }
    
    // –§–∞–∫—Ç–æ—Ä 7: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ (—á–µ–º –º–µ–Ω—å—à–µ, —Ç–µ–º —Ä–µ–∂–µ)
    const relatedSets = Object.values(S.setColl).filter(set => 
        set.minifigs && set.minifigs.some(m => m.minifigNum === minifigNum)
    );
    const relatedSetsCount = relatedSets.length;
    
    let relatedSetsScore = 0;
    if (relatedSetsCount === 0) {
        relatedSetsScore += 15; // –û—á–µ–Ω—å —Ä–µ–¥–∫–∞—è - –Ω–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
        debugInfo.factors.relatedSets = { score: 15, reason: '–ù–µ—Ç —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ (–æ—á–µ–Ω—å —Ä–µ–¥–∫–∞—è)' };
    } else if (relatedSetsCount === 1) {
        relatedSetsScore += 10; // –†–µ–¥–∫–∞—è - —Ç–æ–ª—å–∫–æ –≤ –æ–¥–Ω–æ–º –Ω–∞–±–æ—Ä–µ
        debugInfo.factors.relatedSets = { score: 10, reason: `–¢–æ–ª—å–∫–æ –≤ 1 –Ω–∞–±–æ—Ä–µ (—Ä–µ–¥–∫–∞—è)` };
    } else if (relatedSetsCount <= 3) {
        relatedSetsScore += 5; // –ù–µ–æ–±—ã—á–Ω–∞—è - –≤ 2-3 –Ω–∞–±–æ—Ä–∞—Ö
        debugInfo.factors.relatedSets = { score: 5, reason: `–í ${relatedSetsCount} –Ω–∞–±–æ—Ä–∞—Ö (–Ω–µ–æ–±—ã—á–Ω–∞—è)` };
    } else if (relatedSetsCount <= 5) {
        relatedSetsScore += 2; // –û–±—ã—á–Ω–∞—è - –≤ 4-5 –Ω–∞–±–æ—Ä–∞—Ö
        debugInfo.factors.relatedSets = { score: 2, reason: `–í ${relatedSetsCount} –Ω–∞–±–æ—Ä–∞—Ö (–æ–±—ã—á–Ω–∞—è)` };
    } else {
        debugInfo.factors.relatedSets = { score: 0, reason: `–í ${relatedSetsCount} –Ω–∞–±–æ—Ä–∞—Ö (–æ—á–µ–Ω—å —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–∞—è)` };
    }
    rarityScore += relatedSetsScore;
    
    // –§–∞–∫—Ç–æ—Ä 8: –ù–∞–ª–∏—á–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –±–æ–ª–µ–µ —Ä–µ–¥–∫–∏–º–∏)
    let imageScore = 0;
    if (!minifig.minifig_img_url && !minifig.set_img_url) {
        imageScore += 10; // –ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å —Ä–µ–¥–∫–∏–º–∏
        debugInfo.factors.image = { score: 10, reason: '–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è' };
    } else {
        debugInfo.factors.image = { score: 0, reason: '–ï—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' };
    }
    rarityScore += imageScore;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Ç–æ–≥–æ–≤–æ–≥–æ –±–∞–ª–ª–∞
    let rarity;
    if (rarityScore >= 100) rarity = 'legendary';   // –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω–∞—è (‚â•100 –±–∞–ª–ª–æ–≤)
    else if (rarityScore >= 80) rarity = 'epic';         // –≠–ø–∏—á–µ—Å–∫–∞—è (80-99 –±–∞–ª–ª–æ–≤)
    else if (rarityScore >= 60) rarity = 'rare';         // –†–µ–¥–∫–∞—è (60-79 –±–∞–ª–ª–æ–≤)
    else if (rarityScore >= 40) rarity = 'uncommon';     // –ù–µ–æ–±—ã—á–Ω–∞—è (40-59 –±–∞–ª–ª–æ–≤)
    else rarity = 'common';                               // –û–±—ã—á–Ω–∞—è (<40 –±–∞–ª–ª–æ–≤)
    
    // –õ–æ–≥–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–¥–∫–æ—Å—Ç–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    debugInfo.totalScore = rarityScore;
    debugInfo.rarity = rarity;
    
    // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('üîç Rarity calculation for minifig:', minifigNum, minifig.name);
    console.log('üîç Score breakdown:', {
        numParts: debugInfo.factors.numParts?.score || 0,
        name: debugInfo.factors.name?.score || 0,
        year: debugInfo.factors.year?.score || 0,
        theme: debugInfo.factors.theme?.score || 0,
        setNum: debugInfo.factors.setNum?.score || 0,
        nameSeries: debugInfo.factors.nameSeries?.score || 0,
        relatedSets: debugInfo.factors.relatedSets?.score || 0,
        image: debugInfo.factors.image?.score || 0,
        total: debugInfo.totalScore,
        rarity: debugInfo.rarity
    });
    
    return rarity;
}

function analyzeCollection() {
    console.log('üöÄ analyzeCollection START');
    
    if (S.analyticsLoading) {
        console.log('‚ö†Ô∏è analyzeCollection already loading, skipping');
        return;
    }
    
    console.log('üîç analyzeCollection called, minifigColl size:', Object.keys(S.minifigColl).length);
    console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É...');
    S.analyticsLoading = true;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á–µ—Ç–∞
    S.analyticsData = null;
    S.analyticsLastUpdate = 0;
    
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã —Ä–µ–¥–∫–æ—Å—Ç–∏
    const rarityDistribution = {
        legendary: 0,
        epic: 0,
        rare: 0,
        uncommon: 0,
        common: 0,
        unknown: 0
    };
    
    const sampleParts = [];
    let count = 0;
    for (const [partNum, colors] of Object.entries(S.coll)) {
        if (count >= 10) break; // –ë–µ—Ä–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞
        const part = PART_MAP[partNum];
        if (part) {
            for (const [colorId, quantity] of Object.entries(colors)) {
                const rarity = calculatePartRarity(partNum, colorId);
                rarityDistribution[rarity]++;
                if (count < 5) {
                    sampleParts.push({
                        name: part.name,
                        color: COLOR_MAP[colorId]?.name || 'Unknown',
                        rarity: rarity,
                        numSets: parseInt(part.num_sets) || 0
                    });
                }
                count++;
            }
        }
    }
    
    
    try {
        const analytics = {
            totalParts: 0,
            totalUniqueParts: 0,
            totalSets: Object.keys(S.setColl).length,
            totalMinifigs: Object.keys(S.minifigColl).length,
            rarityStats: {
                legendary: 0,
                epic: 0,
                rare: 0,
                uncommon: 0,
                common: 0,
                unknown: 0
            },
            rareParts: [],
            colorStats: {},
            categoryStats: {},
            yearStats: {},
            topRareParts: [],
            // –ù–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤
            setsStats: {
                totalSets: 0,
                totalPieces: 0,
                averagePieces: 0,
                themeStats: {},
                yearStats: {},
                topThemes: [],
                topSets: []
            },
            // –ù–æ–≤–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
            minifigsStats: {
                totalMinifigs: 0,
                themeStats: {},
                yearStats: {},
                topThemes: [],
                topMinifigs: []
            }
        };
        
        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–µ—Ç–∞–ª–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        for (const [partNum, colors] of Object.entries(S.coll)) {
            const part = PART_MAP[partNum];
            if (!part) continue;
            
            analytics.totalUniqueParts++;
            
            for (const [colorId, quantity] of Object.entries(colors)) {
                analytics.totalParts += quantity;
                
                const rarity = calculatePartRarity(partNum, colorId);
                analytics.rarityStats[rarity] += quantity;
                
                // –°–æ–±–∏—Ä–∞–µ–º —Ä–µ–¥–∫–∏–µ –¥–µ—Ç–∞–ª–∏
                if (['legendary', 'epic', 'rare'].includes(rarity)) {
                    const color = COLOR_MAP[colorId];
                    analytics.rareParts.push({
                        partNum,
                        partName: part.name,
                        colorId,
                        colorName: color?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ü–≤–µ—Ç',
                        quantity,
                        rarity,
                        rarityName: getRarityName(rarity),
                        rarityColor: getRarityColor(rarity),
                        partImgUrl: part.part_img_url || part.set_img_url
                    });
                }
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–≤–µ—Ç–∞–º
                const colorName = COLOR_MAP[colorId]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                analytics.colorStats[colorName] = (analytics.colorStats[colorName] || 0) + quantity;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                const category = flatCategories.find(cat => cat.id === part.part_cat_id);
                const categoryName = category?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è';
                analytics.categoryStats[categoryName] = (analytics.categoryStats[categoryName] || 0) + quantity;
            }
        }
        
        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞–±–æ—Ä—ã –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        for (const [setNum, setData] of Object.entries(S.setColl)) {
            const set = SET_MAP[setNum];
            if (set) {
                const year = set.year;
                const theme = THEME_MAP[set.theme_id];
                const themeName = theme?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–º–∞';
                
                // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞–±–æ—Ä—ã Star Wars –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                if (themeName.toLowerCase().includes('star wars')) {
                }
                
                // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–±–æ—Ä–æ–≤
                analytics.setsStats.totalSets += setData.qty;
                analytics.setsStats.totalPieces += (set.num_parts || 0) * setData.qty;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º –Ω–∞–±–æ—Ä–æ–≤
                analytics.setsStats.themeStats[themeName] = (analytics.setsStats.themeStats[themeName] || 0) + setData.qty;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º –Ω–∞–±–æ—Ä–æ–≤
                analytics.setsStats.yearStats[year] = (analytics.setsStats.yearStats[year] || 0) + setData.qty;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º –¥–µ—Ç–∞–ª–µ–π (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
                analytics.yearStats[year] = (analytics.yearStats[year] || 0) + setData.qty;
            }
        }
        
        // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        for (const [minifigNum, minifigData] of Object.entries(S.minifigColl)) {
            const minifig = MINIFIG_MAP[minifigNum];
            if (minifig) {
                const year = minifig.year;
                const theme = THEME_MAP[minifig.theme_id];
                const themeName = theme?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–º–∞';
                
                // –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
                analytics.minifigsStats.totalMinifigs += minifigData.qty;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
                analytics.minifigsStats.themeStats[themeName] = (analytics.minifigsStats.themeStats[themeName] || 0) + minifigData.qty;
                
                // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
                analytics.minifigsStats.yearStats[year] = (analytics.minifigsStats.yearStats[year] || 0) + minifigData.qty;
            }
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–¥–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
        analytics.rareParts.sort((a, b) => {
            const rarityOrder = { 'legendary': 0, 'epic': 1, 'rare': 2 };
            const aOrder = rarityOrder[a.rarity] ?? 999;
            const bOrder = rarityOrder[b.rarity] ?? 999;
            if (aOrder !== bOrder) return aOrder - bOrder;
            return b.quantity - a.quantity;
        });
        
        // –¢–æ–ø-10 —Å–∞–º—ã—Ö —Ä–µ–¥–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π
        analytics.topRareParts = analytics.rareParts.slice(0, 10);
        
        // –°–æ–∑–¥–∞–µ–º —Ç–æ–ø-—Å–ø–∏—Å–∫–∏ –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤
        analytics.setsStats.topThemes = Object.entries(analytics.setsStats.themeStats)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10)
            .map(([themeName, count]) => {
                // –ù–∞—Ö–æ–¥–∏–º themeId –ø–æ themeName
                const themeId = Object.keys(THEME_MAP).find(id => THEME_MAP[id]?.name === themeName);
                return { themeName, count, themeId: themeId ? parseInt(themeId, 10) : null };
            });
            
        analytics.setsStats.topSets = Object.entries(S.setColl)
            .map(([setNum, setData]) => {
                const set = SET_MAP[setNum];
                return set ? {
                    setNum,
                    setName: set.name,
                    year: set.year,
                    numParts: set.num_parts || 0, // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –≤ –æ–¥–Ω–æ–º —ç–∫–∑–µ–º–ø–ª—è—Ä–µ –Ω–∞–±–æ—Ä–∞
                    quantity: setData.qty,
                    theme: THEME_MAP[set.theme_id]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–º–∞',
                    setImgUrl: set.set_img_url
                } : null;
            })
            .filter(Boolean)
            .sort((a, b) => b.numParts - a.numParts)
            .slice(0, 10);
            
            
        // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –≤ –Ω–∞–±–æ—Ä–∞—Ö
        analytics.setsStats.averagePieces = analytics.setsStats.totalSets > 0 
            ? Math.round(analytics.setsStats.totalPieces / analytics.setsStats.totalSets) 
            : 0;
        
        // –°–æ–∑–¥–∞–µ–º —Ç–æ–ø-—Å–ø–∏—Å–∫–∏ –¥–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        analytics.minifigsStats.topThemes = Object.entries(analytics.minifigsStats.themeStats)
            .sort(([,a], [,b]) => b - a)
            .slice(0, 10)
            .map(([themeName, count]) => {
                // –ù–∞—Ö–æ–¥–∏–º themeId –ø–æ themeName
                const themeId = Object.keys(THEME_MAP).find(id => THEME_MAP[id]?.name === themeName);
                return { themeName, count, themeId: themeId ? parseInt(themeId, 10) : null };
            });
            
        
        // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –≤—Å–µ—Ö –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ —Å —Ä–∞—Å—á–µ—Ç–æ–º —Ä–µ–¥–∫–æ—Å—Ç–∏
        console.log('üîç Creating allMinifigs array, processing', Object.entries(S.minifigColl).length, 'minifigs');
        const allMinifigs = Object.entries(S.minifigColl)
            .map(([minifigNum, minifigData]) => {
                const minifig = MINIFIG_MAP[minifigNum];
                if (!minifig) return null;
                
                console.log('üîç Processing minifig:', minifigNum, minifig.name, {
                    theme_id: minifig.theme_id,
                    year: minifig.year,
                    num_parts: minifig.num_parts,
                    hasImage: !!(minifig.minifig_img_url || minifig.set_img_url)
                });
                
                        // –ï—Å–ª–∏ —É –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–µ—Ç —Ç–µ–º—ã –∏–ª–∏ –≥–æ–¥–∞, –ø–æ–ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
        if (!minifig.theme_id || !minifig.year) {
            console.log('üîç Minifig missing theme/year data, fetching details for:', minifigNum);
            fetchMinifigDetails(minifigNum).catch(console.error);
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å –¥–ª—è –∫–∞–∂–¥–æ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        console.log('üîÑ –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å –¥–ª—è:', minifigNum, minifig.name);
                
                const rarity = calculateMinifigRarity(minifigNum);
                return {
                    minifigNum,
                    minifigName: minifig.name || `–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞ ${minifigNum}`,
                    year: minifig.year || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥–æ–¥',
                    quantity: minifigData.qty,
                    theme: THEME_MAP[minifig.theme_id]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–º–∞',
                    minifigImgUrl: minifig.minifig_img_url || minifig.set_img_url,
                    rarity: rarity,
                    rarityName: getRarityName(rarity),
                    rarityColor: getRarityColor(rarity),
                    numParts: parseInt(minifig.num_parts) || 0
                };
            })
            .filter(Boolean);
        
        // –¢–æ–ø –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
        analytics.minifigsStats.topMinifigs = allMinifigs
            .sort((a, b) => b.quantity - a.quantity)
            .slice(0, 10);
            
        // –¢–æ–ø –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
        console.log('üîÑ –°–æ–∑–¥–∞–µ–º —Ç–æ–ø –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏...');
        console.log('–í—Å–µ–≥–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏:', allMinifigs.length);
        
        // –°–Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ —Å –∏—Ö —Ä–µ–¥–∫–æ—Å—Ç—å—é
        allMinifigs.forEach((minifig, index) => {
            console.log(`${index + 1}. ${minifig.minifigName} - ${minifig.rarity} (${minifig.rarityName})`);
        });
        
        analytics.minifigsStats.topRareMinifigs = allMinifigs
            .sort((a, b) => {
                const rarityOrder = { 'legendary': 0, 'epic': 1, 'rare': 2, 'uncommon': 3, 'common': 4, 'unknown': 5 };
                const aOrder = rarityOrder[a.rarity] ?? 999;
                const bOrder = rarityOrder[b.rarity] ?? 999;
                if (aOrder !== bOrder) return aOrder - bOrder;
                return b.quantity - a.quantity; // –ü—Ä–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
            })
            .slice(0, 10);
            
        analytics.minifigsStats.topRareMinifigs.forEach((minifig, index) => {
            console.log(`${index + 1}. ${minifig.minifigName} - ${minifig.rarity} (${minifig.rarityName})`);
        });
            
        
        // –í—ã—á–∏—Å–ª—è–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        analytics.totalColors = Object.keys(analytics.colorStats).length;
        analytics.totalCategories = Object.keys(analytics.categoryStats).length;
        
        S.analyticsData = analytics;
        S.analyticsLastUpdate = Date.now();
        console.log('‚úÖ –ê–Ω–∞–ª–∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω:', analytics);
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        console.log('üîÑ –û–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å—á–µ—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');
        updateUI();
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏:', error);
        S.analyticsData = null;
    } finally {
        S.analyticsLoading = false;
        console.log('üèÅ analyzeCollection END');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∫ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
function applyTemporaryFilters() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
    S.selCollCatId = null;
    S.q = '';
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
    if (S.tempRarityFilter) {
    }
    
    if (S.tempColorFilter) {
    }
    
    if (S.tempCategoryFilter) {
        S.selCollCatId = parseInt(S.tempCategoryFilter);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    renderSidebar();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
function showTemporaryMessage(message) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-[18px] shadow-lg z-50 transition-opacity';
    notification.style.opacity = '0';
    notification.textContent = message;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
    document.body.appendChild(notification);
    
    // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ
    setTimeout(() => {
        notification.style.opacity = '1';
    }, 100);
    
    // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–º–ø–æ—Ä—Ç–∞
function showImportStats(importedCount, skippedCount) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-emerald-600 to-green-600 text-white px-4 py-3 rounded-[18px] shadow-2xl z-50 transition-all duration-300 border border-emerald-500/20';
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    
    // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å –∏–∫–æ–Ω–∫–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
    const totalCount = importedCount + skippedCount;
    const successRate = totalCount > 0 ? Math.round((importedCount / totalCount) * 100) : 0;
    
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-semibold">–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω</div>
                <div class="text-xs text-white/90 mt-1">
                    <span class="inline-flex items-center gap-1">
                        <span class="w-2 h-2 bg-white rounded-full"></span>
                        ${importedCount} –¥–æ–±–∞–≤–ª–µ–Ω–æ
                    </span>
                    ${skippedCount > 0 ? `
                        <span class="mx-2">‚Ä¢</span>
                        <span class="inline-flex items-center gap-1">
                            <span class="w-2 h-2 bg-white/60 rounded-full"></span>
                            ${skippedCount} –ø—Ä–æ–ø—É—â–µ–Ω–æ
                        </span>
                    ` : ''}
                </div>
            </div>
            <div class="flex-shrink-0 text-xs font-bold bg-white/20 px-2 py-1 rounded-full">
                ${successRate}%
            </div>
        </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
    document.body.appendChild(notification);
    
    // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã (—á—É—Ç—å –¥–æ–ª—å—à–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞
function showImportError(message) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-red-600 to-red-700 text-white px-4 py-3 rounded-[18px] shadow-2xl z-50 transition-all duration-300 border border-red-500/20';
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-semibold">–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞</div>
                <div class="text-xs text-white/90 mt-1">${message}</div>
            </div>
        </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
    document.body.appendChild(notification);
    
    // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ (–¥–æ–ª—å—à–µ –¥–ª—è –æ—à–∏–±–æ–∫)
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 5000);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ —ç–∫—Å–ø–æ—Ä—Ç–∞
function showExportSuccess(itemCount) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–º —ç–∫—Å–ø–æ—Ä—Ç–µ
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-3 rounded-[18px] shadow-2xl z-50 transition-all duration-300 border border-blue-500/20';
    notification.style.opacity = '0';
    notification.style.transform = 'translateX(100%)';
    
    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <div class="text-sm font-semibold">–≠–∫—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω</div>
                <div class="text-xs text-white/90 mt-1">
                    <span class="inline-flex items-center gap-1">
                        <span class="w-2 h-2 bg-white rounded-full"></span>
                        ${itemCount} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ
                    </span>
                </div>
            </div>
            <div class="flex-shrink-0 text-xs font-bold bg-white/20 px-2 py-1 rounded-full">
                CSV
            </div>
        </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ DOM
    document.body.appendChild(notification);
    
    // –ê–Ω–∏–º–∏—Ä—É–µ–º –ø–æ—è–≤–ª–µ–Ω–∏–µ
    setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // –£–±–∏—Ä–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// –§—É–Ω–∫—Ü–∏–∏ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ –∂–µ–ª–∞–Ω–∏–π
function selectAllWishlistItems() {
    const checkboxes = document.querySelectorAll('.wishlist-item-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.classList.add('selected');
        checkbox.innerHTML = I_CheckCircle('w-3 h-3');
    });
    updateWishlistSelectionUI();
}

function deselectAllWishlistItems() {
    const checkboxes = document.querySelectorAll('.wishlist-item-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.classList.remove('selected');
        checkbox.innerHTML = I_Circle('w-3 h-3');
    });
    updateWishlistSelectionUI();
}

function updateWishlistSelectionUI() {
    const checkboxes = document.querySelectorAll('.wishlist-item-checkbox');
    const selectedCount = Array.from(checkboxes).filter(cb => cb.classList.contains('selected')).length;
    const totalCount = checkboxes.length;
    
    const selectAllBtn = document.getElementById('select-all-wishlist');
    const deselectAllBtn = document.getElementById('deselect-all-wishlist');
    const exportSelectedBtn = document.getElementById('export-selected-wishlist');
    const shareSelectedBtn = document.getElementById('share-selected-wishlist');
    
    if (selectedCount === 0) {
        selectAllBtn.classList.remove('hidden');
        deselectAllBtn.classList.add('hidden');
        exportSelectedBtn.classList.add('hidden');
        shareSelectedBtn.classList.add('hidden');
    } else if (selectedCount === totalCount) {
        selectAllBtn.classList.add('hidden');
        deselectAllBtn.classList.remove('hidden');
        exportSelectedBtn.classList.remove('hidden');
        shareSelectedBtn.classList.remove('hidden');
    } else {
        selectAllBtn.classList.remove('hidden');
        deselectAllBtn.classList.remove('hidden');
        exportSelectedBtn.classList.remove('hidden');
        shareSelectedBtn.classList.remove('hidden');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–æ–∫
    if (selectedCount > 0) {
        exportSelectedBtn.innerHTML = `${I_Download('w-5 h-5')} <span class="hidden sm:inline">–≠–∫—Å–ø–æ—Ä—Ç (${selectedCount})</span><span class="sm:hidden">(${selectedCount})</span>`;
        shareSelectedBtn.innerHTML = `${I_Share('w-5 h-5')} <span class="hidden sm:inline">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è (${selectedCount})</span><span class="sm:hidden">(${selectedCount})</span>`;
    } else {
        exportSelectedBtn.innerHTML = `${I_Download('w-5 h-5')} <span class="hidden sm:inline">–≠–∫—Å–ø–æ—Ä—Ç</span>`;
        shareSelectedBtn.innerHTML = `${I_Share('w-5 h-5')} <span class="hidden sm:inline">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span>`;
    }
}

function getSelectedWishlistItems() {
    const checkboxes = document.querySelectorAll('.wishlist-item-checkbox.selected');
    return Array.from(checkboxes).map(checkbox => {
        const itemId = checkbox.dataset.itemId;
        const wishlistId = checkbox.dataset.wishlistId;
        const wishlist = S.wishlists[wishlistId];
        return wishlist ? wishlist.items.find(item => item.id === itemId) : null;
    }).filter(item => item !== null);
}

function exportSelectedWishlistItems() {
    const selectedItems = getSelectedWishlistItems();
    if (selectedItems.length === 0) {
        showImportError('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º CSV –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const csvHeader = 'Type,ID,Name,Color,Added\n';
    const csvData = selectedItems.map(item => {
        const colorName = item.colorId ? (COLOR_MAP[item.colorId]?.name || item.colorId) : '';
        return `${item.type},"${item.itemId}","${item.name}","${colorName}","${item.added}"`;
    }).join('\n');
    
    const csvContent = csvHeader + csvData;
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const fileName = `wishlist-selected-${selectedItems.length}-items-${new Date().toISOString().slice(0,10)}.csv`;
    
    // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    
    setTimeout(() => URL.revokeObjectURL(url), 5000);
    showExportSuccess(selectedItems.length);
}

async function shareSelectedWishlistItems() {
    const selectedItems = getSelectedWishlistItems();
    if (selectedItems.length === 0) {
        showImportError('–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
        return;
    }
    
    try {
        // –°–æ–∑–¥–∞–µ–º CSV –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        const csvHeader = 'Type,ID,Name,Color,Added\n';
        const csvData = selectedItems.map(item => {
            const colorName = item.colorId ? (COLOR_MAP[item.colorId]?.name || item.colorId) : '';
            return `${item.type},"${item.itemId}","${item.name}","${colorName}","${item.added}"`;
        }).join('\n');
        
        const csvContent = csvHeader + csvData;
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const fileName = `wishlist-selected-${selectedItems.length}-items-${new Date().toISOString().slice(0,10)}.csv`;
        const csvFile = new File([blob], fileName, { type: 'text/csv' });
        
        const siteUrl = 'https://zeka3535.github.io/LEGO-Part-Catalog/';
        const title = `–ú–æ–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π LEGO (${selectedItems.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤)`;
        const text = `–ü–æ–¥–µ–ª–∏–ª—Å—è —Å–ø–∏—Å–∫–æ–º –∂–µ–ª–∞–Ω–∏–π LEGO –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞: ${siteUrl}`;
        
        if (navigator.share && navigator.canShare({ files: [csvFile] })) {
            await navigator.share({
                title: title,
                text: text,
                files: [csvFile],
                url: siteUrl
            });
            showTemporaryMessage('–°–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
        } else {
            // Fallback: —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 5000);
            showExportSuccess(selectedItems.length);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏:', error);
        showImportError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
function clearTemporaryFilters() {
    S.tempRarityFilter = null;
    S.tempColorFilter = null;
    S.tempCategoryFilter = null;
}

function renderAnalyticsContent(analytics) {
    // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–±—Ä–∞–Ω–∞
    
    // HTML –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
    const subViewTabs = `
        <div class="flex bg-gray-800 rounded-[18px] p-1 mb-4 sm:mb-6 gap-1">
            <button class="flex-1 px-3 py-2 text-sm font-medium rounded-[18px] transition-all duration-200 ${
                S.analyticsSubView === 'dashboard' 
                    ? 'bg-blue-600 text-white shadow-lg' 
                    : 'text-gray-400 hover:text-white hover:bg-gray-700'
            }" data-action="switch-analytics-subview" data-subview="dashboard">
                <div class="flex items-center justify-center gap-2">
                    ${I_Chart("w-4 h-4")}
                    <span class="hidden sm:inline">–î–∞—à–±–æ—Ä–¥</span>
                </div>
            </button>
            <button class="flex-1 px-3 py-2 text-sm font-medium rounded-[18px] transition-all duration-200 ${
                S.analyticsSubView === 'parts' 
                    ? 'bg-blue-600 text-white shadow-lg' 
                    : 'text-gray-400 hover:text-white hover:bg-gray-700'
            }" data-action="switch-analytics-subview" data-subview="parts">
                <div class="flex items-center justify-center gap-2">
                    ${I_Brick("w-4 h-4")}
                    <span class="hidden sm:inline">–î–µ—Ç–∞–ª–∏</span>
                </div>
            </button>
            <button class="flex-1 px-3 py-2 text-sm font-medium rounded-[18px] transition-all duration-200 ${
                S.analyticsSubView === 'sets' 
                    ? 'bg-blue-600 text-white shadow-lg' 
                    : 'text-gray-400 hover:text-white hover:bg-gray-700'
            }" data-action="switch-analytics-subview" data-subview="sets">
                <div class="flex items-center justify-center gap-2">
                    ${I_Set("w-4 h-4")}
                    <span class="hidden sm:inline">–ù–∞–±–æ—Ä—ã</span>
                </div>
            </button>
            <button class="flex-1 px-3 py-2 text-sm font-medium rounded-[18px] transition-all duration-200 ${
                S.analyticsSubView === 'minifigs' 
                    ? 'bg-blue-600 text-white shadow-lg' 
                    : 'text-gray-400 hover:text-white hover:bg-gray-700'
            }" data-action="switch-analytics-subview" data-subview="minifigs">
                <div class="flex items-center justify-center gap-2">
                    ${I_Minifig("w-4 h-4")}
                    <span class="hidden sm:inline">–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏</span>
                </div>
            </button>
        </div>
    `;
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è "–î–∞—à–±–æ—Ä–¥"
    if (S.analyticsSubView === 'dashboard') {
        const dashboardContent = renderDashboardAnalytics(analytics, subViewTabs);
        const result = `<div data-analytics-subview="dashboard">${dashboardContent}</div>`;
        
        
        return result;
    }
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ù–∞–±–æ—Ä—ã"
    if (S.analyticsSubView === 'sets') {
        return `<div data-analytics-subview="sets">${renderSetsAnalytics(analytics, subViewTabs)}</div>`;
    }
    
    // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è "–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏"
    if (S.analyticsSubView === 'minifigs') {
        return `<div data-analytics-subview="minifigs">${renderMinifigsAnalytics(analytics, subViewTabs)}</div>`;
    }
    
    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–µ—Ç–∞–ª–µ–π
    const rarityStatsHtml = Object.entries(analytics.rarityStats)
        .filter(([rarity, count]) => count > 0)
        .map(([rarity, count]) => {
            const color = getRarityColor(rarity);
            const name = getRarityName(rarity);
            const percentage = analytics.totalParts > 0 ? ((count / analytics.totalParts) * 100) : 0;
            return `
                <div class="flex items-center justify-between p-2 sm:p-3 xl:p-4 bg-gray-800 rounded-[18px] cursor-pointer hover:bg-gray-700 active:bg-gray-600 transition-all duration-150 touch-manipulation group shadow-lg" 
                     style="--item-color: ${color};"
                     data-action="filter-by-rarity" data-rarity="${rarity}" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ ${name.toLowerCase()} –¥–µ—Ç–∞–ª–∏">
                    <div class="flex items-center gap-2 sm:gap-3 xl:gap-4 min-w-0 flex-1">
                        <div class="w-3 h-3 sm:w-4 sm:h-4 xl:w-5 xl:h-5 rounded-full flex-shrink-0 shadow-lg" style="background-color: ${color}"></div>
                        <div class="min-w-0 flex-1">
                            <span class="text-gray-200 font-medium text-sm sm:text-base xl:text-lg truncate">${name}</span>
                            <div class="mt-1">
                                <div style="width: 100%; height: 8px; background-color: #2d3748; border-radius: 18px; overflow: hidden;">
                                    <div style="height: 100%; background-color: ${color}; width: ${Math.max(percentage, 1)}%; border-radius: 18px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-2">
                        <div class="text-white font-bold text-sm sm:text-base xl:text-lg">${count}</div>
                        <div class="text-xs xl:text-sm text-gray-400">${percentage.toFixed(1)}%</div>
                    </div>
                </div>
            `;
        }).join('');

    const topRarePartsHtml = analytics.topRareParts.map(part => `
        <div class="flex items-center justify-between p-2 sm:p-3 xl:p-4 bg-gray-800 rounded-[18px] cursor-pointer hover:bg-gray-700 active:bg-gray-600 transition-all duration-150 touch-manipulation group shadow-lg" 
             style="--item-color: ${part.rarityColor};"
             data-action="open-part-modal" data-part-id="${part.partNum}" data-color-id="${part.colorId}" 
             title="–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª—å: ${part.partName} (${part.colorName})">
            <div class="flex items-center gap-2 sm:gap-3 xl:gap-4 min-w-0 flex-1">
                <div class="w-8 h-8 sm:w-10 sm:h-10 xl:w-12 xl:h-12 rounded-[18px] flex-shrink-0 shadow-lg overflow-hidden bg-white">
                    <img src="${part.partImgUrl || `https://cdn.rebrickable.com/media/parts/${part.partNum}/${part.colorId}.jpg`}" 
                         alt="${part.partName}"
                         class="w-full h-full object-contain"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-full h-full flex items-center justify-center" style="background-color: ${part.rarityColor}; display: none;">
                        ${I_Brick("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-white")}
                    </div>
                </div>
                <div class="min-w-0 flex-1">
                    <div class="text-white font-medium text-xs sm:text-sm xl:text-base truncate">${part.partName}</div>
                    <div class="text-xs xl:text-sm text-gray-400 truncate">${part.colorName}</div>
                    <div class="mt-1">
                        <span class="inline-block px-2 py-1 text-xs rounded-full" style="background-color: ${part.rarityColor}20; color: ${part.rarityColor}">${part.rarityName}</span>
                    </div>
                </div>
            </div>
            <div class="text-right flex-shrink-0 ml-2">
                <div class="text-white font-bold text-sm sm:text-base xl:text-lg">${part.quantity}</div>
            </div>
        </div>
    `).join('');

    const colorStatsHtml = Object.entries(analytics.colorStats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10)
        .map(([colorName, count]) => {
            // –ù–∞—Ö–æ–¥–∏–º colorId –ø–æ –∏–º–µ–Ω–∏ —Ü–≤–µ—Ç–∞
            const colorId = Object.keys(COLOR_MAP).find(id => COLOR_MAP[id]?.name === colorName);
            const maxCount = Math.max(...Object.values(analytics.colorStats));
            const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
            const totalPercentage = analytics.totalParts > 0 ? ((count / analytics.totalParts) * 100) : 0;
            const totalPercentageDisplay = totalPercentage.toFixed(1);
            const colorHex = COLOR_MAP[colorId]?.rgb ? `#${COLOR_MAP[colorId].rgb}` : '#666666';
            
            
            return `
                <div class="flex items-center justify-between p-1.5 sm:p-2 xl:p-3 bg-gray-800 rounded-[18px] cursor-pointer hover:bg-gray-700 active:bg-gray-600 transition-all duration-150 touch-manipulation group shadow-lg" 
                     style="--hover-shadow-color: ${colorHex}40;"
                     onmouseover="this.style.boxShadow='0 10px 15px -3px var(--hover-shadow-color), 0 4px 6px -2px var(--hover-shadow-color)'"
                     onmouseout="this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'"
                     data-action="filter-by-color" data-color-id="${colorId || ''}" data-color-name="${colorName}" 
                     title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏ —Ü–≤–µ—Ç–∞: ${colorName}">
                    <div class="flex items-center gap-1.5 sm:gap-2 xl:gap-3 min-w-0 flex-1">
                        <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 xl:w-4 xl:h-4 rounded-full flex-shrink-0 shadow-lg" style="background-color: ${colorHex}"></div>
                        <div class="min-w-0 flex-1">
                            <span class="text-gray-200 text-xs sm:text-sm xl:text-base truncate">${colorName}</span>
                            <div class="mt-0.5 sm:mt-1">
                                <div style="width: 100%; height: 6px; background-color: #2d3748; border-radius: 18px; overflow: hidden;">
                                    <div style="height: 100%; background-color: ${colorHex}; width: ${Math.max(totalPercentage, 1)}%; border-radius: 18px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-1.5 sm:ml-2">
                        <div class="text-white font-bold text-xs sm:text-sm xl:text-lg">${count}</div>
                        <div class="text-xs xl:text-sm text-gray-400">${totalPercentageDisplay}%</div>
                    </div>
                </div>
            `;
        }).join('');

    const categoryStatsHtml = Object.entries(analytics.categoryStats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10)
        .map(([categoryName, count]) => {
            // –ù–∞—Ö–æ–¥–∏–º categoryId –ø–æ –∏–º–µ–Ω–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const categoryId = flatCategories.find(cat => cat.name === categoryName)?.id;
            const maxCount = Math.max(...Object.values(analytics.categoryStats));
            const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;
            const totalPercentage = analytics.totalParts > 0 ? ((count / analytics.totalParts) * 100) : 0;
            const totalPercentageDisplay = totalPercentage.toFixed(1);
            
            return `
                <div class="flex items-center justify-between p-1.5 sm:p-2 xl:p-3 bg-gray-800 rounded-[18px] cursor-pointer hover:bg-gray-700 active:bg-gray-600 transition-all duration-150 touch-manipulation group shadow-lg" 
                     style="--hover-shadow-color: #3b82f640;"
                     onmouseover="this.style.boxShadow='0 10px 15px -3px var(--hover-shadow-color), 0 4px 6px -2px var(--hover-shadow-color)'"
                     onmouseout="this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'"
                     data-action="filter-by-category" data-category-id="${categoryId || ''}" data-category-name="${categoryName}" 
                     title="–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${categoryName}">
                    <div class="flex items-center gap-1.5 sm:gap-2 xl:gap-3 min-w-0 flex-1">
                        <div class="w-2.5 h-2.5 sm:w-3 sm:h-3 xl:w-4 xl:h-4 rounded-full flex-shrink-0 bg-blue-500 shadow-lg"></div>
                        <div class="min-w-0 flex-1">
                            <span class="text-gray-200 text-xs sm:text-sm xl:text-base truncate">${categoryName}</span>
                            <div class="mt-0.5 sm:mt-1">
                                <div style="width: 100%; height: 6px; background-color: #2d3748; border-radius: 18px; overflow: hidden;">
                                    <div style="height: 100%; background-color: #3b82f6; width: ${Math.max(totalPercentage, 1)}%; border-radius: 18px;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-right flex-shrink-0 ml-1.5 sm:ml-2">
                        <div class="text-white font-bold text-xs sm:text-sm xl:text-lg">${count}</div>
                        <div class="text-xs xl:text-sm text-gray-400">${totalPercentageDisplay}%</div>
                    </div>
                </div>
            `;
        }).join('');

    return `
        <div class="p-3 sm:p-4 lg:p-6 xl:p-8 space-y-4 sm:space-y-6 xl:space-y-8">
            ${subViewTabs}
            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-1.5 sm:gap-3 xl:gap-6">
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Brick("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-blue-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalParts}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">${pluralize(analytics.totalParts, ['–¥–µ—Ç–∞–ª—å', '–¥–µ—Ç–∞–ª–∏', '–¥–µ—Ç–∞–ª–µ–π'])}</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Brick("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-green-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalUniqueParts}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">${pluralize(analytics.totalUniqueParts, ['—É–Ω–∏–∫–∞–ª—å–Ω–∞—è', '—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ', '—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö'])}</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Set("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-green-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalSets}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">–ù–∞–±–æ—Ä–æ–≤</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Minifig("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-purple-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalMinifigs}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Palette("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-yellow-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalColors || 0}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">–¶–≤–µ—Ç–æ–≤</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Cat("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-orange-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalCategories || 0}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6 xl:gap-8">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                <div class="space-y-4 sm:space-y-6">
                    <!-- –†–µ–¥–∫–∏–µ –¥–µ—Ç–∞–ª–∏ -->
                    <div class="bg-gray-800 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8">
                        <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                            <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-yellow-400">${I_Star('w-full h-full')}</div>
                            <span class="hidden sm:inline">–†–µ–¥–∫–∏–µ –¥–µ—Ç–∞–ª–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                            <span class="sm:hidden">–†–µ–¥–∫–∏–µ –¥–µ—Ç–∞–ª–∏</span>
                        </h3>
                        <div class="space-y-2 sm:space-y-3 xl:space-y-4">
                            ${analytics.rareParts.length > 0 ? rarityStatsHtml : '<p class="text-gray-400 text-center py-3 sm:py-4 xl:py-6 text-sm xl:text-base">–†–µ–¥–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>'}
                        </div>
                    </div>

                    <!-- –¢–æ–ø —Ä–µ–¥–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π -->
                    ${analytics.topRareParts.length > 0 ? `
                        <div class="bg-gray-800 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8">
                            <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                                <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-yellow-400">${I_Trophy('w-full h-full')}</div>
                                <span class="hidden sm:inline">–¢–æ–ø-10 —Å–∞–º—ã—Ö —Ä–µ–¥–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π</span>
                                <span class="sm:hidden">–¢–æ–ø —Ä–µ–¥–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π</span>
                            </h3>
                            <div class="space-y-2 sm:space-y-3 xl:space-y-4">
                                ${topRarePartsHtml}
                            </div>
                        </div>
                    ` : ''}
                </div>

                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                <div class="space-y-4 sm:space-y-6">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ü–≤–µ—Ç–∞–º -->
                    <div class="bg-gray-800 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8">
                        <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                            <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-purple-400">${I_Theme('w-full h-full')}</div>
                            <span class="hidden sm:inline">–¢–æ–ø-10 —Ü–≤–µ—Ç–æ–≤</span>
                            <span class="sm:hidden">–¢–æ–ø —Ü–≤–µ—Ç–æ–≤</span>
                        </h3>
                        <div class="space-y-1 sm:space-y-2 xl:space-y-3">
                            ${colorStatsHtml}
                        </div>
                    </div>

                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º -->
                    <div class="bg-gray-800 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8">
                        <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                            <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-orange-400">${I_Package('w-full h-full')}</div>
                            <span class="hidden sm:inline">–¢–æ–ø-10 –∫–∞—Ç–µ–≥–æ—Ä–∏–π</span>
                            <span class="sm:hidden">–¢–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏–π</span>
                        </h3>
                        <div class="space-y-1 sm:space-y-2 xl:space-y-3">
                            ${categoryStatsHtml}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    `;
}

function renderSetsAnalytics(analytics, subViewTabs) {
    const setsStats = analytics.setsStats;
    
                 const topThemesHtml = setsStats.topThemes.map(theme => `
        <div class="flex items-center justify-between p-2 sm:p-3 xl:p-4 bg-gray-800 rounded-[18px] cursor-pointer hover:bg-gray-700 active:bg-gray-600 transition-all duration-150 touch-manipulation group shadow-lg" 
             style="--item-color: #3b82f6;"
             data-action="go-to-theme" data-theme-id="${theme.themeId}"
             title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞–±–æ—Ä—ã —Ç–µ–º—ã: ${theme.themeName}">
             <div class="flex items-center gap-2 sm:gap-3 xl:gap-4 min-w-0 flex-1">
                 <div class="w-3 h-3 sm:w-4 sm:h-4 xl:w-5 xl:h-5 rounded-full flex-shrink-0 bg-blue-500 shadow-lg"></div>
                 <div class="min-w-0 flex-1">
                     <span class="text-gray-200 font-medium text-sm sm:text-base xl:text-lg truncate">${theme.themeName}</span>
                 </div>
             </div>
             <div class="text-right flex-shrink-0 ml-2">
                 <div class="text-white font-bold text-sm sm:text-base xl:text-lg">${theme.count}</div>
             </div>
         </div>
     `).join('');
    
    const topSetsHtml = setsStats.topSets.map(set => `
        <div class="flex items-center justify-between p-2 sm:p-3 xl:p-4 bg-gray-800 rounded-[18px] cursor-pointer hover:bg-gray-700 active:bg-gray-600 transition-all duration-150 touch-manipulation group shadow-lg" 
             style="--item-color: #10b981;"
             data-action="open-set-modal" data-set-id="${set.setNum}" 
             title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞–±–æ—Ä: ${set.setName}">
            <div class="flex items-center gap-2 sm:gap-3 xl:gap-4 min-w-0 flex-1">
                <div class="w-8 h-8 sm:w-10 sm:h-10 xl:w-12 xl:h-12 rounded-[18px] flex-shrink-0 shadow-lg overflow-hidden bg-white">
                    <img src="${set.setImgUrl || `https://cdn.rebrickable.com/media/sets/${set.setNum}.jpg`}" 
                         alt="${set.setName}"
                         class="w-full h-full object-contain"
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                    <div class="w-full h-full bg-green-500 flex items-center justify-center" style="display: none;">
                        ${I_Set("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-white")}
                    </div>
                </div>
                <div class="min-w-0 flex-1">
                    <div class="text-white font-medium text-xs sm:text-sm xl:text-base truncate">${set.setName}</div>
                    <div class="text-xs xl:text-sm text-gray-400 truncate">${set.theme} (${set.year})</div>
                </div>
            </div>
            <div class="text-right flex-shrink-0 ml-2">
                <div class="text-white font-bold text-sm sm:text-base xl:text-lg">${set.numParts}</div>
                <div class="text-xs xl:text-sm text-gray-400">${set.quantity > 1 ? `–¥–µ—Ç–∞–ª–µ–π (${set.quantity} —à—Ç.)` : '–¥–µ—Ç–∞–ª–µ–π'}</div>
            </div>
        </div>
    `).join('');
    
    return `
        <div class="p-3 sm:p-4 lg:p-6 xl:p-8 space-y-4 sm:space-y-6 xl:space-y-8">
            ${subViewTabs}
            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –Ω–∞–±–æ—Ä–æ–≤ -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-1.5 sm:gap-3 xl:gap-6">
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Set("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-green-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${setsStats.totalSets}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">${pluralize(setsStats.totalSets, ['–Ω–∞–±–æ—Ä', '–Ω–∞–±–æ—Ä–∞', '–Ω–∞–±–æ—Ä–æ–≤'])}</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Brick("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-blue-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${setsStats.totalPieces}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">${pluralize(setsStats.totalPieces, ['–¥–µ—Ç–∞–ª—å', '–¥–µ—Ç–∞–ª–∏', '–¥–µ—Ç–∞–ª–µ–π'])}</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Calculator("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-yellow-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${setsStats.averagePieces}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">–°—Ä–µ–¥–Ω–µ–µ</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Cat("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-orange-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${Object.keys(setsStats.themeStats).length}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">${pluralize(Object.keys(setsStats.themeStats).length, ['—Ç–µ–º–∞', '—Ç–µ–º—ã', '—Ç–µ–º'])}</div>
                </div>
            </div>

            <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏ -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6 xl:gap-8">
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                <div class="space-y-4 sm:space-y-6">
                    <!-- –¢–æ–ø —Ç–µ–º—ã –Ω–∞–±–æ—Ä–æ–≤ -->
                    <div class="bg-gray-800 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8">
                        <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                            <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-purple-400">${I_Tags('w-full h-full')}</div>
                            <span class="hidden sm:inline">–¢–æ–ø-10 —Ç–µ–º –Ω–∞–±–æ—Ä–æ–≤</span>
                            <span class="sm:hidden">–¢–æ–ø —Ç–µ–º—ã</span>
                        </h3>
                        <div class="space-y-2 sm:space-y-3 xl:space-y-4">
                            ${topThemesHtml}
                        </div>
                    </div>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                <div class="space-y-4 sm:space-y-6">
                    <!-- –¢–æ–ø –Ω–∞–±–æ—Ä—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–µ—Ç–∞–ª–µ–π -->
                    <div class="bg-gray-800 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8">
                        <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                            <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-orange-400">${I_Brick('w-full h-full')}</div>
                            <span class="hidden sm:inline">–¢–æ–ø-10 –Ω–∞–±–æ—Ä–æ–≤ –ø–æ –¥–µ—Ç–∞–ª—è–º</span>
                            <span class="sm:hidden">–¢–æ–ø –Ω–∞–±–æ—Ä—ã</span>
                        </h3>
                        <div class="space-y-2 sm:space-y-3 xl:space-y-4">
                            ${topSetsHtml}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderMinifigsAnalytics(analytics, subViewTabs) {
    const minifigsStats = analytics.minifigsStats;
    
    console.log('üé® renderMinifigsAnalytics called with:', {
        topMinifigs: minifigsStats.topMinifigs?.length || 0,
        topRareMinifigs: minifigsStats.topRareMinifigs?.length || 0,
        totalMinifigs: minifigsStats.totalMinifigs || 0
    });
    
    // –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ø-5 –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏
    if (minifigsStats.topRareMinifigs && minifigsStats.topRareMinifigs.length > 0) {
        minifigsStats.topRareMinifigs.slice(0, 5).forEach((minifig, index) => {
            console.log(`${index + 1}. ${minifig.minifigName} - ${minifig.rarityName} (${minifig.rarity})`);
        });
    }

    const topMinifigsHtml = minifigsStats.topMinifigs.map(minifig => `
        <div class="flex items-center justify-between p-2 sm:p-3 xl:p-4 bg-gray-800 rounded-[18px] cursor-pointer hover:bg-gray-700 active:bg-gray-600 transition-all duration-150 touch-manipulation group shadow-lg" 
             style="--item-color: #f59e0b;"
             data-action="open-minifig-modal" data-minifig-id="${minifig.minifigNum}" 
             title="–û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É: ${minifig.minifigName}">
            <div class="flex items-center gap-2 sm:gap-3 xl:gap-4 min-w-0 flex-1">
                <div class="w-8 h-8 sm:w-10 sm:h-10 xl:w-12 xl:h-12 rounded-[18px] flex-shrink-0 bg-white overflow-hidden">
                    <img src="${minifig.minifigImgUrl || `https://cdn.rebrickable.com/media/minifigs/${minifig.minifigNum}.jpg`}" 
                         alt="${minifig.minifigName}" 
                         class="w-full h-full object-contain rounded-[18px]"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiBmaWxsPSIjRkZGRkZGIi8+CjxwYXRoIGQ9Ik0yNCA4QzI2LjIwOTEgOCAyOCA5Ljc5MDkgMjggMTJDMjggMTQuMjA5MSAyNi4yMDkxIDE2IDI0IDE2QzIxLjc5MDkgMTYgMjAgMTQuMjA5MSAyMCAxMkMyMCA5Ljc5MDkgMjEuNzkwOSA4IDI0IDhaIiBmaWxsPSIjRkZCNzAwIi8+CjxwYXRoIGQ9Ik0yNCAyMEMyNi4yMDkxIDIwIDI4IDIxLjc5MDkgMjggMjRDMjggMjYuMjA5MSAyNi4yMDkxIDI4IDI0IDI4QzIxLjc5MDkgMjggMjAgMjYuMjA5MSAyMCAyNEMyMCAyMS43OTA5IDIxLjc5MDkgMjAgMjQgMjBaIiBmaWxsPSIjRkZCNzAwIi8+CjxwYXRoIGQ9Ik0yNCAzMkMyNi4yMDkxIDMyIDI4IDMzLjc5MDkgMjggMzZDMjggMzguMjA5MSAyNi4yMDkxIDQwIDI0IDQwQzIxLjc5MDkgNDAgMjAgMzguMjA5MSAyMCAzNkMyMCAzMy43OTA5IDIxLjc5MDkgMzIgMjQgMzJaIiBmaWxsPSIjRkZCNzAwIi8+Cjwvc3ZnPgo='">
                </div>
                <div class="min-w-0 flex-1">
                    <div class="text-white font-medium text-xs sm:text-sm xl:text-base truncate">${minifig.minifigName}</div>
                </div>
            </div>
            <div class="text-right flex-shrink-0 ml-2">
                <div class="text-white font-bold text-sm sm:text-base xl:text-lg">${minifig.quantity}</div>
            </div>
        </div>
    `).join('');

    const topRareMinifigsHtml = minifigsStats.topRareMinifigs.map(minifig => `
        <div class="flex items-center justify-between p-2 sm:p-3 xl:p-4 bg-gray-800 rounded-[18px] cursor-pointer hover:bg-gray-700 active:bg-gray-600 transition-all duration-150 touch-manipulation group shadow-lg" 
             style="--item-color: ${minifig.rarityColor};"
             data-action="open-minifig-modal" data-minifig-id="${minifig.minifigNum}" 
             title="–û—Ç–∫—Ä—ã—Ç—å –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É: ${minifig.minifigName} (${minifig.rarityName})">
            <div class="flex items-center gap-2 sm:gap-3 xl:gap-4 min-w-0 flex-1">
                <div class="w-8 h-8 sm:w-10 sm:h-10 xl:w-12 xl:h-12 rounded-[18px] flex-shrink-0 bg-white overflow-hidden">
                    <img src="${minifig.minifigImgUrl || `https://cdn.rebrickable.com/media/minifigs/${minifig.minifigNum}.jpg`}" 
                         alt="${minifig.minifigName}" 
                         class="w-full h-full object-contain rounded-[18px]"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDgiIGhlaWdodD0iNDgiIHZpZXdCb3g9IjAgMCA0OCA0OCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQ4IiBoZWlnaHQ9IjQ4IiBmaWxsPSIjRkZGRkZGIi8+CjxwYXRoIGQ9Ik0yNCA4QzI2LjIwOTEgOCAyOCA5Ljc5MDkgMjggMTJDMjggMTQuMjA5MSAyNi4yMDkxIDE2IDI0IDE2QzIxLjc5MDkgMTYgMjAgMTQuMjA5MSAyMCAxMkMyMCA5Ljc5MDkgMjEuNzkwOSA4IDI0IDhaIiBmaWxsPSIjRkZCNzAwIi8+CjxwYXRoIGQ9Ik0yNCAyMEMyNi4yMDkxIDIwIDI4IDIxLjc5MDkgMjggMjRDMjggMjYuMjA5MSAyNi4yMDkxIDI4IDI0IDI4QzIxLjc5MDkgMjggMjAgMjYuMjA5MSAyMCAyNEMyMCAyMS43OTA5IDIxLjc5MDkgMjAgMjQgMjBaIiBmaWxsPSIjRkZCNzAwIi8+CjxwYXRoIGQ9Ik0yNCAzMkMyNi4yMDkxIDMyIDI4IDMzLjc5MDkgMjggMzZDMjggMzguMjA5MSAyNi4yMDkxIDQwIDI0IDQwQzIxLjc5MDkgNDAgMjAgMzguMjA5MSAyMCAzNkMyMCAzMy43OTA5IDIxLjc5MDkgMzIgMjQgMzJaIiBmaWxsPSIjRkZCNzAwIi8+Cjwvc3ZnPgo='">
                </div>
                <div class="min-w-0 flex-1">
                    <div class="text-white font-medium text-xs sm:text-sm xl:text-base truncate">${minifig.minifigName}</div>
                    <div class="flex items-center gap-2 mt-1">
                        <div class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: ${minifig.rarityColor}"></div>
                        <div class="text-xs text-gray-400 truncate">${minifig.rarityName}</div>
                        ${minifig.theme && minifig.theme !== '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ç–µ–º–∞' ? `<div class="text-xs text-gray-500 truncate">‚Ä¢ ${minifig.theme}</div>` : ''}
                    </div>
                </div>
            </div>
            <div class="text-right flex-shrink-0 ml-2">
                <div class="text-white font-bold text-sm sm:text-base xl:text-lg">${minifig.quantity}</div>
                <div class="text-xs text-gray-400">${minifig.numParts} pcs</div>
            </div>
        </div>
    `).join('');
    
    return `
        <div class="p-3 sm:p-4 lg:p-6 xl:p-8 space-y-4 sm:space-y-6 xl:space-y-8">
            ${subViewTabs}
            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ -->
            <div class="grid grid-cols-1 gap-1.5 sm:gap-3 xl:gap-6">
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Minifig("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-purple-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${minifigsStats.totalMinifigs}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">${pluralize(minifigsStats.totalMinifigs, ['–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞', '–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏', '–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫'])}</div>
                </div>
            </div>

            <!-- –¢–æ–ø –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É -->
            <div class="bg-gray-800 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8">
                <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-blue-400">${I_Users('w-full h-full')}</div>
                    <span class="hidden sm:inline">–¢–æ–ø-10 –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É</span>
                    <span class="sm:hidden">–¢–æ–ø –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É</span>
                </h3>
                <div class="space-y-2 sm:space-y-3 xl:space-y-4">
                    ${topMinifigsHtml}
                </div>
            </div>

            <!-- –¢–æ–ø –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ -->
            <div class="bg-gray-800 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8">
                <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-yellow-400">${I_Star('w-full h-full')}</div>
                    <span class="hidden sm:inline">–¢–æ–ø-10 –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏</span>
                    <span class="sm:hidden">–¢–æ–ø –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏</span>
                </h3>
                <div class="space-y-2 sm:space-y-3 xl:space-y-4">
                    ${topRareMinifigsHtml}
                </div>
            </div>
        </div>
    `;
}

function renderDashboardAnalytics(analytics, subViewTabs) {
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    if (!analytics) {
        console.error('‚ùå Analytics data is null or undefined');
        return `
            <div class="p-3 sm:p-4 lg:p-6 xl:p-8">
                ${subViewTabs}
                <div class="bg-gray-800 rounded-[18px] p-8 text-center">
                    <div class="mb-4">
                        <div class="w-16 h-16 mx-auto text-yellow-400">${I_Info('w-full h-full')}</div>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-2">–î–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</h3>
                    <p class="text-gray-400">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é</p>
                </div>
            </div>
        `;
    }
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
    const yearData = prepareYearData(analytics);
    const themeData = prepareThemeData(analytics);
    const colorData = prepareColorData(analytics);
    const categoryData = prepareCategoryData(analytics);
    const rarityData = prepareRarityData(analytics);
    const setSizeData = prepareSetSizeData(analytics);
    const yearThemeData = prepareYearThemeData(analytics);
    
    
    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
    const dashboardHtml = `
        <div class="p-3 sm:p-4 lg:p-6 xl:p-8 space-y-4 sm:space-y-6 xl:space-y-8">
            ${subViewTabs}
            
            <!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-1.5 sm:gap-3 xl:gap-6">
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Brick("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-blue-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalParts}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">${pluralize(analytics.totalParts, ['–¥–µ—Ç–∞–ª—å', '–¥–µ—Ç–∞–ª–∏', '–¥–µ—Ç–∞–ª–µ–π'])}</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Brick("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-green-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalUniqueParts}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">${pluralize(analytics.totalUniqueParts, ['—É–Ω–∏–∫–∞–ª—å–Ω–∞—è', '—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ', '—É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö'])}</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Set("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-green-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalSets}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">–ù–∞–±–æ—Ä–æ–≤</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Minifig("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-purple-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalMinifigs}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Palette("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-yellow-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalColors || 0}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">–¶–≤–µ—Ç–æ–≤</div>
                </div>
                <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-2 sm:p-3 xl:p-6 text-center transition-all duration-200">
                    <div class="flex items-center justify-center mb-2">
                        ${I_Cat("w-4 h-4 sm:w-5 sm:h-5 xl:w-6 xl:h-6 text-orange-400")}
                    </div>
                    <div class="text-sm sm:text-lg lg:text-xl xl:text-3xl font-bold text-white">${analytics.totalCategories || 0}</div>
                    <div class="text-xs sm:text-sm xl:text-base text-gray-400">–ö–∞—Ç–µ–≥–æ—Ä–∏–π</div>
                </div>
            </div>
            
            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –≥–æ–¥–∞–º –≤—ã–ø—É—Å–∫–∞ -->
            <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8 transition-all duration-200">
                <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-blue-400">${I_Calendar('w-full h-full')}</div>
                    <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≥–æ–¥–∞–º –≤—ã–ø—É—Å–∫–∞</span>
                </h3>
                <div class="bg-gray-700/20 rounded-[18px] p-3 sm:p-4 lg:p-6">
                    ${yearData.length > 0 ? `
                        <div class="h-50 sm:h-80 xl:h-96 relative">
                            ${renderLineChart(yearData)}
                        </div>
                    ` : `
                        <div class="h-64 sm:h-80 xl:h-96 flex items-center justify-center">
                            <div class="text-gray-400 text-center">
                                <div class="mb-2">
                                    <div class="w-12 h-12 mx-auto text-blue-400">${I_Analytics('w-full h-full')}</div>
                                </div>
                                <div>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –≥–æ–¥–∞—Ö –≤—ã–ø—É—Å–∫–∞</div>
                            </div>
                        </div>
                    `}
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Ç–µ–º–∞–º (–∫—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞) -->
            <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8 transition-all duration-200">
                <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-purple-400">${I_TrendingUp('w-full h-full')}</div>
                    <span>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ç–µ–º–∞–º</span>
                </h3>
                <div class="bg-gray-700/20 rounded-[18px] p-4 sm:p-6">
                    <div class="h-80 sm:h-96 flex items-center justify-center">
                        ${themeData.length > 0 ? renderPieChart(themeData) : '<div class="text-gray-400 text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'}
                    </div>
                    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3">
                        ${themeData.length > 0 ? themeData.map((item, index) => `
                            <div class="flex items-center justify-between p-2 sm:p-3 bg-gray-700/20 rounded-[18px] hover:bg-gray-700/40 transition-all duration-200 shadow-lg cursor-pointer group" data-pie-key="${item.name}-${index}" style="--item-color: ${item.color};" ${item.themeId ? `data-action="go-to-theme" data-theme-id="${item.themeId}"` : ''}>
                                <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                                    <div class="w-4 h-4 rounded-full flex-shrink-0 shadow-sm group-hover:shadow-md transition-shadow duration-200" style="background-color: ${item.color}"></div>
                                    <span class="text-gray-200 text-sm sm:text-base truncate group-hover:text-white transition-colors duration-200">${item.name}</span>
                                </div>
                                <div class="text-right flex-shrink-0 ml-2">
                                    <div class="text-white font-bold text-sm sm:text-base group-hover:text-blue-200 transition-colors duration-200">${item.count}</div>
                                    <div class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors duration-200">${item.percentage.toFixed(1)}%</div>
                                </div>
                            </div>
                        `).join('') : '<div class="text-gray-400 text-center py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ç–µ–º–∞—Ö</div>'}
                    </div>
                </div>
            </div>


            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–µ—Ç–∞–ª–µ–π -->
            <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8 transition-all duration-200">
                <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-purple-400">${I_Puzzle('w-full h-full')}</div>
                    <span>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–µ—Ç–∞–ª–µ–π</span>
                </h3>
                <div class="bg-gray-700/20 rounded-[18px] p-4 sm:p-6">
                    <div class="h-80 sm:h-96 flex items-center justify-center">
                        ${renderPieChart(categoryData)}
                    </div>
                    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3">
                        ${categoryData.map((item, index) => `
                            <div class="flex items-center justify-between p-2 sm:p-3 bg-gray-700/20 rounded-[18px] hover:bg-gray-700/40 transition-all duration-200 shadow-lg cursor-pointer group" data-pie-key="${item.name}-${index}" style="--item-color: ${item.color};" ${item.categoryId ? `data-action="filter-by-category" data-category-id="${item.categoryId}" data-category-name="${item.name}"` : ''}>
                                <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                                    <div class="w-4 h-4 rounded-full flex-shrink-0 shadow-sm group-hover:shadow-md transition-shadow duration-200" style="background-color: ${item.color}"></div>
                                    <span class="text-gray-200 text-sm sm:text-base truncate group-hover:text-white transition-colors duration-200">${item.name}</span>
                                </div>
                                <div class="text-right flex-shrink-0 ml-2">
                                    <div class="text-white font-bold text-sm sm:text-base group-hover:text-blue-200 transition-colors duration-200">${item.count}</div>
                                    <div class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors duration-200">${item.percentage.toFixed(1)}%</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º –Ω–∞–±–æ—Ä–æ–≤ -->
            <div class="bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 rounded-[18px] p-3 sm:p-4 lg:p-6 xl:p-8 transition-all duration-200">
                <h3 class="text-lg sm:text-xl xl:text-2xl font-bold text-white mb-3 sm:mb-4 xl:mb-6 flex items-center gap-2">
                    <div class="w-6 h-6 sm:w-8 sm:h-8 xl:w-10 xl:h-10 text-green-400">${I_Package('w-full h-full')}</div>
                    <span>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º –Ω–∞–±–æ—Ä–æ–≤</span>
                </h3>
                <div class="bg-gray-700/20 rounded-[18px] p-4 sm:p-6">
                    <div class="h-80 sm:h-96 flex items-center justify-center">
                        ${renderPieChart(setSizeData)}
                    </div>
                    <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3">
                        ${setSizeData.map((item, index) => `
                            <div class="flex items-center justify-between p-2 sm:p-3 bg-gray-700/20 rounded-[18px] hover:bg-gray-700/40 transition-all duration-200 shadow-lg cursor-pointer group" data-pie-key="${item.name}-${index}" style="--item-color: ${item.color};" ${`data-action=\"open-set-size-filter\" data-min=\"${item.min ?? ''}\" data-max=\"${item.max ?? ''}\"`}>
                                <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
                                    <div class="w-4 h-4 rounded-full flex-shrink-0 shadow-sm group-hover:shadow-md transition-shadow duration-200" style="background-color: ${item.color}"></div>
                                    <span class="text-gray-200 text-sm sm:text-base truncate group-hover:text-white transition-colors duration-200">${item.name}</span>
                                </div>
                                <div class="text-right flex-shrink-0 ml-2">
                                    <div class="text-white font-bold text-sm sm:text-base group-hover:text-blue-200 transition-colors duration-200">${item.count}</div>
                                    <div class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors duration-200">${item.percentage.toFixed(1)}%</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>

        </div>
    `;
    
    
    return dashboardHtml;
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
function prepareYearData(analytics) {
    const yearStats = analytics.setsStats?.yearStats || {};
    const years = Object.keys(yearStats).map(Number).sort((a, b) => a - b);
    const maxCount = Math.max(...Object.values(yearStats));
    
    return years.map(year => ({
        year: year.toString(),
        count: yearStats[year] || 0,
        height: maxCount > 0 ? Math.max((yearStats[year] / maxCount) * 200, 4) : 4
    }));
}

// –ü–æ–º–æ—â–Ω–∏–∫–∏: –ø–æ–≤—ã—à–µ–Ω–∏–µ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏/—è—Ä–∫–æ—Å—Ç–∏ –¥–ª—è —Ç—ë–º–Ω–æ–≥–æ —Ñ–æ–Ω–∞
function __hexToRgb(hex){const m=hex?.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);if(!m)return null;return{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}}
function __rgbToHex(r,g,b){const h=v=>v.toString(16).padStart(2,'0');return `#${h(Math.max(0,Math.min(255,Math.round(r))))}${h(Math.max(0,Math.min(255,Math.round(g))))}${h(Math.max(0,Math.min(255,Math.round(b))))}`}
function __rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h=0,s=0,l=(max+min)/2;if(max!==min){const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return{h,s,l}}
function __hslToRgb(h,s,l){let r,g,b;if(s===0){r=g=b=l}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};const q=l<0.5?l*(1+s):l+s-l*s;const p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3)}return{r:r*255,g:g*255,b:b*255}}
// –î–µ–ª–∞–µ–º —Ü–≤–µ—Ç–∞ –±–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–º–∏, –Ω–µ –ø–æ–≤—ã—à–∞—è —è—Ä–∫–æ—Å—Ç—å (l –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å)
function adjustColorForDarkBg(hex){
    const rgb=__hexToRgb(hex); if(!rgb) return hex||'#86efac';
    const hsl=__rgbToHsl(rgb.r,rgb.g,rgb.b);
    const s=Math.min(1, hsl.s*1.35 + 0.06); // —Ç–æ–ª—å–∫–æ –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å
    const l=hsl.l; // —è—Ä–∫–æ—Å—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    const r2=__hslToRgb(hsl.h,s,l);
    return __rgbToHex(r2.r,r2.g,r2.b);
}

function prepareThemeData(analytics) {
    const themeStats = analytics.setsStats?.themeStats || {};
    const total = Object.values(themeStats).reduce((sum, count) => sum + count, 0);
    // –í—ã—Å–æ–∫–æ–∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞ —Ü–≤–µ—Ç–æ–≤, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–ª—è —Ç–µ–º–Ω–æ–≥–æ —Ñ–æ–Ω–∞
    const colors = [
        '#60a5fa', '#f87171', '#34d399', '#fbbf24', '#a78bfa', '#22d3ee', '#a3e635', '#fb923c', '#f472b6', '#818cf8',
        '#2dd4bf', '#fb7185', '#d97706', '#8b5cf6', '#38bdf8', '#4ade80', '#eab308', '#f97316', '#ec4899', '#6366f1',
        '#14b8a6', '#f43f5e', '#a16207', '#7c3aed', '#0ea5e9', '#22c55e', '#eab308', '#f97316', '#ef4444', '#8b5cf6',
        '#06b6d4', '#84cc16', '#f59e0b', '#ec4899', '#6366f1', '#14b8a6', '#f43f5e', '#8b5a2b', '#7c3aed', '#0ea5e9',
        '#22c55e', '#eab308', '#f97316', '#ef4444', '#8b5cf6', '#06b6d4', '#84cc16', '#f59e0b', '#ec4899', '#6366f1'
    ];
    // –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç–∏/—è—Ä–∫–æ—Å—Ç–∏ –ø–æ–¥ —Ç—ë–º–Ω—ã–π —Ñ–æ–Ω
    function hexToRgb(hex){const m=hex?.match(/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);if(!m)return null;return{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}}
    function rgbToHex(r,g,b){const h=v=>v.toString(16).padStart(2,'0');return `#${h(Math.max(0,Math.min(255,Math.round(r))))}${h(Math.max(0,Math.min(255,Math.round(g))))}${h(Math.max(0,Math.min(255,Math.round(b))))}`}
    function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h=0,s=0,l=(max+min)/2;if(max!==min){const d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break}h/=6}return{h,s,l}}
    function hslToRgb(h,s,l){let r,g,b;if(s===0){r=g=b=l}else{const hue2rgb=(p,q,t)=>{if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p};const q=l<0.5?l*(1+s):l+s-l*s;const p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3)}return{r:r*255,g:g*255,b:b*255}}
    function adjustColor(hex){const rgb=hexToRgb(hex);if(!rgb)return hex||'#86efac';const hsl=rgbToHsl(rgb.r,rgb.g,rgb.b);const s=Math.min(1,hsl.s*1.25+0.05);const l=Math.min(1,hsl.l*1.12+0.03);const r2=hslToRgb(hsl.h,s,l);return rgbToHex(r2.r,r2.g,r2.b)}
    
    return Object.entries(themeStats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 15) // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ–º –¥–æ 15
        .map(([origName, count], index) => {
            // –ò—â–µ–º themeId –ø–æ –ø–æ–ª–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–µ–º—ã
            const foundId = Object.keys(THEME_MAP).find(id => THEME_MAP[id]?.name === origName);
            const themeId = foundId ? parseInt(foundId, 10) : null;
            const displayName = origName.length > 20 ? origName.substring(0, 20) + '...' : origName;
            return {
                name: displayName,
                count,
                percentage: total > 0 ? (count / total) * 100 : 0,
                color: adjustColorForDarkBg(colors[index % colors.length]),
                themeId
            };
        });
}

function prepareColorData(analytics) {
    const colorStats = analytics.colorStats || {};
    const total = Object.values(colorStats).reduce((sum, count) => sum + count, 0);
    
    return Object.entries(colorStats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10)
        .map(([name, count]) => {
            const colorId = Object.keys(COLOR_MAP).find(id => COLOR_MAP[id]?.name === name);
            const color = colorId ? COLOR_MAP[colorId]?.rgb : '#666666';
            return {
                name: name.length > 15 ? name.substring(0, 15) + '...' : name,
                count,
                percentage: total > 0 ? (count / total) * 100 : 0,
                color: color
            };
        });
}

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
function prepareCategoryData(analytics) {
    const categoryStats = analytics.categoryStats || {};
    const total = Object.values(categoryStats).reduce((sum, count) => sum + count, 0);
    const colors = [
        '#60a5fa', '#f87171', '#34d399', '#fbbf24', '#a78bfa', '#22d3ee', '#a3e635', '#fb923c', '#f472b6', '#818cf8',
        '#2dd4bf', '#fb7185', '#d97706', '#8b5cf6', '#38bdf8', '#4ade80', '#eab308', '#f97316', '#ec4899', '#6366f1'
    ];
    
    return Object.entries(categoryStats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 12)
        .map(([origName, count], index) => {
            // –ò—â–µ–º categoryId –ø–æ –ø–æ–ª–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const categoryId = flatCategories.find(cat => cat.name === origName)?.id || null;
            const displayName = origName.length > 25 ? origName.substring(0, 25) + '...' : origName;
            return {
                name: displayName,
                count,
                percentage: total > 0 ? (count / total) * 100 : 0,
                color: adjustColorForDarkBg(colors[index % colors.length]),
                categoryId
            };
        });
}

function prepareRarityData(analytics) {
    const rarityStats = analytics.rarityStats || {};
    const total = Object.values(rarityStats).reduce((sum, count) => sum + count, 0);
    const rarityColors = {
        'legendary': '#ff6b6b',
        'epic': '#4ecdc4',
        'rare': '#45b7d1',
        'uncommon': '#96ceb4',
        'common': '#feca57',
        'unknown': '#a4a4a4'
    };
    
    return Object.entries(rarityStats)
        .filter(([rarity, count]) => count > 0)
        .sort(([,a], [,b]) => b - a)
        .map(([rarity, count]) => ({
            name: getRarityName(rarity),
            count,
            percentage: total > 0 ? (count / total) * 100 : 0,
            color: rarityColors[rarity] || '#a4a4a4'
        }));
}

function prepareSetSizeData(analytics) {
    const setsStats = analytics.setsStats || {};
    const setSizes = {
        'Micro (1-50 –¥–µ—Ç–∞–ª–µ–π)': 0,
        'Small (51-200 –¥–µ—Ç–∞–ª–µ–π)': 0,
        'Medium (201-500 –¥–µ—Ç–∞–ª–µ–π)': 0,
        'Large (501-1000 –¥–µ—Ç–∞–ª–µ–π)': 0,
        'X-Large (1001-2000 –¥–µ—Ç–∞–ª–µ–π)': 0,
        'XX-Large (2000+ –¥–µ—Ç–∞–ª–µ–π)': 0
    };
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã –Ω–∞–±–æ—Ä–æ–≤ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    if (typeof S !== 'undefined' && S.setColl) {
        Object.entries(S.setColl).forEach(([setNum, setData]) => {
            const set = SET_MAP[setNum];
            if (set && set.num_parts) {
                const parts = set.num_parts;
                if (parts <= 50) setSizes['Micro (1-50 –¥–µ—Ç–∞–ª–µ–π)'] += setData.qty;
                else if (parts <= 200) setSizes['Small (51-200 –¥–µ—Ç–∞–ª–µ–π)'] += setData.qty;
                else if (parts <= 500) setSizes['Medium (201-500 –¥–µ—Ç–∞–ª–µ–π)'] += setData.qty;
                else if (parts <= 1000) setSizes['Large (501-1000 –¥–µ—Ç–∞–ª–µ–π)'] += setData.qty;
                else if (parts <= 2000) setSizes['X-Large (1001-2000 –¥–µ—Ç–∞–ª–µ–π)'] += setData.qty;
                else setSizes['XX-Large (2000+ –¥–µ—Ç–∞–ª–µ–π)'] += setData.qty;
            }
        });
    }
    
    const total = Object.values(setSizes).reduce((sum, count) => sum + count, 0);
    const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3'];
    
    const ranges = {
        'Micro (1-50 –¥–µ—Ç–∞–ª–µ–π)': { min: 1, max: 50 },
        'Small (51-200 –¥–µ—Ç–∞–ª–µ–π)': { min: 51, max: 200 },
        'Medium (201-500 –¥–µ—Ç–∞–ª–µ–π)': { min: 201, max: 500 },
        'Large (501-1000 –¥–µ—Ç–∞–ª–µ–π)': { min: 501, max: 1000 },
        'X-Large (1001-2000 –¥–µ—Ç–∞–ª–µ–π)': { min: 1001, max: 2000 },
        'XX-Large (2000+ –¥–µ—Ç–∞–ª–µ–π)': { min: 2001, max: null }
    };
    
    return Object.entries(setSizes)
        .filter(([,count]) => count > 0)
        .sort(([,a], [,b]) => b - a)
        .map(([name, count], index) => ({
            name,
            count,
            percentage: total > 0 ? (count / total) * 100 : 0,
            color: adjustColorForDarkBg(colors[index % colors.length]),
            min: ranges[name]?.min ?? null,
            max: ranges[name]?.max ?? null
        }));
}

function prepareYearThemeData(analytics) {
    const yearStats = analytics.setsStats?.yearStats || {};
    const themeStats = analytics.setsStats?.themeStats || {};
    
    // –ë–µ—Ä–µ–º —Ç–æ–ø-5 —Ç–µ–º –∏ —Ç–æ–ø-10 –ª–µ—Ç
    const topThemes = Object.entries(themeStats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5)
        .map(([name]) => name);
    
    const topYears = Object.entries(yearStats)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10)
        .map(([year]) => parseInt(year));
    
    
    // –°–æ–∑–¥–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É –¥–∞–Ω–Ω—ã—Ö
    const matrix = topYears.map(year => {
        const yearData = { year, themes: {} };
        topThemes.forEach(theme => {
            yearData.themes[theme] = 0;
        });
        return yearData;
    });
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    if (typeof S !== 'undefined' && S.setColl) {
        let processedSets = 0;
        let matchedSets = 0;
        Object.entries(S.setColl).forEach(([setNum, setData]) => {
            processedSets++;
            const set = SET_MAP[setNum];
            if (set && set.year && set.theme) {
                const year = parseInt(set.year);
                const theme = set.theme;
                if (topYears.includes(year) && topThemes.includes(theme)) {
                    const yearIndex = topYears.indexOf(year);
                    matrix[yearIndex].themes[theme] += setData.qty;
                    matchedSets++;
                } else {
                }
            } else {
            }
        });
    } else {
    }
    
    
    
    return { matrix, topThemes, topYears };
}

function renderPieChart(data) {
    if (data.length === 0) return '<div class="text-gray-400 text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É
    const items = data
        .map((d, i) => ({
            key: `${d.name}-${i}`,
            name: d.name,
            count: d.count || 0,
            color: d.color || '#888888'
        }))
        .filter(d => d.count > 0);
    if (items.length === 0) return '<div class="text-gray-400 text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    
    const total = items.reduce((s, x) => s + x.count, 0);
    
    // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã
    const svgSize = 420;
    const centerX = svgSize / 2;
    const centerY = svgSize / 2;
    const radius = 120; // –≤–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–∞–¥–∏—É—Å
    const strokeWidth = 32; // —Ç–æ–ª—â–∏–Ω–∞ –¥–æ–Ω–∞—Ç–∞
    const innerRadius = radius - strokeWidth / 2;
    const circumference = 2 * Math.PI * innerRadius;
    
    // –†–∞—Å—á–µ—Ç —Å–µ–≥–º–µ–Ω—Ç–æ–≤
    let acc = 0;
    const baseStartOffset = circumference * 0.25; // —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ 12 —á–∞—Å–æ–≤
    const segments = items.map((d, index) => {
        const fraction = d.count / total;
        const segLength = circumference * fraction;
        const gap = Math.max(2, Math.min(6, circumference * 0.003));
        const offset = (circumference - acc) % circumference;
        acc += segLength;
        
        // –ë–∞–∑–æ–≤—ã–π —É–≥–æ–ª –≤ —Å–∏—Å—Ç–µ–º–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç SVG (0 —Ä–∞–¥ = 3 —á–∞—Å–∞)
        const startAngle = (acc - segLength) / circumference * 2 * Math.PI;
        const midAngle = startAngle + (segLength / circumference) * Math.PI;
        // –ü–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≥–µ–æ–º–µ—Ç—Ä–∏—é –ø–æ–¥–ø–∏—Å–µ–π –Ω–∞ 12 —á–∞—Å–æ–≤
        const angleForPositions = midAngle - Math.PI / 2;
        const moveDistance = 10;
        const moveX = moveDistance * Math.cos(angleForPositions);
        const moveY = moveDistance * Math.sin(angleForPositions);
        
        // –ü–æ–∑–∏—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏
        const small = fraction < 0.05;
        const labelR = radius + (small ? 58 : 40);
        const labelX = centerX + labelR * Math.cos(angleForPositions);
        const labelY = centerY + labelR * Math.sin(angleForPositions);
        const connector = small
            ? `<line x1="${centerX + innerRadius * Math.cos(angleForPositions)}" y1="${centerY + innerRadius * Math.sin(angleForPositions)}" x2="${labelX}" y2="${labelY}" stroke="${d.color}" stroke-width="2" opacity="0.8" />`
            : '';
        
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–æ—Ü–µ–Ω—Ç–∞
        const pct = ((d.count / total) * 100);
        const pctText = pct.toFixed(1) + '%';
        const pad = 6;
        const estTextWidth = pctText.length * 6 + 4;
        const cW = estTextWidth + pad * 2;
        const cH = 20;
        const cX = labelX - cW / 2;
        const cY = labelY - cH / 2;
        
        return {
            key: d.key,
            name: d.name,
            color: d.color,
            fraction,
            segLength,
            gap,
            offset,
            moveX,
            moveY,
            pctText,
            labelGroup: `
                <g class="percentage-group" data-sector-index="${index}" data-key="${d.key}">
                    ${connector}
                    <rect x="${cX}" y="${cY}" width="${cW}" height="${cH}" rx="10" ry="10" fill="rgba(0,0,0,0.1)" stroke="${d.color}" stroke-width="1.5" class="percentage-container" />
                    <text x="${labelX}" y="${labelY}" text-anchor="middle" dominant-baseline="middle" class="text-xs font-bold" fill="#ffffff" font-family="system-ui, sans-serif">${pctText}</text>
                </g>
            `
        };
    });
    
    const totalCount = items.reduce((s, x) => s + x.count, 0);
    
    // –ë–∞–∑–æ–≤–æ–µ –∫–æ–ª—å—Ü–æ (–æ–¥–∏–Ω —Ä–∞–∑) –∏ —Å–µ–≥–º–µ–Ω—Ç—ã –≤ –≤–∏–¥–µ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–µ–π —Å–æ —Å–º–µ—â–µ–Ω–∏–µ–º dashoffset
    const baseRing = `<circle cx="${centerX}" cy="${centerY}" r="${innerRadius}" fill="none" stroke="#64748b" stroke-width="${strokeWidth}" class="pie-base-ring" />`;
    const rings = segments.map((s, index) => `
        <g class="pie-sector-group" data-move-x="${s.moveX}" data-move-y="${s.moveY}" data-sector-index="${index}" data-key="${s.key}" ${items[index] ? `data-action=\"open-set-size-filter\" data-min=\"${(data[index]?.min ?? '')}\" data-max=\"${(data[index]?.max ?? '')}\"` : ''}>
            <circle cx="${centerX}" cy="${centerY}" r="${innerRadius}" fill="none" stroke="${s.color}" stroke-width="${strokeWidth}" stroke-linecap="butt"
                stroke-dasharray="${s.segLength} ${Math.max(0, circumference - s.segLength)}" stroke-dashoffset="${(s.offset + baseStartOffset) % circumference}" class="pie-segment" title="${s.name}: ${Math.round(s.fraction*1000)/10}%">
            </circle>
        </g>
    `).join('');
    
    // –†–∞–∑–º–µ—â–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –±–µ–∑ –Ω–∞–ª–æ–∂–µ–Ω–∏–π: –æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –ª–µ–≤–æ–π –∏ –ø—Ä–∞–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã
    const left = [], right = [];
    segments.forEach(s => {
        const labelMatch = s.labelGroup.match(/<text x="([\d.]+)" y="([\d.]+)"/);
        if (!labelMatch) return;
        const x = parseFloat(labelMatch[1]);
        const y = parseFloat(labelMatch[2]);
        if (x < centerX) left.push({ s, x, y }); else right.push({ s, x, y });
    });
    const minGap = 18; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π –∑–∞–∑–æ—Ä –º–µ–∂–¥—É –ø–æ–¥–ø–∏—Å—è–º–∏
    const adjustColumn = (arr) => {
        arr.sort((a,b) => a.y - b.y);
        for (let i = 1; i < arr.length; i++) {
            if (arr[i].y - arr[i-1].y < minGap) {
                arr[i].y = arr[i-1].y + minGap;
            }
        }
    };
    adjustColumn(left); adjustColumn(right);
    function rewriteLabel(s, newY) {
        return s.labelGroup
            .replace(/(<text x="[\d.]+" y=")([\d.]+)("[^>]*>)/, `$1${newY}$3`)
            .replace(/(<rect[^>]* y=")([\d.]+)("[^>]*>)/, (m, p1, yOld, p3) => {
                const hMatch = s.labelGroup.match(/<rect[^>]* height="([\d.]+)"/);
                const h = hMatch ? parseFloat(hMatch[1]) : 20;
                const newRectY = newY - h / 2;
                return `${p1}${newRectY}${p3}`;
            })
            .replace(/(<line[^>]* y2=")([\d.]+)("[^>]*>)/, `$1${newY}$3`);
    }
    const labels = [
        ...left.map(it => rewriteLabel(it.s, it.y)),
        ...right.map(it => rewriteLabel(it.s, it.y))
    ].join('');
    
    return `
        <div class="w-full h-full flex flex-col items-center justify-center">
            <div class="flex-1 flex items-center justify-center">
                <svg viewBox="0 0 ${svgSize} ${svgSize}" class="w-full h-full max-w-full max-h-full pie-chart-svg">
                    ${baseRing}
                    ${rings}
                    ${labels}
                </svg>
            </div>
            <div class="mt-4 text-center text-gray-300 text-sm font-semibold">
                ${totalCount} ${pluralize(totalCount, ['—ç–ª–µ–º–µ–Ω—Ç', '—ç–ª–µ–º–µ–Ω—Ç–∞', '—ç–ª–µ–º–µ–Ω—Ç–æ–≤'])}
            </div>
        </div>
    `;
}

function renderLineChart(data) {
    if (data.length === 0) return '<div class="text-gray-400 text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
    
    const maxCount = Math.max(...data.map(item => item.count));
    const minCount = Math.min(...data.map(item => item.count));
    const range = maxCount - minCount;
    
    // –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä—ã SVG –¥–ª—è –ª—É—á—à–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞
    const width = Math.max(400, Math.min(800, data.length * 30)); // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —à–∏—Ä–∏–Ω–∞
    const height = 200; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    const padding = { top: 20, right: 30, bottom: 50, left: 50 }; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –æ—Å–∏ X
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;
    
    // –í—ã—á–∏—Å–ª—è–µ–º —Ç–æ—á–∫–∏ –¥–ª—è –ª–∏–Ω–∏–∏
    const points = data.map((item, index) => {
        const x = padding.left + (index / (data.length - 1)) * chartWidth;
        const y = padding.top + chartHeight - ((item.count - minCount) / range) * chartHeight;
        return `${x},${y}`;
    }).join(' ');
    
    // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –ª–∏–Ω–∏–∏
    const gradientId = `lineGradient-${Date.now()}`;
    
    // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –ª–∏–Ω–∏–∏
    const circles = data.map((item, index) => {
        const x = padding.left + (index / (data.length - 1)) * chartWidth;
        const y = padding.top + chartHeight - ((item.count - minCount) / range) * chartHeight;
        return `<circle cx="${x}" cy="${y}" r="3" fill="#3b82f6" class="hover:r-4 transition-all duration-200 cursor-pointer" title="${item.year}: ${item.count} –Ω–∞–±–æ—Ä–æ–≤" />`;
    }).join('');
    
    // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π Y (–∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)
    const yAxisLabels = Array.from({length: 6}, (_, i) => {
        const value = minCount + (i / 5) * range;
        const y = padding.top + chartHeight - (i / 5) * chartHeight;
        return `<text x="${padding.left - 8}" y="${y + 4}" text-anchor="end" class="text-xs fill-gray-400" font-family="system-ui, sans-serif">${Math.round(value)}</text>`;
    }).join('');
    
    // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π X (–≥–æ–¥—ã) - —É–º–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –Ω–∞–ª–æ–∂–µ–Ω–∏—è
    const maxLabels = Math.min(8, data.length); // –ú–∞–∫—Å–∏–º—É–º 8 –ø–æ–¥–ø–∏—Å–µ–π
    const showEveryNth = Math.max(1, Math.floor(data.length / maxLabels));
    const xAxisLabels = data.map((item, index) => {
        if (index % showEveryNth !== 0 && index !== data.length - 1) return '';
        const x = padding.left + (index / (data.length - 1)) * chartWidth;
        return `<text x="${x}" y="${height - 25}" text-anchor="middle" class="text-xs fill-gray-400" font-family="system-ui, sans-serif">${item.year}</text>`;
    }).join('');
    
    // –°–æ–∑–¥–∞–µ–º –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏
    const gridLines = Array.from({length: 6}, (_, i) => {
        const y = padding.top + (i / 5) * chartHeight;
        return `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#374151" stroke-width="0.5" opacity="0.3" />`;
    }).join('');
    
    // –°–æ–∑–¥–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ —Å–µ—Ç–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π)
    const verticalGridLines = data.map((_, index) => {
        if (index % showEveryNth !== 0 && index !== data.length - 1) return '';
        const x = padding.left + (index / (data.length - 1)) * chartWidth;
        return `<line x1="${x}" y1="${padding.top}" x2="${x}" y2="${height - padding.bottom}" stroke="#374151" stroke-width="0.5" opacity="0.2" />`;
    }).join('');
    
    return `
        <div class="w-full h-full">
            <svg viewBox="0 0 ${width} ${height}" class="w-full h-full" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <linearGradient id="${gradientId}" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.3" />
                        <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.05" />
                    </linearGradient>
                </defs>
                
                <!-- –°–µ—Ç–∫–∞ -->
                <g>
                    ${gridLines}
                    ${verticalGridLines}
                </g>
                
                <!-- –û—Å–∏ -->
                <line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" stroke="#6b7280" stroke-width="2" />
                <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#6b7280" stroke-width="2" />
                
                <!-- –û–±–ª–∞—Å—Ç—å –ø–æ–¥ –ª–∏–Ω–∏–µ–π -->
                <polygon 
                    points="${padding.left},${padding.top + chartHeight} ${points} ${width - padding.right},${padding.top + chartHeight}" 
                    fill="url(#${gradientId})"
                />
                
                <!-- –õ–∏–Ω–∏—è -->
                <polyline 
                    points="${points}" 
                    fill="none" 
                    stroke="#3b82f6" 
                    stroke-width="2" 
                    stroke-linecap="round" 
                    stroke-linejoin="round"
                    class="hover:stroke-blue-400 transition-colors duration-200"
                />
                
                <!-- –¢–æ—á–∫–∏ –Ω–∞ –ª–∏–Ω–∏–∏ -->
                ${circles}
                
                <!-- –ü–æ–¥–ø–∏—Å–∏ –æ—Å–µ–π -->
                <g>
                    ${yAxisLabels}
                    ${xAxisLabels}
                </g>
                
                <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Å–µ–π -->
                <text x="${width / 2}" y="${height - 2}" text-anchor="middle" class="text-xs fill-gray-300 font-medium" font-family="system-ui, sans-serif">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞</text>
                <text x="15" y="${height / 2}" text-anchor="middle" class="text-xs fill-gray-300 font-medium" font-family="system-ui, sans-serif" transform="rotate(-90, 15, ${height / 2})">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–æ—Ä–æ–≤</text>
            </svg>
        </div>
    `;
}

function renderHeatmap(data) {
    const { matrix, topThemes, topYears } = data;
    const colors = ['#1f2937', '#374151', '#4b5563', '#6b7280', '#9ca3af', '#d1d5db', '#f3f4f6'];
    
    const result = `
        <div class="overflow-x-auto p-4">
            <table class="w-full text-sm border-collapse border border-gray-600">
                <thead>
                    <tr class="bg-gray-700">
                        <th class="text-left p-3 text-gray-200 border border-gray-600 font-bold">–ì–æ–¥</th>
                        ${topThemes.map(theme => `
                            <th class="text-center p-3 text-gray-200 border border-gray-600 font-bold min-w-20" title="${theme}">${theme.length > 12 ? theme.substring(0, 12) + '...' : theme}</th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody>
                    ${matrix.map(row => `
                        <tr class="hover:bg-gray-800">
                            <td class="p-3 text-gray-300 font-bold border border-gray-600">${row.year}</td>
                            ${topThemes.map(theme => {
                                const value = row.themes[theme] || 0;
                                const maxValue = Math.max(...matrix.flatMap(r => Object.values(r.themes)));
                                const intensity = maxValue > 0 ? Math.min(value / maxValue, 1) : 0;
                                const colorIndex = Math.floor(intensity * (colors.length - 1));
                                
                                
                                return `
                                    <td class="text-center p-3 border border-gray-600 font-bold" style="background-color: ${colors[colorIndex]}; color: ${intensity > 0.5 ? 'white' : 'black'}" title="${theme} –≤ ${row.year}: ${value} –Ω–∞–±–æ—Ä–æ–≤">
                                        ${value > 0 ? value : '-'}
                                    </td>
                                `;
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
    
    return result;
}

const sidebarEl = document.getElementById('sidebar-container'),
    backdropEl = document.getElementById('sidebar-backdrop'),
    headerEl = document.getElementById('header-container'),
    mainEl = document.getElementById('main-content'),
    partModalEl = document.getElementById('modal-container'),
    setModalEl = document.getElementById('set-modal-container'),
    colorsModalEl = document.getElementById('colors-modal-container'),
    minifigModalEl = document.getElementById('minifig-modal-container'),
    filterModalEl = document.getElementById('filter-modal-container'),
    settingsModalEl = document.getElementById('settings-modal-container'),
    relatedSetsModalEl = document.getElementById('related-sets-modal-container'),
    toTopBtn = document.getElementById('scroll-to-top-btn'),
    viewerEl = document.getElementById('image-viewer-container'),
    viewerImg = document.getElementById('fullscreen-image'),
    viewerCloseBtn = document.getElementById('image-viewer-close');

async function apiFetchPaginated(e) {
    let t = [];
    let o = 1;
    let retryCount = 0;
    const maxRetries = 3;
    
    for (;;) {
        const l = e.includes("?") ? "&" : "?",
            a = `${REBRICKABLE_API_URL}${e}${l}page=${o}&page_size=800`;
        
        console.log(`API call: ${a}`);
        
        try {
            const i = await fetchWithProxy(a, {
                headers: {
                    Authorization: `key ${getApiKey()}`
                }
            });
            
            if (!i.ok) {
                const errorData = await i.json().catch(() => ({
                    detail: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏."
                }));
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –æ—à–∏–±–æ–∫
                if (i.status === 429) {
                    console.warn(`‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ (429), –∂–¥–µ–º 5 —Å–µ–∫—É–Ω–¥...`);
                    await new Promise(resolve => setTimeout(resolve, 5000));
                    retryCount++;
                    if (retryCount <= maxRetries) continue;
                } else if (i.status >= 500) {
                    console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${i.status}), –ø–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã...`);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    retryCount++;
                    if (retryCount <= maxRetries) continue;
                }
                
                throw new Error(`–û—à–∏–±–∫–∞ API Rebrickable: ${i.status} - ${errorData.detail}`)
            }
            
            const n = await i.json();
            retryCount = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
            
            console.log(`API response page ${o}:`, {
                status: i.status,
                hasResults: !!n.results,
                resultsCount: n.results?.length || 0,
                hasNext: !!n.next,
                sampleResult: n.results?.[0] ? {
                    part_num: n.results[0].part_num,
                    name: n.results[0].name,
                    has_part_img_url: !!n.results[0].part_img_url,
                    part_img_url: n.results[0].part_img_url
                } : null
            });
            
            if (n.results?.length > 0) {
                t = t.concat(n.results)
            }
            if (!n.next) break;
            o++
            
        } catch (error) {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${o}:`, error.message);
            retryCount++;
            
            if (retryCount <= maxRetries) {
                console.log(`üîÑ –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É ${retryCount}/${maxRetries} —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã...`);
                await new Promise(resolve => setTimeout(resolve, 3000));
                continue;
            } else {
                console.error(`üí• –ü—Ä–µ–≤—ã—à–µ–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${o}`);
                throw error;
            }
        }
    }
    return t
}

function procPart(e) {
    if (!e || !e.part_num) return console.warn("–ü—Ä–æ–ø—É—Å–∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ç–∞–ª–∏ –∏–∑ API:", e), null;
    

    
    const t = {
        id: e.part_num,
        name: e.name,
        rebrickable_img_url: e.part_img_url,
        categoryId: e.part_cat_id,
        num_sets: e.num_sets,
        part_num: e.part_num,
        part_cat_id: e.part_cat_id,
        part_img_url: e.part_img_url
    };
    PART_MAP[t.id] = { ...PART_MAP[t.id],
        ...t
    };
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–∏
        saveState();
    return t
}

function getGroupId(e) {
    if (!e || "string" != typeof e) return e || "unknown_group";
    const t = e.match(/^([0-9]+)/);
    return t ? t[1] : e.split("p")[0]
}

function groupParts(e) {
    const t = {};
    return (e || []).forEach(e => {
        if (!e || (!e.part_num && !e.id)) return void console.warn("–ü—Ä–æ–ø—É—Å–∫ –¥–µ—Ç–∞–ª–∏ –±–µ–∑ –Ω–æ–º–µ—Ä–∞:", e);
        const partNum = e.part_num || e.id;
        const o = getGroupId(partNum);
        t[o] || (t[o] = []), t[o].push(e)
    }), Object.keys(t).forEach(e => {
        t[e].sort(partCmp)
    }), t
}

// –í—ã–±–∏—Ä–∞–µ—Ç –ª—É—á—à—É—é –≤–∞—Ä–∏–∞—Ü–∏—é –¥–µ—Ç–∞–ª–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞:
// 1) —Å –≤–∞–ª–∏–¥–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º (part_img_url –∏–ª–∏ rebrickable_img_url)
// 2) –µ—Å–ª–∏ —É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äì –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
// 3) –∏–Ω–∞—á–µ ‚Äì –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≥—Ä—É–ø–ø—ã
function pickBestPartVariantForCard(variants) {
    try {
        if (!Array.isArray(variants) || variants.length === 0) return null;
        const hasImg = (v) => {
            const url = v?.part_img_url || v?.rebrickable_img_url;
            return typeof url === 'string' && url.startsWith('http');
        };
        const withImg = variants.find(hasImg);
        return withImg || variants[0];
    } catch {
        return Array.isArray(variants) && variants[0] ? variants[0] : null;
    }
}

function buildCategoryTree(e) {
    const t = {
            'Bricks': ["brick"],
            'Plates': ["plate"],
            'Technic': ["technic"],
            'Slopes & Wedges': ["slope", "wedge"],
            'Tiles': ["tile"],
            'Panels, Doors & Windows': ["panel", "door", "window"],
            'Wheels & Tyres': ["wheel", "tyre"],
            'Minifig': ["minifig", "minidoll", "headwear"],
            'Bars, Hinges & Connectors': ["bar", "hinge", "connector", "link", "axle", "pin"],
            'Arches & Curves': ["arch", "curved", "round", "cone", "cylinder"]
        },
        o = {},
        l = [];
    (e || []).forEach(e => {
        const a = e.name.toLowerCase();
        let i = !1;
        for (const n in t)
            if (t[n].some(e => a.includes(e))) {
                o[n] || (o[n] = {
                    name: n,
                    children: []
                }), o[n].children.push(e), i = !0;
                break
            }
        i || l.push(e)
    });
    const a = Object.values(o).sort((e, t) => e.name.localeCompare(t.name, 'en'));
    return l.length > 0 && a.push({
        name: "Other",
        children: l.sort((e, t) => e.name.localeCompare(t.name, 'en'))
    }), a
}
async function fetchCategories() {
    try {
        const e = await apiFetchPaginated("/part_categories/");
        flatCategories = e.sort((e, t) => e.name.localeCompare(t.name, 'en')), S.catTree = buildCategoryTree(flatCategories)
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        forceSaveState();
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:", e), S.err = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${e.message}`, S.catTree = []
    }
}
async function fetchThemes() {
    try {
        const e = await apiFetchPaginated("/themes/"),
            t = [],
            o = {};
        (e || []).forEach(e => {
            if (e && e.id) {
                o[e.id] = { ...e,
                    children: []
                };
                THEME_MAP[e.id] = o[e.id]
            }
        });
        (e || []).forEach(e => {
            if (e && e.id && o[e.id]) {
                if (e.parent_id && o[e.parent_id]) {
                    (Array.isArray(o[e.parent_id].children) || (o[e.parent_id].children = []));
                    o[e.parent_id].children.push(o[e.id]);
                } else {
                    t.push(o[e.id]);
                }
            }
        });
        const l = (e) => {
            if (Array.isArray(e.children) && e.children.length > 0) {
                e.children.sort((e, t) => e.name.localeCompare(t.name, 'en'));
                e.children.forEach(l);
            }
        };
        t.sort((e, t) => e.name.localeCompare(t.name, 'en')), t.forEach(l), S.themeTree = t
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–µ–º
        forceSaveState();
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º:", e), S.err = (S.err ? S.err + "\n" : "") + `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–º—ã: ${e.message}`, S.themeTree = []
    }
}
async function fetchAllColors() {
    try {
        const e = await apiFetchPaginated("/colors/");
        const colorsCount = (e || []).length;
        (e || []).forEach(e => {
            const t = String(e.id);
            COLOR_MAP[t] = {
                id: t,
                name: e.name,
                hex: `#${e.rgb}`,
                isTransparent: e.is_trans,
                rgb: e.rgb,
                is_trans: e.is_trans
            }
            // –£—á–∏—Ç—ã–≤–∞–µ–º —Ü–≤–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π id
            try { markApiStatOnce('colors', t); } catch {}
        })
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–≤–µ—Ç–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
        forceSaveState();
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–≤–µ—Ç–æ–≤:", e), S.err = (S.err ? S.err + "\n" : "") + "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞–ª–∏—Ç—Ä—É —Ü–≤–µ—Ç–æ–≤."
    }
}
async function loadPartsForCategory(e) {
    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    document.body.classList.add('category-navigation');
    document.body.classList.add('catalog-view');
    document.body.classList.add('catalog-parts-view');
    setTimeout(() => {
        document.body.classList.remove('category-navigation');
        document.body.classList.remove('catalog-view');
        document.body.classList.remove('catalog-parts-view');
    }, 800);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏...", 65, "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV");
    
    if (S.selCatId = e, S.selFigNum = null, S.showRelatedSets = false, S.loading = !0, S.err = null, S.searchGroups = null, S.q = '', S.catGroups = null, S.toDisplay = S.increment, S.gridStale = !0, updateUI(), S.filters.colorIds?.length > 1) return S.catGroups = {}, S.loading = !1, void updateUI();
    
    let o = []; // –û–±—ä—è–≤–ª—è–µ–º o –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    let l = []; // –û–±—ä—è–≤–ª—è–µ–º l –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∏–∑ –¥–∞–Ω–Ω—ã—Ö CSV –≤–º–µ—Å—Ç–æ API
        o = Object.values(PART_MAP).filter(part => part.categoryId === e);
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ü–≤–µ—Ç–∞, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
        if (S.filters.colorIds?.length === 1) {
            const colorSet = getPartsWithColorSet(S.filters.colorIds[0]);
            if (colorSet.size > 0) {
                o = o.filter(part => colorSet.has(String(part.id)));
            }
        }
        
        l = o;
        S.filters.inCollectionOnly && (l = o.filter(e => S.coll[e.id] && Object.keys(S.coll[e.id]).length > 0));
        S.catGroups = groupParts(l);
    } catch (t) {
        console.error("CSV parts fetch failed:", t), S.err = t.message
        S.catGroups = {}; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º catGroups –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    } finally {
        S.loading = !1;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        if (S.catGroups && Object.keys(S.catGroups).length !== undefined) {
            updateLoadingStatus("–î–µ—Ç–∞–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", 100, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(S.catGroups || {}).length} –≥—Ä—É–ø–ø –¥–µ—Ç–∞–ª–µ–π`);
            setTimeout(() => {
                hideLoadingIndicator();
            }, 1000);
        }
        
        updateUI();
    }
}
function getRelevanceScore(e, t) {
    const o = t.toLowerCase(),
        l = e.name ? e.name.toLowerCase() : '',
        a = e.part_num ? e.part_num.toLowerCase() : e.id ? e.id.toLowerCase() : '';
    return a === o ? 100 : l === o ? 90 : a.startsWith(o) ? 80 : l.startsWith(o) ? 70 : a.includes(o) ? 60 : l.includes(o) ? 50 : 0
}

function partCmp(e, t) {
    if (!t || (!t.part_num && !t.id) || !t.name) return -1;
    if (!e || (!e.part_num && !e.id) || !e.name) return 1;
    const o = e.name.toLowerCase().includes("print") || e.name.toLowerCase().includes("sticker") || e.name.toLowerCase().includes("pattern"),
        l = t.name.toLowerCase().includes("print") || t.name.toLowerCase().includes("sticker") || t.name.toLowerCase().includes("pattern");
    if (o && !l) return 1;
    if (!o && l) return -1;
    const a = (e.part_num || e.id).match(/[a-zA-Z]/),
        i = (t.part_num || t.id).match(/[a-zA-Z]/);
    if (a && !i) return 1;
    if (!a && i) return -1;
    const n = (t.num_sets || 0) - (e.num_sets || 0);
    if (0 !== n) return n;
    const r = e.name.length - t.name.length;
    return 0 !== r ? r : (e.part_num || e.id).localeCompare(t.part_num || t.id, 'en')
}
async function searchRebrickableParts(e) {
    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    document.body.classList.add('searching');
    document.body.classList.add('catalog-view');
    document.body.classList.add('catalog-parts-view');
    setTimeout(() => {
        document.body.classList.remove('searching');
        document.body.classList.remove('catalog-view');
        document.body.classList.remove('catalog-parts-view');
    }, 800);
    
    if (!e || e.trim().length === 0) return S.searchGroups = null, S.loading = !1, S.selCatId = null, S.selFigNum = null, S.showRelatedSets = false, S.gridStale = !0, void updateUI();
    if (S.loading = !0, S.err = null, S.selCatId = null, S.selFigNum = null, S.showRelatedSets = false, S.catGroups = null, S.toDisplay = S.increment, S.gridStale = !0, updateUI(), S.filters.colorIds?.length > 1) return S.searchGroups = {}, S.loading = !1, void updateUI();
    
    let o = []; // –û–±—ä—è–≤–ª—è–µ–º o –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    let l = {}; // –û–±—ä—è–≤–ª—è–µ–º l –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    let a = []; // –û–±—ä—è–≤–ª—è–µ–º a –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    let i = {}; // –û–±—ä—è–≤–ª—è–µ–º i –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    
    try {
        // –ò—â–µ–º –≤ –¥–∞–Ω–Ω—ã—Ö CSV –≤–º–µ—Å—Ç–æ API
        o = searchInCSVData(e, 'parts');
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä —Ü–≤–µ—Ç–∞, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ)
        if (S.filters.colorIds?.length === 1) {
            const colorSet = getPartsWithColorSet(S.filters.colorIds[0]);
            if (colorSet.size > 0) {
                o = o.filter(part => colorSet.has(String(part.id)));
            }
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
        S.filters.inCollectionOnly && (o = o.filter(e => S.coll[e.id] && Object.keys(S.coll[e.id]).length > 0));
        
        l = groupParts(o);
        console.log('Grouped parts:', Object.keys(l).length, 'groups');
        
        a = Object.entries(l).map(([t, o]) => ({
            groupId: t,
            partList: o,
            bestScore: Math.max(...o.map(t => getRelevanceScore(t, e)))
        }));
        a.sort((e, t) => {
            if (t.bestScore !== e.bestScore) return t.bestScore - e.bestScore;
            return partCmp(e.partList[0], t.partList[0])
        });
        i = {};
        a.forEach(e => {
            if (e.bestScore > 0) {
                // –î–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏-–∑–∞–º–µ—Å—Ç–∏—Ç–µ–ª—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª—É—á—à—É—é –≤–∞—Ä–∏–∞—Ü–∏—é —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
                const bestForCard = pickBestPartVariantForCard(e.partList);
                i[e.groupId] = bestForCard ? [bestForCard, ...e.partList] : e.partList;
            }
        }), S.searchGroups = i;
        
        console.log('Final search groups:', Object.keys(i).length, 'groups');

    } catch (t) {
        console.error("CSV search failed:", t), S.err = t.message, S.searchGroups = {}
    } finally {
        S.loading = !1;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–∏—Å–∫–∞
        if (S.q && S.q.trim().length > 0 && S.searchGroups && Object.keys(S.searchGroups).length !== undefined) {
            updateLoadingStatus("–ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω", 100, `–ù–∞–π–¥–µ–Ω–æ ${Object.keys(S.searchGroups || {}).length} –≥—Ä—É–ø–ø –¥–µ—Ç–∞–ª–µ–π`);
            setTimeout(() => {
                hideLoadingIndicator();
            }, 1000);
        }
        
        updateUI();
    }
}
async function fetchSets() {
    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞–±–æ—Ä–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    document.body.classList.add('catalog-view');
    document.body.classList.add('catalog-sets-view');
    setTimeout(() => {
        document.body.classList.remove('catalog-view');
        document.body.classList.remove('catalog-sets-view');
    }, 800);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–±–æ—Ä–æ–≤
    if (S.selThemeId) {
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–±–æ—Ä–æ–≤ —Ç–µ–º—ã...", 65, "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV");
    } else if (S.q) {
        updateLoadingStatus("–ü–æ–∏—Å–∫ –Ω–∞–±–æ—Ä–æ–≤...", 70, `–ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${S.q}"`);
    } else {
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –Ω–∞–±–æ—Ä–æ–≤...", 65, "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV");
    }
    
    let results = []; // –û–±—ä—è–≤–ª—è–µ–º results –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    S.loading = !0, S.err = null, S.setRes = null, S.searchSetRes = null, S.toDisplay = S.increment, S.gridStale = !0, updateUI();
    try {
        if (S.q) {
                    // –ò—â–µ–º –≤ –¥–∞–Ω–Ω—ã—Ö CSV
        results = searchInCSVData(S.q, 'sets');
        } else if (S.selThemeId) {
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–µ–º–µ –∏–∑ –¥–∞–Ω–Ω—ã—Ö CSV
            results = Object.values(SET_MAP).filter(set => 
                set.theme_id === S.selThemeId
            );
            
        } else {
                    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –Ω–∞–±–æ—Ä—ã –∏–∑ CSV
        results = Object.values(SET_MAP);
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
        if (S.setFilters.minYear && S.setFilters.minYear.trim() !== '') {
            const minYear = parseInt(S.setFilters.minYear);
            if (!isNaN(minYear)) {
                results = results.filter(set => set.year && set.year >= minYear);
            }
        }
        if (S.setFilters.maxYear && S.setFilters.maxYear.trim() !== '') {
            const maxYear = parseInt(S.setFilters.maxYear);
            if (!isNaN(maxYear)) {
                results = results.filter(set => set.year && set.year <= maxYear);
            }
        }
        if (S.setFilters.minParts && S.setFilters.minParts.trim() !== '') {
            const minParts = parseInt(S.setFilters.minParts);
            if (!isNaN(minParts)) {
                results = results.filter(set => set.num_parts && set.num_parts >= minParts);
            }
        }
        if (S.setFilters.maxParts && S.setFilters.maxParts.trim() !== '') {
            const maxParts = parseInt(S.setFilters.maxParts);
            if (!isNaN(maxParts)) {
                results = results.filter(set => set.num_parts && set.num_parts <= maxParts);
            }
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
        if (S.sortBy === "alpha_asc") {
            results.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'en'));
        } else if (S.sortBy === "alpha_desc") {
            results.sort((a, b) => (b.name || '').localeCompare(a.name || '', 'en'));
        } else if (S.sortBy === "year_asc") {
            results.sort((a, b) => (a.year || 0) - (b.year || 0));
        } else if (S.sortBy === "year_desc") {
            results.sort((a, b) => (b.year || 0) - (a.year || 0));
        } else if (S.sortBy === "parts_asc") {
            results.sort((a, b) => (a.num_parts || 0) - (b.num_parts || 0));
        } else if (S.sortBy === "parts_desc") {
            results.sort((a, b) => (b.num_parts || 0) - (a.num_parts || 0));
        }
        
        if (S.q) {
            S.searchSetRes = results;
        } else {
            S.setRes = results;
        }
        
        console.log('Sets loaded:', results.length, 'results');
        console.log('Applied filters:', S.setFilters);
        console.log('Sort by:', S.sortBy);

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–±–æ—Ä–æ–≤ –∏–∑ CSV:", e), S.err = e.message
        results = []; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º results –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    } finally {
        S.loading = !1;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–±–æ—Ä–æ–≤
        if (S.subView === 'sets' && results && results.length !== undefined) {
            updateLoadingStatus("–ù–∞–±–æ—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã", 100, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${results.length} –Ω–∞–±–æ—Ä–æ–≤`);
            setTimeout(() => {
                hideLoadingIndicator();
            }, 1000);
        }
        
        updateUI();
    }
}
async function fetchMinifigs() {
    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    document.body.classList.add('catalog-view');
    document.body.classList.add('catalog-minifigs-view');
    setTimeout(() => {
        document.body.classList.remove('catalog-view');
        document.body.classList.remove('catalog-minifigs-view');
    }, 800);
    
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        if (S.q) {
            updateLoadingStatus("–ü–æ–∏—Å–∫ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...", 70, `–ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${S.q}"`);
        } else {
            updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...", 65, "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV");
        }
    
    let results = []; // –û–±—ä—è–≤–ª—è–µ–º results –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    S.loading = !0, S.err = null, S.toDisplay = S.increment, S.gridStale = !0, updateUI();
    try {
        if (S.q) {
                    // –ò—â–µ–º –≤ –¥–∞–Ω–Ω—ã—Ö CSV
        results = searchInCSVData(S.q, 'minifigs');
            S.searchMinifigRes = results;
            S.minifigRes = null;
        } else {
                    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∏–∑ CSV
        results = Object.values(MINIFIG_MAP);
            S.minifigRes = results;
            S.searchMinifigRes = null;
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã
        if (S.sortBy === "name_asc") {
            results.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'en'));
        } else if (S.sortBy === "name_desc") {
            results.sort((a, b) => (b.name || '').localeCompare(a.name || '', 'en'));
        } else if (S.sortBy === "num_parts_desc") {
            results.sort((a, b) => (b.num_parts || 0) - (a.num_parts || 0));
        } else if (S.sortBy === "num_parts_asc") {
            results.sort((a, b) => (a.num_parts || 0) - (b.num_parts || 0));
        }
        
        console.log('Minifigs loaded:', results.length, 'results');
        console.log('Sort by:', S.sortBy);
        

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏–∑ CSV:", e), S.err = e.message
        results = []; // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º results –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    } finally {
        S.loading = !1;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        if (S.subView === 'minifigs' && results && results.length !== undefined) {
            updateLoadingStatus("–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", 100, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${results.length} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫`);
            setTimeout(() => {
                hideLoadingIndicator();
            }, 1000);
        }
        
        updateUI();
    }
}
async function fetchPartColors(e) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–≤–µ—Ç–æ–≤
    updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ —Ü–≤–µ—Ç–æ–≤ –¥–µ—Ç–∞–ª–∏...", 75, "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤");
    
    S.partModal.loadingColors = !0;
    updateModalPartially({
        colors: !0
    });
    
    let t = []; // –û–±—ä—è–≤–ª—è–µ–º t –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    try {
        t = (await apiFetchPaginated(`/parts/${e}/colors/`)).map(e => String(e.color_id));
        
        if (PART_MAP[e]) {
            PART_MAP[e].availableColorIds = t;
            
            if (t.length > 0 && (!S.partModal.selColorId || !t.includes(S.partModal.selColorId))) {
                S.partModal.selColorId = sortColorIds(t, e)[0];
            }
        }
    } catch (error) {
        console.error(`Failed to fetch colors for ${e}:`, error);
        if (!PART_MAP[e]) {
            PART_MAP[e] = {};
        }
        PART_MAP[e].availableColorIds = PART_MAP[e].availableColorIds || [];
    } finally {
        S.partModal.loadingColors = !1;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è —Ü–≤–µ—Ç–æ–≤
        if (PART_MAP[e] && PART_MAP[e].availableColorIds && PART_MAP[e].availableColorIds.length !== undefined) {
            updateLoadingStatus("–¶–≤–µ—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", 80, `–î–æ—Å—Ç—É–ø–Ω–æ ${PART_MAP[e].availableColorIds.length} ${getColorWord(PART_MAP[e].availableColorIds.length)}`);
        }
        
        updateModalPartially({
            colors: !0,
            controls: !0
        });
        
        if (S.partModal.selColorId) {
            fetchPartColorSpecifics(e, S.partModal.selColorId);
        }
    }
}
async function fetchPartColorSpecifics(e, t) {
    S.partModal.loadingImg = !0, updateModalPartially({
        image: !0
    });
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à
    const cacheKey = `${e}-${t}`;
    if (COLOR_IMAGE_CACHE.has(cacheKey)) {
        S.partModal.imgUrl = COLOR_IMAGE_CACHE.get(cacheKey);
        S.partModal.loadingImg = !1;
        updateModalPartially({ image: !0 });
        return;
    }
    
    let now, timeSinceLastRequest, o, l, a; // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    try {
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
        now = Date.now();
        timeSinceLastRequest = now - lastApiRequestTime;
        if (timeSinceLastRequest < API_REQUEST_DELAY) {
            await new Promise(resolve => setTimeout(resolve, API_REQUEST_DELAY - timeSinceLastRequest));
        }
        
        lastApiRequestTime = Date.now();
        o = `${REBRICKABLE_API_URL}/parts/${e}/colors/${t}/`;
        l = await fetchWithProxy(o, {
            headers: {
                Authorization: `key ${getApiKey()}`
            }
        });
            
        if (l.status === 429) {
            // –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ - –∂–¥–µ–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–ø–∞—Å–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            console.warn('Rate limited by API, using fallback image');
            S.partModal.imgUrl = PART_MAP[e]?.rebrickable_img_url || null;
            return;
        }
        
        if (!l.ok) throw new Error("Image not found for this color.");
        a = await l.json();
        
        if (a.part_img_url) {
            // –ö—ç—à–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            COLOR_IMAGE_CACHE.set(cacheKey, a.part_img_url);
            S.partModal.imgUrl = a.part_img_url;
        } else {
            S.partModal.imgUrl = PART_MAP[e]?.rebrickable_img_url || null;
        }
    } catch (error) {
        console.warn("Could not fetch color-specific image:", error);
        S.partModal.imgUrl = PART_MAP[e]?.rebrickable_img_url || null;
    } finally {
        S.partModal.loadingImg = !1;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        if (S.partModal.imgUrl !== undefined) {
            if (S.partModal.imgUrl) {
                updateLoadingStatus("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ", 85, "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ –≥–æ—Ç–æ–≤–æ");
            } else {
                updateLoadingStatus("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ", 85, "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ");
            }
        }
        
        updateModalPartially({
            image: !0
        });
    }
}
async function fetchColorDetailsForPart(e) {
    if (PART_MAP[e]?.colorImages) return;
    
    let now, timeSinceLastRequest, t, o, imageCount; // –û–±—ä—è–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
    
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
        now = Date.now();
        timeSinceLastRequest = now - lastApiRequestTime;
        if (timeSinceLastRequest < API_REQUEST_DELAY) {
            await new Promise(resolve => setTimeout(resolve, API_REQUEST_DELAY - timeSinceLastRequest));
        }
    
    try {
        lastApiRequestTime = Date.now();
        t = await apiFetchPaginated(`/parts/${e}/colors/`);
        if (!PART_MAP[e]) {
            PART_MAP[e] = {
                id: e
            };
        }
        o = {};
        if (Array.isArray(t)) {
            t.forEach(colorData => {
                if (colorData && colorData.part_img_url && colorData.color_id) {
                    o[String(colorData.color_id)] = colorData.part_img_url;
                    // –ö—ç—à–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ü–≤–µ—Ç–æ–≤
                    const cacheKey = `${e}-${colorData.color_id}`;
                    COLOR_IMAGE_CACHE.set(cacheKey, colorData.part_img_url);
                    // –°—á–µ—Ç—á–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ä—Ç–æ—á–µ–∫, –Ω–µ –≤ –º–æ–¥–∞–ª–∫–µ
                }
            });
        }
        PART_MAP[e].colorImages = o;
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Ü–≤–µ—Ç–∞ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ü–≤–µ—Ç–∞
        forceSaveState();
    } catch (error) {
        console.warn(`Could not fetch color details for part ${e}:`, error);
        // –û—Ç–º–µ—á–∞–µ–º —ç—Ç—É –¥–µ—Ç–∞–ª—å –∫–∞–∫ –Ω–µ—É–¥–∞—á–Ω—É—é, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
        if (!PART_MAP[e]) {
            PART_MAP[e] = { id: e };
        }
        PART_MAP[e].colorImages = {}; // –ü—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ—É–¥–∞—á–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        forceSaveState();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–µ—Ç–∞–ª–µ–π –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
async function ensureBasicPartImagesForCollection() {
    const partsNeedingImages = Object.keys(S.coll).filter(partId => {
        const part = PART_MAP[partId];
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –≤–æ–æ–±—â–µ –Ω–µ—Ç URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        // –≠—Ç–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—á–µ–Ω—å —Ä–µ–¥–∫–æ, –ø–æ—Å–∫–æ–ª—å–∫—É inventory_parts.csv –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        return part && !part.part_img_url;
    });
    
    if (partsNeedingImages.length === 0) {
        return;
    }
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –±–µ–∑ –≤—ã–∑–æ–≤–æ–≤ API
    partsNeedingImages.forEach(partId => {
        const part = PART_MAP[partId];
        if (part && !part.part_img_url) {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            part.part_img_url = `https://cdn.rebrickable.com/media/parts/${partId}.jpg`;
            part.rebrickable_img_url = part.part_img_url;

        }
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    saveState();
}

// –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
async function fetchColorDetailsForCollectionParts() {
    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä—É—é –∑–∞–≥—Ä—É–∑–∫—É –≤–º–µ—Å—Ç–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤
    if (localStorage.getItem('disableColorSpecificImages') === 'true') {
        return;
    }
    
    const partsNeedingColorImages = Object.keys(S.coll).filter(partId => {
        const part = PART_MAP[partId];
        return part && !part.colorImages && part.part_img_url && part.part_img_url.startsWith('http');
    });
    
    if (partsNeedingColorImages.length === 0) return;
    

    
    try {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –Ω–µ–±–æ–ª—å—à–∏–º–∏ –ø–∞—Ä—Ç–∏—è–º–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
        for (let i = 0; i < partsNeedingColorImages.length; i += 3) {
            const batch = partsNeedingColorImages.slice(i, i + 3);
            await Promise.all(batch.map(partId => fetchColorDetailsForPart(partId)));
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –º–µ–∂–¥—É –ø–∞—Ä—Ç–∏—è–º–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
            if (i + 3 < partsNeedingColorImages.length) {
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π —Ü–≤–µ—Ç–∞
        forceSaveState();
    } catch (error) {
        console.error('Error fetching color details for collection parts:', error);
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª—é–±—ã—Ö —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
        forceSaveState();
    }
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–µ—Ç–∞–ª–µ–π –≤ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
async function forceRefreshPartImages() {
    if (S.view !== 'collection' || S.subView !== 'parts') return;
    
    const refreshButton = document.getElementById('refresh-images-button');
    const refreshIcon = document.getElementById('refresh-images-icon');
    
    if (!refreshButton || !refreshIcon) return;
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
    refreshButton.disabled = true;
    refreshIcon.innerHTML = '<div class="loader !w-5 !h-5 !border-2"></div>';
    
    try {
        // –°–Ω–∞—á–∞–ª–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –Ω–∞–ª–∏—á–∏–µ –±–∞–∑–æ–≤—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π
        await ensureBasicPartImagesForCollection();
        
        // –ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –¥–ª—è –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π
        await fetchColorDetailsForCollectionParts();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI –æ–¥–∏–Ω —Ä–∞–∑ –≤ –∫–æ–Ω—Ü–µ
        S.gridStale = true;
        updateUI();
    } catch (error) {
        console.error('Error refreshing part images:', error);
        // –û–±–Ω–æ–≤–ª—è–µ–º UI –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –ª—é–±—ã–µ —É—Å–ø–µ—à–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        S.gridStale = true;
        updateUI();
    } finally {
        // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞—Ç–Ω–æ –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫—É
        refreshButton.disabled = false;
        refreshIcon.innerHTML = I_Refresh("w-5 h-5");
    }
}

async function fetchMissingCollectionPartDetails() {
    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–µ—Ç–∞–ª–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    document.body.classList.add('collection-view');
    document.body.classList.add('collection-parts-view');
    setTimeout(() => {
        document.body.classList.remove('collection-view');
        document.body.classList.remove('collection-parts-view');
    }, 800);
    
    const e = Object.keys(S.coll).filter(e => !PART_MAP[e] || !PART_MAP[e].name);
    if (e.length === 0) return;
    
    try {
        for (let t = 0; t < e.length; t += 100) {
            const o = e.slice(t, t + 100);
            try {
                const parts = await apiFetchPaginated(`/parts/?part_nums=${o.join(",")}`);
                
                if (parts && Array.isArray(parts)) {
                    const processedParts = parts.map(procPart).filter(Boolean);
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ API: –ø–æ –æ–¥–Ω–æ–º—É —Ä–∞–∑—É –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç
                    processedParts.forEach(p => { try { markApiStatOnce('parts', p.id || p.part_num); } catch {} });
                }
            } catch (l) {
                console.error(`Could not fetch details for batch starting with part ${o[0]}:`, l);
                S.err = (S.err ? S.err + "\n" : "") + "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–µ—Ç–∞–ª–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏.";
            }
        }
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π
        forceSaveState();
    } catch (error) {
        console.error('Error in fetchMissingCollectionPartDetails:', error);
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª—é–±—ã—Ö —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
        forceSaveState();
    }
}
async function fetchMissingCollectionSetDetails() {
    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞–±–æ—Ä–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    document.body.classList.add('collection-view');
    document.body.classList.add('collection-sets-view');
    setTimeout(() => {
        document.body.classList.remove('collection-view');
        document.body.classList.remove('collection-sets-view');
    }, 800);
    
    const e = Object.keys(S.setColl).filter(e => !SET_MAP[e] || !SET_MAP[e].name);
    if (e.length === 0) return;
    try {
        for (let t = 0; t < e.length; t += 50) {
            const o = e.slice(t, t + 50);
            try {
                const sets = await apiFetchPaginated(`/sets/?set_nums=${o.join(",")}`);
                if (sets && Array.isArray(sets)) {
                    const validSets = sets.filter(set => set && set.set_num);
                    validSets.forEach(set => {
                        if (set && set.set_num) {
                            SET_MAP[set.set_num] = { ...SET_MAP[set.set_num], ...set };
                        }
                    });
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ API: –ø–æ –æ–¥–Ω–æ–º—É —Ä–∞–∑—É –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç
                    validSets.forEach(set => { try { markApiStatOnce('sets', set.set_num); } catch {} });
                }
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫—ç—à –¥–µ—Ç–∞–ª–µ–π –Ω–∞–±–æ—Ä–æ–≤ –¥–ª—è –æ—Ñ–ª–∞–π–Ω —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
                saveState();
            } catch (l) {
                console.error(`Could not fetch details for batch of sets starting with ${o[0]}:`, l);
                S.err = (S.err ? S.err + "\n" : "") + "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.";
            }
        }
    } catch (error) {
        console.error('Error in fetchMissingCollectionSetDetails:', error);
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—à–∏–±–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª—é–±—ã—Ö —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫
        saveState();
    }
}
async function fetchMinifigDetails(e) {
    if (MINIFIG_MAP[e]?.name) return;
    try {
        console.log('üîç Fetching minifig details for:', e);
        const t = await fetchWithProxy(`${REBRICKABLE_API_URL}/minifigs/${e}/`, {
            headers: {
                Authorization: `key ${getApiKey()}`
            }
        });
        if (!t.ok) throw new Error(`Minifig ${e} not found.`);
        const o = await t.json();
        console.log('üîç Minifig details received:', e, {
            name: o.name,
            theme_id: o.theme_id,
            year: o.year,
            num_parts: o.num_parts
        });
        MINIFIG_MAP[e] = o
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ API: –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ –º–∏–Ω–∏—Ñ–∏–≥ —Å –¥–∞–Ω–Ω—ã–º id
        markApiStatOnce('minifigs', e);
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        saveState();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI, –µ—Å–ª–∏ —ç—Ç–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è
        if (S.gridStale) {
            updateUI();
        }
        
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º UI, –µ—Å–ª–∏ –º—ã –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ–º –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        if (S.subView === 'minifigs') {
            S.gridStale = true;
            updateUI();
        }
    } catch (t) {
        console.error(`Could not fetch details for minifig ${e}:`, t)
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è-–∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å #undefined
        if (!MINIFIG_MAP[e]) {
            MINIFIG_MAP[e] = { set_num: e, name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞' };
        }
    }
}

async function fetchSetInventory(e, t = 1) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–∞
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–∞...", 75, "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π");
    
    if (S.setModal.loading = !0, t === 1 && (S.setModal.inv = []), updateSetModalView(), !S.selSetNum) return;
    try {
        const o = `/sets/${e}/parts/?page=${t}&page_size=50&inc_spares=1`,
            l = await fetchWithProxy(`${REBRICKABLE_API_URL}${o}`, {
                headers: {
                    Authorization: `key ${getApiKey()}`
                }
            });
        if (!l.ok) throw new Error("Could not fetch set inventory");
        const a = await l.json();
        const i = (a.results || []).map((e) => {
                procPart(e.part);
                const t = String(e.color.id);
                COLOR_MAP[t] || (COLOR_MAP[t] = {
                    id: t,
                    name: e.color.name,
                    hex: `#${e.color.rgb}`,
                    isTransparent: e.color.is_trans,
                    rgb: e.color.rgb,
                    is_trans: e.color.is_trans
                });
                return {
                    part: e.part,
                    color: COLOR_MAP[t],
                    quantity: e.quantity,
                    is_spare: e.is_spare,
                    element_id: e.element_id
                }
            });
        S.setModal.inv = [...S.setModal.inv, ...i], S.setModal.invPage = t, S.setModal.hasNextInv = !!a.next
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–∞ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        forceSaveState();
    } catch (o) {
        console.error(`Failed to fetch inventory for ${e}:`, o)
    } finally {
        S.setModal.loading = !1;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–∞
        updateLoadingStatus("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–∞–±–æ—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω", 80, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${S.setModal.inv.length} –¥–µ—Ç–∞–ª–µ–π`);
        
        S.selSetNum && updateSetModalView();
    }
}
async function fetchAllSetInventory(e) {
    let t = [];
    let o = 1;
    for (;;) {
        const l = `/sets/${e}/parts/?page=${o}&page_size=500&inc_spares=1`,
            a = await fetchWithProxy(`${REBRICKABLE_API_URL}${l}`, {
                headers: {
                    Authorization: `key ${getApiKey()}`
                }
            });
        if (!a.ok) {
            const e = await a.json().catch(() => ({
                detail: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏."
            }));
            throw new Error(`–û—à–∏–±–∫–∞ API Rebrickable: ${a.status} - ${e.detail}`)
        }
        const i = await a.json();
        const n = (i.results || []).map((e) => {
                procPart(e.part);
                const t = String(e.color.id);
                return COLOR_MAP[t] || (COLOR_MAP[t] = {
                    id: t,
                    name: e.color.name,
                    hex: `#${e.color.rgb}`,
                    isTransparent: e.color.is_trans,
                    rgb: e.color.rgb,
                    is_trans: e.color.is_trans
                }), {
                    part: e.part,
                    color: COLOR_MAP[t],
                    quantity: e.quantity,
                    is_spare: e.is_spare,
                    element_id: e.element_id,
                }
            });
        if (n.length > 0) {
            t = t.concat(n);
        }
        if (!i.next) break;
        o++, await new Promise(e => setTimeout(e, 1e3))
    }
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–∞ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        forceSaveState();
    return t
}
async function loadAllSetInventoryIntoModal(e) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
    updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–∞...", 75, "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π");
    S.setModal.loading = !0;
    S.setModal.inv = [];
    S.setModal.invPage = 1;
    S.setModal.hasNextInv = !1;
    updateSetModalView();
    try {
        const allItems = await fetchAllSetInventory(e);
        S.setModal.inv = allItems || [];
        S.setModal.invPage = 1;
        S.setModal.hasNextInv = !1;
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        forceSaveState();
    } catch (error) {
        console.error(`Failed to fully load inventory for ${e}:`, error);
    } finally {
        S.setModal.loading = !1;
        updateLoadingStatus("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–∞–±–æ—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω", 80, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${S.setModal.inv.length} –¥–µ—Ç–∞–ª–µ–π`);
        S.selSetNum && updateSetModalView();
    }
}
async function fetchSetMinifigs(e) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –Ω–∞–±–æ—Ä–∞
    updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –Ω–∞–±–æ—Ä–∞...", 75, "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫");
    
    S.setModal.loadingMinifigs = !0, updateSetModalView();
    try {
        const t = await apiFetchPaginated(`/sets/${e}/minifigs/`);
        for (let e = 0; e < t.length; e += 5) {
            const o = t.slice(e, e + 5),
                l = o.map(e => fetchMinifigDetails(e.set_num));
            await Promise.all(l), e + 5 < t.length && await new Promise(e => setTimeout(e, 1e3))
        }
        S.setModal.minifigs = (t || []).map(e => ({ ...MINIFIG_MAP[e.set_num],
            quantity: e.quantity,
            isExpanded: !1,
            isLoadingParts: !1,
            parts: null,
            loadingError: !1
        }))
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –Ω–∞–±–æ—Ä–∞ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        forceSaveState();
    } catch (t) {
        console.error(`Failed to fetch minifigs for set ${e}:`, t), S.setModal.minifigs = []
    } finally {
        S.setModal.loadingMinifigs = !1, S.selSetNum && updateSetModalView()
    }
}
async function fetchMinifigParts(e) {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏...", 75, "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π");
    
    try {
        const t = await apiFetchPaginated(`/minifigs/${e}/parts/`);
        const result = (t || []).map(e => {
            procPart(e.part);
            const t = String(e.color.id);
            return COLOR_MAP[t] || (COLOR_MAP[t] = {
                id: t,
                name: e.color.name,
                hex: `#${e.color.rgb}`,
                isTransparent: e.color.is_trans,
                rgb: e.color.rgb,
                is_trans: e.color.is_trans
            }), { ...e,
                color: COLOR_MAP[t]
            }
        });
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π
        forceSaveState();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        await fetchMissingMinifigPartImages(result);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        updateLoadingStatus("–î–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", 80, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${result.length} –¥–µ—Ç–∞–ª–µ–π`);
        
        return result;
    } catch (t) {
        throw console.error(`Failed to fetch parts for minifig ${e}:`, t), t
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
async function fetchMissingMinifigPartImages(minifigParts) {
    const partsWithoutImages = minifigParts.filter(p => !p.part.part_img_url);
    
    if (partsWithoutImages.length === 0) {
        return;
    }
    

    
    for (const partInfo of partsWithoutImages.slice(0, 5)) { // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 5, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
        if (!partInfo || !partInfo.part || !partInfo.part.part_num) {
            console.warn('Invalid part info, skipping...');
            continue;
        }
        
        try {
            // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
            const now = Date.now();
            const timeSinceLastRequest = now - lastApiRequestTime;
            if (timeSinceLastRequest < API_REQUEST_DELAY) {
                await new Promise(resolve => setTimeout(resolve, API_REQUEST_DELAY - timeSinceLastRequest));
            }
            
            lastApiRequestTime = Date.now();
            
            const response = await fetchWithProxy(`${REBRICKABLE_API_URL}/parts/${partInfo.part.part_num}/?key=${getApiKey()}`);
            
            if (response.status === 429) {
                console.warn('–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ API, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–µ—Ç–∞–ª–µ–π');
                break;
            }
            
            if (response.ok) {
                const data = await response.json();
                if (data.results && data.results[0] && data.results[0].part_img_url) {
                    partInfo.part.part_img_url = data.results[0].part_img_url;
                    try {
                        markApiStatOnce('images', `part:${partInfo.part.part_num}`);
                        markApiStatOnce('parts', partInfo.part.part_num);
                    } catch {}

                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
            await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
            console.warn(`Failed to fetch image URL for part ${partInfo.part.part_num}:`, error);
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫–∏ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é
function handleLongPress(type) {
    console.log(`üé≤ Long press detected for: ${type}`);
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
    if (window.handleLongPressInProgress) {
        console.log('üö´ handleLongPress already in progress, skipping...');
        return;
    }
    window.handleLongPressInProgress = true;
    
    // –ù–ï–ú–ï–î–õ–ï–ù–ù–û –±–ª–æ–∫–∏—Ä—É–µ–º updateUI –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
    const originalUpdateUI = window.updateUI;
    const originalRenderMainContent = window.renderMainContent;
    
    // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    window.UI_BLOCKED = true;
    console.log('üö´ UI blocked globally during long press');
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ñ–ª–∞–≥–∞ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
        if (window.UI_BLOCKED) {
            console.log('‚ö†Ô∏è Force reset UI_BLOCKED flag after timeout');
            window.UI_BLOCKED = false;
        }
    }, 10000);
    
    window.updateUI = () => {
        console.log('üö´ updateUI blocked during long press (early)');
        return;
    };
    
    // –¢–∞–∫–∂–µ –±–ª–æ–∫–∏—Ä—É–µ–º renderMainContent
    if (typeof renderMainContent === 'function') {
        window.renderMainContent = () => {
            console.log('üö´ renderMainContent blocked during long press');
            return;
        };
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞–∂–∞—Ç–∏—è
    const button = document.querySelector(`[data-long-press="${type}"]`);
    if (button) {
        button.style.transform = 'scale(0.95)';
        button.style.transition = 'transform 0.1s ease';
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—ã—á–Ω–æ–≥–æ –∫–ª–∏–∫–∞
        button.setAttribute('data-long-press-triggered', 'true');
        
        // –¢–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥
        S.longPressTriggered = true;
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setTimeout(() => {
            button.style.transform = '';
            button.style.transition = '';
        }, 100);
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ UI
    console.log('üöÄ Calling showRandomElement...');
    showRandomElement(type, originalUpdateUI, originalRenderMainContent);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
    window.handleLongPressInProgress = false;
    console.log('üîÑ handleLongPress execution flag reset');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ UI
async function showRandomElement(type, originalUpdateUI, originalRenderMainContent) {
    console.log(`üé≤ showRandomElement called for type: ${type}`);
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞
    if (window.showRandomElementInProgress) {
        console.log('üö´ showRandomElement already in progress, skipping...');
        return;
    }
    window.showRandomElementInProgress = true;
    
    // updateUI –∏ renderMainContent —É–∂–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –≤ handleLongPress
    
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
    await new Promise(resolve => setTimeout(resolve, 300));
    
    try {
        if ("parts" === type) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –¥–µ—Ç–∞–ª—å
            const hasCats = Array.isArray(flatCategories) && flatCategories.length > 0;
            let pool = [];
            if (hasCats) {
                const tries = Math.min(10, flatCategories.length);
                for (let i = 0; i < tries && pool.length === 0; i++) {
                    const randomCat = flatCategories[Math.floor(Math.random() * flatCategories.length)];
                    pool = Object.values(PART_MAP).filter(p => p && p.categoryId === randomCat.id && p.name);
                }
            }
            if (pool.length === 0) {
                pool = Object.values(PART_MAP).filter(p => p && p.name);
            }
            if (pool.length === 0) throw new Error("–î–µ—Ç–∞–ª–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
            
            const randomPart = pool[Math.floor(Math.random() * pool.length)];
            const partId = randomPart.id || randomPart.part_num;
            if (!partId) throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏.");
            
            const groupId = getGroupId(partId);
            let variants = Object.values(PART_MAP).filter(v => 
                v && (v.id || v.part_num) && getGroupId(v.id || v.part_num) === groupId
            );
            if (typeof partCmp === 'function') variants = variants.sort(partCmp);
            
            openModalForPart(partId, groupId, variants.length ? variants : [randomPart]);
            
        } else if ("sets" === type) {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –Ω–∞–±–æ—Ä
            let setPool = Object.values(SET_MAP).filter(s => s && s.name);
            if (setPool.length === 0) throw new Error("–ù–∞–±–æ—Ä—ã –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
            
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –Ω–∞–±–æ—Ä—ã —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Ç–µ–º–æ–π –¥–ª—è —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–∏—è
            const themeIds = Object.keys(THEME_MAP || {});
            if (themeIds.length > 0) {
                const tries = Math.min(5, themeIds.length);
                for (let i = 0; i < tries; i++) {
                    const themeId = parseInt(themeIds[Math.floor(Math.random() * themeIds.length)], 10);
                    const themed = setPool.filter(s => s && s.theme_id === themeId);
                    if (themed.length > 0) { 
                        setPool = themed; 
                        break; 
                    }
                }
            }
            
            const randomSet = setPool[Math.floor(Math.random() * setPool.length)];
            if (!randomSet || !randomSet.set_num) throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä–∞.");
            
            SET_MAP[randomSet.set_num] = randomSet;
            
            openModalForSet(randomSet.set_num);
            
        } else if ("minifigs" === type) {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É
            let figs = Object.values(MINIFIG_MAP).filter(f => f && f.name);
            if (figs.length === 0) throw new Error("–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
            
            const randomFig = figs[Math.floor(Math.random() * figs.length)];
            MINIFIG_MAP[randomFig.set_num] = randomFig;
            
            openModalForMinifig(randomFig.set_num);
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
        S.longPressTriggered = false;
        console.log('üîÑ Long press flag reset');
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º updateUI –∏ renderMainContent
        if (originalUpdateUI) {
            window.updateUI = originalUpdateUI;
            console.log('üîÑ updateUI restored');
        }
        if (originalRenderMainContent) {
            window.renderMainContent = originalRenderMainContent;
            console.log('üîÑ renderMainContent restored');
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        window.UI_BLOCKED = false;
        console.log('üîÑ Global UI block removed');
        
    } catch (e) {
        console.error("showRandomElement failed:", e);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ UI
        const errorNotification = document.createElement('div');
        errorNotification.className = 'fixed top-20 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-4 py-2 rounded-[18px] shadow-lg z-50 text-sm font-medium';
        errorNotification.textContent = `‚ùå –û—à–∏–±–∫–∞: ${e.message}`;
        document.body.appendChild(errorNotification);
        
        setTimeout(() => {
            if (errorNotification.parentNode) {
                errorNotification.parentNode.removeChild(errorNotification);
            }
        }, 3000);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        S.longPressTriggered = false;
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º updateUI –∏ renderMainContent –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (originalUpdateUI) {
            window.updateUI = originalUpdateUI;
            console.log('üîÑ updateUI restored after error');
        }
        if (originalRenderMainContent) {
            window.renderMainContent = originalRenderMainContent;
            console.log('üîÑ renderMainContent restored after error');
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        window.UI_BLOCKED = false;
        console.log('üîÑ Global UI block removed after error');
    } finally {
        // –í—Å–µ–≥–¥–∞ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
        window.showRandomElementInProgress = false;
        console.log('üîÑ showRandomElement execution flag reset');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
function setupLongPressHandlers() {
    const longPressButtons = document.querySelectorAll('[data-long-press]');
    
    longPressButtons.forEach(button => {
        let pressTimer = null;
        const longPressDelay = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞
        let pressStartTime = 0;
        let longPressTriggered = false; // –§–ª–∞–≥ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±—ã—á–Ω–æ–≥–æ –∫–ª–∏–∫–∞
        
        const startPress = (e) => {
            pressStartTime = Date.now();
            longPressTriggered = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –Ω–∞–∂–∞—Ç–∏—è
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
            button.style.transition = 'all 0.3s ease';
            button.style.filter = 'brightness(1.1)';
            
            pressTimer = setTimeout(() => {
                const type = button.getAttribute('data-long-press');
                if (type) {
                    longPressTriggered = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
                    handleLongPress(type);
                }
            }, longPressDelay);
        };
        
        const endPress = () => {
            if (pressTimer) {
                clearTimeout(pressTimer);
                pressTimer = null;
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            button.style.filter = '';
            
            // –ï—Å–ª–∏ –Ω–∞–∂–∞—Ç–∏–µ –±—ã–ª–æ –∫–æ—Ä–æ—Ç–∫–∏–º, —É–±–∏—Ä–∞–µ–º –≤—Å–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            const pressDuration = Date.now() - pressStartTime;
            if (pressDuration < longPressDelay) {
                button.style.transition = '';
            }
        };
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–±—ã—á–Ω—ã–π –∫–ª–∏–∫ –ø–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
        const blockClick = (e) => {
            if (longPressTriggered) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                longPressTriggered = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
                return false;
            }
        };
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        button.addEventListener('touchstart', startPress, { passive: true });
        button.addEventListener('touchend', endPress, { passive: true });
        button.addEventListener('touchcancel', endPress, { passive: true });
        button.addEventListener('click', blockClick, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
        button.addEventListener('mousedown', startPress);
        button.addEventListener('mouseup', endPress);
        button.addEventListener('mouseleave', endPress);
        button.addEventListener('click', blockClick, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –¥–æ–ª–≥–æ–º –Ω–∞–∂–∞—Ç–∏–∏
        button.addEventListener('contextmenu', (e) => e.preventDefault());
    });
}





function getPartImageUrl(e) {
    const t = `data:image/svg+xml,${encodeURIComponent(I_Img("w-full h-full text-gray-500"))}`;
    
    if (!e || typeof e !== 'string' || e.trim() === '') {
        return `src="${t}" loading="lazy" decoding="async"`;
    }
    
    // –ü—Ä–∏–Ω–∏–º–∞–µ–º —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ç–∏–ø—ã URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    const trimmedUrl = e.trim();
    
    // –ü—Ä–∏–Ω–∏–º–∞–µ–º HTTP URL, data URL –∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –ø—É—Ç–∏
    if (trimmedUrl.startsWith('http') || trimmedUrl.startsWith('data:') || trimmedUrl.startsWith('./') || trimmedUrl.startsWith('/')) {
        // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏
        return `src="${trimmedUrl}" loading="lazy" decoding="async" onerror="this.onerror=null; this.src='${t}';"`
    }
    
    // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤ –ø—ã—Ç–∞–µ–º—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å URL –∫–∞–∫ –µ—Å—Ç—å, –Ω–æ –≤—ã–≤–æ–¥–∏–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
    console.warn('Potentially invalid image URL detected:', trimmedUrl);
    return `src="${trimmedUrl}" loading="lazy" decoding="async" onerror="this.onerror=null; this.src='${t}';"`
}

// –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –¥–µ—Ç–∞–ª–∏ —Å –ø—Ä–æ—Å—Ç–æ–π –∑–∞–≥–ª—É—à–∫–æ–π –ø—Ä–∏ –æ—à–∏–±–∫–µ
function getPartImageAttrs(partId, url) {
    const fallback = `data:image/svg+xml,${encodeURIComponent(I_Img("w-full h-full text-gray-500"))}`;
    const u = (url || '').trim();
    
    if (u && (u.startsWith('http') || u.startsWith('./') || u.startsWith('/'))) {
        // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–≥–ª—É—à–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ –∑–∞–≥—Ä—É–∑–∫–∏
        return `src="${u}" loading="lazy" decoding="async" onerror="this.onerror=null; this.src='${fallback}';"`;
    }
    return `src="${fallback}" loading="lazy" decoding="async"`;
}

// –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –Ω–∞–±–æ—Ä–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
function getSetImageAttrs(setNum, url) {
    const fallback = `data:image/svg+xml,${encodeURIComponent(I_Img("w-full h-full text-gray-500"))}`;
    const u = (url || '').trim();
    if (u && (u.startsWith('http') || u.startsWith('./') || u.startsWith('/'))) {
        return `src="${u}" loading="lazy" decoding="async" onerror="window.onSetImgError && window.onSetImgError('${setNum}', this)"`;
    }
    return `src="${fallback}" loading="lazy" decoding="async"`;
}
// –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–±–æ—Ä–∞
window.onSetImgError = async (setNum, imgEl) => {
    try {
        if (!setNum) return;
        // –ï—Å–ª–∏ —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–æ–º–Ω–∏–º imgEl –∫–∞–∫ –∂–¥—É—â–∏–π –∏ –≤—ã—Ö–æ–¥–∏–º
        if (SET_IMAGE_PENDING.has(setNum)) {
            if (imgEl) {
                const waiters = SET_IMAGE_WAITERS.get(setNum) || [];
                waiters.push(imgEl);
                SET_IMAGE_WAITERS.set(setNum, waiters);
            }
            return;
        }
        // –°–æ–∑–¥–∞—ë–º –µ–¥–∏–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∏ —Ä–∞—Å—à–∞—Ä–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –º–µ–∂–¥—É –≤—Å–µ–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
        const pending = (async () => {
            SET_IMAGE_FETCHING.add(setNum);
            try {
                
                const resp = await fetchWithProxy(`${REBRICKABLE_API_URL}/sets/${setNum}/`, {
                    headers: { Authorization: `key ${getApiKey()}` }
                });
                if (!resp.ok) return undefined;
                const data = await resp.json();
                return data?.set_img_url || undefined;
            } catch {
                return undefined;
            } finally {
                SET_IMAGE_FETCHING.delete(setNum);
            }
        })();
        SET_IMAGE_PENDING.set(setNum, pending);
        const url = await pending;
        SET_IMAGE_PENDING.delete(setNum);
        const allWaiters = [imgEl, ...(SET_IMAGE_WAITERS.get(setNum) || [])].filter(Boolean);
        SET_IMAGE_WAITERS.delete(setNum);
        if (!SET_MAP[setNum]) SET_MAP[setNum] = { set_num: setNum };
        if (!url) {
            // –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ API ‚Äì —Å—Ç–∞–≤–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –∑–∞–≥–ª—É—à–∫—É –∏ –∑–∞–ø–æ–º–∏–Ω–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ
            SET_MAP[setNum].set_img_url = '';
            saveState();
            const fallback = `data:image/svg+xml,${encodeURIComponent(I_Img("w-full h-full text-gray-500"))}`;
            allWaiters.forEach(el => {
                try {
                    el.onerror = null;
                    el.src = fallback;
                    const parent = el.closest('[data-action="view-image-fullscreen"]');
                    if (parent) parent.setAttribute('data-image-url', '');
                } catch {}
            });
            return;
        }
        // –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–∏–ª–∏ URL
        SET_MAP[setNum].set_img_url = url;
        markApiStatOnce('images', `set:${setNum}`);
        markApiStatOnce('sets', setNum);
        saveState();
        allWaiters.forEach(el => {
            try {
                el.onerror = null;
                el.src = url;
                const parent = el.closest('[data-action="view-image-fullscreen"]');
                if (parent) parent.setAttribute('data-image-url', url || '');
            } catch {}
        });
        // –ú—è–≥–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ –º–∏–≥–∞–Ω–∏—è
        if (S.view === 'catalog') {
            requestAnimationFrame(() => { S.gridStale = false; });
        } else {
            S.gridStale = true; updateUI();
        }
    } catch (err) {
        console.warn('onSetImgError: failed to recover image for set', setNum, err);
    } finally {
        // no-op, –æ—á–∏—â–∞–µ—Ç—Å—è –≤—ã—à–µ
    }
};

// –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞–±–æ—Ä–∞: –ø–∞—Ä—Å–∏–Ω–≥, –ø—Ä–µ–ª–æ–∞–¥ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
function parseNumericSetImage(url, setNum) {
    try {
        const u = String(url || '').trim();
        if (!u) return null;
        // –ò—â–µ–º —à–∞–±–ª–æ–Ω .../media/sets/{setNum}/{number}.jpg
        const escSet = String(setNum || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(`/media/sets/${escSet}/(\\d+)\\.jpg$`);
        const m = u.match(re);
        if (!m) return null;
        const num = parseInt(m[1], 10);
        const base = u.slice(0, u.lastIndexOf('/') + 1); // –¥–æ —á–∏—Å–ª–∞ –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ —Å–ª—ç—à
        if (!Number.isFinite(num)) return null;
        return { base, num };
    } catch (_) { return null; }
}

// –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏: –ø–∞—Ä—Å–∏–Ω–≥, –ø—Ä–µ–ª–æ–∞–¥ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
function parseNumericMinifigImage(url, figNum) {
    try {
        const u = String(url || '').trim();
        if (!u) return null;
        // –ò—â–µ–º —à–∞–±–ª–æ–Ω (—Å —É—á–µ—Ç–æ–º –≤–∞—Ä–∏–∞—Ü–∏–π, —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π –∏ query):
        // - /media/thumbs/sets/fig-XXXXX/123456.jpg
        // - /media/thumbs/minifigs/fig-XXXXX/123456.jpg
        // - /media/sets/fig-XXXXX/123456.jpg
        // - /media/minifigs/fig-XXXXX/123456.jpg
        // –∞ —Ç–∞–∫–∂–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (?..) –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏ (.webp/.png)
        const escFig = String(figNum || '').replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const re = new RegExp(`/media/(?:thumbs/(?:sets|minifigs)|sets|minifigs)/${escFig}/(\\d+)(?:\\.[a-zA-Z]+)?(?:\\?.*)?$`);
        const m = u.match(re);
        if (!m) return null;
        const num = parseInt(m[1], 10);
        const base = u.slice(0, u.lastIndexOf('/') + 1);
        if (!Number.isFinite(num)) return null;
        return { base, num };
    } catch (_) { return null; }
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–π –¥–µ—Ç–∞–ª–∏: UI –∏ –ª–æ–≥–∏–∫–∞, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –≥–∞–ª–µ—Ä–µ—è–º
function updatePartVariantButtonsState() {
    try {
        const variants = Array.isArray(S.partModal?.variants) ? S.partModal.variants : [];
        const total = variants.length;
        const prevBtn = document.querySelector('#modal-content [data-action="part-variant-prev"]');
        const nextBtn = document.querySelector('#modal-content [data-action="part-variant-next"]');
        const hasMany = total > 1;
        const dis = (btn, enabled) => {
            if (!btn) return;
            if (enabled) btn.classList.remove('opacity-50', 'pointer-events-none');
            else btn.classList.add('opacity-50', 'pointer-events-none');
        };
        if (prevBtn) {
            const isSmall = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
            if (hasMany) {
                if (prevBtn.style.display === 'none') {
                    if (!isSmall) prevBtn.style.display = '';
                    if (!prevBtn._shownOnce) {
                        prevBtn.style.opacity = '0';
                        prevBtn.style.transform = 'translateY(-50%) scale(0.98)';
                        requestAnimationFrame(() => {
                            prevBtn.style.transition = 'opacity 160ms ease';
                            prevBtn.style.opacity = '1';
                            prevBtn.style.transform = 'translateY(-50%)';
                        });
                        prevBtn._shownOnce = true;
                    }
                }
            } else {
                // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≤–∞—Ä–∏–∞—Ü–∏—è ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º
                prevBtn._shownOnce = false;
                prevBtn.style.display = 'none';
            }
        }
        if (nextBtn) {
            const isSmall = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
            if (hasMany) {
                if (nextBtn.style.display === 'none') {
                    if (!isSmall) nextBtn.style.display = '';
                    if (!nextBtn._shownOnce) {
                        nextBtn.style.opacity = '0';
                        nextBtn.style.transform = 'translateY(-50%) scale(0.98)';
                        requestAnimationFrame(() => {
                            nextBtn.style.transition = 'opacity 160ms ease';
                            nextBtn.style.opacity = '1';
                            nextBtn.style.transform = 'translateY(-50%)';
                        });
                        nextBtn._shownOnce = true;
                    }
                }
            } else {
                // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –≤–∞—Ä–∏–∞—Ü–∏—è ‚Äî —Å–∫—Ä—ã–≤–∞–µ–º
                nextBtn._shownOnce = false;
                nextBtn.style.display = 'none';
            }
        }
        // –ö–Ω–æ–ø–∫–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –Ω–∞ –ø–µ—Ä–≤–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏, –µ—Å–ª–∏ –≤–∞—Ä–∏–∞—Ü–∏–π > 1
        dis(prevBtn, hasMany);
        dis(nextBtn, hasMany);
    } catch (_) {}
}

function updatePartVariantDots() {
    try {
        const dotsWrap = document.getElementById('part-variant-dots');
        if (!dotsWrap) return;
        const variants = Array.isArray(S.partModal?.variants) ? S.partModal.variants : [];
        const total = Math.max(1, variants.length);
        const idx = Math.max(0, variants.findIndex(v => v?.id === S.selPartId));
        const hasMany = total > 1;
        const parentContainer = dotsWrap.parentElement;
        if (!hasMany || total > 48) { 
            dotsWrap.innerHTML = ''; 
            dotsWrap.style.opacity = '0'; 
            dotsWrap.style.height = '12px';
            if (parentContainer) {
                parentContainer.style.display = 'none';
            }
            return; 
        }
        if (parentContainer) {
            parentContainer.style.display = 'flex';
        }
        const perRow = 16;
        const rows = [];
        for (let i = 0; i < total; i += perRow) rows.push(i);
        const rowsHtml = rows.map(start => {
            const end = Math.min(total, start + perRow);
            const rowDots = [];
            for (let i = start; i < end; i++) {
                rowDots.push(`<span class="inline-block w-1.5 h-1.5 rounded-full ${i===idx?'bg-blue-500':'bg-gray-500'} transition-all duration-200" style="transform: ${i===idx?'scale(1.25)':'scale(1)'};"></span>`);
            }
            return `<div class="flex items-center justify-center gap-1.5">${rowDots.join('')}</div>`;
        }).join('');
        const rowsCount = Math.max(1, rows.length);
        const rowHeight = 16; // px, –∑–∞–ø–∞—Å –ø–æ –≤—ã—Å–æ—Ç–µ –¥–ª—è —Ç–æ—á–∫–∏ –∏ –º–µ–∂—Å—Ç—Ä–æ—á–Ω–æ–≥–æ –æ—Ç—Å—Ç—É–ø–∞
        dotsWrap.style.display = 'flex';
        dotsWrap.style.flexDirection = 'column';
        dotsWrap.style.alignItems = 'center';
        dotsWrap.style.justifyContent = 'center';
        dotsWrap.style.rowGap = '4px';
        dotsWrap.style.textAlign = 'center';
        dotsWrap.style.height = `${rowsCount * rowHeight}px`;
        // –¶–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–ª–æ–∫–∞ —Å —Ç–æ—á–∫–∞–º–∏
        try {
            const content = document.getElementById('modal-content');
            const container = content?.querySelector('#modal-image-container');
            const imgWrap = container?.closest('.lg\\:w-1\\/2.p-4.sm\\:p-6.bg-gray-900\\/30');
            if (imgWrap) {
                imgWrap.style.display = 'flex';
                imgWrap.style.flexDirection = 'column';
                imgWrap.style.alignItems = 'center';
                imgWrap.style.justifyContent = 'center';
                imgWrap.style.gap = '8px';
            }
        } catch(_) {}
        if (!dotsWrap._visibleOnce) {
            dotsWrap.style.transition = 'opacity 200ms ease, transform 200ms ease';
            dotsWrap.style.opacity = '1';
            dotsWrap.style.transform = 'translateY(0)';
            dotsWrap._visibleOnce = true;
        }
        dotsWrap.innerHTML = rowsHtml;
    } catch (_) {}
}

function applyPartVariantImageToDom() {
    try {
        const content = document.getElementById('modal-content');
        if (!content) return;
        const container = content.querySelector('#modal-image-container');
        const img = container?.querySelector('img');
        const curPart = PART_MAP[S.selPartId];
        const curUrl = (S.partModal?.imgUrl || curPart?.rebrickable_img_url || '').trim();
        if (img && curUrl) {
            const prev = img.getAttribute('data-current-src') || '';
            if (prev !== curUrl) {
                const pre = new Image();
                pre.onload = () => { try { img.src = curUrl; img.setAttribute('data-current-src', curUrl); } catch(_){} };
                pre.onerror = () => { try { img.src = curUrl; img.setAttribute('data-current-src', curUrl); } catch(_){} };
                pre.src = curUrl;
            }
        }
        if (container) container.setAttribute('data-image-url', curUrl || '');
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–æ–ª—è –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞
        try {
            const p = PART_MAP[S.selPartId];
            const nameEl = document.getElementById('part-name');
            const idEl = document.getElementById('part-id');
            const catBtn = document.getElementById('part-category-name');
            if (nameEl && p?.name) nameEl.textContent = p.name;
            if (idEl && p?.id) idEl.textContent = p.id;
            if (catBtn && p?.categoryId) {
                catBtn.dataset.categoryId = String(p.categoryId);
                const catName = flatCategories.find(c=>c.id===p.categoryId)?.name;
                if (catName) catBtn.textContent = catName;
            }
            const relWrap = document.getElementById('related-sets-for-part');
            if (relWrap) {
                let html = '';
                try {
                    const related = getRelatedSetsForPart(p.id);
                    if (related && related.length > 0) {
                        html = `<div class="mt-2">
                            <button data-action="show-related-sets-for-part" class="flex items-center gap-2 px-2 py-1 text-xs font-semibold rounded-[18px] bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-150 shadow-lg hover:shadow-blue-500/25">
                                ${I_Set("w-3 h-3")}
                                ${related.length === 1 ? '–°–≤—è–∑–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä: 1' : `–°–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤: ${related.length}`}
                            </button>
                        </div>`;
                    }
                } catch(_) {}
                relWrap.innerHTML = html;
            }
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫—É –≤—ã–±–æ—Ä–∞ –≤–∞—Ä–∏–∞—Ü–∏–∏
            const headerName = content.querySelector('#modal-content h2');
            if (headerName && p?.name) headerName.textContent = p.name;
            const varText = document.getElementById('variation-select-text');
            if (varText) {
                const currentVar = (S.partModal?.variants || []).find(v => v?.id === S.selPartId);
                if (currentVar?.name) varText.textContent = currentVar.name;
            }
        } catch(_) {}
        updatePartVariantButtonsState();
        updatePartVariantDots();
    } catch (_) {}
}

function tryAdvancePartVariantNext() {
    try {
        const variants = Array.isArray(S.partModal?.variants) ? S.partModal.variants : [];
        const total = variants.length;
        if (total <= 1) return;
        const idx = Math.max(0, variants.findIndex(v => v?.id === S.selPartId));
        const nextIdx = (idx + 1) % total;
        const nextVar = variants[nextIdx];
        if (nextVar && nextVar.id && nextVar.id !== S.selPartId) {
            S.selPartId = nextVar.id;
            const newPart = PART_MAP[S.selPartId];
            if (newPart) {
                S.partModal.imgUrl = newPart.rebrickable_img_url || null;
                S.partModal.selColorId = null;
                S.partModal.qty = 0;
                updateModalPartially({ image: true, controls: true });
                if (newPart.availableColorIds?.length) {
                    S.partModal.selColorId = sortColorIds(newPart.availableColorIds, newPart.id)[0];
                    S.partModal.qty = S.coll[newPart.id]?.[S.partModal.selColorId] || 0;
                    updateModalPartially({ colors: true, controls: true });
                    fetchPartColorSpecifics(newPart.id, S.partModal.selColorId);
                } else {
                    fetchPartColors(newPart.id);
                }
                // –ë–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞: –æ–±–Ω–æ–≤–ª—è–µ–º DOM –∏ —Ç–µ–∫—Å—Ç—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º–µ—Ä—Ü–∞–Ω–∏—è
                setTimeout(() => { applyPartVariantImageToDom(); }, 0);
            }
        }
    } catch (_) {}
}

function tryAdvancePartVariantPrev() {
    try {
        const variants = Array.isArray(S.partModal?.variants) ? S.partModal.variants : [];
        const total = variants.length;
        if (total <= 1) return;
        const idx = Math.max(0, variants.findIndex(v => v?.id === S.selPartId));
        const prevIdx = (idx - 1 + total) % total;
        const prevVar = variants[prevIdx];
        if (prevVar && prevVar.id && prevVar.id !== S.selPartId) {
            S.selPartId = prevVar.id;
            const newPart = PART_MAP[S.selPartId];
            if (newPart) {
                S.partModal.imgUrl = newPart.rebrickable_img_url || null;
                S.partModal.selColorId = null;
                S.partModal.qty = 0;
                updateModalPartially({ image: true, controls: true });
                if (newPart.availableColorIds?.length) {
                    S.partModal.selColorId = sortColorIds(newPart.availableColorIds, newPart.id)[0];
                    S.partModal.qty = S.coll[newPart.id]?.[S.partModal.selColorId] || 0;
                    updateModalPartially({ colors: true, controls: true });
                    fetchPartColorSpecifics(newPart.id, S.partModal.selColorId);
                } else {
                    fetchPartColors(newPart.id);
                }
                // –ë–µ–∑ –ø–æ–ª–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞: –æ–±–Ω–æ–≤–ª—è–µ–º DOM –∏ —Ç–µ–∫—Å—Ç—ã, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º–µ—Ä—Ü–∞–Ω–∏—è
                setTimeout(() => { applyPartVariantImageToDom(); }, 0);
            }
        }
    } catch (_) {}
}
async function scanMinifigImages(figNum) {
    if (!S.selFigNum || S.selFigNum !== figNum) return;
    const st = S.minifigModal || {};
    if (!st.galleryBase || !st.galleryCenter) {
        S.minifigModal && (S.minifigModal.galleryScanDone = true);
        return;
    }
    const base = st.galleryBase;
    const center = st.galleryCenter;
    const maxOffset = 20;
    const tasks = [];
    const numbers = [];
    const foundNumbers = [];
    for (let i = 1; i <= maxOffset; i++) {
        numbers.push(center + i);
        numbers.push(center - i);
    }
    const urls = numbers.map(n => `${base}${n}.jpg`);
    for (let i = 0; i < urls.length; i++) {
        const n = numbers[i];
        const u = urls[i];
        tasks.push(
            preloadImage(u).then(ok => {
                if (ok) {
                    foundNumbers.push(n);
                    foundNumbers.sort((a,b)=>a-b);
                    const newGallery = [ `${base}${center}.jpg`, ...foundNumbers.map(nn => `${base}${nn}.jpg`) ];
                    if (S.selFigNum === figNum && S.minifigModal) {
                        S.minifigModal.gallery = newGallery;
                        updateMinifigGalleryButtonsState();
                        updateMinifigGalleryDots();
                    }
                }
                return ok;
            })
        );
    }
    let results = [];
    try {
        const settled = await Promise.allSettled(tasks);
        for (let i = 0; i < settled.length; i++) {
            const ok = (settled[i].status === 'fulfilled') && settled[i].value === true;
            if (ok) results.push(numbers[i]);
        }
    } catch (_) { }
    try {
        const higher = Array.from(new Set([ ...foundNumbers, ...results.filter(n => n > center) ])).sort((a,b)=>a-b);
        const finalGallery = [ `${base}${center}.jpg`, ...higher.map(n => `${base}${n}.jpg`) ];
        st.gallery = finalGallery;
        st.galleryIndex = 0;
    } finally {
        st.galleryScanDone = true;
    }
}

function applyMinifigGalleryImageToDom() {
    try {
        if (!S.selFigNum || !S.minifigModal) return;
        const baseUrl = (MINIFIG_MAP[S.selFigNum]?.minifig_img_url || MINIFIG_MAP[S.selFigNum]?.set_img_url || '').trim();
        const useGallery = Array.isArray(S.minifigModal.gallery) && S.minifigModal.gallery.length > 0;
        const curUrl = useGallery ? S.minifigModal.gallery[Math.max(0, Math.min(S.minifigModal.galleryIndex || 0, S.minifigModal.gallery.length - 1))] : baseUrl;
        const content = document.getElementById('minifig-modal-content');
        if (!content) return;
        const container = content.querySelector('[data-action="view-image-fullscreen"]');
        const img = container?.querySelector('img');
        if (img && curUrl) {
            const prev = img.getAttribute('data-current-src') || '';
            if (prev !== curUrl) {
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                const pre = new Image();
                img.style.willChange = 'auto';
                img.style.transform = 'none';
                img.style.opacity = '1';
                pre.onload = () => { 
                    try { 
                        img.onerror = null; 
                        img.src = curUrl; 
                        img.setAttribute('data-current-src', curUrl);
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                        if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
                            setTimeout(() => {
                                if (img.src !== curUrl) {
                                    img.src = curUrl;
                                    img.setAttribute('data-current-src', curUrl);
                                }
                            }, 50);
                        }
                    } catch(_){} 
                };
                pre.onerror = () => { 
                    try { 
                        img.src = curUrl; 
                        img.setAttribute('data-current-src', curUrl);
                    } catch(_){} 
                };
                pre.src = curUrl;
            }
        }
        if (container) container.setAttribute('data-image-url', curUrl || '');
        updateMinifigGalleryButtonsState();
        updateMinifigGalleryDots();
    } catch (_) {}
}

async function tryAdvanceMinifigGalleryNext() {
    if (!S.minifigModal || !S.selFigNum) return;
    const st = S.minifigModal;
    const total = st.gallery?.length || 0;
    if (total <= 1) return;
    st.galleryIndex = ((st.galleryIndex || 0) + 1) % total;
    applyMinifigGalleryImageToDom();
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
        setTimeout(() => { applyMinifigGalleryImageToDom(); }, 100);
    }
}

function tryAdvanceMinifigGalleryPrev() {
    if (!S.minifigModal || !S.selFigNum) return;
    const st = S.minifigModal;
    const total = st.gallery?.length || 0;
    if (total <= 1) return;
    const idx = (st.galleryIndex || 0);
    st.galleryIndex = (idx - 1 + total) % total;
    applyMinifigGalleryImageToDom();
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
        setTimeout(() => { applyMinifigGalleryImageToDom(); }, 100);
    }
}

function updateMinifigGalleryButtonsState() {
    try {
        if (!S.minifigModal) return;
        const st = S.minifigModal;
        const prevBtn = document.querySelector('#minifig-modal-content [data-action="minifig-gallery-prev"]');
        const nextBtn = document.querySelector('#minifig-modal-content [data-action="minifig-gallery-next"]');
        const total = st.gallery?.length || 0;
        const hasExtras = total > 1;
        const dis = (btn, enabled) => {
            if (!btn) return;
            if (enabled) btn.classList.remove('opacity-50', 'pointer-events-none');
            else btn.classList.add('opacity-50', 'pointer-events-none');
        };
        if (prevBtn) {
            const isSmall = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
            if (hasExtras) {
                if (prevBtn.style.display === 'none') {
                    if (!isSmall) prevBtn.style.display = '';
                    if (!prevBtn._shownOnce) {
                        prevBtn.style.opacity = '0';
                        prevBtn.style.transform = 'translateY(-50%) scale(0.98)';
                        requestAnimationFrame(() => {
                            prevBtn.style.transition = 'opacity 160ms ease';
                            prevBtn.style.opacity = '1';
                            prevBtn.style.transform = 'translateY(-50%)';
                        });
                        prevBtn._shownOnce = true;
                    }
                }
            } else {
                prevBtn._shownOnce = false;
                prevBtn.style.display = 'none';
            }
        }
        if (nextBtn) {
            const isSmall = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
            if (hasExtras) {
                if (nextBtn.style.display === 'none') {
                    if (!isSmall) nextBtn.style.display = '';
                    if (!nextBtn._shownOnce) {
                        nextBtn.style.opacity = '0';
                        nextBtn.style.transform = 'translateY(-50%) scale(0.98)';
                        requestAnimationFrame(() => {
                            nextBtn.style.transition = 'opacity 160ms ease';
                            nextBtn.style.opacity = '1';
                            nextBtn.style.transform = 'translateY(-50%)';
                        });
                        nextBtn._shownOnce = true;
                    }
                }
            } else {
                nextBtn._shownOnce = false;
                nextBtn.style.display = 'none';
            }
        }
        dis(prevBtn, hasExtras);
        dis(nextBtn, hasExtras);
    } catch (_) {}
}

function updateMinifigGalleryDots() {
    try {
        if (!S.minifigModal) return;
        const dotsWrap = document.getElementById('minifig-gallery-dots');
        if (!dotsWrap) return;
        const total = Math.max(1, S.minifigModal.gallery?.length || 0);
        const idx = Math.max(0, Math.min(S.minifigModal.galleryIndex || 0, total - 1));
        const hasExtras = total > 1;
        if (!hasExtras) { dotsWrap.innerHTML = ''; dotsWrap.style.opacity = '0'; dotsWrap.style.height = '12px'; return; }
        const perRow = 16;
        const rows = [];
        for (let i = 0; i < total; i += perRow) rows.push(i);
        const rowsHtml = rows.map(start => {
            const end = Math.min(total, start + perRow);
            const rowDots = [];
            for (let i = start; i < end; i++) {
                rowDots.push(`<span class="inline-block w-1.5 h-1.5 rounded-full ${i===idx?'bg-blue-500':'bg-gray-500'} transition-all duration-200" style="transform: ${i===idx?'scale(1.25)':'scale(1)'};"></span>`);
            }
            return `<div class="flex items-center justify-center gap-1.5">${rowDots.join('')}</div>`;
        }).join('');
        const rowsCount = Math.max(1, rows.length);
        const rowHeight = 16;
        dotsWrap.style.display = 'flex';
        dotsWrap.style.flexDirection = 'column';
        dotsWrap.style.alignItems = 'center';
        dotsWrap.style.justifyContent = 'center';
        dotsWrap.style.rowGap = '4px';
        dotsWrap.style.textAlign = 'center';
        dotsWrap.style.height = `${rowsCount * rowHeight}px`;
        try {
            const content = document.getElementById('minifig-modal-content');
            const imgWrap = content?.querySelector('.lg\\:w-1\\/2.p-4.sm\\:p-6.bg-gray-900\\/30');
            if (imgWrap) {
                imgWrap.style.display = 'flex';
                imgWrap.style.flexDirection = 'column';
                imgWrap.style.alignItems = 'center';
                imgWrap.style.justifyContent = 'center';
                imgWrap.style.gap = '8px';
            }
        } catch(_) {}
        if (!dotsWrap._visibleOnce) {
            dotsWrap.style.transition = 'opacity 200ms ease, transform 200ms ease';
            dotsWrap.style.opacity = '1';
            dotsWrap.style.transform = 'translateY(0)';
            dotsWrap._visibleOnce = true;
        }
        dotsWrap.innerHTML = rowsHtml;
    } catch (_) {}
}

function initMinifigImageGallery(figNum) {
    try {
        if (!S.minifigModal) return;
        const mf = MINIFIG_MAP[figNum];
        const url = (mf?.minifig_img_url || mf?.set_img_url || '').trim();
        S.minifigModal.gallery = url ? [url] : [];
        S.minifigModal.galleryIndex = 0;
        // –í—Å–µ–≥–¥–∞ –ø–æ–ª—É—á–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ API –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –º–æ–¥–∞–ª–∫–µ –Ω–∞–±–æ—Ä–∞
        S.minifigModal.galleryScanDone = false;
        (async () => {
            try {
                const resp = await fetchWithProxy(`${REBRICKABLE_API_URL}/minifigs/${figNum}/`, { headers: { Authorization: `key ${getApiKey()}` }});
                if (!resp.ok) { S.minifigModal.galleryScanDone = true; return; }
                const data = await resp.json();
                // –°—Ç—Ä–æ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º set_img_url –∏–∑ API
                const apiUrl = (data?.set_img_url || '').trim();
                const p = parseNumericMinifigImage(apiUrl, figNum);
                if (p && S.selFigNum === figNum && S.minifigModal) {
                    S.minifigModal.galleryBase = p.base;
                    S.minifigModal.galleryCenter = p.num;
                    S.minifigModal.galleryScanDone = false;
                    S.minifigModal.galleryScanPromise = scanMinifigImages(figNum);
                } else {
                    S.minifigModal.galleryScanDone = true;
                }
            } catch (_) { S.minifigModal.galleryScanDone = true; }
        })();
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        setTimeout(applyMinifigGalleryImageToDom, 0);
        setTimeout(applyMinifigGalleryImageToDom, 100);
        setTimeout(applyMinifigGalleryImageToDom, 300);
    } catch (_) {}
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–¥–±–æ—Ä–∞ –±–∞–∑–æ–≤–æ–≥–æ —á–∏—Å–ª–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ —à–∞–±–ª–æ–Ω—É thumbs/sets/{fig}/NNNN.jpg
async function findMinifigNumericCenter(base) {
    try {
        const candidates = [
            300000, 275000, 250000, 225000, 200000, 190000, 180000, 175000, 170000,
            166000, 165000, 164000, 163000, 162000, 161000, 160800, 160700, 160600,
            160500, 160480, 160460, 160450, 160444, 160442
        ];
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ã—Å—Ç—Ä—ã–º–∏ –ø—Ä–æ–±–∞–º–∏ –≤ –ø–∞—Ä–∞–ª–ª–µ–ª–∏ –Ω–µ–±–æ–ª—å—à–∏–º–∏ –±–∞—Ç—á–∞–º–∏
        for (let i = 0; i < candidates.length; i += 6) {
            const batch = candidates.slice(i, i + 6);
            const tasks = batch.map(n => preloadImage(`${base}${n}.jpg`).then(ok => ok ? n : 0));
            const results = await Promise.allSettled(tasks);
            const success = results
                .map((r, idx) => (r.status === 'fulfilled' ? r.value : 0) ? batch[idx] : 0)
                .filter(Boolean)
                .sort((a,b)=>a-b);
            if (success.length) {
                const num = success[0];
                return { base, num };
            }
        }
        // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –∫–∞–Ω–¥–∏–¥–∞—Ç –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª ‚Äî –ø—Ä–æ–±—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –≤–Ω–∏–∑ –æ—Ç 160500 –¥–æ 159500 —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º
        let start = 160500;
        const limit = 1000;
        for (let off = 0; off < limit; off++) {
            const n = start - off;
            const ok = await preloadImage(`${base}${n}.jpg`);
            if (ok) return { base, num: n };
        }
        return null;
    } catch (_) {
        return null;
    }
}
function preloadImage(url, timeoutMs = 8000) {
    return new Promise(resolve => {
        try {
            const img = new Image();
            let done = false;
            const finish = (ok) => { if (!done) { done = true; resolve(ok); } };
            const t = setTimeout(() => finish(false), timeoutMs);
            img.onload = () => { clearTimeout(t); finish(true); };
            img.onerror = () => { clearTimeout(t); finish(false); };
            img.src = url;
        } catch (_) { resolve(false); }
    });
}

async function scanSetImages(setNum) {
    // –°–∫–∞–Ω–∏—Ä—É–µ–º –¥–æ 10 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –æ–±–µ —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ –Ω–æ–º–µ—Ä–∞, –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ, –±–µ–∑ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
    if (!S.selSetNum || S.selSetNum !== setNum) return;
    const st = S.setModal || {};
    if (!st.galleryBase || !st.galleryCenter) {
        S.setModal && (S.setModal.galleryScanDone = true);
        return;
    }
    const base = st.galleryBase;
    const center = st.galleryCenter;
    const maxOffset = 20;
    const tasks = [];
    const numbers = [];
    const foundNumbers = [];
    for (let i = 1; i <= maxOffset; i++) {
        numbers.push(center + i);
        numbers.push(center - i);
    }
    const urls = numbers.map(n => `${base}${n}.jpg`);
    for (let i = 0; i < urls.length; i++) {
        const n = numbers[i];
        const u = urls[i];
        tasks.push(
            preloadImage(u).then(ok => {
                if (ok) {
                    // –î–æ–±–∞–≤–ª—è–µ–º —á–∏—Å–ª–æ –∏ –ø–µ—Ä–µ—Å–æ—Ä—Ç–∏—Ä–æ–≤—ã–≤–∞–µ–º –≥–∞–ª–µ—Ä–µ—é —Å–ø—Ä–∞–≤–∞
                    foundNumbers.push(n);
                    foundNumbers.sort((a,b)=>a-b);
                    const newGallery = [ `${base}${center}.jpg`, ...foundNumbers.map(nn => `${base}${nn}.jpg`) ];
                    // –ó–∞—â–∏—Ç–∞ –æ—Ç –≥–æ–Ω–æ–∫: —É–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –≤—Å—ë –µ—â—ë —Å–º–æ—Ç—Ä–∏–º —ç—Ç–æ—Ç –∂–µ –Ω–∞–±–æ—Ä
                    if (S.selSetNum === setNum && S.setModal) {
                        S.setModal.gallery = newGallery;
                        // –ü–æ–∫–∞–∑–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–µ–ª–∫–∏ –∏ —Ç–æ—á–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–∞–π–¥–µ–Ω–Ω–æ–º –∫–∞–¥—Ä–µ (–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏)
                        updateSetGalleryButtonsState();
                        updateSetGalleryDots();
                    }
                }
                return ok;
            })
        );
    }
    let results = [];
    try {
        const settled = await Promise.allSettled(tasks);
        for (let i = 0; i < settled.length; i++) {
            const ok = (settled[i].status === 'fulfilled') && settled[i].value === true;
            if (ok) results.push(numbers[i]);
        }
    } catch (_) {
        // no-op
    }
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Ç–æ–≥–æ–≤—É—é –≥–∞–ª–µ—Ä–µ—é: —Ü–µ–Ω—Ç—Ä, –∑–∞—Ç–µ–º —Å–ø—Ä–∞–≤–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
    try {
        const higher = Array.from(new Set([ ...foundNumbers, ...results.filter(n => n > center) ])).sort((a,b)=>a-b);
        const finalGallery = [ `${base}${center}.jpg`, ...higher.map(n => `${base}${n}.jpg`) ];
        st.gallery = finalGallery;
        st.galleryIndex = 0; // –≤—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å –±–∞–∑–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    } finally {
        st.galleryScanDone = true;
        // –ù–∏–∫–∞–∫–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π DOM –∑–¥–µ—Å—å
    }
}

function applySetGalleryImageToDom() {
    try {
        if (!S.selSetNum || !S.setModal) return;
        // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–∫—Ä—ã–≤–∞–µ–º –±–∞–∑–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –±—É—Ñ–µ—Ä–∞
        const baseUrl = (SET_MAP[S.selSetNum]?.set_img_url || '').trim();
        const useGallery = Array.isArray(S.setModal.gallery) && S.setModal.gallery.length > 0;
        const curUrl = useGallery ? S.setModal.gallery[Math.max(0, Math.min(S.setModal.galleryIndex || 0, S.setModal.gallery.length - 1))] : baseUrl;
        const content = document.getElementById('set-modal-content');
        if (!content) return;
        const container = content.querySelector('[data-action="view-image-fullscreen"]');
        const img = container?.querySelector('img');
        if (img && curUrl) {
            // –ò–∑–±–µ–≥–∞–µ–º –º–µ—Ä—Ü–∞–Ω–∏—è: –Ω–µ –º–µ–Ω—è–µ–º src, –µ—Å–ª–∏ –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è URL
            const prev = img.getAttribute('data-current-src') || '';
            if (prev === curUrl) {
                // –¢–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏/—Ç–æ—á–∫–∏
            } else {
                // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∑–∞—Ç–µ–º –º–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø–æ–¥–º–µ–Ω–∞ –±–µ–∑ fade-out
                const pre = new Image();
                // –§–∏–∫—Å –ø–æ–¥–µ—Ä–≥–∏–≤–∞–Ω–∏—è: –∂–µ—Å—Ç–∫–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ, –æ—Ç–∫–ª—é—á–∞–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
                img.style.willChange = 'auto';
                img.style.transform = 'none';
                img.style.opacity = '1';
                pre.onload = () => {
                    try {
                        img.onerror = null;
                        img.src = curUrl;
                        img.setAttribute('data-current-src', curUrl);
                    } catch (_) {}
                };
                pre.onerror = () => {
                    try { img.src = curUrl; img.setAttribute('data-current-src', curUrl); } catch(_){}
                };
                pre.src = curUrl;
            }
        }
        if (container) container.setAttribute('data-image-url', curUrl || '');
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ (DOM –º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
        updateSetGalleryButtonsState();
        updateSetGalleryDots();
    } catch (_) { /* no-op */ }
}

async function tryAdvanceSetGalleryNext() {
    if (!S.setModal || !S.selSetNum) return;
    const st = S.setModal;
    const total = st.gallery?.length || 0;
    if (total <= 1) return;
    st.galleryIndex = ((st.galleryIndex || 0) + 1) % total;
    applySetGalleryImageToDom();
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
        setTimeout(() => { applySetGalleryImageToDom(); }, 100);
    }
}

function tryAdvanceSetGalleryPrev() {
    if (!S.setModal || !S.selSetNum) return;
    const st = S.setModal;
    const total = st.gallery?.length || 0;
    if (total <= 1) return;
    const idx = (st.galleryIndex || 0);
    st.galleryIndex = (idx - 1 + total) % total;
    applySetGalleryImageToDom();
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
        setTimeout(() => { applySetGalleryImageToDom(); }, 100);
    }
}

function updateSetGalleryButtonsState() {
    try {
        if (!S.setModal) return;
        const st = S.setModal;
        const prevBtn = document.querySelector('#set-modal-content [data-action="set-gallery-prev"]');
        const nextBtn = document.querySelector('#set-modal-content [data-action="set-gallery-next"]');
        const total = st.gallery?.length || 0;
        const hasExtras = total > 1; // wrap: –æ–±–µ –∫–Ω–æ–ø–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã, –µ—Å–ª–∏ –±–æ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞
        const canPrev = hasExtras;
        const canNext = hasExtras;
        const dis = (btn, enabled) => {
            if (!btn) return;
            if (enabled) {
                btn.classList.remove('opacity-50', 'pointer-events-none');
            } else {
                btn.classList.add('opacity-50', 'pointer-events-none');
            }
        };
        // –°–∫—Ä—ã—Ç–∏–µ –∫–Ω–æ–ø–æ–∫, –µ—Å–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ—Ç –≤–æ–æ–±—â–µ
        if (prevBtn) {
            // –ù–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö —Å—Ç—Ä–µ–ª–∫–∏ —Å–∫—Ä—ã—Ç—ã –º–µ–¥–∏–∞-–ø—Ä–∞–≤–∏–ª–æ–º; –Ω–µ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º –∏—Ö
            const isSmall = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
            if (hasExtras) {
                if (prevBtn.style.display === 'none') {
                    if (!isSmall) prevBtn.style.display = '';
                    if (!prevBtn._shownOnce) {
                        prevBtn.style.opacity = '0';
                        prevBtn.style.transform = 'translateY(-50%) scale(0.98)';
                        requestAnimationFrame(() => {
                            prevBtn.style.transition = 'opacity 160ms ease';
                            prevBtn.style.opacity = '1';
                            prevBtn.style.transform = 'translateY(-50%)';
                        });
                        prevBtn._shownOnce = true;
                    }
                } else {
                    // –ù–µ –º–µ–Ω—è–µ–º display/transition, —Ç–æ–ª—å–∫–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                }
            } else {
                prevBtn._shownOnce = false;
                prevBtn.style.display = 'none';
            }
        }
        if (nextBtn) {
            const isSmall = window.matchMedia && window.matchMedia('(max-width: 640px)').matches;
            if (hasExtras) {
                if (nextBtn.style.display === 'none') {
                    if (!isSmall) nextBtn.style.display = '';
                    if (!nextBtn._shownOnce) {
                        nextBtn.style.opacity = '0';
                        nextBtn.style.transform = 'translateY(-50%) scale(0.98)';
                        requestAnimationFrame(() => {
                            nextBtn.style.transition = 'opacity 160ms ease';
                            nextBtn.style.opacity = '1';
                            nextBtn.style.transform = 'translateY(-50%)';
                        });
                        nextBtn._shownOnce = true;
                    }
                } else {
                    // –ù–µ –¥—ë—Ä–≥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏ –±—É—Ñ–µ—Ä–∞
                }
            } else {
                nextBtn._shownOnce = false;
                nextBtn.style.display = 'none';
            }
        }
        dis(prevBtn, canPrev && hasExtras);
        dis(nextBtn, canNext && hasExtras);
    } catch (_) { /* no-op */ }
}

function updateSetGalleryDots() {
    try {
        if (!S.setModal) return;
        const dotsWrap = document.getElementById('set-gallery-dots');
        if (!dotsWrap) return;
        const total = Math.max(1, S.setModal.gallery?.length || 0);
        const idx = Math.max(0, Math.min(S.setModal.galleryIndex || 0, total - 1));
        const hasExtras = total > 1;
        if (!hasExtras) { dotsWrap.innerHTML = ''; dotsWrap.style.opacity = '0'; dotsWrap.style.height = '12px'; return; }
        const perRow = 16;
        const rows = [];
        for (let i = 0; i < total; i += perRow) rows.push(i);
        const rowsHtml = rows.map(start => {
            const end = Math.min(total, start + perRow);
            const rowDots = [];
            for (let i = start; i < end; i++) {
                rowDots.push(`<span class="inline-block w-1.5 h-1.5 rounded-full ${i===idx?'bg-blue-500':'bg-gray-500'} transition-all duration-200" style="transform: ${i===idx?'scale(1.25)':'scale(1)'};"></span>`);
            }
            return `<div class="flex items-center justify-center gap-1.5">${rowDots.join('')}</div>`;
        }).join('');
        const rowsCount = Math.max(1, rows.length);
        const rowHeight = 16;
        dotsWrap.style.display = 'flex';
        dotsWrap.style.flexDirection = 'column';
        dotsWrap.style.alignItems = 'center';
        dotsWrap.style.justifyContent = 'center';
        dotsWrap.style.rowGap = '4px';
        dotsWrap.style.textAlign = 'center';
        dotsWrap.style.height = `${rowsCount * rowHeight}px`;
        try {
            const content = document.getElementById('modal-content');
            const imgWrap = content?.querySelector('.lg\\:w-1\\/2.p-4.sm\\:p-6.bg-gray-900\\/30');
            if (imgWrap) {
                imgWrap.style.display = 'flex';
                imgWrap.style.flexDirection = 'column';
                imgWrap.style.alignItems = 'center';
                imgWrap.style.justifyContent = 'center';
                imgWrap.style.gap = '8px';
            }
        } catch(_) {}
        // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å —Ç–æ—á–∫–∞–º–∏
        if (!dotsWrap._visibleOnce) {
            dotsWrap.style.transition = 'opacity 200ms ease, transform 200ms ease';
            dotsWrap.style.opacity = '1';
            dotsWrap.style.transform = 'translateY(0)';
            dotsWrap._visibleOnce = true;
        }
        dotsWrap.innerHTML = rowsHtml;
    } catch (_) { /* no-op */ }
}

function initSetImageGallery(setNum) {
    try {
        if (!S.setModal) return;
        const set = SET_MAP[setNum];
        const url = (set?.set_img_url || '').trim();
        S.setModal.gallery = url ? [url] : [];
        S.setModal.galleryIndex = 0;
        const parsed = parseNumericSetImage(url, setNum);
        if (parsed) {
            S.setModal.galleryBase = parsed.base;
            S.setModal.galleryCenter = parsed.num;
            S.setModal.galleryScanDone = false;
            // –°—Ç–∞—Ä—Ç—É–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ–æ–Ω–µ (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–∏—Å)
            S.setModal.galleryScanPromise = scanSetImages(setNum);
        } else {
            // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —á–∏—Å–ª–æ–≤–æ–π URL —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è base/center (–Ω–µ –º–µ–Ω—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É)
            S.setModal.galleryScanDone = false;
            (async () => {
                try {
                    const resp = await fetchWithProxy(`${REBRICKABLE_API_URL}/sets/${setNum}/`, { headers: { Authorization: `key ${getApiKey()}` }});
                    if (!resp.ok) { S.setModal.galleryScanDone = true; return; }
                    const data = await resp.json();
                    const apiUrl = (data?.set_img_url || '').trim();
                    const p = parseNumericSetImage(apiUrl, setNum);
                    if (p && S.selSetNum === setNum && S.setModal) {
                        S.setModal.galleryBase = p.base;
                        S.setModal.galleryCenter = p.num;
                        S.setModal.galleryScanDone = false;
                        S.setModal.galleryScanPromise = scanSetImages(setNum);
                    } else {
                        S.setModal.galleryScanDone = true;
                    }
                } catch (_) { S.setModal.galleryScanDone = true; }
            })();
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º DOM-–∫–∞—Ä—Ç–∏–Ω–∫—É –∏ –∫–Ω–æ–ø–∫–∏
        setTimeout(applySetGalleryImageToDom, 0);
    } catch (_) { /* no-op */ }
}


        

        


function sortColorIds(e, t) {
    const o = ["0", "15", "4", "1", "14", "2", "71", "72", "88", "19", "5", "34"],
        l = Object.keys(S.coll[t] || {});
    return [...e].sort((e, t) => {
        const a = o.includes(e),
            i = o.includes(t);
        if (a && !i) return -1;
        if (!a && i) return 1;
        const n = l.includes(e),
            r = l.includes(t);
        if (n && !r) return -1;
        if (!n && r) return 1;
        const s = COLOR_MAP[e],
            c = COLOR_MAP[t];
        return s && c ? s.name.localeCompare(c.name, 'en') : 0
    })
}

function getPluralizedColorString(e) {
    const t = Math.abs(e),
        o = t % 10,
        l = t % 100;
    return l >= 11 && l <= 19 ? "—Ü–≤–µ—Ç–æ–≤" : 1 === o ? "—Ü–≤–µ—Ç" : [2, 3, 4].includes(o) ? "—Ü–≤–µ—Ç–∞" : "—Ü–≤–µ—Ç–æ–≤"
}

function parseCsvLine(e) {
    const t = [];
    let o = "",
        l = !1;
    const a = '"';
    for (let i = 0; i < e.length; i++) {
        const n = e[i];
        n === a ? l && e[i + 1] === a ? (o += a, i++) : l = !l : "," === n && !l ? (t.push(o), o = "") : o += n
    }
    return t.push(o), t.map(e => e.trim())
}
const CATEGORY_ICONS = {
    'Bricks': I_Brick,
    'Plates': I_Plate,
    'Technic': I_Tech,
    'Slopes & Wedges': I_Slope,
    'Tiles': I_Tile,
    'Panels, Doors & Windows': I_Win,
    'Wheels & Tyres': I_Wheel,
    'Minifig': I_Minifig,
    'Bars, Hinges & Connectors': I_Bar,
    'Arches & Curves': I_Arch,
    'Other': I_Other
};

const CATEGORY_COLORS = {
    'Bricks': 'text-red-400',           // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∫–∏—Ä–ø–∏—á–µ–π
    'Plates': 'text-orange-400',        // –û—Ä–∞–Ω–∂–µ–≤—ã–π –¥–ª—è –ø–ª–∞—Å—Ç–∏–Ω
    'Technic': 'text-blue-400',         // –°–∏–Ω–∏–π –¥–ª—è —Ç–µ—Ö–Ω–∏–∫–∞
    'Slopes & Wedges': 'text-green-400', // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å–∫–ª–æ–Ω–æ–≤
    'Tiles': 'text-yellow-400',         // –ñ–µ–ª—Ç—ã–π –¥–ª—è –ø–ª–∏—Ç–æ–∫
    'Panels, Doors & Windows': 'text-purple-400', // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π –¥–ª—è –ø–∞–Ω–µ–ª–µ–π
    'Wheels & Tyres': 'text-gray-400',  // –°–µ—Ä—ã–π –¥–ª—è –∫–æ–ª–µ—Å
    'Minifig': 'text-pink-400',         // –†–æ–∑–æ–≤—ã–π –¥–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
    'Bars, Hinges & Connectors': 'text-cyan-400', // –ì–æ–ª—É–±–æ–π –¥–ª—è —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª–µ–π
    'Arches & Curves': 'text-indigo-400', // –ò–Ω–¥–∏–≥–æ –¥–ª—è –∞—Ä–æ–∫
    'Other': 'text-gray-500'            // –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π –¥–ª—è –ø—Ä–æ—á–µ–≥–æ
};

function filterThemeTreeForCollection(e, t) {
    return Array.isArray(e) ? e.map(e => {
        if (!e || !e.id) return null;
        const o = Array.isArray(e.children) && e.children.length > 0 ? filterThemeTreeForCollection(e.children, t) : [];
        return t.has(e.id) || o.length > 0 ? { ...e,
            children: o
        } : null
    }).filter(Boolean) : []
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–µ—Ç–∞–ª–µ–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
function getCategoryPartCount(categoryId) {
    if (!S.coll || !categoryId) return 0;
    let count = 0;
    Object.keys(S.coll).forEach(partId => {
        const part = PART_MAP[partId];
        if (part && part.categoryId === categoryId) {
            // –°—á–∏—Ç–∞–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
            Object.values(S.coll[partId]).forEach(colorQty => {
                count += colorQty;
            });
        }
    });
    return count;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–∞–±–æ—Ä–æ–≤ –≤ —Ç–µ–º–µ
function getThemeSetCount(themeId) {
    if (!S.setColl || !themeId) return 0;
    let count = 0;
    Object.keys(S.setColl).forEach(setId => {
        const set = SET_MAP[setId];
        if (set && set.theme_id === themeId) {
            count += S.setColl[setId].qty;
        }
    });
    return count;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
function getMinifigCount() {
    if (!S.minifigColl) return 0;
    let count = 0;
    Object.values(S.minifigColl).forEach(minifig => {
        count += minifig.qty;
    });
    return count;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    function getRandomMinifigImage() {
        // –ï—Å–ª–∏ —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–∂–µ –≤—ã–±—Ä–∞–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
        if (S.randomMinifigImage) {
            return S.randomMinifigImage;
        }
        
        const min = 1;
        let max = 30; // Fallback –∑–Ω–∞—á–µ–Ω–∏–µ
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ
        if (window.MINIFIG_COUNT && window.MINIFIG_COUNT > 0) {
            max = window.MINIFIG_COUNT;
        }
        
        let randomNum;
        // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ, –æ—Ç–ª–∏—á–Ω–æ–µ –æ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ
        do {
            randomNum = Math.floor(Math.random() * (max - min + 1)) + min;
        } while (randomNum === S.lastMinifigNumber && max > 1); // –ü–æ–≤—Ç–æ—Ä—è–µ–º, –µ—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ —Ç—É –∂–µ —Ñ–∏–≥—É—Ä–∫—É (–µ—Å–ª–∏ –µ—Å—Ç—å –±–æ–ª—å—à–µ 1 —Ñ–∏–≥—É—Ä–∫–∏)
        
        const imagePath = `./Minifig_png/fig-${randomNum}.png`;
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫—ç—à, –µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
        const img = new Image();
        img.src = imagePath;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
        S.randomMinifigImage = imagePath;
        S.lastMinifigNumber = randomNum;
        
        return imagePath;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    function resetRandomMinifigImage() {
        S.randomMinifigImage = null;
        S.lastMinifigNumber = null;
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
    function setupSidebarDuringLoading() {
        const e = window.innerWidth < 1024;
        // –ù–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å —Å–æ–≥–ª–∞—Å–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏—é S.sidebarOpen
        if (e) {
            if (S.sidebarOpen) {
                sidebarEl.classList.remove("-translate-x-full");
                backdropEl.classList.remove("hidden");
                document.body.style.overflow = "hidden";
            } else {
                sidebarEl.classList.add("-translate-x-full");
                backdropEl.classList.add("hidden");
                document.body.style.overflow = "";
            }
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é
    function setupSidebarManagement() {
        const e = window.innerWidth < 1024;
        // –ù–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö (>=1024px) –±–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–∞
        if (window.innerWidth >= 1024) {
            S.sidebarOpen = true;
            sidebarEl.classList.remove("-translate-x-full");
            backdropEl.classList.add("hidden");
            document.body.style.overflow = "";
            document.body.classList.add('sidebar-open-large');
        } else {
            // –ù–∞ –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö –ª–æ–≥–∏–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π
            e ? S.sidebarOpen ? (sidebarEl.classList.remove("-translate-x-full"), backdropEl.classList.remove("hidden"), document.body.style.overflow = "hidden", sidebarEl.setAttribute('role','dialog'), sidebarEl.setAttribute('aria-modal','true')) : (sidebarEl.classList.add("-translate-x-full"), backdropEl.classList.add("hidden"), document.body.style.overflow = "", sidebarEl.removeAttribute('role'), sidebarEl.removeAttribute('aria-modal')) : (sidebarEl.classList.remove("-translate-x-full"), backdropEl.classList.add("hidden"), document.body.style.overflow = "")
            
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å sidebar-open-large –¥–ª—è –º–∞–ª—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤
            document.body.classList.remove('sidebar-open-large');
        }
    }

function renderSidebar() {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–¥–ø—Ä—ã–≥–∏–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–µ
    const prevScrollTop = sidebarEl.querySelector('#sidebar-scroll-container')?.scrollTop || 0;
    const e = Object.values(S.coll).reduce((e, t) => e + Object.values(t).reduce((e, t) => e + t, 0), 0);
    const t = Object.keys(S.coll).reduce((e, t) => e + Object.keys(S.coll[t]).length, 0);
    const o = Object.values(S.setColl).reduce((e, t) => e + t.qty, 0);
    const l = Object.keys(S.setColl).length;
    const a = Object.values(S.minifigColl).reduce((e, t) => e + t.qty, 0);
    const i = Object.keys(S.minifigColl).length;
    const n = (e) => `flex items-center w-full p-3 text-base font-semibold rounded-[18px] transition-all duration-200 ease-in-out ${S.view===e?"bg-blue-600 text-white":"text-gray-400 hover:bg-gray-700 hover:text-white"}`;
    const r = (e) => `relative flex-1 py-2 px-1 ${S.sidebarCompact?'h-10':'h-16'} rounded-[18px] text-xs font-semibold transition-colors duration-200 flex flex-col items-center justify-center gap-1 ${S.subView===e?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700 hover:text-white"}`;
    const m = (e) => `relative flex-1 py-2 px-1 ${S.sidebarCompact?'h-10':'h-16'} rounded-[18px] text-xs font-semibold transition-colors duration-200 flex flex-col items-center justify-center gap-1 ${S.view===e?"bg-blue-600 text-white":"text-gray-300 hover:bg-gray-700 hover:text-white"}`;
    const s = (e, t, o) => {
        if (o === 0 || "collection" !== S.view) return "";
        const l = t;
        const i = l >= 1e3 ? "text-[10px] px-1" : "text-xs px-1.5";
        const a = `absolute top-1 right-1 ${i} py-0.5 rounded-full font-bold ${S.subView===e?"bg-blue-200 text-blue-800":"bg-gray-600 text-gray-200"}`;
        return `<span class="${a}">${String(l)}</span>`
    };
    let c = "",
        d = "",
        topBtnHtml = "";
    if ("sets" === S.subView) {
        d = "–¢–µ–º—ã";
        let e = S.themeTree;
        let t = "";
        if ("collection" === S.view || "catalog" === S.view) {
            if ("collection" === S.view) {
                const isActive = (S.selCollThemeId === null);
                const btnClass = isActive ? "bg-blue-600 text-white ring-1 ring-blue-400/30" : "text-gray-300 hover:bg-gray-700 hover:text-white";
                t = `
                  <li>
                    <button data-action="show-all-collection-items" class="w-full text-left flex items-center justify-between p-2 h-9 rounded-[18px] transition-colors duration-150 ${btnClass}">
                      <span class="break-words leading-tight flex-1 self-center">–í—Å–µ –Ω–∞–±–æ—Ä—ã</span>
                    </button>
                  </li>
                `;
            } else {
                // –ö–∞—Ç–∞–ª–æ–≥: –∫–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–∫—Ä—ã—Ç –∏ –∑–∞–≥—Ä—É–∂–µ–Ω –ø–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–∞–±–æ—Ä–æ–≤
                const isActive = (
                  S.view === "catalog" &&
                  S.subView === "sets" &&
                  S.selThemeId === null &&
                  (S.q ?? "") === "" &&
                  Array.isArray(S.setRes) && S.setRes.length > 0
                );
                const btnClass = isActive ? "bg-blue-600 text-white ring-1 ring-blue-400/30" : "text-gray-300 hover:bg-gray-700 hover:text-white";
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –Ω–∞–±–æ—Ä–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π —Ç–µ–º—ã
                const totalSetsInCatalog = S.totalSetsInCatalog || 0;
                const relatedBadge = (S.view === "catalog" && S.subView === "sets" && S.showRelatedSets && (S.selFigNum || S.selRelatedPartId)) ? `
                    <span class=\"absolute top-1 right-1 w-5 h-5 bg-blue-200 text-blue-800 rounded-full flex items-center justify-center text-xs font-bold\">${S.selFigNum ? I_Minifig('w-3 h-3') : I_Brick('w-3 h-3')}</span>
                ` : '';
                const countBadge = totalSetsInCatalog > 0 ? `
                    <span class=\"ml-2 bg-gray-600 text-white text-xs font-bold rounded-full px-2 py-1 min-w-[20px] text-center\">
                        ${totalSetsInCatalog}
                    </span>
                ` : '';
                t = `
                  <li>
                    <button data-action=\"show-all-items-sets\" class=\"relative w-full text-left flex items-center justify-between p-2 h-9 rounded-[18px] transition-colors duration-150 ${btnClass}\">
                      ${relatedBadge}
                      <span class=\"break-words leading-tight flex-1 self-center\">–í—Å–µ –Ω–∞–±–æ—Ä—ã</span>
                      <div class=\"flex-shrink-0 ml-2 self-center\">
                        ${countBadge}
                      </div>
                    </button>
                  </li>
                `;
            }
            if ("collection" === S.view) {
                const a = new Set();
                Object.keys(S.setColl).forEach(e => {
                    const t = SET_MAP[e];
                    if (t && t.theme_id) {
                        let e = t.theme_id;
                        for (; e;) {
                            a.add(e);
                            e = THEME_MAP[e]?.parent_id
                        }
                    }
                });
                e = filterThemeTreeForCollection(S.themeTree, a)
            }
        }
        const o = (e) => {
            if (!Array.isArray(e)) return [];
            e.forEach(node => {
                node && Array.isArray(node.children) && o(node.children)
            });
            // –ê–ª—Ñ–∞–≤–∏—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–µ–º (–±–µ–∑ –ø–æ–¥—ä—ë–º–∞ –∏–∑–±—Ä–∞–Ω–Ω—ã—Ö ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –±–ª–æ–∫ —Å–≤–µ—Ä—Ö—É)
            return e.sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || ''), 'en'))
        };
        o(e);
        const l = (e, t = 0) => {
            if (!Array.isArray(e)) return "";
            return e.map(e => {
                if (!e) return "";
                const o = S.expThemes.has(e.id),
                    a = ("catalog" === S.view && S.selThemeId === e.id || "collection" === S.view && S.selCollThemeId === e.id) ? "bg-blue-600/80 text-white" : "text-gray-400 hover:bg-gray-700/50 hover:text-gray-200",
                    i = Array.isArray(e.children) && e.children.length > 0 ? `<div class="sidebar-dropdown ${o?"":"hidden"}"><ul class="space-y-1">${l(e.children,t+1)}</ul></div>` : "",
                    n = S.favThemeIds.has(e.id),
                    r = n ? "text-red-400 opacity-100" : "text-gray-500 lg:opacity-0 lg:group-hover:opacity-100";
                const setCount = getThemeSetCount(e.id);
                const countBadge = ("collection" === S.view && setCount > 0) ? `
                    <span class="ml-2 bg-gray-600 text-white text-xs font-bold rounded-full px-2 py-1 min-w-[20px] text-center">
                        ${setCount}
                    </span>
                ` : '';
                return `
                    <li class="space-y-1">
                        <button data-theme-id="${e.id}" aria-expanded="${o?"true":"false"}" class="w-full text-left flex items-start justify-between p-2 rounded-[18px] transition-colors duration-150 ${a} group" style="padding-left: ${.5+1.5*t}rem;">
                            <div class="flex flex-1 min-w-0">
                                <span data-action="toggle-favorite-theme" data-theme-id="${e.id}" class="p-1 rounded-full hover:bg-gray-600 hover:text-red-400 transition-opacity z-0 mr-2 ${r} flex-shrink-0 self-center" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                    ${I_Heart("w-4 h-4",n)}
                                </span>
                                <span class="break-words leading-tight">${e.name}</span>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0 ml-2 self-center">
                                ${countBadge}
                                ${Array.isArray(e.children)&&e.children.length>0?I_Chev(`w-5 h-5 text-gray-400 transform transition-transform duration-200 flex-shrink-0 ${o?"rotate-180":""}`):""}
                            </div>
                        </button>
                        ${i}
                    </li>
                `
            }).join("")
        };
        topBtnHtml = t;
        if (S.sidebarLoading) {
            // –í–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–µ—Ä—Ö—É
            c = '<div class="flex items-center justify-center p-3 mb-3 bg-gray-700/50 rounded-[18px]"><div class="loader !w-5 !h-5 mr-2"></div><span class="text-sm text-gray-300">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span></div>' + l(e);
        } else {
            c = l(e);
        }
        } else if ("minifigs" === S.subView) {
                d = "–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏";
                let minifigContent = '';
                
                if ("collection" === S.view) {
                    const totalMinifigsInCollection = getMinifigCount();
                    const countBadge = totalMinifigsInCollection > 0 ? `
                        <span class="ml-2 bg-gray-600 text-white text-xs font-bold rounded-full px-2 py-1 min-w-[20px] text-center">
                            ${totalMinifigsInCollection}
                        </span>
                    ` : '';
                    
                    minifigContent = `
                        <li class="text-gray-400 text-sm p-2">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥</li>
                        <li class="flex justify-center p-2">
                            <div class="p-2 sm:p-3 md:p-4 lg:p-5">
                                <img src="${getRandomMinifigImage()}" alt="–°–ª—É—á–∞–π–Ω–∞—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞" class="w-56 h-56 sm:w-72 sm:h-72 md:w-80 md:h-80 lg:w-96 lg:h-96 object-contain" onerror="this.style.display='none'">
                            </div>
                        </li>
                    `;
                } else {
                    minifigContent = `
                        <li class="text-gray-400 text-sm p-2">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥</li>
                        <li class="flex justify-center p-2">
                            <div class="p-2 sm:p-3 md:p-4 lg:p-5">
                                <img src="${getRandomMinifigImage()}" alt="–°–ª—É—á–∞–π–Ω–∞—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞" class="w-56 h-56 sm:w-72 sm:h-72 md:w-80 md:h-80 lg:w-96 lg:h-96 object-contain" onerror="this.style.display='none'">
                            </div>
                        </li>
                    `;
                }
                
                c = minifigContent;
        } else if ("tools" === S.view) {
            d = "–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã";
            let toolsContent = '';
            
            console.log('üîß Rendering tools sidebar, toolSubView:', S.toolSubView, 'view:', S.view);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ toolSubView –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—É—Å—Ç–æ–π
            if (S.toolSubView && S.toolSubView !== '') {
                console.log('‚ö†Ô∏è WARNING: toolSubView is not empty in renderSidebar:', S.toolSubView);
            }
            
            // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            const toolsCategories = [
                {
                    id: 'analytics',
                    name: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                    icon: I_Analytics('w-5 h-5 text-purple-400'),
                    description: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∞–Ω–∞–ª–∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏'
                },
                {
                    id: 'wishlist',
                    name: '–°–ø–∏—Å–∫–∏ –∂–µ–ª–∞–Ω–∏–π',
                    icon: I_Star('w-5 h-5 text-yellow-400'),
                    description: '–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤ –∂–µ–ª–∞–Ω–∏–π',
                    hidden: true
                },
                {
                    id: 'scanner',
                    name: '–°–∫–∞–Ω–µ—Ä –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫',
                    icon: I_Scanner('w-5 h-5 text-green-400'),
                    description: '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ DataMatrix –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫'
                },
                {
                    id: 'photo-search',
                    name: '–ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ',
                    icon: I_Camera('w-5 h-5 text-blue-400'),
                    description: 'AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π, –∫–æ—Ä–æ–±–æ–∫ –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏'
                },
                {
                    id: 'cloud-backup',
                    name: '–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ',
                    icon: I_Cloud('w-5 h-5 text-cyan-400'),
                    description: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö —Å –æ–±–ª–∞—á–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º'
                }
            ];
            
            toolsContent = toolsCategories.map(tool => {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∫—Ä—ã—Ç—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
                if (tool.hidden) return '';
                
                const isActive = S.toolSubView === tool.id;
                const btnClass = isActive ? "bg-blue-600 text-white ring-1 ring-blue-400/30" : "text-gray-300 hover:bg-gray-700 hover:text-white";
                
                return `
                    <li>
                        <button data-tool-sub-view="${tool.id}" class="w-full text-left flex items-start justify-between p-2 rounded-[18px] transition-colors duration-150 ${btnClass}">
                            <div class="flex items-center">
                                <span class="mr-3 flex-shrink-0">${tool.icon}</span>
                                <div>
                                    <span class="break-words leading-tight font-medium">${tool.name}</span>
                                    <div class="text-xs text-gray-400 mt-1">${tool.description}</div>
                                </div>
                            </div>
                        </button>
                    </li>
                `;
            }).join('');
            
            console.log('üîß Tools content generated:', toolsContent.length, 'characters');
            console.log('üîß Tools content preview:', toolsContent.substring(0, 200) + '...');
            c = toolsContent;
    } else {
        d = "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏";
        let e = S.catTree;
        let t = "";
        if ("collection" === S.view || "catalog" === S.view) {
            if ("collection" === S.view) {
                const isActive = (S.selCollCatId === null);
                const btnClass = isActive ? "bg-blue-600 text-white" : "text-gray-300 hover:bg-gray-700 hover:text-white";
                t = `
                  <li>
                    <button data-action="show-all-collection-items" class="w-full text-left flex items-center justify-between p-2 h-9 rounded-[18px] transition-colors duration-150 ${btnClass}">
                      <span class="break-words leading-tight flex-1 self-center">–í—Å–µ –¥–µ—Ç–∞–ª–∏</span>
                    </button>
                  </li>
                `;
                    } else {
            // –ö–∞—Ç–∞–ª–æ–≥: –∫–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ –≤–æ –≤–∫–ª–∞–¥–∫—É –¥–µ—Ç–∞–ª–∏ –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            const isActive = (
              S.view === "catalog" &&
              S.subView === "parts" &&
              S.selCatId === null
            );
            const btnClass = isActive ? "bg-blue-600 text-white" : "text-gray-300 hover:bg-gray-700 hover:text-white";
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π –≤ –∫–∞—Ç–∞–ª–æ–≥–µ, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/—Ç–µ–º—ã
            const totalPartsInCatalog = S.totalPartsInCatalog || 0;
            const countBadge = totalPartsInCatalog > 0 ? `
                <span class="ml-2 bg-gray-600 text-white text-xs font-bold rounded-full px-2 py-1 min-w-[20px] text-center">${totalPartsInCatalog}</span>
            ` : '';
                t = `
                  <li>
                    <button data-action="show-all-items-parts" class="w-full text-left flex items-center justify-between p-2 h-9 rounded-[18px] transition-colors duration-150 ${btnClass}">
                      <span class="break-words leading-tight flex-1 self-center">–í—Å–µ –¥–µ—Ç–∞–ª–∏</span>
                      <div class="flex-shrink-0 ml-2 self-center">
                        ${countBadge}
                      </div>
                    </button>
                  </li>
                `;
            }
            if ("collection" === S.view) {
                const a = new Set(Object.keys(S.coll).map(e => PART_MAP[e]?.categoryId).filter(e => void 0 !== e && null !== e));
                e = JSON.parse(JSON.stringify(S.catTree));
                e = e.map(e => (Array.isArray(e.children) && (e.children = e.children.filter(e => a.has(e.id))), e)).filter(e => Array.isArray(e.children) && e.children.length > 0)
            }
        }
        if (S.sidebarLoading) {
            // –í–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–µ—Ä—Ö—É
            c = '<div class="flex items-center justify-center p-3 mb-3 bg-gray-700/50 rounded-[18px]"><div class="loader !w-5 !h-5 mr-2"></div><span class="text-sm text-gray-300">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span></div>';
            if ("collection" === S.view && Object.keys(S.coll).length > 0 && 0 === e.length) {
                c += '<li class="text-gray-400 text-sm p-2">–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö</li>';
            } else {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–Ω–µ –ø–æ–¥–Ω–∏–º–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ)
                topBtnHtml = t;
                c += e.map(e => {
                    const t = S.expCats.has(e.name),
                        o = e.children.map(e => {
                            const t = ("catalog" === S.view && S.selCatId === e.id || "collection" === S.view && S.selCollCatId === e.id) ? "bg-blue-600/80 text-white" : "text-gray-400 hover:bg-gray-700/50 hover:text-gray-200",
                                o = S.favCatIds.has(e.id),
                                l = o ? "text-red-400 opacity-100" : "text-gray-500 lg:opacity-0 lg:group-hover:opacity-100";
                            return `
                              <li>
                                  <button data-category-id="${e.id}" class="w-full text-left flex items-center p-2 pl-11 rounded-[18px] transition-colors duration-150 ${t} group">
                                    <span data-action="toggle-favorite-category" data-category-id="${e.id}" class="p-1 rounded-full hover:bg-gray-600 hover:text-red-400 transition-opacity z-0 mr-2 -ml-2 ${l}" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                        ${I_Heart("w-4 h-4",o)}
                                    </span>
                                    <span class="truncate flex-grow">${e.name}</span>
                                  </button>
                              </li>
                           `
                        }).join("");
                    // –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π
                    let categoryColor = CATEGORY_COLORS[e.name];
                    if (!categoryColor) {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ –Ω–∞–∑–≤–∞–Ω–∏–π
                        if (e.name.includes('Wheel') || e.name.includes('Tyre')) {
                            categoryColor = 'text-gray-400';
                        } else if (e.name.includes('Other') || e.name === 'Other') {
                            categoryColor = 'text-gray-500';
                        } else {
                            categoryColor = 'text-gray-500';
                        }
                    }
                    const l = (CATEGORY_ICONS[e.name] || I_Other)(`w-5 h-5 mr-3 ${categoryColor} flex-shrink-0`);
                    const totalPartsInCategory = e.children.reduce((total, child) => {
                        return total + getCategoryPartCount(child.id);
                    }, 0);
                    const countBadge = ("collection" === S.view && totalPartsInCategory > 0) ? `
                        <span class="ml-2 bg-gray-600 text-white text-xs font-bold rounded-full px-2 py-1 min-w-[20px] text-center">
                            ${totalPartsInCategory}
                        </span>
                    ` : '';
                    return `
                          <li class="space-y-1">
                              <button data-parent-category="${e.name}" aria-expanded="${t?"true":"false"}" class="w-full text-left flex items-center justify-between p-2 rounded-[18px] hover:bg-gray-700 transition-colors duration-150">
                                  <div class="flex items-center truncate flex-1">
                                    ${l}
                                    <span class="font-semibold text-gray-200 truncate">${e.name}</span>
                                  </div>
                                  <div class="flex items-center gap-2">
                                    ${countBadge}
                                    ${I_Chev(`w-5 h-5 text-gray-400 transform transition-transform duration-200 ${t?"rotate-180":""}`)}
                                  </div>
                              </button>
                              <div class="sidebar-dropdown ${t?"":"hidden"}">
                                  <ul class="space-y-1">
                                      ${o}
                                  </ul>
                              </div>
                          </li>
                      `
                }).join("")
            }
        } else {
            if ("collection" === S.view && Object.keys(S.coll).length > 0 && 0 === e.length) {
                c = '<li class="text-gray-400 text-sm p-2">–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö</li>';
            } else {
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–Ω–µ –ø–æ–¥–Ω–∏–º–∞–µ–º –∏–∑–±—Ä–∞–Ω–Ω—ã–µ)
        topBtnHtml = t, c = e.map(e => {
            const t = S.expCats.has(e.name),
                o = e.children.map(e => {
                    const t = ("catalog" === S.view && S.selCatId === e.id || "collection" === S.view && S.selCollCatId === e.id) ? "bg-blue-600/80 text-white" : "text-gray-400 hover:bg-gray-700/50 hover:text-gray-200",
                        o = S.favCatIds.has(e.id),
                        l = o ? "text-red-400 opacity-100" : "text-gray-500 lg:opacity-0 lg:group-hover:opacity-100";
                    const partCount = getCategoryPartCount(e.id);
                    const countBadge = ("collection" === S.view && partCount > 0) ? `
                        <span class="ml-2 bg-gray-600 text-white text-xs font-bold rounded-full px-2 py-1 min-w-[20px] text-center">
                            ${partCount}
                        </span>
                    ` : '';
                    return `
                      <li>
                          <button data-category-id="${e.id}" class="w-full text-left flex items-start justify-between p-2 pl-11 rounded-[18px] transition-colors duration-150 ${t} group">
                            <div class="flex flex-1 min-w-0">
                                <span data-action="toggle-favorite-category" data-category-id="${e.id}" class="p-1 rounded-full hover:bg-gray-600 hover:text-red-400 transition-opacity z-0 mr-2 -ml-2 ${l} flex-shrink-0 self-center" aria-label="–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ">
                                    ${I_Heart("w-4 h-4",o)}
                                </span>
                                <span class="break-words leading-tight">${e.name}</span>
                            </div>
                            <div class="flex-shrink-0 ml-2 self-center">
                                ${countBadge}
                            </div>
                          </button>
                      </li>
                   `
                }).join("");
            // –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–∞—Ç–µ–≥–æ—Ä–∏–π
            let categoryColor = CATEGORY_COLORS[e.name];
            if (!categoryColor) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–∞—Å—Ç–∏—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å –≤–æ–∑–º–æ–∂–Ω—ã–º–∏ –≤–∞—Ä–∏–∞—Ü–∏—è–º–∏ –Ω–∞–∑–≤–∞–Ω–∏–π
                if (e.name.includes('Wheel') || e.name.includes('Tyre')) {
                    categoryColor = 'text-gray-400';
                } else if (e.name.includes('Other') || e.name === 'Other') {
                    categoryColor = 'text-gray-500';
                } else {
                    categoryColor = 'text-gray-500';
                }
            }
            const l = (CATEGORY_ICONS[e.name] || I_Other)(`w-5 h-5 mr-3 ${categoryColor} flex-shrink-0`);
            return `
                  <li class="space-y-1">
                      <button data-parent-category="${e.name}" class="w-full text-left flex items-start justify-between p-2 rounded-[18px] hover:bg-gray-700 transition-colors duration-150">
                          <div class="flex flex-1 min-w-0">
                            ${l}
                            <span class="font-semibold text-gray-200 break-words leading-tight">${e.name}</span>
                          </div>
                          <div class="flex-shrink-0 ml-2 self-center">
                            ${I_Chev(`w-5 h-5 text-gray-400 transform transition-transform duration-200 ${t?"rotate-180":""}`)}
                          </div>
                      </button>
                      <div class="sidebar-dropdown ${t?"":"hidden"}">
                          <ul class="space-y-1">
                              ${o}
                          </ul>
                      </div>
                  </li>
              `
        }).join("")
            }
        }
    }
    const sidebarFilterTerm = (S.sidebarFilter || '').trim().toLowerCase();
    let filteredListHtml = c;
    if (sidebarFilterTerm) {
        try {
            const tmp = document.createElement('div');
            tmp.innerHTML = `<ul>${c}</ul>`;
            tmp.querySelectorAll('li').forEach(li => {
                const txt = (li.textContent || '').toLowerCase();
                if (!txt.includes(sidebarFilterTerm)) li.remove();
            });
            filteredListHtml = tmp.innerHTML;
        } catch {}
    }
    sidebarEl.innerHTML = `
        <div class="flex items-center justify-between mb-4 flex-shrink-0">
          <h1 class="text-xl font-bold text-white">–ú–µ–Ω—é</h1>
          <button id="sidebar-close" class="modal-close-btn lg:hidden" title="–ó–∞–∫—Ä—ã—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å">
                          ${I_X("w-4 h-4")}
          </button>
        </div>
        
        ${S.sidebarLoading ? `
        <div class="mb-4 p-3 bg-blue-900/30 border border-blue-700/50 rounded-[18px]">
          <div class="flex items-center gap-2 text-blue-300">
            <div class="loader !w-4 !h-4 !border-blue-400"></div>
            <span class="text-sm font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–∞...</span>
          </div>
        </div>
        ` : ''}

        <div class="mb-3 p-1 bg-gray-900/50 rounded-[18px] grid grid-cols-3 gap-1 ${S.sidebarCompact? 'text-[11px]' : 'text-[12px]'}">
            <button data-view="catalog" class="${m("catalog")}" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–µ—Ç–∞–ª–µ–π, –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫">
                ${I_Cat("w-5 h-5 text-blue-400")}
                <span class="mt-1 ${S.sidebarCompact? 'hidden' : ''}">–ö–∞—Ç–∞–ª–æ–≥</span>
            </button>
            <button data-view="collection" class="${m("collection")}" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä –≤–∞—à–µ–π –ª–∏—á–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏">
                ${I_Coll("w-5 h-5 text-teal-400")}
                <span class="mt-1 ${S.sidebarCompact? 'hidden' : ''}">–ö–æ–ª–ª–µ–∫—Ü–∏—è</span>
            </button>
            <button data-view="tools" class="${m("tools")}" title="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ —Ä–∞–±–æ—Ç—ã —Å –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π">
                ${I_Toolbox("w-5 h-5 text-indigo-400")}
                <span class="mt-1 ${S.sidebarCompact? 'hidden' : ''}">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span>
            </button>
        </div>

        ${S.view !== "tools" ? `
        <div class="mb-4 p-1 bg-gray-900/50 rounded-[18px] grid grid-cols-3 gap-1 ${S.sidebarCompact? 'text-[11px]' : 'text-[12px]'}">
            <button data-sub-view="parts" class="${r("parts")}" title="–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏" data-long-press="parts">
                ${I_Brick("w-5 h-5 text-blue-400")}
                <span class="mt-1 ${S.sidebarCompact? 'hidden' : ''}">–î–µ—Ç–∞–ª–∏</span>
                ${s("parts",e,t)}
            </button>
            <button data-sub-view="sets" class="${r("sets")} relative" title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞–±–æ—Ä—ã" data-long-press="sets">
                ${I_Set("w-5 h-5 text-green-400")}
                <span class="mt-1 ${S.sidebarCompact? 'hidden' : ''}">–ù–∞–±–æ—Ä—ã</span>
                ${s("sets",o,l)}
                ${S.view === "catalog" && S.subView === "sets" && S.showRelatedSets && (S.selFigNum || S.selRelatedPartId) ? `<div class="absolute top-1 right-1 w-5 h-5 bg-blue-200 text-blue-800 rounded-full flex items-center justify-center text-xs font-bold">${S.selFigNum ? I_Minifig("w-3 h-3") : I_Brick("w-3 h-3")}</div>` : ''}
            </button>
            <button data-sub-view="minifigs" class="${r("minifigs")}" title="–ü–æ–∫–∞–∑–∞—Ç—å –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏" data-long-press="minifigs">
                ${I_Minifig("w-5 h-5 text-purple-400")}
                <span class="mt-1 ${S.sidebarCompact? 'hidden' : ''}">–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏</span>
                ${s("minifigs",a,i)}
            </button>
        </div>
        
        ` : ''}
        ${S.view !== "tools" ? `
        <div id="sidebar-scroll-container" class="flex-grow overflow-y-auto no-scrollbar ${S.sidebarCompact? 'text-sm' : ''}">
          <div class="sticky top-0 z-10 bg-gray-800/95 backdrop-blur border-b border-gray-700 pb-2 mb-2">
            <div class="flex items-center justify-between">
              <h2 class="text-lg font-semibold text-white">${d}</h2>
            ${S.subView !== 'minifigs' ? `
              <div class=\"flex items-center gap-1\">
                <button id=\"sidebar-toggle-all\" class=\"px-2 py-1 text-xs rounded-[18px] bg-gray-700 text-gray-300 hover:bg-gray-600\" title=\"${(S.subView==='sets' ? (S.expThemes?.size>0) : (S.subView==='parts' ? (S.expCats?.size>0) : false)) ? '–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ' : '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ'}\">${I_Chev(`w-4 h-4 ${(S.subView==='sets' ? (S.expThemes?.size>0) : (S.subView==='parts' ? (S.expCats?.size>0) : false)) ? 'rotate-180' : ''}`)}</button>
                ${((S.subView==='sets' ? ((S.favThemeIds&&S.favThemeIds.size>0)) : (S.subView==='parts' ? ((S.favCatIds&&S.favCatIds.size>0)) : false))
                  ? `<button id="sidebar-favs-toggle" class="px-2 py-1 text-xs rounded-[18px] ${S.sidebarFavsVisible?'bg-gray-600 text-white':'bg-gray-700 text-gray-300 hover:bg-gray-600'}" title="${S.sidebarFavsVisible ? '–°–∫—Ä—ã—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ' : '–ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">${S.sidebarFavsVisible ? I_Heart('w-4 h-4 text-red-400', true) : I_Heart('w-4 h-4', false)}</button>`
                  : ``)}
              </div>
              ` : ''}
            </div>
            ${S.subView !== 'minifigs' ? `
              <ul class="mt-2">${topBtnHtml}</ul>
              <div class="mt-2">
                <div class="relative">
                    <input id="sidebar-search" type="text" placeholder="–§–∏–ª—å—Ç—Ä —Å–ø–∏—Å–∫–æ–≤..." value="${S.sidebarFilter||''}" class="w-full h-10 bg-gray-700 border border-gray-600 rounded-[18px] pl-4 pr-12 text-white placeholder-gray-400 focus:outline-none focus:ring-0" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off" aria-label="–§–∏–ª—å—Ç—Ä –ø—É–Ω–∫—Ç–æ–≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏" />
                    <button id="sidebar-search-clear" class="absolute inset-y-0 right-0 flex items-center justify-center w-10 text-gray-400 hover:text-white hidden" style="display: none;" title="–û—á–∏—Å—Ç–∏—Ç—å">${I_X('w-5 h-5')}</button>
                    <div id="sidebar-search-icon" class="absolute inset-y-0 right-0 flex items-center justify-center w-10 text-gray-400" title="–ü–æ–∏—Å–∫">${I_Search('w-5 h-5')}</div>
                </div>
              </div>
            ` : ''}
          </div>
          <nav>
            ${(() => {
                const mode = 'all';
                const makePinned = () => {
                    try {
                        if (S.subView === 'sets') {
                            const ids = Array.from(S.favThemeIds || []);
                            if (!ids.length) return '';
                            const items = ids.map(id => {
                                const th = THEME_MAP[id];
                                if (!th || !th.name) return '';
                                return `
                                  <li>
                                    <button data-theme-id="${id}" class="w-full text-left flex items-center justify-between p-2 rounded-[18px] transition-colors duration-150 text-gray-300 hover:bg-gray-700/50 hover:text-white">
                                      <span class="truncate">${th.name}</span>
                                      ${I_Heart('w-4 h-4 text-red-400 ml-2', true)}
                                    </button>
                                  </li>
                                `;
                            }).join('');
                            return items;
                        } else if (S.subView === 'parts') {
                            const ids = Array.from(S.favCatIds || []);
                            if (!ids.length) return '';
                            const items = ids.map(id => {
                                const cat = (typeof flatCategories !== 'undefined') ? flatCategories.find(c => c.id === id) : null;
                                const name = cat?.name || `–ö–∞—Ç–µ–≥–æ—Ä–∏—è #${id}`;
                                return `
                                  <li>
                                    <button data-category-id="${id}" class="w-full text-left flex items-center justify-between p-2 rounded-[18px] transition-colors duration-150 text-gray-300 hover:bg-gray-700/50 hover:text-white">
                                      <span class="truncate">${name}</span>
                                      ${I_Heart('w-4 h-4 text-red-400 ml-2', true)}
                                    </button>
                                  </li>
                                `;
                            }).join('');
                            return items;
                        }
                    } catch {}
                    return '';
                };
                const makeRecent = () => {
                    try {
                        const arr = Array.isArray(S.sidebarRecent) ? S.sidebarRecent : [];
                        if (!arr.length) return '';
                        return arr.map(it => {
                            if (it.type === 'theme') {
                                const th = THEME_MAP[it.id];
                                if (!th) return '';
                                return `
                                  <li>
                                    <button data-theme-id="${it.id}" class="w-full text-left flex items-center p-2 rounded-[18px] transition-colors duration-150 text-gray-300 hover:bg-gray-700/50 hover:text-white">
                                      ${I_Set('w-4 h-4 text-green-400 mr-2')}
                                      <span class="truncate">${th.name}</span>
                                    </button>
                                  </li>
                                `;
                            } else if (it.type === 'category') {
                                const cat = (typeof flatCategories !== 'undefined') ? flatCategories.find(c => c.id === it.id) : null;
                                const name = cat?.name || `–ö–∞—Ç–µ–≥–æ—Ä–∏—è #${it.id}`;
                                return `
                                  <li>
                                    <button data-category-id="${it.id}" class="w-full text-left flex items-center p-2 rounded-[18px] transition-colors duration-150 text-gray-300 hover:bg-gray-700/50 hover:text-white">
                                      ${I_Brick('w-4 h-4 text-blue-400 mr-2')}
                                      <span class="truncate">${name}</span>
                                    </button>
                                  </li>
                                `;
                            }
                            return '';
                        }).join('');
                    } catch {}
                    return '';
                };
                if (S.subView === 'minifigs') {
                    // –î–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ —Å–∫—Ä—ã–≤–∞–µ–º —Å–ø–µ—Ü. —Ä–µ–∂–∏–º—ã –∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
                    return `<ul id=\"category-list\" class=\"space-y-1\">${filteredListHtml}</ul>`;
                }
                // –†–µ–∂–∏–º –ø–æ–∫–∞–∑–∞ —Ç–æ–ª—å–∫–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
                if (mode === 'favs') return `<ul id=\"category-list\" class=\"space-y-1\">${filteredListHtml}</ul>`;
                const fav = S.sidebarFavsVisible ? makePinned() : '';
                return `
                  ${S.sidebarFavsVisible && fav ? `
                    <div class=\"flex items-center justify-between px-2 mb-1\">
                      <div class=\"text-xs uppercase tracking-wide text-gray-400\">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
                    </div>
                    <ul id=\"sidebar-fav-list\" class=\"space-y-1\">${fav}</ul>
                    <div class=\"border-t border-gray-700 my-2\"></div>
                  ` : ''}
                  <ul id=\"category-list\" class=\"space-y-1\">${filteredListHtml}</ul>
                `;
            })()}
          </nav>
        </div>
        ` : ''}
        
        ${S.view === "tools" ? `
        <div id="sidebar-scroll-container" class="flex-grow overflow-y-auto no-scrollbar">
          <h2 class="text-lg font-semibold text-white mb-3">${d}</h2>
          <nav>
            <ul id="category-list" class="space-y-1">${c}</ul>
          </nav>
        </div>
        ` : ''}
        
        <div class="flex-shrink-0 mt-4 border-t border-gray-700 pt-4 space-y-4">
            ${"collection"===S.view?`
            <div class="bg-gray-800/50 border border-gray-700 rounded-[18px] overflow-hidden">
                <button id="collection-summary-toggle" class="w-full flex items-center justify-between text-left p-3 group ${S.collectionSummaryExpanded ? '' : 'hover:bg-gray-700/30'} transition-all duration-200" title="${S.collectionSummaryExpanded ? '–°–≤–µ—Ä–Ω—É—Ç—å —Å–≤–æ–¥–∫—É –∫–æ–ª–ª–µ–∫—Ü–∏–∏' : '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å —Å–≤–æ–¥–∫—É –∫–æ–ª–ª–µ–∫—Ü–∏–∏'}" style="${S.collectionSummaryExpanded ? 'box-shadow:none !important; outline:none !important;' : ''}">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-blue-600/20 rounded-[18px] flex items-center justify-center mr-3 ${S.collectionSummaryExpanded ? '' : 'group-hover:bg-blue-600/30'} transition-colors">
                            <svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                        </div>
                        <h3 class="text-sm font-semibold text-gray-300 ${S.collectionSummaryExpanded ? '' : 'group-hover:text-white'} transition-colors">
                            –°–≤–æ–¥–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                        </h3>
                    </div>
                    <div class="flex items-center">
                        <div class="w-6 h-6 bg-gray-600/50 rounded-full flex items-center justify-center group-hover:bg-gray-600/70 transition-colors">
                            <svg class="w-3 h-3 text-gray-400 group-hover:text-gray-300 transition-colors transform ${S.collectionSummaryExpanded ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
                            </svg>
                        </div>
                    </div>
                </button>
                <div id="collection-summary-content" class="${S.collectionSummaryExpanded ? 'block' : 'hidden'} p-3 pt-0 space-y-1.5 transition-all duration-200">
                                          ${0===e&&0===l&&0===i?'<div class="text-center py-4"><div class="text-gray-400 text-sm mb-2 font-medium">–í–∞—à–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—è –ø—É—Å—Ç–∞</div><div class="text-gray-500 text-xs">–ù–∞—á–Ω–∏—Ç–µ —Å–æ–±–∏—Ä–∞—Ç—å LEGO –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</div></div>':`
                        <div class="space-y-1.5">
                          <div class="flex items-center justify-between text-sm py-1.5 px-3 rounded-[18px] bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 transition-all duration-200">
                              <span class="text-gray-300 flex items-center">
                                  ${I_Brick("inline-block w-4 h-4 mr-2 text-blue-400")} 
                                  –î–µ—Ç–∞–ª–∏
                              </span>
                              <div class="text-right flex items-center gap-2">
                                  <div class="text-center">
                                      <div class="text-white font-semibold text-sm">${String(t)}</div>
                                      <div class="text-gray-400 text-xs">—É–Ω–∏–∫.</div>
                                  </div>
                                  <div class="text-gray-500 text-sm">/</div>
                                  <div class="text-center">
                                      <div class="text-white font-semibold text-sm">${String(e)}</div>
                                      <div class="text-gray-400 text-xs">–≤—Å–µ–≥–æ</div>
                                  </div>
                              </div>
                          </div>
                          <div class="flex items-center justify-between text-sm py-1.5 px-3 rounded-[18px] bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 transition-all duration-200">
                              <span class="text-gray-300 flex items-center">
                                  ${I_Set("inline-block w-4 h-4 mr-2 text-green-400")} 
                                  –ù–∞–±–æ—Ä—ã
                              </span>
                              <div class="text-right flex items-center gap-2">
                                  <div class="text-center">
                                      <div class="text-white font-semibold text-sm">${String(l)}</div>
                                      <div class="text-gray-400 text-xs">—É–Ω–∏–∫.</div>
                                  </div>
                                  <div class="text-gray-500 text-sm">/</div>
                                  <div class="text-center">
                                      <div class="text-white font-semibold text-sm">${String(o)}</div>
                                      <div class="text-gray-400 text-xs">–≤—Å–µ–≥–æ</div>
                                  </div>
                              </div>
                          </div>
                          <div class="flex items-center justify-between text-sm py-1.5 px-3 rounded-[18px] bg-gray-700/20 hover:bg-gray-700/40 border border-gray-600/20 hover:border-gray-600/40 transition-all duration-200">
                              <span class="text-gray-300 flex items-center">
                                  ${I_Minifig("inline-block w-4 h-4 mr-2 text-purple-400")} 
                                  –ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                              </span>
                              <div class="text-right flex items-center gap-2">
                                  <div class="text-center">
                                      <div class="text-white font-semibold text-sm">${String(i)}</div>
                                      <div class="text-gray-400 text-xs">—É–Ω–∏–∫.</div>
                                  </div>
                                  <div class="text-gray-500 text-sm">/</div>
                                  <div class="text-center">
                                      <div class="text-white font-semibold text-sm">${String(a)}</div>
                                      <div class="text-gray-400 text-xs">–≤—Å–µ–≥–æ</div>
                                  </div>
                              </div>
                          </div>
                      </div>
                    `}
                </div>
            </div>
            `:""}
            ${S.view !== "tools" ? `
            
            <button id="settings-button" class="w-full mt-3 flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-600 hover:bg-gray-500 text-white shadow-lg hover:shadow-gray-500/25" title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π –∏ –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö">
                ${I_Settings("w-5 h-5 mr-2 text-gray-300")} –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
            ` : ''}
        </div>
        
        ${S.view === "tools" ? `
        <!-- –ö–Ω–æ–ø–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–Ω–∏–∑—É —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ -->
        <div class="flex-shrink-0 mt-4 border-t border-gray-700 pt-4">
            <button id="settings-button" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-600 hover:bg-gray-500 text-white shadow-lg hover:shadow-gray-500/25" title="–û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π –∏ –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö">
                ${I_Settings("w-5 h-5 mr-2 text-gray-300")} –ù–∞—Å—Ç—Ä–æ–π–∫–∏
            </button>
        </div>
        ` : ''}
      `;
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
    const scrollEl = document.getElementById('sidebar-scroll-container');
    if (scrollEl) scrollEl.scrollTop = prevScrollTop;
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é
    setupLongPressHandlers();
    
    // –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–∏ (–±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Ñ–æ–∫—É—Å)
    const filterSidebarList = (term) => {
        const list = document.getElementById('category-list');
        if (!list) return;
        const items = list.querySelectorAll('li');
        const q = (term || '').toLowerCase();
        items.forEach(li => {
            const txt = (li.textContent || '').toLowerCase();
            if (!q) {
                li.classList.remove('hidden');
            } else {
                if (txt.includes(q)) li.classList.remove('hidden'); else li.classList.add('hidden');
            }
        });
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –∫–Ω–æ–ø–æ–∫ –≤—ã–Ω–µ—Å–µ–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        updateSidebarSearchButtonsVisibility();
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫ –ø–æ–∏—Å–∫–∞ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
    function updateSidebarSearchButtonsVisibility() {
        const clearBtn = document.getElementById('sidebar-search-clear');
        const iconBtn = document.getElementById('sidebar-search-icon');
        const searchInput = document.getElementById('sidebar-search');
        
        if (clearBtn && iconBtn && searchInput) {
            const hasText = searchInput.value && searchInput.value.trim().length > 0;
            
            // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –æ–±–µ –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –º–∏–≥–∞–Ω–∏—è
            clearBtn.style.display = 'none';
            iconBtn.style.display = 'none';
            
            // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é –∫–Ω–æ–ø–∫—É
            if (hasText) {
                clearBtn.classList.remove('hidden');
                clearBtn.style.display = 'flex';
                iconBtn.classList.add('hidden');
            } else {
                clearBtn.classList.add('hidden');
                iconBtn.classList.remove('hidden');
                iconBtn.style.display = 'flex';
            }
        }
    }
    const sidebarSearch = document.getElementById('sidebar-search');
    if (sidebarSearch) sidebarSearch.addEventListener('input', (e) => {
        S.sidebarFilter = e.target.value || '';
        filterSidebarList(S.sidebarFilter);
        updateSidebarSearchButtonsVisibility();
    });
    if (sidebarSearch) sidebarSearch.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            S.sidebarFilter = '';
            const el = document.getElementById('sidebar-search');
            if (el) { el.value = ''; el.blur(); }
            filterSidebarList('');
            updateSidebarSearchButtonsVisibility();
            renderSidebar();
        }
    });
    const sidebarSearchClear = document.getElementById('sidebar-search-clear');
    if (sidebarSearchClear) sidebarSearchClear.addEventListener('click', () => {
        S.sidebarFilter = '';
        const el = document.getElementById('sidebar-search');
        if (el) el.value = '';
        filterSidebarList('');
        updateSidebarSearchButtonsVisibility();
        renderSidebar();
    });
    const sidebarSearchIcon = document.getElementById('sidebar-search-icon');
    if (sidebarSearchIcon) sidebarSearchIcon.addEventListener('click', () => { const el = document.getElementById('sidebar-search'); el && el.focus(); });

    // –ö–Ω–æ–ø–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ —É–±—Ä–∞–Ω–∞
    const toggleAll = document.getElementById('sidebar-toggle-all');
    if (toggleAll) toggleAll.addEventListener('click', () => {
        const isOpen = (S.subView==='sets') ? (S.expThemes && S.expThemes.size > 0) : (S.subView==='parts' ? (S.expCats && S.expCats.size > 0) : false);
        if (S.subView === 'sets') {
            if (isOpen) { S.expThemes = new Set(); }
            else { const all = new Set(); try { (S.themeTree||[]).forEach(node => { if (node && node.children && node.children.length) all.add(node.id); }); } catch {} S.expThemes = all; }
        } else if (S.subView === 'parts') {
            if (isOpen) { S.expCats = new Set(); }
            else { const all = new Set(); try { (S.catTree||[]).forEach(node => { if (node && node.name) all.add(node.name); }); } catch {} S.expCats = all; }
        }
        renderSidebar();
    });
    // –¢—É–º–±–ª–µ—Ä –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    const favsToggle = document.getElementById('sidebar-favs-toggle');
    if (favsToggle) favsToggle.addEventListener('click', () => {
        S.sidebarFavsVisible = !S.sidebarFavsVisible;
        try { localStorage.setItem('sidebarFavsVisible', String(S.sidebarFavsVisible)); } catch {}
        renderSidebar();
    });

    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    updateSidebarSearchButtonsVisibility();

    return sidebarEl.innerHTML;
}

function renderHeader() {
    const {
        view: currentView
    } = S;
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–∏—Å–∫–∞
    const searchContext = currentView === 'collection' ? '–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏' : '–≤ –∫–∞—Ç–∞–ª–æ–≥–µ';
    
    let t = `–ü–æ–∏—Å–∫ ${searchContext}...`;
    
    const selCount = S.multiSelect.items?.size || 0;
    const showMultiselectBar = S.multiSelect.active && !((S.view === 'collection') && !S.collectionMultiSelectEnabled);
    const selBar = showMultiselectBar ? `
        <div id="multiselect-bar" class="mt-3 bg-gray-800/80 border border-gray-700 rounded-[18px] p-2 flex items-center justify-between gap-2 flex-nowrap overflow-x-auto no-scrollbar" style="${S.multiSelect.justActivated ? 'animation: msSlideFadeIn .36s cubic-bezier(.22,.61,.36,1) both;' : ''}">
            <div class="flex items-center gap-3 flex-shrink-0">
                <button data-action="cancel-multiselect" class="text-gray-300 hover:text-white" title="–û—Ç–º–µ–Ω–∏—Ç—å –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä">${I_X('w-5 h-5')}</button>
                <span class="text-sm text-gray-300">–í—ã–±—Ä–∞–Ω–æ: <strong>${selCount}</strong></span>
            </div>
            <div class="flex items-center gap-2 flex-nowrap flex-shrink-0">
                ${S.view==='collection' ? `<button data-action="select-all-visible" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold px-3 py-2 rounded-[18px] transition-colors duration-150 shadow-lg hover:shadow-blue-500/25" title="–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä">+ –í—Å–µ</button>` : ''}
                <button data-action="share-multiselect" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-semibold px-3 py-2 rounded-[18px] transition-colors duration-150 shadow-lg hover:shadow-gray-500/25" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —á–µ—Ä–µ–∑ CSV —Ñ–∞–π–ª –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">${I_Share('w-5 h-5')} <span class="hidden sm:inline">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span></button>
                ${S.view==='catalog' ? `<button data-action="add-multiselect-to-collection" class="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white text-sm font-semibold px-3 py-2 rounded-[18px] transition-colors duration-150 shadow-lg hover:shadow-green-500/25" title="–î–æ–±–∞–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é">+ –í –∫–æ–ª–ª–µ–∫—Ü–∏—é</button>` : `<button data-action="delete-multiselect" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold px-3 py-2 rounded-[18px] transition-colors duration-150 shadow-lg hover:shadow-red-500/25" title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏">${I_Trash('w-5 h-5')} <span class=\"hidden sm:inline\">–£–¥–∞–ª–∏—Ç—å</span></button>`}
            </div>
        </div>
    ` : '';
    headerEl.innerHTML = `
            <div class="flex justify-between items-center gap-4">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="sidebar-toggle-btn lg:hidden" title="–û—Ç–∫—Ä—ã—Ç—å/–∑–∞–∫—Ä—ã—Ç—å –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏">
                        ${I_Menu("w-4 h-4")}
                    </button>
                         <h1 class="text-xl font-bold text-white hidden sm:block main-title">
                         <span class="bg-gradient-to-r from-blue-400 via-blue-500 to-blue-600 bg-clip-text text-transparent font-extrabold tracking-tight">LEGO¬Æ Catalog</span>
                          ${S.view === "catalog" && S.subView === "sets" && S.showRelatedSets && (S.selFigNum || S.selRelatedPartId) ? 
                              `<span class=\"text-sm font-normal text-blue-400 ml-2\">‚Ä¢ –°–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã</span>` : ''}
                      </h1>
                </div>
                <div class="flex items-center space-x-2 w-full max-w-sm">
                    <div class="relative flex-grow">
                        <input id="search-input" type="search" placeholder="${t}" value="${S.q}" class="w-full bg-gray-700 border border-gray-600 rounded-[18px] pl-4 pr-12 text-white placeholder-gray-400 focus:outline-none focus:ring-0" title="–ü–æ–∏—Å–∫ ${searchContext}" autocomplete="off" spellcheck="false" autocorrect="off" autocapitalize="off"/>
                        <button id="clear-search" class="absolute inset-y-0 right-0 flex items-center justify-center w-10 text-gray-400 hover:text-white ${S.q?"":"hidden"}" title="–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å">${I_X("w-5 h-5")}</button>
                        <div id="search-icon" class="absolute inset-y-0 right-0 flex items-center justify-center w-10 text-gray-400 ${S.q?"hidden":""}" title="–ü–æ–∏—Å–∫">
                            ${I_Search("w-5 h-5")}
                        </div>
                        <div id="autocomplete-dropdown">
                            <!-- –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–¥–µ—Å—å -->
                        </div>
                    </div>
                     <button id="search-button" class="px-3 bg-blue-600 text-white rounded-[18px] hover:bg-blue-700 transition-colors duration-150 shadow-lg hover:shadow-blue-500/25 flex-shrink-0 hidden" aria-label="–ü–æ–∏—Å–∫" title="–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–∏—Å–∫ ${searchContext}">
                        ${I_Search("w-5 h-5")}
                    </button>
                    <button id="ai-search-button" class="px-3 bg-blue-600 text-white rounded-[18px] hover:bg-blue-700 transition-colors duration-150 shadow-lg hover:shadow-blue-500/25 flex-shrink-0" aria-label="AI –ø–æ–∏—Å–∫" title="AI –ø–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏" onclick="openAISearch()">
                        ${I_Camera("w-5 h-5")}
                    </button>
                    <button id="filter-button" class="px-3 bg-gray-600 text-white rounded-[18px] hover:bg-gray-500 transition-colors duration-150 shadow-lg hover:shadow-gray-500/25 flex-shrink-0" aria-label="–§–∏–ª—å—Ç—Ä—ã" title="–û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏">
                        ${I_Filter("w-5 h-5")}
                    </button>

                </div>
            </div>
            
            ${selBar}
        `;
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
    setTimeout(() => {
        setupSearchButtonsVisibility();
    }, 0);
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–Ω–ª–∞–π–Ω/–æ—Ñ—Ñ–ª–∞–π–Ω
    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–µ—Ç–∏ –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
}
function renderSetCard(e, t, o = 0) {
    if (!e) return "";
    const l = "", // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: t ? "animate-in" : "",
        a = "", // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: t ? S.getAnimationDelay(o) : "",
        i = S.setColl[e.set_num] ? S.setColl[e.set_num].qty : 0;
    // –ï—Å–ª–∏ —É –Ω–∞–±–æ—Ä–∞ –Ω–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ —á–µ—Ä–µ–∑ API –æ–¥–∏–Ω —Ä–∞–∑
    if ((!e.set_img_url || !String(e.set_img_url).startsWith('http')) && e.set_num && !SET_IMAGE_FETCHING.has(e.set_num) && !SET_IMAGE_FAILED.has(e.set_num)) {
        if (API_IMAGE_FETCH_COUNT >= API_IMAGE_FETCH_LIMIT) {
            // –î–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ —Å–µ—Å—Å–∏—é ‚Äî –±–æ–ª—å—à–µ –Ω–µ –ø—ã—Ç–∞–µ–º—Å—è
            SET_IMAGE_FAILED.add(e.set_num);
        } else {
        SET_IMAGE_FETCHING.add(e.set_num);
        (async () => {
            try {
                API_IMAGE_FETCH_COUNT++;
                
                const resp = await fetchWithProxy(`${REBRICKABLE_API_URL}/sets/${e.set_num}/`, { headers: { Authorization: `key ${getApiKey()}` }});
                if (resp.ok) {
                    const data = await resp.json();
                    if (data && data.set_img_url) {
                        e.set_img_url = data.set_img_url;
                        SET_MAP[e.set_num] = { ...SET_MAP[e.set_num], set_img_url: data.set_img_url };
                        markApiStatOnce('images', `set:${e.set_num}`);
                        markApiStatOnce('sets', e.set_num);
                        saveState();
                        S.gridStale = true; updateUI();
                    } else {
                        // –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è ‚Äî –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –Ω–µ—É–¥–∞—á–Ω—É—é –ø–æ–ø—ã—Ç–∫—É, —á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–≥–∞—Ç—å API –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ
                        SET_IMAGE_FAILED.add(e.set_num);
                    }
                }
            } catch (err) {
                console.error('Failed to fetch set image via API:', e.set_num, err);
                SET_IMAGE_FAILED.add(e.set_num);
            } finally {
                SET_IMAGE_FETCHING.delete(e.set_num);
            }
        })();
        }
    }
    return `
            <div data-set-num="${e.set_num}" style="${a}" class="set-card ${l} relative bg-gray-800 rounded-[18px] overflow-hidden group cursor-pointer">
                ${i>0?`<div class="absolute top-3 left-3 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md pointer-events-none">${i}</div>`:""}
                <div class="w-full h-40 bg-gray-700 flex items-center justify-center p-2 rounded-t-lg card-image-container">
                    <div class="w-full h-full bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-inner relative">
                        <img ${getSetImageAttrs(e.set_num, e.set_img_url)} alt="${e.name}" class="w-full h-full object-contain pointer-events-none" loading="lazy" />
                        ${((S.view==="collection" && S.collectionMultiSelectEnabled) || (S.view==="catalog" && S.catalogMultiSelectEnabled))?`
                        <button data-action="toggle-select" data-item-type="set" data-item-id="${e.set_num}" class="absolute top-1.5 right-1.5 bg-gray-900/40 hover:bg-gray-900/60 text-white/80 hover:text-white rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md ${S.multiSelect.active && S.multiSelect.items.has(`sets:${e.set_num}`)?'opacity-100 text-white hover:text-white bg-gray-900/70':'opacity-100 md:opacity-0 md:group-hover:opacity-100'}">
                            ${S.multiSelect.active && S.multiSelect.items.has(`sets:${e.set_num}`) ? I_CheckCircle('w-4 h-4') : I_Circle('w-4 h-4')}
                        </button>
                        `:""}
                        ${S.view==="catalog" && S.wishlistEnabled?`
                        <button data-action="add-to-wishlist" data-item-type="set" data-item-id="${e.set_num}" class="absolute bottom-1.5 left-1.5 ${isInWishlist('set', e.set_num) ? 'bg-gradient-to-br from-amber-400 to-yellow-500 hover:from-amber-300 hover:to-yellow-400 shadow-amber-500/60 ring-2 ring-amber-400/50' : 'bg-gradient-to-br from-gray-600/80 to-gray-700/80 hover:from-gray-500/90 hover:to-gray-600/90 shadow-gray-500/40'} text-white rounded-full w-6 h-6 flex items-center justify-center z-20 shadow-lg hover:shadow-xl opacity-100 transition-all duration-200 hover:scale-110 hidden" title="${isInWishlist('set', e.set_num) ? '–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π' : '–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π'}">
                            ${I_Star('w-4 h-4')}
                        </button>
                        `:""}
                ${S.view==="collection"?`
                        <button aria-label="–£–¥–∞–ª–∏—Ç—å ${e.name}" data-action="delete-set-from-collection" data-set-num="${e.set_num}" class="absolute bottom-2 right-2 bg-red-600 text-white p-1.5 rounded-full z-10 shadow-lg hover:shadow-red-500/25 opacity-100 focus:opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-all duration-150" title="–£–¥–∞–ª–∏—Ç—å –Ω–∞–±–æ—Ä –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏">
                    ${I_Trash("w-4 h-4")}
                </button>`:""}
                    </div>
                </div>
                <div class="p-4 space-y-1 card-info-container">
                    <h3 class="text-sm font-semibold text-white truncate pointer-events-none card-title">${e.name}</h3>
                    <p class="text-xs text-gray-400 pointer-events-none card-info-text">#${e.set_num} ‚Ä¢ ${e.num_parts} –¥–µ—Ç–∞–ª–µ–π</p>
                    <p class="text-xs text-gray-300 pointer-events-none card-info-text">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: ${e.year}</p>
                </div>
            </div>
        `
}
function renderMinifigCard(e, t, o = 0) {
    if (!e) return `
        <div class="minifig-card relative bg-gray-800 rounded-[18px] overflow-hidden group p-4 flex flex-col items-center justify-center" style="min-height: 180px;">
            <div class="w-16 h-16 bg-gray-700 rounded-full mb-4"></div>
            <div class="h-4 bg-gray-700 rounded w-24 mb-2"></div>
            <div class="h-3 bg-gray-700 rounded w-16 mb-1"></div>
            <div class="h-3 bg-gray-700 rounded w-12"></div>
            <span class="text-gray-400 text-xs mt-4 card-info-text">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        </div>
    `;
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏, –µ—Å–ª–∏ –∏–º—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
    if (!e.name && e.set_num) {
        fetchMinifigDetails(e.set_num).catch(console.error);
    }
    const l = "", // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: t ? "animate-in" : "",
        a = "", // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: t ? S.getAnimationDelay(o) : "",
        i = S.minifigColl[e.set_num] ? S.minifigColl[e.set_num].qty : 0;
    return `
            <div data-fig-num="${e.set_num}" style="${a}" class="minifig-card ${l} relative bg-gray-800 rounded-[18px] overflow-hidden group cursor-pointer">
                ${S.view==="collection"?"":""}
                ${i>0?`<div class="absolute top-3 left-3 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md pointer-events-none">${i}</div>`:""}
                <div class="w-full h-40 bg-gray-700 flex items-center justify-center p-2 rounded-t-lg card-image-container">
                    <div class="w-full h-full bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-inner relative">
                        <img ${getPartImageUrl((e.minifig_img_url && e.minifig_img_url.startsWith('http')) || (e.set_img_url && e.set_img_url.startsWith('http')) ? (e.minifig_img_url || e.set_img_url) : null)} alt="${e.name}" class="w-full h-full object-contain pointer-events-none" loading="lazy" />
                        ${((S.view==="collection" && S.collectionMultiSelectEnabled) || (S.view==="catalog" && S.catalogMultiSelectEnabled))?`
                        <button data-action="toggle-select" data-item-type="minifig" data-item-id="${e.set_num}" class="absolute top-1.5 right-1.5 bg-gray-900/40 hover:bg-gray-900/60 text-white/80 hover:text-white rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md ${S.multiSelect.active && S.multiSelect.items.has(`minifigs:${e.set_num}`)?'opacity-100 text-white hover:text-white bg-gray-900/70':'opacity-100 md:opacity-0 md:group-hover:opacity-100'}">
                            ${S.multiSelect.active && S.multiSelect.items.has(`minifigs:${e.set_num}`) ? I_CheckCircle('w-4 h-4') : I_Circle('w-4 h-4')}
                        </button>
                        `:""}
                        ${S.view==="catalog" && S.wishlistEnabled?`
                        <button data-action="add-to-wishlist" data-item-type="minifig" data-item-id="${e.set_num}" class="absolute bottom-1.5 left-1.5 ${isInWishlist('minifig', e.set_num) ? 'bg-gradient-to-br from-amber-400 to-yellow-500 hover:from-amber-300 hover:to-yellow-400 shadow-amber-500/60 ring-2 ring-amber-400/50' : 'bg-gradient-to-br from-gray-600/80 to-gray-700/80 hover:from-gray-500/90 hover:to-gray-600/90 shadow-gray-500/40'} text-white rounded-full w-6 h-6 flex items-center justify-center z-20 shadow-lg hover:shadow-xl opacity-100 transition-all duration-200 hover:scale-110 hidden" title="${isInWishlist('minifig', e.set_num) ? '–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π' : '–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π'}">
                            ${I_Star('w-4 h-4')}
                        </button>
                        `:""}
                ${S.view==="collection"?`
                        <button aria-label="–£–¥–∞–ª–∏—Ç—å ${e.name || e.set_num}" data-action="delete-minifig-from-collection" data-fig-num="${e.set_num}" class="absolute bottom-2 right-2 bg-red-600 text-white p-1.5 rounded-full z-10 shadow-lg hover:shadow-red-500/25 opacity-100 focus:opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-all duration-150" title="–£–¥–∞–ª–∏—Ç—å –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏">
                    ${I_Trash("w-4 h-4")}
                </button>`:""}
                    </div>
                </div>
                <div class="p-4 space-y-1 card-info-container">
                    <h3 class="text-sm font-semibold text-white truncate pointer-events-none card-title">${e.name || '–ó–∞–≥—Ä—É–∑–∫–∞...'}</h3>
                    <p class="text-xs text-gray-400 pointer-events-none card-info-text">#${e.set_num}</p>
                    ${!e.name ? '<p class="text-xs text-blue-400 card-info-text">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏...</p>' : ''}
                </div>
            </div>
        `
}

function renderPartCard(e, t, o, l, a = 0) {
    if (!e) return "";
    const i = "collection" === S.view,
        n = getGroupId(e.id),
        r = "", // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: l ? "animate-in" : "",
        s = ""; // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: l ? S.getAnimationDelay(a) : "";
    let c = "";
    o > 0 && (c = `<div class="absolute top-3 left-3 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md pointer-events-none">${o}</div>`);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–¥–∫–æ—Å—Ç–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    let rarityIndicator = "";
    if (i && t) {
        const rarity = calculatePartRarity(e.id, t.id);
        if (['legendary', 'epic', 'rare'].includes(rarity)) {
            const rarityColor = getRarityColor(rarity);
            const rarityName = getRarityName(rarity);
            rarityIndicator = `<div class="absolute top-3 right-3 w-3 h-3 rounded-full border-2 border-white shadow-md pointer-events-none" style="background-color: ${rarityColor}" title="${rarityName}"></div>`;
        }
    }
            // –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç part_img_url –∏–∑ inventory_parts.csv –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    let d = e.part_img_url || e.rebrickable_img_url;
    
    // Debug: Log image URL selection
    console.log(`Part ${e.id} (${e.name}): part_img_url=${e.part_img_url}, rebrickable_img_url=${e.rebrickable_img_url}, selected=${d}`);
    
    // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ –∏ –¥–æ—Å—Ç—É–ø–Ω–∞
    if (i && t && localStorage.getItem('disableColorSpecificImages') !== 'true') {
        const colorImage = PART_MAP[e.id]?.colorImages?.[t.id];
        if (colorImage && colorImage.startsWith('http')) {
            d = colorImage;
            console.log(`Using color-specific image for part ${e.id} color ${t.id}: ${colorImage}`);
        }
    }
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è - –Ω–æ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
    if (!d || typeof d !== 'string' || !d.startsWith('http')) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–æ–æ–±—â–µ –Ω–µ—Ç
        if (!e.part_img_url && !e.rebrickable_img_url) {
            d = `https://cdn.rebrickable.com/media/parts/${e.id}.jpg`;
            console.log(`Generated fallback URL for part ${e.id}: ${d}`);
        } else {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ HTTP (–º–æ–∂–µ—Ç –±—ã—Ç—å data: URL –∏–ª–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å)
            d = e.part_img_url || e.rebrickable_img_url;
            console.log(`Using existing non-HTTP URL for part ${e.id}: ${d}`);
        }
    }
    

    const tHtml = t ? `
        <div class="flex items-center pt-1 pointer-events-none">
            <span class="w-4 h-4 rounded-full border border-gray-500 ${t.isTransparent?"checkerboard":""}" style="background-color: ${t.hex};"></span>
            <span class="ml-2 text-xs text-gray-300 truncate card-info-text">${t.name}</span>
        </div>
    ` : "";
    return `
            <div data-group-id="${n}" data-part-id="${e.id}" ${i && t ?`data-color-id="${t.id}"`:""} style="${s}" class="part-card ${r} relative bg-gray-800 rounded-[18px] overflow-hidden group cursor-pointer">
                ${i && t ?"" :""}
                ${c}
                ${rarityIndicator}
                <div class="w-full h-40 bg-gray-700 flex items-center justify-center p-2 rounded-t-lg card-image-container">
                    <div class="w-full h-full bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-inner relative">
                        <img ${getPartImageAttrs(e.id, d)} alt="${e.name}" class="w-full h-full object-contain pointer-events-none" loading="lazy" />
                        ${(S.view==="collection" && S.collectionMultiSelectEnabled)?`
                        <button data-action="toggle-select" data-item-type="part" data-item-id="${e.id}" data-color-id="${t?.id || ''}" class="absolute top-1.5 right-1.5 bg-gray-900/40 hover:bg-gray-900/60 text-white/80 hover:text-white rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md ${S.multiSelect.active && S.multiSelect.items.has(`parts:${e.id}:${t?.id || ''}`)?'opacity-100 text-white hover:text-white bg-gray-900/70':'opacity-100 md:opacity-0 md:group-hover:opacity-100'}">
                            ${S.multiSelect.active && S.multiSelect.items.has(`parts:${e.id}:${t?.id || ''}`) ? I_CheckCircle('w-4 h-4') : I_Circle('w-4 h-4')}
                        </button>
                        `: ''}
                        ${S.view==="catalog" && S.wishlistEnabled?`
                        <button data-action="add-to-wishlist" data-item-type="part" data-item-id="${e.id}" data-color-id="${t?.id || ''}" class="absolute bottom-1.5 left-1.5 ${isInWishlist('part', e.id, t?.id) ? 'bg-gradient-to-br from-amber-400 to-yellow-500 hover:from-amber-300 hover:to-yellow-400 shadow-amber-500/60 ring-2 ring-amber-400/50' : 'bg-gradient-to-br from-gray-600/80 to-gray-700/80 hover:from-gray-500/90 hover:to-gray-600/90 shadow-gray-500/40'} text-white rounded-full w-6 h-6 flex items-center justify-center z-20 shadow-lg hover:shadow-xl opacity-100 transition-all duration-200 hover:scale-110 hidden" title="${isInWishlist('part', e.id, t?.id) ? '–£–¥–∞–ª–∏—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π' : '–î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π'}">
                            ${I_Star('w-4 h-4')}
                        </button>
                        `:""}
                ${i && t ?`
                        <button aria-label="–£–¥–∞–ª–∏—Ç—å ${e.name} (${t.name})" data-action="delete-from-collection" data-part-id="${e.id}" data-color-id="${t.id}" class="absolute bottom-2 right-2 bg-red-600 text-white p-1.5 rounded-full z-10 shadow-lg hover:shadow-red-500/25 opacity-100 focus:opacity-100 md:opacity-0 md:group-hover:opacity-100 transition-all duration-150" title="–£–¥–∞–ª–∏—Ç—å –¥–µ—Ç–∞–ª—å –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏">
                        ${I_Trash("w-4 h-4")}
                    </button>
                `:""}
                    </div>
                </div>
                <div class="p-4 space-y-1 card-info-container">
                    <h3 class="text-sm font-semibold text-white truncate pointer-events-none card-title">${e.name}</h3>
                    <p class="text-xs text-gray-400 pointer-events-none card-info-text">ID: ${e.id}</p>
                    ${i? tHtml :""}
                </div>
            </div>
        `
}

function renderAppliedFilters() {
    let e = "",
        t = !1,
        o = !1;
    if ("sets" === S.subView) {
        const {
            minYear: l,
            maxYear: a,
            minParts: i,
            maxParts: n
        } = S.setFilters, r = [(l && l.trim() !== '') && `–ú–∏–Ω. –≥–æ–¥: ${l}`, (a && a.trim() !== '') && `–ú–∞–∫—Å. –≥–æ–¥: ${a}`, (i && i.trim() !== '') && `–ú–∏–Ω. –¥–µ—Ç–∞–ª–µ–π: ${i}`, (n && n.trim() !== '') && `–ú–∞–∫—Å. –¥–µ—Ç–∞–ª–µ–π: ${n}`].filter(Boolean).map(e => `
                <div class="flex items-center bg-green-900/50 text-green-200 rounded-full pl-3 pr-2 py-1 text-sm">
                    <span class="mr-2">${e}</span>
                </div>`).join(""), s = {
            year_desc: "–ì–æ–¥ (–Ω–æ–≤—ã–µ)",
            year_asc: "–ì–æ–¥ (—Å—Ç–∞—Ä—ã–µ)",
            parts_desc: "–î–µ—Ç–∞–ª–∏ (—É–±—ã–≤.)",
            parts_asc: "–î–µ—Ç–∞–ª–∏ (–≤–æ–∑—Ä.)",
            alpha_asc: "–ê–ª—Ñ–∞–≤–∏—Ç (A-Z)",
            alpha_desc: "–ê–ª—Ñ–∞–≤–∏—Ç (Z-A)"
        },
        c = {
            [Symbol.iterator]: function*() {
                yield* Object.entries(this).map(([k, v]) => [k, v])
            }
        };
        Object.assign(c, s);
        t = S.q ? "relevance" === S.sortBy : "year_desc" === S.sortBy;
        const d = t || !s[S.sortBy] || s[S.sortBy] === undefined ? "" : `
                <div class="flex items-center bg-gray-600 text-gray-200 rounded-full pl-3 pr-2 py-1 text-sm">
                    <span class="mr-2">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: ${s[S.sortBy]}</span>
                </div>
            `;
        e = [d, r].filter(Boolean).join(""), o = (!t) || ((l && l.trim() !== '') || (a && a.trim() !== '') || (i && i.trim() !== '') || (n && n.trim() !== ''))
    } else if ("minifigs" === S.subView) {
        const l = {
            name_asc: "–ê–ª—Ñ–∞–≤–∏—Ç (A-Z)",
            name_desc: "–ê–ª—Ñ–∞–≤–∏—Ç (Z-A)",
            num_parts_desc: "–ö–æ–ª-–≤–æ –¥–µ—Ç–∞–ª–µ–π (—É–±—ã–≤.)",
            num_parts_asc: "–ö–æ–ª-–≤–æ –¥–µ—Ç–∞–ª–µ–π (–≤–æ–∑—Ä.)"
        },
        a = {
            [Symbol.iterator]: function*() {
                yield* Object.entries(this).map(([k, v]) => [k, v])
            }
        };
        Object.assign(a, l);
        t = S.q ? "relevance" === S.sortBy : "name_asc" === S.sortBy;
        const i = t || !l[S.sortBy] || l[S.sortBy] === undefined ? "" : `
                <div class="flex items-center bg-gray-600 text-gray-200 rounded-full pl-3 pr-2 py-1 text-sm">
                    <span class="mr-2">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: ${l[S.sortBy]}</span>
                </div>
            `;
        e = i, o = !t
    } else {
        const {
            colorIds: l,
            inCollectionOnly: a
        } = S.filters, i = l.map(e => {
            if (!COLOR_MAP[e]) return "";
            return `
                <div class="flex items-center bg-blue-900/50 text-blue-200 rounded-full pl-3 pr-2 py-1 text-sm">
                    <span class="mr-2">${COLOR_MAP[e].name}</span>
                    <button data-action="remove-filter" data-filter-type="color" data-color-id="${e}" class="text-blue-200 hover:bg-blue-500/50 rounded-full p-0.5">${I_X("w-4 h-4")}</button>
                </div>
                `
        }).join(""), n = a && "catalog" === S.view ? `
                <div class="flex items-center bg-green-900/50 text-green-200 rounded-full pl-3 pr-2 py-1 text-sm">
                    <span class="mr-2">–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                    <button data-action="remove-filter" data-filter-type="inCollectionOnly" class="text-green-200 hover:bg-green-500/50 rounded-full p-0.5">${I_X("w-4 h-4")}</button>
                </div>
            ` : "", r = {
            relevance: "–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å",
            alpha_asc: "–ê–ª—Ñ–∞–≤–∏—Ç (A-Z)",
            alpha_desc: "–ê–ª—Ñ–∞–≤–∏—Ç (Z-A)",
            popularity: "–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å",
            quantity_desc: "–ö–æ–ª-–≤–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (—É–±—ã–≤.)",
            quantity_asc: "–ö–æ–ª-–≤–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–≤–æ–∑—Ä.)"
        },
        s = {
            [Symbol.iterator]: function*() {
                yield* Object.entries(this).map(([k, v]) => [k, v])
            }
        };
        Object.assign(s, r);
        t = S.q ? "relevance" === S.sortBy : "popularity" === S.sortBy;
        const c = t || !r[S.sortBy] || r[S.sortBy] === undefined ? "" : `
                <div class="flex items-center bg-gray-600 text-gray-200 rounded-full pl-3 pr-2 py-1 text-sm">
                    <span class="mr-2">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: ${r[S.sortBy]}</span>
                    <button data-action="remove-filter" data-filter-type="sortBy" class="text-gray-200 hover:bg-gray-500/50 rounded-full p-0.5">${I_X("w-4 h-4")}</button>
                </div>
            `;
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        const tempFilters = [];
        if (S.tempRarityFilter) {
            tempFilters.push(`
                <div class="flex items-center bg-purple-900/50 text-purple-200 rounded-full pl-3 pr-2 py-1 text-sm">
                    <span class="mr-2">–†–µ–¥–∫–æ—Å—Ç—å: ${getRarityName(S.tempRarityFilter)}</span>
                    <button data-action="clear-temp-filters" class="text-purple-200 hover:bg-purple-500/50 rounded-full p-0.5">${I_X("w-4 h-4")}</button>
                </div>
            `);
        }
        if (S.tempColorFilter) {
            const colorName = COLOR_MAP[S.tempColorFilter]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ü–≤–µ—Ç';
            tempFilters.push(`
                <div class="flex items-center bg-purple-900/50 text-purple-200 rounded-full pl-3 pr-2 py-1 text-sm">
                    <span class="mr-2">–¶–≤–µ—Ç: ${colorName}</span>
                    <button data-action="clear-temp-filters" class="text-purple-200 hover:bg-purple-500/50 rounded-full p-0.5">${I_X("w-4 h-4")}</button>
                </div>
            `);
        }
        if (S.tempCategoryFilter) {
            const category = flatCategories.find(cat => cat.id === parseInt(S.tempCategoryFilter));
            const categoryName = category?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è';
            tempFilters.push(`
                <div class="flex items-center bg-purple-900/50 text-purple-200 rounded-full pl-3 pr-2 py-1 text-sm">
                    <span class="mr-2">–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${categoryName}</span>
                    <button data-action="clear-temp-filters" class="text-purple-200 hover:bg-purple-500/50 rounded-full p-0.5">${I_X("w-4 h-4")}</button>
                </div>
            `);
        }
        
        e = [c, i, n, ...tempFilters].filter(Boolean).join(""), o = (!t && S.sortBy !== "popularity" && !S.selFigNum) || (l.length > 0 && !S.selFigNum) || (a && "catalog" === S.view && a === true && !S.selFigNum) || tempFilters.length > 0
    }
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ" –ø—Ä–∏ –ø–æ–∫–∞–∑–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
    // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const hasActiveFilters = e.trim() !== "";
    const shouldShowClearButton = o && hasActiveFilters && !(S.subView === "sets" && S.selFigNum && S.showRelatedSets && !S.q);
    
    return shouldShowClearButton ? `
            <div class="px-4 pt-2 pb-0">
                <div class="flex items-center flex-wrap gap-2">
                    ${e}
                    <button data-action="remove-all-filters" class="text-sm text-blue-400 hover:underline">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                </div>
            </div>
        ` : ""
}

// –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏: –≤ –ø–∞–ø–∫—É —Ç–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö > 1 —Ü–≤–µ—Ç–∞
function groupCollectionPartsForDisplay(items) {
    try {
        const partIdToGroup = new Map();
        (items || []).forEach(entry => {
            const pid = entry?.part?.id;
            if (!pid) return;
            if (!partIdToGroup.has(pid)) {
                partIdToGroup.set(pid, { part: entry.part, colors: [], totalQty: 0 });
            }
            const g = partIdToGroup.get(pid);
            g.colors.push({ color: entry.color, quantity: entry.quantity });
            g.totalQty += entry.quantity || 0;
        });
        const display = [];
        for (const g of partIdToGroup.values()) {
            const uniqueColors = new Map();
            g.colors.forEach(ci => {
                const key = String(ci?.color?.id);
                if (!uniqueColors.has(key)) uniqueColors.set(key, ci);
            });
            const colorList = Array.from(uniqueColors.values());
            if (colorList.length > 3 && S.foldersEnabled) {
                console.log(`Creating folder for part ${g.part?.id} with ${colorList.length} colors, total qty: ${g.totalQty}`);
                display.push({ type: 'folder', part: g.part, colors: colorList, totalQty: g.totalQty });
            } else {
                // –î–ª—è 1-3 —Ü–≤–µ—Ç–æ–≤ –∏–ª–∏ –µ—Å–ª–∏ –ø–∞–ø–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –∫–∞–∂–¥–æ–º—É —Ü–≤–µ—Ç—É
                for (const ci of colorList) {
                    display.push({ type: 'single', entry: { part: g.part, color: ci?.color || null, quantity: ci?.quantity || 0 } });
                }
            }
        }
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ä–µ–∂–∏–º—É
        const getName = it => it.type === 'folder' ? (it.part?.name || '') : (it.entry?.part?.name || '');
        const getQty = it => it.type === 'folder' ? (it.totalQty || 0) : (it.entry?.quantity || 0);
        const getPopularity = it => it.type === 'folder' ? (PART_MAP[it.part?.id]?.num_sets || 0) : (PART_MAP[it.entry?.part?.id]?.num_sets || 0);
        switch (S.sortBy) {
            case 'alpha_desc':
                display.sort((a,b)=> (getName(b)).localeCompare(getName(a), 'en'));
                break;
            case 'quantity_desc':
                display.sort((a,b)=> getQty(b) - getQty(a) || getName(a).localeCompare(getName(b),'en'));
                break;
            case 'quantity_asc':
                display.sort((a,b)=> getQty(a) - getQty(b) || getName(a).localeCompare(getName(b),'en'));
                break;
            case 'popularity':
                display.sort((a,b)=> getPopularity(b) - getPopularity(a));
                break;
            case 'popular': // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø–æ–¥–¥–µ—Ä–∂–∏–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–µ –∏–º—è
                display.sort((a,b)=> getPopularity(b) - getPopularity(a));
                break;
            default:
                display.sort((a,b)=> getName(a).localeCompare(getName(b),'en'));
        }
        return display;
    } catch (e) {
        console.warn('groupCollectionPartsForDisplay failed:', e);
        return [];
    }
}

// –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–ø–∫–∏ (—Ç–∞–π–ª —Ä–∞–∑–º–µ—Ä–∞ –∫–∞—Ä—Ç–æ—á–∫–∏) —Å 4 –º–∏–Ω–∏–∞—Ç—é—Ä–∞–º–∏ –ø–µ—Ä–≤—ã—Ö —Ü–≤–µ—Ç–æ–≤
function renderCollectionFolderCard(part, colors) {
    try {
        console.log(`Rendering folder card for part ${part?.id}:`, { part, colors, coll: S.coll?.[part?.id] });
        const groupId = getGroupId(part.id);
        const thumbs = (colors || []).slice(0,4);
        const thumbImgs = thumbs.map(ci => {
            const colorId = String(ci?.color?.id || '');
            const fallback = part.rebrickable_img_url || part.part_img_url || '';
            return `<div class="w-full h-full flex items-center justify-center bg-white rounded-[18px] overflow-hidden shadow-md border border-gray-200 hover:shadow-lg hover:scale-105 transition-all duration-200 cursor-pointer"><img ${getColorImageUrl(part.id, colorId, fallback)} alt="${part.name}" class="w-full h-full object-contain" loading="lazy" /></div>`;
        });
        while (thumbImgs.length < 4) {
            thumbImgs.push(`<div class="w-full h-full bg-gray-100 rounded-[18px] border border-gray-200 flex items-center justify-center opacity-60"><div class="w-6 h-6 bg-gray-300 rounded-full"></div></div>`);
        }
        const colorsCount = (colors || []).length;
        const inCollectionQty = Object.values(S.coll?.[part.id] || {}).reduce((a,b)=>a+b,0);
        const isExpanded = !!(S.expandedFolders && S.expandedFolders.has(String(part.id)));
        const ringClasses = isExpanded ? ' ring-2 ring-blue-500 ' : '';
        const expandedClasses = isExpanded ? ' shadow-lg shadow-blue-500/50 bg-gradient-to-br from-gray-800 to-gray-700 ' : '';
        return `
            <div data-group-id="${groupId}" data-part-id="${part.id}" data-folder="true" class="part-card${ringClasses}${expandedClasses} relative bg-gray-800 rounded-[18px] overflow-hidden group cursor-pointer transition-all duration-300">
                ${inCollectionQty>0?`<div class="absolute top-3 left-3 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md pointer-events-none">${inCollectionQty}</div>`:""}
                <div class="w-full h-40 bg-gradient-to-br from-gray-600 to-gray-700 flex items-center justify-center p-2 rounded-t-lg card-image-container">
                    <div class="w-full h-full relative grid grid-cols-2 grid-rows-2 gap-2">
                        ${thumbImgs.join('')}
                        ${(S.view==="collection" && S.collectionMultiSelectEnabled)?`
                        <button data-action="toggle-select" data-item-type="part-folder" data-item-id="${part.id}" class="absolute top-1.5 right-1.5 bg-gray-900/40 hover:bg-gray-900/60 text-white/80 hover:text-white rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md ${S.multiSelect.active && S.multiSelect.items.has(`parts-folder:${part.id}`)?'opacity-100 text-white hover:text-white bg-gray-900/70':'opacity-100 md:opacity-0 md:group-hover:opacity-100'}">
                            ${S.multiSelect.active && S.multiSelect.items.has(`parts-folder:${part.id}`) ? I_CheckCircle('w-4 h-4') : I_Circle('w-4 h-4')}
                        </button>
                        `:""}
                                          
                        ${S.view==="collection"?`
                        <button aria-label="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ü–≤–µ—Ç–∞ ${part.name}" data-action="delete-folder-from-collection" data-part-id="${part.id}" class="absolute bottom-2 right-2 bg-red-600 text-white p-1.5 rounded-full z-10 shadow-md opacity-100 focus:opacity-100 md:opacity-0 md:group-hover:opacity-100" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ ${getColorWord(colorsCount)} –¥–µ—Ç–∞–ª–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏">${I_Trash('w-4 h-4')}</button>
                        `:""}
                    </div>
                </div>
                <div class="p-4 space-y-1 card-info-container">
                    <h3 class="text-sm font-semibold text-white truncate pointer-events-none card-title">${part.name}</h3>
                    <p class="text-xs text-gray-400 pointer-events-none card-info-text">ID: ${part.id}</p>
                    <p class="text-xs text-gray-300 pointer-events-none card-info-text">${getColorWord(colorsCount)}: ${colorsCount}</p>
                </div>
            </div>
        `;
    } catch (e) {
        console.warn('renderCollectionFolderCard failed:', e);
        return '';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π (–¥–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞)
function getCurrentFilteredParts() {
    if (S.view !== 'catalog' || S.subView !== 'parts') {
        return null;
    }
    
    // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏–∑ renderMainContent
    let n = [];
    let i = {};
    let l = "–í—Å–µ –¥–µ—Ç–∞–ª–∏";
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (S.selCatId) {
        const cat = flatCategories.find(c => c.id === S.selCatId);
        if (cat) {
            n = S.catGroups[cat.name] || [];
            l = cat.name;
        }
    } else {
        // –í—Å–µ –¥–µ—Ç–∞–ª–∏
        n = Object.values(PART_MAP);
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ n –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏
    if (n.length === 0 && S.catGroups && Object.keys(S.catGroups).length > 0) {
        i = S.catGroups;
        n = Object.values(i).flat();
        l = "–í—Å–µ –¥–µ—Ç–∞–ª–∏";
    }
    
    // –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ ¬´–í—Å–µ –¥–µ—Ç–∞–ª–∏¬ª
    if (S.filters) {
        // –¢–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        if (S.filters.inCollectionOnly) {
            n = n.filter(p => S.coll[p.id] && Object.keys(S.coll[p.id]).length > 0);
        }
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ü–≤–µ—Ç—É (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ü–≤–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ)
        if (S.filters.colorIds && S.filters.colorIds.length === 1) {
            const colorSet = getPartsWithColorSet(S.filters.colorIds[0]);
            if (colorSet.size > 0) {
                n = n.filter(p => colorSet.has(String(p.id)));
            } else {
                n = [];
            }
        } else if (S.filters.colorIds && S.filters.colorIds.length > 1) {
            n = [];
        }
    }
    
    // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞—Ü–∏–∏
    i = groupParts(n);
    const r = i ? Object.keys(i) : [];
    const t = r.map(gid => pickBestPartVariantForCard(i[gid])).filter(Boolean);
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
    if (S.sortBy) {
        switch (S.sortBy) {
            case "alpha_asc":
                t.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'en'));
                break;
            case "alpha_desc":
                t.sort((a, b) => (b.name || '').localeCompare(a.name || '', 'en'));
                break;
            case "popularity":
                t.sort((a, b) => (b.num_sets || 0) - (a.num_sets || 0));
                break;
        }
    }
    
    return t;
}

function renderMainContent() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if (window.UI_BLOCKED) {
        console.log('üö´ renderMainContent blocked by global flag');
        return;
    }
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –≤—ã–∑–æ–≤–æ–≤
    if (window.renderingMainContent) {
        console.log('‚ö†Ô∏è renderMainContent already running, skipping');
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        setTimeout(() => {
            window.renderingMainContent = false;
        }, 50);
        return;
    }
    
    window.renderingMainContent = true;
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
    setTimeout(() => {
        if (window.renderingMainContent) {
            console.log('‚ö†Ô∏è Force reset renderingMainContent flag after timeout');
            window.renderingMainContent = false;
        }
    }, 5000);
    
    let e = "";
    
    // –û—Ç–ª–∞–¥–æ—á–Ω—ã–µ –ª–æ–≥–∏ —É–¥–∞–ª–µ–Ω—ã –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è —à—É–º–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏
    
    // –û—Ç–ª–∞–¥–∫–∞ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞
    
    if (S.view === 'tools' && S.toolSubView === 'analytics' && S.analyticsSubView === 'dashboard') {
    }
    
    
    if (S.loading) {
        e = '<div class="flex flex-col items-center justify-center h-full p-8 text-center"><div class="loader"></div><p class="mt-4 text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>';
    } else if (S.err) {
        e = `<div class="flex flex-col items-center justify-center h-full p-8 text-center text-red-400"><p class="font-semibold">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞</p><p class="text-sm mt-2">${S.err}</p></div>`;
    } else if ("catalog" === S.view) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        if (S.showUniversalSearch && S.universalSearchResults) {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            const { parts, sets, minifigs } = S.universalSearchResults;
            const totalResults = parts.length + sets.length + minifigs.length;
            S.totalItems = totalResults;
            S.loadedItems = totalResults; // –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å—Ä–∞–∑—É
            e = renderUniversalSearchResults(S.universalSearchResults, S.universalSearchTerm);
        } else {
            let t, o, l, a = "sets-minifigs-grid";
            
            if ("parts" === S.subView) {
                let i = {};
                l = "–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏, –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –ø–æ–∏—Å–∫–æ–º";
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (!S.catGroups && !S.searchGroups && Object.keys(PART_MAP).length > 0) {
                console.log('üîß Initializing parts data for parts subview');
                console.log('üîß Current state - S.q:', S.q, 'S.searchGroups:', S.searchGroups, 'S.catGroups:', S.catGroups, 'window.searchStateReset:', window.searchStateReset);
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –∏—â–µ–º –ø–æ –Ω–µ–º—É
                // –ù–û —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                if (S.q && S.q.trim() && !window.searchStateReset) {
                    console.log('üîç Searching parts for query:', S.q);
                    const searchResults = Object.values(PART_MAP).filter(part => 
                        part.name && part.name.toLowerCase().includes(S.q.toLowerCase()) ||
                        part.part_num && part.part_num.toLowerCase().includes(S.q.toLowerCase())
                    );
                    S.searchGroups = { 'search': searchResults };
                    console.log('üîç Search results for parts:', searchResults.length);
                } else {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 100)
                    const allParts = Object.values(PART_MAP);
                    S.catGroups = { 'default': allParts };
                    console.log('üîß All parts loaded:', allParts.length);
                }
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (—á–∞—Å—Ç–æ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –Ω–∞–±–æ—Ä–∞—Ö) –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            if (S.catGroups && Object.keys(S.catGroups).length > 0) {
                Object.keys(S.catGroups).forEach(key => {
                    if (Array.isArray(S.catGroups[key])) {
                        S.catGroups[key].sort((a, b) => {
                            const popularityA = parseInt(a.num_sets) || 0;
                            const popularityB = parseInt(b.num_sets) || 0;
                            return popularityB - popularityA; // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏
                        });
                    }
                });
                console.log('‚úÖ Parts sorted by popularity, most used first');
            }
            
            if (S.searchGroups && Object.keys(S.searchGroups).length > 0) {
                console.log('üìä Sorting search results by popularity (most used first)');
                Object.keys(S.searchGroups).forEach(key => {
                    if (Array.isArray(S.searchGroups[key])) {
                        S.searchGroups[key].sort((a, b) => {
                            const popularityA = parseInt(a.num_sets) || 0;
                            const popularityB = parseInt(b.num_sets) || 0;
                            return popularityB - popularityA; // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏
                        });
                    }
                });
                console.log('‚úÖ Search results sorted by popularity, most used first');
            }
            
            
            if (S.filters.colorIds?.length > 1) {
                l = '–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Ü–≤–µ—Ç–∞–º –≤ —Ä–µ–∂–∏–º–µ "–ö–∞—Ç–∞–ª–æ–≥" –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω —Ü–≤–µ—Ç –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–≤–æ—é "–ö–æ–ª–ª–µ–∫—Ü–∏—é"';
            } else if (S.searchGroups !== null) {
                i = S.searchGroups;
                l = "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
            } else if (S.selCatId !== null) {
                i = S.catGroups;
                l = "–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç –¥–µ—Ç–∞–ª–µ–π";
            } else {
                // –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ –ø–æ–∏—Å–∫–∞, –Ω–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏
                if (S.catGroups && Object.keys(S.catGroups).length > 0) {
                    i = S.catGroups;
                    l = "–í—Å–µ –¥–µ—Ç–∞–ª–∏";
                }
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –Ω–æ searchGroups –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
            // –ù–û —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –Ω–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ –±—ã–ª–æ –Ω–µ–¥–∞–≤–Ω–µ–≥–æ —Å–±—Ä–æ—Å–∞)
            if (S.q && S.q.trim() && (!S.searchGroups || Object.keys(S.searchGroups).length === 0) && !window.searchStateReset) {
                const searchResults = Object.values(PART_MAP).filter(part => 
                    part.name && part.name.toLowerCase().includes(S.q.toLowerCase()) ||
                    part.part_num && part.part_num.toLowerCase().includes(S.q.toLowerCase())
                );
                S.searchGroups = { 'search': searchResults };
                i = S.searchGroups;
                l = searchResults.length > 0 ? `–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –¥–ª—è "${S.q}" (${searchResults.length})` : "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ";
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è, –Ω–æ catGroups –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
            if (S.selCatId && (!S.catGroups || Object.keys(S.catGroups).length === 0)) {
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                // –ü–æ–∫–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏
                const allParts = Object.values(PART_MAP);
                S.catGroups = { 'category': allParts };
                i = S.catGroups;
                l = `–î–µ—Ç–∞–ª–∏ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (${allParts.length})`;
            }
            
            let n = Object.values(i).flat();
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ i –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏
            if (n.length === 0 && S.catGroups && Object.keys(S.catGroups).length > 0) {
                i = S.catGroups;
                n = Object.values(i).flat();
                l = "–í—Å–µ –¥–µ—Ç–∞–ª–∏";
                console.log('üîß Using all parts from catGroups:', {
                    catGroupsKeys: Object.keys(S.catGroups),
                    totalParts: n.length,
                    firstFew: n.slice(0, 3).map(p => ({id: p.id, name: p.name}))
                });
            }
            
            // –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ ¬´–í—Å–µ –¥–µ—Ç–∞–ª–∏¬ª
            if (S.filters) {
                // –¢–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã, –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                if (S.filters.inCollectionOnly) {
                    n = n.filter(p => S.coll[p.id] && Object.keys(S.coll[p.id]).length > 0);
                }
                // –§–∏–ª—å—Ç—Ä –ø–æ —Ü–≤–µ—Ç—É (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ü–≤–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ)
                if (S.filters.colorIds && S.filters.colorIds.length === 1) {
                    const colorSet = getPartsWithColorSet(S.filters.colorIds[0]);
                    if (colorSet.size > 0) {
                        n = n.filter(p => colorSet.has(String(p.id)));
                    } else {
                        n = [];
                    }
                } else if (S.filters.colorIds && S.filters.colorIds.length > 1) {
                    n = [];
                }
            }
            
            console.log('üìä Parts after filtering:', {
                nLength: n.length,
                filtersApplied: !!S.filters
            });
            
            // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞—Ü–∏–∏
            i = groupParts(n);
            const r = i ? Object.keys(i) : [];
            t = r.map(gid => pickBestPartVariantForCard(i[gid])).filter(Boolean);
            
            console.log('üìä Parts final result:', {
                iKeys: Object.keys(i),
                rLength: r.length,
                tLength: t?.length || 0,
                toDisplay: S.toDisplay,
                hasMoreItems: S.hasMoreItems,
                firstFewParts: t?.slice(0, 3).map(p => ({id: p.id, name: p.name})) || []
            });
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∫ –∫–∞—Ä—Ç–æ—á–∫–∞–º –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–π –≤–∞—Ä–∏–∞—Ü–∏–∏
            if (S.sortBy) {
                switch (S.sortBy) {
                    case "alpha_asc":
                        t.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'en'));
                        break;
                    case "alpha_desc":
                        t.sort((a, b) => (b.name || '').localeCompare(a.name || '', 'en'));
                        break;
                    case "popularity":
                        t.sort((a, b) => (b.num_sets || 0) - (a.num_sets || 0));
                        break;
                }
            }
            o = e => {
                const t = Object.values(S.coll[e.id] || {}).reduce((e, t) => e + t, 0);
                return renderPartCard(e, null, t, S.gridStale);
            }, a = "parts-grid";
        } else if ("sets" === S.subView) {
            console.log('Sets subview, selFigNum:', S.selFigNum, 'q:', S.q, 'view:', S.view);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (!S.setRes && !S.searchSetRes && Object.keys(SET_MAP).length > 0) {
                console.log('üîß Initializing sets data for sets subview');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –Ω–∞–±–æ—Ä—ã –∏–ª–∏ –Ω–∞–±–æ—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (S.q && S.q.trim()) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –∏—â–µ–º –ø–æ –Ω–µ–º—É
                    const searchResults = Object.values(SET_MAP).filter(set => 
                        set.name && set.name.toLowerCase().includes(S.q.toLowerCase()) ||
                        set.set_num && set.set_num.toLowerCase().includes(S.q.toLowerCase())
                    );
                    S.searchSetRes = searchResults;
                    console.log('üîç Search results for sets:', searchResults.length);
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –¥–æ—Å—Ç—É–ø–Ω—ã–µ –Ω–∞–±–æ—Ä—ã (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 100)
                    const allSets = Object.values(SET_MAP);
                    S.setRes = allSets;
                    console.log('üì¶ All sets loaded:', allSets.length);
                }
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –Ω–∞–±–æ—Ä—ã –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏) –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            if (S.setRes && Array.isArray(S.setRes)) {
                console.log('üìÖ Sorting sets by year (newest first)');
                S.setRes.sort((a, b) => {
                    const yearA = parseInt(a.year) || 0;
                    const yearB = parseInt(b.year) || 0;
                    return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
                });
                console.log('‚úÖ Sets sorted by year, newest first');
            }
            
            if (S.searchSetRes && Array.isArray(S.searchSetRes)) {
                console.log('üìÖ Sorting search results by year (newest first)');
                S.searchSetRes.sort((a, b) => {
                    const yearA = parseInt(a.year) || 0;
                    const yearB = parseInt(b.year) || 0;
                    return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
                });
                console.log('‚úÖ Search results sorted by year, newest first');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
            if (S.selFigNum && S.showRelatedSets && !S.q) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
                const relatedSets = getRelatedSetsForMinifig(S.selFigNum);
                console.log('Related sets for minifig:', S.selFigNum, ':', relatedSets);
                if (relatedSets && relatedSets.length > 0) {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                    console.log('üìÖ Sorting related sets by year (newest first)');
                    relatedSets.sort((a, b) => {
                        const yearA = parseInt(a.year) || 0;
                        const yearB = parseInt(b.year) || 0;
                        return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
                    });
                    console.log('‚úÖ Related sets sorted by year, newest first');
                    
                    t = relatedSets;
                    o = e => renderSetCard(e, S.gridStale);
                    l = `–°–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –¥–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ "${MINIFIG_MAP[S.selFigNum]?.name || S.selFigNum}" (${relatedSets.length})`;
                    console.log('Setting t to relatedSets:', t);
                } else {
                    t = S.q ? S.searchSetRes : S.setRes;
                    o = e => renderSetCard(e, S.gridStale);
                    l = S.q ? "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ." : "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞–±–æ—Ä–æ–≤, –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –ø–æ–∏—Å–∫–æ–º";
                    console.log('No related sets found, using default sets');
                }
            } else if (S.selRelatedPartId && S.showRelatedSets && !S.q) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–µ—Ç–∞–ª–∏
                const relatedSets = getRelatedSetsForPart(S.selRelatedPartId);
                if (relatedSets && relatedSets.length > 0) {
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
                    relatedSets.sort((a, b) => {
                        const yearA = parseInt(a.year) || 0;
                        const yearB = parseInt(b.year) || 0;
                        return yearB - yearA;
                    });
                    t = relatedSets;
                    o = e => renderSetCard(e, S.gridStale);
                    const partName = PART_MAP[S.selRelatedPartId]?.name || S.selRelatedPartId;
                    l = `–°–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –¥–ª—è –¥–µ—Ç–∞–ª–∏ "${partName}" (${relatedSets.length})`;
                } else {
                    t = S.q ? S.searchSetRes : S.setRes;
                    o = e => renderSetCard(e, S.gridStale);
                    l = S.q ? "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ." : "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞–±–æ—Ä–æ–≤, –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –ø–æ–∏—Å–∫–æ–º";
                }
            } else {
                // –û–±—ã—á–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–æ–≤
                t = S.q ? S.searchSetRes : S.setRes;
                o = e => renderSetCard(e, S.gridStale);
                l = S.q ? "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ." : "–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω–∞–±–æ—Ä–æ–≤, –∏–ª–∏ –≤–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –ø–æ–∏—Å–∫–æ–º";
                console.log('Using default sets display');
            }
            console.log('Final t value for sets:', t);
        } else {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            if (!S.minifigRes && !S.searchMinifigRes && Object.keys(MINIFIG_MAP).length > 0) {
                console.log('üîß Initializing minifigs data for minifigs subview');
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∏–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (S.q && S.q.trim()) {
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å, –∏—â–µ–º –ø–æ –Ω–µ–º—É
                    const searchResults = Object.values(MINIFIG_MAP).filter(minifig => 
                        minifig.name && minifig.name.toLowerCase().includes(S.q.toLowerCase()) ||
                        minifig.set_num && minifig.set_num.toLowerCase().includes(S.q.toLowerCase())
                    );
                    S.searchMinifigRes = searchResults;
                    console.log('üîç Search results for minifigs:', searchResults.length);
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–∞, –∑–∞–≥—Ä—É–∂–∞–µ–º –í–°–ï –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ (–Ω–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 100)
                    const allMinifigs = Object.values(MINIFIG_MAP);
                    S.minifigRes = allMinifigs;
                    console.log('üë§ All minifigs loaded:', allMinifigs.length);
                }
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏) –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            if (S.minifigRes && Array.isArray(S.minifigRes)) {
                console.log('üìÖ Sorting minifigs by year (newest first)');
                S.minifigRes.sort((a, b) => {
                    const yearA = parseInt(a.year) || 0;
                    const yearB = parseInt(b.year) || 0;
                    return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
                });
                console.log('‚úÖ Minifigs sorted by year, newest first');
            }
            
            if (S.searchMinifigRes && Array.isArray(S.searchMinifigRes)) {
                console.log('üìÖ Sorting minifig search results by year (newest first)');
                S.searchMinifigRes.sort((a, b) => {
                    const yearA = parseInt(a.year) || 0;
                    const yearB = parseInt(b.year) || 0;
                    return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
                });
                console.log('‚úÖ Minifig search results sorted by year, newest first');
            }
            
            t = S.q ? S.searchMinifigRes : S.minifigRes;
            o = e => renderMinifigCard(e, S.gridStale);
            l = S.q ? "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ." : "catalog" === S.view && !S.q ? "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –¥–ª—è –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫" : "–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–µ—Ç –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫.";
        }
        if (!t || 0 === t.length) e = `
                    <div class="flex flex-col items-center justify-center h-full p-4 text-center">
                        ${S.sidebarLoading ? `
                            <div class="flex items-center text-blue-400 text-sm mb-6">
                                <div class="loader !w-6 !h-6 !border-2 mr-3"></div>
                                <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
                            </div>
                        ` : ''}
                        <p class="text-gray-400 max-w-sm mb-6">${l}</p>
                    </div>`;
        else {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º S.toDisplay –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫/–≥—Ä—É–ø–ø
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
            const headerHtml = (S.subView === "sets" && S.selFigNum && S.showRelatedSets && !S.q) ? `
                <div class="px-4 pt-4 pb-2">
                    <div class="flex items-center justify-between bg-gray-800/50 rounded-[18px] p-3 border border-gray-700">
                        <div class="flex items-center gap-3">
                            <span class="text-blue-400">${I_Minifig("w-5 h-5")}</span>
                            <div>
                                <h2 class="text-lg font-semibold text-white">–°–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã</h2>
                                <p class="text-sm text-gray-400">–î–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ "${MINIFIG_MAP[S.selFigNum]?.name || S.selFigNum}"</p>
                            </div>
                        </div>
                        
                        <!-- –ü—Ä–µ–≤—å—é-–∫–∞—Ä—Ç–∏–Ω–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ -->
                        <div class="flex items-center gap-3">
                            <div class="w-16 h-16 bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-md cursor-pointer hover:shadow-lg transition-shadow relative group" 
                                 data-action="open-minifig-preview" 
                                 data-fig-num="${S.selFigNum}"
                                 title="–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏">
                                <img src="${MINIFIG_MAP[S.selFigNum]?.minifig_img_url || MINIFIG_MAP[S.selFigNum]?.set_img_url || `https://cdn.rebrickable.com/media/minifigs/${S.selFigNum}.jpg`}" 
                                     alt="${MINIFIG_MAP[S.selFigNum]?.name || S.selFigNum}" 
                                     class="w-full h-full object-contain"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMzc0MTUxIi8+CjxwYXRoIGQ9Ik0zMiAxNkMyMy4xNjM0IDE2IDE2IDIzLjE2MzQgMTYgMzJDMTYgNDAuODM2NiAyMy4xNjM0IDQ4IDMyIDQ4QzQwLjgzNjYgNDggNDggNDAuODM2NiA0OCAzMkM0OCAyMy4xNjM0IDQwLjgzNjYgMTYgMzIgMTZaIiBmaWxsPSIjNkI3MjgwIi8+CjxwYXRoIGQ9Ik0yNCAyOEgyNEMyMi44OTU1IDI4IDIyIDI4Ljg5NTQgMjIgMzBWMzRIMjZWMzBDMjYgMjguODk1NCAyNS4xMDQ2IDI4IDI0IDI4WiIgZmlsbD0iIzZCNzI4MCIvPgo8cGF0aCBkPSJNMzIgMjhIMzJDMzAuODk1NCAyOCAzMCAyOC44OTU0IDMwIDMwVjM0SDM0VjMwQzM0IDI4Ljg5NTQgMzMuMTA0NiAyOCAzMiAyOFoiIGZpbGw9IiM2QjcyODAiLz4KPHBhdGggZD0iTTI0IDM2SDQwQzQxLjEwNDYgMzYgNDIgMzYuODk1NCA0MiAzOFY0MEg0MlY0MkM0MiA0My4xMDQ2IDQxLjEwNDYgNDQgNDAgNDRIMjRDMjIuODk1NCA0NCAyMiA0My4xMDQ2IDIyIDQyVjQwSDIyVjM4QzIyIDM2Ljg5NTQgMjIuODk1NCAzNiAyNCAzNloiIGZpbGw9IiM2QjcyODAiLz4KPC9zdmc+'">
                                
                                <!-- –ò–∫–æ–Ω–∫–∞ –ª—É–ø—ã –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ -->
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                    <svg class="w-6 h-6 text-white drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            ` : '';

            // –ü–ª–∞—à–∫–∞ –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–µ—Ç–∞–ª–∏
            const headerHtmlPart = (S.subView === "sets" && S.selRelatedPartId && S.showRelatedSets && !S.q) ? `
                <div class="px-4 pt-4 pb-2">
                    <div class="flex items-center justify-between bg-gray-800/50 rounded-[18px] p-3 border border-gray-700">
                        <div class="flex items-center gap-3">
                            <span class="text-blue-400">${I_Brick("w-5 h-5")}</span>
                            <div>
                                <h2 class="text-lg font-semibold text-white">–°–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã</h2>
                                <p class="text-sm text-gray-400">–î–ª—è –¥–µ—Ç–∞–ª–∏ "${(PART_MAP[S.selRelatedPartId]?.name || S.selRelatedPartId)}"</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-16 h-16 bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-md cursor-pointer hover:shadow-lg transition-shadow relative group"
                                 data-action="open-part-preview"
                                 data-part-id="${S.selRelatedPartId}"
                                 title="–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏ –¥–µ—Ç–∞–ª–∏">
                                <img src="${PART_MAP[S.selRelatedPartId]?.rebrickable_img_url || ''}"
                                     alt="${PART_MAP[S.selRelatedPartId]?.name || S.selRelatedPartId}"
                                     class="w-full h-full object-contain"
                                     onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCA2NCA2NCIgZmlsbD0ibm9uZSIgeG1zbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjY0IiBoZWlnaHQ9IjY0IiBmaWxsPSIjMzc0MTUxIi8+CjxwYXRoIGQ9Ik0zMiAxNkMyMy4xNjM0IDE2IDE2IDIzLjE2MzQgMTYgMzJDMTYgNDAuODM2NiAyMy4xNjM0IDQ4IDMyIDQ4QzQwLjgzNjYgNDggNDggNDAuODM2NiA0OCAzMkM0OCAyMy4xNjM0IDQwLjgzNjYgMTYgMzIgMTZaIiBmaWxsPSIjNkI3MjgwIi8+CjxwYXRoIGQ9Ik0yNCAyOEgyNEMyMi44OTU1IDI4IDIyIDI4Ljg5NTQgMjIgMzBWMzRIMjZWMzBDMjYgMjguODk1NCAyNS4xMDQ2IDI4IDI0IDI4WiIgZmlsbD0iIzZCNzI4MCIvPgo8cGF0aCBkPSJNMzIgMjhIMzJDMzAuODk1NCAyOCAzMCAyOC44OTU0IDMwIDMwVjM0SDM0VjMwQzM0IDI4Ljg5NTQgMzMuMTA0NiAyOCAzMiAyOFoiIGZpbGw9IiM2QjcyODAiLz4KPHBhdGggZD0iTTI0IDM2SDQwQzQxLjEwNDYgMzYgNDIgMzYuODk1NCA0MiAzOFY0MEg0MlY0MkM0MiA0My4xMDQ2IDQxLjEwNDYgNDQgNDAgNDRIMjRDMjIuODk1NCA0NCAyMiA0My4xMDQ2IDIyIDQyVjQwSDIyVjM4QzIyIDM2Ljg5NTQgMjIuODk1NCAzNiAyNCAzNloiIGZpbGw9IiM2QjcyODAiLz4KPC9zdmc+'">
                                <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-30 transition-all duration-200 flex items-center justify-center opacity-0 group-hover:opacity-100">
                                    <svg class="w-6 h-6 text-white drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            ` : '';

            // –ö–∞—Ç–∞–ª–æ–≥ (sets/minifigs) —Ä–µ–Ω–¥–µ—Ä–∏–º –∫–∞–∫ —Ä–∞–Ω—å—à–µ, –∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤–∫–ª—é—á–∞–µ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ –∏–º–µ–Ω–∏
            console.log('üîç renderMainContent debug:', {
                view: S.view,
                subView: S.subView,
                tType: typeof t,
                tLength: t?.length,
                tIsArray: Array.isArray(t),
                toDisplay: S.toDisplay
            });
            
            if (S.view === 'catalog' || S.subView !== 'parts') {
                // –°—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ª–∏–º–∏—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                console.log('üìä Setting hasMoreItems for non-parts view:', {
                    tLength: t?.length || 0,
                    toDisplay: S.toDisplay,
                    t: t,
                    subView: S.subView,
                    view: S.view
                });
                
                // –ó–∞—â–∏—Ç–∞ –æ—Ç null/undefined –∑–Ω–∞—á–µ–Ω–∏–π
                if (!t || !Array.isArray(t)) {
                    console.log('‚ö†Ô∏è t is not a valid array, setting hasMoreItems to false');
                    S.hasMoreItems = false;
                    S.totalItems = 0;
                    S.loadedItems = 0;
                } else {
                    S.hasMoreItems = t.length > S.toDisplay;
                    S.totalItems = t.length;
                    const shown = t.slice(0, S.toDisplay);
                    S.loadedItems = shown.length;
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
                    if (S.subView === 'parts') {
                        console.log('üîß Parts pagination debug:', {
                            view: S.view,
                            totalParts: t.length,
                            toDisplay: S.toDisplay,
                            hasMoreItems: S.hasMoreItems,
                            shownCount: shown.length,
                            remaining: t.length - shown.length
                        });
                    }
                }
                
                console.log('üìä Catalog view stats:', {
                    hasMoreItems: S.hasMoreItems,
                    totalItems: S.totalItems,
                    loadedItems: S.loadedItems,
                    toDisplay: S.toDisplay,
                    subView: S.subView
                });
                
                if (S.hasMoreItems) {
                    console.log('‚úÖ Will show more items button or auto-load');
                } else {
                    console.log('‚ùå No more items to load');
                }
                
                const shown = t ? t.slice(0, S.toDisplay) : [];
                const header = headerHtml || headerHtmlPart;
                e = `${header}<div class="grid ${a} gap-4 p-4">${shown.map((e,t)=>{const l=o(e,true,t);return l.replace('class=\"part-card ',`style=\"${S.getAnimationDelay(t)}\" class=\"part-card `).replace('class=\"set-card ',`style=\"${S.getAnimationDelay(t)}\" class=\"set-card `).replace('class=\"minifig-card ',`style=\"${S.getAnimationDelay(t)}\" class=\"minifig-card `)}).join("")}</div>`;
            } else {
                // –ù–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–µ—Ç–∞–ª–µ–π –ø–æ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é
                const groups = groupCollectionPartsByName(t);
                S.hasMoreItems = groups.length > S.toDisplay;
                S.totalItems = groups.length;
                const shownGroups = groups.slice(0, S.toDisplay);
                S.loadedItems = shownGroups.length;
                const groupsHtml = shownGroups.map((g, idx) => renderCollectionNameGroup(g, idx)).join("");
                e = `${headerHtml}<div class="space-y-3 p-4">${groupsHtml}</div>`;
            }

            // –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ" —É–±—Ä–∞–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ-–¥–æ–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
        }
        }
    } else {
        let t, o, l = `–í –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–µ—Ç ${"parts"===S.subView?"–¥–µ—Ç–∞–ª–µ–π":"sets"===S.subView?"–Ω–∞–±–æ—Ä–æ–≤":"–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫"}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥`,
            i = S.q.trim().toLowerCase(),
            n = "grid-cols-[repeat(auto-fill,minmax(150px,1fr))]";
        if ("parts" === S.subView) {
            const e = [];
            for (const t in S.coll)
                for (const o in S.coll[t]) {
                    const l = PART_MAP[t],
                        a = COLOR_MAP[o],
                        i = S.coll[t][o];
                    if (l && a && i > 0) {
                        e.push({
                            part: l,
                            color: a,
                            quantity: i
                        });
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                        if (!l.name || !l.part_img_url) {
                            fetchMissingCollectionPartDetails().catch(console.error);
                        }
                    }
                }
            let filteredParts = e;
            S.selCollCatId && (filteredParts = e.filter(({
                part: e
            }) => PART_MAP[e.id]?.categoryId === S.selCollCatId));
            S.filters.colorIds?.length > 0 && (filteredParts = e.filter(e => S.filters.colorIds.includes(e.color.id)));
            i && (filteredParts = e.filter(({
                part: e
            }) => e.name.toLowerCase().includes(i) || e.id.toLowerCase().includes(i)));
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
            if (S.tempRarityFilter) {
                filteredParts = filteredParts.filter(({part, color}) => 
                    calculatePartRarity(part.id, color.id) === S.tempRarityFilter
                );
            }
            
            if (S.tempColorFilter) {
                filteredParts = filteredParts.filter(({color}) => 
                    color.id === S.tempColorFilter
                );
            }
            
            // tempCategoryFilter —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ S.selCollCatId
            
            t = filteredParts;
            switch (S.sortBy) {
                case "alpha_asc":
                    t.sort((e, t) => e.part.name.localeCompare(t.part.name, 'en'));
                    break;
                case "alpha_desc":
                    t.sort((e, t) => t.part.name.localeCompare(e.part.name, 'en'));
                    break;
                case "quantity_desc":
                    t.sort((a, b) => b.quantity - a.quantity);
                    break;
                case "quantity_asc":
                    t.sort((a, b) => a.quantity - b.quantity);
                    break;
                case "popularity":
                    t.sort((e, t) => (PART_MAP[t.part.id]?.num_sets || 0) - (PART_MAP[e.part.id]?.num_sets || 0))
                    break;
                case "popular":
                    t.sort((e, t) => (PART_MAP[t.part.id]?.num_sets || 0) - (PART_MAP[e.part.id]?.num_sets || 0))
            }
            o = (e, t, o) => renderPartCard(e.part, e.color, e.quantity, t, o);
            n = "parts-grid";
        } else if ("sets" === S.subView) {
            let sets = Object.keys(S.setColl).map(e => SET_MAP[e]).filter(Boolean);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–µ—Ç–∞–ª–∏ –Ω–∞–±–æ—Ä–∞ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            sets.forEach(set => {
                if (!set.name || !set.set_img_url) {
                    fetchMissingCollectionSetDetails().catch(console.error);
                }
            });
            
            if (S.selCollThemeId) {
                const getAllChildThemeIds = (themeId) => {
                    const theme = THEME_MAP[themeId];
                    if (!theme) return [];
                    let ids = [theme.id];
                    if (Array.isArray(theme.children)) {
                        theme.children.forEach(child => {
                            ids = ids.concat(getAllChildThemeIds(child.id));
                        });
                    }
                    return ids;
                };
                const allowedThemeIds = getAllChildThemeIds(S.selCollThemeId);
                sets = sets.filter(set => set && allowedThemeIds.includes(set.theme_id));
            }
            i && (sets = sets.filter(e => e.name.toLowerCase().includes(i) || e.set_num.toLowerCase().includes(i)));

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –≥–æ–¥–∞–º –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            if (S.setFilters) {
                const { minYear, maxYear, minParts, maxParts } = S.setFilters;
                if (minYear && minYear.trim() !== '') {
                    const v = parseInt(minYear);
                    if (!isNaN(v)) sets = sets.filter(s => s.year && s.year >= v);
                }
                if (maxYear && maxYear.trim() !== '') {
                    const v = parseInt(maxYear);
                    if (!isNaN(v)) sets = sets.filter(s => s.year && s.year <= v);
                }
                if (minParts && minParts.trim() !== '') {
                    const v = parseInt(minParts);
                    if (!isNaN(v)) sets = sets.filter(s => s.num_parts && s.num_parts >= v);
                }
                if (maxParts && maxParts.trim() !== '') {
                    const v = parseInt(maxParts);
                    if (!isNaN(v)) sets = sets.filter(s => s.num_parts && s.num_parts <= v);
                }
            }
            t = sets;
            switch (S.sortBy) {
                case "alpha_asc":
                    t.sort((e, t) => e.name.localeCompare(t.name, 'en'));
                    break;
                case "alpha_desc":
                    t.sort((e, t) => t.name.localeCompare(e.name, 'en'));
                    break;
                case "year_asc":
                    t.sort((e, t) => e.year - t.year);
                    break;
                case "year_desc":
                    t.sort((e, t) => t.year - e.year);
                    break;
                case "parts_asc":
                    t.sort((e, t) => e.num_parts - t.num_parts);
                    break;
                case "parts_desc":
                    t.sort((e, t) => t.num_parts - e.num_parts)
            }
            o = (e, t, o) => renderSetCard(e, t, o);
            n = "sets-minifigs-grid";
        } else {
            let minifigs = Object.keys(S.minifigColl).map(e => MINIFIG_MAP[e]).filter(Boolean);
            i && (minifigs = minifigs.filter(e => e.name.toLowerCase().includes(i) || e.set_num.toLowerCase().includes(i)));
            t = minifigs;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            minifigs.forEach(minifig => {
                if (!minifig.name || !minifig.minifig_img_url) {
                    fetchMinifigDetails(minifig.set_num).catch(console.error);
                }
            });
            
            switch (S.sortBy) {
                case "name_asc":
                    t.sort((e, t) => e.name.localeCompare(t.name, 'en'));
                    break;
                case "name_desc":
                    t.sort((e, t) => t.name.localeCompare(e.name, 'en'));
                    break;
                case "num_parts_desc":
                    t.sort((e, t) => t.num_parts - e.num_parts);
                    break;
                case "num_parts_asc":
                    t.sort((e, t) => e.num_parts - e.num_parts)
            }
            o = (e, t, o) => renderMinifigCard(e, t, o);
            n = "sets-minifigs-grid";
        }
        if (t.length === 0) {
            (i || "parts"===S.subView && (S.filters.colorIds.length > 0 || S.selCollCatId) || "sets" === S.subView && S.selCollThemeId) && (l += ", —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å—Ç—Ä–∞–º");
            e = `<div class="flex flex-col items-center justify-center h-full p-4 text-center">
                    ${S.sidebarLoading ? `
                        <div class="flex items-center text-blue-400 text-sm mb-6">
                            <div class="loader !w-6 !h-6 !border-2 mr-3"></div>
                            <span>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</span>
                        </div>
                    ` : ''}
                    <div class="mb-6">
                        <div class="w-20 h-20 mx-auto text-gray-400 mb-4 bg-gradient-to-br from-gray-700/30 to-gray-800/30 rounded-full flex items-center justify-center border border-gray-600/20">
                            ${"parts"===S.subView?I_Brick('w-10 h-10'):"sets"===S.subView?I_Set('w-10 h-10'):I_Minifig('w-10 h-10')}
                        </div>
                        <h3 class="text-xl font-semibold text-gray-200 mb-3">${l}</h3>
                        <p class="text-gray-400 text-base mb-4 max-w-md mx-auto leading-relaxed">–î–æ–±–∞–≤–ª—è–π—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ —á—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Å–≤–æ—é –∫–æ–ª–ª–µ–∫—Ü–∏—é</p>
                        <div class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500/10 border border-blue-500/30 rounded-[18px] text-blue-400 text-sm font-medium">
                            <span>üí°</span>
                            <span>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞—Ç–∞–ª–æ–≥</span>
                        </div>
                    </div>
                </div>`;
        } else {
            // –î–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π –≤–∫–ª—é—á–∞–µ–º –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
            if (S.subView === 'parts') {
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å–ø–∏—Å–æ–∫ –≤ —Å–º–µ—Å—å –æ–¥–∏–Ω–æ—á–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –∏ –ø–∞–ø–æ–∫ –ø–æ —É—Å–ª–æ–≤–∏—é (>1 —Ü–≤–µ—Ç–∞)
                const display = groupCollectionPartsForDisplay(t);
                S.hasMoreItems = display.length > S.toDisplay;
                S.totalItems = display.length;
                const shown = display.slice(0, S.toDisplay);
                S.loadedItems = shown.length;
                if (!S.expandedFolders) S.expandedFolders = new Set();
                const html = shown.map((d, idx) => {
                    if (d.type === 'folder') {
                        const base = renderCollectionFolderCard(d.part, d.colors)
                            .replace('class="part-card ', `style="${S.getAnimationDelay(idx)}" class="part-card `);
                        // –ï—Å–ª–∏ –ø–∞–ø–∫–∞ —Ä–∞—Å–∫—Ä—ã—Ç–∞ ‚Äî –æ—Ç—Ä–∏—Å—É–µ–º –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Å–∏–Ω–µ–π —Ä–∞–º–∫–æ–π –≤–æ–∫—Ä—É–≥ –ø–∞–ø–∫–∏ –∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ü–≤–µ—Ç–æ–≤
                        if (S.expandedFolders.has(String(d.part.id))) {
                            const baseNoRing = base.replace(' ring-2 ring-blue-500 ', ' ');
                            const colorCardsWrapped = d.colors.map(ci => {
                                const entry = { part: d.part, color: ci.color, quantity: (S.coll?.[d.part.id]?.[String(ci.color?.id)] || 0) };
                                const html = o(entry, true, idx + 1);
                                return html;
                            }).join("");
                            return `
                                <div class="part-folder-group-container" style="grid-column: 1 / -1;">
                                    <div class="border-2 border-blue-500 rounded-[18px] p-6 shadow-2xl shadow-blue-500/30 bg-blue-50/10 backdrop-blur-sm relative">
                                        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ø–∫–∏ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ -->
                                        <button data-action="close-folder" data-part-id="${d.part.id}" class="absolute top-2 right-2 bg-red-600 hover:bg-red-700 text-white rounded-full w-6 h-6 flex items-center justify-center z-20 shadow-lg hover:shadow-red-500/25 transition-all duration-200 hover:scale-110" title="–ó–∞–∫—Ä—ã—Ç—å –ø–∞–ø–∫—É">
                                            ${I_X('w-4 h-4')}
                                        </button>
                                        
                                        <div class="folder-grid">
                                            <div class="transform scale-105 transition-transform duration-200">${baseNoRing}</div>
                                            ${colorCardsWrapped}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        return base;
                    }
                    // –æ–¥–∏–Ω–æ—á–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏: —Å—Ä–∞–∑—É –æ–±—ã—á–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª–∫—É –¥–µ—Ç–∞–ª–∏)
                    return o(d.entry, true, idx);
                }).join("");
                e = `<div class="${n} p-4">${html}</div>`;
            } else {
                // –°–µ—Ç–∫–∏ –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
                S.hasMoreItems = t.length > S.toDisplay;
                S.totalItems = t.length;
                const shown = t.slice(0, S.toDisplay);
                S.loadedItems = shown.length;
                e = `<div class="${n} p-4">${shown.map((e,t)=>o(e,true,t)).join("")}</div>`;
            }
            // –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ" —É–±—Ä–∞–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ-–¥–æ–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
        }
    } 
    if ("tools" === S.view) {
        console.log('üîß Rendering tools main content, toolSubView:', S.toolSubView);
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –µ—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø–æ–¥—Ä–∞–∑–¥–µ–ª
        if (!S.toolSubView || S.toolSubView === '') {
            e = `
                <div class="flex flex-col items-center justify-center h-full p-4 sm:p-8 xl:p-12 text-center">
                    <div class="mb-3 sm:mb-4 xl:mb-6">
                        <div class="w-16 h-16 sm:w-20 sm:h-20 xl:w-24 xl:h-24 mx-auto text-blue-400">${I_Toolbox('w-full h-full')}</div>
                    </div>
                    <h2 class="text-xl sm:text-2xl xl:text-3xl font-bold text-gray-200 mb-2 xl:mb-4">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h2>
                    <p class="text-gray-400 mb-4 xl:mb-6 text-sm sm:text-base xl:text-lg px-4 xl:px-8 max-w-md xl:max-w-lg">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
                </div>
            `;
        } else {
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            if (S.toolSubView === 'analytics') {
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
            if (!S.analyticsLoading) {
                console.log('üìä –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏...', {
                    hasData: !!S.analyticsData,
                    collectionUpdated: S.collectionLastUpdate,
                    analyticsUpdated: S.analyticsLastUpdate
                });
                analyzeCollection();
            }
        } else if (S.toolSubView === 'cloud-backup') {
            // –õ–æ–≥–∏–∫–∞ –¥–ª—è –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
            e = renderCloudBackupContent();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—â–µ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
            if (!cloudStorageConnected && window.remoteStorageAvailable) {
                setTimeout(() => {
                    checkSavedCloudStorageState();
                }, 200);
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ, –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã
            if (cloudStorageConnected && window.remoteStorageAvailable) {
                debouncedLoadBackupsList(true, 300); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–µ
            }
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–∫–∏ –∂–µ–ª–∞–Ω–∏–π —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 'wishlist'
        if (S.toolSubView === 'wishlist') {
            e = renderWishlistContent();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            initWishlistMultiselect();
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 'scanner'
        if (S.toolSubView === 'scanner') {
            e = renderScannerContent();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫–∞–Ω–µ—Ä –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            setTimeout(initScannerOnViewChange, 100);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π –ø–æ —Ñ–æ—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 'photo-search'
        if (S.toolSubView === 'photo-search') {
            e = renderPhotoSearchContent();
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
            setTimeout(initPhotoSearchOnViewChange, 100);
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ 'analytics'
        if (S.toolSubView === 'analytics') {
            if (S.analyticsLoading) {
                e = `
                    <div class="flex flex-col items-center justify-center h-full p-8 text-center">
                        <div class="loader mb-4"></div>
                        <h2 class="text-2xl font-bold text-gray-200 mb-2">–ê–Ω–∞–ª–∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</h2>
                        <p class="text-gray-400">–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–¥–∫–æ—Å—Ç—å –¥–µ—Ç–∞–ª–µ–π –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...</p>
                    </div>
                `;
            } else if (S.analyticsData) {
                e = renderAnalyticsContent(S.analyticsData);
            } else {
                e = `
                    <div class="flex flex-col items-center justify-center h-full p-4 sm:p-8 xl:p-12 text-center">
                        <div class="mb-3 sm:mb-4 xl:mb-6">
                            <div class="w-16 h-16 sm:w-20 sm:h-20 xl:w-24 xl:h-24 mx-auto text-blue-400">${I_Analytics('w-full h-full')}</div>
                        </div>
                        <h2 class="text-xl sm:text-2xl xl:text-3xl font-bold text-gray-200 mb-2 xl:mb-4">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
                        <p class="text-gray-400 mb-4 xl:mb-6 text-sm sm:text-base xl:text-lg px-4 xl:px-8 max-w-md xl:max-w-lg">–î–æ–±–∞–≤—å—Ç–µ –¥–µ—Ç–∞–ª–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É</p>
                    </div>
                `;
            }
        }
        }
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –µ—Å–ª–∏ —ç—Ç–æ —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ
    if (S.view === 'catalog' && S.subView === 'parts' && window.isIncrementalUpdate) {
        // –ù–∞—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
        const gridContainer = mainEl.querySelector('.grid');
        if (gridContainer) {
            // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            const existingCards = gridContainer.querySelectorAll('.part-card').length;
            const newCardsCount = S.toDisplay - existingCards;
            
            if (newCardsCount > 0) {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–∑ —É–∂–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const t = getCurrentFilteredParts();
                const newCards = t ? t.slice(existingCards, S.toDisplay) : [];
                
                // –†–µ–Ω–¥–µ—Ä–∏–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                const newCardsHtml = newCards.map((item, index) => {
                    const cardHtml = renderPartCard(item, null, 0, false, existingCards + index);
                    return cardHtml.replace('class="part-card ', `style="${S.getAnimationDelay(existingCards + index)}" class="part-card `);
                }).join("");
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
                gridContainer.insertAdjacentHTML('beforeend', newCardsHtml);
                console.log(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${newCardsCount} –Ω–æ–≤—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ`);
            }
        } else {
            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–µ—Ç, —Ä–µ–Ω–¥–µ—Ä–∏–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
            mainEl.innerHTML = renderAppliedFilters() + e;
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        window.isIncrementalUpdate = false;
    } else {
        // –û–±—ã—á–Ω–æ–µ –ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        mainEl.innerHTML = renderAppliedFilters() + e;
    }
    
    
    // –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, —Ç.–∫. —Ä–∞–∑–º–µ—Ä—ã –º–æ–≥–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è
    if (typeof window.refreshScrollProgress === 'function') {
        try { window.refreshScrollProgress(); } catch {}
    }
    // –ò –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–µ–∫–∞, –µ—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ —à–∞–ø–∫–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
    (function(){
        const track = document.getElementById('scroll-progress');
        const header = document.getElementById('header-container');
        if (track) {
            const headerHeight = header?.offsetHeight || 0;
            const top = Math.max(12, headerHeight + 8);
            track.style.top = top + 'px';
            track.style.bottom = '12px';
        }
    })();
            S.gridStale = !1;
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
        if (document.body.classList.contains('tab-switching')) {
            setTimeout(() => {
                document.body.classList.remove('tab-switching');
            }, 200);
        }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞—Ç—å –±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –µ—Å–ª–∏ –Ω–µ—Ç –ø–æ–ª–æ—Å—ã –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    requestAnimationFrame(() => {
        if (!S.loading && S.hasMoreItems && mainEl.scrollHeight <= mainEl.clientHeight) {
            S.toDisplay += S.increment;
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ renderMainContent –≤–º–µ—Å—Ç–æ updateUI –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∑–∞—â–∏—Ç—É –æ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
            if (!window.renderingMainContent) {
                renderMainContent();
            } else {
                console.log('‚ö†Ô∏è Skipping renderMainContent call to prevent infinite loop');
            }
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—Å–ª–µ –∞–≤—Ç–æ–ø–æ–¥–≥—Ä—É–∑–∫–∏/–ø—Ä–æ–≤–µ—Ä–∫–∏
        if (typeof window.refreshScrollProgress === 'function') {
            try { window.refreshScrollProgress(); } catch {}
        }
    });
    
    // –£–±—Ä–∞–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π UI
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    window.renderingMainContent = false;
}
// –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
function setupScrollListener() {
    console.log('üîß setupScrollListener called, mainEl:', mainEl);
    
    if (mainEl.hasAttribute('data-scroll-listener')) {
        console.log('‚ö†Ô∏è Scroll listener already set up, skipping');
        return; // –£–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
    }
    
    mainEl.setAttribute('data-scroll-listener', 'true');
    console.log('‚úÖ Scroll listener attribute set');
    
    let scrollTimeout;
    let lastLoadTime = 0;
    let lastScrollTop = 0;
    const minLoadInterval = 500; // –ú–∏–Ω–∏–º—É–º 500ms –º–µ–∂–¥—É –∑–∞–≥—Ä—É–∑–∫–∞–º–∏
    const fastScrollThreshold = 100; // –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –µ—Å–ª–∏ –±–æ–ª—å—à–µ 100px –∑–∞ —Ä–∞–∑
    
    mainEl.addEventListener('scroll', () => {
        clearTimeout(scrollTimeout);
        
        scrollTimeout = setTimeout(() => {
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            if (S.view !== 'catalog' && S.view !== 'collection') {
                console.log('üìú Scroll detected but not in catalog or collection view:', S.view);
                return;
            }
            
            // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            if (S.subView === 'parts') {
                console.log('üìú Scroll detected in parts view:', {
                    view: S.view,
                    toDisplay: S.toDisplay,
                    hasMoreItems: S.hasMoreItems,
                    loading: S.loading
                });
            }
            
            const scrollTop = mainEl.scrollTop;
            const scrollHeight = mainEl.scrollHeight;
            const clientHeight = mainEl.clientHeight;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–±–ª–∏–∂–∞–µ–º—Å—è –ª–∏ –º—ã –∫ –∫–æ–Ω—Ü—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞)
            const isNearBottom = scrollTop + clientHeight >= scrollHeight - 300; // 300px –æ—Ç –∫–æ–Ω—Ü–∞ –¥–ª—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±—ã—Å—Ç—Ä—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
            const scrollDelta = Math.abs(scrollTop - lastScrollTop);
            const isFastScroll = scrollDelta > fastScrollThreshold;
            lastScrollTop = scrollTop;
            
            if ((isNearBottom || isFastScroll) && !S.loading && S.hasMoreItems) {
                const now = Date.now();
                if (now - lastLoadTime < minLoadInterval) {
                    console.log('‚è±Ô∏è Too soon to load more items, skipping');
                    return;
                }
                
                lastLoadTime = now;
                console.log('üìú Auto-loading more items on scroll...', {
                    current: S.toDisplay,
                    increment: S.increment,
                    hasMore: S.hasMoreItems,
                    scrollTop,
                    scrollHeight,
                    clientHeight,
                    subView: S.subView,
                    totalItems: S.totalItems,
                    loadedItems: S.loadedItems,
                    willShow: S.toDisplay + (S.increment * 2),
                    isNearBottom,
                    isFastScroll,
                    scrollDelta
                });
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø—Ä–µ–≤—ã—à–∞–µ–º –ª–∏ –º—ã –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                if (S.totalItems && S.toDisplay >= S.totalItems) {
                    console.log('‚ö†Ô∏è Already showing all items, skipping auto-load');
                    S.hasMoreItems = false;
                    return;
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
                if (S.subView === 'parts' && S.totalItems && S.toDisplay >= S.totalItems) {
                    console.log('‚ö†Ô∏è Parts: Already showing all items, skipping auto-load');
                    S.hasMoreItems = false;
                    return;
                }
                
                // –ó–∞—â–∏—Ç–∞ –æ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∏—è
                if (S.toDisplay > 10000) {
                    console.log('‚ö†Ô∏è toDisplay too high, stopping auto-load');
                    S.hasMoreItems = false;
                    return;
                }
                
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–∞–µ–º—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                const loadAmount = S.increment; // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ 100 –∫–∞—Ä—Ç–æ—á–µ–∫
                S.toDisplay += loadAmount;
                S.gridStale = true;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
                window.isIncrementalUpdate = true;
                
                console.log('üîÑ Calling updateUI from scroll listener, new toDisplay:', S.toDisplay);
                console.log('üîÑ Parts pagination after increment:', {
                    toDisplay: S.toDisplay,
                    totalItems: S.totalItems,
                    hasMoreItems: S.hasMoreItems,
                    subView: S.subView
                });
                updateUI();
            }
        }, 100); // –ó–∞–¥–µ—Ä–∂–∫–∞ 100ms –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    }, { passive: true });
    
    console.log('‚úÖ Scroll listener added successfully');
    console.log('üîß Scroll listener setup complete for:', {
        view: S.view,
        subView: S.subView,
        toDisplay: S.toDisplay,
        hasMoreItems: S.hasMoreItems
    });
}

function renderSetCollectionControls() {
    if (!S.selSetNum) return "";
    const {
        qty: e
    } = S.setModal, t = S.setColl[S.selSetNum]?.qty || 0;
    return `
            <div class="bg-gray-700/50 rounded-[18px] p-3 sm:p-4 md:p-3 lg:p-4 xl:p-5">
                <div class="space-y-3 sm:space-y-4 md:space-y-3 lg:space-y-4">
                    <!-- Header -->
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-3">
                        <h3 class="text-sm sm:text-base md:text-base lg:text-lg font-semibold text-white flex items-center justify-between w-full gap-2 sm:gap-3">
                            <div class="flex items-center gap-2 sm:gap-3">
                                ${I_Set("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5 text-blue-400")}
                                <span class="hidden sm:inline">–ö–æ–ª–ª–µ–∫—Ü–∏—è –Ω–∞–±–æ—Ä–æ–≤</span>
                                <span class="sm:hidden">–ö–æ–ª–ª–µ–∫—Ü–∏—è</span>
                            </div>
                            <span class="text-xs sm:text-sm md:text-sm lg:text-base text-gray-400">
                                (–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏: <span id="set-modal-in-collection-qty" class="font-bold text-white">${t}</span>)
                            </span>
                        </h3>
                    </div>
                    
                    <!-- Controls -->
                    <div class="flex flex-col gap-3 sm:gap-4">
                        <!-- Quantity Controls -->
                        <div class="flex items-center justify-center gap-2 sm:gap-3">
                            <button data-action="decrease-set-qty"
                                class="p-2 sm:p-2.5 md:p-2 lg:p-2.5 rounded-full ${e > 0 ? 'bg-gray-600 hover:bg-gray-500 shadow-lg hover:shadow-gray-500/25' : 'bg-gray-700 cursor-not-allowed'} text-white transition-all duration-150 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center"
                                ${e <= 0 ? 'disabled' : ''}
                                title="–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                                ${I_Minus("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5")}
                            </button>

                            <input id="set-modal-quantity-input"
                                type="number"
                                value="${e}"
                                readonly
                                class="w-14 sm:w-16 md:w-16 lg:w-18 text-center bg-gray-900 text-white font-bold rounded-[18px] py-2 sm:py-2.5 md:py-2 lg:py-2.5 text-sm sm:text-base md:text-sm lg:text-base min-h-[44px] border border-gray-600 focus:border-blue-500 focus:outline-none"/>

                            <button data-action="increase-set-qty"
                                class="p-2 sm:p-2.5 md:p-2 lg:p-2.5 rounded-full bg-gray-600 hover:bg-gray-500 text-white transition-all duration-150 shadow-lg hover:shadow-gray-500/25 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center"
                                title="–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                                ${I_Plus("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5")}
                            </button>
                        </div>

                        <!-- Action Buttons Row -->
                        <div class="flex gap-2 sm:gap-3">
                            <!-- Update Button -->
                            <button data-action="update-set-collection"
                                class="flex items-center justify-center gap-2 sm:gap-3 bg-blue-600 text-white font-bold py-3 sm:py-3.5 md:py-3 lg:py-3.5 px-2 sm:px-3 md:px-3 lg:px-4 rounded-[18px] hover:bg-blue-700 transition-all duration-150 shadow-lg hover:shadow-blue-500/25 touch-manipulation text-xs sm:text-sm md:text-sm lg:text-base min-h-[48px] sm:min-h-[52px] flex-1">
                                ${t>0 ? I_Refresh("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5") : I_Plus("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5")}
                                <span class="hidden sm:inline">${t>0 ? "–û–±–Ω–æ–≤–∏—Ç—å" : (e > 1 ? "–î–æ–±–∞–≤–∏—Ç—å "+e : "–î–æ–±–∞–≤–∏—Ç—å")}</span>
                                <span class="sm:hidden">${t>0 ? "–û–±–Ω–æ–≤–∏—Ç—å" : (e > 1 ? "–î–æ–±–∞–≤–∏—Ç—å "+e : "–î–æ–±–∞–≤–∏—Ç—å")}</span>
                            </button>

                            <!-- Delete Button -->
                            ${t>0?`
                                <button data-action="delete-from-set-collection-modal"
                                    class="flex items-center justify-center gap-1 sm:gap-2 text-xs sm:text-sm md:text-sm lg:text-base bg-red-600 hover:bg-red-700 text-white rounded-[18px] py-2 sm:py-2.5 md:py-2 lg:py-2.5 px-1.5 sm:px-2 md:px-2 lg:px-3 transition-all duration-150 shadow-lg hover:shadow-red-500/25 touch-manipulation min-h-[48px] sm:min-h-[52px] flex-3"
                                    title="${e > 1 ? "–£–¥–∞–ª–∏—Ç—å "+e+" –Ω–∞–±–æ—Ä–æ–≤" : "–£–¥–∞–ª–∏—Ç—å –Ω–∞–±–æ—Ä"}">
                                    ${I_Trash("w-3 h-3 sm:w-4 sm:h-4 md:w-3 md:h-3 lg:w-4 lg:h-4")}
                                    <span class="hidden sm:inline">${e > 1 ? "–£–¥–∞–ª–∏—Ç—å "+e : "–£–¥–∞–ª–∏—Ç—å"}</span>
                                    <span class="sm:hidden">${e > 1 ? "–£–¥–∞–ª–∏—Ç—å "+e : "–£–¥–∞–ª–∏—Ç—å"}</span>
                                </button>
                            `:""}
                        </div>
                    </div>
                    
                    <!-- Info Text -->
                    <div class="text-xs text-gray-400 text-center leading-relaxed px-2 sm:px-4">
                        <div class="flex items-center justify-center gap-2 mb-2 sm:hidden">
                            <button id="toggle-set-info" data-action="toggle-set-info" class="flex items-center gap-1 text-blue-400 hover:text-blue-300 transition-colors">
                                <!-- –ò–∫–æ–Ω–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (SVG) -->
                                <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
                                    <circle cx="12" cy="12" r="9" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M12 8h.01" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M11 12h1v4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <span class="text-xs">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</span>
                            </button>
                        </div>
                        <div id="set-info-content" class="hidden sm:block">
                            ${(() => {
                                const getSetWord = (count) => {
                                    if (count === 1) return "–Ω–∞–±–æ—Ä";
                                    if (count >= 2 && count <= 4) return "–Ω–∞–±–æ—Ä–∞";
                                    return "–Ω–∞–±–æ—Ä–æ–≤";
                                };
                                
                                if (t > 0) {
                                    if (e > 1) {
                                        return `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–æ—Ä–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏. –£–¥–∞–ª–µ–Ω–∏–µ —É–±–µ—Ä–µ—Ç ${e} ${getSetWord(e)}`;
                                    } else {
                                        return "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–æ—Ä–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏. –£–¥–∞–ª–µ–Ω–∏–µ —É–±–µ—Ä–µ—Ç –Ω–∞–±–æ—Ä —Å –∫–æ–ª–ª–µ–∫—Ü–∏–∏";
                                    }
                                } else {
                                    if (e > 1) {
                                        return `–î–æ–±–∞–≤–ª–µ–Ω–∏–µ ${e} ${getSetWord(e)} –¥–æ–±–∞–≤–∏—Ç –∏—Ö –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é`;
                                    } else {
                                        return "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞–±–æ—Ä–∞ –¥–æ–±–∞–≤–∏—Ç –µ–≥–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é";
                                    }
                                }
                            })()}
                        </div>
                    </div>
                </div>
            </div>
        `
}

function renderSetBulkPartsControls() {
    return S.selSetNum ? S.setModal.bulkUpdate ? `
                <div class="bg-gray-700/50 rounded-[18px] p-4 mt-4">
                     <h3 class="text-md font-semibold text-gray-300 mb-2">–ö–æ–ª–ª–µ–∫—Ü–∏—è –¥–µ—Ç–∞–ª–µ–π</h3>
                     <div class="flex items-center justify-center gap-3 text-white h-10">
                        <div class="loader !w-5 !h-5 !border-2"></div>
                        <span>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...</span>
                     </div>
                </div>
            ` : `
            <div class="bg-gray-700/50 rounded-[18px] p-2 sm:p-4 mt-2 sm:mt-4">
                <h3 class="text-sm sm:text-md font-semibold text-gray-300 mb-1 sm:mb-2">–ö–æ–ª–ª–µ–∫—Ü–∏—è –¥–µ—Ç–∞–ª–µ–π</h3>
                <div class="grid grid-cols-2 gap-1 sm:gap-2 mb-1 sm:mb-2">
                    <button data-action="bulk-add-parts" class="flex items-center justify-center px-1 sm:px-3 py-3 sm:py-3.5 md:py-3 lg:py-3.5 text-xs font-semibold rounded-[18px] transition-colors duration-150 bg-green-600 hover:bg-green-700 text-white shadow-lg hover:shadow-green-500/25 whitespace-nowrap min-h-[48px] sm:min-h-[52px]" title="–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –∏–∑ –Ω–∞–±–æ—Ä–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–µ—Ç–∞–ª–µ–π">
                        –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ
                    </button>
                    <button data-action="bulk-remove-parts" class="flex items-center justify-center px-1 sm:px-3 py-3 sm:py-3.5 md:py-3 lg:py-3.5 text-xs font-semibold rounded-[18px] transition-colors duration-150 bg-red-600 hover:bg-red-700 text-white shadow-lg hover:shadow-red-500/25 whitespace-nowrap min-h-[48px] sm:min-h-[52px] flex-3" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –∏–∑ –Ω–∞–±–æ—Ä–∞ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π">
                        –£–¥–∞–ª–∏—Ç—å –≤—Å–µ
                    </button>
                </div>
                <p class="text-xs text-gray-400 text-center">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—è–º–∏ –∏–∑ –Ω–∞–±–æ—Ä–∞ –≤ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π</p>
            </div>
        ` : ""
}

function renderSetModalToggleButton() {
    const e = SET_MAP[S.selSetNum];
    return e ? "details" === S.setModal.view ? `<button data-action="toggle-set-modal-view" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-600 hover:bg-gray-500 text-white shadow-lg hover:shadow-gray-500/25">
                ${I_Brick("w-5 h-5")}
                <span>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
                <span class="text-xs bg-gray-700 text-gray-200 px-1.5 py-0.5 rounded-full">${e.num_parts}</span>
            </button>` : `<button data-action="toggle-set-modal-view" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-blue-500/25">
                ${I_Cat("w-5 h-5")}
                <span>–î–µ—Ç–∞–ª–∏ –Ω–∞–±–æ—Ä–∞</span>
            </button>` : ""
}

function renderSetModalDetailsView() {
    const e = SET_MAP[S.selSetNum];
    const t = THEME_MAP[e.theme_id];
    return `
        <div class="flex flex-col lg:flex-row">
            <div class="lg:w-1/2 p-4 sm:p-6 bg-gray-900/30 flex items-center justify-center flex-col gap-2 flex-1 lg:flex-shrink-0 border-b lg:border-b-0 lg:border-r border-gray-700">
                 <div class="relative">
                    <button data-action="set-gallery-prev" class="set-gallery-btn absolute left-[-3rem] top-1/2 p-2 sm:p-1.5 rounded-full bg-gray-700 hover:bg-gray-600 text-white shadow-lg inline-flex z-20 select-none focus:outline-none" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="display: none;">
                        ${I_ChevronLeft("w-6 h-6 sm:w-5 sm:h-5")}
                    </button>
                    <div data-action="view-image-fullscreen" data-image-url="${e.set_img_url||""}" class="w-48 h-48 sm:w-64 sm:h-64 bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-lg relative cursor-pointer group mx-auto">
                    <img ${getSetImageAttrs(e.set_num, e.set_img_url)} alt="${e.name}" class="max-w-full max-h-full object-contain">
                    <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                        ${I_Search("w-10 h-10 text-white")}
                    </div>
                    </div>
                        <div class="flex items-center justify-center mt-2 w-full">
                        <div id="set-gallery-dots" class="flex items-center justify-center gap-1.5" style="opacity: 0; transform: translateY(6px); height: 12px;"></div>
                    </div>
                    <button data-action="set-gallery-next" class="set-gallery-btn absolute right-[-3rem] top-1/2 p-2 sm:p-1.5 rounded-full bg-gray-700 hover:bg-gray-600 text-white shadow-lg inline-flex z-20 select-none focus:outline-none" title="–°–ª–µ–¥—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="display: none;">
                        ${I_ChevronRight("w-6 h-6 sm:w-5 sm:h-5")}
                    </button>
                 </div>
            </div>
            
            <div class="lg:w-1/2 p-4 sm:p-6 flex flex-col">
                <div class="space-y-6">
                    <div>
                        <h3 class="text-md font-semibold text-gray-300 mb-3">–î–µ—Ç–∞–ª–∏</h3>
                        <div class="space-y-1 text-sm text-gray-400">
                            <p><span class="font-semibold text-gray-300">–ù–∞–∑–≤–∞–Ω–∏–µ:</span> ${e.name}</p>
                            <p>ID: ${e.set_num}</p>
                            <p>–ì–æ–¥: ${e.year}</p>
                            <p>–ö–æ–ª-–≤–æ –¥–µ—Ç–∞–ª–µ–π: ${e.num_parts}</p>
                            ${t?`<div class="flex items-center">
                                <span class="mr-1">–¢–µ–º–∞:</span>
                                <button data-action="go-to-theme" data-theme-id="${t.id}" class="text-blue-400 hover:text-blue-300 hover:underline text-left truncate">
                                    ${t.name}
                                </button>
                            </div>`:""}
                        </div>
                    </div>

                    <div id="set-modal-controls-container">
                        ${renderSetCollectionControls()}
                        ${renderSetBulkPartsControls()}
                    </div>
                    
                     ${S.setModal.status?`
                        <div class="mt-4 p-2 text-sm rounded-[18px] ${"error"===S.setModal.statusType?"bg-red-900/50 text-red-300":"bg-green-900/50 text-green-300"}">
                            ${S.setModal.status}
                        </div>
                     `:""}
                </div>
            </div>
        </div>
        `
}

function renderSetModalInventoryView() {
    return `<div id="set-inventory-container" class="p-4 flex flex-col">
            ${renderSetInventory()}
        </div>`
}

function updateSetModalView() {
    if (!S.selSetNum) return;
    const e = document.getElementById("set-modal-view-container");
    if (!e) return;
    if ("details" === S.setModal.view) {
        e.innerHTML = renderSetModalDetailsView();
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –≥–∞–ª–µ—Ä–µ—é –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
        if (S.selSetNum) {
            if (!S.setModal.gallery) initSetImageGallery(S.selSetNum);
            else setTimeout(() => { applySetGalleryImageToDom(); }, 0);
        }
        // –ö–Ω–æ–ø–∫–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–≤–∞–π–ø—ã –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–±–æ—Ä–∞ (—Ç–∞—á)
        setTimeout(() => { setupSetImageSwipe(); }, 0);
    } else {
        e.innerHTML = renderSetModalInventoryView();
    }
    
    // –ù–ï –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º z-index - ModalManager —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç —ç—Ç–∏–º
    // if (setModalEl) {
    //     console.log('Set modal z-index after view update:', setModalEl.style.zIndex);
    //     // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º z-index –µ—Å–ª–∏ –æ–Ω —Å–±—Ä–æ—Å–∏–ª—Å—è
    //     if (setModalEl.style.zIndex !== '95') {
    //         setModalEl.style.zIndex = '95';
    //         console.log('Set modal z-index restored to 95');
    //     }
    // }
    // –¢—Ä–µ–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –º–æ–¥–∞–ª–∫–∏ –∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ —Ä–µ–Ω–¥–µ—Ä–µ –º–æ–¥–∞–ª–∫–∏
    // –ü–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞ –≤–∏–¥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –≤ –º–æ–¥–∞–ª–∫–µ
    (function(){
        const track = document.getElementById('set-scroll-progress');
        const content = document.getElementById('set-modal-content');
        if (track && content) {
            const header = content.querySelector('.border-b');
            const headerH = header?.offsetHeight || 0;
            const top = Math.max(12, headerH + 8);
            track.style.top = top + 'px';
            track.style.bottom = '12px';
        }
        const scrollArea = document.getElementById('set-modal-view-container');
        const bar = track?.querySelector('.bar');
        const update = () => {
            if (!track || !bar || !scrollArea) return;
            const max = scrollArea.scrollHeight - scrollArea.clientHeight;
            const percent = max <= 0 ? 100 : Math.min(100, Math.max(0, (scrollArea.scrollTop / max) * 100));
            const containerH = track.clientHeight || 0;
            const barH = bar.clientHeight || 24;
            const maxOffset = Math.max(0, containerH - barH);
            const translatePx = (percent / 100) * maxOffset;
            bar.style.transform = `translateY(${translatePx}px)`;
        };
        update();
        let to;
        const onScroll = () => {
            track?.classList.add('visible');
            update();
            clearTimeout(to);
            to = setTimeout(() => track?.classList.remove('visible'), 200);
        };
        scrollArea?.addEventListener('scroll', onScroll, { passive: true });
        const obs = new MutationObserver(update);
        scrollArea && obs.observe(scrollArea, { childList: true, subtree: true });
        window.addEventListener('resize', () => { update(); }, { passive: true });
    })();

    // –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∑–∞–ø–∞—Å–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π: –µ—Å–ª–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω —Ä–∞–Ω–µ–µ –±–µ–∑ –∑–∞–ø–∞—Å–Ω—ã—Ö (—Å—Ç–∞—Ä—ã–π –∫—ç—à), –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é
    try {
        if (S.setModal && S.setModal.view === 'inventory' && !S.setModal._checkedSparesOnce) {
            S.setModal._checkedSparesOnce = true;
            setTimeout(() => {
                try {
                    const inv = Array.isArray(S.setModal.inv) ? S.setModal.inv : [];
                    const hasSpare = inv.some(item => item && item.is_spare === true);
                    if (!hasSpare && S.selSetNum) {
                        // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –∑–∞–ø–∞—Å–Ω—ã–µ
                        loadAllSetInventoryIntoModal(S.selSetNum);
                    }
                } catch (_) {}
            }, 0);
        }
    } catch (_) {}
}

function setupSetImageSwipe() {
    try {
        const content = document.getElementById('set-modal-content');
        if (!content) return;
        const container = content.querySelector('[data-action="view-image-fullscreen"]');
        if (!container) return;
        if (container._swipeBound) return;
        container._swipeBound = true;

        let startX = 0, startY = 0, startT = 0, swiping = false;
        const THRESH_X = 48; // –ø–∏–∫—Å–µ–ª–µ–π
        const THRESH_Y = 40;
        const THRESH_MS = 600;

        const onTouchStart = (ev) => {
            const t = ev.touches && ev.touches[0];
            if (!t) return;
            startX = t.clientX; startY = t.clientY; startT = Date.now();
            swiping = true;
        };
        const onTouchMove = (ev) => {
            if (!swiping) return;
            // –ù–µ –±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–æ–∫—Ä—É—Ç–∫—É, –µ—Å–ª–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ
            const t = ev.touches && ev.touches[0];
            if (!t) return;
            const dx = t.clientX - startX;
            const dy = Math.abs(t.clientY - startY);
            if (Math.abs(dx) > THRESH_X && dy < THRESH_Y) {
                // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ fullscreen –ø–æ —Ç–∞–ø—É
                ev.preventDefault();
            }
        };
        const onTouchEnd = (ev) => {
            if (!swiping) return;
            swiping = false;
            const t = ev.changedTouches && ev.changedTouches[0];
            if (!t) return;
            const dt = Date.now() - startT;
            const dx = t.clientX - startX;
            const dy = Math.abs(t.clientY - startY);
            if (dt <= THRESH_MS && Math.abs(dx) > THRESH_X && dy < THRESH_Y) {
                // –°–≤–∞–π–ø —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω ‚Äî –Ω–µ –¥–∞—ë–º –≤—Å–ø–ª—ã—Ç—å –∫–ª–∏–∫—É –Ω–∞ fullscreen
                ev.preventDefault(); ev.stopPropagation();
                if (dx < 0) {
                    // –≤–ª–µ–≤–æ -> —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    performSwipeTransition('next');
                } else {
                    // –≤–ø—Ä–∞–≤–æ -> –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–∞–¥—Ä —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    performSwipeTransition('prev');
                }
            }
        };
        container.addEventListener('touchstart', onTouchStart, { passive: true });
        container.addEventListener('touchmove', onTouchMove, { passive: false });
        container.addEventListener('touchend', onTouchEnd, { passive: false });
    } catch (_) { /* no-op */ }
}

function setupMinifigImageSwipe() {
    try {
        const content = document.getElementById('minifig-modal-content');
        if (!content) return;
        const container = content.querySelector('[data-action="view-image-fullscreen"]');
        if (!container) return;
        if (container._swipeBound) return;
        container._swipeBound = true;

        let startX = 0, startY = 0, startT = 0, swiping = false;
        const THRESH_X = 48;
        const THRESH_Y = 40;
        const THRESH_MS = 600;

        const onTouchStart = (ev) => {
            const t = ev.touches && ev.touches[0];
            if (!t) return;
            startX = t.clientX; startY = t.clientY; startT = Date.now();
            swiping = true;
        };
        const onTouchMove = (ev) => {
            if (!swiping) return;
            const t = ev.touches && ev.touches[0];
            if (!t) return;
            const dx = t.clientX - startX;
            const dy = Math.abs(t.clientY - startY);
            if (Math.abs(dx) > THRESH_X && dy < THRESH_Y) {
                ev.preventDefault();
            }
        };
        const onTouchEnd = (ev) => {
            if (!swiping) return;
            swiping = false;
            const t = ev.changedTouches && ev.changedTouches[0];
            if (!t) return;
            const dt = Date.now() - startT;
            const dx = t.clientX - startX;
            const dy = Math.abs(t.clientY - startY);
            if (dt <= THRESH_MS && Math.abs(dx) > THRESH_X && dy < THRESH_Y) {
                ev.preventDefault(); ev.stopPropagation();
                if (dx < 0) {
                    performMinifigSwipeTransition('next');
                } else {
                    performMinifigSwipeTransition('prev');
                }
            }
        };
        container.addEventListener('touchstart', onTouchStart, { passive: true });
        container.addEventListener('touchmove', onTouchMove, { passive: false });
        container.addEventListener('touchend', onTouchEnd, { passive: false });
    } catch (_) {}
}

function performMinifigSwipeTransition(direction) {
    try {
        if (!S.minifigModal || !S.selFigNum) return;
        const st = S.minifigModal;
        const total = st.gallery?.length || 0;
        if (total <= 1) return;
        const content = document.getElementById('minifig-modal-content');
        if (!content) return;
        const container = content.querySelector('[data-action="view-image-fullscreen"]');
        const img = container?.querySelector('img');
        if (!container || !img) return;
        if (container._animating) return;
        container._animating = true;

        const curIdx = Math.max(0, Math.min(st.galleryIndex || 0, total - 1));
        const nextIdx = direction === 'next' ? (curIdx + 1) % total : (curIdx - 1 + total) % total;
        const nextUrl = st.gallery[nextIdx];

        const ghost = new Image();
        ghost.src = nextUrl;
        ghost.alt = img.alt || '';
        ghost.style.position = 'absolute';
        ghost.style.inset = '0';
        ghost.style.width = '100%';
        ghost.style.height = '100%';
        ghost.style.objectFit = 'contain';
        ghost.style.objectPosition = 'center';
        ghost.style.transform = direction === 'next' ? 'translateX(100%) translateZ(0)' : 'translateX(-100%) translateZ(0)';
        ghost.style.transition = 'transform 220ms ease';
        ghost.style.willChange = 'transform';
        ghost.style.backfaceVisibility = 'hidden';
        ghost.draggable = false;

        const curStart = 'translateX(0) translateZ(0)';
        const curEnd = direction === 'next' ? 'translateX(-100%) translateZ(0)' : 'translateX(100%) translateZ(0)';
        const prevPos = img.style.position;
        const prevInset = img.style.inset;
        const prevW = img.style.width;
        const prevH = img.style.height;
        const prevOF = img.style.objectFit;
        const prevOP = img.style.objectPosition;
        const prevTrans = img.style.transition;
        const prevWB = img.style.willChange;
        const prevBF = img.style.backfaceVisibility;
        img.style.position = 'absolute';
        img.style.inset = '0';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.style.objectPosition = 'center';
        img.style.transition = 'transform 220ms ease';
        img.style.willChange = 'transform';
        img.style.backfaceVisibility = 'hidden';
        img.style.transform = curStart;

        const startAnim = () => {
            try {
                container.appendChild(ghost);
                requestAnimationFrame(() => {
                    try {
                        img.style.transform = curEnd;
                        ghost.style.transform = 'translateX(0)';
                    } catch(_) {}
                });
                setTimeout(() => {
                    try {
                        img.style.transition = '';
                        img.style.transform = '';
                        img.onerror = null;
                        img.src = nextUrl;
                        img.setAttribute('data-current-src', nextUrl);
                        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ—Å–ª–µ —Å–≤–∞–π–ø–∞
                        if (window.matchMedia && window.matchMedia('(max-width: 768px)').matches) {
                            setTimeout(() => {
                                if (img.src !== nextUrl) {
                                    img.src = nextUrl;
                                    img.setAttribute('data-current-src', nextUrl);
                                }
                            }, 50);
                        }
                        ghost.remove();
                        img.style.position = prevPos;
                        img.style.inset = prevInset;
                        img.style.width = prevW;
                        img.style.height = prevH;
                        img.style.objectFit = prevOF;
                        img.style.objectPosition = prevOP;
                        img.style.transition = prevTrans;
                        img.style.willChange = prevWB;
                        img.style.backfaceVisibility = prevBF;
                        st.galleryIndex = nextIdx;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç data-image-url –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                        container.setAttribute('data-image-url', nextUrl || '');
                        updateMinifigGalleryDots();
                    } catch(_) {}
                    finally { container._animating = false; }
                }, 230);
            } catch(_) { container._animating = false; }
        };
        if (ghost.complete) startAnim(); else ghost.onload = startAnim;
    } catch (_) {}
}
function performSwipeTransition(direction) {
    try {
        if (!S.setModal || !S.selSetNum) return;
        const st = S.setModal;
        const total = st.gallery?.length || 0;
        if (total <= 1) return;
        const content = document.getElementById('set-modal-content');
        if (!content) return;
        const container = content.querySelector('[data-action="view-image-fullscreen"]');
        const img = container?.querySelector('img');
        if (!container || !img) return;
        if (container._animating) return;
        container._animating = true;

        const curIdx = Math.max(0, Math.min(st.galleryIndex || 0, total - 1));
        const nextIdx = direction === 'next' ? (curIdx + 1) % total : (curIdx - 1 + total) % total;
        const nextUrl = st.gallery[nextIdx];

        const ghost = new Image();
        ghost.src = nextUrl;
        ghost.alt = img.alt || '';
        ghost.style.position = 'absolute';
        ghost.style.inset = '0';
        ghost.style.width = '100%';
        ghost.style.height = '100%';
        ghost.style.objectFit = 'contain';
        ghost.style.objectPosition = 'center';
        ghost.style.transform = direction === 'next' ? 'translateX(100%) translateZ(0)' : 'translateX(-100%) translateZ(0)';
        ghost.style.transition = 'transform 220ms ease';
        ghost.style.willChange = 'transform';
        ghost.style.backfaceVisibility = 'hidden';
        ghost.draggable = false;

        const curStart = 'translateX(0) translateZ(0)';
        const curEnd = direction === 'next' ? 'translateX(-100%) translateZ(0)' : 'translateX(100%) translateZ(0)';
        // –ñ—ë—Å—Ç–∫–æ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π img –ø–æ —Ü–µ–Ω—Ç—Ä—É –Ω–∞ –≤—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö —Å–¥–≤–∏–≥–æ–≤
        const prevPos = img.style.position;
        const prevInset = img.style.inset;
        const prevW = img.style.width;
        const prevH = img.style.height;
        const prevOF = img.style.objectFit;
        const prevOP = img.style.objectPosition;
        const prevTrans = img.style.transition;
        const prevWB = img.style.willChange;
        const prevBF = img.style.backfaceVisibility;
        img.style.position = 'absolute';
        img.style.inset = '0';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.style.objectPosition = 'center';
        img.style.transition = 'transform 220ms ease';
        img.style.willChange = 'transform';
        img.style.backfaceVisibility = 'hidden';
        img.style.transform = curStart;

        // –î–æ–∂–∏–¥–∞–µ–º—Å—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ ghost
        const startAnim = () => {
            try {
                container.appendChild(ghost);
                // –ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä
                requestAnimationFrame(() => {
                    try {
                        img.style.transform = curEnd;
                        ghost.style.transform = 'translateX(0)';
                    } catch(_) {}
                });
                // –ó–∞–≤–µ—Ä—à–∞–µ–º —á–µ—Ä–µ–∑ —Ç–∞–π–º–µ—Ä
                setTimeout(() => {
                    try {
                        // –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è: —Å—Ç–∞–≤–∏–º –Ω–æ–≤—ã–π src –≤ –æ—Å–Ω–æ–≤–Ω–æ–π img –∏ —á–∏—Å—Ç–∏–º —Å—Ç–∏–ª–∏
                        img.style.transition = '';
                        img.style.transform = '';
                        img.onerror = null;
                        img.src = nextUrl;
                        img.setAttribute('data-current-src', nextUrl);
                        ghost.remove();
                        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª–∏ img
                        img.style.position = prevPos;
                        img.style.inset = prevInset;
                        img.style.width = prevW;
                        img.style.height = prevH;
                        img.style.objectFit = prevOF;
                        img.style.objectPosition = prevOP;
                        img.style.willChange = prevWB;
                        img.style.backfaceVisibility = prevBF;
                        st.galleryIndex = nextIdx;
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∞—Ç—Ä–∏–±—É—Ç data-image-url –¥–ª—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
                        container.setAttribute('data-image-url', nextUrl || '');
                        updateSetGalleryDots();
                        updateSetGalleryButtonsState();
                    } catch(_) {}
                    container._animating = false;
                }, 240);
            } catch(_) { container._animating = false; }
        };
        if (ghost.complete) startAnim(); else ghost.onload = startAnim;
    } catch(_) { /* no-op */ }
}

// –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤ –º–æ–¥–∞–ª–∫–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
;(function(){
    const setupMinifigScrollProgress = () => {
        const track = document.getElementById('minifig-scroll-progress');
        const content = document.getElementById('minifig-modal-content');
        if (track && content) {
            const header = content.querySelector('.border-b');
            const headerH = header?.offsetHeight || 0;
            const top = Math.max(12, headerH + 8);
            track.style.top = top + 'px';
            track.style.bottom = '12px';
        }
        const scrollArea = document.getElementById('minifig-modal-view-container');
        const bar = track?.querySelector('.bar');
        const update = () => {
            if (!track || !bar || !scrollArea) return;
            const max = scrollArea.scrollHeight - scrollArea.clientHeight;
            const percent = max <= 0 ? 100 : Math.min(100, Math.max(0, (scrollArea.scrollTop / max) * 100));
            const containerH = track.clientHeight || 0;
            const barH = bar.clientHeight || 24;
            const maxOffset = Math.max(0, containerH - barH);
            const translatePx = (percent / 100) * maxOffset;
            bar.style.transform = `translateY(${translatePx}px)`;
        };
        update();
        let to;
        const onScroll = () => {
            track?.classList.add('visible');
            update();
            clearTimeout(to);
            to = setTimeout(() => track?.classList.remove('visible'), 200);
        };
        scrollArea?.addEventListener('scroll', onScroll, { passive: true });
        const obs = new MutationObserver(update);
        scrollArea && obs.observe(scrollArea, { childList: true, subtree: true });
        window.addEventListener('resize', () => { update(); }, { passive: true });
    };
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ –º–æ–¥–∞–ª–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    const _updateMinifigModalView = updateMinifigModalView;
    updateMinifigModalView = function() {
        _updateMinifigModalView();
        setupMinifigScrollProgress();
    };
})();

// –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤ –º–æ–¥–∞–ª–∫–µ —Å–∫–∞–Ω–µ—Ä–∞ –∫–∞–º–µ—Ä—ã
;(function(){
    const setupPhotoCameraScrollProgress = () => {
        const track = document.getElementById('photo-camera-scroll-progress');
        const content = document.getElementById('photo-camera-modal-content');
        if (track && content) {
            const header = content.querySelector('.border-b');
            const headerH = header?.offsetHeight || 0;
            const top = Math.max(12, headerH + 8);
            track.style.top = top + 'px';
            track.style.bottom = '12px';
        }
        const scrollArea = content?.querySelector('.overflow-y-auto');
        const bar = track?.querySelector('.bar');
        const update = () => {
            if (!track || !bar || !scrollArea) return;
            const max = scrollArea.scrollHeight - scrollArea.clientHeight;
            const percent = max <= 0 ? 100 : Math.min(100, Math.max(0, (scrollArea.scrollTop / max) * 100));
            const containerH = track.clientHeight || 0;
            const barH = bar.clientHeight || 24;
            const maxOffset = Math.max(0, containerH - barH);
            const translatePx = (percent / 100) * maxOffset;
            bar.style.transform = `translateY(${translatePx}px)`;
        };
        update();
        let to;
        const onScroll = () => {
            track?.classList.add('visible');
            update();
            clearTimeout(to);
            to = setTimeout(() => track?.classList.remove('visible'), 200);
        };
        scrollArea?.addEventListener('scroll', onScroll, { passive: true });
        const obs = new MutationObserver(update);
        scrollArea && obs.observe(scrollArea, { childList: true, subtree: true });
        window.addEventListener('resize', () => { update(); }, { passive: true });
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–∫–∞–Ω–µ—Ä–∞ –∫–∞–º–µ—Ä—ã
    window.setupPhotoCameraScrollProgress = setupPhotoCameraScrollProgress;
})();

// –ü—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –≤ –º–æ–¥–∞–ª–∫–µ —Å–∫–∞–Ω–µ—Ä–∞ DataMatrix
;(function(){
    const setupCameraScrollProgress = () => {
        const track = document.getElementById('camera-scroll-progress');
        const content = document.getElementById('camera-modal-content');
        if (track && content) {
            const header = content.querySelector('.border-b');
            const headerH = header?.offsetHeight || 0;
            const top = Math.max(12, headerH + 8);
            track.style.top = top + 'px';
            track.style.bottom = '12px';
        }
        const scrollArea = content?.querySelector('.overflow-y-auto');
        const bar = track?.querySelector('.bar');
        const update = () => {
            if (!track || !bar || !scrollArea) return;
            const max = scrollArea.scrollHeight - scrollArea.clientHeight;
            const percent = max <= 0 ? 100 : Math.min(100, Math.max(0, (scrollArea.scrollTop / max) * 100));
            const containerH = track.clientHeight || 0;
            const barH = bar.clientHeight || 24;
            const maxOffset = Math.max(0, containerH - barH);
            const translatePx = (percent / 100) * maxOffset;
            bar.style.transform = `translateY(${translatePx}px)`;
        };
        update();
        let to;
        const onScroll = () => {
            track?.classList.add('visible');
            update();
            clearTimeout(to);
            to = setTimeout(() => track?.classList.remove('visible'), 200);
        };
        scrollArea?.addEventListener('scroll', onScroll, { passive: true });
        const obs = new MutationObserver(update);
        scrollArea && obs.observe(scrollArea, { childList: true, subtree: true });
        window.addEventListener('resize', () => { update(); }, { passive: true });
    };
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–∫–∞–Ω–µ—Ä–∞ DataMatrix
    window.setupCameraScrollProgress = setupCameraScrollProgress;
})();

function renderSetModal(e = !1) {
    if (!S.selSetNum) return void closeSetModal();
    const t = SET_MAP[S.selSetNum];
    if (!t) return void closeSetModal();
    
    const o = e ? "modal-content-enter" : "",
        l = "inventory" === S.setModal.view;
            e && (document.body.classList.add("overflow-hidden"), setModalEl.classList.remove("modal-hidden"), requestAnimationFrame(() => setModalEl.classList.add("visible"))), setModalEl.innerHTML = `
        <div id="set-modal-content" class="bg-gray-800 rounded-[18px] shadow-xl w-[calc(100%-2rem)] ${l?"max-w-6xl":"max-w-4xl"} flex flex-col ${l?"h-[calc(100vh-4rem)]":"max-h-[calc(100vh-2rem)]"} ${o} transition-all duration-300 relative">
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                 <h2 class="text-xl lg:text-2xl font-bold text-white truncate pr-4 modal-title-multiline">${t.name}</h2>
                 <div class="flex items-center gap-2 flex-shrink-0">
                    ${renderSetModalToggleButton()}
                    <button data-action="share-set" class="text-gray-300 hover:text-white transition-colors" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –Ω–∞–±–æ—Ä–æ–º —á–µ—Ä–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ CSV —Ñ–∞–π–ª">${I_Share("w-6 h-6")}</button>
                    <button id="set-modal-close" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–±–æ—Ä–∞">${I_X("w-4 h-4")}</button>
                 </div>
            </div>
            <div id="set-scroll-progress"><div class="bar"></div></div>
            <div id="set-modal-view-container" class="flex-grow overflow-y-auto no-scrollbar" style="min-height: 0;"></div>
        </div>
        `, updateSetModalView();
        
        // –ù–ï —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º z-index –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ - ModalManager —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç —ç—Ç–∏–º
        // if (setModalEl) {
        //     setModalEl.style.zIndex = '95';
        //     console.log('Set modal z-index forced to 95 after render');
        // }
}
function renderSetInventory() {
    const {
        inv: e,
        loading: t,
        hasNextInv: o,
        minifigs: l,
        loadingMinifigs: a
    } = S.setModal;
    let i = "";
    a ? i = '<div class="flex items-center justify-center p-4"><div class="loader !w-6 !h-6"></div></div>' : l?.length > 0 && (i = l.map(e => {
        const t = e.set_num,
            o = S.minifigColl[t]?.qty || 0,
            l = e.name || "–ó–∞–≥—Ä—É–∑–∫–∞...";
        const n = e.isLoadingParts ? '<div class="flex items-center justify-center p-2"><div class="loader !w-5 !h-5"></div></div>' : e.loadingError ? `
                        <div class="text-center p-2">
                            <p class="text-xs text-red-400 mb-2">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏.</p>
                            <button data-action="retry-load-minifig-parts" data-fig-num="${t}" class="text-xs px-3 py-2 rounded-[18px] bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-150 shadow-lg hover:shadow-blue-500/25 min-h-[40px]">
                                –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                            </button>
                        </div>
                    ` : (e.parts || []).map((e) => `
                                <div class="flex items-center p-1.5 rounded-[18px] gap-2 text-xs cursor-pointer hover:bg-gray-700/50"
                                     data-action="open-part-from-inventory"
                                     data-part-id="${e.part.part_num}"
                                     data-color-id="${e.color.id}"
                                     data-quantity="${e.quantity}">
                                    <div class="w-8 h-8 bg-white rounded-[18px] flex items-center justify-center flex-shrink-0 overflow-hidden">
                                        <img ${getPartImageUrl(e.part.part_img_url)} alt="${e.part.name}" class="w-full h-full object-contain p-0.5 rounded-[18px]">
                                    </div>
                                    <div class="flex-grow truncate">
                                        <p class="text-gray-200 truncate">${e.part.name}</p>
                                        <p class="text-gray-400 truncate">${e.part.part_num}</p>
                                    </div>
                                    <div class="flex items-center gap-2 flex-shrink-0">
                                        <span class="w-4 h-4 rounded-full border border-gray-500 ${e.color.isTransparent?"checkerboard":""}" style="background-color: ${e.color.hex};" title="${e.color.name}"></span>
                                        <span class="text-gray-300 w-6 text-right">${e.quantity}x</span>
                                    </div>
                                </div>
                            `).join("") || (e.parts && 0 === e.parts.length ? '<p class="text-xs text-gray-400 text-center p-2">–î–µ—Ç–∞–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>' : "");
        return `
                    <div class="bg-gray-700/50 rounded-[18px] overflow-hidden">
                        <div class="flex items-center p-2 gap-3 text-sm cursor-pointer hover:bg-gray-700/50"
                             data-action="open-minifig-from-inventory" data-fig-num="${t}">
                            <div class="w-10 h-10 bg-white rounded-[18px] flex items-center justify-center flex-shrink-0 overflow-hidden">
                                <img ${getPartImageUrl(e.minifig_img_url || e.set_img_url)} alt="${l}" class="w-full h-full object-contain p-1 rounded-[18px]">
                            </div>
                            <div class="flex-grow truncate">
                                <p class="text-white font-semibold truncate">${l}</p>
                                <p class="text-gray-400 truncate">${t}</p>
                            </div>
                            <div class="flex items-center gap-2 flex-shrink-0">
                                <span class="text-gray-300 w-8 text-right font-semibold">${e.quantity}x</span>
                                <button data-action="add-minifig-to-collection" data-fig-num="${t}" data-quantity="${e.quantity}" class="z-10 relative p-2 rounded-full text-white transition-colors duration-150 ${o>0?"bg-green-600 shadow-lg hover:shadow-green-500/25":"bg-blue-600 hover:bg-blue-700 shadow-lg hover:shadow-blue-500/25"} min-h-[44px] min-w-[44px] flex items-center justify-center" title="${o>0?`–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏: ${o}`:`–î–æ–±–∞–≤–∏—Ç—å ${e.quantity} –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫`}">
                                    ${I_Minifig("w-5 h-5")}
                                </button>
                                <button data-action="toggle-minifig-parts" data-fig-num="${t}" class="z-10 relative p-2 rounded-full bg-gray-600 hover:bg-gray-500 text-white transition-colors duration-150 shadow-lg hover:shadow-gray-500/25 min-h-[44px] min-w-[44px] flex items-center justify-center" title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏">
                                    ${I_Chev(`w-5 h-5 transform transition-transform duration-200 ${e.isExpanded?"rotate-180":""}`)}
                                </button>
                            </div>
                        </div>
                        <div id="minifig-parts-${t.replace(/[^a-zA-Z0-9]/g,"-")}" class="minifig-parts-container ${e.isExpanded?"p-2 max-h-60 overflow-y-auto no-scrollbar expanded":"hidden"}">
                             ${e.isExpanded?`
                                <div class="flex justify-end items-center mb-2 px-1.5">
                                    <button data-action="add-minifig-parts-to-collection" data-fig-num="${t}" class="flex items-center gap-2 text-xs px-3 py-2 rounded-[18px] bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-150 shadow-lg hover:shadow-blue-500/25 disabled:opacity-50 min-h-[40px]" title="–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏ —ç—Ç–æ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –≤ –≤–∞—à—É –∫–æ–ª–ª–µ–∫—Ü–∏—é –¥–µ—Ç–∞–ª–µ–π" ${S.setModal.bulkUpdate?"disabled":""}>
                                        ${I_Plus("w-4 h-4")}
                                        <span>–î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª–∏</span>
                                    </button>
                                </div>
                            `:""}
                            ${n}
                        </div>
                    </div>
                `
    }).join(""));
        // –°–Ω–∞—á–∞–ª–∞ –æ–±—ã—á–Ω—ã–µ, –∑–∞—Ç–µ–º –∑–∞–ø–∞—Å–Ω—ã–µ
        const regularSetInv = e.filter(p => !p.is_spare);
        const sparesSetInv = e.filter(p => p.is_spare);
        const renderSetInvRow = (e) => `
            <div class="flex items-center bg-gray-700/50 p-2 rounded-[18px] gap-3 text-sm cursor-pointer hover:bg-gray-700/70"
                 data-action="open-part-from-inventory"
                 data-part-id="${e.part.part_num}"
                 data-color-id="${e.color.id}"
                 data-quantity="${e.quantity}">
                <div class="w-10 h-10 bg-white rounded-[18px] flex items-center justify-center flex-shrink-0 overflow-hidden">
                        <img ${getPartImageUrl(e.part.part_img_url)} alt="${e.part.name}" class="w-full h-full object-contain p-1 rounded-[18px]">
                </div>
                <div class="flex-grow truncate">
                    <p class="text-white font-semibold truncate">${e.part.name}</p>
                    <p class="text-gray-400 truncate">${e.part.part_num}</p>
                </div>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <span class="w-5 h-5 rounded-full border border-gray-500 ${e.color.isTransparent?"checkerboard":""}" style="background-color: ${e.color.hex};" title="${e.color.name}"></span>
                    <span class="text-gray-300 w-8 text-right">${e.quantity}x</span>
                </div>
            </div>
        `;
        const r = `
            <div class="space-y-2">${regularSetInv.map(renderSetInvRow).join("")}</div>
            ${sparesSetInv.length ? `
            <div class="pt-2">
                <div class="text-xs text-gray-400 uppercase tracking-wide mb-1 flex items-center justify-center gap-1">${I_Info("w-3 h-3 text-yellow-400")} –ó–∞–ø–∞—Å–Ω—ã–µ</div>
                <div class="space-y-2">${sparesSetInv.map(renderSetInvRow).join("")}</div>
            </div>` : ''}
        `;
    let s = "";
    return t ? s = '<div class="flex justify-center p-4 flex-shrink-0"><div class="loader !w-8 !h-8"></div></div>' : s = "", `
            <div class="space-y-6">
                ${i?`
                    <div>
                        <h3 class="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                            ${I_Minifig("w-5 h-5")} –ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                        </h3>
                        <div class="space-y-2">${i}</div>
                    </div>`:""}
                <div>
                    <h3 class="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                        ${I_Brick("w-5 h-5")} –î–µ—Ç–∞–ª–∏
                    </h3>
                    ${e.length>0||t?`
                        <div class="space-y-2">${r}</div>
                        ${s}
                    `:'<div class="text-sm text-gray-400 p-2">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (–∫—Ä–æ–º–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫) –Ω–µ –Ω–∞–π–¥–µ–Ω.</div>'}
                </div>
            </div>
        `
}

function updateSetModalControlsState() {
    if (!S.selSetNum) return;
    const e = document.getElementById("set-modal-controls-container");
    e && (e.innerHTML = renderSetCollectionControls() + renderSetBulkPartsControls())
}
function renderModal() {
    if (!S.selPartId) return void(partModalEl.classList.contains("modal-hidden") || closeModal());
    const e = PART_MAP[S.selPartId];
    if (!e) return void closeModal();
    const t = flatCategories.find(t => t.id === e.categoryId)?.name, {
        variants: o,
        imgUrl: l
    } = S.partModal;
    let a = "";
    o?.length > 1 && (a = `
                <div>
                    <label for="variation-select-button" class="block text-sm font-medium text-gray-400 mb-2">–í–∞—Ä–∏–∞—Ü–∏—è</label>
                    <div class="relative variation-select-container">
                        <button id="variation-select-button" class="w-full bg-gray-700 border border-gray-600 rounded-[18px] py-2 px-3 text-white focus:outline-none focus:ring-0 cursor-pointer pr-2 text-left flex justify-between items-center hover:bg-gray-600 transition-colors duration-200">
                            <span id="variation-select-text" class="truncate flex-1">${o.find(e => e.id === S.selPartId)?.name || (o[0]?.name || '')}</span>
                            <svg class="w-4 h-4 text-gray-400 transition-transform duration-200 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </button>
                        <div id="variation-dropdown" class="absolute bg-gray-700 border border-gray-600 rounded-[18px] shadow-lg z-[99999] max-h-60 overflow-y-auto" style="display: none; background-color: #374151; border: 1px solid #4B5563; border-radius: 6px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); min-width: 200px;">
                            ${(() => { const seen = new Set(); return o.filter(v=>{const id=v?.id; if(!id||seen.has(id)) return false; seen.add(id); return true;}).map(e=>`
                                <div data-value="${e.id}" class="variation-option px-3 py-2 text-white hover:bg-gray-600 cursor-pointer transition-colors duration-150 ${e.id===S.selPartId?'selected':''}">
                                    <span class="truncate block">${e.name}</span>
                                </div>
                            `).join("") })()}
                        </div>
                    </div>
                </div>
            `);
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑; –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö —Ä–µ–Ω–¥–µ—Ä–∞—Ö –Ω–µ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
    (function(){
        try {
            const isOpen = partModalEl.classList.contains('visible');
            if (!isOpen) {
                document.body.classList.add('overflow-hidden');
                partModalEl.classList.remove('modal-hidden');
                partModalEl.style.zIndex = '60';
                requestAnimationFrame(() => partModalEl.classList.add('visible'));
            }
        } catch(_) {}
    })();
    partModalEl.innerHTML = `
        <div id="modal-content" class="bg-gray-800 rounded-[18px] shadow-xl w-[calc(100%-2rem)] max-w-lg lg:max-w-4xl flex flex-col max-h-[calc(100vh-2rem)] modal-content-enter">
            
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center">
                 <h2 class="text-xl lg:text-2xl font-bold text-white truncate pr-8 modal-title-multiline">${e.name}</h2>
                 <div class="flex items-center gap-2">
                    <button data-action="share-part" class="text-gray-300 hover:text-white transition-colors duration-150" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –¥–µ—Ç–∞–ª—å—é —á–µ—Ä–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ CSV —Ñ–∞–π–ª">${I_Share("w-6 h-6")}</button>
                    <button id="modal-close" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ">${I_X("w-4 h-4")}</button>
                 </div>
            </div>
            
            <div id="modal-scroll-area" class="flex-grow flex flex-col lg:flex-row overflow-y-auto no-scrollbar">
                <div class="lg:w-1/2 p-4 sm:p-6 bg-gray-900/30 flex items-center justify-center flex-col gap-2 flex-1 lg:flex-shrink-0 border-b lg:border-b-0 lg:border-r border-gray-700">
                     <div class="relative">
                        <button data-action="part-variant-prev" class="set-gallery-btn absolute left-[-3rem] top-1/2 p-2 sm:p-1.5 rounded-full bg-gray-700 hover:bg-gray-600 text-white shadow-lg inline-flex z-20 select-none focus:outline-none" title="–ü—Ä–µ–¥—ã–¥—É—â–∞—è –≤–∞—Ä–∏–∞—Ü–∏—è" style="display: none;">
                            ${I_ChevronLeft("w-6 h-6 sm:w-5 sm:h-5")}
                        </button>
                        <div id="modal-image-container" data-action="view-image-fullscreen" data-image-url="${l||""}" class="w-48 h-48 sm:w-64 sm:h-64 bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-lg relative cursor-pointer group mx-auto">
                            <img ${getPartImageUrl(l)} alt="${e.name}" class="max-w-full max-h-full object-contain">
                            <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                               ${I_Search("w-10 h-10 text-white")}
                            </div>
                        </div>
                        <div class="flex items-center justify-center mt-2 w-full" style="display: none;">
                            <div id="part-variant-dots" class="flex items-center justify-center gap-1.5" style="opacity: 0; transform: translateY(6px); height: 12px;"></div>
                        </div>
                        <button data-action="part-variant-next" class="set-gallery-btn absolute right-[-3rem] top-1/2 p-2 sm:p-1.5 rounded-full bg-gray-700 hover:bg-gray-600 text-white shadow-lg inline-flex z-20 select-none focus:outline-none" title="–°–ª–µ–¥—É—é—â–∞—è –≤–∞—Ä–∏–∞—Ü–∏—è" style="display: none;">
                            ${I_ChevronRight("w-6 h-6 sm:w-5 sm:h-5")}
                        </button>
                     </div>
                </div>
                
                <div class="lg:w-1/2 p-4 sm:p-6 flex flex-col">
                    <div>
                         <div class="modal-section-spacing">
                            <h3 class="text-md font-semibold text-gray-300 modal-section-title">–î–µ—Ç–∞–ª—å</h3>
                            <div class="space-y-1 text-sm text-gray-400">
                                <p><span class="font-semibold text-gray-300">–ù–∞–∑–≤–∞–Ω–∏–µ:</span> <span id="part-name">${e.name}</span></p>
                                <p>ID: <span id="part-id">${e.id}</span></p>
                                ${(() => {
                                    // –ì–æ–¥ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏ ‚Äî –º–∏–Ω–∏–º—É–º –ø–æ –≥–æ–¥–∞–º —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
                                    const y = getFirstAppearanceYearForPart(e.id);
                                    return y ? `<p>–ì–æ–¥: ${y}</p>` : '';
                                })()}
                                ${t?`
                                    <div class="flex items-center">
                                        <span class="mr-1">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
                                        <button id="part-category-name" data-action="go-to-category" data-category-id="${e.categoryId}" class="text-blue-400 hover:text-blue-300 hover:underline text-left truncate">
                                            ${t}
                                        </button>
                                    </div>
                                `:""}
                                <div id="related-sets-for-part"></div>
                            </div>
                            ${a?`<div class="mt-4">${a}</div>`:""}
                        </div>
                        
                         <div class="modal-section-spacing">
                          <h3 class="text-md font-semibold text-gray-300 modal-section-title">–¶–≤–µ—Ç–∞</h3>
                           <div id="color-selector-container" class="min-h-[120px] sm:min-h-[120px] lg:min-h-[160px]">${renderColorSelector()}</div>
                         </div>
                         
                         <div id="modal-controls-container" class="modal-section-spacing">${renderModalControls()}</div>
                    </div>
                </div>
            </div>
        </div>
        `;
    // –ï—Å–ª–∏ –æ–∫–Ω–æ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ, —É–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –≤—Ö–æ–¥–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ —É –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    setTimeout(() => { try { if (partModalEl.classList.contains('visible')) { const c = document.getElementById('modal-content'); c && c.classList.remove('modal-content-enter'); } } catch(_) {} }, 0);
    updateModalPartially({
        image: !0
    });
    setTimeout(() => { try { setupPartImageSwipe(); } catch(_) {} }, 0);
    // –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–Ω–¥–µ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º/–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∏ —Ç–æ—á–∫–∏ –≤–∞—Ä–∏–∞—Ü–∏–π
    setTimeout(() => { try { applyPartVariantImageToDom(); } catch(_) {} }, 0);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≤–∞—Ä–∏–∞—Ü–∏–π
    const variationSelectButton = document.getElementById("variation-select-button");
    const variationDropdown = document.getElementById("variation-dropdown");
    const variationSelectText = document.getElementById("variation-select-text");
    
    if (variationSelectButton && variationDropdown) {
        console.log('Variation elements found:', {
            button: variationSelectButton,
            dropdown: variationDropdown,
            text: variationSelectText
        });
        
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é
        variationSelectButton.addEventListener("click", (event) => {
            event.preventDefault();
            console.log('Variation button clicked');
            const isOpen = variationDropdown.style.display !== 'none';
            console.log('Is dropdown open:', isOpen);
            
            if (!isOpen) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
                variationDropdown.style.display = 'block';
                variationSelectButton.classList.add('open');
                
                // –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ç–æ—á–Ω–æ –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π
                const buttonRect = variationSelectButton.getBoundingClientRect();
                const modalContainer = document.querySelector('#modal-content');
                const modalRect = modalContainer.getBoundingClientRect();
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                variationDropdown.style.position = 'absolute';
                variationDropdown.style.left = '0px';
                variationDropdown.style.top = '100%';
                variationDropdown.style.marginTop = '4px';
                variationDropdown.style.width = '100%';
                variationDropdown.style.minWidth = '100%';
                
                console.log('Dropdown positioned at:', {
                    position: 'absolute',
                    left: '0px',
                    top: '100%',
                    width: '100%',
                    buttonWidth: buttonRect.width,
                    modalWidth: modalRect.width
                });
            } else {
                variationDropdown.style.display = 'none';
                variationSelectButton.classList.remove('open');
                console.log('Dropdown closed');
            }
        });
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –æ–ø—Ü–∏–∏
        variationDropdown.addEventListener("click", (event) => {
            const option = event.target.closest('.variation-option');
            if (option) {
                const selectedVariationId = option.dataset.value;
                const selectedVariation = S.partModal.variants?.find(v => v.id === selectedVariationId);
                
                if (selectedVariation && selectedVariation.id !== S.selPartId) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π ID –¥–µ—Ç–∞–ª–∏ –Ω–∞ –Ω–æ–≤—É—é –≤–∞—Ä–∏–∞—Ü–∏—é
                    S.selPartId = selectedVariationId;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                    variationSelectText.textContent = selectedVariation.name;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –æ–ø—Ü–∏–π
                    variationDropdown.querySelectorAll('.variation-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é
                    variationDropdown.style.display = 'none';
                    variationSelectButton.classList.remove('open');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏
                    const newPart = PART_MAP[selectedVariationId];
                    if (newPart) {
                        S.partModal.imgUrl = newPart.rebrickable_img_url || null;
                        S.partModal.selColorId = null;
                        S.partModal.qty = 0;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        updateModalPartially({
                            image: true
                        });
        setTimeout(() => { applyPartVariantImageToDom(); }, 0);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏
                        const modalTitle = document.querySelector('#modal-content h2');
                        if (modalTitle) {
                            modalTitle.textContent = selectedVariation.name;
                        }
                        
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏
                        if (newPart.availableColorIds && newPart.availableColorIds.length > 0) {
                            S.partModal.selColorId = sortColorIds(newPart.availableColorIds, newPart.id)[0];
                            S.partModal.qty = S.coll[selectedVariationId]?.[S.partModal.selColorId] || 0;
                            updateModalPartially({
                                colors: true,
                                controls: true
                            });
                            fetchPartColorSpecifics(newPart.id, S.partModal.selColorId);
                        } else {
                            fetchPartColors(newPart.id);
                        }
                        setTimeout(() => { applyPartVariantImageToDom(); }, 0);
                    }
                }
            }
        });
        
        // –û—Ç–∫–ª—é—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        variationDropdown.addEventListener('wheel', function(e) {
            e.stopPropagation();
        }, { passive: false });
        
        variationDropdown.addEventListener('touchmove', function(e) {
            e.stopPropagation();
        }, { passive: false });
        
        variationDropdown.addEventListener('keydown', function(e) {
            if ([32, 33, 34, 35, 36, 37, 38, 39, 40].includes(e.keyCode)) {
                e.stopPropagation();
            }
        });
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞
        function applyScrollbarStyles() {
            if (variationDropdown) {
                variationDropdown.style.scrollbarWidth = 'thin';
                variationDropdown.style.scrollbarColor = '#6B7280 transparent';
                variationDropdown.style.padding = '8px 6px 8px 0';
            }
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        variationSelectButton.addEventListener("click", function() {
            setTimeout(applyScrollbarStyles, 10);
        });
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        applyScrollbarStyles();
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener("click", (event) => {
            if (!variationSelectButton.contains(event.target) && !variationDropdown.contains(event.target)) {
                variationDropdown.style.display = 'none';
                variationSelectButton.classList.remove('open');
            }
        });
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–ª–∞–≤–∏—à–∏ Escape
        document.addEventListener("keydown", (event) => {
            if (event.key === "Escape") {
                variationDropdown.style.display = 'none';
                variationSelectButton.classList.remove('open');
            }
        });
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ (–≤–∞–∂–Ω–æ –¥–ª—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
        window.addEventListener("scroll", () => {
            if (variationDropdown.style.display !== 'none') {
                variationDropdown.style.display = 'none';
                variationSelectButton.classList.remove('open');
            }
        });
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        window.addEventListener("resize", () => {
            if (variationDropdown.style.display !== 'none') {
                variationDropdown.style.display = 'none';
                variationSelectButton.classList.remove('open');
            }
        });
    }
}

function renderColorSelector() {
    if (!S.selPartId) return "";
    const e = PART_MAP[S.selPartId];
    if (!e) return "";
    const {
        selColorId: t,
        loadingColors: o
    } = S.partModal, l = e.availableColorIds || [];
    
    if (o) {
        return '<div class="flex items-center justify-center h-24"><div class="loader !w-8 !h-8"></div></div>';
    }
    
    if (l.length === 0) {
        return '<div class="text-center py-4">\n                        <p class="text-sm text-gray-400 mb-3">–ù–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–≤–µ—Ç–∞—Ö.</p>\n                        <button data-action="retry-fetch-colors" class="bg-blue-600 text-white font-bold py-1.5 px-4 rounded-[18px] hover:bg-blue-700 transition-colors text-sm">\n                            –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞\n                        </button>\n                    </div>';
    }
    
    return `
            <div class="bg-gray-900/50 rounded-[18px]">
                <div class="relative color-palette-wrapper">
                    <div class="color-palette-container no-scrollbar">
                        <div class="flex flex-wrap justify-center gap-3 p-3 color-palette-inner">
                            ${sortColorIds(l,e.id).map(e=>{const o=COLOR_MAP[e];if(!o)return"";const l=S.coll[S.selPartId]&&S.coll[S.selPartId][e]>0;return`
                <button data-color-id="${e}" title="${o.name}" class="w-8 h-8 rounded-full border-2 transition-transform duration-150 overflow-hidden flex-shrink-0 flex items-center justify-center shadow-lg ${o.isTransparent?"checkerboard":""} ${t===e?"border-blue-500 scale-110":"border-gray-600 hover:border-gray-400"}" style="background-color: ${o.hex}; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);" onmouseover="this.style.boxShadow='0 10px 15px -3px ${o.hex}40, 0 4px 6px -2px ${o.hex}30'" onmouseout="this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'">
                    ${l?`<div class="w-2 h-2 bg-white rounded-full ${o.isTransparent || o.hex === '#FFFFFF' || o.hex === '#fff' ? 'border border-black' : ''}"></div>`:""}
                </button>
            `}).join("")}
                        </div>
                    </div>
                    ${l.length>1.5*COLOR_COLLAPSE_THRESHOLD?'<div class="absolute bottom-0 left-0 right-0 h-8 bg-gradient-to-t from-gray-900/50 to-transparent pointer-events-none color-palette-gradient"></div>':""}
                </div>
            </div>
        `;
}
function renderModalControls() {
    const {
        selColorId: e,
        qty: t
    } = S.partModal, o = e ? COLOR_MAP[e] : null;
    if (!S.selPartId) return "";
    const l = S.coll[S.selPartId]?.[e] || 0;
    return `
            <div class="bg-gray-700/50 rounded-[18px] p-3 sm:p-4 md:p-3 lg:p-4 xl:p-5">
                <div class="space-y-3 sm:space-y-4 md:space-y-3 lg:space-y-4">
                    <!-- Header -->
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-3">
                        <h3 class="text-sm sm:text-base md:text-base lg:text-lg font-semibold text-white flex items-center justify-between w-full gap-2 sm:gap-3">
                            <div class="flex items-center gap-2 sm:gap-3">
                                ${I_Brick("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5 text-blue-400")}
                                <span class="truncate" title="${o ? o.name : '–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç'}">${o ? o.name : '–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç'}</span>
                            </div>
                            <span class="text-xs sm:text-sm md:text-sm lg:text-base text-gray-400">
                                (–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏: <span id="modal-in-collection-qty" class="font-bold text-white">${l}</span>)
                            </span>
                        </h3>
                    </div>
                    
                    <!-- Controls -->
                    <div class="flex flex-col gap-3 sm:gap-4">
                        <!-- Quantity Controls -->
                        <div class="flex items-center justify-center gap-2 sm:gap-3">
                            <button data-action="decrease-qty"
                                class="p-2 sm:p-2.5 md:p-2 lg:p-2.5 rounded-full ${t > 0 ? 'bg-gray-600 hover:bg-gray-500 shadow-lg hover:shadow-gray-500/25' : 'bg-gray-700 cursor-not-allowed'} text-white transition-all duration-150 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center"
                                ${t <= 0 ? 'disabled' : ''}
                                title="–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                                ${I_Minus("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5")}
                            </button>

                            <input id="modal-quantity-input"
                                type="number"
                                value="${t}"
                                readonly
                                class="w-14 sm:w-16 md:w-16 lg:w-18 text-center bg-gray-900 text-white font-bold rounded-[18px] py-2 sm:py-2.5 md:py-2 lg:py-2.5 text-sm sm:text-base md:text-sm lg:text-base min-h-[44px] border border-gray-600 focus:border-blue-500 focus:outline-none"/>

                            <button data-action="increase-qty"
                                class="p-2 sm:p-2.5 md:p-2 lg:p-2.5 rounded-full bg-gray-600 hover:bg-gray-500 text-white transition-all duration-150 shadow-lg hover:shadow-gray-500/25 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center"
                                title="–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                                ${I_Plus("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5")}
                            </button>
                        </div>

                        <!-- Action Buttons Row -->
                        <div class="flex gap-2 sm:gap-3">
                            <!-- Update Button -->
                            <button id="modal-update-collection-btn" data-action="update-collection"
                                class="flex items-center justify-center gap-2 sm:gap-3 ${o ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-600 cursor-not-allowed'} text-white font-bold py-3 sm:py-3.5 md:py-3 lg:py-3.5 px-3 sm:px-4 md:px-4 lg:px-5 rounded-[18px] transition-all duration-150 shadow-lg hover:shadow-blue-500/25 touch-manipulation text-sm sm:text-base md:text-sm lg:text-base min-h-[48px] sm:min-h-[52px] flex-1"
                                ${!o ? 'disabled' : ''}>
                                ${l>0 ? I_Refresh("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5") : I_Plus("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5")}
                                <span class="hidden sm:inline">${!o ? "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç" : (l>0 ? "–û–±–Ω–æ–≤–∏—Ç—å" : (t > 1 ? "–î–æ–±–∞–≤–∏—Ç—å "+t : "–î–æ–±–∞–≤–∏—Ç—å"))}</span>
                                <span class="sm:hidden">${!o ? "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç" : (l>0 ? "–û–±–Ω–æ–≤–∏—Ç—å" : (t > 1 ? "–î–æ–±–∞–≤–∏—Ç—å "+t : "–î–æ–±–∞–≤–∏—Ç—å"))}</span>
                            </button>

                            <!-- Delete Button -->
                            ${l>0?`
                                <button data-action="delete-from-collection-modal"
                                    class="flex items-center justify-center gap-1 sm:gap-2 text-xs sm:text-sm md:text-sm lg:text-base bg-red-600 hover:bg-red-700 text-white rounded-[18px] py-2 sm:py-2.5 md:py-2 lg:py-2.5 px-2 sm:px-3 md:px-3 lg:px-4 transition-all duration-150 shadow-lg hover:shadow-red-500/25 touch-manipulation min-h-[48px] sm:min-h-[52px] flex-3"
                                    title="${t > 1 ? "–£–¥–∞–ª–∏—Ç—å "+t+" –¥–µ—Ç–∞–ª–µ–π" : "–£–¥–∞–ª–∏—Ç—å –¥–µ—Ç–∞–ª—å"}">
                                    ${I_Trash("w-3 h-3 sm:w-4 sm:h-4 md:w-3 md:h-3 lg:w-4 lg:h-4")}
                                    <span class="hidden sm:inline">${t > 1 ? "–£–¥–∞–ª–∏—Ç—å "+t : "–£–¥–∞–ª–∏—Ç—å"}</span>
                                    <span class="sm:hidden">${t > 1 ? "–£–¥–∞–ª–∏—Ç—å "+t : "–£–¥–∞–ª–∏—Ç—å"}</span>
                                </button>
                            `:""}
                        </div>
                    </div>
                    
                    <!-- Info Text -->
                    <div class="text-xs text-gray-400 text-center leading-relaxed px-2 sm:px-4">
                        ${!o ? 
                            "–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –¥–µ—Ç–∞–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π" :
                            (l>0 ? 
                                (t > 1 ? 
                                    `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏. –£–¥–∞–ª–µ–Ω–∏–µ —É–±–µ—Ä–µ—Ç ${t} ${(() => {
                                        const getPartWord = (count) => {
                                            if (count === 1) return "–¥–µ—Ç–∞–ª—å";
                                            if (count >= 2 && count <= 4) return "–¥–µ—Ç–∞–ª–∏";
                                            return "–¥–µ—Ç–∞–ª–µ–π";
                                        };
                                        return getPartWord(t);
                                    })()} –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.` :
                                    "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏. –£–¥–∞–ª–µ–Ω–∏–µ —É–±–µ—Ä–µ—Ç –¥–µ—Ç–∞–ª—å –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏."
                                ) : 
                                ""
                            )
                        }
                    </div>
                </div>
            </div>
        `
}
function renderFilterModal() {
    if (!S.filterOpen) return void closeFilterModal();
    
    // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
    hideSidebarHint();
    
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º tempFilters —Å —Ç–µ–∫—É—â–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    tempFilters.setFilters = { ...S.setFilters };
    tempFilters.sortBy = S.sortBy;
    tempFilters.filters = { ...S.filters };
    
    let e = "";
    if ("sets" === S.subView) {
        const t = [{
            id: "relevance",
            name: "–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å",
            desc: "–ü–æ–∏—Å–∫"
        }, {
            id: "year_desc",
            name: "–ì–æ–¥ (–Ω–æ–≤—ã–µ)",
            desc: "–ü–æ —É–º–æ–ª—á."
        }, {
            id: "year_asc",
            name: "–ì–æ–¥ (—Å—Ç–∞—Ä—ã–µ)",
            desc: ""
        }, {
            id: "parts_desc",
            name: "–ö–æ–ª-–≤–æ –¥–µ—Ç–∞–ª–µ–π (—É–±—ã–≤.)",
            desc: ""
        }, {
            id: "parts_asc",
            name: "–ö–æ–ª-–≤–æ –¥–µ—Ç–∞–ª–µ–π (–≤–æ–∑—Ä.)",
            desc: ""
        }, {
            id: "alpha_asc",
            name: "–ê–ª—Ñ–∞–≤–∏—Ç (A-Z)",
            desc: ""
        }, {
            id: "alpha_desc",
            name: "–ê–ª—Ñ–∞–≤–∏—Ç (Z-A)",
            desc: ""
        }].map(e => {
            const t = tempFilters.sortBy === e.id,
                o = "relevance" === e.id && !S.q,
                l = ("relevance" === e.id && S.q || "year_desc" === e.id && !S.q ? `<span class="ml-2 text-xs bg-blue-600/50 text-blue-300 px-1.5 py-0.5 rounded-full">–ü–æ —É–º–æ–ª—á.</span>` : "");
            return `
                    <label class="p-3 rounded-[18px] hover:bg-gray-700/50 transition-colors cursor-pointer ${o?"opacity-50 cursor-not-allowed":""}">
                        <input type="radio" name="sort" value="${e.id}" ${t?"checked":""} ${o?"disabled":""} data-action="modal-set-sort">
                        <span class="text-white">${e.name}</span>
                        ${l}
                    </label>
                `
        }).join("");
        e = `
                <div>
                    <h3 class="text-md font-semibold text-gray-300 mb-2">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</h3>
                    <div class="bg-gray-900/50 rounded-[18px] space-y-1 p-2">${t}</div>
                </div>
                <div>
                    <h3 class="text-md font-semibold text-gray-300 mb-2">–§–∏–ª—å—Ç—Ä—ã</h3>
                    <div class="bg-gray-900/50 rounded-[18px] p-3 space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="min-year" class="block text-sm font-medium text-gray-400 mb-1">–ú–∏–Ω. –≥–æ–¥</label>
                                <input type="number" id="min-year" value="${tempFilters.setFilters.minYear || ''}" data-filter-key="minYear" class="w-full bg-gray-700 border border-gray-600 rounded-[18px] py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2020" oninput="updateFilterValue(this, 'minYear')" onchange="updateFilterValue(this, 'minYear')">
                            </div>
                             <div>
                                <label for="max-year" class="block text-sm font-medium text-gray-400 mb-1">–ú–∞–∫—Å. –≥–æ–¥</label>
                                <input type="number" id="max-year" value="${tempFilters.setFilters.maxYear || ''}" data-filter-key="maxYear" class="w-full bg-gray-700 border border-gray-600 rounded-[18px] py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2023" oninput="updateFilterValue(this, 'maxYear')" onchange="updateFilterValue(this, 'maxYear')">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="min-parts" class="block text-sm font-medium text-gray-400 mb-1">–ú–∏–Ω. –¥–µ—Ç–∞–ª–µ–π</label>
                                <input type="number" id="min-parts" value="${tempFilters.setFilters.minParts || ''}" data-filter-key="minParts" class="w-full bg-gray-700 border border-gray-600 rounded-[18px] py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100" oninput="updateFilterValue(this, 'minParts')" onchange="updateFilterValue(this, 'minParts')">
                            </div>
                             <div>
                                <label for="max-parts" class="block text-sm font-medium text-gray-400 mb-1">–ú–∞–∫—Å. –¥–µ—Ç–∞–ª–µ–π</label>
                                <input type="number" id="max-parts" value="${tempFilters.setFilters.maxParts || ''}" data-filter-key="maxParts" class="w-full bg-gray-700 border border-gray-600 rounded-[18px] py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000" oninput="updateFilterValue(this, 'maxParts')" onchange="updateFilterValue(this, 'maxParts')">
                            </div>
                        </div>
                    </div>
                </div>
            `
    } else if ("minifigs" === S.subView) {
        const t = [{
            id: "relevance",
            name: "–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å",
            desc: "–ü–æ–∏—Å–∫"
        }, {
            id: "name_asc",
            name: "–ê–ª—Ñ–∞–≤–∏—Ç (A-Z)",
            desc: "–ü–æ —É–º–æ–ª—á."
        }, {
            id: "name_desc",
            name: "–ê–ª—Ñ–∞–≤–∏—Ç (Z-A)",
            desc: ""
        }, {
            id: "num_parts_desc",
            name: "–ö–æ–ª-–≤–æ –¥–µ—Ç–∞–ª–µ–π (—É–±—ã–≤.)",
            desc: ""
        }, {
            id: "num_parts_asc",
            name: "–ö–æ–ª-–≤–æ –¥–µ—Ç–∞–ª–µ–π (–≤–æ–∑—Ä.)",
            desc: ""
        }].map(e => {
            const t = tempFilters.sortBy === e.id,
                o = "relevance" === e.id && !S.q,
                l = ("relevance" === e.id && S.q || "name_asc" === e.id && !S.q ? `<span class="ml-2 text-xs bg-blue-600/50 text-blue-300 px-1.5 py-0.5 rounded-full">–ü–æ —É–º–æ–ª—á.</span>` : "");
            return `
                    <label class="p-3 rounded-[18px] hover:bg-gray-700/50 transition-colors cursor-pointer ${o?"opacity-50 cursor-not-allowed":""}">
                        <input type="radio" name="sort" value="${e.id}" ${t?"checked":""} ${o?"disabled":""} data-action="modal-set-sort">
                        <span class="text-white">${e.name}</span>
                        ${l}
                    </label>
                `
        }).join("");
        e = `
                <div>
                    <h3 class="text-md font-semibold text-gray-300 mb-2">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</h3>
                    <div class="bg-gray-900/50 rounded-[18px] space-y-1 p-2">${t}</div>
                </div>
            `
    } else {
        const sortOptions = [{
            id: "relevance",
            name: "–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å",
            desc: "–ü–æ–∏—Å–∫"
        }, {
            id: "popularity",
            name: "–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å",
            desc: "–ö–∞—Ç–∞–ª–æ–≥"
        }, {
            id: "alpha_asc",
            name: "–ê–ª—Ñ–∞–≤–∏—Ç (A-Z)",
            desc: ""
        }, {
            id: "alpha_desc",
            name: "–ê–ª—Ñ–∞–≤–∏—Ç (Z-A)",
            desc: ""
        }];
        if (S.view !== "catalog") {
            sortOptions.push({
                id: "quantity_desc",
                name: "–ö–æ–ª-–≤–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (—É–±—ã–≤.)",
                desc: ""
            }, {
                id: "quantity_asc",
                name: "–ö–æ–ª-–≤–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–≤–æ–∑—Ä.)",
                desc: ""
            });
        }
        const t = sortOptions.map(e => {
            const t = tempFilters.sortBy === e.id,
                o = "relevance" === e.id && !S.q || "popularity" === e.id && S.q,
                l = S.q && "relevance" === e.id || !S.q && "popularity" === e.id ? '<span class="ml-2 text-xs bg-blue-600/50 text-blue-300 px-1.5 py-0.5 rounded-full">–ü–æ —É–º–æ–ª—á.</span>' : "";
            return `
                    <label class="p-3 rounded-[18px] hover:bg-gray-700/50 transition-colors cursor-pointer ${o?"opacity-50 cursor-not-allowed":""}">
                        <input type="radio" name="sort" value="${e.id}" ${t?"checked":""} ${o?"disabled":""} data-action="modal-set-sort">
                        <span class="text-white">${e.name}</span>
                        ${l}
                    </label>
                `
        }).join(""), o = "catalog" === S.view ? `
                <div>
                    <h3 class="text-md font-semibold text-gray-300 mb-2">–§–∏–ª—å—Ç—Ä—ã</h3>
                    <div class="bg-gray-900/50 rounded-[18px] p-2">
                        <label class="p-2 cursor-pointer">
                            <input type="checkbox" ${tempFilters.filters.inCollectionOnly?"checked":""} data-action="modal-toggle-collection">
                            <span class="text-white">–¢–æ–ª—å–∫–æ –¥–µ—Ç–∞–ª–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</span>
                        </label>
                    </div>
                </div>
                            ` : "", l = Object.keys(COLOR_MAP).sort((e, t) => COLOR_MAP[e].name.localeCompare(COLOR_MAP[t].name, 'en')).map(e => {
            const t = COLOR_MAP[e],
                o = tempFilters.filters.colorIds.includes(e);
            return `<button data-action="modal-set-color" data-color-id="${e}" title="${t.name}" class="w-8 h-8 rounded-full border-2 transition-transform duration-150 overflow-hidden flex-shrink-0 ${t.isTransparent?"checkerboard":""} ${o?"border-blue-500 scale-110":"border-gray-600 hover:border-gray-400"}" style="background-color: ${t.hex}; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);" onmouseover="this.style.boxShadow='0 10px 15px -3px ${t.hex}40, 0 4px 6px -2px ${t.hex}30'" onmouseout="this.style.boxShadow='0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'"></button>`
        }).join("");
        e = `
                <div>
                    <h3 class="text-md font-semibold text-gray-300 mb-2">–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ</h3>
                    <div class="bg-gray-900/50 rounded-[18px] space-y-1 p-2">${t}</div>
                </div>
                ${o}
                <div>
                     <h3 class="text-md font-semibold text-gray-300 mb-2">–§–∏–ª—å—Ç—Ä –ø–æ —Ü–≤–µ—Ç—É</h3>
                     <div class="bg-gray-900/50 rounded-[18px] p-3">
                        <button data-action="modal-set-color" data-color-id="null" class="w-full mb-3 py-2 text-sm rounded-[18px] transition-colors duration-150 ${0===tempFilters.filters.colorIds.length?"bg-blue-600 text-white font-semibold shadow-lg hover:shadow-blue-500/25":"bg-gray-600 hover:bg-gray-500 text-gray-200 shadow-lg hover:shadow-gray-500/25"}">–í—Å–µ —Ü–≤–µ—Ç–∞</button>
                        <div class="max-h-60 overflow-y-auto no-scrollbar pr-1">
                            <div class="grid gap-2" style="grid-template-columns: repeat(auto-fill,minmax(180px,1fr));">
                                ${Object.keys(COLOR_MAP).sort((a,b)=>COLOR_MAP[a].name.localeCompare(COLOR_MAP[b].name,'en')).map(id=>{const c=COLOR_MAP[id];const sel=tempFilters.filters.colorIds.includes(id);return `
                                    <button data-action="modal-set-color" data-color-id="${id}" class="flex items-center gap-3 p-2 rounded-[18px] border ${sel?"border-blue-500 bg-blue-900/30":"border-gray-700 hover:border-gray-500"}">
                                        <span class="w-6 h-6 rounded-full border ${c.isTransparent?"checkerboard border-gray-500":"border-gray-500"} flex-shrink-0" style="background-color:${c.hex}; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border-radius: 50% !important;" onmouseover="this.style.boxShadow='0 4px 6px -1px ${c.hex}40, 0 2px 4px -1px ${c.hex}30'" onmouseout="this.style.boxShadow='0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'"></span>
                                        <span class="text-sm text-gray-200 truncate">${c.name}</span>
                                    </button>`}).join("")}
                            </div>
                        </div>
                     </div>
                </div>`
    }
    S.filterOpen = true;
    modalManager.openModal('filter-modal-container', filterModalEl);
    filterModalEl.innerHTML = `
            <div id="filter-modal-content" class="bg-gray-800 rounded-[18px] shadow-xl w-[calc(100%-2rem)] max-w-md flex flex-col max-h-[calc(100vh-2rem)] modal-content-enter">
                <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center">
                     <h2 class="text-xl font-bold text-white">–§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</h2>
                     <button id="filter-modal-close" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ñ–∏–ª—å—Ç—Ä–æ–≤">${I_X("w-4 h-4")}</button>
                </div>
                <div class="flex-grow p-4 overflow-y-auto no-scrollbar space-y-6">${e}</div>
                <div class="flex-shrink-0 p-4 border-t border-gray-700 flex justify-between items-center gap-4">
                    <button data-action="modal-reset-filters" class="px-4 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-600 hover:bg-gray-500 text-white shadow-lg hover:shadow-gray-500/25" title="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –∫ –∑–Ω–∞—á–µ–Ω–∏—è–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é">–°–±—Ä–æ—Å–∏—Ç—å</button>
                    <button data-action="modal-apply-filters" class="flex-grow px-4 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-blue-500/25" title="–ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
        `
}
function renderSettingsModal() {
    if (!S.settingsOpen) return void closeSettingsModal();
    const isFirstOpen = settingsModalEl.classList.contains('modal-hidden');
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–µ—Ä–≥–∞–Ω–∏—è
    const prevScrollTop = settingsModalEl.querySelector('#settings-modal-scroll')?.scrollTop || 0;
    
    S.settingsOpen = true;
    if (isFirstOpen) {
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
        hideSidebarHint();
        modalManager.openModal('settings-modal-container', settingsModalEl);
    }
    const {
        delConfirm: e,
        status: t,
        statusType: o
    } = S.settingsModal, l = Object.values(S.coll).reduce((e, t) => e + Object.keys(t).length, 0);
    const a = Object.keys(S.setColl).length;
    const i = Object.keys(S.minifigColl).length;
    let n = "";
    n = "parts" === e ? `
                <p class="text-yellow-300 text-sm text-center mb-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ</p>
                <div class="flex gap-2">
                    <button data-action="cancel-delete" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-gray-600 text-white">–û—Ç–º–µ–Ω–∞</button>
                    <button data-action="confirm-delete-parts" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ</button>
                </div>` : "all" === e ? `
                <p class="text-yellow-300 text-sm text-center mb-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –∏ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</p>
                <div class="flex gap-2">
                    <button data-action="cancel-delete" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-gray-600 text-white">–û—Ç–º–µ–Ω–∞</button>
                    <button data-action="confirm-delete-all" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-red-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–ì–û</button>
                </div>` : `<button data-action="delete-all-parts" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25 ${0===l?"opacity-50 cursor-not-allowed":""}" ${0===l?"disabled":""}" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ)">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏</button>`;
    let r = "";
    r = "sets" === e ? `
                <p class="text-yellow-300 text-sm text-center mb-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ</p>
                <div class="flex gap-2">
                    <button data-action="cancel-delete" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-gray-600 text-white">–û—Ç–º–µ–Ω–∞</button>
                    <button data-action="confirm-delete-sets" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ</button>
                </div>` : `<button data-action="delete-all-sets" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25 ${0===a?"opacity-50 cursor-not-allowed":""}" ${0===a?"disabled":""}" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–∞–±–æ—Ä—ã –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ)">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–∞–±–æ—Ä—ã</button>`;
    let s = "";
    s = "minifigs" === e ? `
                <p class="text-yellow-300 text-sm text-center mb-2">–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ</p>
                <div class="flex gap-2">
                    <button data-action="cancel-delete" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-gray-600 text-white">–û—Ç–º–µ–Ω–∞</button>
                    <button data-action="confirm-delete-minifigs" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ</button>
                </div>` : `<button data-action="delete-all-minifigs" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25 ${0===i?"opacity-50 cursor-not-allowed":""}" ${0===i?"disabled":""}" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ)">–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏</button>`;
    const c = "error" === o ? "bg-red-900/50 text-red-300" : "success" === o ? "bg-green-900/50 text-green-300" : "bg-blue-900/50 text-blue-300";
    const enterClass = isFirstOpen ? 'modal-content-enter' : '';
    settingsModalEl.innerHTML = `
             <div id="settings-modal-content" class="bg-gray-800 rounded-[18px] shadow-xl w-[calc(100%-2rem)] max-w-md flex flex-col max-h-[90vh] ${enterClass}">
                <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center">
                     <h2 class="text-xl font-bold text-white">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                     <div id="import-export-status" class="px-2 py-1 text-xs rounded-[18px] ${t?c:'bg-transparent text-transparent'} text-center flex-shrink-0" style="${t?'':'display: none;'}">${t||''}</div>
                     <button id="settings-modal-close" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫">${I_X("w-4 h-4")}</button>
                </div>
                <div id="settings-modal-scroll" class="flex-grow p-4 overflow-y-auto no-scrollbar space-y-6">
                     ${loadUserAccount() ? `
                     <div>
                        <h3 class="text-md font-semibold text-white mb-2 pl-0">–û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ</h3>
                        <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                            <p class="text-xs text-gray-400">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å –æ–±–ª–∞—á–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º. –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã —Å –ª—é–±–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</p>
                            <div class="grid grid-cols-2 gap-3">
                                <button data-action="load-from-cloud" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-cyan-600 hover:bg-cyan-500 text-white shadow-lg hover:shadow-cyan-500/25" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏–∑ –æ–±–ª–∞–∫–∞">
                                    ${I_CloudDownload("w-5 h-5 mr-2")} –ó–∞–≥—Ä—É–∑–∏—Ç—å
                                </button>
                                <button data-action="save-to-cloud" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-green-600 hover:bg-green-500 text-white shadow-lg hover:shadow-green-500/25" title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤ –æ–±–ª–∞–∫–æ">
                                    ${I_CloudUpload("w-5 h-5 mr-2")} –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                                </button>
                            </div>
                            <div id="cloud-backup-info" class="mt-2">
                                <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    <div>
                        <h3 class="text-md font-semibold text-white mb-2 pl-0">–ò–º–ø–æ—Ä—Ç –∏ —ç–∫—Å–ø–æ—Ä—Ç CSV</h3>
                        <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                            <p class="text-xs text-gray-400">–ò–º–ø–æ—Ä—Ç –∏ —ç–∫—Å–ø–æ—Ä—Ç –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV. –ò–º–ø–æ—Ä—Ç –æ–±—ä–µ–¥–∏–Ω–∏—Ç –¥–∞–Ω–Ω—ã–µ —Å –≤–∞—à–µ–π —Ç–µ–∫—É—â–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π</p>
                            <div class="grid grid-cols-2 gap-3">
                                <button data-action="import-csv" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg hover:shadow-emerald-500/25" title="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏–∑ CSV —Ñ–∞–π–ª–∞">
                                    ${I_Up("w-5 h-5 mr-2")} –ò–º–ø–æ—Ä—Ç
                                </button>
                                <button data-action="export-csv" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg hover:shadow-indigo-500/25" title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤ CSV —Ñ–∞–π–ª">
                                    ${I_Down("w-5 h-5 mr-2")} –≠–∫—Å–ø–æ—Ä—Ç
                                </button>
                                <button data-action="share-collection" class="col-span-2 w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-blue-500/25" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π —á–µ—Ä–µ–∑ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–µ—Ç–∏ –∏–ª–∏ —Å–∫–∞—á–∞—Ç—å CSV —Ñ–∞–π–ª">
                                    ${I_Share("w-5 h-5 mr-2")} –ü–µ—Ä–µ–¥–∞—Ç—å –≤ —Å–æ—Ü—Å–µ—Ç–∏
                                </button>
                                
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-md font-semibold text-white mb-2 pl-0">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h3>
                        <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-sm text-gray-300 flex items-center gap-2">${I_Menu('w-4 h-4 text-blue-400')} –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é</span>
                                <button data-action="toggle-sidebar-compact" class="toggle-switch ${S.sidebarCompact? 'on' : ''}" aria-pressed="${S.sidebarCompact}"><span class="knob"></span></button>
                            </div>
                            <div class="border-t border-gray-700/50 my-1"></div>
                            <div class="text-xs text-gray-400">–ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä</div>
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-sm text-gray-300 flex items-center gap-2">${I_Cat('w-4 h-4 text-blue-400')} –ö–∞—Ç–∞–ª–æ–≥</span>
                                <button data-action="toggle-catalog-multiselect" class="toggle-switch ${S.catalogMultiSelectEnabled? 'on' : ''}" aria-pressed="${S.catalogMultiSelectEnabled}"><span class="knob"></span></button>
                            </div>
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-sm text-gray-300 flex items-center gap-2">${I_Coll('w-4 h-4 text-teal-400')} –ö–æ–ª–ª–µ–∫—Ü–∏—è</span>
                                <button data-action="toggle-collection-multiselect" class="toggle-switch ${S.collectionMultiSelectEnabled? 'on' : ''}" aria-pressed="${S.collectionMultiSelectEnabled}"><span class="knob"></span></button>
                            </div>
                            <div class="flex items-center justify-between gap-2 hidden">
                                <span class="text-sm text-gray-300 flex items-center gap-2">${I_Star('w-4 h-4 text-yellow-400')} –°–ø–∏—Å–∫–∏ –∂–µ–ª–∞–Ω–∏–π</span>
                                <button data-action="toggle-wishlist" class="toggle-switch ${S.wishlistEnabled? 'on' : ''}" aria-pressed="${S.wishlistEnabled}"><span class="knob"></span></button>
                            </div>
                            <div class="border-t border-gray-700/50 my-1"></div>
                            <div class="text-xs text-gray-400">–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</div>
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-sm text-gray-300 flex items-center gap-2">${I_Folder('w-4 h-4 text-green-400')} –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ –ø–∞–ø–∫–∏</span>
                                <button data-action="toggle-folders" class="toggle-switch ${S.foldersEnabled? 'on' : ''}" aria-pressed="${S.foldersEnabled}"><span class="knob"></span></button>
                            </div>
                            <p class="text-xs text-gray-400">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –¥–µ—Ç–∞–ª–∏ —Å –±–æ–ª–µ–µ —á–µ–º 3‚Äë–º—è —Ü–≤–µ—Ç–∞–º–∏ –±—É–¥—É—Ç —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –ø–∞–ø–∫–∏. –ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ, –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-md font-semibold text-white mb-2 pl-0">–ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏</h3>
                        <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-sm text-gray-300 flex items-center gap-2">${I_Shield('w-4 h-4 text-blue-400')} –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—Ç—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É</span>
                                <button data-action="toggle-prevent-exit" class="toggle-switch ${S.preventAccidentalExit? 'on' : ''}" aria-pressed="${S.preventAccidentalExit}"><span class="knob"></span></button>
                            </div>
                            <p class="text-xs text-gray-400">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø–æ—Ç–µ—Ä—é –Ω–µ–∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ —Å–ª—É—á–∞–π–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-md font-semibold text-white mb-2 pl-0">–û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –∏ –¥–∞–Ω–Ω—ã–µ</h3>
                        <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                            <div class="text-xs text-gray-400">–û—á–∏—Å—Ç–∫–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</div>
                            <div class="bg-red-900/20 border border-red-600/30 rounded-[18px] p-3 space-y-3">
                               ${"all" !== e ? `<button data-action=\"delete-all-data\" class=\"w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white mb-3 shadow-lg hover:shadow-red-500/25\">
                                   ${I_Trash("w-5 h-5 mr-2")} –£–¥–∞–ª–∏—Ç—å –≤—Å—ë
                               </button>` : ""}
                               ${"all"===e ? `
                                   <div class=\"p-3\">
                                       <p class=\"text-yellow-300 text-sm text-center mb-2\">–í—ã —É–≤–µ—Ä–µ–Ω—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ –∏ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</p>
                                       <div class=\"flex gap-2\">
                                           <button data-action=\"cancel-delete\" class=\"w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-gray-600 text-white\">–û—Ç–º–µ–Ω–∞</button>
                                           <button data-action=\"confirm-delete-all\" class=\"w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25\">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–ì–û</button>
                                       </div>
                                   </div>
                               ` : `${n}${r}${s}`}
                            </div>
                            <div class="border-t border-gray-700/50 my-1"></div>
                            <div class="text-xs text-gray-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º</div>
                            <div class="space-y-3">
                                <p class="text-xs text-gray-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –º–µ—Å—Ç–∞</p>
                                <div id="network-status-row" class="flex items-center justify-between gap-3 mb-2">
                                    <span class="text-xs text-gray-300">–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã</span>
                                    <span id="settings-offline-indicator" class="text-xs font-semibold px-2 py-1 rounded-[18px] ${navigator.onLine ? 'bg-green-900/40 text-green-300' : 'bg-yellow-900/40 text-yellow-300'}">${navigator.onLine ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω'}</span>
                                </div>
                                <div class="flex gap-3">
                                    <button data-action="clear-app-cache" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25">
                                        –û—á–∏—Å—Ç–∏—Ç—å –∫—ç—à
                                    </button>
                                    <button data-action="refresh-csv-cache" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-gray-600 text-white shadow-lg hover:shadow-gray-500/25">
                                        –û–±–Ω–æ–≤–∏—Ç—å –∫—ç—à CSV
                                    </button>
                                </div>
                                <div id="cache-usage" class="text-xs text-gray-400"></div>
                            </div>
                            <div class="border-t border-gray-700/50 my-1"></div>
                            <div class="text-xs text-gray-400">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã</div>
                            <div class="space-y-3">
                                <p class="text-xs text-gray-400">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–∞–º–µ—Ä—ã –¥–ª—è DataMatrix —Å–∫–∞–Ω–µ—Ä–∞ –∏ AI –ø–æ–∏—Å–∫–∞</p>
                                <div class="flex gap-3">
                                    <button data-action="clear-camera-settings" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25">
                                        ${I_Camera("w-5 h-5 mr-2")} –û—á–∏—Å—Ç–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
                                    </button>
                                </div>
                                <div id="camera-settings-status" class="text-xs text-gray-400"></div>
                            </div>
                            <div class="border-t border-gray-700/50 my-1"></div>
                            <div class="text-xs text-gray-400">–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö</div>
                            <div class="bg-red-900/20 border border-red-600/30 rounded-[18px] p-3 space-y-3">
                                <p class="text-xs text-red-300">–û–ü–ê–°–ù–û: –£–¥–∞–ª—è–µ—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</p>
                                <div class="flex gap-3">
                                    <button data-action="clear-all-data" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-700 hover:bg-red-600 text-white shadow-lg hover:shadow-red-500/25">
                                        ${I_Trash("w-5 h-5 mr-2")} –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-md font-semibold text-white mb-2 pl-0">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h3>
                        <div class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] p-3 space-y-3">
                            <div class="flex items-center justify-between gap-2">
                                <span class="text-sm text-gray-300 flex items-center gap-2">${I_Globe('w-4 h-4 text-orange-400')} –í–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Å–∏</span>
                                <button data-action="toggle-proxy-enabled" class="toggle-switch ${S.proxyEnabled? 'on' : ''}" aria-pressed="${S.proxyEnabled}"><span class="knob"></span></button>
                            </div>
                            <p class="text-xs text-gray-400">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä—ã –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –æ–±—Ö–æ–¥–∞ –±–ª–æ–∫–∏—Ä–æ–≤–æ–∫ API. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤–∫–ª—é—á–∏—Ç—å, –µ—Å–ª–∏ –ø—Ä—è–º—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ API –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è.</p>
                        </div>
                    </div>
                    <div class="settings-button-container">
                        <button data-action="toggle-settings-stats" class="w-full flex items-center justify-between text-left text-md font-semibold text-gray-300 mb-2">
                            <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>
                            <span id="settings-stats-chevron" class="rotate">${I_Chev('w-5 h-5 text-gray-400')}</span>
                        </button>
                        <div id="settings-stats-panel" class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] space-y-2 text-sm collapse-panel">
                            
                            
                            ${(() => {
                                const stats = getLoadingStats();
                                const lastUpdate = stats.lastApiUpdate ? new Date(stats.lastApiUpdate).toLocaleString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞';
                                return `
                                    <div class="space-y-1">
                                        <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                                            <div class="flex items-center text-gray-300 text-xs">
                                                <div class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                                                –¶–≤–µ—Ç–∞:
                                            </div>
                                            <div class="text-white font-semibold text-xs">${stats.colors}</div>
                                        </div>
                                        <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                                            <div class="flex items-center text-gray-300 text-xs">
                                                <div class="w-2 h-2 rounded-full bg-blue-500 mr-2"></div>
                                                –ö–∞—Ç–µ–≥–æ—Ä–∏–∏:
                                            </div>
                                            <div class="text-white font-semibold text-xs">${stats.categories}</div>
                                        </div>
                                        <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                                            <div class="flex items-center text-gray-300 text-xs">
                                                <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                                                –¢–µ–º—ã:
                                            </div>
                                            <div class="text-white font-semibold text-xs">${stats.themes}</div>
                                        </div>
                                        <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                                            <div class="flex items-center text-gray-300 text-xs">
                                                <div class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></div>
                                                –î–µ—Ç–∞–ª–∏:
                                            </div>
                                            <div class="text-white font-semibold text-xs">${stats.parts}</div>
                                        </div>
                                        <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                                            <div class="flex items-center text-gray-300 text-xs">
                                                <div class="w-2 h-2 rounded-full bg-purple-500 mr-2"></div>
                                                –ù–∞–±–æ—Ä—ã:
                                            </div>
                                            <div class="text-white font-semibold text-xs">${stats.sets}</div>
                                        </div>
                                        <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                                            <div class="flex items-center text-gray-300 text-xs">
                                                <div class="w-2 h-2 rounded-full bg-pink-500 mr-2"></div>
                                                –ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏:
                                            </div>
                                            <div class="text-white font-semibold text-xs">${stats.minifigs}</div>
                                        </div>
                                        <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                                            <div class="flex items-center text-gray-300 text-xs">
                                                <div class="w-2 h-2 rounded-full bg-cyan-500 mr-2"></div>
                                                –†–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏:
                                            </div>
                                            <div class="text-white font-semibold text-xs">${PROXY_CONFIG.workingProxies.length}/${PROXY_CONFIG.proxies.length}</div>
                                        </div>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                    <div class="settings-button-container">
                        <button data-action="toggle-about" class="w-full flex items-center justify-between text-left text-md font-semibold text-gray-300 mb-2">
                            <span>–û —Å–∞–π—Ç–µ</span>
                            <span id="about-chevron" class="rotate">${I_Chev('w-5 h-5 text-gray-400')}</span>
                        </button>
                        <div id="about-panel" class="bg-gray-900/50 rounded-[18px] p-3 space-y-3 text-sm text-gray-400 collapse-panel">
                           <p>
                               –û–¥–Ω–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–µ –≤–µ–±‚Äë–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏ –≤–µ–¥–µ–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ LEGO
                           </p>
                           <ul class="list-disc list-outside pl-5 space-y-1">
                               <li><strong>–ö–∞—Ç–∞–ª–æ–≥ LEGO</strong> - –¥–µ—Ç–∞–ª–∏, –Ω–∞–±–æ—Ä—ã –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ —Å —É–º–Ω—ã–º –ø–æ–∏—Å–∫–æ–º</li>
                               <li><strong>–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</strong> - –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö</li>
                               <li><strong>–ú–æ–¥–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏</strong> - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ –∏ —Ü–≤–µ—Ç–∞–º–∏</li>
                               <li><strong>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong> - –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –¥–∏–∞–≥—Ä–∞–º–º—ã –∫–æ–ª–ª–µ–∫—Ü–∏–∏</li>
                               <li><strong>–ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä</strong> - –ø–∞–∫–µ—Ç–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏</li>
                               <li><strong>–ò–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç</strong> - CSV —Ñ–∞–π–ª—ã –∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ</li>
                               <li><strong>–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫</strong> - –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–≤–µ—Ç—ã –ø—Ä–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</li>
                               <li><strong>–ü—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ</strong> - offline —Ä–µ–∂–∏–º –∏ –±—ã—Å—Ç—Ä–∞—è –∑–∞–≥—Ä—É–∑–∫–∞</li>
                               <li><strong>–°–∫–∞–Ω–µ—Ä DataMatrix</strong> - —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π DataMatrix –∫–æ–¥–æ–≤ —Å–µ—Ä–∏–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫</li>
                               <li><strong>AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–æ —Ñ–æ—Ç–æ</strong> - –ø–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π, –∫–æ—Ä–æ–±–æ–∫ –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º</li>
                               <!-- <li><strong>–°–ø–∏—Å–∫–∏ –∂–µ–ª–∞–Ω–∏–π</strong> - —Å–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞–º–∏ –∂–µ–ª–∞–µ–º—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤</li> -->
                               <li><strong>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</strong> - –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ–∏—Å–∫–∞ –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</li>
                               <li><strong>–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω</strong> - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ –¥–µ—Å–∫—Ç–æ–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤</li>
                           </ul>
                        </div>
                    </div>
                    
                    <!-- –û—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è –¥–ª—è —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π -->
                    <div class="settings-button-container">
                        <button data-action="toggle-technologies" class="w-full flex items-center justify-between text-left text-md font-semibold text-gray-300 mb-2">
                            <span>–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</span>
                            <span id="technologies-chevron" class="rotate">${I_Chev('w-5 h-5 text-gray-400')}</span>
                        </button>
                        <div id="technologies-panel" class="bg-gray-800/60 border border-gray-700/50 rounded-[18px] space-y-3 text-sm collapse-panel">
                                   <p class="text-xs text-gray-400">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞—Ö –∏ API, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</p>
                                   
                                   <!-- –ö–∞–º–µ—Ä–∞ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
                                   <div class="space-y-2">
                                       <h4 class="text-sm font-medium text-gray-300 flex items-center gap-2">
                                           ${I_Camera('w-4 h-4 text-blue-400')} –ö–∞–º–µ—Ä–∞ –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                                       </h4>
                                       <div class="pl-6 space-y-1">
                                           <p class="text-xs text-gray-400">
                                               <strong>WebRTC API</strong> - –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                                           </p>
                                           <p class="text-xs text-gray-400">
                                               <strong>MediaDevices API</strong> - –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä–∞–º–∏ –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è–º–∏
                                           </p>
                                           <p class="text-xs text-gray-400">
                                               <strong>Canvas API</strong> - –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–æ–≤
                                           </p>
                                       </div>
                                   </div>
                                   
                                   <!-- AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ -->
                                   <div class="space-y-2">
                                       <h4 class="text-sm font-medium text-gray-300 flex items-center gap-2">
                                           ${I_Tech('w-4 h-4 text-purple-400')} AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ
                                       </h4>
                                       <div class="pl-6 space-y-1">
                                           <p class="text-xs text-gray-400">
                                               <strong>Brickognize API</strong> - –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π, –∫–æ—Ä–æ–±–æ–∫ –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ LEGO –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º
                                           </p>
                                           <p class="text-xs text-gray-400">
                                               <a href="https://brickognize.com/" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">brickognize.com</a> - –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
                                           </p>
                                           <p class="text-xs text-gray-400">
                                               –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫, –¥–µ—Ç–∞–ª–µ–π –∏ –Ω–∞–±–æ—Ä–æ–≤ LEGO
                                           </p>
                                       </div>
                                   </div>
                                   
                                   <!-- API –∏ –¥–∞–Ω–Ω—ã–µ -->
                                   <div class="space-y-2">
                                       <h4 class="text-sm font-medium text-gray-300 flex items-center gap-2">
                                           ${I_Cloud('w-4 h-4 text-cyan-400')} API –∏ –¥–∞–Ω–Ω—ã–µ
                                       </h4>
                                       <div class="pl-6 space-y-1">
                                           <p class="text-xs text-gray-400">
                                               <strong>Rebrickable API</strong> - –æ—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ –¥–µ—Ç–∞–ª—è—Ö LEGO
                                           </p>
                                           <p class="text-xs text-gray-400">
                                               <a href="https://rebrickable.com/api/" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">rebrickable.com/api</a> - –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π API —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö CSV
                                           </p>
                                           <p class="text-xs text-gray-400">
                                               <strong>RemoteStorage</strong> - –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –æ–±–ª–∞—á–Ω—ã–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º
                                           </p>
                                           <p class="text-xs text-gray-400">
                                               <a href="https://remotestorage.io/" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">remotestorage.io</a> - –æ—Ç–∫—Ä—ã—Ç—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
                                           </p>
                                       </div>
                                   </div>
                                   
                                   <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ -->
                                   <div class="space-y-2">
                                       <h4 class="text-sm font-medium text-gray-300 flex items-center gap-2">
                                           ${I_Toolbox('w-4 h-4 text-green-400')} –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
                                       </h4>
                                       <div class="pl-6 space-y-1">
                                           <p class="text-xs text-gray-400">
                                               <strong>IndexedDB</strong> - –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                                           </p>
                                           <p class="text-xs text-gray-400">
                                               <strong>Service Worker</strong> - –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ä–∞–±–æ—Ç—ã –æ—Ñ–ª–∞–π–Ω
                                           </p>
                                       </div>
                                   </div>
                        </div>
                    </div>
                    
                    <!-- –ö–Ω–æ–ø–∫–∞ GitHub –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Å–µ–∫—Ü–∏–∏ -->
                    <div class="pt-3 border-t border-gray-700/50 flex flex-col items-center justify-center gap-3 text-center">
                        <a href="https://github.com/Zeka3535/LEGO-Part-Catalog" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 px-4 py-3 rounded-[18px] bg-gray-700 hover:bg-gray-600 text-white transition-all duration-150 shadow-lg hover:shadow-gray-500/25 hover:scale-105 active:scale-95">
                            <svg class="w-5 h-5" viewBox="0 0 24 24" aria-hidden="true" fill="currentColor"><path d="M12 .5C5.73.5.98 5.24.98 11.5c0 4.85 3.15 8.96 7.52 10.41.55.1.75-.24.75-.53 0-.26-.01-1.13-.02-2.05-3.06.66-3.71-1.3-3.71-1.3-.5-1.26-1.22-1.6-1.22-1.6-1-.69.08-.68.08-.68 1.1.08 1.68 1.13 1.68 1.13.98 1.68 2.58 1.2 3.2.92.1-.71.38-1.2.69-1.48-2.44-.28-5-1.22-5-5.43 0-1.2.43-2.19 1.13-2.96-.11-.28-.49-1.41.11-2.94 0 0 .92-.29 3.02 1.13.88-.24 1.82-.36 2.76-.36.94 0 1.88.12 2.76.36 2.1-1.42 3.02-1.13 3.02-1.13.6 1.53.22 2.66.11 2.94.7.77 1.13 1.76 1.13 2.96 0 4.22-2.56 5.15-5 5.43.4.34.73 1.01.73 2.04 0 1.47-.01 2.65-.01 3.01 0 .29.2.64.75.53 4.37-1.45 7.52-5.56 7.52-10.41C23.02 5.24 18.27.5 12 .5z"/></svg>
                            <span class="font-semibold">GitHub –ø—Ä–æ–µ–∫—Ç–∞</span>
                        </a>
                    </div>
                </div>
            </div>
        `
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º —Ä–µ–Ω–¥–µ—Ä–µ
    if (!isFirstOpen) {
        const scrollEl = document.getElementById('settings-modal-scroll');
        if (scrollEl) scrollEl.scrollTop = prevScrollTop;
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"
    setTimeout(() => {
        const panel = document.getElementById('settings-stats-panel');
        const chevron = document.getElementById('settings-stats-chevron');
        
        if (panel) {
            const isOpen = localStorage.getItem('settingsStatsOpen') === 'true';
            if (isOpen) {
                panel.classList.add('open');
            } else {
                panel.classList.remove('open');
            }
        }
        
        if (chevron) {
            const isOpen = localStorage.getItem('settingsStatsOpen') === 'true';
            if (isOpen) {
                chevron.classList.add('rotate-180');
            } else {
                chevron.classList.remove('rotate-180');
            }
        }
        
    }, 0);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ "–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏"
    setTimeout(() => {
        const techPanel = document.getElementById('technologies-panel');
        const techChevron = document.getElementById('technologies-chevron');
        
        if (techPanel) {
            const isOpen = localStorage.getItem('technologiesOpen') === 'true';
            if (isOpen) {
                techPanel.classList.add('open');
            } else {
                techPanel.classList.remove('open');
            }
        }
        
        if (techChevron) {
            const isOpen = localStorage.getItem('technologiesOpen') === 'true';
            if (isOpen) {
                techChevron.classList.add('rotate-180');
            } else {
                techChevron.classList.remove('rotate-180');
            }
        }
        
    }, 0);
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ "–û —Å–∞–π—Ç–µ"
    setTimeout(() => {
        const aboutPanel = document.getElementById('about-panel');
        const aboutChevron = document.getElementById('about-chevron');
        
        if (aboutPanel) {
            const isOpen = localStorage.getItem('aboutOpen') === 'true';
            if (isOpen) {
                aboutPanel.classList.add('open');
            } else {
                aboutPanel.classList.remove('open');
            }
        }
        
        if (aboutChevron) {
            const isOpen = localStorage.getItem('aboutOpen') === 'true';
            if (isOpen) {
                aboutChevron.classList.add('rotate-180');
            } else {
                aboutChevron.classList.remove('rotate-180');
            }
        }
        
    }, 0);
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞/–∫—ç—à–∞ (–≤ –ú–ë)
    ;(async () => {
        try {
            if (navigator.storage && navigator.storage.estimate) {
                const est = await navigator.storage.estimate();
                const used = typeof est.usage === 'number' ? est.usage : 0;
                const quota = typeof est.quota === 'number' ? est.quota : 0;
                const usedMb = (used / (1024 * 1024)).toFixed(2);
                const quotaMb = quota ? (quota / (1024 * 1024)).toFixed(0) : '‚Äî';
                let cacheFiles = 0;
                try {
                    const cacheInfo = await window.getCacheInfo();
                    cacheFiles = Object.values(cacheInfo).reduce((sum, v) => sum + (typeof v === 'number' ? v : 0), 0);
                } catch {}
                const el = document.getElementById('cache-usage');
                if (el) el.textContent = `–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞: ${usedMb} –ú–ë${quota ? ` –∏–∑ ~${quotaMb} –ú–ë` : ''}${cacheFiles ? `, —Ñ–∞–π–ª–æ–≤ –≤ –∫—ç—à–µ: ${cacheFiles}` : ''}`;
            }
        } catch {}
    })();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
    updateCloudBackupInfo(); // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤ —Ñ–æ–Ω–µ
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    if (loadUserAccount() && !cloudStorageConnected && window.remoteStorageAvailable) {
        console.log('‚òÅÔ∏è Settings opened, checking saved cloud storage state');
        setTimeout(() => {
            checkSavedCloudStorageState().then((connected) => {
                if (connected) {
                    // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
                    setTimeout(() => {
                        checkBackupFreshness();
                    }, 1000);
                }
            });
        }, 200);
    } else if (loadUserAccount() && cloudStorageConnected) {
        // –ï—Å–ª–∏ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã, —Å—Ä–∞–∑—É –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
        console.log('‚òÅÔ∏è Settings opened, already connected, checking backup freshness');
        setTimeout(() => {
            checkBackupFreshness();
        }, 500);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã
    updateCameraSettingsStatus();
}

function updateFilterModalUI() {
    if (!S.filterOpen || !filterModalEl.innerHTML) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    filterModalEl.querySelectorAll('input[name="sort"]').forEach(e => {
        const input = e;
        input.checked = tempFilters.sortBy === input.value;
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–µ—Ç–∞–ª–µ–π
    if ("parts" === S.subView) {
        const e = filterModalEl.querySelector('input[data-action="modal-toggle-collection"]');
        e && (e.checked = tempFilters.filters.inCollectionOnly);
        const t = filterModalEl.querySelector('button[data-color-id="null"]');
        t && (t.className = `w-full mb-3 py-2 text-sm rounded-[18px] transition-colors ${0===tempFilters.filters.colorIds.length?"bg-blue-600 text-white font-semibold":"bg-gray-600 hover:bg-gray-500 text-gray-200"}`);
        filterModalEl.querySelectorAll('button[data-action="modal-set-color"]').forEach(el => {
            const e = el;
            const t = e.dataset.colorId;
            if (t && "null" !== t) {
                const o = tempFilters.filters.colorIds.includes(t),
                    l = COLOR_MAP[t];
                l && (e.className = `flex items-center gap-3 p-2 rounded-[18px] border ${o?"border-blue-500 bg-blue-900/30":"border-gray-700 hover:border-gray-500"}`)
            }
        })
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞–±–æ—Ä–æ–≤
    if ("sets" === S.subView) {
        const minYearInput = filterModalEl.querySelector('input[id="min-year"]');
        const maxYearInput = filterModalEl.querySelector('input[id="max-year"]');
        const minPartsInput = filterModalEl.querySelector('input[id="min-parts"]');
        const maxPartsInput = filterModalEl.querySelector('input[id="max-parts"]');
        
        if (minYearInput) minYearInput.value = tempFilters.setFilters.minYear || "";
        if (maxYearInput) maxYearInput.value = tempFilters.setFilters.maxYear || "";
        if (minPartsInput) minPartsInput.value = tempFilters.setFilters.minParts || "";
        if (maxPartsInput) maxPartsInput.value = tempFilters.setFilters.maxParts || "";
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
        filterModalEl.querySelectorAll('input[name="sort"]').forEach(input => {
            input.checked = tempFilters.sortBy === input.value;
        });
        
        console.log('Updated set filters UI:', tempFilters.setFilters);
        console.log('Updated sort UI:', tempFilters.sortBy);
    }
}

function updateModalPartially(e) {
    if (!S.selPartId) return;
    if (e.image) {
        const e = document.getElementById("modal-image-container");
        if (e) {
            const {
                imgUrl: t,
                loadingImg: o
            } = S.partModal;
            const l = PART_MAP[S.selPartId];
            e.dataset.imageUrl = t || "";
            e.innerHTML = `
                    ${o?`<div class="absolute inset-0 bg-gray-900/80 flex items-center justify-center z-10"><div class="loader !w-10 !h-10"></div></div>`:""}
                    <img ${getPartImageUrl(t)} alt="${l.name}" class="max-w-full max-h-full object-contain">
                     <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                       ${I_Search("w-10 h-10 text-white")}
                    </div>
                `
        }
    }
    if (e.colors) {
        const e = document.getElementById("color-selector-container");
        e && (e.innerHTML = renderColorSelector());
    }
    if (e.controls) {
        const e = document.getElementById("modal-controls-container");
        e && (e.innerHTML = renderModalControls())
    }
}

// –°–≤–∞–π–ø—ã –≤ –º–æ–¥–∞–ª–∫–µ –¥–µ—Ç–∞–ª–∏ (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∞—Ä–∏–∞—Ü–∏–π)
function setupPartImageSwipe() {
    try {
        const content = document.getElementById('modal-content');
        if (!content) return;
        const container = content.querySelector('#modal-image-container');
        if (!container) return;
        if (container._swipeBound) return;
        container._swipeBound = true;
        let startX = 0, startY = 0, startT = 0, swiping = false;
        const THRESH_X = 48, THRESH_Y = 40, THRESH_MS = 600;
        const onTouchStart = (ev) => {
            const t = ev.touches && ev.touches[0];
            if (!t) return;
            startX = t.clientX; startY = t.clientY; startT = Date.now();
            swiping = true;
        };
        const onTouchMove = (ev) => {
            if (!swiping) return;
            const t = ev.touches && ev.touches[0];
            if (!t) return;
            const dx = t.clientX - startX;
            const dy = Math.abs(t.clientY - startY);
            if (Math.abs(dx) > THRESH_X && dy < THRESH_Y) ev.preventDefault();
        };
        const onTouchEnd = (ev) => {
            if (!swiping) return; swiping = false;
            const t = ev.changedTouches && ev.changedTouches[0];
            if (!t) return;
            const dt = Date.now() - startT;
            const dx = t.clientX - startX;
            const dy = Math.abs(t.clientY - startY);
            if (dt <= THRESH_MS && Math.abs(dx) > THRESH_X && dy < THRESH_Y) {
                ev.preventDefault(); ev.stopPropagation();
                if (dx < 0) tryAdvancePartVariantNext(); else tryAdvancePartVariantPrev();
            }
        };
        container.addEventListener('touchstart', onTouchStart, { passive: true });
        container.addEventListener('touchmove', onTouchMove, { passive: false });
        container.addEventListener('touchend', onTouchEnd, { passive: false });
    } catch (_) {}
}
function updateModalControlsState() {
    if (!S.selPartId || !S.partModal.selColorId) return;
    const e = S.coll[S.selPartId]?.[S.partModal.selColorId] || 0,
        t = document.getElementById("modal-in-collection-qty");
    t && (t.textContent = String(e));
    const o = document.getElementById("modal-update-collection-btn");
    o && (o.textContent = e > 0 ? "–û–±–Ω–æ–≤–∏—Ç—å" : "–î–æ–±–∞–≤–∏—Ç—å");
    const l = document.getElementById("modal-delete-container");
    if (l) {
        const t = '<button data-action="delete-from-collection-modal" class="mt-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded-[18px] py-1.5 px-3 transition-colors duration-150 shadow-lg hover:shadow-red-500/25">–£–¥–∞–ª–∏—Ç—å –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏</button>';
        e > 0 ? l.innerHTML.trim() || (l.innerHTML = t) : l.innerHTML = ""
    }
    const a = document.getElementById("modal-quantity-input");
    a && (a.value = String(S.partModal.qty));
    
    // –ü–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
    const controlsContainer = document.getElementById("modal-controls-container");
    if (controlsContainer) {
        controlsContainer.innerHTML = renderModalControls();
    }
}

function renderMinifigModal(e = !1) {
    if (!S.selFigNum) return void closeMinifigModal();
    const t = MINIFIG_MAP[S.selFigNum];
    if (!t) return void closeMinifigModal();
    const o = e ? "modal-content-enter" : "",
        l = "inventory" === S.minifigModal.view;
    e && (document.body.classList.add("overflow-hidden"), minifigModalEl.classList.remove("modal-hidden"), minifigModalEl.style.zIndex = '50', requestAnimationFrame(() => minifigModalEl.classList.add("visible"))), minifigModalEl.innerHTML = `
        <div id="minifig-modal-content" class="bg-gray-800 rounded-[18px] shadow-xl w-[calc(100%-2rem)] ${l?"max-w-2xl":"max-w-4xl"} flex flex-col ${l?"h-[calc(100vh-4rem)]":"max-h-[calc(100vh-2rem)]"} ${o} transition-all duration-300">
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center gap-4">
                 <h2 class="text-xl lg:text-2xl font-bold text-white truncate pr-4 modal-title-multiline">${t.name}</h2>
                 <div class="flex items-center gap-2 flex-shrink-0">
                    ${renderMinifigModalToggleButton()}
                    <button data-action="share-minifig" class="text-gray-300 hover:text-white transition-colors" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–æ–π —á–µ—Ä–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏ CSV —Ñ–∞–π–ª">${I_Share("w-6 h-6")}</button>
                    <button id="minifig-modal-close" class="modal-close-btn ${e?"animate-once":""}" title="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏">${I_X("w-4 h-4")}</button>
                 </div>
            </div>
            <div id="minifig-scroll-progress"><div class="bar"></div></div>
            <div id="minifig-modal-view-container" class="flex-grow overflow-y-auto no-scrollbar" style="min-height: 0;">
            </div>
        </div>
        `, updateMinifigModalView()
}

function updateMinifigModalView() {
    if (!S.selFigNum) return;
    const e = document.getElementById("minifig-modal-view-container");
    if (!e) return;
    if ("details" === S.minifigModal.view) {
        e.innerHTML = renderMinifigModalDetailsView();
        if (S.selFigNum) {
            const hasGallery = Array.isArray(S.minifigModal.gallery) && S.minifigModal.gallery.length > 0;
            if (!hasGallery) initMinifigImageGallery(S.selFigNum);
            else {
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                setTimeout(() => { applyMinifigGalleryImageToDom(); }, 0);
                setTimeout(() => { applyMinifigGalleryImageToDom(); }, 100);
                setTimeout(() => { applyMinifigGalleryImageToDom(); }, 300);
            }
        }
        setTimeout(() => { setupMinifigImageSwipe(); }, 0);
    } else {
        e.innerHTML = renderMinifigModalInventoryView();
    }
}

function renderMinifigModalToggleButton() {
    const e = MINIFIG_MAP[S.selFigNum];
    return e ? "details" === S.minifigModal.view ? `<button data-action="toggle-minifig-modal-view" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-gray-600 hover:bg-gray-500 text-white shadow-lg hover:shadow-gray-500/25">
                ${I_Brick("w-5 h-5")}
                <span>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</span>
                <span class="text-xs bg-gray-700 text-gray-200 px-1.5 py-0.5 rounded-full">${e.num_parts}</span>
            </button>` : `<button data-action="toggle-minifig-modal-view" class="flex items-center gap-2 px-3 py-1.5 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-blue-600 hover:bg-blue-700 text-white shadow-lg hover:shadow-blue-500/25">
                ${I_Cat("w-5 h-5")}
                <span>–î–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏</span>
            </button>` : ""
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
function getRelatedSetsForMinifig(figNum) {
    if (!window.INVENTORY_DATA || !window.INVENTORY_DATA.minifigs) {
        return [];
    }
    
    const relatedSets = [];
    const inventoryMinifigs = window.INVENTORY_DATA.minifigs;
    
    // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è–º, –≥–¥–µ –µ—Å—Ç—å —ç—Ç–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞
    Object.keys(inventoryMinifigs).forEach(inventoryId => {
        const minifigs = inventoryMinifigs[inventoryId];
        const hasMinifig = minifigs.some(m => m.fig_num === figNum);
        
        if (hasMinifig) {
            // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –Ω–∞–±–æ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            if (window.INVENTORY_DATA.sets && window.INVENTORY_DATA.sets[inventoryId]) {
                const sets = window.INVENTORY_DATA.sets[inventoryId];
                sets.forEach(set => {
                    if (SET_MAP[set.set_num]) {
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–∞–±–æ—Ä–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                        relatedSets.push(SET_MAP[set.set_num]);
                    }
                });
            }
        }
    });
    
    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≥–æ–¥—É
    const uniqueSets = relatedSets.filter((set, index, self) => 
        index === self.findIndex(s => s.set_num === set.set_num)
    ).sort((a, b) => (b.year || 0) - (a.year || 0));
    
    return uniqueSets;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
function showRelatedSetsModal(relatedSets, entityName, entityLabel = "–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–æ–π") {
    if (!relatedSets || relatedSets.length === 0) return;
    
    // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ (–≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
    hideSidebarHint();
    
    modalManager.openModal('related-sets-modal-container', relatedSetsModalEl);
    
    const setsList = relatedSets.map(set => `
        <div class="flex items-center bg-gray-700/50 p-3 rounded-[18px] gap-3 hover:bg-gray-700/70 transition-colors cursor-pointer"
             data-action="open-set-from-related"
             data-set-num="${set.set_num}">
            <div class="w-16 h-16 bg-white rounded-[18px] flex items-center justify-center flex-shrink-0">
                <img ${getPartImageUrl(SET_MAP[set.set_num]?.set_img_url || '')} alt="${set.name}" class="w-full h-full object-contain p-1">
            </div>
            <div class="flex-grow min-w-0">
                <p class="text-white font-semibold truncate">${set.name}</p>
                <p class="text-gray-400 text-sm">${set.set_num}</p>
                <div class="flex items-center gap-2 text-xs text-gray-500">
                    ${set.year ? `<span>${set.year}</span>` : ''}
                    ${set.theme_name ? `<span>‚Ä¢ ${set.theme_name}</span>` : ''}
                </div>
            </div>
        </div>
    `).join('');
    
    relatedSetsModalEl.innerHTML = `
        <div class="bg-gray-800 rounded-[18px] shadow-xl w-[calc(100%-2rem)] max-w-2xl flex flex-col max-h-[calc(100vh-2rem)] modal-content-enter relative">
            <div id="related-sets-scroll-progress"><div class="bar"></div></div>
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">–ù–∞–±–æ—Ä—ã —Å ${entityLabel} "${entityName}"</h2>
                <button id="related-sets-modal-close" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤">${I_X("w-4 h-4")}</button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto no-scrollbar space-y-3">
                ${setsList}
            </div>
        </div>
    `;

    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–µ—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∏ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏—è
    try {
        const ind = document.getElementById('settings-offline-indicator');
        if (ind) {
            const updateNetInSettings = () => {
                if (navigator.onLine) {
                    ind.textContent = '–û–Ω–ª–∞–π–Ω';
                    ind.className = 'text-xs font-semibold px-2 py-1 rounded-[18px] bg-green-900/40 text-green-300';
                } else {
                    ind.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–µ–Ω';
                    ind.className = 'text-xs font-semibold px-2 py-1 rounded-[18px] bg-yellow-900/40 text-yellow-300';
                }
            };
            updateNetInSettings();
            window.addEventListener('online', updateNetInSettings, { once: true });
            window.addEventListener('offline', updateNetInSettings, { once: true });
        }
    } catch {}
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–∫—Ä–æ–ª–ª-–ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
    setupRelatedSetsScrollProgress();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤ –¥–µ—Ç–∞–ª–∏
function getRelatedSetsForPart(partId) {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
    if (!window.INVENTORY_DATA || !window.INVENTORY_DATA.parts) {
        return [];
    }
    const relatedSets = [];
    const inventoryParts = window.INVENTORY_DATA.parts;
    // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è–º, –≥–¥–µ –µ—Å—Ç—å —ç—Ç–∞ –¥–µ—Ç–∞–ª—å (–±–µ–∑ —É—á–µ—Ç–∞ –∑–∞–ø—á–∞—Å—Ç–µ–π)
    Object.keys(inventoryParts).forEach(inventoryId => {
        const items = inventoryParts[inventoryId];
        if (!Array.isArray(items)) return;
        const hasPart = items.some(item => item.part_num === partId);
        if (hasPart) {
            if (window.INVENTORY_DATA.sets && window.INVENTORY_DATA.sets[inventoryId]) {
                const sets = window.INVENTORY_DATA.sets[inventoryId];
                sets.forEach(set => {
                    const full = SET_MAP[set.set_num];
                    if (full) relatedSets.push(full);
                });
            }
        }
    });
    // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
    const uniqueSets = relatedSets.filter((set, index, self) =>
        index === self.findIndex(s => s.set_num === set.set_num)
    ).sort((a, b) => (parseInt(b.year) || 0) - (parseInt(a.year) || 0));
    return uniqueSets;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ–¥–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ —Å–∞–º—ã–º —Å—Ç–∞—Ä—ã–º —Å–≤—è–∑–∞–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–∞–º
function getFirstAppearanceYearForMinifig(figNum) {
    try {
        const sets = getRelatedSetsForMinifig(figNum) || [];
        const years = sets.map(s => parseInt(s.year) || 0).filter(y => y > 0);
        if (years.length === 0) return null;
        return Math.min(...years);
    } catch (_) { return null; }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≥–æ–¥–∞ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–∏ –ø–æ —Å–∞–º—ã–º —Å—Ç–∞—Ä—ã–º —Å–≤—è–∑–∞–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–∞–º
function getFirstAppearanceYearForPart(partId) {
    try {
        const sets = getRelatedSetsForPart(partId) || [];
        const years = sets.map(s => parseInt(s.year) || 0).filter(y => y > 0);
        if (years.length === 0) return null;
        return Math.min(...years);
    } catch (_) { return null; }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫—Ä–æ–ª–ª-–ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
function setupRelatedSetsScrollProgress() {
    const track = document.getElementById('related-sets-scroll-progress');
    const content = relatedSetsModalEl.querySelector('.bg-gray-800');
    if (track && content) {
        const header = content.querySelector('.border-b');
        const headerH = header?.offsetHeight || 0;
        const top = Math.max(12, headerH + 8);
        track.style.top = top + 'px';
        track.style.bottom = '12px';
    }
    
    const scrollArea = content?.querySelector('.overflow-y-auto');
    const bar = track?.querySelector('.bar');
    
    const update = () => {
        if (!track || !bar || !scrollArea) return;
        const max = scrollArea.scrollHeight - scrollArea.clientHeight;
        const percent = max <= 0 ? 100 : Math.min(100, Math.max(0, (scrollArea.scrollTop / max) * 100));
        const containerH = track.clientHeight || 0;
        const barH = bar.clientHeight || 24;
        const maxOffset = Math.max(0, containerH - barH);
        const translatePx = (percent / 100) * maxOffset;
        bar.style.transform = `translateY(${translatePx}px)`;
    };
    
    update();
    
    let to;
    const onScroll = () => {
        track?.classList.add('visible');
        update();
        clearTimeout(to);
        to = setTimeout(() => track?.classList.remove('visible'), 200);
    };
    
    scrollArea?.addEventListener('scroll', onScroll, { passive: true });
    
    const obs = new MutationObserver(update);
    scrollArea && obs.observe(scrollArea, { childList: true, subtree: true });
    
    window.addEventListener('resize', () => { update(); }, { passive: true });
}

function renderMinifigModalDetailsView() {
    if (!S.selFigNum) return "";
    const e = MINIFIG_MAP[S.selFigNum];
    const {
        qty: t
    } = S.minifigModal;
    const o = S.minifigColl[S.selFigNum]?.qty || 0;
    const l = `
        <div class="bg-gray-700/50 rounded-[18px] p-3 sm:p-4 md:p-3 lg:p-4 xl:p-5">
            <div class="space-y-3 sm:space-y-4 md:space-y-3 lg:space-y-4">
                <!-- Header -->
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 sm:gap-3">
                    <h3 class="text-sm sm:text-base md:text-base lg:text-lg font-semibold text-white flex items-center justify-between w-full gap-2 sm:gap-3">
                        <div class="flex items-center gap-2 sm:gap-3">
                            ${I_Minifig("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5 text-blue-400")}
                            <span class="hidden sm:inline">–ö–æ–ª–ª–µ–∫—Ü–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫</span>
                            <span class="sm:hidden">–ö–æ–ª–ª–µ–∫—Ü–∏—è</span>
                        </div>
                        <span class="text-xs sm:text-sm md:text-sm lg:text-base text-gray-400">
                            (–í –∫–æ–ª–ª–µ–∫—Ü–∏–∏: <span class="font-bold text-white">${o}</span>)
                        </span>
                    </h3>
                </div>
                
                <!-- Controls -->
                <div class="flex flex-col gap-3 sm:gap-4">
                    <!-- Quantity Controls -->
                    <div class="flex items-center justify-center gap-2 sm:gap-3">
                        <button data-action="decrease-minifig-qty"
                            class="p-2 sm:p-2.5 md:p-2 lg:p-2.5 rounded-full ${t > 0 ? 'bg-gray-600 hover:bg-gray-500 shadow-lg hover:shadow-gray-500/25' : 'bg-gray-700 cursor-not-allowed'} text-white transition-all duration-150 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center"
                            ${t <= 0 ? 'disabled' : ''}
                            title="–£–º–µ–Ω—å—à–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                            ${I_Minus("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5")}
                        </button>

                        <input type="number"
                            value="${t}"
                            readonly
                            class="w-14 sm:w-16 md:w-16 lg:w-18 text-center bg-gray-900 text-white font-bold rounded-[18px] py-2 sm:py-2.5 md:py-2 lg:py-2.5 text-sm sm:text-base md:text-sm lg:text-base min-h-[44px] border border-gray-600 focus:border-blue-500 focus:outline-none"/>

                        <button data-action="increase-minifig-qty"
                            class="p-2 sm:p-2.5 md:p-2 lg:p-2.5 rounded-full bg-gray-600 hover:bg-gray-500 text-white transition-all duration-150 shadow-lg hover:shadow-gray-500/25 touch-manipulation min-w-[44px] min-h-[44px] flex items-center justify-center"
                            title="–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ">
                            ${I_Plus("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5")}
                        </button>
                    </div>

                    <!-- Action Buttons Row -->
                    <div class="flex gap-2 sm:gap-3">
                        <!-- Update Button -->
                        <button data-action="update-minifig-collection"
                            class="flex items-center justify-center gap-2 sm:gap-3 bg-blue-600 text-white font-bold py-3 sm:py-3.5 md:py-3 lg:py-3.5 px-3 sm:px-4 md:px-4 lg:px-5 rounded-[18px] hover:bg-blue-700 transition-all duration-150 shadow-lg hover:shadow-blue-500/25 touch-manipulation text-sm sm:text-base md:text-sm lg:text-base min-h-[48px] sm:min-h-[52px] flex-1">
                            ${o>0 ? I_Refresh("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5") : I_Plus("w-4 h-4 sm:w-5 sm:h-5 md:w-4 md:h-4 lg:w-5 lg:h-5")}
                            <span class="hidden sm:inline">${o>0 ? "–û–±–Ω–æ–≤–∏—Ç—å" : (t > 1 ? "–î–æ–±–∞–≤–∏—Ç—å "+t : "–î–æ–±–∞–≤–∏—Ç—å")}</span>
                            <span class="sm:hidden">${o>0 ? "–û–±–Ω–æ–≤–∏—Ç—å" : (t > 1 ? "–î–æ–±–∞–≤–∏—Ç—å "+t : "–î–æ–±–∞–≤–∏—Ç—å")}</span>
                        </button>

                        <!-- Delete Button -->
                        ${o>0?`
                            <button data-action="delete-from-minifig-collection-modal"
                                class="flex items-center justify-center gap-1 sm:gap-2 text-xs sm:text-sm md:text-sm lg:text-base bg-red-600 hover:bg-red-700 text-white rounded-[18px] py-2 sm:py-2.5 md:py-2 lg:py-2.5 px-2 sm:px-3 md:px-3 lg:px-4 transition-all duration-150 shadow-lg hover:shadow-red-500/25 touch-manipulation min-h-[48px] sm:min-h-[52px] flex-3"
                                title="${t > 1 ? "–£–¥–∞–ª–∏—Ç—å "+t+" –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫" : "–£–¥–∞–ª–∏—Ç—å –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É"}">
                                ${I_Trash("w-3 h-3 sm:w-4 sm:h-4 md:w-3 md:h-3 lg:w-4 lg:h-4")}
                                <span class="hidden sm:inline">${t > 1 ? "–£–¥–∞–ª–∏—Ç—å "+t : "–£–¥–∞–ª–∏—Ç—å"}</span>
                                <span class="sm:hidden">${t > 1 ? "–£–¥–∞–ª–∏—Ç—å "+t : "–£–¥–∞–ª–∏—Ç—å"}</span>
                            </button>
                        `:""}
                    </div>
                </div>
                
                <!-- Info Text -->
                <div class="text-xs text-gray-400 text-center leading-relaxed px-2 sm:px-4">
                    ${o>0 ? 
                        (t > 1 ? 
                            `–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏ –µ—ë –¥–µ—Ç–∞–ª–µ–π –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏. –£–¥–∞–ª–µ–Ω–∏–µ —É–±–µ—Ä–µ—Ç ${t} ${(() => {
                                const getMinifigWord = (count) => {
                                    if (count === 1) return "–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É";
                                    if (count >= 2 && count <= 4) return "–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏";
                                    return "–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫";
                                };
                                return getMinifigWord(t);
                            })()} –∏ –¥–µ—Ç–∞–ª–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏` :
                            "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏ –µ—ë –¥–µ—Ç–∞–ª–µ–π –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏. –£–¥–∞–ª–µ–Ω–∏–µ —É–±–µ—Ä–µ—Ç –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É –∏ –µ—ë –¥–µ—Ç–∞–ª–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏"
                        ) : 
                        (t > 1 ? 
                            `–î–æ–±–∞–≤–ª–µ–Ω–∏–µ ${t} ${(() => {
                                const getMinifigWord = (count) => {
                                    if (count === 1) return "–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É";
                                    if (count >= 2 && count <= 4) return "–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏";
                                    return "–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫";
                                };
                                return getMinifigWord(t);
                            })()} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç –∏—Ö –≤ –º–µ—Å—Ç–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é` :
                            "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–∏—Ç –µ—ë –≤ –º–µ—Å—Ç–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é"
                        )
                    }
                </div>
            </div>
        </div>`;
    return `
        <div class="flex flex-col lg:flex-row">
            <div class="lg:w-1/2 p-4 sm:p-6 bg-gray-900/30 flex items-center justify-center flex-col gap-2 flex-1 lg:flex-shrink-0 border-b lg:border-b-0 lg:border-r border-gray-700">
                 <div class="relative">
                    <button data-action="minifig-gallery-prev" class="set-gallery-btn absolute left-[-3rem] top-1/2 p-2 sm:p-1.5 rounded-full bg-gray-700 hover:bg-gray-600 text-white shadow-lg inline-flex z-20 select-none focus:outline-none" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="display: none;">
                        ${I_ChevronLeft("w-6 h-6 sm:w-5 sm:h-5")}
                    </button>
                    <div data-action="view-image-fullscreen" data-image-url="${e.minifig_img_url||e.set_img_url||""}" class="w-48 h-48 sm:w-64 sm:h-64 bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-lg relative cursor-pointer group mx-auto">
                        <img ${getPartImageUrl(e.minifig_img_url || e.set_img_url)} alt="${e.name}" class="max-w-full max-h-full object-contain">
                        <div class="absolute inset-0 bg-black/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                           ${I_Search("w-10 h-10 text-white")}
                        </div>
                    </div>
                    <div class="flex items-center justify-center mt-2 w-full">
                        <div id="minifig-gallery-dots" class="flex items-center justify-center gap-1.5" style="opacity: 0; transform: translateY(6px); height: 12px;"></div>
                    </div>
                    <button data-action="minifig-gallery-next" class="set-gallery-btn absolute right-[-3rem] top-1/2 p-2 sm:p-1.5 rounded-full bg-gray-700 hover:bg-gray-600 text-white shadow-lg inline-flex z-20 select-none focus:outline-none" title="–°–ª–µ–¥—É—é—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" style="display: none;">
                        ${I_ChevronRight("w-6 h-6 sm:w-5 sm:h-5")}
                    </button>
                 </div>
                 ${(!e.minifig_img_url && !e.set_img_url) ? `
                 <div class="mt-3 text-center">
                     <button data-action="refresh-minifig-image" class="text-xs px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-[18px] transition-colors">
                         ${I_Refresh("w-4 h-4 inline mr-1")} –û–±–Ω–æ–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                     </button>
                 </div>
                 ` : ''}
            </div>
            <div class="lg:w-1/2 p-4 sm:p-6 flex flex-col">
                <div class="space-y-6">
                    <div>
                        <h3 class="text-md font-semibold text-gray-300 mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        <div class="space-y-1 text-sm text-gray-400">
                            <p><span class="font-semibold text-gray-300">–ù–∞–∑–≤–∞–Ω–∏–µ:</span> ${e.name}</p>
                            <p>ID: ${e.set_num}</p>
                            ${(() => {
                                // –ì–æ–¥ –ø–µ—Ä–≤–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ ‚Äî –º–∏–Ω–∏–º—É–º –ø–æ –≥–æ–¥–∞–º —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
                                const y = getFirstAppearanceYearForMinifig(S.selFigNum);
                                return y ? `<p>–ì–æ–¥: ${y}</p>` : '';
                            })()}
                            <p>–ö–æ–ª-–≤–æ –¥–µ—Ç–∞–ª–µ–π: ${e.num_parts}</p>
                            ${(() => {
                                const relatedSets = getRelatedSetsForMinifig(S.selFigNum);
                                console.log('Related sets for', S.selFigNum, ':', relatedSets);
                                if (relatedSets.length > 0) {
                                    return `<div class="mt-2">
                                        <button data-action="show-related-sets" class="flex items-center gap-2 px-2 py-1 text-xs font-semibold rounded-[18px] bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-150 shadow-lg hover:shadow-blue-500/25">
                                            ${I_Set("w-3 h-3")}
                                            ${relatedSets.length === 1 ? '–°–≤—è–∑–∞–Ω–Ω—ã–π –Ω–∞–±–æ—Ä: 1' : `–°–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤: ${relatedSets.length}`}
                                        </button>
                                    </div>`;
                                }
                                return '';
                            })()}
                        </div>
                    </div>
                    ${l}
                </div>
            </div>
        </div>`
}
function renderMinifigModalInventoryView() {
    const {
        inv: e,
        loadingInv: t,
        invError: o,
        bulkUpdate: l,
        status: a,
        statusType: i
    } = S.minifigModal;
    const n = MINIFIG_MAP[S.selFigNum];
    let r = "";
    if (t) {
        r = `<div class="flex items-center justify-center h-full p-4"><div class="loader"></div></div>`;
    } else if (o) {
        r = `<div class="text-center p-4">
                <p class="text-red-400 mb-3">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å.</p>
                <button data-action="retry-load-minifig-inv" class="bg-blue-600 text-white px-4 py-2 rounded-[18px] hover:bg-blue-700">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            </div>`;
    } else if (e) {
        if (e.length === 0) {
            r = `<p class="text-gray-400 text-center p-4">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –¥–ª—è —ç—Ç–æ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.</p>`;
        } else {
            // –°–Ω–∞—á–∞–ª–∞ –æ–±—ã—á–Ω—ã–µ, –∑–∞—Ç–µ–º –∑–∞–ø–∞—Å–Ω—ã–µ
            const regular = e.filter(p => !p.is_spare);
            const spares = e.filter(p => p.is_spare);
            const renderRow = (e, isSpare=false) => `
                <div class="flex items-center bg-gray-700/50 p-2 rounded-[18px] gap-3 text-sm cursor-pointer hover:bg-gray-700/70"
                     data-action="open-part-from-inventory"
                     data-part-id="${e.part.part_num}"
                     data-color-id="${e.color.id}"
                     data-quantity="${e.quantity}">
                    <div class="w-10 h-10 bg-white rounded-[18px] flex items-center justify-center flex-shrink-0 overflow-hidden">
                        <img ${getPartImageUrl(e.part.part_img_url)} alt="${e.part.name}" class="w-full h-full object-contain p-1 rounded-[18px]">
                    </div>
                    <div class="flex-grow truncate">
                        <p class="text-white font-semibold truncate">${e.part.name}</p>
                        <p class="text-gray-400 truncate">${e.part.part_num}</p>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="w-5 h-5 rounded-full border border-gray-500 ${e.color.isTransparent?"checkerboard":""}" style="background-color: ${e.color.hex};" title="${e.color.name}"></span>
                        <span class="text-gray-300 w-8 text-right">${e.quantity}x</span>
                    </div>
                </div>`;
            const regularHtml = regular.map(p => renderRow(p)).join("");
            const sparesHtml = spares.length ? `
                <div class="pt-2">
                    <div class="text-xs text-gray-400 uppercase tracking-wide mb-1 flex items-center justify-center gap-1">${I_Alert("w-3 h-3 text-yellow-400")} –ó–∞–ø–∞—Å–Ω—ã–µ</div>
                    <div class="space-y-2">${spares.map(p => renderRow(p, true)).join("")}</div>
                </div>` : '';
            r = `<div class="space-y-2">${regularHtml}${sparesHtml}</div>`;
        }
    }
    return `
        <div class="p-4 space-y-4">
            <div class="flex justify-between items-center bg-gray-700/50 p-3 rounded-[18px]">
                <h3 class="text-lg font-semibold text-white">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –¥–µ—Ç–∞–ª–µ–π</h3>
                ${l?`<div class="flex items-center gap-2 text-sm text-gray-300">
                        <div class="loader !w-4 !h-4 !border-2"></div>
                        <span>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...</span>
                    </div>`: (e && e.length > 0) ? `
                    <button data-action="add-minifig-parts-modal" class="flex items-center gap-2 text-sm px-3 py-1.5 rounded-[18px] bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-150 shadow-lg hover:shadow-blue-500/25 disabled:opacity-50" ${l?"disabled":""}>
                        ${I_Plus("w-4 h-4")}
                        <span>–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é</span>
                    </button>`: ""}
            </div>
            ${a?`<div class="p-2 text-sm rounded-[18px] ${"error"===i?"bg-red-900/50 text-red-300":"bg-green-900/50 text-green-300"}">${a}</div>`:""}
            ${r}
        </div>`;
}
function updateUI() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    if (window.UI_BLOCKED) {
        console.log('üö´ updateUI blocked by global flag');
        return;
    }
    
    console.log('üîÑ updateUI called, view:', S.view, 'subView:', S.subView, 'loading:', S.loading);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞
    const loadingContainer = document.getElementById('loading-container');
    if (loadingContainer && !loadingContainer.classList.contains('hidden')) {
        console.log('üì± Loading container visible, rendering sidebar and header');
        // –í—Å–µ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –Ω–æ —Ä–µ–Ω–¥–µ—Ä–∏–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        renderSidebar();
        renderHeader();
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏
        setupSidebarDuringLoading();
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if (Object.keys(PART_MAP).length === 0 || Object.keys(SET_MAP).length === 0 || Object.keys(MINIFIG_MAP).length === 0) {
        console.warn('‚ö†Ô∏è Data not loaded yet, waiting...');
        console.log('üìä PART_MAP size:', Object.keys(PART_MAP).length);
        console.log('üì¶ SET_MAP size:', Object.keys(SET_MAP).length);
        console.log('üë§ MINIFIG_MAP size:', Object.keys(MINIFIG_MAP).length);
        
        // –†–µ–Ω–¥–µ—Ä–∏–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        renderSidebar();
        renderHeader();
        setupSidebarDuringLoading();
        
        console.log('‚è∞ Scheduling updateUI retry in 100ms');
        setTimeout(updateUI, 100);
        return;
    }
    
    console.log('Data loaded, proceeding with UI update');
    console.log('PART_MAP size:', Object.keys(PART_MAP).length);
    console.log('Sample parts with images:', Object.values(PART_MAP).slice(0, 3).map(p => ({
        id: p.id,
        name: p.name,
        hasImage: !!(p.part_img_url || p.rebrickable_img_url)
    })));
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –µ—â–µ –Ω–µ –±—ã–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
    if (!window.globalSortingApplied) {
        console.log('üìÖ Applying global sorting in updateUI...');
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –Ω–∞–±–æ—Ä—ã –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        if (Object.keys(SET_MAP).length > 0) {
            console.log('üì¶ Sorting all sets by year in updateUI...');
            const allSets = Object.values(SET_MAP);
            allSets.sort((a, b) => {
                const yearA = parseInt(a.year) || 0;
                const yearB = parseInt(b.year) || 0;
                return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
            });
            console.log('‚úÖ All sets sorted by year in updateUI');
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        if (Object.keys(MINIFIG_MAP).length > 0) {
            console.log('üë§ Sorting all minifigs by year in updateUI...');
            const allMinifigs = Object.values(MINIFIG_MAP);
            allMinifigs.sort((a, b) => {
                const yearA = parseInt(a.year) || 0;
                const yearB = parseInt(b.year) || 0;
                return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
            });
            console.log('‚úÖ All minifigs sorted by year in updateUI');
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (—á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        if (Object.keys(PART_MAP).length > 0) {
            console.log('üîß Sorting all parts by popularity in updateUI...');
            const allParts = Object.values(PART_MAP);
            allParts.sort((a, b) => {
                const popularityA = parseInt(a.num_sets) || 0;
                const popularityB = parseInt(b.num_sets) || 0;
                return popularityB - popularityA; // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏
            });
        }
        
        window.globalSortingApplied = true;
    }
    
    renderSidebar(), renderHeader(), renderMainContent();
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
    const wishlistModalEl = document.getElementById('wishlist-modal-container');
    if (wishlistModalEl) {
        if (S.wishlistModal.open) {
            wishlistModalEl.classList.remove('modal-hidden');
            wishlistModalEl.innerHTML = renderWishlistModal();
        } else {
            wishlistModalEl.classList.add('modal-hidden');
            wishlistModalEl.innerHTML = '';
        }
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag-and-drop –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –∂–µ–ª–∞–Ω–∏–π
    if (S.view === 'tools' && S.toolSubView === 'wishlist') {
        setTimeout(() => {
            // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
        }, 100);
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
    if (window.searchStateReset) {
        console.log('üîÑ Clearing search state reset flag, current state - S.q:', S.q, 'S.searchGroups:', S.searchGroups, 'S.catGroups:', S.catGroups);
        window.searchStateReset = false;
        console.log('üîÑ Search state reset flag cleared');
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞, –µ—Å–ª–∏ –æ–Ω–æ –µ—â–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ
        const searchInput = document.getElementById('search-input');
        if (searchInput && searchInput.value && !S.q) {
            searchInput.value = '';
            console.log('üîÑ Search input field cleared');
        }
    }
    
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è S.q, –Ω–µ –¥–ª—è –∞–≤—Ç–æ–ø–æ–∏—Å–∫–∞)
    const searchInput = document.getElementById('search-input');
    if (searchInput && !searchInput.hasAttribute('data-search-listener')) {
        searchInput.setAttribute('data-search-listener', 'true');
        searchInput.addEventListener('input', (e) => {
            S.q = e.target.value;
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
            resetRandomMinifigImage();
            
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –ø–æ–∏—Å–∫–∞ –∏ AI –ø–æ–∏—Å–∫–∞
            setupSearchButtonsVisibility();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–æ–º
            if (S.q && S.q.trim().length > 0) {
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç
                if (autocompleteTimeout) {
                    clearTimeout(autocompleteTimeout);
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—ã–π —Ç–∞–π–º–∞—É—Ç –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞
                autocompleteTimeout = setTimeout(() => {
                    const suggestions = generateAutocompleteSuggestions(S.q);
                    showAutocompleteSuggestions(suggestions, S.q);
                    selectedAutocompleteIndex = -1;
                }, 150); // 150ms –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
            } else {
                // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç –ø—Ä–∏ –ø—É—Å—Ç–æ–º –∑–∞–ø—Ä–æ—Å–µ
                if (autocompleteTimeout) {
                    clearTimeout(autocompleteTimeout);
                }
                hideAutocomplete();
            }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—é
        searchInput.addEventListener('keydown', (e) => {
            const dropdown = document.getElementById('autocomplete-dropdown');
            if (!dropdown || dropdown.style.display === 'none') return;
            
            const items = dropdown.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return;
            
            switch (e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, items.length - 1);
                    updateAutocompleteSelection(items);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, -1);
                    updateAutocompleteSelection(items);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (selectedAutocompleteIndex >= 0 && selectedAutocompleteIndex < items.length) {
                        const item = items[selectedAutocompleteIndex];
                        const suggestion = {
                            text: item.querySelector('.autocomplete-item-text').textContent,
                            type: item.dataset.type,
                            id: item.dataset.id
                        };
                        selectAutocompleteSuggestion(suggestion);
                    } else {
                        triggerSearch();
                    }
                    break;
                case 'Escape':
                    hideAutocomplete();
                    selectedAutocompleteIndex = -1;
                    break;
            }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –≤–Ω–µ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#search-input') && !e.target.closest('#autocomplete-dropdown')) {
                hideAutocomplete();
                selectedAutocompleteIndex = -1;
            }
        });
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
    setupAutocompleteClickHandlers();
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é
    setupSidebarManagement();
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–µ
    if (!S.scrollThrottle) {
        S.scrollThrottle = true;
        let scrollTimeout;
        
        const progressEl = document.getElementById('scroll-progress');
        const progressBar = progressEl?.querySelector('.bar');
        const updateScrollTrackBounds = () => {
            const track = document.getElementById('scroll-progress');
            const header = document.getElementById('header-container');
            if (track) {
                const headerHeight = header?.offsetHeight || 0;
                const top = Math.max(12, headerHeight + 8);
                track.style.top = top + 'px';
                track.style.bottom = '12px';
            }
        };
        const getPercentForEl = (el) => {
            // –ï—Å–ª–∏ –∏–∑–≤–µ—Å—Ç–Ω–æ –æ–±—â–µ–µ —á–∏—Å–ª–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —Ç–µ–∫—É—â–µ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
            if (typeof S?.totalItems === 'number' && S.totalItems > 0) {
                const shown = Math.min(S.loadedItems || 0, S.totalItems);
                const coverage = Math.max(0, Math.min(1, shown / S.totalItems));
                // –ü—Ä–æ–≥—Ä–µ—Å—Å –≤–Ω—É—Ç—Ä–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —É—á–∞—Å—Ç–∫–∞
                const max = el.scrollHeight - el.clientHeight;
                const inner = max > 0 ? Math.min(1, Math.max(0, el.scrollTop / max)) : 1;
                const percent = coverage * 100 * inner;
                return Math.max(0, Math.min(100, percent));
            }
            // –§–æ–ª–±—ç–∫: —Ç–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            const max = el.scrollHeight - el.clientHeight;
            if (max <= 0) return 100;
            const scrollFraction = Math.min(1, Math.max(0, el.scrollTop / max));
            return scrollFraction * 100;
        };
        const updateScrollProgress = () => {
            let percent = 0;
            const main = document.getElementById('main-content');
            if (main) {
                // –í—Å–µ–≥–¥–∞ —Å—á–∏—Ç–∞–µ–º –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                percent = getPercentForEl(main);
            } else {
                // –§–æ–ª–±—ç–∫ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É, –µ—Å–ª–∏ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                const doc = document.documentElement;
                const max = doc.scrollHeight - doc.clientHeight;
                if (max <= 0) {
                    percent = 100;
                } else {
                    const top = window.pageYOffset || doc.scrollTop || document.body.scrollTop || 0;
                    const scrollFraction = Math.min(1, Math.max(0, top / max));
                    percent = scrollFraction * 100;
                }
            }
            if (progressEl && progressBar) {
                const containerHeight = progressEl.clientHeight || 0;
                const barHeight = progressBar.clientHeight || 24;
                const maxOffset = Math.max(0, containerHeight - barHeight);
                const translatePx = (percent / 100) * maxOffset;
                progressBar.style.transform = `translateY(${translatePx}px)`;
            }
        };
        updateScrollTrackBounds();
        updateScrollProgress();

        // –î–µ–ª–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        window.refreshScrollProgress = updateScrollProgress;

        const onAnyScroll = () => {
            if (!document.body.classList.contains('scrolling')) {
                document.body.classList.add('scrolling');
            }
            if (progressEl) progressEl.classList.add('visible');
            updateScrollProgress();
            
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                document.body.classList.remove('scrolling');
                if (progressEl) progressEl.classList.remove('visible');
            }, 200);
        };
        window.addEventListener('scroll', onAnyScroll, { passive: true });
        const main = document.getElementById('main-content');
        if (main) main.addEventListener('scroll', onAnyScroll, { passive: true });
        // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        const observer = new MutationObserver(() => {
            if (typeof window.refreshScrollProgress === 'function') {
                try { window.refreshScrollProgress(); } catch {}
            }
        });
        if (main) observer.observe(main, { childList: true, subtree: true });
        window.addEventListener('resize', updateScrollTrackBounds, { passive: true });
        window.addEventListener('resize', updateScrollProgress, { passive: true });
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    if (!S.resizeThrottle) {
        S.resizeThrottle = true;
        let resizeTimeout;
        
        window.addEventListener('resize', () => {
            if (!document.body.classList.contains('resizing')) {
                document.body.classList.add('resizing');
            }
            
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                document.body.classList.remove('resizing');
            }, 300);
        }, { passive: true });
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
    if (!S.tabSwitchThrottle) {
        S.tabSwitchThrottle = true;
        let tabSwitchTimeout;
        
        const disableAnimationsOnTabSwitch = () => {
            if (!document.body.classList.contains('tab-switching')) {
                document.body.classList.add('tab-switching');
            }
            
            clearTimeout(tabSwitchTimeout);
            tabSwitchTimeout = setTimeout(() => {
                document.body.classList.remove('tab-switching');
            }, 500);
        };
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—ã–∑–æ–≤–µ updateUI
        disableAnimationsOnTabSwitch();
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –ø–æ–∏—Å–∫–µ
    if (S.q && S.q.length > 0) {
        document.body.classList.add('searching');
        setTimeout(() => {
            document.body.classList.remove('searching');
        }, 600);
    }
    if (S.q && S.q.length > 2) {
        document.body.classList.add('searching');
    } else {
        document.body.classList.remove('searching');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    if (S.filters.colorIds && S.filters.colorIds.length > 0) {
        document.body.classList.add('filtering');
    } else {
        document.body.classList.remove('filtering');
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞–±–æ—Ä–æ–≤
    if (S.setFilters && (S.setFilters.minYear || S.setFilters.maxYear || S.setFilters.minParts || S.setFilters.maxParts)) {
        document.body.classList.add('filtering');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ
    if (S.sortBy && S.sortBy !== 'popularity') {
        document.body.classList.add('sorting');
    } else {
        document.body.classList.remove('sorting');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–∞–º
    if (S.selThemeId || S.selCollThemeId) {
        document.body.classList.add('theme-navigation');
    } else {
        document.body.classList.remove('theme-navigation');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    if (S.selCatId || S.selCollCatId) {
        document.body.classList.add('category-navigation');
    } else {
        document.body.classList.remove('category-navigation');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    if (S.view === 'collection') {
        document.body.classList.add('collection-view');
    } else {
        document.body.classList.remove('collection-view');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É
    if (S.view === 'catalog') {
        document.body.classList.add('catalog-view');
    } else {
        document.body.classList.remove('catalog-view');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞–º
    if (S.subView === 'minifigs') {
        document.body.classList.add('minifigs-view');
    } else {
        document.body.classList.remove('minifigs-view');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –Ω–∞–±–æ—Ä–∞–º
    if (S.subView === 'sets') {
        document.body.classList.add('sets-view');
    } else {
        document.body.classList.remove('sets-view');
    }
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –¥–µ—Ç–∞–ª—è–º
    if (S.subView === 'parts') {
        document.body.classList.add('parts-view');
    } else {
        document.body.classList.remove('parts-view');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π
    if (S.view === 'collection' && S.subView === 'parts') {
        document.body.classList.add('collection-parts-view');
    } else {
        document.body.classList.remove('collection-parts-view');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–∞–±–æ—Ä–æ–≤
    if (S.view === 'collection' && S.subView === 'sets') {
        document.body.classList.add('collection-sets-view');
    } else {
        document.body.classList.remove('collection-sets-view');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
    if (S.view === 'collection' && S.subView === 'minifigs') {
        document.body.classList.add('collection-minifigs-view');
    } else {
        document.body.classList.remove('collection-minifigs-view');
    }
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É –¥–µ—Ç–∞–ª–µ–π
    if (S.view === 'catalog' && S.subView === 'parts') {
        document.body.classList.add('catalog-parts-view');
    } else {
        document.body.classList.remove('catalog-parts-view');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É –Ω–∞–±–æ—Ä–æ–≤
    if (S.view === 'catalog' && S.subView === 'sets') {
        document.body.classList.add('catalog-sets-view');
    } else {
        document.body.classList.remove('catalog-sets-view');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
    if (S.view === 'catalog' && S.subView === 'minifigs') {
        document.body.classList.add('catalog-minifigs-view');
    } else {
        document.body.classList.remove('catalog-minifigs-view');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ü–≤–µ—Ç–∞–º
    if (S.view === 'collection' && S.subView === 'parts' && S.filters.colorIds && S.filters.colorIds.length > 0) {
        document.body.classList.add('collection-parts-color-filtered');
    } else {
        document.body.classList.remove('collection-parts-color-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    if (S.view === 'collection' && S.subView === 'parts' && S.selCollCatId) {
        document.body.classList.add('collection-parts-category-filtered');
    } else {
        document.body.classList.remove('collection-parts-category-filtered');
    }
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –ø–æ–∏—Å–∫—É
    if (S.view === 'collection' && S.subView === 'parts' && S.q && S.q.length > 0) {
        document.body.classList.add('collection-parts-search-filtered');
    } else {
        document.body.classList.remove('collection-parts-search-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ
    if (S.view === 'collection' && S.subView === 'parts' && S.sortBy && S.sortBy !== 'popularity') {
        document.body.classList.add('collection-parts-sort-filtered');
    } else {
        document.body.classList.remove('collection-parts-sort-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
    if (S.view === 'collection' && S.subView === 'parts' && S.sortBy && S.sortBy === 'popularity') {
        document.body.classList.add('collection-parts-popularity-filtered');
    } else {
        document.body.classList.remove('collection-parts-popularity-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
    if (S.view === 'collection' && S.subView === 'parts' && S.sortBy && (S.sortBy === 'alpha_asc' || S.sortBy === 'alpha_desc')) {
        document.body.classList.add('collection-parts-alpha-filtered');
    } else {
        document.body.classList.remove('collection-parts-alpha-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
    if (S.view === 'collection' && S.subView === 'parts' && S.sortBy && S.sortBy === 'relevance') {
        document.body.classList.add('collection-parts-relevance-filtered');
    } else {
        document.body.classList.remove('collection-parts-relevance-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º
    if (S.view === 'collection' && S.subView === 'parts' && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-multi-filtered');
    } else {
        document.body.classList.remove('collection-parts-multi-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 200 && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-heavy-filtered');
    } else {
        document.body.classList.remove('collection-parts-heavy-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –æ—á–µ–Ω—å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 500 && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-very-heavy-filtered');
    } else {
        document.body.classList.remove('collection-parts-very-heavy-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 1000 && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-critical-filtered');
    } else {
        document.body.classList.remove('collection-parts-critical-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 1000 && S.sidebarOpen && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-critical-sidebar-filtered');
    } else {
        document.body.classList.remove('collection-parts-critical-sidebar-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é –∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 1000 && S.sidebarOpen && document.body.classList.contains('scrolling') && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-critical-sidebar-scroll-filtered');
    } else {
        document.body.classList.remove('collection-parts-critical-sidebar-scroll-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é –∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 1000 && S.sidebarOpen && (document.body.classList.contains('scrolling') || document.body.classList.contains('resizing')) && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-critical-sidebar-scroll-resize-filtered');
    } else {
        document.body.classList.remove('collection-parts-critical-sidebar-scroll-resize-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é –∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –≤–∫–ª–∞–¥–æ–∫
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 1000 && S.sidebarOpen && (document.body.classList.contains('scrolling') || document.body.classList.contains('resizing') || document.body.classList.contains('tab-switching')) && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-critical-sidebar-scroll-resize-tab-filtered');
    } else {
        document.body.classList.remove('collection-parts-critical-sidebar-scroll-resize-tab-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é –∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –≤–∫–ª–∞–¥–æ–∫ –∏ –ø–æ–∏—Å–∫–æ–º
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 1000 && S.sidebarOpen && (document.body.classList.contains('scrolling') || document.body.classList.contains('resizing') || document.body.classList.contains('tab-switching') || document.body.classList.contains('searching')) && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-critical-sidebar-scroll-resize-tab-search-filtered');
    } else {
        document.body.classList.remove('collection-parts-critical-sidebar-scroll-resize-tab-search-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é –∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –≤–∫–ª–∞–¥–æ–∫ –∏ –ø–æ–∏—Å–∫–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 1000 && S.sidebarOpen && (document.body.classList.contains('scrolling') || document.body.classList.contains('resizing') || document.body.classList.contains('tab-switching') || document.body.classList.contains('searching') || document.body.classList.contains('filtering')) && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-critical-sidebar-scroll-resize-tab-search-filter-filtered');
    } else {
        document.body.classList.remove('collection-parts-critical-sidebar-scroll-resize-tab-search-filter-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é –∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –≤–∫–ª–∞–¥–æ–∫ –∏ –ø–æ–∏—Å–∫–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 1000 && S.sidebarOpen && (document.body.classList.contains('scrolling') || document.body.classList.contains('resizing') || document.body.classList.contains('tab-switching') || document.body.classList.contains('searching') || document.body.classList.contains('filtering') || document.body.classList.contains('sorting')) && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-critical-sidebar-scroll-resize-tab-search-filter-sort-filtered');
    } else {
        document.body.classList.remove('collection-parts-critical-sidebar-scroll-resize-tab-search-filter-sort-filtered');
    }
    
    // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –±—ã—Å—Ç—Ä–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –≤—Å–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –æ—Ç–∫—Ä—ã—Ç–æ–π –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é –∏ –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–æ–π –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –≤–∫–ª–∞–¥–æ–∫ –∏ –ø–æ–∏—Å–∫–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π –ø–æ —Ç–µ–º–∞–º
    if (S.view === 'collection' && S.subView === 'parts' && Object.keys(S.coll).length > 1000 && S.sidebarOpen && (document.body.classList.contains('scrolling') || document.body.classList.contains('resizing') || document.body.classList.contains('tab-switching') || document.body.classList.contains('searching') || document.body.classList.contains('filtering') || document.body.classList.contains('sorting') || document.body.classList.contains('theme-navigation')) && (S.filters.colorIds?.length > 0 || S.selCollCatId || S.q?.length > 0 || (S.sortBy && S.sortBy !== 'popularity'))) {
        document.body.classList.add('collection-parts-critical-sidebar-scroll-resize-tab-search-filter-sort-theme-filtered');
    } else {
        document.body.classList.remove('collection-parts-critical-sidebar-scroll-resize-tab-search-filter-sort-theme-filtered');
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Ñ–æ–Ω—É
    if (backdropEl && !backdropEl.hasAttribute('data-backdrop-listener')) {
        backdropEl.setAttribute('data-backdrop-listener', 'true');
        backdropEl.addEventListener('click', () => {
            S.sidebarOpen = false;
            updateUI();
        });
    }
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –¥–ª—è –∫–Ω–æ–ø–æ–∫ –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é
    setupLongPressHandlers();
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –ø–æ–∏—Å–∫–∞ –∏ AI –ø–æ–∏—Å–∫–∞ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    setTimeout(() => {
        setupSearchButtonsVisibility();
    }, 0);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫ –ø–æ–∏—Å–∫–∞
function setupSearchButtonsVisibility() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–µ –≤ —Ä–µ–∂–∏–º–µ tools (AI –ø–æ–∏—Å–∫)
    if (S.view === 'tools') {
        console.log('üîç Skipping setupSearchButtonsVisibility - in tools view');
        return;
    }
    
    const searchButton = document.getElementById('search-button');
    const aiSearchButton = document.getElementById('ai-search-button');
    const clearButton = document.getElementById('clear-search');
    const searchIcon = document.getElementById('search-icon');
    
    console.log('üîç setupSearchButtonsVisibility called:', {
        searchButton: !!searchButton,
        aiSearchButton: !!aiSearchButton,
        clearButton: !!clearButton,
        searchIcon: !!searchIcon,
        S_q: S.q,
        S_q_length: S.q ? S.q.length : 0,
        S_view: S.view
    });
    
    if (searchButton && aiSearchButton && clearButton && searchIcon) {
        if (S.q && S.q.trim().length > 0) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∏—Å–∫–∞ –∏ —Å–∫—Ä—ã–≤–∞–µ–º AI –ø–æ–∏—Å–∫ –∏ –∏–∫–æ–Ω–∫—É –ø–æ–∏—Å–∫–∞
            console.log('üîç Showing search button, hiding AI search button and search icon');
            searchButton.classList.remove('hidden');
            searchButton.style.display = 'flex';
            aiSearchButton.classList.add('hidden');
            aiSearchButton.style.display = 'none';
            clearButton.classList.remove('hidden');
            clearButton.style.display = 'flex';
            searchIcon.classList.add('hidden');
            searchIcon.style.display = 'none';
        } else {
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–∏—Å–∫–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º AI –ø–æ–∏—Å–∫ –∏ –∏–∫–æ–Ω–∫—É –ø–æ–∏—Å–∫–∞
            console.log('üîç Hiding search button, showing AI search button and search icon');
            searchButton.classList.add('hidden');
            searchButton.style.display = 'none';
            aiSearchButton.classList.remove('hidden');
            aiSearchButton.style.display = 'flex';
            clearButton.classList.add('hidden');
            clearButton.style.display = 'none';
            searchIcon.classList.remove('hidden');
            searchIcon.style.display = 'flex';
        }
    } else {
        console.log('üîç Some buttons not found:', {
            searchButton: !!searchButton,
            aiSearchButton: !!aiSearchButton,
            clearButton: !!clearButton,
            searchIcon: !!searchIcon
        });
    }
}
function generateCsvData() {
    const t = (t) => {
        if (null == t) return "";
        const o = String(t);
        return o.includes(",") || o.includes('"') || o.includes("\n") ? `"${o.replace(/"/g,'""')}"` : o
    };
    const e = [
        "type", "id", "quantity", "name",
        "part_cat_id", "part_cat_name",
        "color_id", "color_name",
        "set_theme_id", "set_theme_name", "set_year", "set_num_parts",
        "minifig_num_parts"
    ];
    let o = e.join(",") + "\n";
    for (const [partNum, colors] of Object.entries(S.coll)) {
        for (const [colorId, quantity] of Object.entries(colors)) {
            const part = PART_MAP[partNum];
            const color = COLOR_MAP[colorId];
            const category = part ? flatCategories.find(cat => cat.id === part.categoryId) : null;
            o += [
                t("part"), t(partNum), t(quantity), t(part?.name),
                t(part?.categoryId), t(category?.name),
                t(colorId), t(color?.name),
                "", "", "", "", ""
            ].join(",") + "\n";
        }
    }
    for (const [setNum, collectionInfo] of Object.entries(S.setColl)) {
        const set = SET_MAP[setNum];
        const theme = set ? THEME_MAP[set.theme_id] : null;
        o += [
            t("set"), t(setNum), t(collectionInfo.qty), t(set?.name),
            "", "", "", "",
            t(set?.theme_id), t(theme?.name), t(set?.year), t(set?.num_parts), ""
        ].join(",") + "\n";
    }
    for (const [figNum, collectionInfo] of Object.entries(S.minifigColl)) {
        const minifig = MINIFIG_MAP[figNum];
        o += [
            t("minifig"), t(figNum), t(collectionInfo.qty), t(minifig?.name),
            "", "", "", "", "", "", "", "",
            t(minifig?.num_parts)
        ].join(",") + "\n";
    }
    return o;
}
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è CSV —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä)
function generateCsvDataForSelection(selection) {
    const quote = (val) => {
        if (val == null) return "";
        const s = String(val);
        return s.includes(",") || s.includes('"') || s.includes("\n") ? `"${s.replace(/"/g,'""')}"` : s;
    };
    const headers = [
        "type", "id", "quantity", "name",
        "part_cat_id", "part_cat_name",
        "color_id", "color_name",
        "set_theme_id", "set_theme_name", "set_year", "set_num_parts",
        "minifig_num_parts"
    ];
    let csv = headers.join(",") + "\n";
    const fromCollection = (S.view === 'collection');
    
    // –î–µ—Ç–∞–ª–∏ (—Ü–≤–µ—Ç–æ—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ)
    for (const { id: partNum, colorId } of selection.parts || []) {
        const part = PART_MAP[partNum];
        const color = COLOR_MAP[colorId];
        const category = part ? flatCategories.find(cat => cat.id === part.categoryId) : null;
        const qty = fromCollection ? ((S.coll?.[partNum]?.[colorId]) || 0) : 1;
        csv += [
            quote("part"), quote(partNum), quote(qty), quote(part?.name),
            quote(part?.categoryId), quote(category?.name),
            quote(colorId), quote(color?.name),
            "", "", "", "", ""
        ].join(",") + "\n";
    }
    
    // –ü–∞–ø–∫–∏ (–≤—Å–µ –¥–µ—Ç–∞–ª–∏ –≤ –ø–∞–ø–∫–µ)
    for (const folderPartId of selection.folders || []) {
        const part = PART_MAP[folderPartId];
        const category = part ? flatCategories.find(cat => cat.id === part.categoryId) : null;
        
        if (fromCollection) {
            // –î–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏: –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ü–≤–µ—Ç–∞ –¥–µ—Ç–∞–ª–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            const collectionColors = S.coll?.[folderPartId] || {};
            console.log(`Processing folder ${folderPartId}, collection colors:`, collectionColors);
            
            if (Object.keys(collectionColors).length > 0) {
                // –ï—Å—Ç—å —Ü–≤–µ—Ç–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ - –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤—Å–µ
                for (const [colorId, qty] of Object.entries(collectionColors)) {
                    if (qty > 0) {
                        const color = COLOR_MAP[colorId];
                        csv += [
                            quote("part"), quote(folderPartId), quote(qty), quote(part?.name),
                            quote(part?.categoryId), quote(category?.name),
                            quote(colorId), quote(color?.name),
                            "", "", "", "", ""
                        ].join(",") + "\n";
                    }
                }
            } else {
                // –ù–µ—Ç —Ü–≤–µ—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ - –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å —Å –Ω—É–ª–µ–≤—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
                console.log(`Folder ${folderPartId} has no colors in collection`);
                csv += [
                    quote("part"), quote(folderPartId), quote(0), quote(part?.name),
                    quote(part?.categoryId), quote(category?.name),
                    "", "",
                    "", "", "", "", ""
                ].join(",") + "\n";
            }
        } else {
            // –ï—Å–ª–∏ –Ω–µ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –¥–æ–±–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å –±–µ–∑ —Ü–≤–µ—Ç–∞
            csv += [
                quote("part"), quote(folderPartId), quote(1), quote(part?.name),
                quote(part?.categoryId), quote(category?.name),
                "", "",
                "", "", "", "", ""
            ].join(",") + "\n";
        }
    }
    
    // –ù–∞–±–æ—Ä—ã
    for (const setNum of selection.sets || []) {
        const set = SET_MAP[setNum];
        const theme = set ? THEME_MAP[set.theme_id] : null;
        const qty = fromCollection ? ((S.setColl?.[setNum]?.qty) || 0) : 1;
        csv += [
            quote("set"), quote(setNum), quote(qty), quote(set?.name),
            "", "", "", "",
            quote(set?.theme_id), quote(theme?.name), quote(set?.year), quote(set?.num_parts), ""
        ].join(",") + "\n";
    }
    
    // –ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    for (const figNum of selection.minifigs || []) {
        const minifig = MINIFIG_MAP[figNum];
        const qty = fromCollection ? ((S.minifigColl?.[figNum]?.qty) || 0) : 1;
        csv += [
            quote("minifig"), quote(figNum), quote(qty), quote(minifig?.name),
            "", "", "", "", "", "", "", "",
            quote(minifig?.num_parts)
        ].join(",") + "\n";
    }
    
    return csv;
}
// –ö–æ–º–ø–æ–∑–∏—Ç–Ω–æ–µ –ø—Ä–µ–≤—å—é PNG: —Å–ª–µ–≤–∞ ‚Äî –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏, —Å–ø—Ä–∞–≤–∞ ‚Äî —Ç–µ–∫—Å—Ç
async function createCompositePreviewImage(imageUrl, title, subtitle, options = {}) {
    try {
        if (!imageUrl || !imageUrl.startsWith('http')) return null;
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ CORS-–ø—Ä–æ–∫—Å–∏ (–ø–æ—á—Ç–∏ –≤—Å–µ–≥–¥–∞ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç —Ä–∏—Å–æ–≤–∞—Ç—å –Ω–∞ canvas)
        const proxiedUrl = `https://images.weserv.nl/?url=${encodeURIComponent(imageUrl)}&w=800&output=png`;
        const tryLoad = (url) => new Promise((resolve, reject) => {
            const i = new Image();
            i.crossOrigin = 'anonymous';
            i.onload = () => resolve(i);
            i.onerror = reject;
            i.src = url;
        });
        let img = await tryLoad(proxiedUrl).catch(() => null);
        if (!img) img = await tryLoad(imageUrl).catch(() => null);
        if (!img) return null;
        // –†–∏—Å—É–µ–º –∫–æ–º–ø–æ–∑–∏—Ü–∏—é (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è)
        const width = 1024, height = 576;
        const canvas = document.createElement('canvas');
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext('2d');
        // –§–æ–Ω
        ctx.fillStyle = '#111827';
        ctx.fillRect(0, 0, width, height);
        // –õ–µ–≤–∞—è –æ–±–ª–∞—Å—Ç—å –ø–æ–¥ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        const pad = 40;
        const imgArea = { x: pad, y: pad, w: Math.floor(width * 0.5) - Math.floor(pad * 1.2), h: height - pad * 2 };
        // –ë–µ–ª–∞—è –ø–ª–∞—à–∫–∞ —Å –º—è–≥–∫–∏–º–∏ —É–≥–ª–∞–º–∏
        const radius = 16;
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.moveTo(imgArea.x - 8 + radius, imgArea.y - 8);
        ctx.lineTo(imgArea.x - 8 + imgArea.w + 16 - radius, imgArea.y - 8);
        ctx.quadraticCurveTo(imgArea.x - 8 + imgArea.w + 16, imgArea.y - 8, imgArea.x - 8 + imgArea.w + 16, imgArea.y - 8 + radius);
        ctx.lineTo(imgArea.x - 8 + imgArea.w + 16, imgArea.y - 8 + imgArea.h + 16 - radius);
        ctx.quadraticCurveTo(imgArea.x - 8 + imgArea.w + 16, imgArea.y - 8 + imgArea.h + 16, imgArea.x - 8 + imgArea.w + 16 - radius, imgArea.y - 8 + imgArea.h + 16);
        ctx.lineTo(imgArea.x - 8 + radius, imgArea.y - 8 + imgArea.h + 16);
        ctx.quadraticCurveTo(imgArea.x - 8, imgArea.y - 8 + imgArea.h + 16, imgArea.x - 8, imgArea.y - 8 + imgArea.h + 16 - radius);
        ctx.lineTo(imgArea.x - 8, imgArea.y - 8 + radius);
        ctx.quadraticCurveTo(imgArea.x - 8, imgArea.y - 8, imgArea.x - 8 + radius, imgArea.y - 8);
        ctx.closePath();
        ctx.fill();
        // –í–ø–∏—Å—ã–≤–∞–µ–º –∫–∞—Ä—Ç–∏–Ω–∫—É —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–π
        const src = img;
        const scale = Math.min(imgArea.w / src.width, imgArea.h / src.height);
        const dw = Math.max(1, Math.floor(src.width * scale));
        const dh = Math.max(1, Math.floor(src.height * scale));
        const dx = Math.floor(imgArea.x + (imgArea.w - dw) / 2);
        const dy = Math.floor(imgArea.y + (imgArea.h - dh) / 2);
        ctx.drawImage(src, dx, dy, dw, dh);
        // –¢–µ–∫—Å—Ç —Å–ø—Ä–∞–≤–∞
        const textX = Math.floor(width * 0.5) + pad;
        const textW = width - textX - pad;
        ctx.fillStyle = '#ffffff';
        ctx.textBaseline = 'top';
        const drawText = (text, x, y, maxWidth, font, color = '#ffffff', lh = 0) => {
            ctx.font = font; ctx.fillStyle = color;
            const words = String(text || '').split(' ');
            let line = '', yPos = y, lineHeight = lh || (/700\s+48px/.test(font) ? 56 : 40);
            for (let n = 0; n < words.length; n++) {
                const testLine = line + (line ? ' ' : '') + words[n];
                if (ctx.measureText(testLine).width > maxWidth && n > 0) {
                    ctx.fillText(line, x, yPos);
                    line = words[n];
                    yPos += lineHeight;
                } else {
                    line = testLine;
                }
            }
            if (line) ctx.fillText(line, x, yPos);
            return yPos + lineHeight;
        };
        let nextY = drawText(title || 'LEGO Item', textX, pad, textW, '700 48px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif');
        nextY = drawText(subtitle || '–í–∫–ª—é—á–∞–µ—Ç:', textX, nextY + 10, textW, '400 32px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif', 'rgba(255,255,255,0.9)');
        // –¶–≤–µ—Ç–Ω–∞—è –∫—Ä—É–≥–ª–∞—è –∏–∫–æ–Ω–∫–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ü–≤–µ—Ç–∞ (–µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω —Ü–≤–µ—Ç)
        if (options && options.colorHex) {
            const circleY = nextY + 14;
            const circleX = textX + 6 + 14;
            ctx.save();
            ctx.beginPath();
            ctx.arc(circleX, circleY, 14, 0, Math.PI * 2);
            ctx.closePath();
            ctx.clip();
            if (options.isTransparent) {
                // –ù–µ–±–æ–ª—å—à–∞—è —à–∞—Ö–º–∞—Ç–∫–∞ –ø–æ–¥ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ —Ü–≤–µ—Ç–∞
                const s = 4;
                for (let yy = circleY - 16; yy < circleY + 16; yy += s) {
                    for (let xx = circleX - 16; xx < circleX + 16; xx += s) {
                        const on = ((xx + yy) / s) % 2 === 0;
                        ctx.fillStyle = on ? '#cbd5e1' : '#94a3b8';
                        ctx.fillRect(xx, yy, s, s);
                    }
                }
            }
            ctx.fillStyle = options.colorHex;
            ctx.globalAlpha = 1;
            ctx.beginPath();
            ctx.arc(circleX, circleY, 14, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
            // –û–±–≤–æ–¥–∫–∞ –∫—Ä—É–≥–∞
            ctx.strokeStyle = '#1f2937';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(circleX, circleY, 14, 0, Math.PI * 2);
            ctx.stroke();
            // –ü–æ–¥–ø–∏—Å—å —Ü–≤–µ—Ç–∞
            ctx.font = '400 24px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif';
            ctx.fillStyle = 'rgba(255,255,255,0.95)';
            const colorLabel = options.colorName ? String(options.colorName) : 'Color';
            ctx.fillText(colorLabel, circleX + 22, circleY - 12);
            nextY = Math.max(nextY, circleY + 14);
        }
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ)
        if (options && options.meta) {
            nextY = drawText(String(options.meta), textX, nextY + 12, textW, '400 24px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif', 'rgba(255,255,255,0.8)');
        }
        // –ü–æ–¥–ø–∏—Å—å —Å–∞–π—Ç–∞
        ctx.fillStyle = '#60a5fa';
        ctx.font = '500 24px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif';
        ctx.fillText('zeka3535.github.io/LEGO-Part-Catalog', textX, height - pad - 32);
        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 0.95));
        if (!blob) return null;
        const fname = (options && options.fileName) ? options.fileName : 'lego-item.png';
        return new File([blob], fname, { type: 'image/png' });
    } catch (e) {
        console.warn('Failed to build composite image:', e);
        return null;
    }
}
// –†–∞—Å—Ç—Ä–æ–≤–æ–µ –ø—Ä–µ–≤—å—é PNG (—Ç–µ–∫—Å—Ç–æ–≤–∞—è –∑–∞–≥–ª—É—à–∫–∞), –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–±—Ä–∞—Ç—å –∫–æ–º–ø–æ–∑–∏—Ç
async function createRasterPreviewImage(title, subtitle, options = {}) {
    try {
        const width = 1024, height = 576;
        const canvas = document.createElement('canvas');
        canvas.width = width; canvas.height = height;
        const ctx = canvas.getContext('2d');
        // –§–æ–Ω
        ctx.fillStyle = '#111827';
        ctx.fillRect(0, 0, width, height);
        // –ó–∞–≥–æ–ª–æ–≤–æ–∫
        ctx.fillStyle = '#ffffff';
        ctx.font = '700 56px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif';
        ctx.textBaseline = 'top';
        const padX = 48, padY = 80;
        const maxTitleWidth = width - padX * 2;
        const drawText = (text, x, y, maxWidth, font) => {
            ctx.font = font;
            const words = String(text).split(' ');
            let line = '', yPos = y, lineHeight = /700\s+56px/.test(font) ? 64 : 44;
            for (let n = 0; n < words.length; n++) {
                const testLine = line + (line ? ' ' : '') + words[n];
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    ctx.fillText(line, x, yPos);
                    line = words[n];
                    yPos += lineHeight;
                } else {
                    line = testLine;
                }
            }
            if (line) ctx.fillText(line, x, yPos);
            return yPos + lineHeight;
        };
        let nextY = drawText(title || 'LEGO Item', padX, padY, maxTitleWidth, ctx.font);
        // –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        nextY = drawText(subtitle || '–í–∫–ª—é—á–∞–µ—Ç:', padX, nextY + 8, maxTitleWidth, '400 36px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif');
        // –ù–∏–∂–Ω—è—è –ø–æ–¥–ø–∏—Å—å
        ctx.fillStyle = '#60a5fa';
        ctx.font = '500 28px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif';
        ctx.fillText('zeka3535.github.io/LEGO-Part-Catalog', padX, height - 64);

        const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png', 0.92));
        if (!blob) return null;
        const fname = (options && options.fileName) ? options.fileName : 'lego-item.png';
        return new File([blob], fname, { type: 'image/png' });
    } catch (e) {
        console.warn('Failed to build raster preview:', e);
        return null;
    }
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –≤ CSV
function exportCollectionToCSV() {
    try {
        updateSettingsModalStatus("–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞\nCSV —Ñ–∞–π–ª–∞", "info");
        
        const csvData = generateCsvData();
        
        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `lego-collection-${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
        
        updateSettingsModalStatus("–≠–∫—Å–ø–æ—Ä—Ç CSV\n—É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!", "success");
        setTimeout(() => {
            if (S.settingsOpen && S.settingsModal.status === "–≠–∫—Å–ø–æ—Ä—Ç CSV\n—É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!") {
                clearSettingsModalStatus();
            }
        }, 3000);
    } catch (e) {
        console.error("CSV Export failed:", e);
        S.settingsModal.status = `–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ CSV: ${e.message}`, S.settingsModal.statusType = "error";
        renderSettingsModal();
    }
}
async function processCsvData(content) {
    const t = (e, t) => {
        updateSettingsModalStatus(e, t);
        "error" !== t && setTimeout(() => {
            if (S.settingsOpen && S.settingsModal.status === e) {
                clearSettingsModalStatus();
            }
        }, 3e3)
    };
    try {
        const l = content.split(/\r?\n/).filter(e => "" !== e.trim());
        if (l.length < 2) throw new Error("CSV —Ñ–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏.");
        const a = parseCsvLine(l[0]).map(e => e.trim().replace(/"/g, "")),
            i = ["type", "id", "quantity"];
        if (!i.every(e => a.includes(e))) throw new Error(`–ù–µ–≤–µ—Ä–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ CSV. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ: ${i.join(", ")}.`);
        let n = {
            parts: 0,
            sets: 0,
            minifigs: 0
        };
        for (let e = 1; e < l.length; e++) {
            const csvRow = parseCsvLine(l[e]),
                row = a.reduce((acc, header, index) => {
                    acc[header] = csvRow[index] ? csvRow[index].trim() : "";
                    return acc;
                }, {});
            const {
                type,
                id,
                quantity
            } = row, qty = parseInt(quantity, 10);
            if (!type || !id || isNaN(qty) || qty <= 0) {
                console.warn(`–ü—Ä–æ–ø—É—Å–∫ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ${e+1}:`, l[e]);
                continue
            }
            switch (type) {
                case "part":
                    {
                        const {
                            color_id,
                            name,
                            part_cat_id,
                            color_name
                        } = row;
                        if (!color_id) continue;
                        S.coll[id] || (S.coll[id] = {});
                        S.coll[id][color_id] = (S.coll[id][color_id] || 0) + qty;
                        if (name && !PART_MAP[id]) {
                            PART_MAP[id] = {
                                id: id,
                                part_num: id,
                                name: name,
                                categoryId: part_cat_id ? parseInt(part_cat_id, 10) : null
                            };
                        }
                        if (color_name && !COLOR_MAP[color_id]) {
                            COLOR_MAP[color_id] = {
                                id: color_id,
                                name: color_name
                            };
                        }
                        n.parts++;
                        break;
                    }
                case "set":
                    {
                        const {
                            name,
                            set_theme_id,
                            set_year,
                            set_num_parts
                        } = row;
                        S.setColl[id] = {
                            qty: (S.setColl[id]?.qty || 0) + qty
                        };
                        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏, —á—Ç–æ–±—ã –Ω–∞–±–æ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–ª—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ; –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ–∑–∂–µ
                        SET_MAP[id] = {
                            ...SET_MAP[id],
                            set_num: id,
                            name: name || (SET_MAP[id]?.name || ''),
                            theme_id: set_theme_id ? parseInt(set_theme_id, 10) : (SET_MAP[id]?.theme_id ?? null),
                            year: set_year ? parseInt(set_year, 10) : (SET_MAP[id]?.year ?? null),
                            num_parts: set_num_parts ? parseInt(set_num_parts, 10) : (SET_MAP[id]?.num_parts ?? null),
                            set_img_url: SET_MAP[id]?.set_img_url || ''
                        };
                        n.sets++;
                        break;
                    }
                case "minifig":
                    {
                        const {
                            name,
                            minifig_num_parts
                        } = row;
                        S.minifigColl[id] = {
                            qty: (S.minifigColl[id]?.qty || 0) + qty
                        };
                        // –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç MINIFIG_MAP[id], –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ—Ç –∏–º–µ–Ω–∏
                        if (!MINIFIG_MAP[id]) {
                            MINIFIG_MAP[id] = {
                                set_num: id,
                                name: name || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
                                num_parts: minifig_num_parts ? parseInt(minifig_num_parts, 10) : null
                            };
                        }
                        n.minifigs++;
                        break;
                    }
            }
        }
        saveState(), t(`–ò–º–ø–æ—Ä—Ç: ${n.parts} –¥–µ—Ç–∞–ª–µ–π, ${n.sets} –Ω–∞–±–æ—Ä–æ–≤, ${n.minifigs} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫`, "success")
    } catch (e) {
        console.error("CSV Import failed:", e), t(`${e.message}`, "error");
        // –ù–µ –ø–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —á—Ç–æ–±—ã –æ–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞—Å—å –≤ –≤—ã–∑—ã–≤–∞—é—â–µ–º –∫–æ–¥–µ
    }
}

async function handleUpdateCollection(e, t, o) {
    S.coll[e] || (S.coll[e] = {});
    o > 0 ? S.coll[e][t] = o : (delete S.coll[e][t], 0 === Object.keys(S.coll[e]).length && delete S.coll[e]), o > 0 && !PART_MAP[e]?.colorImages && await fetchColorDetailsForPart(e), S.collectionLastUpdate = Date.now(), saveState(), forceSaveState(), S.gridStale = !0, "collection" === S.view ? updateUI() : (renderSidebar(), (function(){
        const card = mainEl.querySelector(`.part-card[data-part-id="${e}"]`);
        if (card && o > 0) {
            card.classList.add('collection-added');
            setTimeout(() => card.classList.remove('collection-added'), 250);
        }
    })(), mainEl.querySelector(`.part-card[data-part-id="${e}"]`)?.prepend(function() {
        const total = Object.values(S.coll[e] || {}).reduce((sum, qty) => sum + qty, 0);
        if (total > 0) {
            let el = document.createElement("div");
            el.className = "absolute top-3 right-3 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md";
            el.textContent = String(total);
            return el;
        }
        return document.createDocumentFragment();
    }()));
    // –ö—Ä–æ–º–µ –º–æ–¥–∞–ª–∫–∏: –µ—Å–ª–∏ –º—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –∏ –∫–∞—Ä—Ç–æ—á–∫–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî —Å—Ç–∞–≤–∏–º data-–∞—Ç—Ä–∏–±—É—Ç –¥–ª—è CSS-–∞–Ω–∏–º–∞—Ü–∏–∏
    if (o > 0) {
        const card = mainEl.querySelector(`.part-card[data-part-id="${e}"]`);
        if (card) {
            card.setAttribute('data-collection-change', 'added');
            setTimeout(() => card.removeAttribute('data-collection-change'), 300);
        }
    }
    
    // –ï—Å–ª–∏ –¥–µ—Ç–∞–ª—å –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏ —É –Ω–µ—ë –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    if (o > 0 && !PART_MAP[e]?.part_img_url) {
        fetchMissingImagesForCollection().catch(console.error);
    }
    
    if(S.selPartId === e) {
        updateModalControlsState();
        const button = partModalEl.querySelector(`button[data-color-id="${t}"]`);
        if (button) {
            const existingDot = button.querySelector('.w-2.h-2.bg-white.rounded-full');
            if (o > 0 && !existingDot) {
                let dot = document.createElement("div");
                const colorInfo = COLOR_MAP[t];
                const needsBlackBorder = colorInfo && (colorInfo.isTransparent || colorInfo.hex === '#FFFFFF' || colorInfo.hex === '#fff');
                dot.className = `w-2 h-2 bg-white rounded-full ${needsBlackBorder ? 'border border-black' : ''}`;
                button.appendChild(dot);
            } else if (o <= 0 && existingDot) {
                existingDot.remove();
            }
        }
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è –º—è–≥–∫–æ–≥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∂–∏–º–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏)
    if (S.view === 'collection' && o > 0) {
        setTimeout(() => {
            const card = mainEl.querySelector(`.part-card[data-part-id="${e}"][data-color-id="${t}"]`) ||
                          mainEl.querySelector(`.part-card[data-part-id="${e}"]`);
            if (card) {
                card.classList.add('collection-added');
                card.setAttribute('data-collection-change', 'added');
                setTimeout(() => {
                    card.classList.remove('collection-added');
                    card.removeAttribute('data-collection-change');
                }, 300);
            }
        }, 0);
    }
}

function handleUpdateSetCollection(e, t) {
    const o = (S.setColl[e]?.qty || 0) > 0;
    t > 0 ? (S.setColl[e] = {
        qty: t
        }, o || (fetchAllSetInventory(e).catch(t => console.error(`Failed to proactively fetch inventory for ${e}`, t)), fetchSetMinifigs(e).catch(t => console.error(`Failed to proactively fetch minifigs for ${e}`, t)))) : delete S.setColl[e], S.collectionLastUpdate = Date.now(), saveState(), forceSaveState(), S.gridStale = !0, "collection" === S.view ? updateUI() : (renderSidebar(), mainEl.querySelector(`.set-card[data-set-num="${e}"]`)?.prepend(function() {
        if (t > 0) {
            let o = document.createElement("div");
            return o.className = "absolute top-3 right-3 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md", o.textContent = String(t), o
        }
        return document.createDocumentFragment()
    }())), (function(){
        const card = mainEl.querySelector(`.set-card[data-set-num="${e}"]`);
        if (card && t > 0) {
            card.classList.add('collection-added');
            card.setAttribute('data-collection-change', 'added');
            setTimeout(() => {
                card.classList.remove('collection-added');
                card.removeAttribute('data-collection-change');
            }, 300);
        }
    })(), S.selSetNum === e && updateSetModalControlsState()

    // –í —Ä–µ–∂–∏–º–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–ø–æ—Å–ª–µ updateUI) ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–µ –Ω–∞–±–æ—Ä–∞
    if (S.view === 'collection' && t > 0) {
        setTimeout(() => {
            const card = mainEl.querySelector(`.set-card[data-set-num="${e}"]`);
            if (card) {
                card.classList.add('collection-added');
                card.setAttribute('data-collection-change', 'added');
                setTimeout(() => {
                    card.classList.remove('collection-added');
                    card.removeAttribute('data-collection-change');
                }, 300);
            }
        }, 0);
    }
    
    // –ï—Å–ª–∏ –Ω–∞–±–æ—Ä –±—ã–ª –¥–æ–±–∞–≤–ª–µ–Ω –∏ —É –Ω–µ–≥–æ –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    if (t > 0 && !SET_MAP[e]?.set_img_url) {
        fetchMissingImagesForCollection().catch(console.error);
    }
}
async function handleUpdateMinifigCollection(e, t, o = !0) {
    const l = S.minifigColl[e]?.qty || 0,
        a = t - l;
    if (0 !== a) try {
        const t = MINIFIG_MAP[e]?.parts || await fetchMinifigParts(e);
        MINIFIG_MAP[e] && !MINIFIG_MAP[e].parts && (MINIFIG_MAP[e].parts = t), (t || []).forEach(t => {
            const o = t.part.part_num,
                l = String(t.color.id),
                i = t.quantity * a;
            S.coll[o] || (S.coll[o] = {});
            const n = S.coll[o][l] || 0,
                r = n + i;
            r > 0 ? S.coll[o][l] = r : (delete S.coll[o][l], 0 === Object.keys(S.coll[o]).length && delete S.coll[o])
        })
    } catch (i) {
        console.error(`Failed to update parts for minifig ${e}:`, i)
    }
    t > 0 ? (S.minifigColl[e] = {
        qty: t
    }, o && !MINIFIG_MAP[e]?.name && await fetchMinifigDetails(e)) : delete S.minifigColl[e], S.collectionLastUpdate = Date.now(), saveState(), forceSaveState(), S.gridStale = !0, "collection" === S.view ? updateUI() : (renderSidebar(), (function(){
        const card = mainEl.querySelector(`.minifig-card[data-fig-num="${e}"]`);
        if (card && t > 0) {
            card.classList.add('collection-added');
            card.setAttribute('data-collection-change', 'added');
            setTimeout(() => {
                card.classList.remove('collection-added');
                card.removeAttribute('data-collection-change');
            }, 300);
        }
    })(), mainEl.querySelector(`.minifig-card[data-fig-num="${e}"]`)?.prepend(function() {
        if (t > 0) {
            let t = document.createElement("div");
            t.className = "absolute top-3 right-3 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md", t.textContent = String(e), t
        }
        return document.createDocumentFragment();
    }()));
    S.selFigNum === e && renderMinifigModal(!1);
    if (S.selSetNum && S.setModal.minifigs.find(t => t.set_num === e)) renderSetModal(!1)
    
    // –ï—Å–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞ –±—ã–ª–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏ —É –Ω–µ—ë –Ω–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
    if (t > 0 && !MINIFIG_MAP[e]?.minifig_img_url) {
        fetchMissingImagesForCollection().catch(console.error);
    }
}

function addToWishlist(itemType, itemId, colorId = null) {
    console.log('üéØ addToWishlist called with:', { itemType, itemId, colorId });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤–∫–ª—é—á–µ–Ω—ã –ª–∏ —Å–ø–∏—Å–∫–∏ –∂–µ–ª–∞–Ω–∏–π
    if (!S.wishlistEnabled) {
        console.log('‚ùå –°–ø–∏—Å–∫–∏ –∂–µ–ª–∞–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω—ã');
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞
    const itemKey = colorId ? `${itemType}:${itemId}:${colorId}` : `${itemType}:${itemId}`;
    
    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç–ª–µ–º–µ–Ω—Ç–µ
    let itemInfo = null;
    switch (itemType) {
        case 'set':
            itemInfo = SET_MAP[itemId];
            break;
        case 'minifig':
            itemInfo = MINIFIG_MAP[itemId];
            break;
        case 'part':
            itemInfo = PART_MAP[itemId];
            if (colorId) {
                itemInfo = { ...itemInfo, color: COLOR_MAP[colorId] };
            }
            break;
    }
    
    if (!itemInfo) {
        console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç–ª–µ–º–µ–Ω—Ç–µ:', itemType, itemId);
        return;
    }
    
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
    const wishlistItem = {
        id: itemKey,
        type: itemType,
        itemId: itemId,
        colorId: colorId,
        name: itemInfo.name,
        image: itemInfo.set_img_url || itemInfo.minifig_img_url || itemInfo.part_img_url,
        added: new Date().toISOString()
    };
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π
    const singleWishlistId = 'main-wishlist';
    
    // –°–æ–∑–¥–∞–µ–º –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if (!S.wishlists[singleWishlistId]) {
        S.wishlists[singleWishlistId] = {
            id: singleWishlistId,
            name: '–ú–æ–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π',
            description: '–≠–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —è —Ö–æ—á—É –ø—Ä–∏–æ–±—Ä–µ—Å—Ç–∏',
            created: new Date().toISOString(),
            modified: new Date().toISOString(),
            items: []
        };
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫
    const wishlist = S.wishlists[singleWishlistId];
    if (!wishlist.items.find(item => item.id === itemKey)) {
        wishlist.items.push(wishlistItem);
        wishlist.modified = new Date().toISOString();
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        saveState();
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–±—Ä–∞–Ω–æ
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ, –Ω–µ –≤–µ—Å—å UI
        if (S.view === 'catalog') {
            updateWishlistButtons();
        } else if (S.view === 'tools' && S.toolSubView === 'wishlist') {
            S.gridStale = true;
            updateUI();
        }
        
        console.log('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π:', wishlistItem);
    } else {
        // –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–±—Ä–∞–Ω–æ
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - —É –Ω–∞—Å –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π
function createWishlist() {
    console.log('‚ÑπÔ∏è createWishlist called but not needed - using single wishlist');
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - —É –Ω–∞—Å –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π
function editWishlist(wishlistId) {
    console.log('‚ÑπÔ∏è editWishlist called but not needed - using single wishlist');
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - —É –Ω–∞—Å –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π
function deleteWishlist(wishlistId) {
    console.log('‚ÑπÔ∏è deleteWishlist called but not needed - using single wishlist');
}

function viewWishlist(wishlistId) {
    const wishlist = S.wishlists[wishlistId];
    if (!wishlist) return;
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
    S.wishlistModal = {
        open: true,
        wishlistId: wishlistId,
        wishlist: wishlist
    };
    
    updateUI();
    console.log('Viewing wishlist:', wishlist);
}

function exportWishlist(wishlistId) {
    const wishlist = S.wishlists[wishlistId];
    if (!wishlist) return;
    
    // –°–æ–∑–¥–∞–µ–º CSV –¥–∞–Ω–Ω—ã–µ
    const csvHeader = 'Type,ID,Name,Color,Added\n';
    const csvData = wishlist.items.map(item => {
        const colorName = item.colorId ? (COLOR_MAP[item.colorId]?.name || item.colorId) : '';
        return `${item.type},"${item.itemId}","${item.name}","${colorName}","${item.added}"`;
    }).join('\n');
    
    const csvContent = csvHeader + csvData;
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const fileName = `wishlist-${wishlist.name.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '')}-${new Date().toISOString().slice(0,10)}.csv`;
    
    // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    
    setTimeout(() => URL.revokeObjectURL(url), 5000);
    showExportSuccess(wishlist.items.length);
}

function importWishlist(wishlistId) {
    const wishlist = S.wishlists[wishlistId];
    if (!wishlist) return;
    
    // –°–æ–∑–¥–∞–µ–º —Å–∫—Ä—ã—Ç—ã–π input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.csv';
    input.style.display = 'none';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const csvContent = e.target.result;
                const lines = csvContent.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showImportError('–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏');
                    return;
                }
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                const dataLines = lines.slice(1);
                let importedCount = 0;
                let skippedCount = 0;
                
                dataLines.forEach(line => {
                    const columns = line.split(',').map(col => col.replace(/^"|"$/g, ''));
                    if (columns.length < 3) return;
                    
                    const [type, itemId, name, colorName, added] = columns;
                    
                    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
                    const itemKey = `${type}:${itemId}`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —ç–ª–µ–º–µ–Ω—Ç
                    if (!wishlist.items.find(item => item.id === itemKey)) {
                        const wishlistItem = {
                            id: itemKey,
                            type: type,
                            itemId: itemId,
                            colorId: null,
                            name: name,
                            image: '', // –ë—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ UI
                            added: added || new Date().toISOString()
                        };
                        
                        wishlist.items.push(wishlistItem);
                        importedCount++;
                    } else {
                        skippedCount++;
                    }
                });
                
                wishlist.modified = new Date().toISOString();
                saveState();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                if (S.view === 'tools' && S.toolSubView === 'wishlist') {
                    S.gridStale = true;
                    updateUI();
                }
                
                showImportStats(importedCount, skippedCount);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ CSV:', error);
                showImportError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Ñ–∞–π–ª–∞');
            }
        };
        
        reader.readAsText(file);
    };
    
    document.body.appendChild(input);
    input.click();
    document.body.removeChild(input);
}

// –¢–µ—Å—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã —Å–ø–∏—Å–∫–æ–≤ –∂–µ–ª–∞–Ω–∏–π
window.testWishlist = function() {
    console.log('üß™ Testing wishlist functionality...');
    console.log('S.wishlistEnabled:', S.wishlistEnabled);
    console.log('S.wishlists:', S.wishlists);
    console.log('S.currentWishlist:', S.currentWishlist);
    
    // –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞
    if (Object.keys(S.wishlists).length === 0) {
        console.log('Creating test wishlist...');
        createWishlist();
    }
    
    const result = {
        wishlistEnabled: S.wishlistEnabled,
        wishlistsCount: Object.keys(S.wishlists).length,
        currentWishlist: S.currentWishlist
    };
    
    console.log('Current state after test:', result);
    return result;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
window.testAddToWishlist = function() {
    console.log('üß™ Testing add to wishlist...');
    addToWishlist('set', '10210-1', null);
    return 'Element added to wishlist';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ø–∏—Å–∫–∞
window.testCreateWishlist = function() {
    console.log('üß™ Testing create wishlist directly...');
    createWishlist();
    return 'Create wishlist function called';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ
window.testClickHandler = function() {
    console.log('üß™ Testing click handler...');
    const btn = document.getElementById('create-wishlist');
    if (btn) {
        console.log('Button found:', btn);
        btn.click();
    } else {
        console.log('Button not found!');
    }
    return 'Click test completed';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
window.checkWishlistState = function() {
    if (typeof S === 'undefined') {
        console.error('S is not defined. Make sure the page is fully loaded.');
        return null;
    }
    return {
        wishlistEnabled: S.wishlistEnabled,
        wishlists: S.wishlists,
        currentWishlist: S.currentWishlist
    };
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ S
window.checkS = function() {
    return typeof S !== 'undefined' ? S : null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
function renderWishlistModal() {
    if (!S.wishlistModal.open || !S.wishlistModal.wishlist) {
        return '';
    }
    
    const wishlist = S.wishlistModal.wishlist;
    const items = wishlist.items || [];
    
    return `
        <div class="bg-gray-800 rounded-[18px] shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="flex items-center justify-between p-6 border-b border-gray-700">
                <div>
                    <h2 class="text-2xl font-bold text-white">${wishlist.name}</h2>
                    ${wishlist.description ? `<p class="text-gray-400 mt-1">${wishlist.description}</p>` : ''}
                    <p class="text-sm text-gray-500 mt-2">
                        –°–æ–∑–¥–∞–Ω: ${new Date(wishlist.created).toLocaleDateString('ru-RU')} ‚Ä¢ 
                        –≠–ª–µ–º–µ–Ω—Ç–æ–≤: ${items.length}
                    </p>
                </div>
                <button id="close-wishlist-modal" class="text-gray-400 hover:text-white transition-colors">
                    ${I_X('w-6 h-6')}
                </button>
            </div>
            
            <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ -->
            <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                ${items.length === 0 ? `
                    <div class="text-center py-12">
                        <div class="text-gray-400 mb-4">${I_List('w-16 h-16 mx-auto')}</div>
                        <h3 class="text-lg font-semibold text-gray-300 mb-2">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</h3>
                        <p class="text-gray-500">–î–æ–±–∞–≤—å—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞, –Ω–∞–∂–∞–≤ –Ω–∞ —Å–µ—Ä–¥–µ—á–∫–æ</p>
                    </div>
                ` : `
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${items.map(item => `
                            <div class="bg-gray-700 rounded-[18px] p-4 hover:bg-gray-600 transition-colors">
                                <div class="flex items-start space-x-3">
                                    ${item.image ? `
                                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-[18px] flex-shrink-0">
                                    ` : `
                                        <div class="w-16 h-16 bg-gray-600 rounded-[18px] flex items-center justify-center flex-shrink-0">
                                            ${I_Brick('w-8 h-8 text-gray-400')}
                                        </div>
                                    `}
                                    <div class="flex-1 min-w-0">
                                        <h4 class="font-semibold text-white truncate">${item.name}</h4>
                                        <p class="text-sm text-gray-400">${item.type === 'set' ? '–ù–∞–±–æ—Ä' : item.type === 'minifig' ? '–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞' : '–î–µ—Ç–∞–ª—å'}</p>
                                        <p class="text-xs text-gray-500">ID: ${item.itemId}</p>
                                        ${item.colorId ? `<p class="text-xs text-gray-500">–¶–≤–µ—Ç: ${item.colorId}</p>` : ''}
                                        <p class="text-xs text-gray-500 mt-1">
                                            –î–æ–±–∞–≤–ª–µ–Ω: ${new Date(item.added).toLocaleDateString('ru-RU')}
                                        </p>
                                    </div>
                                    <button class="remove-from-wishlist text-red-400 hover:text-red-300 transition-colors" 
                                            data-wishlist-id="${wishlist.id}" 
                                            data-item-id="${item.id}">
                                        ${I_Trash('w-4 h-4')}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>
            
            <!-- –ü–æ–¥–≤–∞–ª -->
            <div class="flex items-center justify-between p-6 border-t border-gray-700 bg-gray-750">
                <div class="flex space-x-2">
                    <button id="export-wishlist-from-modal" 
                            class="flex items-center px-3 sm:px-4 py-2 sm:py-3 text-xs sm:text-sm font-medium bg-green-600 hover:bg-green-700 text-white rounded-[18px] transition-all duration-200 shadow-lg hover:shadow-green-500/25 hover:transform hover:-translate-y-0.5"
                            data-wishlist-id="${wishlist.id}">
                        ${I_Download('w-3 h-3 sm:w-4 sm:h-4 mr-1 sm:mr-2')}
                        <span class="hidden sm:inline">–≠–∫—Å–ø–æ—Ä—Ç CSV</span>
                        <span class="sm:hidden">–≠–∫—Å–ø–æ—Ä—Ç</span>
                    </button>
                    <button id="edit-wishlist-from-modal" 
                            class="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-[18px] transition-colors"
                            data-wishlist-id="${wishlist.id}">
                        ${I_Edit('w-4 h-4 mr-2')}
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
                <button id="close-wishlist-modal-bottom" 
                        class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-[18px] transition-colors">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
            </div>
        </div>
    `;
}

async function handleBulkUpdatePartsFromSet(e, t) {
    if (S.setModal.bulkUpdate) return;
    S.setModal.bulkUpdate = !0, S.setModal.status = "", S.setModal.statusType = "", updateSetModalControlsState();
    try {
        (await fetchAllSetInventory(e) || []).forEach(e => {
            const {
                part: o,
                color: l,
                quantity: a
            } = e;
            S.coll[o.part_num] || (S.coll[o.part_num] = {});
            const i = String(l.id),
                n = S.coll[o.part_num][i] || 0;
            "add" === t ? S.coll[o.part_num][i] = n + a : n - a > 0 ? (S.coll[o.part_num][i] = n - a) : (delete S.coll[o.part_num][i], 0 === Object.keys(S.coll[o.part_num]).length && delete S.coll[o.part_num])
        });
        let o = 0,
            l = 0,
            a = 0,
            i = 0;
        const n = S.setModal.minifigs || await apiFetchPaginated(`/sets/${e}/minifigs/`);
        for (let e = 0; e < n.length; e += 3) {
            const r = n.slice(e, e + 3);
            await Promise.all(r.map(async e => {
                const n = e.set_num,
                    r = e.quantity,
                    s = S.minifigColl[n]?.qty || 0;
                "add" === t ? (S.minifigColl[n] = {
                    qty: s + r
                }, o += r) : (s - r > 0 ? S.minifigColl[n] = {
                    qty: s - r
                } : delete S.minifigColl[n], a += r);
                const fig = S.setModal.minifigs.find(f => f.set_num === n);
                const c = fig?.parts || await fetchMinifigParts(n);
                if (fig) fig.parts = c;
                (c || []).forEach(e => {
                    const o = e.part.part_num,
                        a = String(e.color.id),
                        n = e.quantity * r;
                    S.coll[o] || (S.coll[o] = {});
                    const s = S.coll[o][a] || 0;
                    "add" === t ? S.coll[o][a] = s + n : s - n > 0 ? S.coll[o][a] = s - n : (delete S.coll[o][a], 0 === Object.keys(S.coll[o]).length && delete S.coll[o]), "add" === t ? l += n : i += n
                })
            })), e + 3 < n.length && await new Promise(e => setTimeout(e, 1e3))
        }
        saveState(), forceSaveState(), await Promise.all([fetchMissingCollectionPartDetails(), ensureBasicPartImagesForCollection(), fetchColorDetailsForCollectionParts(), fetchMissingCollectionMinifigDetails()]);
        let r = "";
        "add" === t ? (r = "–î–µ—Ç–∞–ª–∏ –Ω–∞–±–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã.", o > 0 && (r += ` ${o} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏ –∏—Ö –¥–µ—Ç–∞–ª–∏ (${l} —à—Ç.) —Ç–∞–∫–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.`)) : (r = "–î–µ—Ç–∞–ª–∏ –Ω–∞–±–æ—Ä–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã.", a > 0 && (r += ` –¢–∞–∫–∂–µ —É–¥–∞–ª–µ–Ω—ã ${a} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏ –∏—Ö –¥–µ—Ç–∞–ª–∏ (${i} —à—Ç.).`)), S.setModal.status = r, S.setModal.statusType = "success", setTimeout(() => {
            S.selSetNum && S.setModal.status === r && (S.setModal.status = "", renderSetModal(!1))
        }, 3e3), S.gridStale = !0, updateUI()
    } catch (o) {
        console.error(`Bulk ${t} failed for set ${e}:`, o), S.setModal.status = `–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å ${"add"===t?"–¥–æ–±–∞–≤–∏—Ç—å":"—É–¥–∞–ª–∏—Ç—å"} –¥–µ—Ç–∞–ª–∏.`, S.setModal.statusType = "error"
    } finally {
        S.setModal.bulkUpdate = !1, S.selSetNum && renderSetModal(!1)
    }
}
async function handleBulkAddMinifigParts(e) {
    const t = S.setModal.minifigs.find(t => t.set_num === e);
    if (!t || S.setModal.bulkUpdate) return;
    S.setModal.bulkUpdate = !0, S.setModal.status = `–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∏–∑ "${t.name}"...`, S.setModal.statusType = "info", renderSetModal(!1);
    try {
        let o = t.parts;
        o || (o = await fetchMinifigParts(e));
        t.parts = o;
        if (!o || 0 === o.length) throw new Error("–î–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
        const l = t.quantity;
        (o || []).forEach(e => {
            const t = e.part.part_num,
                o = String(e.color.id),
                l = e.quantity * l;
            S.coll[t] || (S.coll[t] = {}), S.coll[t][o] = (S.coll[t][o] || 0) + l
        }), saveState(), forceSaveState(), await Promise.all([fetchMissingCollectionPartDetails(), ensureBasicPartImagesForCollection(), fetchColorDetailsForCollectionParts()]);
        const a = `–î–µ—Ç–∞–ª–∏ –∏–∑ "${t.name}" (${o.length} –≤–∏–¥–æ–≤) –¥–æ–±–∞–≤–ª–µ–Ω—ã.`;
        S.setModal.status = a, S.setModal.statusType = "success", setTimeout(() => {
            S.selSetNum && S.setModal.status === a && (S.setModal.status = "", renderSetModal(!1))
        }, 3e3)
    } catch (o) {
        console.error("Error adding minifig parts:", o), S.setModal.status = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–µ–π.", S.setModal.statusType = "error"
    } finally {
        S.setModal.bulkUpdate = !1, S.selSetNum && renderSetModal(!1), "collection" === S.view && "parts" === S.subView ? (S.gridStale = !0, updateUI()) : renderSidebar()
    }
}
async function handleBulkAddMinifigPartsFromModal(e) {
    const t = MINIFIG_MAP[e];
    if (!t || S.minifigModal.bulkUpdate) return;
    S.minifigModal.bulkUpdate = !0, S.minifigModal.status = `–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –∏–∑ "${t.name}"...`, S.minifigModal.statusType = "info", renderMinifigModal(!1);
    try {
        const o = S.minifigModal.inv || await fetchMinifigParts(e);
        S.minifigModal.inv = o;
        if (!o || 0 === o.length) throw new Error("–î–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
        (o || []).forEach(e => {
            const t = e.part.part_num,
                o = String(e.color.id),
                l = e.quantity;
            S.coll[t] || (S.coll[t] = {}), S.coll[t][o] = (S.coll[t][o] || 0) + l
        }), saveState(), forceSaveState(), await Promise.all([fetchMissingCollectionPartDetails(), ensureBasicPartImagesForCollection(), fetchColorDetailsForCollectionParts()]);
        const l = `–î–µ—Ç–∞–ª–∏ –∏–∑ "${t.name}" (${o.length} –≤–∏–¥–æ–≤) –¥–æ–±–∞–≤–ª–µ–Ω—ã.`;
        S.minifigModal.status = l, S.minifigModal.statusType = "success", setTimeout(() => {
            S.selFigNum && S.minifigModal.status === l && (S.minifigModal.status = "", renderMinifigModal(!1))
        }, 3e3)
    } catch (o) {
        console.error("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏:", o), S.minifigModal.status = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –¥–µ—Ç–∞–ª–µ–π.", S.minifigModal.statusType = "error"
    } finally {
        S.minifigModal.bulkUpdate = !1, S.selFigNum && renderMinifigModal(!1), "collection" === S.view && "parts" === S.subView ? (S.gridStale = !0, updateUI()) : renderSidebar()
    }
}
function triggerSearch(e = !1) {
    console.log('triggerSearch called with:', { e, S_q: S.q, S_subView: S.subView, S_view: S.view });
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
    resetRandomMinifigImage();
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –∏ –æ—Ç–∫—Ä—ã—Ç—å —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
    if (S.q && S.q.trim().length > 0) {
        if (searchAndOpenElement(S.q.trim())) {
            console.log('Element found and opened directly:', S.q.trim());
            return; // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω –∏ –æ—Ç–∫—Ä—ã—Ç, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏
        }
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø–æ–∏—Å–∫–∞
    if (S.q && S.q.trim().length > 0) {
        updateLoadingStatus("–ü–æ–∏—Å–∫...", 70, `–ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${S.q}"`);
    }
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –ø–æ–∏—Å–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏
    if (S.q && S.q.trim().length > 0) {
        let searchResults;
        let searchContext;
        
        if (S.view === "collection") {
            // –ü–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            searchResults = searchCollectionElements(S.q.trim());
            searchContext = "–∫–æ–ª–ª–µ–∫—Ü–∏–∏";
        } else {
            // –ü–æ–∏—Å–∫ –≤ –ø–æ–ª–Ω–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ
            searchResults = searchAllElements(S.q.trim());
            searchContext = "–∫–∞—Ç–∞–ª–æ–≥–µ";
        }
        
        const totalResults = searchResults.parts.length + searchResults.sets.length + searchResults.minifigs.length;
        
        if (totalResults > 0) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            const originalView = S.view;
            S.view = "catalog"; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –≤ —Ä–µ–∂–∏–º –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            S.subView = "parts";
            S.selCatId = null;
            S.selFigNum = null;
            S.showRelatedSets = false;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            S.universalSearchResults = searchResults;
            S.universalSearchTerm = S.q.trim();
            S.showUniversalSearch = true;
            S.originalSearchContext = originalView; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            S.gridStale = true;
            updateUI();
            
            console.log(`Search in ${searchContext} completed: ${totalResults} results found`);
            return;
        }
    }
    
    // –ï—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º –æ–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫
    if (!e) {
        if ("sets" === S.subView) {
            S.sortBy = S.q ? "relevance" : "year_desc";
            S.setFilters = {
                minYear: "",
                maxYear: "",
                minParts: "",
                maxParts: ""
            };
        } else if ("minifigs" === S.subView) {
            S.sortBy = S.q ? "relevance" : "name_asc";
        } else {
            S.sortBy = S.q ? "relevance" : "popularity";
            S.filters.colorIds = [];
            S.filters.inCollectionOnly = !1;
        }
    }
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    document.body.classList.add('searching');
    setTimeout(() => {
        document.body.classList.remove('searching');
    }, 800);
    
    S.gridStale = !0;
    if ("collection" === S.view) {
        S.selCollCatId = null;
        S.selCollThemeId = null;
        updateUI();
    } else if ("tools" === S.view) {
        // –í —Ä–µ–∂–∏–º–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –ø–æ–∏—Å–∫–∞
        S.view = "catalog";
        S.subView = "parts";
        S.selCatId = null;
        S.selFigNum = null;
        S.showRelatedSets = false;
        S.searchGroups = null;
        S.catGroups = null;
        S.setRes = null;
        S.searchSetRes = null;
        S.minifigRes = null;
        S.searchMinifigRes = null;
        S.showUniversalSearch = false;
        S.universalSearchResults = null;
        S.universalSearchTerm = "";
        S.originalSearchContext = null;
        window.searchStateReset = true;
        console.log('Switching from tools to catalog for search, calling searchRebrickableParts with:', S.q.trim());
        searchRebrickableParts(S.q.trim());
    } else if ("sets" === S.subView) {
        S.selThemeId = null;
        S.selFigNum = null;
        S.showRelatedSets = false;
        fetchSets();
    } else if ("minifigs" === S.subView) {
        S.selFigNum = null;
        S.showRelatedSets = false;
        fetchMinifigs();
    } else {
        S.selCatId = null;
        S.selFigNum = null;
        S.showRelatedSets = false;
        console.log('Calling searchRebrickableParts with:', S.q.trim());
        searchRebrickableParts(S.q.trim());
    }
}
function openImageViewer(e) {
    if (!e || e.includes("data:image/svg+xml")) return;
    
    // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ image viewer (–≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
    hideSidebarHint();
    
    // –û—Ç–º–µ–Ω—è–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π —Ç–∞–π–º–µ—Ä –∑–∞–∫—Ä—ã—Ç–∏—è
    if (viewerEl && viewerEl._closeTimer) {
        clearTimeout(viewerEl._closeTimer);
        viewerEl._closeTimer = null;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    viewerImg.setAttribute("src", e);
    viewerEl.classList.remove("zoomed", "zoom-mode");
    viewerImg.classList.remove("zoomed");
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑—É–º–∞
    resetZoom();
    
    // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å viewer-hidden –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
    viewerEl.classList.remove("viewer-hidden");
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ modalManager
    modalManager.openModal('image-viewer-container', viewerEl);
    
    // –£–±–∏—Ä–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É
    viewerImg.onclick = null;
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç
    const closeBtn = document.getElementById('image-viewer-close');
    if (closeBtn) {
        closeBtn.onclick = closeImageViewer;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
        closeBtn.style.opacity = '0';
        closeBtn.style.transform = 'scale(0.8) rotate(-10deg)';
        
        setTimeout(() => {
            closeBtn.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            closeBtn.style.opacity = '1';
            closeBtn.style.transform = 'scale(1) rotate(0deg)';
        }, 200);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑—É–º–∞
    initializeZoomControls();
}
function closeImageViewer() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    viewerImg.setAttribute("src", "");
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑—É–º–∞
    resetZoom();
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ modalManager
    modalManager.closeModal('image-viewer-container');
    
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ image viewer —Å–∫—Ä—ã—Ç
    if (viewerEl) {
        viewerEl.classList.add('viewer-hidden');
        viewerEl.classList.remove('visible', 'zoom-mode');
    }
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑—É–º–∞
let zoomState = {
    scale: 1,
    viewportX: 0,
    viewportY: 0,
    isDragging: false,
    startX: 0,
    startY: 0,
    startViewportX: 0,
    startViewportY: 0
};

// –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ –∑—É–º–∞
function resetZoom() {
    zoomState.scale = 1;
    zoomState.viewportX = 0;
    zoomState.viewportY = 0;
    zoomState.isDragging = false;
    zoomState.startX = 0;
    zoomState.startY = 0;
    zoomState.startViewportX = 0;
    zoomState.startViewportY = 0;
    
    if (viewerEl) {
        viewerEl.classList.remove('zoom-mode');
        const imageCanvas = viewerEl.querySelector('.image-canvas');
        const imageWrapper = viewerEl.querySelector('.image-wrapper');
        
        if (imageCanvas && imageWrapper) {
            imageWrapper.style.transform = 'scale(1)';
            imageCanvas.style.transform = 'translate(0px, 0px)';
            imageCanvas.classList.remove('dragging');
        }
    }
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
    const isMobile = window.innerWidth <= 768;
    if (isMobile) {
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const zoomResetBtn = document.getElementById('zoom-reset-btn');
        
        if (zoomInBtn) zoomInBtn.style.display = 'flex';
        if (zoomOutBtn) zoomOutBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∑—É–º–µ 1x
        if (zoomResetBtn) zoomResetBtn.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∑—É–º–µ 1x –∏ —Å–±—Ä–æ—à–µ–Ω–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    }
    
    updateZoomButtons();
}

// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∑—É–º–∞
function applyZoom() {
    const imageCanvas = viewerEl.querySelector('.image-canvas');
    const imageWrapper = viewerEl.querySelector('.image-wrapper');
    
    if (imageCanvas && imageWrapper) {
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑—É–º –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—é
        imageWrapper.style.transform = `scale(${zoomState.scale})`;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫ –ø–æ–ª–æ—Ç–Ω—É
        imageCanvas.style.transform = `translate(${zoomState.viewportX}px, ${zoomState.viewportY}px)`;
    }
}

// –§—É–Ω–∫—Ü–∏—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è –∑—É–º–∞
function zoomIn() {
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö - 1x ‚Üí 2x ‚Üí 3x
        if (zoomState.scale === 1) {
            zoomState.scale = 2;
        } else if (zoomState.scale === 2) {
            zoomState.scale = 3;
        }
        
        if (zoomState.scale > 1) {
            applyZoom();
            updateZoomButtons();
            viewerEl.classList.add('zoom-mode');
        }
    } else {
        // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ - –æ–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–º–∏ –≥—Ä–∞–¥–∞—Ü–∏—è–º–∏
        if (zoomState.scale < 3) {
            zoomState.scale = Math.min(zoomState.scale * 1.5, 3);
            applyZoom();
            updateZoomButtons();
            
            if (zoomState.scale > 1) {
                viewerEl.classList.add('zoom-mode');
            }
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –∑—É–º–∞
function zoomOut() {
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile) {
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö - 3x ‚Üí 2x ‚Üí 1x
        if (zoomState.scale === 3) {
            zoomState.scale = 2;
            applyZoom();
            updateZoomButtons();
        } else if (zoomState.scale === 2) {
            zoomState.scale = 1;
            applyZoom();
            updateZoomButtons();
            viewerEl.classList.remove('zoom-mode');
            resetZoom();
        }
    } else {
        // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ - –æ–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–º–∏ –≥—Ä–∞–¥–∞—Ü–∏—è–º–∏
        if (zoomState.scale > 1) {
            zoomState.scale = Math.max(zoomState.scale / 1.5, 1);
            applyZoom();
            updateZoomButtons();
            
            if (zoomState.scale === 1) {
                viewerEl.classList.remove('zoom-mode');
                resetZoom();
            }
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –∑—É–º–∞
function updateZoomButtons() {
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');
    const zoomResetBtn = document.getElementById('zoom-reset-btn');
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–±–∏–ª—å–Ω–æ–µ –ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    const isMobile = window.innerWidth <= 768;
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –∏ —É–ø—Ä–∞–≤–ª—è–µ–º –∏—Ö –≤–∏–¥–∏–º–æ—Å—Ç—å—é
    if (zoomInBtn) {
        const isDisabled = zoomState.scale >= 3;
        zoomInBtn.disabled = isDisabled;
        
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        if (isMobile) {
            zoomInBtn.style.display = isDisabled ? 'none' : 'flex';
        }
    }
    
    if (zoomOutBtn) {
        const isDisabled = zoomState.scale <= 1;
        zoomOutBtn.disabled = isDisabled;
        
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        if (isMobile) {
            zoomOutBtn.style.display = isDisabled ? 'none' : 'flex';
        }
    }
    
    if (zoomResetBtn) {
        const isDisabled = zoomState.scale <= 1;
        zoomResetBtn.disabled = isDisabled;
        
        // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        if (isMobile) {
            zoomResetBtn.style.display = isDisabled ? 'none' : 'flex';
        }
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–±—Ä–æ—Å–∞ - —Å–∫—Ä—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç —Å–º–µ—â–µ–Ω–∏—è
    if (zoomResetBtn && isMobile) {
        const hasOffset = zoomState.viewportX !== 0 || zoomState.viewportY !== 0;
        const shouldShow = zoomState.scale > 1 && hasOffset;
        zoomResetBtn.style.display = shouldShow ? 'flex' : 'none';
    }
    
    // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫
    if (isMobile) {
        const zoomControls = document.querySelector('.zoom-controls');
        if (zoomControls) {
            // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–∏–¥–∏–º—ã–µ –∫–Ω–æ–ø–∫–∏
            const visibleButtons = Array.from(zoomControls.children).filter(btn => 
                btn.style.display !== 'none' && !btn.disabled
            );
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∏–¥–∏–º—ã–µ –∫–Ω–æ–ø–∫–∏, —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            if (visibleButtons.length > 0) {
                zoomControls.style.justifyContent = 'center';
                zoomControls.style.left = '50%';
                zoomControls.style.right = 'auto';
                zoomControls.style.transform = 'translateX(-50%)';
            }
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑—É–º–∞
function initializeZoomControls() {
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');
    const zoomResetBtn = document.getElementById('zoom-reset-btn');
    const imageWrapper = viewerEl.querySelector('.image-wrapper');
    
    // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if (zoomInBtn) {
        zoomInBtn.onclick = null;
        zoomInBtn.ontouchstart = null;
        zoomInBtn.addEventListener('click', handleZoomIn, { passive: false });
        zoomInBtn.addEventListener('touchstart', handleZoomIn, { passive: false });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        zoomInBtn.dataset.processing = 'false';
        zoomInBtn.dataset.lastClick = '0';
    }
    
    if (zoomOutBtn) {
        zoomOutBtn.onclick = null;
        zoomOutBtn.ontouchstart = null;
        zoomOutBtn.addEventListener('click', handleZoomOut, { passive: false });
        zoomOutBtn.addEventListener('touchstart', handleZoomOut, { passive: false });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        zoomOutBtn.dataset.processing = 'false';
        zoomOutBtn.dataset.lastClick = '0';
    }
    
    if (zoomResetBtn) {
        zoomResetBtn.onclick = null;
        zoomResetBtn.ontouchstart = null;
        zoomResetBtn.addEventListener('click', handleZoomReset, { passive: false });
        zoomResetBtn.addEventListener('touchstart', handleZoomReset, { passive: false });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        zoomResetBtn.dataset.processing = 'false';
        zoomResetBtn.dataset.lastClick = '0';
    }
    
    if (imageWrapper) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        imageWrapper.removeEventListener('mousedown', startDrag);
        imageWrapper.removeEventListener('mousemove', drag);
        imageWrapper.removeEventListener('mouseup', endDrag);
        imageWrapper.removeEventListener('mouseleave', endDrag);
        imageWrapper.removeEventListener('touchstart', startDragTouch);
        imageWrapper.removeEventListener('touchmove', dragTouch);
        imageWrapper.removeEventListener('touchend', endDragTouch);
        imageWrapper.removeEventListener('wheel', handleWheel);
        imageWrapper.removeEventListener('dblclick', handleDoubleClick);
        imageWrapper.removeEventListener('contextmenu', handleContextMenu);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        imageWrapper.addEventListener('mousedown', startDrag);
        imageWrapper.addEventListener('mousemove', drag);
        imageWrapper.addEventListener('mouseup', endDrag);
        imageWrapper.addEventListener('mouseleave', endDrag);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–∞—á-—Å–æ–±—ã—Ç–∏–π (–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ)
        imageWrapper.addEventListener('touchstart', startDragTouch, { passive: false });
        imageWrapper.addEventListener('touchmove', dragTouch, { passive: false });
        imageWrapper.addEventListener('touchend', endDragTouch, { passive: false });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ pinch-to-zoom –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        if (window.innerWidth <= 768) {
            imageWrapper.addEventListener('touchstart', handlePinchStart, { passive: false });
            imageWrapper.addEventListener('touchmove', handlePinchMove, { passive: false });
            imageWrapper.addEventListener('touchend', handlePinchEnd, { passive: false });
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ª–µ—Å–∏–∫–∞ –º—ã—à–∏ –¥–ª—è –∑—É–º–∞
        imageWrapper.addEventListener('wheel', handleWheel, { passive: false });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑—É–º–∞
        imageWrapper.addEventListener('dblclick', handleDoubleClick);
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –∏ –æ–¥–∏–Ω–æ—á–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        if (window.innerWidth <= 768) {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–∞—Å–∞–Ω–∏–π (–¥–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è)
            imageWrapper.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, { passive: false });
            
            imageWrapper.addEventListener('touchend', function(e) {
                if (e.changedTouches.length > 1) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, { passive: false });
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫, –Ω–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            imageWrapper.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                return false;
            }, { passive: false });
            
            // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –¥–ª—è –≤—Å–µ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            viewerEl.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, { passive: false });
            
            viewerEl.addEventListener('touchend', function(e) {
                if (e.changedTouches.length > 1) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, { passive: false });
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –æ–¥–∏–Ω–æ—á–Ω—ã–π –∫–ª–∏–∫ –¥–ª—è –≤—Å–µ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            viewerEl.addEventListener('click', function(e) {
                // –†–∞–∑—Ä–µ—à–∞–µ–º –∫–ª–∏–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–∞–º –∑—É–º–∞
                if (!e.target.closest('.zoom-controls')) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }, { passive: false });
        }
        
        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏
        imageWrapper.addEventListener('contextmenu', handleContextMenu);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
    window.addEventListener('resize', handleWindowResize);
    
    updateZoomButtons();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
function handleWindowResize() {
    if (zoomState.scale > 1) {
        // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const scale = zoomState.scale;
        
        const maxViewportX = viewportWidth * (scale - 1) * 0.5;
        const maxViewportY = viewportHeight * (scale - 1) * 0.5;
        
        // –ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–º–µ—â–µ–Ω–∏–µ viewport –µ—Å–ª–∏ –æ–Ω–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–æ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
        zoomState.viewportX = Math.max(-maxViewportX, Math.min(maxViewportX, zoomState.viewportX));
        zoomState.viewportY = Math.max(-maxViewportY, Math.min(maxViewportY, zoomState.viewportY));
        
        applyZoom();
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    updateZoomButtons();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑—É–º–∞
function handleZoomIn(e) {
    const zoomInBtn = document.getElementById('zoom-in-btn');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–Ω–æ–ø–∫–∞
    if (!zoomInBtn || zoomInBtn.disabled) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ, –∞ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ
    if (e.target !== zoomInBtn && !zoomInBtn.contains(e.target)) {
        return;
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    if (e.type === 'touchstart' || e.type === 'touchend') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ —á–∞—Å—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        if (zoomState.isDragging) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞—Å–∞–Ω–∏–µ —Ç–æ—á–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ
        const rect = zoomInBtn.getBoundingClientRect();
        const touch = e.type === 'touchstart' ? e.touches[0] : e.changedTouches[0];
        const x = touch.clientX;
        const y = touch.clientY;
        
        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
        }
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    if (e.type === 'touchstart' && e.changedTouches.length > 1) {
        return;
    }
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
    if (zoomInBtn.dataset.processing === 'true') {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –±—ã—Å—Ç—Ä—ã—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
    const now = Date.now();
    const lastClick = parseInt(zoomInBtn.dataset.lastClick || '0');
    if (now - lastClick < 300) { // 300ms –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    zoomInBtn.dataset.processing = 'true';
    zoomInBtn.dataset.lastClick = now.toString();
    
    setTimeout(() => {
        zoomIn();
        zoomInBtn.dataset.processing = 'false';
    }, 200); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 200ms
}

function handleZoomOut(e) {
    const zoomOutBtn = document.getElementById('zoom-out-btn');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–Ω–æ–ø–∫–∞
    if (!zoomOutBtn || zoomOutBtn.disabled) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ, –∞ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ
    if (e.target !== zoomOutBtn && !zoomOutBtn.contains(e.target)) {
        return;
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    if (e.type === 'touchstart' || e.type === 'touchend') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ —á–∞—Å—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        if (zoomState.isDragging) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞—Å–∞–Ω–∏–µ —Ç–æ—á–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ
        const rect = zoomOutBtn.getBoundingClientRect();
        const touch = e.type === 'touchstart' ? e.touches[0] : e.changedTouches[0];
        const x = touch.clientX;
        const y = touch.clientY;
        
        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
        }
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    if (e.type === 'touchstart' && e.changedTouches.length > 1) {
        return;
    }
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
    if (zoomOutBtn.dataset.processing === 'true') {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –±—ã—Å—Ç—Ä—ã—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
    const now = Date.now();
    const lastClick = parseInt(zoomOutBtn.dataset.lastClick || '0');
    if (now - lastClick < 300) { // 300ms –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    zoomOutBtn.dataset.processing = 'true';
    zoomOutBtn.dataset.lastClick = now.toString();
    
    setTimeout(() => {
        zoomOut();
        zoomOutBtn.dataset.processing = 'false';
    }, 200); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 200ms
}

function handleZoomReset(e) {
    const zoomResetBtn = document.getElementById('zoom-reset-btn');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –∫–Ω–æ–ø–∫–∞
    if (!zoomResetBtn || zoomResetBtn.disabled) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ, –∞ –Ω–µ —Å–ª—É—á–∞–π–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ
    if (e.target !== zoomResetBtn && !zoomResetBtn.contains(e.target)) {
        return;
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    if (e.type === 'touchstart' || e.type === 'touchend') {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –Ω–µ —á–∞—Å—Ç—å –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
        if (zoomState.isDragging) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–∞—Å–∞–Ω–∏–µ —Ç–æ—á–Ω–æ –ø–æ –∫–Ω–æ–ø–∫–µ
        const rect = zoomResetBtn.getBoundingClientRect();
        const touch = e.type === 'touchstart' ? e.touches[0] : e.changedTouches[0];
        const x = touch.clientX;
        const y = touch.clientY;
        
        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            return false;
        }
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
    if (e.type === 'touchstart' && e.changedTouches.length > 1) {
        return;
    }
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
    if (zoomResetBtn.dataset.processing === 'true') {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –±—ã—Å—Ç—Ä—ã—Ö –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –Ω–∞–∂–∞—Ç–∏–π
    const now = Date.now();
    const lastClick = parseInt(zoomResetBtn.dataset.lastClick || '0');
    if (now - lastClick < 300) { // 300ms –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    zoomResetBtn.dataset.processing = 'true';
    zoomResetBtn.dataset.lastClick = now.toString();
    
    setTimeout(() => {
        resetZoom();
        zoomResetBtn.dataset.processing = 'false';
    }, 200); // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 200ms
}

function handleContextMenu(e) {
    if (zoomState.isDragging) {
        e.preventDefault();
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º—ã—à–∏
function startDrag(e) {
    // –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –∑—É–º –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
    if (zoomState.scale <= 1) {
        e.preventDefault();
        e.stopPropagation();
        return;
    }
    
    if (zoomState.scale > 1) {
        zoomState.isDragging = true;
        zoomState.startX = e.clientX;
        zoomState.startY = e.clientY;
        zoomState.startViewportX = zoomState.viewportX;
        zoomState.startViewportY = zoomState.viewportY;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å dragging –∫ –ø–æ–ª–æ—Ç–Ω—É
        const imageCanvas = viewerEl.querySelector('.image-canvas');
        if (imageCanvas) {
            imageCanvas.classList.add('dragging');
        }
        
        e.preventDefault();
    }
}

function drag(e) {
    if (zoomState.isDragging && zoomState.scale > 1) {
        // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
        const deltaX = e.clientX - zoomState.startX;
        const deltaY = e.clientY - zoomState.startY;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É –ø–æ–ª–æ–∂–µ–Ω–∏—é viewport
        const newViewportX = zoomState.startViewportX + deltaX;
        const newViewportY = zoomState.startViewportY + deltaY;
        
        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞ –∏ –∑—É–º–∞
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const scale = zoomState.scale;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ viewport
        const maxViewportX = viewportWidth * (scale - 1) * 0.5;
        const maxViewportY = viewportHeight * (scale - 1) * 0.5;
        
        zoomState.viewportX = Math.max(-maxViewportX, Math.min(maxViewportX, newViewportX));
        zoomState.viewportY = Math.max(-maxViewportY, Math.min(maxViewportY, newViewportY));
        
        applyZoom();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
        updateZoomButtons();
        
        e.preventDefault();
    }
}

function endDrag(e) {
    if (zoomState.isDragging) {
        zoomState.isDragging = false;
        
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å dragging —Å –ø–æ–ª–æ—Ç–Ω–∞
        const imageCanvas = viewerEl.querySelector('.image-canvas');
        if (imageCanvas) {
            imageCanvas.classList.remove('dragging');
        }
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–∞—á-—Å–æ–±—ã—Ç–∏–π
function startDragTouch(e) {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –∑—É–º–∞
    if (e.target.closest('.zoom-btn')) {
        e.preventDefault();
        e.stopPropagation();
        return;
    }
    
    // –ï—Å–ª–∏ —ç—Ç–æ pinch-–∂–µ—Å—Ç, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
    if (e.touches.length > 1) {
        return;
    }
    
    // –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –µ—Å–ª–∏ –∑—É–º –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
    if (zoomState.scale <= 1) {
        e.preventDefault();
        e.stopPropagation();
        return;
    }
    
    if (zoomState.scale > 1 && e.touches.length === 1) {
        const touch = e.touches[0];
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ - —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —ç—Ç–æ –Ω–µ –∫–∞—Å–∞–Ω–∏–µ –ø–æ –∫–Ω–æ–ø–∫–µ
        const zoomControls = document.querySelector('.zoom-controls');
        if (zoomControls) {
            const rect = zoomControls.getBoundingClientRect();
            const x = touch.clientX;
            const y = touch.clientY;
            
            // –ï—Å–ª–∏ –∫–∞—Å–∞–Ω–∏–µ –≤ –æ–±–ª–∞—Å—Ç–∏ –∫–Ω–æ–ø–æ–∫ –∑—É–º–∞, –Ω–µ –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
            if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }
        }
        
        zoomState.isDragging = true;
        zoomState.startX = touch.clientX;
        zoomState.startY = touch.clientY;
        zoomState.startViewportX = zoomState.viewportX;
        zoomState.startViewportY = zoomState.viewportY;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å dragging –∫ –ø–æ–ª–æ—Ç–Ω—É
        const imageCanvas = viewerEl.querySelector('.image-canvas');
        if (imageCanvas) {
            imageCanvas.classList.add('dragging');
        }
        
        e.preventDefault();
        e.stopPropagation();
    }
}

function dragTouch(e) {
    // –ï—Å–ª–∏ —ç—Ç–æ pinch-–∂–µ—Å—Ç, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
    if (e.touches.length > 1) {
        return;
    }
    
    if (zoomState.isDragging && zoomState.scale > 1 && e.touches.length === 1) {
        const touch = e.touches[0];
        
        // –í—ã—á–∏—Å–ª—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –æ—Ç –Ω–∞—á–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
        const deltaX = touch.clientX - zoomState.startX;
        const deltaY = touch.clientY - zoomState.startY;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–º–µ—â–µ–Ω–∏–µ –∫ –Ω–∞—á–∞–ª—å–Ω–æ–º—É –ø–æ–ª–æ–∂–µ–Ω–∏—é viewport
        const newViewportX = zoomState.startViewportX + deltaX;
        const newViewportY = zoomState.startViewportY + deltaY;
        
        // –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞ —ç–∫—Ä–∞–Ω–∞ –∏ –∑—É–º–∞
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const scale = zoomState.scale;
        
        // –í—ã—á–∏—Å–ª—è–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ viewport
        const maxViewportX = viewportWidth * (scale - 1) * 0.5;
        const maxViewportY = viewportHeight * (scale - 1) * 0.5;
        
        zoomState.viewportX = Math.max(-maxViewportX, Math.min(maxViewportX, newViewportX));
        zoomState.viewportY = Math.max(-maxViewportY, Math.min(maxViewportY, newViewportY));
        
        applyZoom();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–∏
        updateZoomButtons();
        
        e.preventDefault();
        e.stopPropagation();
    }
}

function endDragTouch(e) {
    // –ï—Å–ª–∏ —ç—Ç–æ pinch-–∂–µ—Å—Ç, –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
    if (e.touches.length > 1) {
        return;
    }
    
    if (zoomState.isDragging) {
        zoomState.isDragging = false;
        
        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å dragging —Å –ø–æ–ª–æ—Ç–Ω–∞
        const imageCanvas = viewerEl.querySelector('.image-canvas');
        if (imageCanvas) {
            imageCanvas.classList.remove('dragging');
        }
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–ª–µ—Å–∏–∫–∞ –º—ã—à–∏ –¥–ª—è –∑—É–º–∞
function handleWheel(e) {
    e.preventDefault();
    
    // –ù–∞ –ü–ö —Ä–∞–∑—Ä–µ—à–∞–µ–º –∑—É–º –∫–æ–ª–µ—Å–∏–∫–æ–º –≤—Å–µ–≥–¥–∞, –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–º –∑—É–º–µ
    const isMobile = window.innerWidth <= 768;
    
    if (isMobile && zoomState.scale <= 1) {
        return;
    }
    
    if (e.deltaY < 0) {
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö - —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∑—É–º
        zoomIn();
    } else if (e.deltaY > 0) {
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ - —É–º–µ–Ω—å—à–∞–µ–º –∑—É–º
        zoomOut();
    }
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è pinch-to-zoom
let lastPinchDistance = 0;
let isPinching = false;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–æ—á–∫–∞–º–∏
function getDistance(touches) {
    const dx = touches[0].clientX - touches[1].clientX;
    const dy = touches[0].clientY - touches[1].clientY;
    return Math.sqrt(dx * dx + dy * dy);
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ pinch-to-zoom –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
function handlePinchStart(e) {
    if (e.touches.length === 2) {
        isPinching = true;
        lastPinchDistance = getDistance(e.touches);
        e.preventDefault();
        e.stopPropagation();
    }
}

function handlePinchMove(e) {
    if (isPinching && e.touches.length === 2) {
        const currentDistance = getDistance(e.touches);
        const distanceDiff = currentDistance - lastPinchDistance;
        
        // –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∑—É–º–∞
        if (Math.abs(distanceDiff) > 10) {
            if (distanceDiff > 0) {
                // –†–∞–∑–≤–µ–¥–µ–Ω–∏–µ –ø–∞–ª—å—Ü–µ–≤ - —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
                zoomIn();
            } else {
                // –°–∂–∞—Ç–∏–µ –ø–∞–ª—å—Ü–µ–≤ - —É–º–µ–Ω—å—à–µ–Ω–∏–µ
                zoomOut();
            }
            lastPinchDistance = currentDistance;
        }
        
        e.preventDefault();
        e.stopPropagation();
    }
}

function handlePinchEnd(e) {
    isPinching = false;
    lastPinchDistance = 0;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∑—É–º–∞
function handleDoubleClick(e) {
    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–∫–ª—é—á–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –Ω–∞ —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö –∏ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    if ('ontouchstart' in window || window.innerWidth <= 768) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    // –ó–∞–ø—Ä–µ—â–∞–µ–º –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –µ—Å–ª–∏ –∑—É–º –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω
    if (zoomState.scale <= 1) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
    }
    
    e.preventDefault();
    e.stopPropagation();
    
    if (zoomState.scale === 1) {
        // –ï—Å–ª–∏ –∑—É–º —Å–±—Ä–æ—à–µ–Ω, —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 2x
        zoomState.scale = 2;
        applyZoom();
        updateZoomButtons();
        viewerEl.classList.add('zoom-mode');
    } else {
        // –ï—Å–ª–∏ –∑—É–º –∞–∫—Ç–∏–≤–µ–Ω, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º
        resetZoom();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
function restoreModalStates() {
    // –¢–µ–ø–µ—Ä—å modalManager —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç z-index
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ image viewer (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
function restoreImageViewerHandlers() {
    if (!viewerEl) return;
    
    // –ü—Ä–æ—Å—Ç–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    viewerEl.classList.remove('visible', 'zoomed');
    viewerEl.classList.add('viewer-hidden');
    viewerEl.style.zIndex = '-1';
    
    // –û—á–∏—â–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if (viewerImg) {
        viewerImg.src = '';
        viewerImg.classList.remove('zoomed');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è image viewer (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
function resetImageViewer() {
    if (!viewerEl) return;
    
    // –ü—Ä–æ—Å—Ç–æ–µ —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
    viewerEl.classList.remove('visible', 'zoomed');
    viewerEl.classList.add('viewer-hidden');
    viewerEl.style.zIndex = '-1';
    
    // –û—á–∏—â–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    if (viewerImg) {
        viewerImg.src = '';
        viewerImg.classList.remove('zoomed');
    }
    
    // –£–±–∏—Ä–∞–µ–º overflow-hidden
    document.body.classList.remove('overflow-hidden');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è image viewer (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
function checkImageViewerState() {
    if (!viewerEl) return;
    
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    const isHidden = viewerEl.classList.contains('viewer-hidden');
    const isVisible = viewerEl.classList.contains('visible');
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    if (isHidden && isVisible) {
        resetImageViewer();
        return true;
    }
    
    return false;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
function forceRestoreAllModals() {
    // –¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ–º modalManager –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
    if (modalManager.getOpenModalsCount() > 0) {
        // modalManager —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
    }
    
    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ image viewer –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç
    if (viewerEl && viewerEl.classList.contains('viewer-hidden')) {
        viewerEl.style.zIndex = '-1';
        viewerEl.style.pointerEvents = 'none';
    }
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º overflow-hidden –¥–ª—è body
    document.body.classList.add('overflow-hidden');
}

function closeModal() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    S.selPartId = null;
    S.partModal = {
        groupId: null,
        variants: [],
        selColorId: null,
        qty: 1,
        loadingColors: !1,
        loadingImg: !1,
        imgUrl: null
    };
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ modalManager
    modalManager.closeModal('modal-container');
}

function closeSetModal() {
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    S.selSetNum = null;
    S.setModal = {
        loading: !1,
        inv: [],
        invPage: 1,
        hasNextInv: !1,
        qty: 1,
        bulkUpdate: !1,
        status: "",
        statusType: "",
        view: "details",
        minifigs: [],
        loadingMinifigs: !1
    };
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ modalManager
    modalManager.closeModal('set-modal-container');
}

function closeMinifigModal() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞, –Ω–æ –ù–ï —Å–±—Ä–∞—Å—ã–≤–∞–µ–º selFigNum
    // –µ—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –ø–æ–∫–∞–∑–∞—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã
    S.minifigModal = {
        loading: !1,
        qty: 1,
        view: 'details',
        inv: null,
        loadingInv: !1,
        invError: !1,
        bulkUpdate: !1,
        status: '',
        statusType: ''
    };
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ modalManager
    modalManager.closeModal('minifig-modal-container');
}

function closeFilterModal() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    S.filterOpen = false;
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    S.selFigNum = null;
    S.showRelatedSets = false;
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ modalManager
    modalManager.closeModal('filter-modal-container');
}

function closeRelatedSetsModal() {
    console.log('closeRelatedSetsModal called');
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ modalManager
    modalManager.closeModal('related-sets-modal-container');
}

function closeWishlistModal() {
    console.log('closeWishlistModal called');
    
    S.wishlistModal = { open: false, wishlistId: null, wishlist: null };
    updateUI();
}

// –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –ø–∞–ø–æ–∫ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è - —É –Ω–∞—Å –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π
function toggleWishlistExpand(wishlistId) {
    console.log('‚ÑπÔ∏è toggleWishlistExpand called but not needed - using single wishlist');
}

// –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏

// –§—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω—ã - —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∞–º–∏

function removeFromWishlist(wishlistId, itemId) {
    const wishlist = S.wishlists[wishlistId];
    if (!wishlist) return;
    
    // –ù–∞—Ö–æ–¥–∏–º –∏ —É–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç
    const itemIndex = wishlist.items.findIndex(item => item.id === itemId);
    if (itemIndex === -1) return;
    
    const item = wishlist.items[itemIndex];
    wishlist.items.splice(itemIndex, 1);
    wishlist.modified = new Date().toISOString();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
    if (S.wishlistModal.open && S.wishlistModal.wishlistId === wishlistId) {
        S.wishlistModal.wishlist = wishlist;
    }
    
    saveState();
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–±—Ä–∞–Ω–æ
    updateUI();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å—Ç—å –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ –∂–µ–ª–∞–Ω–∏–π
function isInWishlist(itemType, itemId, colorId = null) {
    const itemKey = colorId ? `${itemType}:${itemId}:${colorId}` : `${itemType}:${itemId}`;
    const singleWishlistId = 'main-wishlist';
    
    const wishlist = S.wishlists[singleWishlistId];
    if (wishlist && wishlist.items) {
        return wishlist.items.some(item => item.id === itemKey);
    }
    return false;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –ø–æ –¥–∞–Ω–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–∞
function removeFromWishlistByItem(itemType, itemId, colorId = null) {
    const itemKey = colorId ? `${itemType}:${itemId}:${colorId}` : `${itemType}:${itemId}`;
    const singleWishlistId = 'main-wishlist';
    
    const wishlist = S.wishlists[singleWishlistId];
    if (wishlist && wishlist.items) {
        const itemIndex = wishlist.items.findIndex(item => item.id === itemKey);
        if (itemIndex !== -1) {
            const item = wishlist.items[itemIndex];
            wishlist.items.splice(itemIndex, 1);
            wishlist.modified = new Date().toISOString();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
            if (S.wishlistModal.open && S.wishlistModal.wishlistId === singleWishlistId) {
                S.wishlistModal.wishlist = wishlist;
            }
            
            saveState();
            // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–±—Ä–∞–Ω–æ
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI
            if (S.view === 'catalog' || (S.view === 'tools' && S.toolSubView === 'wishlist')) {
                S.gridStale = true;
                updateUI();
            }
            return;
        }
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ –∂–µ–ª–∞–Ω–∏–π
function moveWishlistItemUp(wishlistId, itemId) {
    console.log('üîÑ moveWishlistItemUp called:', { wishlistId, itemId });
    
    const wishlist = S.wishlists[wishlistId];
    if (!wishlist) {
        console.log('‚ùå Wishlist not found');
        return;
    }
    
    const itemIndex = wishlist.items.findIndex(item => item.id === itemId);
    console.log('üîÑ Item index:', itemIndex, 'Total items:', wishlist.items.length);
    
    if (itemIndex <= 0) {
        console.log('‚ùå Cannot move - already at beginning or not found');
        return; // –£–∂–µ –≤ –Ω–∞—á–∞–ª–µ —Å–ø–∏—Å–∫–∞
    }
    
    const container = document.querySelector(`.wishlist-drop-zone[data-wishlist-id="${wishlistId}"]`);
    if (!container) {
        console.log('‚ùå Container not found');
        return;
    }
    
    // –ù–∞—Ö–æ–¥–∏–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const currentItem = document.querySelector(`[data-item-id="${itemId}"]`);
    const previousItem = document.querySelector(`[data-item-id="${wishlist.items[itemIndex - 1].id}"]`);
    
    console.log('üîÑ DOM elements:', { currentItem, previousItem });
    
    if (!currentItem || !previousItem) {
        console.log('‚ùå DOM elements not found');
        return;
    }
    
    console.log('üîÑ Starting instant swap');
    
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –≤ –¥–∞–Ω–Ω—ã—Ö
    const temp = wishlist.items[itemIndex];
    wishlist.items[itemIndex] = wishlist.items[itemIndex - 1];
    wishlist.items[itemIndex - 1] = temp;
    
    console.log('üîÑ Data swapped, new order:', wishlist.items.map(item => item.id));
    
    wishlist.modified = new Date().toISOString();
    saveState();
    
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –≤ DOM –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
    console.log('üîÑ Swapping in DOM');
    container.insertBefore(currentItem, previousItem);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    updateWishlistButtonStates(wishlistId);
    console.log('üîÑ Swap completed');
    
    console.log(`‚úÖ Moved item ${itemId} up in wishlist ${wishlistId}`);
}

function moveWishlistItemDown(wishlistId, itemId) {
    console.log('üîÑ moveWishlistItemDown called:', { wishlistId, itemId });
    
    const wishlist = S.wishlists[wishlistId];
    if (!wishlist) {
        console.log('‚ùå Wishlist not found');
        return;
    }
    
    const itemIndex = wishlist.items.findIndex(item => item.id === itemId);
    console.log('üîÑ Item index:', itemIndex, 'Total items:', wishlist.items.length);
    
    if (itemIndex === -1 || itemIndex >= wishlist.items.length - 1) {
        console.log('‚ùå Cannot move - already at end or not found');
        return; // –£–∂–µ –≤ –∫–æ–Ω—Ü–µ —Å–ø–∏—Å–∫–∞
    }
    
    const container = document.querySelector(`.wishlist-drop-zone[data-wishlist-id="${wishlistId}"]`);
    if (!container) {
        console.log('‚ùå Container not found');
        return;
    }
    
    // –ù–∞—Ö–æ–¥–∏–º DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const currentItem = document.querySelector(`[data-item-id="${itemId}"]`);
    const nextItem = document.querySelector(`[data-item-id="${wishlist.items[itemIndex + 1].id}"]`);
    
    console.log('üîÑ DOM elements:', { currentItem, nextItem });
    
    if (!currentItem || !nextItem) {
        console.log('‚ùå DOM elements not found');
        return;
    }
    
    console.log('üîÑ Starting instant swap');
    
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –≤ –¥–∞–Ω–Ω—ã—Ö
    const temp = wishlist.items[itemIndex];
    wishlist.items[itemIndex] = wishlist.items[itemIndex + 1];
    wishlist.items[itemIndex + 1] = temp;
    
    console.log('üîÑ Data swapped, new order:', wishlist.items.map(item => item.id));
    
    wishlist.modified = new Date().toISOString();
    saveState();
    
    // –ú–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏ –≤ DOM –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
    console.log('üîÑ Swapping in DOM');
    container.insertBefore(nextItem, currentItem);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    updateWishlistButtonStates(wishlistId);
    console.log('üîÑ Swap completed');
    
    console.log(`‚úÖ Moved item ${itemId} down in wishlist ${wishlistId}`);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
function updateWishlistButtonStates(wishlistId) {
    const wishlist = S.wishlists[wishlistId];
    if (!wishlist) return;
    
    const container = document.querySelector(`.wishlist-drop-zone[data-wishlist-id="${wishlistId}"]`);
    if (!container) return;
    
    const items = container.querySelectorAll('.wishlist-item');
    items.forEach((item, index) => {
        const leftButton = item.querySelector('.move-left');
        const rightButton = item.querySelector('.move-right');
        
        if (leftButton) {
            leftButton.disabled = index === 0;
            leftButton.classList.toggle('opacity-50', index === 0);
        }
        
        if (rightButton) {
            rightButton.disabled = index === items.length - 1;
            rightButton.classList.toggle('opacity-50', index === items.length - 1);
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π
function updateWishlistItemsSmoothly(wishlistId) {
    const wishlist = S.wishlists[wishlistId];
    if (!wishlist) return;
    
    const container = document.querySelector(`.wishlist-drop-zone[data-wishlist-id="${wishlistId}"]`);
    if (!container) return;
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    const currentItems = Array.from(container.querySelectorAll('.wishlist-item'));
    
    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π HTML –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const newItemsHTML = wishlist.items.map(item => renderWishlistItemCard(item, wishlistId)).join('');
    
    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = newItemsHTML;
    const newItems = Array.from(tempContainer.children);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–µ —Ç—Ä–æ–≥–∞—è –∏—Ö –ø–æ–∑–∏—Ü–∏–∏
    currentItems.forEach((currentItem, index) => {
        if (newItems[index]) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –∫–ª–∞—Å—Å—ã –∞–Ω–∏–º–∞—Ü–∏–∏
            const hasJumpingUp = currentItem.classList.contains('jumping-up');
            const hasJumpingDown = currentItem.classList.contains('jumping-down');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
            currentItem.innerHTML = newItems[index].innerHTML;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∞—Å—Å—ã –∞–Ω–∏–º–∞—Ü–∏–∏
            if (hasJumpingUp) {
                currentItem.classList.add('jumping-up');
            }
            if (hasJumpingDown) {
                currentItem.classList.add('jumping-down');
            }
        }
    });
    
    // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –¥–æ–±–∞–≤–ª—è–µ–º –∏–ª–∏ —É–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ
    if (newItems.length > currentItems.length) {
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        for (let i = currentItems.length; i < newItems.length; i++) {
            container.appendChild(newItems[i]);
        }
    } else if (newItems.length < currentItems.length) {
        // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        for (let i = currentItems.length - 1; i >= newItems.length; i--) {
            currentItems[i].remove();
        }
    }
}

function closeSettingsModal() {
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    S.settingsOpen = false;
    S.settingsModal.delConfirm = null;
    S.settingsModal.status = '';
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ modalManager
    modalManager.closeModal('settings-modal-container');
}
function openModalForPart(e, t, o) {
    const l = PART_MAP[e];
    if (l) {
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ—Ç–∞–ª–∏ (–≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
        hideSidebarHint();
        
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —ç–∫—Ä–∞–Ω –ø–∞–ø–∫–∏ —Ü–≤–µ—Ç–æ–≤ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª–∫–∏ –¥–µ—Ç–∞–ª–∏
        try { if (colorsModalEl && !colorsModalEl.classList.contains('modal-hidden')) { modalManager.closeModal('colors-modal-container'); } } catch {}
        // –ï—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–∏, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
        if (S.selPartId && S.selPartId !== e) {
            console.log('openModalForPart: Closing previous part modal for:', S.selPartId);
            modalManager.closeModal('modal-container');
        }
        
        // –£–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –≤–∞—Ä–∏–∞—Ü–∏–π –∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç—å
        let variants = Array.isArray(o) ? o : [];
        const seen = new Set();
        variants = variants.filter(v => {
            const id = v?.id || v?.part_num;
            if (!id || seen.has(id)) return false;
            seen.add(id);
            return true;
        });
        // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –¥–µ—Ç–∞–ª—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ä–µ–¥–∏ –≤–∞—Ä–∏–∞—Ü–∏–π, –¥–æ–±–∞–≤–∏–º –µ—ë –≤ –Ω–∞—á–∞–ª–æ
        const currId = l.id || l.part_num;
        if (currId && !seen.has(currId)) variants.unshift(l);
        S.selPartId = e;
        S.partModal = {
            groupId: t,
            variants,
            selColorId: null,
            qty: 0,
            loadingColors: !1,
            loadingImg: !1,
            imgUrl: l.rebrickable_img_url || null
        };
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ modalManager
        modalManager.openModal('modal-container', partModalEl);
        renderModal();
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –¥–µ—Ç–∞–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        fetchImagesForViewedItems().catch(console.error);
        
        if (l.availableColorIds) {
            if (l.availableColorIds.length > 0) {
                S.partModal.selColorId = sortColorIds(l.availableColorIds, l.id)[0];
                S.partModal.qty = S.coll[e]?.[S.partNum]?.[S.partModal.selColorId] || 0;
                updateModalPartially({
                    controls: !0
                });
                fetchPartColorSpecifics(l.id, S.partModal.selColorId);
            } else {
                fetchPartColors(l.id);
            }
        } else {
            fetchPartColors(l.id);
        }
    }
}

function setupColorsScrollProgress() {
    const track = document.getElementById('colors-scroll-progress');
    const scrollArea = document.getElementById('colors-modal-scroll');
    if (!track || !scrollArea) return;
    const update = () => {
        if (!track || !scrollArea) return;
        // –í—ã—Ä–æ–≤–Ω—è—Ç—å —Ç—Ä–µ–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏ —Å —É—á—ë—Ç–æ–º sticky-–∑–∞–≥–æ–ª–æ–≤–∫–∞
        const header = document.getElementById('colors-modal-header');
        const headerH = header?.offsetHeight || 0;
        const top = Math.max(12, headerH + 8);
        track.style.top = top + 'px';
        track.style.bottom = '12px';
        const max = (scrollArea.scrollHeight - scrollArea.clientHeight);
        const percent = max <= 0 ? 100 : Math.min(100, Math.max(0, (scrollArea.scrollTop / max) * 100));
        const containerH = track.clientHeight || 0;
        const bar = track.querySelector('.bar');
        const barH = bar?.clientHeight || 24;
        const maxOffset = Math.max(0, containerH - barH);
        const translatePx = (percent / 100) * maxOffset;
        if (bar) bar.style.transform = `translateY(${translatePx}px)`;
    };
    update();
    let to;
    const onScroll = () => {
        track?.classList.add('visible');
        update();
        clearTimeout(to);
        to = setTimeout(() => track?.classList.remove('visible'), 200);
    };
    scrollArea.addEventListener('scroll', onScroll, { passive: true });
    window.addEventListener('resize', () => update(), { passive: true });
}

// –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ: –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ü–≤–µ—Ç–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–µ—Ç–∞–ª–∏ –≤ –≤–∏–¥–µ –∫–∞—Ä—Ç–æ—á–µ–∫
function openColorsModalForPart(partId) {
    const part = PART_MAP[partId];
    if (!part) return;
    
    // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ü–≤–µ—Ç–æ–≤ (–≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
    hideSidebarHint();
    
    const colorIds = Object.keys(S.coll[partId] || {});
    if (colorIds.length === 0 && part.availableColorIds && part.availableColorIds.length > 0) {
        // –µ—Å–ª–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–µ—Ç, –Ω–æ –µ—Å—Ç—å –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ ‚Äî –ø–æ–∫–∞–∂–µ–º –∏—Ö
        colorIds.push(...part.availableColorIds);
    }
    const unique = Array.from(new Set(colorIds));
    const entries = unique.map(cid => ({ part, color: COLOR_MAP[cid], quantity: (S.coll?.[partId]?.[cid] || 0) }));
    modalManager.openModal('colors-modal-container', colorsModalEl);
    const selCount = S.multiSelect.items?.size || 0;
    const showMultiselectBarInModal = S.multiSelect.active && S.collectionMultiSelectEnabled;
    const colorsSelBar = showMultiselectBarInModal ? `
        <div id="multiselect-bar" class="mt-3 bg-gray-800/80 border border-gray-700 rounded-[18px] p-2 flex items-center justify-between gap-2 flex-nowrap overflow-x-auto no-scrollbar" style="${S.multiSelect.justActivated ? 'animation: msSlideFadeIn .36s cubic-bezier(.22,.61,.36,1) both;' : ''}">
            <div class="flex items-center gap-3 flex-shrink-0">
                <button data-action="cancel-multiselect" class="text-gray-300 hover:text-white" title="–û—Ç–º–µ–Ω–∏—Ç—å –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä">${I_X('w-5 h-5')}</button>
                <span class="text-sm text-gray-300">–í—ã–±—Ä–∞–Ω–æ: <strong>${selCount}</strong></span>
            </div>
            <div class="flex items-center gap-2 flex-nowrap flex-shrink-0">
                <button data-action="select-all-visible" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold px-3 py-2 rounded-[18px] transition-colors duration-150 shadow-lg hover:shadow-blue-500/25" title="–î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä">+ –í—Å–µ</button>
                <button data-action="share-multiselect" class="flex items-center gap-2 bg-gray-700 hover:bg-gray-600 text-white text-sm font-semibold px-3 py-2 rounded-[18px] transition-colors duration-150 shadow-lg hover:shadow-gray-500/25" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏ —á–µ—Ä–µ–∑ CSV —Ñ–∞–π–ª –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">${I_Share('w-5 h-5')} <span class="hidden sm:inline">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</span></button>
                <button data-action="delete-multiselect" class="flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white text-sm font-semibold px-3 py-2 rounded-[18px] transition-colors duration-150 shadow-lg hover:shadow-red-500/25" title="–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏">${I_Trash('w-5 h-5')} <span class="hidden sm:inline">–£–¥–∞–ª–∏—Ç—å</span></button>
            </div>
        </div>
    ` : '';
    const cards = entries.map((entry, idx) => renderPartCard(entry.part, entry.color, entry.quantity, true, idx)).join("");
    colorsModalEl.innerHTML = `
        <div class="bg-gray-900 rounded-[18px] shadow-xl w-[calc(100%-2rem)] max-w-5xl flex flex-col max-h-[calc(100vh-2rem)] overflow-hidden modal-content-enter">
            <div class="relative flex-grow overflow-y-auto no-scrollbar bg-gray-900" id="colors-modal-scroll">
                <div id="colors-scroll-progress"><div class="bar"></div></div>
                <div id="colors-modal-header" class="sticky top-0 z-10 bg-gray-900 p-4 border-b border-gray-700 flex flex-col gap-3">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl lg:text-2xl font-bold text-white truncate pr-4 modal-title-multiline">${part.name} ‚Äî ${getColorWord(unique.length)} (${unique.length})</h2>
                        <button id="colors-modal-close" class="modal-close-btn" title="–ó–∞–∫—Ä—ã—Ç—å">${I_X('w-4 h-4')}</button>
                    </div>
                    ${colorsSelBar}
                </div>
                <div class="p-4">
                    <div class="bg-gray-800/60 rounded-[18px] p-3">
                        <div class="folder-grid">${cards}</div>
                    </div>
                </div>
            </div>
        </div>`;
    setupColorsScrollProgress();
}

function openModalForSet(e) {
    if (SET_MAP[e]) {
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞–±–æ—Ä–∞ (–≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
        hideSidebarHint();
        
        // –ï—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–±–æ—Ä–∞, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
        if (S.selSetNum && S.selSetNum !== e) {
            console.log('openModalForSet: Closing previous set modal for:', S.selSetNum);
            modalManager.closeModal('set-modal-container');
        }
        
        S.selSetNum = e;
        S.setModal = {
            loading: !1,
            inv: [],
            invPage: 1,
            hasNextInv: !1,
            qty: S.setColl[e]?.qty || 0,
            bulkUpdate: !1,
            status: "",
            statusType: "",
            view: "details",
            minifigs: [],
            loadingMinifigs: !1
        };
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ modalManager
        console.log('openModalForSet: Before modalManager.openModal - current z-indexes:');
        modalManager.debugZIndexes();
        modalManager.openModal('set-modal-container', setModalEl);
        console.log('openModalForSet: After modalManager.openModal - current z-indexes:');
        modalManager.debugZIndexes();
        renderSetModal(!0);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–∞–ª–µ—Ä–µ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞–±–æ—Ä–∞
        try { initSetImageGallery(S.selSetNum); } catch(_) {}
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –Ω–∞–±–æ—Ä–∞ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        fetchImagesForViewedItems().catch(console.error);
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –≤–µ—Å—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å –Ω–∞–±–æ—Ä–∞
        loadAllSetInventoryIntoModal(e);
        fetchSetMinifigs(e);
    }
}
function openModalForMinifig(e) {
    if (MINIFIG_MAP[e]) {
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ (–≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ—Å–Ω–æ–≤–Ω–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ)
        hideSidebarHint();
        
        // –ï—Å–ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
        if (S.selFigNum && S.selFigNum !== e) {
            console.log('openModalForMinifig: Closing previous minifig modal for:', S.selFigNum);
            modalManager.closeModal('minifig-modal-container');
        }
        
        S.selFigNum = e;
        S.minifigModal = {
            loading: !1,
            qty: S.minifigColl[e]?.qty || 0,
            view: 'details',
            inv: null,
            loadingInv: !1,
            invError: !1,
            bulkUpdate: !1,
            status: '',
            statusType: ''
        };
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ modalManager
        modalManager.openModal('minifig-modal-container', minifigModalEl);
        renderMinifigModal(!0);
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∑–∞–≥—Ä—É–∂–∞–µ–º –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
        fetchImagesForViewedItems().catch(console.error);
    }
}

function refreshWithNewFilters() {
    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    document.body.classList.add('filtering');
    setTimeout(() => {
        document.body.classList.remove('filtering');
    }, 800);
    
    S.toDisplay = S.increment, S.gridStale = !0;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
    if ("collection" === S.view) {
        updateUI();
    } else if ("sets" === S.subView) {
        // –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–±–æ—Ä—ã –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        fetchSets();
    } else if ("minifigs" === S.subView) {
        // –í—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        fetchMinifigs();
    } else if (S.q) {
        searchRebrickableParts(S.q.trim());
    } else if (S.selCatId) {
        loadPartsForCategory(S.selCatId);
    } else {
        updateUI();
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è input –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("input", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via input event:', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è change –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("change", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via change event:', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è blur –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("blur", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via blur event:', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
}, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Ñ–∞–∑–µ –∑–∞—Ö–≤–∞—Ç–∞

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è keyup –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("keyup", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –∏–ª–∏ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
            if (e.key === 'Enter' || e.key === 'Escape') {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via keyup event:', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
                
                // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const applyButton = filterModalEl.querySelector('[data-action="modal-apply-filters"]');
                    if (applyButton) {
                        applyButton.click();
                    }
                }
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è paste –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("paste", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via paste event:', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è drop –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("drop", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via drop event:', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è compositionend –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("compositionend", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via compositionend event:', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è beforeinput –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("beforeinput", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            const newValue = e.data || '';
            if (newValue !== '') {
                tempFilters.setFilters[filterKey] = newValue;
                console.log('Filter updated via beforeinput event:', filterKey, '=', newValue);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è input –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("input", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via input event (all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è change –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("change", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via change event (all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è blur –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("blur", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via blur event (all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
}, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Ñ–∞–∑–µ –∑–∞—Ö–≤–∞—Ç–∞

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è keyup –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("keyup", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            if (e.key === 'Enter' || e.key === 'Escape') {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via keyup event (all types):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
                
                // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const applyButton = filterModalEl.querySelector('[data-action="modal-apply-filters"]');
                    if (applyButton) {
                        applyButton.click();
                    }
                }
            }
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è paste –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("paste", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via paste event (all types):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è drop –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("drop", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via drop event (all types):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è compositionend –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("compositionend", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via compositionend event (all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è beforeinput –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("beforeinput", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            const newValue = e.data || '';
            if (newValue !== '') {
                tempFilters.setFilters[filterKey] = newValue;
                console.log('Filter updated via beforeinput event (all types):', filterKey, '=', newValue);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è input –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)
document.addEventListener("input", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via input event (final):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è change –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)
document.addEventListener("change", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via change event (final):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è blur –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)
document.addEventListener("blur", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via blur event (final):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
}, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Ñ–∞–∑–µ –∑–∞—Ö–≤–∞—Ç–∞

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è keyup –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)
document.addEventListener("keyup", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            if (e.key === 'Enter' || e.key === 'Escape') {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via keyup event (final):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
                
                // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const applyButton = filterModalEl.querySelector('[data-action="modal-apply-filters"]');
                    if (applyButton) {
                        applyButton.click();
                    }
                }
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è paste –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)
document.addEventListener("paste", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via paste event (final):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è drop –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)
document.addEventListener("drop", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via drop event (final):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è compositionend –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)
document.addEventListener("compositionend", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via compositionend event (final):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è beforeinput –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π)
document.addEventListener("beforeinput", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            const newValue = e.data || '';
            if (newValue !== '') {
                tempFilters.setFilters[filterKey] = newValue;
                console.log('Filter updated via beforeinput event (final):', filterKey, '=', newValue);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è input –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (—Ñ–∏–Ω–∞–ª—å–Ω—ã–π - –ø–æ—Å–ª–µ–¥–Ω–∏–π)
document.addEventListener("input", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via input event (final - last):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è compositionend –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —è–∑—ã–∫–æ–≤ —Å –∫–æ–º–ø–æ–∑–∏—Ü–∏–µ–π)
document.addEventListener("compositionend", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT' && t.type === 'number') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via compositionend event:', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è beforeinput –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("beforeinput", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT' && t.type === 'number') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
            const newValue = e.data || '';
            if (newValue !== '') {
                tempFilters.setFilters[filterKey] = newValue;
                console.log('Filter updated via beforeinput event:', filterKey, '=', newValue);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è input –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("input", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via input event (all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è change –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("change", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via change event (all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è blur –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("blur", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via blur event (all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
}, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Ñ–∞–∑–µ –∑–∞—Ö–≤–∞—Ç–∞
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è keyup –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("keyup", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            if (e.key === 'Enter' || e.key === 'Escape') {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via keyup event (all types):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
                
                // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const applyButton = filterModalEl.querySelector('[data-action="modal-apply-filters"]');
                    if (applyButton) {
                        applyButton.click();
                    }
                }
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è paste –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("paste", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via paste event (all types):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è drop –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("drop", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via drop event (all types):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è compositionend –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ —è–∑—ã–∫–æ–≤ —Å –∫–æ–º–ø–æ–∑–∏—Ü–∏–µ–π)
document.addEventListener("compositionend", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via compositionend event (all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è beforeinput –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.addEventListener("beforeinput", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            const newValue = e.data || '';
            if (newValue !== '') {
                tempFilters.setFilters[filterKey] = newValue;
                console.log('Filter updated via beforeinput event (all types):', filterKey, '=', newValue);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è input –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π)
document.addEventListener("input", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via input event (main):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è change –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π)
document.addEventListener("change", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via change event (main):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è blur –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π)
document.addEventListener("blur", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via blur event (main):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
}, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Ñ–∞–∑–µ –∑–∞—Ö–≤–∞—Ç–∞

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è keyup –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π)
document.addEventListener("keyup", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            if (e.key === 'Enter' || e.key === 'Escape') {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via keyup event (main):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
                
                // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const applyButton = filterModalEl.querySelector('[data-action="modal-apply-filters"]');
                    if (applyButton) {
                        applyButton.click();
                    }
                }
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è paste –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π)
document.addEventListener("paste", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via paste event (main):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è drop –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π)
document.addEventListener("drop", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via drop event (main):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è compositionend –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π)
document.addEventListener("compositionend", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via compositionend event (main):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è beforeinput –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π)
document.addEventListener("beforeinput", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            const newValue = e.data || '';
            if (newValue !== '') {
                tempFilters.setFilters[filterKey] = newValue;
                console.log('Filter updated via beforeinput event (main):', filterKey, '=', newValue);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è input –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π - –≤—Å–µ —Ç–∏–ø—ã)
document.addEventListener("input", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via input event (main - all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è change –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π - –≤—Å–µ —Ç–∏–ø—ã)
document.addEventListener("change", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via change event (main - all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è blur –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π - –≤—Å–µ —Ç–∏–ø—ã)
document.addEventListener("blur", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via blur event (main - all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
}, true); // –ò—Å–ø–æ–ª—å–∑—É–µ–º capture –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è –Ω–∞ —Ñ–∞–∑–µ –∑–∞—Ö–≤–∞—Ç–∞

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è keyup –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π - –≤—Å–µ —Ç–∏–ø—ã)
document.addEventListener("keyup", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            if (e.key === 'Enter' || e.key === 'Escape') {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via keyup event (main - all types):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
                
                // –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const applyButton = filterModalEl.querySelector('[data-action="modal-apply-filters"]');
                    if (applyButton) {
                        applyButton.click();
                    }
                }
            }
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è paste –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π - –≤—Å–µ —Ç–∏–ø—ã)
document.addEventListener("paste", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –≤—Å—Ç–∞–≤–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via paste event (main - all types):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è drop –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π - –≤—Å–µ —Ç–∏–ø—ã)
document.addEventListener("drop", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            setTimeout(() => {
                tempFilters.setFilters[filterKey] = t.value;
                console.log('Filter updated via drop event (main - all types):', filterKey, '=', t.value);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }, 0);
        }
    }
});
// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è compositionend –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π - –≤—Å–µ —Ç–∏–ø—ã)
document.addEventListener("compositionend", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            tempFilters.setFilters[filterKey] = t.value;
            console.log('Filter updated via compositionend event (main - all types):', filterKey, '=', t.value);
            console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è beforeinput –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ (–æ—Å–Ω–æ–≤–Ω–æ–π - –≤—Å–µ —Ç–∏–ø—ã)
document.addEventListener("beforeinput", e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t) && t.tagName === 'INPUT') {
        const filterKey = t.dataset.filterKey;
        if (filterKey && tempFilters && tempFilters.setFilters) {
            // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
            const newValue = e.data || '';
            if (newValue !== '') {
                tempFilters.setFilters[filterKey] = newValue;
                console.log('Filter updated via beforeinput event (main - all types):', filterKey, '=', newValue);
                console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
            }
        }
    }
});
document.addEventListener("click", async e => {
    if (!(e.target instanceof Element)) return;
    const t = e.target;
    
    // –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ –∫–ª–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    console.log('üñ±Ô∏è Click detected:', {
        target: t,
        id: t.id,
        className: t.className,
        tagName: t.tagName,
        closestMoveLeft: t.closest('.move-left'),
        closestMoveRight: t.closest('.move-right')
    });
    
    // –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò - –∫–Ω–æ–ø–∫–∏ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π (–µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫)
    
    // –ü—Ä–æ—Å–º–æ—Ç—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è –µ–¥–∏–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
    
    if (t.closest('.import-wishlist')) {
        e.preventDefault();
        e.stopPropagation();
        const wishlistId = t.closest('.import-wishlist').dataset.wishlistId;
        if (wishlistId) {
            importWishlist(wishlistId);
        }
        return;
    }
    
    if (t.closest('.export-wishlist')) {
        e.preventDefault();
        e.stopPropagation();
        const wishlistId = t.closest('.export-wishlist').dataset.wishlistId;
        if (wishlistId) {
            exportWishlist(wishlistId);
        }
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ –∂–µ–ª–∞–Ω–∏–π
    if (t.id === 'select-all-wishlist' || t.closest('#select-all-wishlist')) {
        e.preventDefault();
        e.stopPropagation();
        selectAllWishlistItems();
        return;
    }
    
    if (t.id === 'deselect-all-wishlist' || t.closest('#deselect-all-wishlist')) {
        e.preventDefault();
        e.stopPropagation();
        deselectAllWishlistItems();
        return;
    }
    
    if (t.id === 'export-selected-wishlist' || t.closest('#export-selected-wishlist')) {
        e.preventDefault();
        e.stopPropagation();
        exportSelectedWishlistItems();
        return;
    }
    
    if (t.id === 'share-selected-wishlist' || t.closest('#share-selected-wishlist')) {
        e.preventDefault();
        e.stopPropagation();
        shareSelectedWishlistItems();
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –≤ —Å–ø–∏—Å–∫–µ –∂–µ–ª–∞–Ω–∏–π
    const wishlistCheckbox = t.closest('.wishlist-item-checkbox');
    if (wishlistCheckbox) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('üîò Wishlist checkbox clicked:', wishlistCheckbox);
        
        if (wishlistCheckbox.classList.contains('selected')) {
            wishlistCheckbox.classList.remove('selected');
            wishlistCheckbox.innerHTML = I_Circle('w-3 h-3');
            console.log('üîò Unselected item');
        } else {
            wishlistCheckbox.classList.add('selected');
            wishlistCheckbox.innerHTML = I_CheckCircle('w-3 h-3');
            console.log('üîò Selected item');
        }
        
        updateWishlistSelectionUI();
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
    if (t.id === 'export-wishlist-from-modal') {
        e.preventDefault();
        e.stopPropagation();
        const wishlistId = t.dataset.wishlistId;
        if (wishlistId) {
            exportWishlist(wishlistId);
        }
        return;
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –µ–¥–∏–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω–æ
    
    if (t.closest('[data-action="remove-from-wishlist"]')) {
        e.preventDefault();
        e.stopPropagation();
        const removeButton = t.closest('[data-action="remove-from-wishlist"]');
        const wishlistId = removeButton.dataset.wishlistId;
        const itemId = removeButton.dataset.itemId;
        console.log('üóëÔ∏è Remove button clicked:', { wishlistId, itemId });
        if (wishlistId && itemId) {
            removeFromWishlist(wishlistId, itemId);
        }
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–ª–∞—Å—Å)
    if (t.closest('.remove-from-wishlist')) {
        e.preventDefault();
        e.stopPropagation();
        const removeButton = t.closest('.remove-from-wishlist');
        const wishlistId = removeButton.dataset.wishlistId;
        const itemId = removeButton.dataset.itemId;
        console.log('üóëÔ∏è Remove button clicked (modal):', { wishlistId, itemId });
        if (wishlistId && itemId) {
            removeFromWishlist(wishlistId, itemId);
        }
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
    if (t.closest('.move-left')) {
        console.log('üîÑ Move left clicked');
        e.preventDefault();
        e.stopPropagation();
        const wishlistId = t.closest('.move-left').dataset.wishlistId;
        const itemId = t.closest('.move-left').dataset.itemId;
        console.log('üîÑ Move left data:', { wishlistId, itemId });
        if (wishlistId && itemId) {
            moveWishlistItemUp(wishlistId, itemId);
        }
        return;
    }
    
    if (t.closest('.move-right')) {
        console.log('üîÑ Move right clicked');
        e.preventDefault();
        e.stopPropagation();
        const wishlistId = t.closest('.move-right').dataset.wishlistId;
        const itemId = t.closest('.move-right').dataset.itemId;
        console.log('üîÑ Move right data:', { wishlistId, itemId });
        if (wishlistId && itemId) {
            moveWishlistItemDown(wishlistId, itemId);
        }
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–ø–∏—Å–∫–∞ –∂–µ–ª–∞–Ω–∏–π
    if (t.closest('[data-action="open-item-modal"]')) {
        e.preventDefault();
        e.stopPropagation();
        const itemElement = t.closest('[data-action="open-item-modal"]');
        const itemType = itemElement.dataset.itemType;
        const itemId = itemElement.dataset.itemIdValue;
        
        if (itemType && itemId) {
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
            if (itemType === 'set') {
                openModalForSet(itemId);
            } else if (itemType === 'minifig') {
                openModalForMinifig(itemId);
            } else if (itemType === 'part') {
                // –î–ª—è –¥–µ—Ç–∞–ª–µ–π –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ü–≤–µ—Ç
                const fullItemId = itemElement.dataset.itemId;
                const colorId = fullItemId.split(':')[2];
                openModalForPart(itemId, colorId);
            }
        }
        return;
    }
    
    if (t.id === 'close-wishlist-modal' || t.id === 'close-wishlist-modal-bottom') {
        e.preventDefault();
        e.stopPropagation();
        closeWishlistModal();
        return;
    }
    
    // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –ø–∞–ø–æ–∫ –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –µ–¥–∏–Ω–æ–º —Å–ø–∏—Å–∫–µ –∂–µ–ª–∞–Ω–∏–π

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ data-action —É —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–ª–∏ –µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª–µ–π
    const actionElement = t.closest('[data-action]');
    if (actionElement) {
        switch (actionElement.dataset.action) {
            case "add-to-wishlist":
                e.preventDefault();
                e.stopPropagation();
                console.log('üéØ Add to wishlist button clicked!', actionElement);
                const itemType = actionElement.dataset.itemType;
                const itemId = actionElement.dataset.itemId;
                const colorId = actionElement.dataset.colorId;
                console.log('üìù Item data:', { itemType, itemId, colorId });
                if (itemType && itemId) {
                    if (isInWishlist(itemType, itemId, colorId)) {
                        // –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ - —É–¥–∞–ª—è–µ–º –µ–≥–æ
                        removeFromWishlistByItem(itemType, itemId, colorId);
                    } else {
                        // –≠–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ - –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                        addToWishlist(itemType, itemId, colorId);
                    }
                } else {
                    console.error('‚ùå Missing item data:', { itemType, itemId, colorId });
                }
                return;
            case "set-gallery-prev":
                e.preventDefault();
                e.stopPropagation();
                if (S.setModal) {
                    const total = S.setModal.gallery?.length || 0;
                    if (total > 1) {
                        const idx = (S.setModal.galleryIndex || 0);
                        S.setModal.galleryIndex = (idx - 1 + total) % total;
                        applySetGalleryImageToDom();
                    }
                }
                return;
            case "set-gallery-next":
                e.preventDefault();
                e.stopPropagation();
                tryAdvanceSetGalleryNext();
                return;
            case "part-variant-prev":
                e.preventDefault();
                e.stopPropagation();
                tryAdvancePartVariantPrev();
                return;
            case "part-variant-next":
                e.preventDefault();
                e.stopPropagation();
                tryAdvancePartVariantNext();
                return;
            case "minifig-gallery-prev":
                e.preventDefault();
                e.stopPropagation();
                if (S.minifigModal) {
                    const total = S.minifigModal.gallery?.length || 0;
                    if (total > 1) {
                        const idx = (S.minifigModal.galleryIndex || 0);
                        S.minifigModal.galleryIndex = (idx - 1 + total) % total;
                        applyMinifigGalleryImageToDom();
                    }
                }
                return;
            case "minifig-gallery-next":
                e.preventDefault();
                e.stopPropagation();
                tryAdvanceMinifigGalleryNext();
                return;
        }
    }

    // –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–∞—á–∞–ª–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –Ω–∞–±–æ—Ä–∞ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if (t.closest('[data-action="open-set-modal"]')) {
        e.preventDefault();
        e.stopPropagation();
        const setId = t.closest('[data-action="open-set-modal"]').dataset.setId;
        
        if (setId) {
            const set = SET_MAP[setId];
            if (set) {
                openModalForSet(setId);
            } else {
                console.log('‚ùå Set not found in SET_MAP for setId:', setId);
            }
        }
        return;
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if (t.closest('[data-action="open-minifig-modal"]')) {
        e.preventDefault();
        e.stopPropagation();
        const minifigId = t.closest('[data-action="open-minifig-modal"]').dataset.minifigId;
        
        if (minifigId) {
            const minifig = MINIFIG_MAP[minifigId];
            if (minifig) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                openModalForMinifig(minifigId);
            } else {
                console.log('‚ùå Minifig not found in MINIFIG_MAP for minifigId:', minifigId);
            }
        }
        return;
    }
    
    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–µ–º–µ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ (–∫–∞–∫ –≤ –º–æ–¥–∞–ª–∫–µ –Ω–∞–±–æ—Ä–æ–≤)
    if (t.closest('[data-action="go-to-theme"]')) {
        e.preventDefault();
        e.stopPropagation();
        const themeId = t.closest('[data-action="go-to-theme"]').dataset.themeId;
        
        if (themeId) {
            closeSetModal();
            S.view = "catalog";
            S.multiSelect.active = false;
            S.multiSelect.items = new Set();
            S.selThemeId = parseInt(themeId, 10);
            S.selFigNum = null;
            S.showRelatedSets = false;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –æ—Ç–∫—É–¥–∞ –±—ã–ª –∫–ª–∏–∫ - –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –Ω–∞–±–æ—Ä–æ–≤ –∏–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
            const clickedElement = t.closest('[data-action="go-to-theme"]');
            if (clickedElement && clickedElement.closest('#analytics-content')) {
                // –ï—Å–ª–∏ –∫–ª–∏–∫ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
                const analyticsContent = clickedElement.closest('#analytics-content');
                if (analyticsContent && analyticsContent.querySelector('[data-analytics-subview="sets"]')) {
                    S.subView = "sets";
                    fetchSets();
                } else if (analyticsContent && analyticsContent.querySelector('[data-analytics-subview="minifigs"]')) {
                    S.subView = "minifigs";
                    fetchMinifigs();
                } else {
                    // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞–±–æ—Ä—ã
                    S.subView = "sets";
                    fetchSets();
                }
            } else {
                // –ï—Å–ª–∏ –∫–ª–∏–∫ –∏–∑ –º–æ–¥–∞–ª–∫–∏ –Ω–∞–±–æ—Ä–∞, —Ç–æ –Ω–∞–±–æ—Ä—ã
                S.subView = "sets";
                fetchSets();
            }
            
        }
        return;
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if (t.closest('[data-action="switch-analytics-subview"]')) {
        e.preventDefault();
        e.stopPropagation();
        const subview = t.closest('[data-action="switch-analytics-subview"]').dataset.subview;
        
        if (subview && ['parts', 'sets', 'minifigs', 'dashboard'].includes(subview)) {
            S.analyticsSubView = subview;
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
            if (S.view === 'tools' && S.toolSubView === 'analytics') {
                console.log('üìä –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', subview);
                analyzeCollection();
            }
            updateUI();
        }
        return;
    }
    
    // –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò - –ø–æ—Å–ª–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    
    // –ú—É–ª—å—Ç–∏–≤—ã–±–æ—Ä: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ
    const selBtn = t.closest('[data-action="toggle-select"]');
    if (selBtn) {
        const type = selBtn.dataset.itemType;
        const id = selBtn.dataset.itemId;
        const colorId = selBtn.dataset.colorId || '';
        if (!type || !id) return;
        if (!S.multiSelect.active) { S.multiSelect.active = !0; S.multiSelect.justActivated = !0; }
        const key =
            type === 'part' ? `parts:${id}:${colorId}` :
            (type === 'part-folder' ? `parts-folder:${id}` :
            (type === 'set' ? `sets:${id}` : `minifigs:${id}`));
        if (S.multiSelect.items.has(key)) S.multiSelect.items.delete(key); else S.multiSelect.items.add(key);
        if (S.multiSelect.items.size === 0) { S.multiSelect.active = !1; S.multiSelect.justActivated = !1; }
        renderHeader();
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–≤–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞, —á—Ç–æ–±—ã –Ω–µ –∞–Ω–∏–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤—Ç–æ—Ä–æ–π –∏ –¥–∞–ª–µ–µ
        queueMicrotask(() => { S.multiSelect.justActivated = !1; });
        updateUI();
        return;
    }
    if (t.closest('#toggle-catalog-multiselect')) {
        S.catalogMultiSelectEnabled = !S.catalogMultiSelectEnabled;
        localStorage.setItem('catalogMultiSelectEnabled', String(S.catalogMultiSelectEnabled));
        // –ü—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
        if (!S.catalogMultiSelectEnabled) { S.multiSelect.active = false; S.multiSelect.items = new Set(); }
        renderHeader();
        updateUI();
        return;
    }
    if (t.closest('#toggle-collection-multiselect')) {
        S.collectionMultiSelectEnabled = !S.collectionMultiSelectEnabled;
        localStorage.setItem('collectionMultiSelectEnabled', String(S.collectionMultiSelectEnabled));
        if (!S.collectionMultiSelectEnabled) { S.multiSelect.active = false; S.multiSelect.items = new Set(); }
        renderHeader();
        updateUI();
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –∫–ª–∏–∫ image viewer
    if (viewerEl && !viewerEl.classList.contains("viewer-hidden") && !t.closest("#image-viewer-container")) {
        // –ï—Å–ª–∏ image viewer –æ—Ç–∫—Ä—ã—Ç –∏ –∫–ª–∏–∫ –Ω–µ –ø–æ –Ω–µ–º—É, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –ª–∏ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
    if (viewerEl && viewerEl.classList.contains("viewer-hidden")) {
        // –ï—Å–ª–∏ image viewer –∑–∞–∫—Ä—ã—Ç, –Ω–æ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏—Ö
        const activeModals = [
            { el: partModalEl, sel: S.selPartId },
            { el: setModalEl, sel: S.selSetNum },
            { el: minifigModalEl, sel: S.selFigNum },
            { el: filterModalEl, sel: S.filterOpen },
            { el: settingsModalEl, sel: S.settingsOpen },
            { el: relatedSetsModalEl, sel: !relatedSetsModalEl.classList.contains("modal-hidden") }
        ];
        
        const hasActiveModal = activeModals.some(modal => modal.sel);
        if (hasActiveModal) {
            restoreModalStates();
        }
    }
    
    const o = t.closest('[data-action="view-image-fullscreen"]');
    if (o?.dataset.imageUrl) return openImageViewer(o.dataset.imageUrl);
    
    
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if (t.closest('[data-action="filter-by-rarity"]')) {
        e.preventDefault();
        e.stopPropagation();
        const rarity = t.closest('[data-action="filter-by-rarity"]').dataset.rarity;
        const rarityName = getRarityName(rarity);
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏
        clearTemporaryFilters();
        S.view = 'collection';
        S.subView = 'parts';
        S.tempRarityFilter = rarity;
        
        applyTemporaryFilters();
        updateUI();
        return;
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ü–≤–µ—Ç—É –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if (t.closest('[data-action="filter-by-color"]')) {
        e.preventDefault();
        e.stopPropagation();
        const colorId = t.closest('[data-action="filter-by-color"]').dataset.colorId;
        const colorName = t.closest('[data-action="filter-by-color"]').dataset.colorName;
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ü–≤–µ—Ç—É
        clearTemporaryFilters();
        S.view = 'collection';
        S.subView = 'parts';
        S.tempColorFilter = colorId;
        
        applyTemporaryFilters();
        updateUI();
        return;
    }
    
    // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if (t.closest('[data-action="filter-by-category"]')) {
        e.preventDefault();
        e.stopPropagation();
        const categoryId = t.closest('[data-action="filter-by-category"]').dataset.categoryId;
        const categoryName = t.closest('[data-action="filter-by-category"]').dataset.categoryName;
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—é –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        clearTemporaryFilters();
        S.view = 'collection';
        S.subView = 'parts';
        S.tempCategoryFilter = categoryId;
        
        applyTemporaryFilters();
        updateUI();
        return;
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –¥–µ—Ç–∞–ª–∏ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
    if (t.closest('[data-action="open-part-modal"]')) {
        e.preventDefault();
        e.stopPropagation();
        const partId = t.closest('[data-action="open-part-modal"]').dataset.partId;
        const colorId = t.closest('[data-action="open-part-modal"]').dataset.colorId;
        
        if (partId) {
            const part = PART_MAP[partId];
            if (part) {
                const groupId = getGroupId(part.part_num || partId);
                openModalForPart(part.id || part.part_num || partId, groupId, [part]);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
                if (colorId) {
                    S.partModal.selColorId = String(colorId);
                    S.partModal.qty = S.coll[part.id]?.[S.partModal.selColorId] || 0;
                    updateModalPartially({ controls: true, image: true });
                    fetchPartColorSpecifics(part.id, S.partModal.selColorId);
                }
            }
        }
        return;
    }
    
    
    // –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (t.closest('[data-action="clear-temp-filters"]')) {
        e.preventDefault();
        e.stopPropagation();
        clearTemporaryFilters();
        updateUI();
        return;
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –¥–µ—Ç–∞–ª–∏ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–∞/–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    const invPartEl = t.closest('[data-action="open-part-from-inventory"]');
    const clickedActionEl = t.closest('[data-action]');
    const clickedAction = clickedActionEl?.dataset.action;
    if (invPartEl && (!clickedAction || clickedAction === 'open-part-from-inventory')) {
        const pid = invPartEl.getAttribute('data-part-id');
        const cid = invPartEl.getAttribute('data-color-id');
        const qty = parseInt(invPartEl.getAttribute('data-quantity') || '0');
        if (pid && cid) {
            const part = PART_MAP[pid] || PART_MAP[String(pid)];
            if (part) {
                const groupId = getGroupId(part.part_num || pid);
                openModalForPart(part.id || part.part_num || pid, groupId, [part]);
                
                // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–∏ –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö
                setTimeout(() => {
                    modalManager.bringToFront('modal-container');
                }, 100);
                
                S.partModal.selColorId = String(cid);
                S.partModal.qty = S.coll[part.id]?.[S.partModal.selColorId] || 0;
                updateModalPartially({ controls: !0, image: !0 });
                fetchPartColorSpecifics(part.id, S.partModal.selColorId);
            }
        }
        return;
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–∞
    const invFigEl = t.closest('[data-action="open-minifig-from-inventory"]');
    if (invFigEl && (!clickedAction || clickedAction === 'open-minifig-from-inventory')) {
        const figNum = invFigEl.getAttribute('data-fig-num');
        if (figNum) {
            openModalForMinifig(figNum);
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö
            setTimeout(() => {
                modalManager.bringToFront('minifig-modal-container');
            }, 100);
        }
        return;
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∏–∑ –ø—Ä–µ–≤—å—é –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
    const minifigPreviewEl = t.closest('[data-action="open-minifig-preview"]');
    if (minifigPreviewEl && (!clickedAction || clickedAction === 'open-minifig-preview')) {
        const figNum = minifigPreviewEl.getAttribute('data-fig-num');
        if (figNum) {
            openModalForMinifig(figNum);
            
            // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö
            setTimeout(() => {
                modalManager.bringToFront('minifig-modal-container');
            }, 100);
        }
        return;
    }
    
    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –¥–µ—Ç–∞–ª–∏ –∏–∑ –ø—Ä–µ–≤—å—é –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
    const partPreviewEl = t.closest('[data-action="open-part-preview"]');
    if (partPreviewEl && (!clickedAction || clickedAction === 'open-part-preview')) {
        const partId = partPreviewEl.getAttribute('data-part-id');
        if (partId) {
            const part = PART_MAP[partId] || PART_MAP[String(partId)];
            if (part) {
                const groupId = getGroupId(part.part_num || partId);
                openModalForPart(part.id || part.part_num || partId, groupId, [part]);
                setTimeout(() => {
                    modalManager.bringToFront('modal-container');
                }, 100);
            }
        }
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è image viewer (–≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
    if (t.closest("#image-viewer-close")) {
        animateCloseButtonClick(t.closest("#image-viewer-close"));
        return closeImageViewer();
    }
    
    if ("image-viewer-container" === t.id) return closeImageViewer();
    const l = t.closest('[data-action="toggle-favorite-category"]');
    if (l?.dataset.categoryId) {
        e.stopPropagation();
        const t = parseInt(l.dataset.categoryId, 10);
        return S.favCatIds.has(t) ? S.favCatIds.delete(t) : S.favCatIds.add(t), saveState(), void renderSidebar()
    }
    const a = t.closest('[data-action="toggle-favorite-theme"]');
    if (a?.dataset.themeId) {
        e.stopPropagation();
        const t = parseInt(a.dataset.themeId, 10);
        return S.favThemeIds.has(t) ? S.favThemeIds.delete(t) : S.favThemeIds.add(t), saveState(), void renderSidebar()
    }
    if (t.closest("#scroll-to-top-btn")) return mainEl.scrollTo({
        top: 0,
        behavior: "smooth"
    });
    if (t.closest("#sidebar-toggle")) {
        if (window.innerWidth >= 1024) {
            // –ù–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–∞
            return;
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
        const sidebarToggleBtn = t.closest("#sidebar-toggle");
        if (sidebarToggleBtn) {
            sidebarToggleBtn.style.transform = 'scale(0.9) rotate(-2deg)';
            setTimeout(() => {
                sidebarToggleBtn.style.transform = 'scale(1) rotate(0deg)';
            }, 150);
        }
        
        // –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        S.sidebarOpen = !S.sidebarOpen;
        
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        if (S.sidebarOpen) {
            hideSidebarHint();
        }
        
        updateUI();
    }
    if (t.closest("#sidebar-close")) {
        if (window.innerWidth >= 1024) {
            // –ù–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö –∫–Ω–æ–ø–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–∞
            return;
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
        const sidebarCloseBtn = t.closest("#sidebar-close");
        if (sidebarCloseBtn) {
            sidebarCloseBtn.style.transform = 'scale(0.9) rotate(2deg)';
            setTimeout(() => {
                sidebarCloseBtn.style.transform = 'scale(1) rotate(0deg)';
            }, 150);
        }
        
        // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        S.sidebarOpen = false;
        updateUI();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –≤ —Å–∫–∞–Ω–µ—Ä–µ –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
        if (S.view === 'tools' && S.toolSubView === 'scanner' && window.innerWidth < 1024) {
            setTimeout(() => {
                console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏...');
                showCameraSelectionModal();
            }, 300); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
        if (S.view === 'tools' && S.toolSubView === 'photo-search' && window.innerWidth < 1024) {
            setTimeout(() => {
                console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏...');
                showPhotoCameraSelectionModal();
            }, 300); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        hideSidebarHint();
    }
    if ("sidebar-backdrop" === t.id) {
        if (window.innerWidth >= 1024) {
            // –ù–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö backdrop –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç - –ø–∞–Ω–µ–ª—å –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–∞
            return;
        }
        // –†–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ —á–µ—Ä–µ–∑ backdrop –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        S.sidebarOpen = false;
        updateUI();
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –≤ —Å–∫–∞–Ω–µ—Ä–µ –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
        if (S.view === 'tools' && S.toolSubView === 'scanner' && window.innerWidth < 1024) {
            setTimeout(() => {
                console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (backdrop)...');
                showCameraSelectionModal();
            }, 300); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (—Ç–æ–ª—å–∫–æ –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö)
        if (S.view === 'tools' && S.toolSubView === 'photo-search' && window.innerWidth < 1024) {
            setTimeout(() => {
                console.log('–ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (backdrop)...');
                showPhotoCameraSelectionModal();
            }, 300); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        hideSidebarHint();
    }
    
    // –ö–Ω–æ–ø–∫–∏ "–ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ" —É–¥–∞–ª–µ–Ω—ã ‚Äî –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–µ –Ω—É–∂–µ–Ω
    const i = t.closest("[data-view]");
    if (i?.dataset.view) {
        const e = i.dataset.view;
        if (S.view === e) return;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–∞–∑–¥–µ–ª–æ–≤
        S.totalItems = null;
        S.loadedItems = null;
        S.originalSearchContext = null;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
        if (e === 'collection' && Object.keys(S.coll).length > 0) {
            updateLoadingStatus("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–ª–µ–∫—Ü–∏—é...", 50, "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–∏");
        } else if (e === 'catalog') {
            updateLoadingStatus("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥...", 50, "–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞");
        } else if (e === 'tools') {
            // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
            clearTemporaryFilters();
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            S.toolSubView = '';
            S.subView = '';
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            S.gridStale = true;
            updateLoadingStatus("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã...", 50, "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤");
        }
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        document.body.classList.add('tab-switching');
        setTimeout(() => {
            document.body.classList.remove('tab-switching');
        }, 300);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ö–∞—Ç–∞–ª–æ–≥/–ö–æ–ª–ª–µ–∫—Ü–∏—è
        S.multiSelect.active = false; S.multiSelect.items = new Set();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∏–¥—ã
        if (S.view === 'tools' && e !== 'tools') {
            S.toolSubView = '';
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º subView –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            S.subView = 'parts';
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –Ω–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ
            S.sortBy = 'popularity';
            console.log('üîß Resetting subView to parts and sortBy to popularity when switching from tools');
            
            // –û—á–∏—â–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            console.log('üîß –û—á–∏—Å—Ç–∫–∞ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...');
            cleanupCamera();
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω)
        const activeModal = document.querySelector('[id$="-modal-container"]:not(.modal-hidden)');
        if (!activeModal) {
            hideSidebarHint();
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º selFigNum —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ –∏ –≤–∫–ª–∞–¥–∫—É "–ù–∞–±–æ—Ä—ã"
        const shouldKeepSelFigNum = (e === 'catalog' && S.subView === 'sets' && S.selFigNum);
        const newSelFigNum = shouldKeepSelFigNum ? S.selFigNum : null;
        
        // –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ –∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
        if (e === 'catalog' || e === 'tools') {
            console.log(`Switching to ${e}, force closing all modals`);
            modalManager.closeAllModals();
            
            // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ (–≤—Å–µ–≥–¥–∞, —Ç–∞–∫ –∫–∞–∫ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞)
            hideSidebarHint();
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
            const allModals = [
                'modal-container',
                'set-modal-container', 
                'minifig-modal-container',
                'filter-modal-container',
                'settings-modal-container',
                'related-sets-modal-container'
            ];
            
            allModals.forEach(modalId => {
                const modalEl = document.getElementById(modalId);
                if (modalEl && !modalEl.classList.contains('modal-hidden')) {
                    console.log(`Force closing modal: ${modalId}`);
                    modalEl.classList.add('modal-hidden');
                    modalEl.classList.remove('visible');
                    modalEl.innerHTML = '';
                }
            });
            
            // –£–±–∏—Ä–∞–µ–º overflow-hidden
            document.body.classList.remove('overflow-hidden');
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
        resetRandomMinifigImage();
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
        if (window.stopTipRotation) {
            window.stopTipRotation();
        }
        
        console.log('üîÑ Switching to view:', e, 'from:', S.view);
        console.log('üîÑ Before reset - S.q:', S.q, 'S.searchGroups:', S.searchGroups, 'S.catGroups:', S.catGroups);
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ –Ω–∞—á–∞–ª—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É —Ä–∞–∑–¥–µ–ª–∞–º–∏
        if (mainEl) {
            mainEl.scrollTo({
                top: 0,
                behavior: 'instant'
            });
        }
        return S.view = e, S.q = "", S.err = null, S.gridStale = !0, S.selCatId = null, S.selCollCatId = null, S.selThemeId = null, S.selCollThemeId = null, S.selFigNum = newSelFigNum, S.searchGroups = null, S.catGroups = null, S.setRes = null, S.searchSetRes = null, S.minifigRes = null, S.searchMinifigRes = null, S.showUniversalSearch = false, S.universalSearchResults = null, S.universalSearchTerm = "", S.originalSearchContext = null, window.searchStateReset = true, console.log('üîÑ After reset - S.q:', S.q, 'S.searchGroups:', S.searchGroups, 'S.catGroups:', S.catGroups, 'S.showUniversalSearch:', S.showUniversalSearch, 'window.searchStateReset:', window.searchStateReset), void("catalog" === S.view && "minifigs" === S.subView && !S.minifigRes ? fetchMinifigs() : (updateUI(), setTimeout(() => {
            setupScrollListener();
            // –ù–ï –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Ä–æ—Ç–∞—Ü–∏—é –ø–æ–¥—Å–∫–∞–∑–æ–∫ - —ç—Ç–æ —Å–æ–∑–¥–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª!
            console.log('‚ö†Ô∏è Skipping tip rotation restart to prevent infinite loop');
        }, 50)))
    }
    const n = t.closest("[data-sub-view]");
    if (n?.dataset.subView) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É
        if (n.hasAttribute('data-long-press-triggered') || S.longPressTriggered) {
            console.log('üö´ Blocking click after long press on:', n.dataset.subView);
            console.log('üö´ Flags:', { 
                hasAttribute: n.hasAttribute('data-long-press-triggered'), 
                globalFlag: S.longPressTriggered 
            });
            n.removeAttribute('data-long-press-triggered');
            S.longPressTriggered = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ñ–ª–∞–≥
            return;
        }
        
        const e = n.dataset.subView;
        if (S.subView === e) return;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–¥–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π
        if (e === 'minifigs') {
            updateLoadingStatus("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏...", 60, "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫");
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
            resetRandomMinifigImage();
        } else if (e === 'sets') {
            updateLoadingStatus("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –Ω–∞–±–æ—Ä—ã...", 60, "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤");
        } else if (e === 'parts') {
            updateLoadingStatus("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –¥–µ—Ç–∞–ª–∏...", 60, "–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π");
        }
        
        // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–¥–≤–∫–ª–∞–¥–æ–∫ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        document.body.classList.add('tab-switching');
        setTimeout(() => {
            document.body.classList.remove('tab-switching');
        }, 1000);
        
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –ø–æ–¥–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω)
        const activeModal = document.querySelector('[id$="-modal-container"]:not(.modal-hidden)');
        if (!activeModal) {
            hideSidebarHint();
        }
        
        S.subView = e;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Ä–∞–∑–¥–µ–ª –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞–º–∏
        if (S.view === 'tools') {
            console.log('üîß Resetting toolSubView in subview handler, current toolSubView:', S.toolSubView);
            console.log('üîß Current subView being set to:', e);
            S.toolSubView = '';
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å
            const sidebarEl = document.getElementById('sidebar');
            if (sidebarEl) {
                const newHTML = renderSidebar();
                console.log('üîß Subview handler: New sidebar HTML length:', newHTML.length);
                sidebarEl.innerHTML = newHTML;
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ HTML –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
                if (newHTML.includes('–ê–Ω–∞–ª–∏—Ç–∏–∫–∞')) {
                    console.log('‚úÖ Subview handler: Tools list found in sidebar HTML');
                } else {
                    console.log('‚ùå Subview handler: Tools list NOT found in sidebar HTML');
                }
            }
        }
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫
        if (window.stopTipRotation) {
            window.stopTipRotation();
        }
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å –≤–∫–ª–∞–¥–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        if (S.view === 'tools' && S.toolSubView === 'cloud-backup' && e !== 'tools') {
            console.log('‚èπÔ∏è Stopping periodic versions refresh - leaving tools tab');
            stopPeriodicVersionsRefresh();
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∫–ª–∞–¥–∫–∏
        if (e !== 'sets') {
            S.selFigNum = null;
            S.showRelatedSets = false;
        }
        S.q = "";
        S.err = null;
        S.increment = "minifigs" === e ? 100 : 100;
        S.toDisplay = S.increment;
        S.gridStale = !0;
        S.filters = { colorIds: [], inCollectionOnly: !1 };
        S.setFilters = { minYear: "", maxYear: "", minParts: "", maxParts: "" };
        S.selCatId = null;
        S.selCollCatId = null;
        S.selThemeId = null;
        S.selCollThemeId = null;
        S.searchGroups = null;
        S.catGroups = null;
        S.setRes = null;
        S.searchSetRes = null;
        S.minifigRes = null;
        S.searchMinifigRes = null;
        S.showUniversalSearch = false;
        S.universalSearchResults = null;
        S.universalSearchTerm = "";
        S.originalSearchContext = null;
        
        if ("sets" === e) {
            S.sortBy = "year_desc";
        } else if ("minifigs" === e) {
            S.sortBy = "name_asc";
        } else {
            S.sortBy = "popularity";
        }
        
        if ("catalog" === S.view && "minifigs" === e && !S.minifigRes) {
            fetchMinifigs();
            
        } else if ("minifigs" === e && S.view === "collection" && Object.keys(S.minifigColl).length > 0) {
            fetchMissingCollectionMinifigDetails().then(() => { 
                S.gridStale = true; 
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ –Ω–∞—á–∞–ª—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
                if (mainEl) {
                    mainEl.scrollTo({
                        top: 0,
                        behavior: 'instant'
                    });
                }
                updateUI(); 
                
            }).catch(console.error);
        } else {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –∫ –Ω–∞—á–∞–ª—É –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏
            if (mainEl) {
                mainEl.scrollTo({
                    top: 0,
                    behavior: 'instant'
                });
            }
            updateUI();
        }
        
        // –ï—Å–ª–∏ –º—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏, –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞
        if (S.view === "catalog") {
            // –î–µ–ª–∞–µ–º —Ç–æ –∂–µ —Å–∞–º–æ–µ, —á—Ç–æ –∏ –∫–Ω–æ–ø–∫–∞ "–ö–∞—Ç–∞–ª–æ–≥"
            console.log('Switching tabs in catalog, refreshing catalog state');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä
            S.multiSelect.active = false; 
            S.multiSelect.items = new Set();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
            resetRandomMinifigImage();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            updateUI();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
            setupScrollListener();
            
        }
        
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        setupScrollListener();
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
    const toolSubViewBtn = t.closest("[data-tool-sub-view]");
    if (toolSubViewBtn?.dataset.toolSubView) {
        const toolSubView = toolSubViewBtn.dataset.toolSubView;
        if (S.toolSubView === toolSubView) return;
        
        // –û—á–∏—â–∞–µ–º –∫–∞–º–µ—Ä—É –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        if ((S.toolSubView === 'scanner' || S.toolSubView === 'photo-search') && toolSubView !== 'scanner' && toolSubView !== 'photo-search') {
            console.log('üîß –û—á–∏—Å—Ç–∫–∞ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...');
            cleanupCamera();
        }
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å –≤–∫–ª–∞–¥–∫–∏ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
        if (S.toolSubView === 'cloud-backup' && toolSubView !== 'cloud-backup') {
            console.log('‚èπÔ∏è Stopping periodic versions refresh - leaving cloud backup tab');
            stopPeriodicVersionsRefresh();
        }
        
        S.toolSubView = toolSubView;
        S.gridStale = true;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
        if (toolSubView === 'cloud-backup') {
            console.log('‚òÅÔ∏è Cloud backup tab opened, checking saved state');
            setTimeout(() => {
                if (window.remoteStorageAvailable) {
                    checkSavedCloudStorageState();
                    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                    updateCloudStorageUI();
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ä—Å–∏–π –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
                    debouncedLoadBackupsList(true, 500); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É
                    if (cloudStorageConnected && cloudStorageClient) {
                        startPeriodicVersionsRefresh();
                    }
                } else {
                    console.log('‚ö†Ô∏è RemoteStorage not available');
                }
            }, 100);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        updateUI();
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    if (t.closest('#connect-cloud-storage')) {
        e.preventDefault();
        e.stopPropagation();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        const connectionState = getCloudStorageConnectionState();
        
        if (connectionState.showReconnectButton) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç, –Ω–æ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è - –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
            console.log('üîß Found saved account, attempting reconnection:', connectionState.account);
            isReconnecting = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç RemoteStorage
            if (!cloudStorageClient) {
                cloudStorageClient = new RemoteStorage({
                    logging: 'warn',
                    cache: false,
                    // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫
                    redirectUri: window.location.origin + window.location.pathname
                });
                cloudStorageClient.access.claim('lego-catalog', 'rw');
                setupRemoteStorageEventHandlers();
            }
            
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É
            try {
                cloudStorageClient.connect(connectionState.account);
                updateCloudStorageStatus('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', 'info');
            } catch (error) {
                console.error('‚ùå Reconnection failed:', error);
                isReconnecting = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                updateCloudStorageStatus('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
            }
        } else if (connectionState.showConnectButton) {
            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç –¥–ª—è –≤–≤–æ–¥–∞ email
            console.log('üîß New user, showing connection widget...');
            setTimeout(() => {
                if (window.remoteStorageAvailable) {
                    console.log('üîß Initializing RemoteStorage widget...');
                    initializeRemoteStorageWidget();
                } else {
                    console.error('‚ùå RemoteStorage not available');
                    updateCloudStorageStatus('RemoteStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'error');
                }
            }, 100);
        } else if (connectionState.isConnected) {
            // –ï—Å–ª–∏ —É–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º UI
            console.log('üîß Already connected, updating UI');
            updateCloudStorageUI();
        }
        return;
    }
    
    
    if (t.closest('#backup-to-cloud')) {
        e.preventDefault();
        e.stopPropagation();
        saveToCloud();
        return;
    }
    
    if (t.closest('#restore-from-cloud')) {
        e.preventDefault();
        e.stopPropagation();
        loadFromCloud();
        return;
    }
    
    if (t.closest('#reconnect-cloud-storage')) {
        e.preventDefault();
        e.stopPropagation();
        // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è
        cloudStorageConnected = false;
        saveRemoteStorageState(false);
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤–∏–¥–∂–µ—Ç –∑–∞–Ω–æ–≤–æ
        setTimeout(() => {
            if (window.remoteStorageAvailable) {
                console.log('üîß Reconnecting RemoteStorage widget...');
                initializeRemoteStorageWidget();
            }
        }, 500);
        return;
    }
    
    if (t.closest('#logout-cloud-storage')) {
        e.preventDefault();
        e.stopPropagation();
        logoutFromCloudStorage();
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    if (t.closest('#toggle-instruction')) {
        e.preventDefault();
        e.stopPropagation();
        const content = document.getElementById('instruction-content');
        const button = t.closest('#toggle-instruction');
        
        if (content && button) {
            const textSpan = button.querySelector('span:last-child');
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                if (textSpan) textSpan.textContent = '–°–∫—Ä—ã—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏';
            } else {
                content.classList.add('hidden');
                if (textSpan) textSpan.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏';
            }
        }
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π
    if (t.closest('#refresh-backups')) {
        e.preventDefault();
        e.stopPropagation();
        debouncedLoadBackupsList(true, 100); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
        return;
    }
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è/—Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è —Å–≤–æ–¥–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    if (t.closest('#collection-summary-toggle')) {
        S.collectionSummaryExpanded = !S.collectionSummaryExpanded;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
        localStorage.setItem('collectionSummaryExpanded', String(S.collectionSummaryExpanded));
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI
        renderSidebar();
        return;
    }
    
    if (t.closest('[data-action="show-all-collection-items"]') || t.closest('[data-action="show-all-items-parts"]')) {
        // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤ "–≤—Å–µ –¥–µ—Ç–∞–ª–∏" –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π
        resetRandomMinifigImage();
        
        if (S.view === 'collection') {
            document.body.classList.add('collection-view');
            setTimeout(() => document.body.classList.remove('collection-view'), 800);
            if (S.subView === 'parts') S.selCollCatId = null;
            if (S.subView === 'sets') S.selCollThemeId = null;
            S.gridStale = true;
            updateUI();
        } else {
            document.body.classList.add('catalog-view');
            setTimeout(() => document.body.classList.remove('catalog-view'), 800);
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
            S.view = 'catalog';
            S.subView = 'parts';
            S.selCatId = null;
            S.selFigNum = null;
            S.showRelatedSets = false;
            S.q = '';
            try {
                const allParts = Object.values(PART_MAP).filter(Boolean);
                S.searchGroups = groupParts(allParts);
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
                S.totalPartsInCatalog = allParts.length;
            } catch (err) {
                console.warn('Failed to build all parts groups, falling back to UI update only', err);
                S.searchGroups = {};
                S.totalPartsInCatalog = 0;
            }
            S.gridStale = true;
            updateUI();
        }
        return;
    }
    if (t.closest('[data-action="show-all-items-sets"]')) {
        // –í –∫–∞—Ç–∞–ª–æ–≥–µ: –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–∞–±–æ—Ä—ã
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –≤—Å–µ—Ö –Ω–∞–±–æ—Ä–æ–≤
        resetRandomMinifigImage();
        
        S.view = 'catalog';
        S.subView = 'sets';
        S.selThemeId = null;
        S.selFigNum = null;
        S.showRelatedSets = false;
        S.q = '';
        S.gridStale = true;
        fetchSets();
        return;
    }
    const r = t.closest("[data-theme-id]");
    if (r?.dataset.themeId) {
        const e = parseInt(r.dataset.themeId, 10),
            t = THEME_MAP[e],
            o = t && Array.isArray(t.children) && t.children.length > 0;
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ "–ù–µ–¥–∞–≤–Ω–∏–µ"
        try {
            const rec = { type: 'theme', id: e };
            const arr = Array.isArray(S.sidebarRecent) ? S.sidebarRecent : [];
            const newArr = [rec, ...arr.filter(x => !(x.type==='theme' && x.id===e))].slice(0, 10);
            S.sidebarRecent = newArr; saveState();
        } catch {}
        if (o) {
            S.expThemes.has(e) ? S.expThemes.delete(e) : S.expThemes.add(e)
        }
        // –ü–µ—Ä–µ—Ö–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ–∂–∏–º–µ (–∫–∞—Ç–∞–ª–æ–≥/–∫–æ–ª–ª–µ–∫—Ü–∏—è)
        if ("collection" === S.view) {
            // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Ç–µ–º –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            document.body.classList.add('collection-view');
            setTimeout(() => {
                document.body.classList.remove('collection-view');
            }, 800);
            
            S.selCollThemeId !== e && (S.selCollThemeId = e, S.gridStale = !0, updateUI());
        }
        else if (S.selThemeId !== e) {
            // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–∞–º –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            document.body.classList.add('theme-navigation');
            setTimeout(() => {
                document.body.classList.remove('theme-navigation');
            }, 800);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Ç–µ–º–∞–º
            resetRandomMinifigImage();
            
            S.selThemeId = e, S.selFigNum = null, S.showRelatedSets = false, S.q = "", S.sortBy = "year_desc", S.setFilters = {
                minYear: "",
                maxYear: "",
                minParts: "",
                maxParts: ""
            };
            fetchSets()
        }
        return void(o && renderSidebar())
    }
    const s = t.closest("[data-parent-category]");
    if (s?.dataset.parentCategory) {
        const e = s.dataset.parentCategory,
            t = S.expCats.has(e);
        return t ? S.expCats.delete(e) : S.expCats.add(e), void renderSidebar()
    }
    const c = t.closest("[data-category-id]");
    if (c?.dataset.categoryId) {
        const e = parseInt(c.dataset.categoryId, 10);
        // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ "–ù–µ–¥–∞–≤–Ω–∏–µ"
        try {
            const rec = { type: 'category', id: e };
            const arr = Array.isArray(S.sidebarRecent) ? S.sidebarRecent : [];
            const newArr = [rec, ...arr.filter(x => !(x.type==='category' && x.id===e))].slice(0, 10);
            S.sidebarRecent = newArr; saveState();
        } catch {}
        // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        document.body.classList.add('category-navigation');
        setTimeout(() => {
            document.body.classList.remove('category-navigation');
        }, 800);
        // –ü–µ—Ä–µ—Ö–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ —Ç–µ–∫—É—â–µ–º —Ä–µ–∂–∏–º–µ (–∫–∞—Ç–∞–ª–æ–≥/–∫–æ–ª–ª–µ–∫—Ü–∏—è)
        return S.q = "", S.selFigNum = null, S.showRelatedSets = false, "collection" === S.view ? (() => {
            // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞–Ω–∏–∏ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            document.body.classList.add('collection-view');
            setTimeout(() => {
                document.body.classList.remove('collection-view');
            }, 800);
            
            S.selCollCatId !== e && (S.selCollCatId = e, S.gridStale = !0, updateUI());
        })() : (() => {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
            resetRandomMinifigImage();
            
            S.selCatId !== e && (S.selCatId = e, S.filters = {
                colorIds: [],
                inCollectionOnly: !1
            }, S.sortBy = "popularity", loadPartsForCategory(e));
            return void 0;
        })();
    }
    
    const d = t.closest('[data-action="delete-from-collection"]');
    if (d?.dataset.partId && d.dataset.colorId) return await handleUpdateCollection(d.dataset.partId, d.dataset.colorId, 0);
    const delFolderBtn = t.closest('[data-action="delete-folder-from-collection"]');
    if (delFolderBtn) {
        const pid = delFolderBtn.getAttribute('data-part-id');
        if (pid && S.coll[pid]) {
            const colors = Object.keys(S.coll[pid]);
            for (const cid of colors) {
                await handleUpdateCollection(pid, cid, 0);
            }
        }
        return;
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–∞–ø–∫–∏
    const closeFolderBtn = t.closest('[data-action="close-folder"]');
    if (closeFolderBtn) {
        const pid = closeFolderBtn.getAttribute('data-part-id');
        if (pid) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–ø–∫—É, —É–¥–∞–ª—è—è –µ—ë –∏–∑ expandedFolders
            if (!S.expandedFolders) S.expandedFolders = new Set();
            S.expandedFolders.delete(String(pid));
            S.gridStale = true;
            updateUI();
        }
        return;
    }
    const u = t.closest(".minifig-card");
    if (u?.dataset.figNum) {
        const delFigBtn = t.closest('[data-action="delete-minifig-from-collection"]');
        if (delFigBtn) {
            const num = delFigBtn.dataset.figNum;
            if (num) handleUpdateMinifigCollection(num, 0, false);
            return;
        }
        const selFigBtn = t.closest('[data-action="toggle-select"]');
        if (selFigBtn) return; // –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—ã—à–µ
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ (–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ, –∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏)
        openModalForMinifig(u.dataset.figNum);
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö
        setTimeout(() => {
            modalManager.bringToFront('minifig-modal-container');
        }, 100);
        return;
    }
    const g = t.closest(".set-card");
    if (g?.dataset.setNum) {
        const delSetBtn = t.closest('[data-action="delete-set-from-collection"]');
        if (delSetBtn) {
            const num = delSetBtn.dataset.setNum;
            if (num) handleUpdateSetCollection(num, 0);
            return;
        }
        const selSetBtn = t.closest('[data-action="toggle-select"]');
        if (selSetBtn) return; // –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—ã—à–µ
        openModalForSet(g.dataset.setNum);
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–±–æ—Ä–∞ –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö
        setTimeout(() => {
            modalManager.bringToFront('set-modal-container');
        }, 100);
        return;
    }
    const m = t.closest(".part-card");
    if (m?.dataset.groupId && m.dataset.partId) {
        const partId = m.dataset.partId,
            groupId = m.dataset.groupId,
            part = PART_MAP[partId];
        if (!part) return;
        let groupPartsArr = [part];
        if ("catalog" === S.view) {
            const groups = S.searchGroups || S.catGroups;
            groupPartsArr = groups && groups[groupId] ? groups[groupId] : [part]
        } else {
            const isFolder = m.hasAttribute('data-folder');
            const isColorsModalOpen = colorsModalEl && !colorsModalEl.classList.contains('modal-hidden');
            const cardColorId = m.getAttribute('data-color-id');
            // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ —Ü–≤–µ—Ç–∞ (–Ω–µ –ø–∞–ø–∫–µ) ‚Äî –≤—Å–µ–≥–¥–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –¥–µ—Ç–∞–ª–∏
            if (!isFolder && cardColorId) {
                openModalForPart(partId, groupId, [part]);
                S.partModal.selColorId = String(cardColorId);
                S.partModal.qty = S.coll[partId]?.[S.partModal.selColorId] || 0;
                updateModalPartially({ controls: !0, image: !0 });
                fetchPartColorSpecifics(partId, S.partModal.selColorId);
                return;
            }
            // –ï—Å–ª–∏ —ç—Ç–æ –ø–∞–ø–∫–∞ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —Ü–≤–µ—Ç–æ–≤ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ >3 —Ü–≤–µ—Ç–æ–≤
            if (isFolder) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∫–ª–∏–∫–Ω—É–ª–∏ –ª–∏ –ø–æ –∫–Ω–æ–ø–∫–µ –∑–∞–∫—Ä—ã—Ç–∏—è
                const closeBtn = t.closest('[data-action="close-folder"]');
                if (closeBtn) {
                    // –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤—ã—à–µ
                    return;
                }
                
                // –¢–æ–≥–ª–∏–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏–µ –ø–∞–ø–∫–∏ ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ—è–≤—è—Ç—Å—è —Ä—è–¥–æ–º
                if (!S.expandedFolders) S.expandedFolders = new Set();
                const key = String(partId);
                if (S.expandedFolders.has(key)) S.expandedFolders.delete(key); else S.expandedFolders.add(key);
                S.gridStale = true;
                updateUI();
                return;
            }
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç —ç–∫—Ä–∞–Ω –ø–∞–ø–∫–∏ –∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–ø–∫—É –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å
            if (isColorsModalOpen) {
                modalManager.closeModal('colors-modal-container');
                openModalForPart(partId, groupId, [part]);
                setTimeout(() => modalManager.bringToFront('modal-container'), 50);
                if (cardColorId) {
                    S.partModal.selColorId = String(cardColorId);
                    S.partModal.qty = S.coll[partId]?.[S.partModal.selColorId] || 0;
                    updateModalPartially({ controls: !0, image: !0 });
                    fetchPartColorSpecifics(partId, S.partModal.selColorId);
                }
                return;
            }
            // –§–æ–ª–±—ç–∫: –æ–±—ã—á–Ω–∞—è –º–æ–¥–∞–ª–∫–∞
            openModalForPart(partId, groupId, [part]);
            return;
        }
        const selPartBtn = t.closest('[data-action="toggle-select"]');
        if (selPartBtn) return; // –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—ã—à–µ
        openModalForPart(partId, groupId, groupPartsArr);
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–∏ –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö
        setTimeout(() => {
            modalManager.bringToFront('modal-container');
        }, 100);
        if ("collection" === S.view && m.dataset.colorId) {
            S.partModal.selColorId = m.dataset.colorId;
            S.partModal.qty = S.coll[partId]?.[S.partModal.selColorId] || 0;
            updateModalPartially({
                controls: !0
            });
            fetchPartColorSpecifics(partId, S.partModal.selColorId);
        }
        return;
    }
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ü–≤–µ—Ç–æ–≤
    if (t.id === 'colors-modal-close' || t.closest('#colors-modal-close') || t.id === 'colors-modal-container') {
        if (t.closest('#colors-modal-close')) {
            animateCloseButtonClick(t.closest('#colors-modal-close'));
        }
        modalManager.closeModal('colors-modal-container');
        return;
    }
    // –ü–∞–ø–∫–∏ —Ç–µ–ø–µ—Ä—å –∫–ª–∏–∫–∞—é—Ç—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ (–æ—Ç–∫—Ä—ã–≤–∞—é—Ç –º–æ–¥–∞–ª–∫—É), –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç–æ–≥–≥–ª–µ—Ä –Ω–µ –Ω—É–∂–µ–Ω
    if ("modal-container" === t.id || t.closest("#modal-close")) {
        if (t.closest("#modal-close")) {
            animateCloseButtonClick(t.closest("#modal-close"));
        }
        return closeModal();
    }
    if ("set-modal-container" === t.id || t.closest("#set-modal-close")) {
        if (t.closest("#set-modal-close")) {
            animateCloseButtonClick(t.closest("#set-modal-close"));
        }
        return closeSetModal();
    }
    if ("minifig-modal-container" === t.id || t.closest("#minifig-modal-close")) {
        if (t.closest("#minifig-modal-close")) {
            animateCloseButtonClick(t.closest("#minifig-modal-close"));
        }
        return closeMinifigModal();
    }
    if ("filter-modal-container" === t.id || t.closest("#filter-modal-close")) {
        if (t.closest("#filter-modal-close")) {
            animateCloseButtonClick(t.closest("#filter-modal-close"));
        }
        return closeFilterModal();
    }
    if ("settings-modal-container" === t.id || t.closest("#settings-modal-close")) {
        if (t.closest("#settings-modal-close")) {
            animateCloseButtonClick(t.closest("#settings-modal-close"));
        }
        return closeSettingsModal();
    }
    if ("related-sets-modal-container" === t.id || t.closest("#related-sets-modal-close")) {
        if (t.closest("#related-sets-modal-close")) {
            animateCloseButtonClick(t.closest("#related-sets-modal-close"));
        }
        return closeRelatedSetsModal();
    }
    if ("wishlist-modal-container" === t.id) {
        return closeWishlistModal();
    }
    if (t.closest("#search-button")) return triggerSearch();
    if (t.closest("#ai-search-button")) return openAISearch();
    if (t.closest("#clear-search")) {
        S.q = "";
        S.selFigNum = null;
        S.showRelatedSets = false;
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫
        S.showUniversalSearch = false;
        S.universalSearchResults = null;
        S.universalSearchTerm = "";
        S.originalSearchContext = null;
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
        S.totalItems = null;
        S.loadedItems = null;
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–æ–∏—Å–∫–∞
        resetRandomMinifigImage();
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ —Å–±—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–∏—Å–∫–∞
        window.searchStateReset = true;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
        const searchInput = document.getElementById("search-input");
        if (searchInput) {
            searchInput.value = "";
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø–æ–∏—Å–∫–∞
        setupSearchButtonsVisibility();
        
        if (searchInput) {
            searchInput.focus();
        }
        return void triggerSearch()
    }
    // –ü–∞–Ω–µ–ª—å –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞
    if (t.closest('[data-action="cancel-multiselect"]')) {
        const bar = document.getElementById('multiselect-bar');
        if (bar) {
            bar.style.animation = 'msSlideFadeOut .28s ease-in both';
            setTimeout(() => { S.multiSelect.active = !1; S.multiSelect.items = new Set; renderHeader(); updateUI(); }, 260);
        } else {
            S.multiSelect.active = !1; S.multiSelect.items = new Set; renderHeader(); updateUI();
        }
        return;
    }
    if (t.closest('[data-action="delete-multiselect"]')) {
        if (!S.multiSelect.active || S.multiSelect.items.size === 0) return;
        const keys = Array.from(S.multiSelect.items);
        for (const key of keys) {
            if (key.startsWith('sets:')) {
                const id = key.split(':')[1];
                handleUpdateSetCollection(id, 0);
            } else if (key.startsWith('minifigs:')) {
                const id = key.split(':')[1];
                await handleUpdateMinifigCollection(id, 0, false);
            } else if (key.startsWith('parts:')) {
                const [, id, colorId] = key.split(':');
                await handleUpdateCollection(id, colorId, 0);
            } else if (key.startsWith('parts-folder:')) {
                const id = key.split(':')[1];
                const colors = Object.keys(S.coll[id] || {});
                for (const colorId of colors) {
                    await handleUpdateCollection(id, colorId, 0);
                }
            }
        }
        S.multiSelect.active = !1; S.multiSelect.items = new Set;
        renderHeader(); updateUI();
        return;
    }

    if (t.closest('[data-action="add-multiselect-to-collection"]')) {
        if (!S.multiSelect.active || S.multiSelect.items.size === 0) return;
        const keys = Array.from(S.multiSelect.items);
        for (const key of keys) {
            if (key.startsWith('sets:')) {
                const id = key.split(':')[1];
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–±–æ—Ä –∏ –≤–µ—Å—å –µ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
                handleUpdateSetCollection(id, (S.setColl[id]?.qty || 0) + 1);
                handleBulkUpdatePartsFromSet(id, 'add');
            } else if (key.startsWith('minifigs:')) {
                const id = key.split(':')[1];
                S.minifigColl[id] = { qty: (S.minifigColl[id]?.qty || 0) + 1 };
                await handleBulkAddMinifigParts(id);
            } else if (key.startsWith('parts:')) {
                const [, id, colorId] = key.split(':');
                const qty = (S.coll[id]?.[colorId] || 0) + 1;
                await handleUpdateCollection(id, colorId, qty);
            } else if (key.startsWith('parts-folder:')) {
                const id = key.split(':')[1];
                // –î–ª—è –ø–∞–ø–∫–∏: —É–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ –≤—Å–µ–º —Ü–≤–µ—Ç–∞–º –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å 1 –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞)
                const colors = Object.keys(S.coll[id] || {});
                if (colors.length > 0) {
                    for (const colorId of colors) {
                        const qty = (S.coll[id]?.[colorId] || 0) + 1;
                        await handleUpdateCollection(id, colorId, qty);
                    }
                } else {
                    // –ï—Å–ª–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞, –¥–æ–±–∞–≤–∏–º –ø–æ –ø–µ—Ä–≤–æ–º—É –¥–æ—Å—Ç—É–ø–Ω–æ–º—É —Ü–≤–µ—Ç—É
                    const available = PART_MAP[id]?.availableColorIds;
                    const colorId = Array.isArray(available) && available.length ? String(available[0]) : null;
                    if (colorId) await handleUpdateCollection(id, colorId, 1);
                }
            }
        }
        saveState(); forceSaveState();
        S.multiSelect.active = !1; S.multiSelect.items = new Set;
        renderHeader(); updateUI();
        return;
    }
    if (t.closest('[data-action="share-multiselect"]')) {
        if (!S.multiSelect.active || S.multiSelect.items.size === 0) return;
        const keys = Array.from(S.multiSelect.items);
        const parts = [];
        const sets = [];
        const minifigs = [];
        const folders = [];
        for (const key of keys) {
            if (key.startsWith('sets:')) {
                const id = key.split(':')[1];
                sets.push(id);
            } else if (key.startsWith('minifigs:')) {
                const id = key.split(':')[1];
                minifigs.push(id);
            } else if (key.startsWith('parts:')) {
                const [, id, colorId] = key.split(':');
                parts.push({ id, colorId });
            } else if (key.startsWith('parts-folder:')) {
                const id = key.split(':')[1];
                folders.push(id);
            }
        }
        const selection = { parts, sets, minifigs, folders };
        console.log('Share multiselect selection:', selection);
        console.log('S.coll:', S.coll);
        console.log('S.view:', S.view);
        try {
            const csvData = generateCsvDataForSelection(selection);
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            let fileName = `lego-selection-${new Date().toISOString().slice(0,10)}.csv`;
            const siteUrl = 'https://zeka3535.github.io/LEGO-Part-Catalog/';
            const totalSelected = parts.length + sets.length + minifigs.length + folders.length;
            let prettyText = '';
            let files = [];
            let csvFile = null;
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –∏, –ø—Ä–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–º –≤—ã–±–æ—Ä–µ, –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            if (totalSelected === 1) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏
                let titleLine = '–í—ã–±—Ä–∞–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –∏–∑ LEGO Part Catalog';
                let detailsLine = '';
                const countsLine = (() => {
                    // –ï—Å–ª–∏ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                    if (sets.length === 1) {
                        const sId = sets[0];
                        const qty = (S.view === 'collection') ? (S.setColl?.[sId]?.qty || 1) : 1;
                        return `‚Äî –Ω–∞–±–æ—Ä–æ–≤: 1 (qty ${qty})`;
                    }
                    if (minifigs.length === 1) {
                        const mId = minifigs[0];
                        const qty = (S.view === 'collection') ? (S.minifigColl?.[mId]?.qty || 1) : 1;
                        return `‚Äî –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫: 1 (qty ${qty})`;
                    }
                    if (parts.length === 1) {
                        const { id: pId, colorId } = parts[0];
                        const qty = (S.view === 'collection') ? (S.coll?.[pId]?.[colorId] || 1) : 1;
                        const colorName = (COLOR_MAP[colorId]?.name || '');
                        return `‚Äî –¥–µ—Ç–∞–ª–µ–π: 1 (qty ${qty})${colorName ? `, —Ü–≤–µ—Ç: ${colorName}` : ''}`;
                    }
                    if (folders.length === 1) {
                        const folderId = folders[0];
                        const part = PART_MAP[folderId];
                        const totalQty = (S.view === 'collection' && S.coll?.[folderId]) ? 
                            Object.values(S.coll[folderId]).reduce((a, b) => a + b, 0) : 0;
                        const colorsCount = (S.view === 'collection' && S.coll?.[folderId]) ? 
                            Object.keys(S.coll[folderId]).length : 0;
                        
                        // –î–ª—è –ø–∞–ø–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
                        if (S.view === 'collection' && S.coll?.[folderId]) {
                            const colorDetails = [];
                            for (const [colorId, qty] of Object.entries(S.coll[folderId])) {
                                if (qty > 0) {
                                    const color = COLOR_MAP[colorId];
                                    const colorName = color?.name || colorId;
                                    colorDetails.push(`${colorName}: ${qty}`);
                                }
                            }
                            return `‚Äî –ø–∞–ø–∫–∞: ${part?.name || folderId} ‚Ä¢ ${colorDetails.join(', ')}`;
                        } else {
                            return `‚Äî –ø–∞–ø–∫–∞: ${part?.name || folderId} (${colorsCount} —Ü–≤–µ—Ç–æ–≤, –≤—Å–µ–≥–æ: ${totalQty})`;
                        }
                    }
                    return `‚Äî –¥–µ—Ç–∞–ª–µ–π: ${parts.length}, –ø–∞–ø–æ–∫: ${folders.length}, –Ω–∞–±–æ—Ä–æ–≤: ${sets.length}, –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫: ${minifigs.length}`;
                })();
                let imageUrl = '';
                let selectedName = '';
                if (sets.length === 1) {
                    const sId = sets[0];
                    const s = SET_MAP[sId] || {};
                    const pcs = (s?.num_parts ? `${s.num_parts} pcs` : '');
                    const year = (s?.year ? `${s.year}` : '');
                    detailsLine = `${s?.name || '–ù–∞–±–æ—Ä'} (#${sId})${pcs ? ' ‚Ä¢ ' + pcs : ''}${year ? ' ‚Ä¢ ' + year : ''}`;
                    imageUrl = (s?.set_img_url && s.set_img_url.startsWith('http')) ? s.set_img_url : '';
                    selectedName = s?.name || `set-${sId}`;
                } else if (minifigs.length === 1) {
                    const mId = minifigs[0];
                    const m = MINIFIG_MAP[mId] || {};
                    const pcs = (m?.num_parts ? `${m.num_parts} pcs` : '');
                    detailsLine = `${m?.name || '–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞'} (${mId})${pcs ? ' ‚Ä¢ ' + pcs : ''}`;
                    imageUrl = (m?.minifig_img_url && m.minifig_img_url.startsWith('http')) ? m.minifig_img_url : (m?.set_img_url || '');
                    selectedName = m?.name || `minifig-${mId}`;
                } else if (parts.length === 1) {
                    const { id: pId, colorId } = parts[0];
                    const p = PART_MAP[pId] || {};
                    const colorName = (COLOR_MAP[colorId]?.name || '');
                    detailsLine = `${p?.name || '–î–µ—Ç–∞–ª—å'} (${pId})${colorName ? ' ‚Ä¢ ' + colorName : ''}`;
                    // –ü—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ –±–µ—Ä—ë–º —Ü–≤–µ—Ç–æ—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
                    const colorImg = (p?.colorImages && p.colorImages[colorId]) ? p.colorImages[colorId] : '';
                    imageUrl = (colorImg && colorImg.startsWith('http')) ? colorImg : (p?.part_img_url || p?.rebrickable_img_url || '');
                    selectedName = p?.name || `part-${pId}`;
                } else if (folders.length === 1) {
                    const folderId = folders[0];
                    const p = PART_MAP[folderId] || {};
                    const totalQty = (S.view === 'collection' && S.coll?.[folderId]) ? 
                        Object.values(S.coll[folderId]).reduce((a, b) => a + b, 0) : 0;
                    const colorsCount = (S.view === 'collection' && S.coll?.[folderId]) ? 
                        Object.keys(S.coll[folderId]).length : 0;
                    
                    // –î–ª—è –ø–∞–ø–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
                    if (S.view === 'collection' && S.coll?.[folderId]) {
                        const colorDetails = [];
                        for (const [colorId, qty] of Object.entries(S.coll[folderId])) {
                            if (qty > 0) {
                                const color = COLOR_MAP[colorId];
                                const colorName = color?.name || colorId;
                                colorDetails.push(`${colorName}: ${qty}`);
                            }
                        }
                        detailsLine = `${p?.name || '–ü–∞–ø–∫–∞ –¥–µ—Ç–∞–ª–µ–π'} (${folderId}) ‚Ä¢ ${colorDetails.join(', ')}`;
                    } else {
                        detailsLine = `${p?.name || '–ü–∞–ø–∫–∞ –¥–µ—Ç–∞–ª–µ–π'} (${folderId}) ‚Ä¢ ${colorsCount} —Ü–≤–µ—Ç–æ–≤ ‚Ä¢ –≤—Å–µ–≥–æ: ${totalQty}`;
                    }
                    imageUrl = (p?.part_img_url || p?.rebrickable_img_url || '');
                    selectedName = p?.name || `folder-${folderId}`;
                }
                prettyText = [titleLine, detailsLine, countsLine, '', `–°–∞–π—Ç: ${siteUrl}`].join('\n');
                // –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–±—Ä–∞—Ç—å –∫–æ–º–ø–æ–∑–∏—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º; –∑–∞—Ç–µ–º —Ñ–æ–ª–±—ç–∫–∏ SVG/PNG
                let imageFile = null;
                if (imageUrl && imageUrl.startsWith('http')) {
                    const opts = {};
                    if (folders.length === 1) {
                        // –î–ª—è –ø–∞–ø–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ü–≤–µ—Ç –¥–µ—Ç–∞–ª–∏ –∏–ª–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Ü–≤–µ—Ç
                        const folderId = folders[0];
                        const p = PART_MAP[folderId];
                        if (p?.colorImages && Object.keys(p.colorImages).length > 0) {
                            const firstColorId = Object.keys(p.colorImages)[0];
                            const c = COLOR_MAP[firstColorId];
                            if (c) {
                                opts.colorHex = c.hex || '#000000';
                                opts.colorName = c.name || '';
                                opts.isTransparent = !!c.isTransparent;
                            }
                        }
                    } else if (parts.length === 1) {
                        const { colorId } = parts[0];
                        const c = COLOR_MAP[colorId];
                        if (c) {
                            opts.colorHex = c.hex || '#000000';
                            opts.colorName = c.name || '';
                            opts.isTransparent = !!c.isTransparent;
                        }
                    }
                    // –î–æ–±–∞–≤–∏–º —Å—Ç—Ä–æ–∫—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (–∫–æ–ª-–≤–æ, –≥–æ–¥, –¥–µ—Ç–∞–ª–∏ –∏ —Ç.–¥.)
                    let metaExtra = '';
                    if (folders.length === 1) {
                        const folderId = folders[0];
                        const p = PART_MAP[folderId] || {};
                        const totalQty = (S.view === 'collection' && S.coll?.[folderId]) ? 
                            Object.values(S.coll[folderId]).reduce((a, b) => a + b, 0) : 0;
                        const colorsCount = (S.view === 'collection' && S.coll?.[folderId]) ? 
                            Object.keys(S.coll[folderId]).length : 0;
                        
                        // –î–ª—è –ø–∞–ø–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Ü–≤–µ—Ç–æ–≤
                        if (S.view === 'collection' && S.coll?.[folderId]) {
                            const colorDetails = [];
                            for (const [colorId, qty] of Object.entries(S.coll[folderId])) {
                                if (qty > 0) {
                                    const color = COLOR_MAP[colorId];
                                    const colorName = color?.name || colorId;
                                    colorDetails.push(`${colorName}: ${qty}`);
                                }
                            }
                            metaExtra = `–ø–∞–ø–∫–∞: ${colorDetails.join(', ')}`;
                        } else {
                            metaExtra = `–ø–∞–ø–∫–∞: ${colorsCount} —Ü–≤–µ—Ç–æ–≤, –≤—Å–µ–≥–æ: ${totalQty}`;
                        }
                    } else if (sets.length === 1) {
                        const s = SET_MAP[sets[0]] || {};
                        const piecesInfo = s?.num_parts ? `–¥–µ—Ç–∞–ª–µ–π –≤ –Ω–∞–±–æ—Ä–µ: ${s.num_parts}` : '';
                        const yearInfo = s?.year ? `–≥–æ–¥: ${s.year}` : '';
                        metaExtra = [piecesInfo, yearInfo].filter(Boolean).join(', ');
                    } else if (minifigs.length === 1) {
                        const m = MINIFIG_MAP[minifigs[0]] || {};
                        const piecesInfo = m?.num_parts ? `–¥–µ—Ç–∞–ª–µ–π –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ: ${m.num_parts}` : '';
                        metaExtra = [piecesInfo].filter(Boolean).join(', ');
                    }
                    const baseMeta = countsLine.replace(/^‚Äî\s?/, '');
                    opts.meta = [baseMeta, metaExtra].filter(Boolean).join(' ‚Ä¢ ');
                    // –ò–º—è —Ñ–∞–π–ª–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                    const safe = String(selectedName || 'item').replace(/[\\/:*?"<>|]+/g, '').trim().replace(/\s+/g, '-').slice(0, 80);
                    opts.fileName = `lego-${safe}.png`;
                    imageFile = await createCompositePreviewImage(
                        imageUrl,
                        detailsLine.split(' ‚Ä¢ ')[0] || 'LEGO Item',
                        'CSV –≤–∫–ª—é—á–∞–µ—Ç:',
                        opts
                    );
                }
                if (!imageFile) {
                    const fallbackTitle = detailsLine.split(' ‚Ä¢ ')[0] || 'LEGO Item';
                    const fallbackSub = 'CSV –≤–∫–ª—é—á–∞–µ—Ç:';
                    const safe = String(selectedName || 'item').replace(/[\\/:*?"<>|]+/g, '').trim().replace(/\s+/g, '-').slice(0, 80);
                    imageFile = await createRasterPreviewImage(fallbackTitle, fallbackSub, { fileName: `lego-${safe}.png` });
                }
                if (selectedName) {
                    const safeCsv = String(selectedName).replace(/[\\/:*?"<>|]+/g, '').trim().replace(/\s+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '').slice(0, 80);
                    fileName = `lego-selection-${safeCsv}.csv`;
                }
                // –°–æ–∑–¥–∞—ë–º CSV-—Ñ–∞–π–ª —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º
                csvFile = new File([blob], fileName, { type: 'text/csv' });
                files = imageFile ? [csvFile, imageFile] : [csvFile];
            } else {
                // –î–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–∞–ø–∫–∞—Ö
                let folderDetails = '';
                if (folders.length > 0) {
                    const folderInfo = [];
                    for (const folderId of folders) {
                        const part = PART_MAP[folderId];
                        if (S.view === 'collection' && S.coll?.[folderId]) {
                            const colorDetails = [];
                            for (const [colorId, qty] of Object.entries(S.coll[folderId])) {
                                if (qty > 0) {
                                    const color = COLOR_MAP[colorId];
                                    const colorName = color?.name || colorId;
                                    colorDetails.push(`${colorName}: ${qty}`);
                                }
                            }
                            folderInfo.push(`${part?.name || folderId} (${colorDetails.join(', ')})`);
                        } else {
                            folderInfo.push(`${part?.name || folderId}`);
                        }
                    }
                    folderDetails = folderInfo.join('\n');
                }
                
                prettyText = [
                    '–ú–æ–π –ø–æ–¥–±–æ—Ä –∏–∑ LEGO Part Catalog',
                    `‚Äî –¥–µ—Ç–∞–ª–µ–π: ${parts.length}, –ø–∞–ø–æ–∫: ${folders.length}, –Ω–∞–±–æ—Ä–æ–≤: ${sets.length}, –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫: ${minifigs.length}`,
                    ...(folderDetails ? ['', '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–æ–∫:', folderDetails] : []),
                    `–°–∞–π—Ç: ${siteUrl}`
                ].join('\n');
                
                // –î–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∏–º—è, —Å–æ–∑–¥–∞—ë–º CSV —Å–µ–π—á–∞—Å
                csvFile = new File([blob], fileName, { type: 'text/csv' });
                files = [csvFile];
            }
            if (navigator.share) {
                let shared = false;
                if (navigator.canShare) {
                    // –ü—Ä–æ–±—É–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞ (CSV + –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
                    if (!shared && files.length === 2 && navigator.canShare({ files })) {
                        await navigator.share({ files, title: '–ü–æ–¥–±–æ—Ä LEGO', text: prettyText });
                        shared = true;
                    }
                    // –ï—Å–ª–∏ –Ω–µ–ª—å–∑—è –æ–±–∞ —Ñ–∞–π–ª–∞ ‚Äî –ø—Ä–æ–±—É–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    const imageOnly = files.find(f => f.type && f.type.startsWith('image/'));
                    if (!shared && imageOnly && navigator.canShare({ files: [imageOnly] })) {
                        await navigator.share({ files: [imageOnly], title: '–ü–æ–¥–±–æ—Ä LEGO', text: prettyText });
                        shared = true;
                    }
                    // –ï—Å–ª–∏ –Ω–µ–ª—å–∑—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ‚Äî –ø—Ä–æ–±—É–µ–º —Ç–æ–ª—å–∫–æ CSV
                    if (!shared && navigator.canShare({ files: [csvFile] })) {
                        await navigator.share({ files: [csvFile], title: '–ü–æ–¥–±–æ—Ä LEGO (CSV)', text: prettyText });
                        shared = true;
                    }
                }
                if (!shared) {
                    // –§–∞–π–ª—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è ‚Äî –¥–µ–ª–∏–º—Å—è —Ç–µ–∫—Å—Ç–æ–º + CSV –≤ —Ç–µ–∫—Å—Ç–µ
                    await navigator.share({ title: '–ü–æ–¥–±–æ—Ä LEGO', text: prettyText + (csvData ? '\n\n' + csvData : ''), url: siteUrl });
                }
            } else {
                // –§–æ–ª–±—ç–∫: —Å–∫–∞—á–∏–≤–∞–µ–º CSV –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Å–∞–π—Ç; –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –ø—Ä–∏–∫–ª–∞–¥—ã–≤–∞–µ–º
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 5000);
                window.open(siteUrl, '_blank');
            }
        } catch (err) {
            console.error('Share selection failed:', err);
        }
        return;
    }
    
    // –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä
    if (t.closest('[data-action="select-all-visible"]')) {
        if (!S.multiSelect.active) {
            S.multiSelect.active = true;
            S.multiSelect.justActivated = true;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        const visibleElements = [];
        
        // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞
        const selectButtons = document.querySelectorAll('[data-action="toggle-select"]');
        selectButtons.forEach(button => {
            const itemType = button.getAttribute('data-item-type');
            const itemId = button.getAttribute('data-item-id');
            const colorId = button.getAttribute('data-color-id');
            
            if (itemType && itemId) {
                let key = '';
                if (itemType === 'set') {
                    key = `sets:${itemId}`;
                } else if (itemType === 'minifig') {
                    key = `minifigs:${itemId}`;
                } else if (itemType === 'part') {
                    key = `parts:${itemId}:${colorId || ''}`;
                } else if (itemType === 'part-folder') {
                    key = `parts-folder:${itemId}`;
                }
                
                if (key && !S.multiSelect.items.has(key)) {
                    visibleElements.push(key);
                }
            }
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤ –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä
        visibleElements.forEach(key => {
            S.multiSelect.items.add(key);
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        renderHeader();
        updateUI();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        queueMicrotask(() => { S.multiSelect.justActivated = false; });
        
        return;
    }
    
    // Share buttons in modals
    if (t.closest('[data-action="share-part"]')) {
        (async () => {
            try {
                const siteUrl = 'https://zeka3535.github.io/LEGO-Part-Catalog/';
                const partId = S.selPartId;
                if (!partId) return;
                const colorId = S.partModal?.selColorId || '';
                const qty = S.partModal?.qty || 0;
                const includeCsv = (qty > 0) && !!colorId;
                const p = PART_MAP[partId] || {};
                const color = COLOR_MAP[colorId];
                const title = `${p?.name || '–î–µ—Ç–∞–ª—å'} (${partId})`;
                const subtitle = includeCsv ? 'CSV –≤–∫–ª—é—á–∞–µ—Ç:' : '';
                const colorImg = (p?.colorImages && colorId && p.colorImages[colorId]) ? p.colorImages[colorId] : '';
                const imageUrl = (colorImg && colorImg.startsWith('http')) ? colorImg : (p?.part_img_url || p?.rebrickable_img_url || S.partModal?.imgUrl || '');
                const opts = {};
                if (color) {
                    opts.colorHex = color.hex || '#000000';
                    opts.colorName = color.name || '';
                    opts.isTransparent = !!color.isTransparent;
                }
                if (qty > 0) {
                    opts.meta = `–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${qty}`;
                }
                const safeBase = String(p?.name || `part-${partId}`).replace(/[\\/:*?"<>|]+/g, '').trim().replace(/\s+/g, '-').slice(0, 80);
                opts.fileName = `lego-${safeBase}.png`;
                let imageFile = await createCompositePreviewImage(imageUrl, title, subtitle, opts);
                if (!imageFile) {
                    const fallbackSub = qty > 0 ? `–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${qty}` : '';
                    imageFile = await createRasterPreviewImage(title, fallbackSub, { fileName: `lego-${safeBase}.png` });
                }
                let files = [imageFile];
                let csvData = '';
                let csvFile = null;
                if (includeCsv) {
                    csvData = generateCsvDataForSelection({ parts: [{ id: partId, colorId }] });
                    const csvBlob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                    const csvName = `lego-selection-${partId}${colorId ? '-' + colorId : ''}.csv`;
                    csvFile = new File([csvBlob], csvName, { type: 'text/csv' });
                    files = [csvFile, imageFile];
                }
                if (navigator.share) {
                    let shared = false;
                    if (navigator.canShare) {
                        if (!shared && files.length === 2 && navigator.canShare({ files })) { await navigator.share({ files, title, text: `–°–∞–π—Ç: ${siteUrl}` }); shared = true; }
                        if (!shared && navigator.canShare({ files: [imageFile] })) { await navigator.share({ files: [imageFile], title, text: `–°–∞–π—Ç: ${siteUrl}` }); shared = true; }
                        if (!shared && csvFile && navigator.canShare({ files: [csvFile] })) { await navigator.share({ files: [csvFile], title: title + ' (CSV)', text: `–°–∞–π—Ç: ${siteUrl}` }); shared = true; }
                    }
                    if (!shared) {
                        await navigator.share({ title, text: `–°–∞–π—Ç: ${siteUrl}` + (includeCsv ? ('\n\n' + csvData) : '') , url: siteUrl });
                    }
                } else {
                    // Fallback: download files
                    const urlImg = URL.createObjectURL(imageFile); const a1 = document.createElement('a'); a1.href = urlImg; a1.download = imageFile.name || 'lego-part.png'; document.body.appendChild(a1); a1.click(); a1.remove(); setTimeout(() => URL.revokeObjectURL(urlImg), 5000);
                    if (csvFile) { const urlCsv = URL.createObjectURL(csvFile); const a2 = document.createElement('a'); a2.href = urlCsv; a2.download = csvFile.name; document.body.appendChild(a2); a2.click(); a2.remove(); setTimeout(() => URL.revokeObjectURL(urlCsv), 5000); }
                    window.open(siteUrl, '_blank');
                }
            } catch (err) { console.error('Share part failed:', err); }
        })();
        return;
    }
    if (t.closest('[data-action="share-set"]')) {
        (async () => {
            try {
                const siteUrl = 'https://zeka3535.github.io/LEGO-Part-Catalog/';
                const setNum = S.selSetNum; if (!setNum) return;
                const s = SET_MAP[setNum] || {};
                const qty = S.setModal?.qty || 0;
                const title = `${s?.name || '–ù–∞–±–æ—Ä'}`;
                const subtitle = 'CSV –≤–∫–ª—é—á–∞–µ—Ç:';
                const imageUrl = (s?.set_img_url && String(s.set_img_url).startsWith('http')) ? s.set_img_url : '';
                const opts = { fileName: `lego-set-${setNum}.png` };
                const theme = s?.theme_id ? THEME_MAP[s.theme_id] : null;
                const piecesInfo = s?.num_parts ? `–¥–µ—Ç–∞–ª–µ–π: ${s.num_parts}` : '';
                const yearInfo = s?.year ? `–≥–æ–¥: ${s.year}` : '';
                const idInfo = `ID: ${setNum}`;
                const extras = [piecesInfo, yearInfo, idInfo].filter(Boolean).join(' ‚Ä¢ ');
                if (extras) opts.meta = extras;
                let imageFile = await createCompositePreviewImage(imageUrl, title, subtitle, opts);
                if (!imageFile) imageFile = await createRasterPreviewImage(title, qty>0?`–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${qty}`:'' , { fileName: `lego-set-${setNum}.png` });
                const csvData = generateCsvDataForSelection({ sets: [setNum] });
                const csvBlob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                const csvFile = new File([csvBlob], `lego-selection-set-${setNum}.csv`, { type: 'text/csv' });
                if (navigator.share) {
                    let shared = false;
                    const files = [csvFile, imageFile];
                    if (navigator.canShare) {
                        if (!shared && navigator.canShare({ files })) { await navigator.share({ files, title, text: `–°–∞–π—Ç: ${siteUrl}` }); shared = true; }
                        if (!shared && navigator.canShare({ files: [imageFile] })) { await navigator.share({ files: [imageFile], title, text: `–°–∞–π—Ç: ${siteUrl}` }); shared = true; }
                        if (!shared && navigator.canShare({ files: [csvFile] })) { await navigator.share({ files: [csvFile], title: title + ' (CSV)', text: `–°–∞–π—Ç: ${siteUrl}` }); shared = true; }
                    }
                    if (!shared) { await navigator.share({ title, text: `–°–∞–π—Ç: ${siteUrl}\n\n` + csvData, url: siteUrl }); }
                } else {
                    const urlImg = URL.createObjectURL(imageFile); const a1 = document.createElement('a'); a1.href = urlImg; a1.download = imageFile.name || 'lego-set.png'; document.body.appendChild(a1); a1.click(); a1.remove(); setTimeout(() => URL.revokeObjectURL(urlImg), 5000);
                    const urlCsv = URL.createObjectURL(csvBlob); const a2 = document.createElement('a'); a2.href = urlCsv; a2.download = csvFile.name; document.body.appendChild(a2); a2.click(); a2.remove(); setTimeout(() => URL.revokeObjectURL(urlCsv), 5000);
                    window.open(siteUrl, '_blank');
                }
            } catch (err) { console.error('Share set failed:', err); }
        })();
        return;
    }
    if (t.closest('[data-action="share-minifig"]')) {
        (async () => {
            try {
                const siteUrl = 'https://zeka3535.github.io/LEGO-Part-Catalog/';
                const figNum = S.selFigNum; if (!figNum) return;
                const m = MINIFIG_MAP[figNum] || {};
                const qty = S.minifigModal?.qty || 0;
                const title = `${m?.name || '–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞'}`;
                const subtitle = 'CSV –≤–∫–ª—é—á–∞–µ—Ç:';
                const imageUrl = (m?.minifig_img_url && String(m.minifig_img_url).startsWith('http')) ? m.minifig_img_url : (m?.set_img_url || '');
                const opts = { fileName: `lego-minifig-${figNum}.png` };
                const piecesInfo = m?.num_parts ? `–¥–µ—Ç–∞–ª–µ–π: ${m.num_parts}` : '';
                const idInfo = `ID: ${figNum}`;
                const extras = [piecesInfo, idInfo].filter(Boolean).join(' ‚Ä¢ ');
                if (extras) opts.meta = extras;
                let imageFile = await createCompositePreviewImage(imageUrl, title, subtitle, opts);
                if (!imageFile) imageFile = await createRasterPreviewImage(title, qty>0?`–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${qty}`:'' , { fileName: `lego-minifig-${figNum}.png` });
                const csvData = generateCsvDataForSelection({ minifigs: [figNum] });
                const csvBlob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                const csvFile = new File([csvBlob], `lego-selection-minifig-${figNum}.csv`, { type: 'text/csv' });
                if (navigator.share) {
                    let shared = false;
                    const files = [csvFile, imageFile];
                    if (navigator.canShare) {
                        if (!shared && navigator.canShare({ files })) { await navigator.share({ files, title, text: `–°–∞–π—Ç: ${siteUrl}` }); shared = true; }
                        if (!shared && navigator.canShare({ files: [imageFile] })) { await navigator.share({ files: [imageFile], title, text: `–°–∞–π—Ç: ${siteUrl}` }); shared = true; }
                        if (!shared && navigator.canShare({ files: [csvFile] })) { await navigator.share({ files: [csvFile], title: title + ' (CSV)', text: `–°–∞–π—Ç: ${siteUrl}` }); shared = true; }
                    }
                    if (!shared) { await navigator.share({ title, text: `–°–∞–π—Ç: ${siteUrl}\n\n` + csvData, url: siteUrl }); }
                } else {
                    const urlImg = URL.createObjectURL(imageFile); const a1 = document.createElement('a'); a1.href = urlImg; a1.download = imageFile.name || 'lego-minifig.png'; document.body.appendChild(a1); a1.click(); a1.remove(); setTimeout(() => URL.revokeObjectURL(urlImg), 5000);
                    const urlCsv = URL.createObjectURL(csvBlob); const a2 = document.createElement('a'); a2.href = urlCsv; a2.download = csvFile.name; document.body.appendChild(a2); a2.click(); a2.remove(); setTimeout(() => URL.revokeObjectURL(urlCsv), 5000);
                    window.open(siteUrl, '_blank');
                }
            } catch (err) { console.error('Share minifig failed:', err); }
        })();
        return;
    }
    if (t.closest("#filter-button")) {
        // –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        S.filterOpen = !0;
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
        if (!S.filters) S.filters = { colorIds: [], inCollectionOnly: false };
        if (!S.setFilters) S.setFilters = { minYear: "", maxYear: "", minParts: "", maxParts: "" };
        if (!S.sortBy) S.sortBy = 'popularity';
        
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        hideSidebarHint();
        
        tempFilters = {
            filters: JSON.parse(JSON.stringify(S.filters)),
            setFilters: JSON.parse(JSON.stringify(S.setFilters)),
            sortBy: S.sortBy
        };
        return void renderFilterModal();
    }
    if (t.closest("#refresh-images-button")) {
        return void forceRefreshPartImages();
    }

    if (t.closest("#settings-button")) {
        // –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–∞–∂–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        S.settingsOpen = !0;
        
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        hideSidebarHint();
        
        return void renderSettingsModal();
    }

    // –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (filterModalEl?.contains(t)) {
        // –ù–∞–∂–∞—Ç–∏–µ –ø–æ –ø—É–Ω–∫—Ç–∞–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–º–µ—Ç–∫–∞), –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—é –∫–æ–ª–ª–µ–∫—Ü–∏–∏, —Ü–≤–µ—Ç–∞–º –∏ –∫–Ω–æ–ø–∫–∞–º –°–±—Ä–æ—Å–∏—Ç—å/–ü—Ä–∏–º–µ–Ω–∏—Ç—å
        const actionEl = t.closest('[data-action]');
        // –ö–ª–∏–∫ –ø–æ –≤–∞—Ä–∏–∞–Ω—Ç—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ label ‚Üí –Ω–∞—Ö–æ–¥–∏–º –≤–ª–æ–∂–µ–Ω–Ω—ã–π input
        const sortLabel = t.closest('label');
        if (sortLabel) {
            const input = sortLabel.querySelector('input[name="sort"][data-action="modal-set-sort"]');
            if (input) {
                tempFilters.sortBy = input.value;
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                resetRandomMinifigImage();
                updateFilterModalUI();
                return;
            }
        }
        if (actionEl) {
            switch (actionEl.dataset.action) {
                case 'modal-set-sort': {
                    const input = actionEl.tagName === 'INPUT' ? actionEl : actionEl.querySelector('input[name="sort"]');
                    if (input) {
                        tempFilters.sortBy = input.value;
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                        resetRandomMinifigImage();
                    }
                    updateFilterModalUI();
                    return;
                }
                case 'modal-toggle-collection': {
                    const input = actionEl.tagName === 'INPUT' ? actionEl : actionEl.querySelector('input');
                    if (input && tempFilters.filters) {
                        tempFilters.filters.inCollectionOnly = !!input.checked;
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
                        resetRandomMinifigImage();
                    }
                    updateFilterModalUI();
                    return;
                }
                case 'modal-set-color': {
                    const colorId = actionEl.dataset.colorId;
                    if (colorId === 'null') {
                        tempFilters.filters.colorIds = [];
                    } else if (colorId) {
                        const list = tempFilters.filters.colorIds || [];
                        const idx = list.indexOf(colorId);
                        if (idx >= 0) list.splice(idx, 1); else list.push(colorId);
                        tempFilters.filters.colorIds = list;
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–≤–µ—Ç–∞
                    resetRandomMinifigImage();
                    
                    updateFilterModalUI();
                    return;
                }
                case 'modal-reset-filters': {
                    if (S.subView === 'sets') {
                        tempFilters.setFilters = { minYear: '', maxYear: '', minParts: '', maxParts: '' };
                        tempFilters.sortBy = S.q ? 'relevance' : 'year_desc';
                    } else if (S.subView === 'minifigs') {
                        tempFilters.sortBy = S.q ? 'relevance' : 'name_asc';
                    } else {
                        tempFilters.filters = { colorIds: [], inCollectionOnly: false };
                        tempFilters.sortBy = S.q ? 'relevance' : 'popularity';
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    resetRandomMinifigImage();
                    
                    updateFilterModalUI();
                    return;
                }
                case 'modal-apply-filters': {
                    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –¥–≤–æ–π–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
                    e.preventDefault();
                    if (S.filterApplying) return;
                    S.filterApplying = true;
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                    resetRandomMinifigImage();
                    
                    if (S.subView === 'sets') {
                        S.setFilters = { ...tempFilters.setFilters };
                        S.sortBy = tempFilters.sortBy;
                    } else if (S.subView === 'minifigs') {
                        S.sortBy = tempFilters.sortBy;
                    } else {
                        S.filters = { ...tempFilters.filters };
                        S.sortBy = tempFilters.sortBy;
                    }
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    closeFilterModal();
                    try { refreshWithNewFilters(); } finally { setTimeout(() => { S.filterApplying = false; }, 0); }
                    return;
                }
            }
        }
    }
    const h = t.closest('[data-action="remove-filter"]');
    if (h) {
        const e = h.dataset.filterType;
        if ("color" === e) {
            S.filters.colorIds = S.filters.colorIds.filter(id => id !== h.dataset.colorId)
        }
        if ("inCollectionOnly" === e) {
            S.filters.inCollectionOnly = !1;
        }
        if ("sortBy" === e) {
            S.sortBy = S.q ? "relevance" : "popularity";
        }
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞
        resetRandomMinifigImage();
        
        return void refreshWithNewFilters()
    }
    if (t.closest('[data-action="remove-all-filters"]')) {
        if ("sets" === S.subView) {
            S.setFilters = {
                minYear: "",
                maxYear: "",
                minParts: "",
                maxParts: ""
            };
            S.sortBy = S.q ? "relevance" : "year_desc";
        } else if ("minifigs" === S.subView) {
            S.sortBy = S.q ? "relevance" : "name_asc";
        } else {
            S.filters.colorIds = [];
            S.filters.inCollectionOnly = !1;
            S.sortBy = S.q ? "relevance" : "popularity";
        }
        
        // –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        clearTemporaryFilters();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        resetRandomMinifigImage();
        
        return void refreshWithNewFilters();
    }
     if (settingsModalEl?.contains(t)) {
        const e = t.closest("[data-action]");
        if (!e) return;
        switch (e.dataset.action) {
            case "disable-color-images":
            case "toggle-settings-stats":
                const panel = document.getElementById('settings-stats-panel');
                const chevron = document.getElementById('settings-stats-chevron');
                if (panel) {
                    const wasOpen = panel.classList.contains('open');
                    panel.classList.toggle('open');
                    const isOpen = panel.classList.contains('open');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
                    localStorage.setItem('settingsStatsOpen', String(isOpen));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —à–µ–≤—Ä–æ–Ω–∞
                    if (chevron) {
                        if (isOpen) {
                            chevron.classList.add('rotate-180');
                        } else {
                            chevron.classList.remove('rotate-180');
                        }
                    }
                    
                    // –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫—Å–∏ –ø—Ä–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ –ø–∞–Ω–µ–ª–∏
                    if (!wasOpen && isOpen) {
                        console.log('üîç –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ–∫—Å–∏...');
                        setTimeout(() => {
                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–∫—Å–∏
                            const now = Date.now();
                            const timeSinceLastTest = now - PROXY_CONFIG.lastProxyTest;
                            
                            // –ê–≤—Ç–æ–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–∫—Å–∏ —É–±—Ä–∞–Ω–∞
                        }, 300);
                    }
                }
                break;
            case "toggle-technologies":
                const techPanel = document.getElementById('technologies-panel');
                const techChevron = document.getElementById('technologies-chevron');
                if (techPanel) {
                    const wasOpen = techPanel.classList.contains('open');
                    techPanel.classList.toggle('open');
                    const isOpen = techPanel.classList.contains('open');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
                    localStorage.setItem('technologiesOpen', String(isOpen));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —à–µ–≤—Ä–æ–Ω–∞
                    if (techChevron) {
                        if (isOpen) {
                            techChevron.classList.add('rotate-180');
                        } else {
                            techChevron.classList.remove('rotate-180');
                        }
                    }
                }
                break;
            case "toggle-about":
                const aboutPanel = document.getElementById('about-panel');
                const aboutChevron = document.getElementById('about-chevron');
                if (aboutPanel) {
                    const wasOpen = aboutPanel.classList.contains('open');
                    aboutPanel.classList.toggle('open');
                    const isOpen = aboutPanel.classList.contains('open');
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
                    localStorage.setItem('aboutOpen', String(isOpen));
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —à–µ–≤—Ä–æ–Ω–∞
                    if (aboutChevron) {
                        if (isOpen) {
                            aboutChevron.classList.add('rotate-180');
                            console.log('üîÑ –î–æ–±–∞–≤–ª–µ–Ω –∫–ª–∞—Å—Å rotate-180 –¥–ª—è about-chevron');
                        } else {
                            aboutChevron.classList.remove('rotate-180');
                        }
                    }
                }
                break;
                const checkbox = document.getElementById('disable-color-images');
                if (checkbox) {
                    localStorage.setItem('disableColorSpecificImages', checkbox.checked.toString());
                    if (checkbox.checked) {
                                            updateSettingsModalStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n–¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ü–≤–µ—Ç–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∞", "success");
                } else {
                                            updateSettingsModalStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π\n–¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ü–≤–µ—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞", "success");
                }
                }
                break;
            case "share-collection": {
                (async () => {
                    try {
                        const csvData = generateCsvData();
                        const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
                        const fileName = `lego-collection-${new Date().toISOString().slice(0,10)}.csv`;
                        const siteUrl = 'https://zeka3535.github.io/LEGO-Part-Catalog/';
                        const siteText = `–ú–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è –∏–∑ LEGO Part Catalog ‚Äî —É–¥–æ–±–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ –¥–µ—Ç–∞–ª–µ–π, –Ω–∞–±–æ—Ä–æ–≤ –∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫. –°–∞–π—Ç: ${siteUrl}`;
                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([blob], fileName, { type: 'text/csv' })] })) {
                            const file = new File([blob], fileName, { type: 'text/csv' });
                            await navigator.share({ files: [file], title: '–ö–æ–ª–ª–µ–∫—Ü–∏—è LEGO (CSV)', text: siteText });
                        } else if (navigator.share) {
                            await navigator.share({ title: '–ö–æ–ª–ª–µ–∫—Ü–∏—è LEGO (CSV)', text: siteText + '\n\n' + csvData, url: siteUrl });
                        } else {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); a.remove();
                            setTimeout(() => URL.revokeObjectURL(url), 5000);
                            window.open(siteUrl, '_blank');
                        }
                        updateSettingsModalStatus('–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞\n–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞', 'success');
                        // –ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ 2.5—Å
                        setTimeout(() => { if (S.settingsOpen && S.settingsModal.status === '–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞\n–∏ –ø–µ—Ä–µ–¥–∞–Ω–∞') { clearSettingsModalStatus(); } }, 2500);
                    } catch (err) {
                        console.error('Share collection failed:', err);
                        updateSettingsModalStatus('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–¥–∞—Ç—å\n–∫–æ–ª–ª–µ–∫—Ü–∏—é', 'error');
                        setTimeout(() => { if (S.settingsOpen && S.settingsModal.status === '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–¥–∞—Ç—å\n–∫–æ–ª–ª–µ–∫—Ü–∏—é') { clearSettingsModalStatus(); } }, 3000);
                    }
                })();
                return;
            }
            case "toggle-catalog-multiselect":
                S.catalogMultiSelectEnabled = !S.catalogMultiSelectEnabled;
                localStorage.setItem('catalogMultiSelectEnabled', String(S.catalogMultiSelectEnabled));
                // –ü—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å –º—É–ª—å—Ç–∏–≤—ã–±–æ—Ä–∞ –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                if (!S.catalogMultiSelectEnabled) { S.multiSelect.active = false; S.multiSelect.items = new Set(); }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å–∞–º —Ç—É–º–±–ª–µ—Ä –±–µ–∑ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –º–æ–¥–∞–ª–∫–∏
                (function(){
                    const btn = settingsModalEl.querySelector('[data-action="toggle-catalog-multiselect"]');
                    if (btn) {
                        if (S.catalogMultiSelectEnabled) btn.classList.add('on'); else btn.classList.remove('on');
                        btn.setAttribute('aria-pressed', String(S.catalogMultiSelectEnabled));
                    }
                })();
                S.gridStale = true; updateUI();
                return;
            case "toggle-collection-multiselect":
                S.collectionMultiSelectEnabled = !S.collectionMultiSelectEnabled;
                localStorage.setItem('collectionMultiSelectEnabled', String(S.collectionMultiSelectEnabled));
                if (!S.collectionMultiSelectEnabled) { S.multiSelect.active = false; S.multiSelect.items = new Set(); }
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç—É–º–±–ª–µ—Ä, –Ω–µ —Ç—Ä–æ–≥–∞—è –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
                (function(){
                    const btn = settingsModalEl.querySelector('[data-action="toggle-collection-multiselect"]');
                    if (btn) {
                        if (S.collectionMultiSelectEnabled) btn.classList.add('on'); else btn.classList.remove('on');
                        btn.setAttribute('aria-pressed', String(S.collectionMultiSelectEnabled));
                    }
                })();
                S.gridStale = true; updateUI();
                return;
            case "toggle-wishlist":
                S.wishlistEnabled = !S.wishlistEnabled;
                localStorage.setItem('wishlistEnabled', String(S.wishlistEnabled));
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç—É–º–±–ª–µ—Ä, –Ω–µ —Ç—Ä–æ–≥–∞—è –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
                (function(){
                    const btn = settingsModalEl.querySelector('[data-action="toggle-wishlist"]');
                    if (btn) {
                        if (S.wishlistEnabled) btn.classList.add('on'); else btn.classList.remove('on');
                        btn.setAttribute('aria-pressed', String(S.wishlistEnabled));
                    }
                })();
                S.gridStale = true; updateUI();
                return;
            case "toggle-folders":
                S.foldersEnabled = !S.foldersEnabled;
                localStorage.setItem('foldersEnabled', String(S.foldersEnabled));
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç—É–º–±–ª–µ—Ä, –Ω–µ —Ç—Ä–æ–≥–∞—è –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç
                (function(){
                    const btn = settingsModalEl.querySelector('[data-action="toggle-folders"]');
                    if (btn) {
                        if (S.foldersEnabled) btn.classList.add('on'); else btn.classList.remove('on');
                        btn.setAttribute('aria-pressed', String(S.foldersEnabled));
                    }
                })();
                updateSettingsModalStatus(S.foldersEnabled ? "–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ –ø–∞–ø–∫–∏\n–≤–∫–ª—é—á–µ–Ω–∞" : "–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ –ø–∞–ø–∫–∏\n–æ—Ç–∫–ª—é—á–µ–Ω–∞", "success");
                S.gridStale = true; updateUI();
                setTimeout(()=>{ if (S.settingsOpen) { clearSettingsModalStatus(); } }, 2000);
                return;
            case "toggle-prevent-exit":
                S.preventAccidentalExit = !S.preventAccidentalExit;
                try { localStorage.setItem('preventAccidentalExit', String(S.preventAccidentalExit)); } catch {}
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç—É–º–±–ª–µ—Ä –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                (function(){
                    const btn = settingsModalEl.querySelector('[data-action="toggle-prevent-exit"]');
                    if (btn) {
                        if (S.preventAccidentalExit) btn.classList.add('on'); else btn.classList.remove('on');
                        btn.setAttribute('aria-pressed', String(S.preventAccidentalExit));
                    }
                })();
                updateSettingsModalStatus(S.preventAccidentalExit ? "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ\n–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –≤–∫–ª—é—á–µ–Ω–æ" : "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ\n–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω–æ", "success");
                setTimeout(()=>{ if (S.settingsOpen) { clearSettingsModalStatus(); } }, 2000);
                return;
            case "toggle-proxy-enabled":
                S.proxyEnabled = !S.proxyEnabled;
                try { localStorage.setItem('proxyEnabled', String(S.proxyEnabled)); } catch {}
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç—É–º–±–ª–µ—Ä –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
                (function(){
                    const btn = settingsModalEl.querySelector('[data-action="toggle-proxy-enabled"]');
                    if (btn) {
                        if (S.proxyEnabled) btn.classList.add('on'); else btn.classList.remove('on');
                        btn.setAttribute('aria-pressed', String(S.proxyEnabled));
                    }
                })();
                updateSettingsModalStatus(S.proxyEnabled ? "–ü—Ä–æ–∫—Å–∏ –≤–∫–ª—é—á–µ–Ω—ã" : "–ü—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã", "success");
                setTimeout(()=>{ if (S.settingsOpen) { clearSettingsModalStatus(); } }, 2000);
                return;
            case "toggle-sidebar-compact":
                S.sidebarCompact = !S.sidebarCompact;
                try { localStorage.setItem('sidebarCompact', String(!!S.sidebarCompact)); } catch {}
                (function(){
                    const btn = settingsModalEl.querySelector('[data-action="toggle-sidebar-compact"]');
                    if (btn) {
                        if (S.sidebarCompact) btn.classList.add('on'); else btn.classList.remove('on');
                        btn.setAttribute('aria-pressed', String(S.sidebarCompact));
                    }
                })();
                updateSettingsModalStatus(S.sidebarCompact ? "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω" : "–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º –æ—Ç–∫–ª—é—á–µ–Ω", "success");
                // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–∞–π–¥–±–∞—Ä –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
                renderSidebar();
                setTimeout(()=>{ if (S.settingsOpen) { clearSettingsModalStatus(); } }, 1500);
                return;

            case "delete-all-parts":
                S.settingsModal.delConfirm = "parts", renderSettingsModal();
                break;
            case "delete-all-sets":
                S.settingsModal.delConfirm = "sets", renderSettingsModal();
                break;
            case "delete-all-minifigs":
                S.settingsModal.delConfirm = "minifigs", renderSettingsModal();
                break;
            case "delete-all-data":
                S.settingsModal.delConfirm = "all", renderSettingsModal();
                break;
            case "cancel-delete":
                S.settingsModal.delConfirm = null, renderSettingsModal();
                break;
            case "confirm-delete-parts":
                S.coll = {}, saveState(), S.settingsModal.delConfirm = null, renderSettingsModal(), updateUI();
                break;
            case "confirm-delete-sets":
                S.setColl = {}, saveState(), S.settingsModal.delConfirm = null, renderSettingsModal(), updateUI();
                break;
            case "confirm-delete-minifigs":
                S.minifigColl = {}, saveState(), S.settingsModal.delConfirm = null, renderSettingsModal(), updateUI();
                break;
            case "confirm-delete-all":
                S.coll = {}, S.setColl = {}, S.minifigColl = {}, saveState(), S.settingsModal.delConfirm = null, renderSettingsModal(), updateUI();
                break;
            case "refresh-minifig-data":
                updateSettingsModalStatus("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö\n–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫", "info");
                try {
                    await refreshMinifigData();
                    updateSettingsModalStatus("–î–∞–Ω–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫\n–æ–±–Ω–æ–≤–ª–µ–Ω—ã", "success");
                } catch (err) {
                    console.error(err);
                    updateSettingsModalStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å\n–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏", "error");
                }
                break;
            case "reload-csv-data":
                updateSettingsModalStatus("–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö\n–∏–∑ CSV", "info");
                try {
                    await loadDataFromCSV();
                    updateSettingsModalStatus("–î–∞–Ω–Ω—ã–µ –∏–∑ CSV\n–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!", "success");
                } catch (error) {
                    updateSettingsModalStatus(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏\nCSV: ${error.message}`, "error");
                }
                break;
            case "load-missing-api-data":
                updateSettingsModalStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö\n–¥–∞–Ω–Ω—ã—Ö –∏–∑ API", "info");
                try {
                    await loadMissingDataFromAPI();
                    updateSettingsModalStatus("–ù–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ\n–∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!", "success");
                } catch (error) {
                    updateSettingsModalStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏\nAPI –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, "error");
                }
                break;
            case "force-reload-csv":
                updateSettingsModalStatus("–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è\n–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ CSV", "info");
                try {
                    // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç—ã –¥–∞–Ω–Ω—ã—Ö
                    Object.keys(PART_MAP).forEach(key => delete PART_MAP[key]);
                    Object.keys(SET_MAP).forEach(key => delete SET_MAP[key]);
                    Object.keys(MINIFIG_MAP).forEach(key => delete MINIFIG_MAP[key]);
                    Object.keys(COLOR_MAP).forEach(key => delete COLOR_MAP[key]);
                    flatCategories.length = 0;
                    Object.keys(THEME_MAP).forEach(key => delete THEME_MAP[key]);
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ CSV
                    await loadDataFromCSV();
                    updateSettingsModalStatus("CSV –¥–∞–Ω–Ω—ã–µ\n–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã!", "success");
                } catch (error) {
                    updateSettingsModalStatus(`–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π\n–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, "error");
                }
                break;
            case "clear-app-cache":
                updateSettingsModalStatus("–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞\n–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è", "info");
                try {
                    const success = await window.clearAppCache();
                    if (success) {
                        updateSettingsModalStatus("–ö—ç—à –æ—á–∏—â–µ–Ω!\n–°—Ç—Ä–∞–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∞", "success");
                        
                        // –ß–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    } else {
                        updateSettingsModalStatus("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏\n–∫—ç—à–∞", "error");
                    }
                } catch (error) {
                                            updateSettingsModalStatus(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏\n–∫—ç—à–∞: ${error.message}`, "error");
                }
                break;
            case "refresh-csv-cache":
                updateSettingsModalStatus("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ CSV –∫—ç—à–∞", "info");
                try {
                    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({ type: 'REFRESH_CSV_CACHE' });
                        updateSettingsModalStatus("CSV –∫—ç—à –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è...", "info");
                    } else {
                        updateSettingsModalStatus("–°–µ—Ä–≤–∏—Å-–≤–æ—Ä–∫–µ—Ä –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω", "error");
                    }
                } catch (error) {
                    updateSettingsModalStatus(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è CSV: ${error.message}`, "error");
                }
                break;
            case "clear-camera-settings":
                updateSettingsModalStatus("–û—á–∏—Å—Ç–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫\n–∫–∞–º–µ—Ä—ã", "info");
                try {
                    const success = clearAllCameraSettings();
                    if (success) {
                        updateSettingsModalStatus("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã\n–æ—á–∏—â–µ–Ω—ã!", "success");
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã
                        updateCameraSettingsStatus();
                    } else {
                        updateSettingsModalStatus("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏\n–Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã", "error");
                    }
                } catch (error) {
                    updateSettingsModalStatus(`–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏\n–Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã: ${error.message}`, "error");
                }
                break;
            case "clear-all-data":
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                updateSettingsModalStatus("‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ", "error");
                
                // –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã, –∑–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                setTimeout(() => {
                    const confirmed = confirm(
                        "‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï ‚ö†Ô∏è\n\n" +
                        "–í—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ—Å—å —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:\n" +
                        "‚Ä¢ –í—Å—é –∫–æ–ª–ª–µ–∫—Ü–∏—é (–¥–µ—Ç–∞–ª–∏, –Ω–∞–±–æ—Ä—ã, –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏)\n" +
                        "‚Ä¢ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏\n" +
                        "‚Ä¢ –í–µ—Å—å –∫—ç—à\n" +
                        "‚Ä¢ –í—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n\n" +
                        "–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!\n\n" +
                        "–ù–∞–∂–º–∏—Ç–µ –û–ö –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–ª–∏ –û—Ç–º–µ–Ω–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã."
                    );
                    
                    if (confirmed) {
                        updateSettingsModalStatus("–ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é\n–æ—á–∏—Å—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö...", "info");
                        
                        // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É
                        clearAllApplicationData().then((success) => {
                            if (success) {
                                updateSettingsModalStatus("–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã!\n–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...", "success");
                                
                                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
                                setTimeout(() => {
                                    window.location.reload();
                                }, 2000);
                            } else {
                                updateSettingsModalStatus("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏\n–¥–∞–Ω–Ω—ã—Ö", "error");
                            }
                        }).catch((error) => {
                            updateSettingsModalStatus(`–û—à–∏–±–∫–∞: ${error.message}`, "error");
                        });
                    } else {
                        updateSettingsModalStatus("–û—á–∏—Å—Ç–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞\n–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º", "info");
                    }
                }, 2000);
                break;
            // –ö–Ω–æ–ø–∫–∞ "–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è" —É–±—Ä–∞–Ω–∞; —Å–≤–µ–¥–µ–Ω–∏—è –æ –∫—ç—à–µ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫

            case "import-csv":
                document.getElementById("import-csv-input")?.click();
                break;
            case "export-csv":
                exportCollectionToCSV();
                break;
            case "load-from-cloud":
                loadFromCloud();
                break;
            case "save-to-cloud":
                saveToCloud();
                break;
        }
    } else if (minifigModalEl?.contains(t)) {
        const e = t.closest("[data-action]");
        if (!e) return;
        switch (e.dataset.action) {
            case "decrease-minifig-qty":
                S.minifigModal.qty > 0 && (S.minifigModal.qty--, renderMinifigModal(!1));
                break;
            case "increase-minifig-qty":
                S.minifigModal.qty++, renderMinifigModal(!1);
                break;
            case "update-minifig-collection":
                S.selFigNum && await handleUpdateMinifigCollection(S.selFigNum, S.minifigModal.qty);
                break;
            case "delete-from-minifig-collection-modal":
                if (S.selFigNum) {
                    await handleUpdateMinifigCollection(S.selFigNum, 0);
                    S.minifigModal.qty = 0;
                }
                break;
            case "toggle-minifig-modal-view":
                S.minifigModal.view = "details" === S.minifigModal.view ? "inventory" : "details";
                if ("inventory" === S.minifigModal.view && !S.minifigModal.inv) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                    updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏...", 75, "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π");
                    S.minifigModal.loadingInv = !0; S.minifigModal.invError = !1;
                    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å—é –º–æ–¥–∞–ª–∫—É, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫—É-–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
                    renderMinifigModal(false);
                    try {
                        S.minifigModal.inv = await fetchMinifigParts(S.selFigNum)
                    } catch (t) {
                        S.minifigModal.invError = !0
                    } finally {
                        S.minifigModal.loadingInv = !1;
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                        if (S.minifigModal.inv && S.minifigModal.inv.length > 0) {
                            updateLoadingStatus("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω", 80, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${S.minifigModal.inv.length} –¥–µ—Ç–∞–ª–µ–π`);
                        } else {
                            updateLoadingStatus("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—É—Å—Ç", 80, "–î–µ—Ç–∞–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
                        }
                        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
                        renderMinifigModal(false);
                    }
                } else {
                    // –ü—Ä–æ—Å—Ç–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ ‚Äî –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –≤—Å—é –º–æ–¥–∞–ª–∫—É –∫–∞–∫ —É –Ω–∞–±–æ—Ä–æ–≤
                    renderMinifigModal(false);
                }
                break;
            case "add-minifig-parts-modal":
                S.selFigNum && handleBulkAddMinifigPartsFromModal(S.selFigNum);
                break;
            case "retry-load-minifig-inv":
                S.minifigModal.inv = null;
                const o = minifigModalEl.querySelector('[data-action="toggle-minifig-modal-view"]');
                o?.click();
                break
            case "refresh-minifig-image":
                if (S.selFigNum) {
                    try {
                        await fetchMinifigDetails(S.selFigNum);
                        renderMinifigModal(false);
                    } catch (error) {
                        console.error('Failed to refresh minifig image:', error);
                    }
                }
                break;
            case "show-related-sets":
                console.log('show-related-sets clicked, selFigNum:', S.selFigNum);
                if (S.selFigNum) {
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                    modalManager.closeAllModals();
                    
                    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
                    const allModals = [
                        'modal-container',
                        'set-modal-container', 
                        'minifig-modal-container',
                        'filter-modal-container',
                        'settings-modal-container',
                        'related-sets-modal-container'
                    ];
                    
                    allModals.forEach(modalId => {
                        const modalEl = document.getElementById(modalId);
                        if (modalEl && !modalEl.classList.contains('modal-hidden')) {
                            console.log(`Force closing modal: ${modalId}`);
                            modalEl.classList.add('modal-hidden');
                            modalEl.classList.remove('visible');
                            modalEl.innerHTML = '';
                        }
                    });
                    
                    // –£–±–∏—Ä–∞–µ–º overflow-hidden
                    document.body.classList.remove('overflow-hidden');
                    
                    console.log('All modals force closed, switching to catalog/sets');
                    
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥ –∏ –≤–∫–ª–∞–¥–∫—É "–ù–∞–±–æ—Ä—ã" –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
                    S.view = "catalog";
                    S.subView = "sets";
                    S.showRelatedSets = true; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
                    console.log('Switched to catalog/sets, selFigNum:', S.selFigNum, 'showRelatedSets:', S.showRelatedSets);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    updateUI();
                    console.log('updateUI called, selFigNum after:', S.selFigNum);
                }
                break;
        }
    } else if (relatedSetsModalEl?.contains(t)) {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
        const actionEl = t.closest("[data-action]");
        if (!actionEl) return;
        
        const { action, setNum } = actionEl.dataset;
        switch (action) {
            case "open-set-from-related":
                if (setNum) {
                    console.log('Opening set from related sets:', setNum);
                    // –ù–ï –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
                    // closeRelatedSetsModal();
                    openModalForSet(setNum);
                    
                    // –í—Ä–µ–º–µ–Ω–Ω–æ –ø–æ–¥–Ω–∏–º–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–±–æ—Ä–∞ –Ω–∞ —Å–∞–º—ã–π –≤–µ—Ä—Ö
                    setTimeout(() => {
                        modalManager.bringToFront('set-modal-container');
                    }, 100); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è
                    

                }
                break;
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        if (t.id === 'related-sets-modal-close' || t.closest('#related-sets-modal-close')) {
            if (t.closest('#related-sets-modal-close')) {
                animateCloseButtonClick(t.closest('#related-sets-modal-close'));
            }
            closeRelatedSetsModal();
            // –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏, –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –µ–≥–æ z-index
            if (S.selFigNum && minifigModalEl && !minifigModalEl.classList.contains("modal-hidden")) {
                minifigModalEl.style.setProperty('z-index', '70', 'important');
            }
        }
    } else if (setModalEl?.contains(t)) {
        // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø—Ä–∏—à–µ–ª –ø–æ –≤–∫–ª–∞–¥–∫–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ —Ü–µ–ª–∏–∫–æ–º, –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∫–Ω–æ–ø–∫–∞—Ö
        const e = t.closest("[data-action]");
        if (!e) return;
        const {
            action: o,
            themeId: l,
            figNum: a,
            quantity: i
        } = e.dataset;
        switch (o) {
            case "toggle-set-modal-view":
                S.setModal.view = "details" === S.setModal.view ? "inventory" : "details", renderSetModal(!1);
                break;
            case "load-more-inventory":
                S.selSetNum && fetchSetInventory(S.selSetNum, S.setModal.invPage + 1);
                break;
            case "decrease-set-qty":
                S.setModal.qty > 0 && (S.setModal.qty--, updateSetModalControlsState());
                break;
            case "increase-set-qty":
                S.setModal.qty++, updateSetModalControlsState();
                break;
            case "update-set-collection":
                S.selSetNum && handleUpdateSetCollection(S.selSetNum, S.setModal.qty);
                break;
            case "delete-from-set-collection-modal":
                S.selSetNum && (handleUpdateSetCollection(S.selSetNum, 0), S.setModal.qty = 0);
                break;
            case "bulk-add-parts":
                S.selSetNum && handleBulkUpdatePartsFromSet(S.selSetNum, "add");
                break;
            case "bulk-remove-parts":
                S.selSetNum && handleBulkUpdatePartsFromSet(S.selSetNum, "remove");
                break;
            case "toggle-set-info":
                const infoContent = document.getElementById("set-info-content");
                if (infoContent) {
                    infoContent.classList.toggle("hidden");
                }
                break;
            case "toggle-minifig-parts":
                if (a) {
                    const e = S.setModal.minifigs.find(e => e.set_num === a);
                    if (e) {
                        // –ü—Ä–æ—Å—Ç–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–π
                        e.isExpanded = !e.isExpanded;
                        renderSetModal(false);
                        
                        if (!e.parts && !e.loadingError) {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –Ω–∞–±–æ—Ä–∞
                            updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏...", 75, "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π");
                            
                            e.isLoadingParts = !0, fetchMinifigParts(a).then(t => {
                                e.parts = t;
                                
                                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                                updateLoadingStatus("–î–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", 80, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${t.length} –¥–µ—Ç–∞–ª–µ–π`);
                            }).catch(() => {
                                e.loadingError = !0;
                                updateLoadingStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π", 0, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏");
                            }).finally(() => {
                                e.isLoadingParts = !1, S.selSetNum && renderSetModal(!1)
                            })
                        }
                    }
                }
                break;
            case "retry-load-minifig-parts":
                if (a) {
                    const e = S.setModal.minifigs.find(e => e.set_num === a);
                    e && (e.loadingError = !1, e.isLoadingParts = !0, e.parts = null, renderSetModal(!1), 
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                        updateLoadingStatus("–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏...", 75, "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–µ—Ç–∞–ª–µ–π"),
                        fetchMinifigParts(a).then(t => {
                            e.parts = t;
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–≥—Ä—É–∑–∫–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                            updateLoadingStatus("–î–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã", 80, `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${t.length} –¥–µ—Ç–∞–ª–µ–π`);
                        }).catch(() => {
                            e.loadingError = !0;
                            updateLoadingStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π", 0, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–µ—Ç–∞–ª–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏");
                        }).finally(() => {
                            e.isLoadingParts = !1, S.selSetNum && renderSetModal(!1)
                        })
                    )
                }
                break;
            case "add-minifig-to-collection":
                a && i && await handleUpdateMinifigCollection(a, (S.minifigColl[a]?.qty || 0) + parseInt(i, 10), !1);
                break;
            case "add-minifig-parts-to-collection":
                a && handleBulkAddMinifigParts(a)
                break;
        }
    } else if (partModalEl?.contains(t)) {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –≤–∞—Ä–∏–∞—Ü–∏–π
        if (t.id === "variation-select-button") {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é
            const dropdown = document.getElementById("variation-dropdown");
            const isOpen = dropdown.style.display !== 'none';
            
            if (!isOpen) {
                dropdown.style.display = 'block';
                t.classList.add('open');
            } else {
                dropdown.style.display = 'none';
                t.classList.remove('open');
            }
            return;
        }
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –æ–ø—Ü–∏–∏ –≤–∞—Ä–∏–∞—Ü–∏–∏
        if (t.classList.contains("variation-option")) {
            const selectedVariationId = t.dataset.value;
            const selectedVariation = S.partModal.variants?.find(v => v.id === selectedVariationId);
            
            if (selectedVariation && selectedVariation.id !== S.selPartId) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π ID –¥–µ—Ç–∞–ª–∏ –Ω–∞ –Ω–æ–≤—É—é –≤–∞—Ä–∏–∞—Ü–∏—é
                S.selPartId = selectedVariationId;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                const buttonText = document.getElementById("variation-select-text");
                if (buttonText) {
                    buttonText.textContent = selectedVariation.name;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –æ–ø—Ü–∏–π
                const dropdown = document.getElementById("variation-dropdown");
                if (dropdown) {
                    dropdown.querySelectorAll('.variation-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    t.classList.add('selected');
                }
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é
                const button = document.getElementById("variation-select-button");
                if (button) {
                    button.classList.remove('open');
                }
                if (dropdown) {
                    dropdown.style.display = 'none';
                }
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –Ω–æ–≤–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏
                const newPart = PART_MAP[selectedVariationId];
                if (newPart) {
                    S.partModal.imgUrl = newPart.rebrickable_img_url || null;
                    S.partModal.selColorId = null;
                    S.partModal.qty = 0;
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    updateModalPartially({
                        image: true
                    });
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–º–µ–Ω–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏
                    const modalTitle = document.querySelector('#modal-content h2');
                    if (modalTitle) {
                        modalTitle.textContent = selectedVariation.name;
                    }
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–π –≤–∞—Ä–∏–∞—Ü–∏–∏
                    if (newPart.availableColorIds && newPart.availableColorIds.length > 0) {
                        S.partModal.selColorId = sortColorIds(newPart.availableColorIds, newPart.id)[0];
                        S.partModal.qty = S.coll[selectedVariationId]?.[S.partModal.selColorId] || 0;
                        updateModalPartially({
                            colors: true,
                            controls: true
                        });
                        fetchPartColorSpecifics(newPart.id, S.partModal.selColorId);
                    } else {
                        fetchPartColors(newPart.id);
                    }
                }
            }
            return;
        }
        
        const e = t.closest("[data-action]");
        if (e) {
            const {
                action: t,
                categoryId: o
            } = e.dataset;
            switch (t) {
                case "decrease-qty":
                    S.partModal.qty > 0 && (S.partModal.qty--, updateModalControlsState());
                    break;
                case "increase-qty":
                    S.partModal.qty++, updateModalControlsState();
                    break;
                case "update-collection":
                    S.selPartId && S.partModal.selColorId && await handleUpdateCollection(S.selPartId, S.partModal.selColorId, S.partModal.qty);
                    break;
                case "delete-from-collection-modal":
                    S.selPartId && S.partModal.selColorId && (await handleUpdateCollection(S.selPartId, S.partModal.selColorId, 0), S.partModal.qty = 0);
                    break;
                case "go-to-category":
                    o && (closeModal(), S.view = "catalog", S.multiSelect.active = false, S.multiSelect.items = new Set(), S.subView = "parts", S.selCatId = parseInt(o, 10), S.selFigNum = null, S.showRelatedSets = false, loadPartsForCategory(S.selCatId));
                    break;
                case "retry-fetch-colors":
                    S.selPartId && fetchPartColors(S.selPartId)
                    break;
                case "show-related-sets-for-part":
                    if (S.selPartId) {
                        try {
                            const part = PART_MAP[S.selPartId];
                            const related = getRelatedSetsForPart(part.id);
                            if (related && related.length > 0) {
                                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –∫–∞—Ç–∞–ª–æ–≥/–Ω–∞–±–æ—Ä—ã –∏ –≤–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –Ω–∞–±–æ—Ä–æ–≤
                                closeModal();
                                S.view = "catalog";
                                S.subView = "sets";
                                S.selFigNum = null;
                                S.selRelatedPartId = part.id;
                                S.showRelatedSets = true;
                                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ –∫—ç—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞
                                S._relatedSetsCache = { type: 'part', id: part.id, name: part.name || part.id, items: related };
                                updateUI();
                            }
                        } catch (err) {}
                    }
            }
        }
        const o = t.closest("button[data-color-id]");
        if (o && o.dataset.colorId) {
            S.partModal.selColorId = o.dataset.colorId;
            S.partModal.qty = S.coll[S.selPartId]?.[S.partModal.selColorId] || 0;
            
            // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            updateModalPartially({
                controls: !0
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç–∞ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Å–∫–∞—á–∫–∏
            const colorContainer = document.getElementById("color-selector-container");
            if (colorContainer) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
                const allColorButtons = colorContainer.querySelectorAll('button[data-color-id]');
                allColorButtons.forEach(btn => {
                    btn.classList.remove('border-blue-500', 'scale-110');
                    btn.classList.add('border-gray-600');
                });
                
                // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ü–≤–µ—Ç
                const selectedButton = colorContainer.querySelector(`button[data-color-id="${S.partModal.selColorId}"]`);
                if (selectedButton) {
                    selectedButton.classList.remove('border-gray-600');
                    selectedButton.classList.add('border-blue-500', 'scale-110');
                }
            }
            
            fetchPartColorSpecifics(S.selPartId, S.partModal.selColorId);
        }
    }
}), document.addEventListener("keydown", e => {
    const activeElement = document.activeElement;
    
        if ("Escape" === e.key) {
            if (viewerEl.classList.contains("viewer-hidden")) {
                if (S.filterOpen) {
                    closeFilterModal();
                } else if (S.settingsOpen) {
                    closeSettingsModal();
                } else if (S.selSetNum) {
                    closeSetModal();
                } else if (S.selFigNum) {
                    closeMinifigModal();
                } else if (S.selPartId) {
                    closeModal();
                } else if (!relatedSetsModalEl.classList.contains("modal-hidden")) {
                    closeRelatedSetsModal();
                }
            } else {
                closeImageViewer();
            }
            
            // –î–≤–æ–π–Ω–æ–µ –Ω–∞–∂–∞—Ç–∏–µ Escape –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
            if (e.repeat) {
                console.log('Double Escape detected, force restoring modals...');
                forceRestoreAllModals();
            }
    } else if ("Enter" === e.key && activeElement.id === "search-input") {
        triggerSearch();
    }
}), mainEl.addEventListener("scroll", () => {
    const threshold = 300;
    const isAtBottom = mainEl.scrollHeight - mainEl.scrollTop <= mainEl.clientHeight + threshold;

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞
    if (isAtBottom && !S.loading && S.hasMoreItems && S.view === 'catalog') {
        S.toDisplay += S.increment;
        updateUI();
    }
    
    const e = mainEl.scrollTop > 300;
    e && toTopBtn.classList.contains("opacity-0") ? toTopBtn.classList.remove("opacity-0", "pointer-events-none", "translate-y-4") : !e && !toTopBtn.classList.contains("opacity-0") && toTopBtn.classList.add("opacity-0", "pointer-events-none", "translate-y-4")
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
async function preloadRemainingImagesInBackground() {
    try {
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π (51-100)
        // console.log('Background preloading remaining part images (51-100)...');
        // const remainingPartPromises = [];
        // for (let i = 51; i <= 100; i++) {
        //     const img = new Image();
        //     const preloadPromise = new Promise((resolve) => {
        //         img.onload = () => resolve();
        //         img.onerror = () => {
        //             console.warn(`Failed to preload part image part-${i}.png (folder may not exist)`);
        //             resolve();
        //         };
        //         img.src = `./Parts_png/part-${i}.png`;
        //     });
        //     remainingPartPromises.push(preloadPromise);
        // }
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–±–æ—Ä–æ–≤ (21-50)
        // console.log('Background preloading remaining set images (21-50)...');
        // const remainingSetPromises = [];
        // for (let i = 21; i <= 50; i++) {
        //     const img = new Image();
        //         const preloadPromise = new Promise((resolve) => {
        //             img.onload = () => resolve();
        //             img.onerror = () => {
        //                 console.warn(`Failed to preload set image set-${i}.png (folder may not exist)`);
        //                 resolve();
        //             };
        //             img.src = `./Sets_png/set-${i}.png`;
        //         };
        //         remainingSetPromises.push(preloadPromise);
        // }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
        // await Promise.all([...remainingPartPromises, ...remainingSetPromises]);
        console.log('Background image preloading disabled - Parts_png and Sets_png folders not found');
        
    } catch (error) {
        console.error('Error preloading remaining images in background:', error);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –∫—ç—à
async function preloadImages() {
    try {
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        const minifigCount = window.MINIFIG_COUNT || 30; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏–ª–∏ fallback
        console.log(`Preloading ${minifigCount} minifig images...`);
        
        const minifigPromises = [];
        for (let i = 1; i <= minifigCount; i++) {
            const img = new Image();
            const preloadPromise = new Promise((resolve) => {
                img.onload = () => resolve();
                img.onerror = () => {
                    console.warn(`Failed to preload minifig image fig-${i}.png`);
                    resolve(); // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –¥—Ä—É–≥–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–µ
                };
                img.src = `./Minifig_png/fig-${i}.png`;
            });
            minifigPromises.push(preloadPromise);
        }
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π (–ø–µ—Ä–≤—ã–µ 50)
        // console.log('Preloading popular part images...');
        // const partPromises = [];
        // for (let i = 1; i <= 50; i++) {
        //     const img = new Image();
        //     const preloadPromise = new Promise((resolve) => {
        //         img.onload = () => resolve();
        //         img.onerror = () => {
        //             console.warn(`Failed to preload part image part-${i}.png (folder may not exist)`);
        //             resolve();
        //         };
        //         img.src = `./Parts_png/part-${i}.png`;
        //     });
        //     partPromises.push(preloadPromise);
        // }
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–±–æ—Ä–æ–≤ (–ø–µ—Ä–≤—ã–µ 20)
        // console.log('Preloading popular set images...');
        // const setPromises = [];
        // for (let i = 1; i <= 20; i++) {
        //     const img = new Image();
        //     const preloadPromise = new Promise((resolve) => {
        //         img.onload = () => resolve();
        //         img.onerror = () => {
        //             console.warn(`Failed to preload set image set-${i}.png (folder may not exist)`);
        //             resolve();
        //         };
        //         img.src = `./Sets_png/set-${i}.png`;
        //     });
        //     setPromises.push(preloadPromise);
        // }
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
        await Promise.all([...minifigPromises]);
        console.log(`Successfully preloaded ${minifigCount} minifig images`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
        updateLoadingStatus("–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ", 92, "–û—Å–Ω–æ–≤–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ –∫—ç—à");
        
    } catch (error) {
        console.error('Error preloading images:', error);
    }
}

async function initializeApp() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º RemoteStorage –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    try {
        await window.loadRemoteStorage();
        console.log('‚úÖ RemoteStorage loaded during app initialization');
    } catch (error) {
        console.warn('‚ö†Ô∏è Failed to load RemoteStorage during initialization:', error);
    }
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—ã—Ö–æ–¥–∞: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ–∫–Ω–∞/–ø–∞–Ω–µ–ª–∏, –∞ –Ω–µ –≤—ã—Ö–æ–¥–∏–º
    try {
        window.history.pushState({lock:true}, '', window.location.href);
        window.addEventListener('popstate', (event) => {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–ª–∏—Ç—Ä—É —Ü–≤–µ—Ç–æ–≤, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞
            try { if (colorsModalEl && !colorsModalEl.classList.contains('modal-hidden')) { modalManager.closeModal('colors-modal-container'); } } catch {}
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å
            try { if (modalManager && modalManager.getOpenModalsCount() > 0) { modalManager.closeLastModal(); } } catch {}
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ, —á—Ç–æ–±—ã –æ—Å—Ç–∞—Ç—å—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
            window.history.pushState({lock:true}, '', window.location.href);
        });
    } catch {}
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ OAuth callback, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('code') || urlParams.has('state') || urlParams.has('access_token')) {
        console.log('üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω OAuth callback, –æ—á–∏—â–∞–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫');
        // –û—á–∏—â–∞–µ–º URL –æ—Ç OAuth –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ –≤–∫–ª—é—á–µ–Ω—ã)
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
    
    const proxyCheckPromise = !S.proxyEnabled ? 
        Promise.resolve(false) : 
        checkAllProxies(false).catch(error => {
            console.warn('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–æ–∫—Å–∏:', error);
            return false;
        });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ (–ë–ï–ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
    setTimeout(() => {
        if (window.remoteStorageAvailable && typeof RemoteStorage !== 'undefined') {
            const connectionState = getCloudStorageConnectionState();
            
            if (connectionState.needsReconnection) {
                console.log('üîç –ù–∞–π–¥–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫');
                console.log('‚ÑπÔ∏è –î–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ" –≤ —Ä–∞–∑–¥–µ–ª–µ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
            }
        }
    }, 1000);
    
    
    // –ú–∞—Å—Å–∏–≤ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    window.LOADING_TIPS = [
    "üìà –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–∞–∑–¥–µ–ª '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞' –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏",
    "üîÑ –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∑–∞–≥—Ä—É–∑–∫–æ–π –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à",
    "üéØ –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∏ –º—É–ª—å—Ç–∏–∫—Ä–∏—Ç–µ—Ä–∏–∞–ª—å–Ω–æ",
    "üì± –°–∞–π—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - —É–¥–æ–±–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ",
    "üîÑ –£–º–Ω–æ–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–∫–æ—Ä—è–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –¥–∞–Ω–Ω—ã—Ö",
    "üìä –í –∞–Ω–∞–ª–∏—Ç–∏–∫–µ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –ø–æ —Ü–≤–µ—Ç–∞–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º",
    "üé≤ –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∫–Ω–æ–ø–∫–∏ '–î–µ—Ç–∞–ª–∏', '–ù–∞–±–æ—Ä—ã' –∏–ª–∏ '–§–∏–≥—É—Ä–∫–∏' 1 —Å–µ–∫—É–Ω–¥—É –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞",
    "üîç –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º –ø–æ–º–æ–≥–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã",
    "üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã",
    "üí° –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã",
    "üåê –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–∫—Å–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ö–æ–¥–∏—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ API –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç—ã",
    "üìã –ü–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ—Å—å –º–µ–∂–¥—É –∫–∞—Ç–∞–ª–æ–≥–æ–º –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á",
    "üé® –§–∏–ª—å—Ç—Ä—É–π—Ç–µ –¥–µ—Ç–∞–ª–∏ –ø–æ —Ü–≤–µ—Ç—É –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥–±–æ—Ä–∞ –∫ –≤–∞—à–µ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
    "‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ —Å –≤–∏–∑—É–∞–ª—å–Ω—ã–º–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏",
    "üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ –¥–µ—Ç–∞–ª–µ–π",
    "‚òÅÔ∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏",
    "üîß –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–æ —Ç–µ–º–∞–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–æ–≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π —Å–µ—Ä–∏–∏",
    "üß† –£–º–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∏—Ä—É–µ—Ç –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ",
    "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ",
    "‚ù§Ô∏è –î–æ–±–∞–≤–ª—è–π—Ç–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞",
    "üíæ –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –±—Ä–∞—É–∑–µ—Ä–∞",
    "ü•ß –ö—Ä—É–≥–æ–≤—ã–µ –¥–∏–∞–≥—Ä–∞–º–º—ã –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ —Ç–µ–º–∞–º –∏ —Ä–µ–¥–∫–æ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤",
    "‚ö° –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–æ–Ω—á–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑",
    "üîê –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏",
    "üéØ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é —Ñ–∏–ª—å—Ç—Ä–æ–≤ –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –Ω—É–∂–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤",
    "üìã –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Å–≤–æ—é –∫–æ–ª–ª–µ–∫—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV",
    "üìà –°—Ç–æ–ª–±—á–∞—Ç—ã–µ –≥—Ä–∞—Ñ–∏–∫–∏ –ø–æ–º–æ–≥–∞—é—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
    "üîÑ –†–µ–≥—É–ª—è—Ä–Ω–æ –æ–±–Ω–æ–≤–ª—è–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
    "üéØ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤",
    "üîç –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –Ω—É–∂–Ω—ã—Ö –¥–µ—Ç–∞–ª–µ–π",
    "üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫—ç—à–∞ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
    "üí° –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã",
    "üîÑ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è",
    "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö",
    "üîç –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —á–∞—Å—Ç–∏—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é - –Ω–µ –Ω—É–∂–Ω–æ –≤–≤–æ–¥–∏—Ç—å –ø–æ–ª–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ",
    "üì± PWA –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω–æ–µ",
    "‚ù§Ô∏è –î–æ–±–∞–≤–ª—è–π—Ç–µ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ–º—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞",
    "üåê Offline —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö",
    "üìä –í –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –º–æ–∂–Ω–æ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞",
    "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–µ–≤—ã–µ –∞—Å–ø–µ–∫—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
    "üñºÔ∏è –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ",
    "üéØ –°–∏—Å—Ç–µ–º–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑—É—á–∏—Ç—å –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∫–∞—Ç–∞–ª–æ–≥–∞",
    "üé≤ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
    "üé® –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–µ–ª–∞—é—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –±–æ–ª–µ–µ –ø—Ä–∏—è—Ç–Ω—ã–º",
    "‚ö° –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ",
    "üì§ –≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è",
    "üéØ –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é",
    "üìö –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –ø–æ–¥—Å–∫–∞–∑–∫–∞—Ö —Ä–∞—Å—à–∏—Ä—è–µ—Ç –∑–Ω–∞–Ω–∏—è –æ —Ñ—É–Ω–∫—Ü–∏—è—Ö",
    "üîç –§–∏–ª—å—Ç—Ä—ã –º–æ–∂–Ω–æ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤",
    "üé® –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ü–≤–µ—Ç–æ–≤—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–¥–±–æ—Ä–∞ –¥–µ—Ç–∞–ª–µ–π –∫ –Ω–∞–±–æ—Ä—É",
    "üìã –ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏–∑ –¥—Ä—É–≥–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤",
    "üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤",
    "üé≤ –£–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –∫–Ω–æ–ø–∫—É –î–µ—Ç–∞–ª–∏/–ù–∞–±–æ—Ä—ã/–§–∏–≥—É—Ä–∫–∏ 1 —Å–µ–∫—É–Ω–¥—É –¥–ª—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞",
    "üñºÔ∏è –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º",
    "üì± –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤",
    "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏",
    "üì∑ –°–∫–∞–Ω–µ—Ä DataMatrix —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –∫–æ–¥—ã —Å–µ—Ä–∏–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ —Å –ø–æ–º–æ—â—å—é –∫–∞–º–µ—Ä—ã",
    "ü§ñ AI —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ Brickognize API –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º",
    "üì∑ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫–∞–Ω–µ—Ä DataMatrix –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é",
    "ü§ñ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –¥–µ—Ç–∞–ª—å, –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫—É –∏–ª–∏ –¥–∞–∂–µ –Ω–∞–±–æ—Ä –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ AI",
    "üîç –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ–º–æ–≥–∞—é—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã",
    "üì± –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–∏–∑–∞–π–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —É–¥–æ–±—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–∞ –ª—é–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö",
    "üí° –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏—Ç–µ –∫—ç—à –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∞–π—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã"
    ];
    
    console.log('LOADING_TIPS initialized with', window.LOADING_TIPS.length, 'tips');
    
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫
    window.LAST_TIPS_HISTORY = {
        feelingLucky: [],
        loading: [],
        maxHistory: 3 // –•—Ä–∞–Ω–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø–æ–¥—Å–∫–∞–∑–∫–∏
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
    window.getRandomTip = function() {
        if (!window.LOADING_TIPS || window.LOADING_TIPS.length === 0) {
            console.error('LOADING_TIPS array is not available');
            return 'üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        const currentTip = document.getElementById('loading-tip')?.textContent || '';
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â—É—é –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        const availableTips = window.LOADING_TIPS.filter(tip => 
            tip !== currentTip && !window.LAST_TIPS_HISTORY.loading.includes(tip)
        );
        
        if (availableTips.length === 0) {
            // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏, –æ—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
            console.log('All tips are in history, clearing history');
            window.LAST_TIPS_HISTORY.loading = [];
            
            // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
            const freshTips = window.LOADING_TIPS.filter(tip => tip !== currentTip);
            if (freshTips.length === 0) {
                // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª—é–±—É—é
                const randomIndex = Math.floor(Math.random() * window.LOADING_TIPS.length);
                const tip = window.LOADING_TIPS[randomIndex];
                console.log(`All tips are the same, selected: index ${randomIndex}, tip: ${tip}`);
                return tip;
            }
            
            const randomIndex = Math.floor(Math.random() * freshTips.length);
            const tip = freshTips[randomIndex];
            console.log(`Fresh tip selected after history clear: index ${randomIndex}, tip: ${tip}`);
            return tip;
        }
        
        // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
        const randomIndex = Math.floor(Math.random() * availableTips.length);
        const tip = availableTips[randomIndex];
        console.log(`Random tip selected (excluding current and history): index ${randomIndex}, tip: ${tip}`);
        return tip;
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏
    window.getRandomLoadingTip = function() {
        if (!window.LOADING_TIPS || window.LOADING_TIPS.length === 0) {
            console.error('LOADING_TIPS array is not available');
            return 'üí° –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã...';
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è
        const currentTip = document.getElementById('loading-tip')?.textContent || '';
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∏—Å–∫–ª—é—á–∞—è —Ç–µ–∫—É—â—É—é –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
        const availableTips = window.LOADING_TIPS.filter(tip => 
            tip !== currentTip && !window.LAST_TIPS_HISTORY.loading.includes(tip)
        );
        
        if (availableTips.length === 0) {
            // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏–∏, –æ—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏ –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
            console.log('All loading tips are in history, clearing history');
            window.LAST_TIPS_HISTORY.loading = [];
            
            // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
            const freshTips = window.LOADING_TIPS.filter(tip => tip !== currentTip);
            if (freshTips.length === 0) {
                // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ª—é–±—É—é
                const randomIndex = Math.floor(Math.random() * window.FEELING_LUCKY_TIPS.length);
                const tip = window.LOADING_TIPS[randomIndex];
                console.log(`All loading tips are the same, selected: index ${randomIndex}, tip: ${tip}`);
                return tip;
            }
            
            const randomIndex = Math.floor(Math.random() * freshTips.length);
            const tip = freshTips[randomIndex];
            console.log(`Fresh loading tip selected after history clear: index ${randomIndex}, tip: ${tip}`);
            return tip;
        }
        
        // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö
        const randomIndex = Math.floor(Math.random() * availableTips.length);
        const tip = availableTips[randomIndex];
        console.log(`Random loading tip selected (excluding current and history): index ${randomIndex}, tip: ${tip}`);
        return tip;
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏ —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫
    window.animateTipChange = function(element, newTip, onComplete = null) {
        if (!element) return;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
        element.classList.add('fade-out');
        
        // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è
        setTimeout(() => {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –±–µ–ª—ã–π —Ç–µ–∫—Å—Ç —Å —ç–º–æ–¥–∑–∏
            element.textContent = newTip;
            
            // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –ø–æ—è–≤–ª–µ–Ω–∏—è
            element.classList.remove('fade-out');
            element.classList.add('fade-in');
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            setTimeout(() => {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É
                element.classList.add('show');
                
                // –ü—É–ª—å—Å–∞—Ü–∏—é –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º
                
                // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å—ã –∞–Ω–∏–º–∞—Ü–∏–∏
                setTimeout(() => {
                    element.classList.remove('fade-in', 'show');
                }, 600);
                
                // –í—ã–∑—ã–≤–∞–µ–º callback –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if (onComplete) onComplete();
            }, 50);
        }, 300);
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤ –∏—Å—Ç–æ—Ä–∏—é
    window.addTipToHistory = function(tip, type = 'feelingLucky') {
        if (!window.LAST_TIPS_HISTORY || !window.LAST_TIPS_HISTORY[type]) return;
        
        const history = window.LAST_TIPS_HISTORY[type];
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –Ω–∞—á–∞–ª–æ –º–∞—Å—Å–∏–≤–∞
        history.unshift(tip);
        
        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
        if (history.length > window.LAST_TIPS_HISTORY.maxHistory) {
            history.pop();
        }
        
        console.log(`Added tip to ${type} history:`, tip);
        console.log(`Current ${type} history:`, history);
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
    window.startTipRotation = function() {
        console.log('üîÑ startTipRotation called, current interval:', window.tipRotationInterval);
        
        // –ó–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        if (window.tipRotationInterval) {
            console.log('‚ö†Ô∏è Tip rotation already running, skipping start request');
            return;
        }
        
        let tipElement = document.getElementById('loading-tip');
        
        // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –µ–≥–æ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥
        if (!tipElement) {
            console.log('üîç Tip element not found, waiting for it to appear...');
            let attempts = 0;
            const maxAttempts = 10;
            
            const waitForElement = setInterval(() => {
                tipElement = document.getElementById('loading-tip');
                attempts++;
                
                if (tipElement) {
                    clearInterval(waitForElement);
                    console.log('‚úÖ Tip element found after', attempts, 'attempts');
                    startRotation();
                } else if (attempts >= maxAttempts) {
                    clearInterval(waitForElement);
                    console.log('‚ùå Tip element not found after', maxAttempts, 'attempts, giving up');
                    return;
                }
            }, 500);
            
            return;
        }
        
        startRotation();
        
        function startRotation() {
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (window.tipRotationInterval) {
                clearInterval(window.tipRotationInterval);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
            window.tipRotationInterval = setInterval(() => {
                if (tipElement && window.getRandomTip && window.animateTipChange) {
                    const newTip = window.getRandomTip();
                    console.log('üîÑ Rotating tip to:', newTip);
                    window.animateTipChange(tipElement, newTip, () => {
                        console.log('‚úÖ Tip rotated to:', newTip);
                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –∏—Å—Ç–æ—Ä–∏—é
                        if (window.addTipToHistory) {
                            window.addTipToHistory(newTip, 'feelingLucky');
                        }
                    });
                }
            }, 5000);
            
            console.log('üöÄ Tip rotation started, interval ID:', window.tipRotationInterval);
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫
    window.stopTipRotation = function() {
        console.log('üõë stopTipRotation called, current interval:', window.tipRotationInterval);
        if (window.tipRotationInterval) {
            console.log('üõë Stopping tip rotation, interval ID:', window.tipRotationInterval);
            clearInterval(window.tipRotationInterval);
            window.tipRotationInterval = null;
            console.log('‚úÖ Tip rotation stopped');
        } else {
            console.log('‚ÑπÔ∏è No tip rotation interval to stop');
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
    window.forceStartTipRotation = function() {
        console.log('Force starting tip rotation...');
        if (window.startTipRotation) {
            window.startTipRotation();
        } else {
            console.error('startTipRotation function not available');
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫
    window.checkTipRotationStatus = function() {
        console.log('üîç Tip rotation status:');
        console.log('- LOADING_TIPS array length:', window.LOADING_TIPS ? window.LOADING_TIPS.length : 'undefined');
        console.log('- getRandomTip function available:', !!window.getRandomTip);
        console.log('- startTipRotation function available:', !!window.startTipRotation);
        console.log('- stopTipRotation function available:', !!window.stopTipRotation);
        console.log('- Current interval ID:', window.tipRotationInterval);
        console.log('- Tip element exists:', !!document.getElementById('loading-tip'));
        
        const tipElement = document.getElementById('loading-tip');
        if (tipElement) {
            console.log('- Current tip text:', tipElement.textContent);
        }
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –¥–µ–±–∞–≥ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    window.debugFeelingLucky = function() {
        console.log('üîç === DEBUG FEELING LUCKY ===');
        console.log('S.view:', S.view);
        console.log('S.subView:', S.subView);
        console.log('S.loading:', S.loading);
        console.log('S.err:', S.err);
        console.log('window.tipRotationInterval:', window.tipRotationInterval);
        console.log('window.startTipRotation available:', !!window.startTipRotation);
        console.log('window.stopTipRotation available:', !!window.stopTipRotation);
        console.log('window.getRandomTip available:', !!window.getRandomTip);
        console.log('window.animateTipChange available:', !!window.animateTipChange);
        console.log('=== END DEBUG ===');
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–±–∞–≥ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
    window.debugScrollState = function() {
        console.log('üìú === DEBUG SCROLL STATE ===');
        console.log('S.toDisplay:', S.toDisplay);
        console.log('S.totalItems:', S.totalItems);
        console.log('S.hasMoreItems:', S.hasMoreItems);
        console.log('S.increment:', S.increment);
        console.log('S.loadedItems:', S.loadedItems);
        console.log('S.view:', S.view);
        console.log('S.subView:', S.subView);
        console.log('mainEl.scrollHeight:', mainEl?.scrollHeight);
        console.log('mainEl.clientHeight:', mainEl?.clientHeight);
        console.log('mainEl.scrollTop:', mainEl?.scrollTop);
        console.log('Scroll listener attribute:', mainEl?.getAttribute('data-scroll-listener'));
        console.log('=== END SCROLL DEBUG ===');
    };
    
    // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π
    window.loadAllParts = function() {
        console.log('üîß Forcing load of all parts...');
        S.toDisplay = S.totalItems || 10000;
        S.hasMoreItems = false;
        updateUI();
        console.log('‚úÖ All parts should now be loaded');
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏
    window.startLoadingTipRotation = function() {
        const loadingTipElement = document.getElementById('loading-tip');
        if (!loadingTipElement) {
            console.log('Loading tip element not found, cannot start rotation');
            return;
        }
        
        console.log('Starting loading tip rotation, current tip:', loadingTipElement.textContent);
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        if (window.loadingTipRotationInterval) {
            clearInterval(window.loadingTipRotationInterval);
            console.log('Cleared previous loading tip rotation interval');
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –∫–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã (–±—ã—Å—Ç—Ä–µ–µ —á–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —ç–∫—Ä–∞–Ω–µ)
        window.loadingTipRotationInterval = setInterval(() => {
            if (loadingTipElement && window.getRandomLoadingTip && window.animateTipChange) {
                const newTip = window.getRandomLoadingTip();
                window.animateTipChange(loadingTipElement, newTip, () => {
                    console.log('Loading tip rotated to:', newTip);
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –∏—Å—Ç–æ—Ä–∏—é
                    if (window.addTipToHistory) {
                        window.addTipToHistory(newTip, 'loading');
                    }
                });
            }
        }, 3000);
        
        console.log('Loading tip rotation started, interval ID:', window.loadingTipRotationInterval);
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏
    window.stopLoadingTipRotation = function() {
        if (window.loadingTipRotationInterval) {
            console.log('Stopping loading tip rotation, interval ID:', window.loadingTipRotationInterval);
            clearInterval(window.loadingTipRotationInterval);
            window.loadingTipRotationInterval = null;
            console.log('Loading tip rotation stopped');
        } else {
            console.log('No loading tip rotation interval to stop');
        }
    };
    
    // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    // document.body.classList.add('page-loading');
    
    // –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    updateLoadingStatus("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...", 5, "–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö");
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    if (window.resetProgress) {
        window.resetProgress();
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏
    setTimeout(() => {
        if (window.startLoadingTipRotation) {
            console.log('Starting loading tip rotation...');
            window.startLoadingTipRotation();
        }
    }, 1000);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    resetRandomMinifigImage();
    
    loadState();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–≥—Ä–µ–≥–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV
    try {
        window.CSV_MB_PROGRESS = { totalBytes: 0, totalExpected: 0 };
    } catch {}

    S.sidebarLoading = true;
    updateUI();

    try {
        console.log('Starting data loading from CSV...');
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
        const progressMonitor = setInterval(() => {
            if (window._loadingProgressState && window._loadingProgressState.current < 99) {
                const timeSinceStart = Date.now() - (window._csvLoadStartTime || Date.now());
                if (timeSinceStart > 30000) { // 30 —Å–µ–∫—É–Ω–¥
                    console.log('‚ö†Ô∏è Long loading detected, forcing progress advance');
                    if (window.forceProgressAdvance) {
                        window.forceProgressAdvance();
                    }
                }
            }
        }, 5000);
        
        // –í—Å–µ–≥–¥–∞ —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ñ–∞–π–ª–æ–≤ (–±—ã—Å—Ç—Ä–æ, –æ—Ñ–ª–∞–π–Ω)
        await loadDataFromCSV();
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        clearInterval(progressMonitor);
        
        console.log('CSV data loading completed');
        console.log('PART_MAP size after CSV loading:', Object.keys(PART_MAP).length);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        try {
            const response = await fetch('./Minifig_png/minifig-count.txt');
            if (response.ok) {
                const count = await response.text();
                window.MINIFIG_COUNT = parseInt(count.trim());
                console.log('Minifig count loaded:', window.MINIFIG_COUNT);
            }
        } catch (e) {
            console.log('Minifig count file not found, using fallback range 1-30');
        }
        
        // –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –∫—ç—à
        updateLoadingStatus("–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...", 90, "–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫");
        await preloadImages();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ API –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (–±–µ–∑ –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏)
        updateLoadingStatus("–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...", 95, "–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ API");
        checkForNewDataInBackground();
        
    } catch (e) {
        console.error("Data loading failed:", e);
        S.err = S.err || `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞: ${e.message}`;
    } finally {
        S.sidebarLoading = false;
        updateUI();
    }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏, –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å
    (async () => {
        try {
            if (Object.keys(S.coll).length > 0) {
                await fetchMissingCollectionPartDetails();
                await ensureBasicPartImagesForCollection();
                // –ù–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ü–≤–µ—Ç–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∑–∞–¥–µ—Ä–∂–µ–∫
                // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            }
            
            if (Object.keys(S.setColl).length > 0) {
                await fetchMissingCollectionSetDetails();
            }
            
            if (Object.keys(S.minifigColl).length > 0) {
                await fetchMissingCollectionMinifigDetails();
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            saveState();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
            if (S.view === 'collection') {
                S.gridStale = true;
                updateUI();
            }
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            setupScrollListener();
            
            // –¢–µ–ø–µ—Ä—å –∑–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            console.log('Loading missing images after all data is loaded...');
            await fetchMissingImagesFromCSV();
            
            // –§–æ–Ω–æ–≤–∞—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            console.log('Starting background image preloading...');
            preloadRemainingImagesInBackground();
            
            // –û–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
            updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", 100, "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é");
            
            // –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            // setTimeout(() => {
            //     document.body.classList.remove('page-loading');
            // }, 500);
            
            setTimeout(() => {
                hideLoadingIndicator();
                
                // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫
                animateButtonsAppearance();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å sidebar-toggle –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –¥–ª—è –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                setTimeout(() => {
                    showSidebarHint();
                }, 1500);
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                // –û–¢–ö–õ–Æ–ß–ï–ù–û: –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å —Å–∏—Å—Ç–µ–º–æ–π –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                // setTimeout(() => {
                //     if (window.startTipRotation) {
                //         console.log('Starting automatic tip rotation...');
                //         window.startTipRotation();
                //     }
                // }, 2000);
            }, 1000);
            
        } catch (e) {
            console.error("Background collection data fetch failed:", e);
            // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏", 100, "–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é");
            setTimeout(() => {
                hideLoadingIndicator();
            }, 1000);
        }
    })();
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö (–ë–ï–ó –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
    setTimeout(async () => {
        try {
            console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞...');
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            if (window.remoteStorageAvailable && typeof RemoteStorage !== 'undefined') {
                const connectionState = getCloudStorageConnectionState();
                
                if (connectionState.needsReconnection) {
                    console.log('‚ÑπÔ∏è –ù–∞–π–¥–µ–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ, –Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫');
                    console.log('‚ÑπÔ∏è –î–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ" –≤ —Ä–∞–∑–¥–µ–ª–µ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
                } else if (connectionState.isConnected) {
                    console.log('‚úÖ –£–∂–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É');
                    updateCloudStorageUI();
                } else {
                    console.log('‚ÑπÔ∏è –ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –æ–±–ª–∞—á–Ω–æ–º—É —Ö—Ä–∞–Ω–∏–ª–∏—â—É');
                }
            } else {
                console.log('‚ö†Ô∏è RemoteStorage –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞:', error);
        }
    }, 3000); // –ñ–¥–µ–º 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
}
document.addEventListener("DOMContentLoaded", () => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º drag-and-drop –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –∂–µ–ª–∞–Ω–∏–π
    // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    
    // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('wheel', (e) => {
        if (e.ctrlKey) {
            e.preventDefault();
        }
    }, { passive: false });
    
    // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∂–µ—Å—Ç–æ–≤ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    document.addEventListener('gesturestart', (e) => e.preventDefault());
    document.addEventListener('gesturechange', (e) => e.preventDefault());
    document.addEventListener('gestureend', (e) => e.preventDefault());
    
    viewerCloseBtn.innerHTML = I_X("w-6 h-6");
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ CSV —Ñ–∞–π–ª–∞
    const csvImportInput = document.getElementById('import-csv-input');
    if (csvImportInput) {
        csvImportInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                try {
                    const content = await file.text();
                    await processCsvData(content);
                    // –û—á–∏—â–∞–µ–º –≤–≤–æ–¥ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞
                    event.target.value = '';
                    // –û–±–Ω–æ–≤–ª—è–µ–º UI
                    S.gridStale = true;
                    updateUI();
                } catch (error) {
                    console.error('CSV import failed:', error);
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    updateSettingsModalStatus(`${error.message}`, 'error');
                    // –û—á–∏—â–∞–µ–º –≤–≤–æ–¥ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                    event.target.value = '';
                }
            }
        });
    }
    
    initializeApp();

    // S.preventAccidentalExit —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏–∑ localStorage –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ S

    // –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–ª—É—á–∞–π–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏/–∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏
    window.addEventListener('beforeunload', (event) => {
        try {
            if (!S || !S.preventAccidentalExit) return;
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            resetRandomMinifigImage();
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫
            if (window.stopTipRotation) {
                window.stopTipRotation();
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏
            if (window.stopLoadingTipRotation) {
                window.stopLoadingTipRotation();
            }
            event.preventDefault();
            event.returnValue = '';
        } catch {}
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            if (!window.isSecureContext && location.hostname !== 'localhost') {
                console.warn('Service Worker —Ç—Ä–µ–±—É–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (https –∏–ª–∏ localhost). –°–µ–π—á–∞—Å: ', location.protocol);
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Service Worker
            navigator.serviceWorker.register('./service-worker.js', { scope: './' })
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope:', registration.scope);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('Service Worker update found');
                        
                        newWorker.addEventListener('statechange', async () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // –ù–æ–≤—ã–π Service Worker –≥–æ—Ç–æ–≤, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–±–Ω–æ–≤–∏—Ç—å
                                console.log('New service worker ready, prompting update');
                                if (confirm('–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è!\n\n–ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç:\n‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞\n‚Ä¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏\n‚Ä¢ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã\n\n–≠—Ç–æ –∑–∞–π–º–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.\n–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å?')) {
                                    console.log('üîÑ Starting app update with cache clearing...');
                                    
                                    try {
                                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                                        const updateIndicator = document.createElement('div');
                                        updateIndicator.id = 'update-indicator';
                                        updateIndicator.innerHTML = `
                                            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;">
                                                <div style="background: #1f2937; padding: 2rem; border-radius: 1rem; text-align: center; color: white; max-width: 300px;">
                                                    <div style="margin-bottom: 1rem; display: flex; justify-content: center;">${I_Refresh('w-12 h-12 text-blue-400 animate-spin')}</div>
                                                    <div style="font-weight: bold; margin-bottom: 0.5rem;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
                                                    <div id="update-status" style="color: #9ca3af; font-size: 0.875rem;">–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞...</div>
                                                    <div style="margin-top: 1rem; height: 4px; background: #374151; border-radius: 2px; overflow: hidden;">
                                                        <div id="update-progress" style="height: 100%; background: #3b82f6; width: 0%; transition: width 0.3s ease;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                        document.body.appendChild(updateIndicator);
                                        
                                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                                        const updateProgress = (width, status) => {
                                            const progressBar = document.getElementById('update-progress');
                                            const statusText = document.getElementById('update-status');
                                            if (progressBar) progressBar.style.width = width + '%';
                                            if (statusText) statusText.textContent = status;
                                        };
                                        
                                        updateProgress(20, '–û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞...');
                                        
                                        // –°–Ω–∞—á–∞–ª–∞ –æ—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                                        console.log('üßπ Clearing app cache before update...');
                                        const cacheCleared = await window.clearAppCache();
                                        
                                        updateProgress(60, '–ö—ç—à –æ—á–∏—â–µ–Ω, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...');
                                        
                                        if (cacheCleared) {
                                            console.log('‚úÖ Cache cleared successfully, proceeding with update');
                                        } else {
                                            console.warn('‚ö†Ô∏è Cache clearing failed, but proceeding with update anyway');
                                        }
                                        
                                        // –ó–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ–º Service Worker
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        
                                        updateProgress(80, '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...');
                                        
                                        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–æ–π –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—á–∏—Å—Ç–∫–∏ –∫—ç—à–∞
                                        setTimeout(() => {
                                            updateProgress(100, '–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...');
                                            setTimeout(() => {
                                                window.location.reload();
                                            }, 300);
                                        }, 500);
                                        
                                    } catch (error) {
                                        console.error('‚ùå Error during update process:', error);
                                        
                                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–µ, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                                        const statusText = document.getElementById('update-status');
                                        if (statusText) {
                                            statusText.textContent = '–û—à–∏–±–∫–∞, –Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è...';
                                            statusText.style.color = '#f59e0b';
                                        }
                                        
                                        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1000);
                                    }
                                } else {
                                    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                                    console.log('‚ÑπÔ∏è User declined app update');
                                    
                                    // –ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å –Ω–µ–±–æ–ª—å—à–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ
                                    const updateNotification = document.createElement('div');
                                    updateNotification.innerHTML = `
                                        <div style="position: fixed; top: 20px; right: 20px; background: #1f2937; color: white; padding: 1rem; border-radius: 0.5rem; z-index: 9999; max-width: 300px; border-left: 4px solid #3b82f6;">
                                            <div style="font-weight: bold; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">${I_Refresh('w-4 h-4 text-blue-400')} –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ</div>
                                            <div style="font-size: 0.875rem; color: #9ca3af; margin-bottom: 1rem;">–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ—Å–µ—â–µ–Ω–∏–∏</div>
                                            <button onclick="this.parentElement.parentElement.remove()" style="background: #374151; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
                                        </div>
                                    `;
                                    document.body.appendChild(updateNotification);
                                    
                                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
                                    setTimeout(() => {
                                        if (updateNotification.parentElement) {
                                            updateNotification.remove();
                                        }
                                    }, 10000);
                                }
                            }
                        });
                    });
                    
                    return navigator.serviceWorker.ready;
                })
                .then(() => {
                    console.log('ServiceWorker is active and ready.');
                    
                    // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Service Worker
                    navigator.serviceWorker.addEventListener('message', event => {
                        if (event.data && event.data.type === 'RELOAD_PAGE') {
                            window.location.reload();
                        }
                    });
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—ç—à–µ–º
                    window.clearAppCache = async () => {
                        try {
                            const cacheNames = await caches.keys();
                            await Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheName.startsWith('lego-catalog-cache')) {
                                        console.log('Deleting cache:', cacheName);
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                            
                            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É API –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞
                            try {
                                const initialStats = {
                                    colors: 0,
                                    parts: 0,
                                    sets: 0,
                                    minifigs: 0,
                                    images: 0,
                                    lastUpdate: null
                                };
                                localStorage.setItem('legoApiStats', JSON.stringify(initialStats));
                                window.API_STATS = initialStats;
                                console.log('API stats reset successfully');
                            } catch (statsError) {
                                console.error('Failed to reset API stats:', statsError);
                            }
                            
                            
                            console.log('App cache cleared successfully');
                            return true;
                        } catch (error) {
                            console.error('Failed to clear cache:', error);
                            return false;
                        }
                    };
                    
                    window.getCacheInfo = async () => {
                        try {
                            const cacheNames = await caches.keys();
                            const cacheInfo = {};
                            
                            for (const cacheName of cacheNames) {
                                if (cacheName.startsWith('lego-catalog-cache')) {
                                    const cache = await caches.open(cacheName);
                                    const keys = await cache.keys();
                                    cacheInfo[cacheName] = keys.length;
                                }
                            }
                            
                            return cacheInfo;
                        } catch (error) {
                            console.error('Failed to get cache info:', error);
                            return {};
                        }
                    };
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
        });
    }

    // PWA install prompt (–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
    (function(){
        let deferredInstallPrompt = null;
        let pwaPromptShown = false;
        let loadTimestamp = null;
        try {
            pwaPromptShown = localStorage.getItem('pwaPromptShown') === 'true';
        } catch {}
        window.addEventListener('load', () => { loadTimestamp = Date.now(); });

        window.addEventListener('beforeinstallprompt', (e) => {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∞–≤—Ç–æ-–ø–æ–∫–∞–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞
            e.preventDefault();
            deferredInstallPrompt = e;
            if (!pwaPromptShown) {
                const now = Date.now();
                const base = loadTimestamp || now;
                const delay = Math.max(0, 3000 - (now - base));
                setTimeout(() => {
                    showPwaInstallNotice();
                    try { localStorage.setItem('pwaPromptShown', 'true'); } catch {}
                }, delay);
                pwaPromptShown = true;
            }
        });

        window.addEventListener('appinstalled', () => {
            deferredInstallPrompt = null;
            try { localStorage.setItem('pwaPromptShown', 'true'); } catch {}
        });

        function showPwaInstallNotice() {
            // –ë–∞–Ω–Ω–µ—Ä –≤ —Å—Ç–∏–ª–µ –±–ª–æ–∫–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            const bar = document.createElement('div');
            bar.setAttribute('role', 'dialog');
            bar.className = 'fixed inset-x-0 bottom-0 z-[70] pointer-events-none sm:hidden';
            bar.innerHTML = `
                <div class="flex justify-center px-4 pb-4">
                    <div class="pointer-events-auto w-full max-w-md bg-gray-900/80 backdrop-blur-md rounded-[18px] p-4 border border-gray-700 shadow-xl">
                        <div class="flex flex-col items-start gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-semibold text-gray-300 mb-1">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ LEGO Catalog –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
                                <div class="text-xs text-gray-400">–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø, –æ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º –∏ –Ω–∞—Ç–∏–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>
                            </div>
                            <div class="flex items-center gap-2 w-full justify-center">
                                <button id="pwa-install-btn" class="flex-1 px-3 py-2 text-sm font-semibold rounded-[18px] transition-colors duration-150 bg-blue-600 hover:bg-blue-700 text-white">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                                <button id="pwa-install-dismiss" class="flex-1 px-3 py-2 text-sm rounded-[18px] text-gray-300 hover:text-white hover:bg-gray-700/60">–ü–æ–∑–∂–µ</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            document.body.appendChild(bar);

            const onDismiss = () => { bar.remove(); };
            const onInstall = async () => {
                if (!deferredInstallPrompt) { onDismiss(); return; }
                try {
                    deferredInstallPrompt.prompt();
                    await deferredInstallPrompt.userChoice;
                } catch {}
                deferredInstallPrompt = null;
                onDismiss();
            };
            document.getElementById('pwa-install-dismiss')?.addEventListener('click', onDismiss, { once: true });
            document.getElementById('pwa-install-btn')?.addEventListener('click', onInstall, { once: true });
        }
    })();
});
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∏–∑ CSV —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
// –¢–µ–ø–µ—Ä—å —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ –æ—á–µ—Ä–µ–¥–∏, –Ω–∞—á–∏–Ω–∞—è —Å —Å–∞–º—ã—Ö –≤–∞–∂–Ω—ã—Ö –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
async function loadDataFromCSV() {
    try {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        window._csvLoadStartTime = Date.now();
        
        // –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–≤—ã–º–∏)
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö...", null, "–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ");
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ü–ï–†–í–´–ú–ò (—Å–∞–º—ã–µ –≤–∞–∂–Ω—ã–µ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–µ—Ç–∞–ª–µ–π...", null, "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏");
        await loadCategoriesFromCSV();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–º—ã (–¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –Ω–∞–±–æ—Ä–∞–º)
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º –Ω–∞–±–æ—Ä–æ–≤...", null, "–¢–µ–º—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –Ω–∞–±–æ—Ä–∞–º");
        await loadThemesFromCSV();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ü–≤–µ—Ç–∞ (–Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π)
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ —Ü–≤–µ—Ç–æ–≤...", null, "–¶–≤–µ—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π");
        await loadColorsFromCSV();
        
        // –§–∞–∑–∞ 2: –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∞ (–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
        // –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–∞
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π...", null, "–î–µ—Ç–∞–ª–∏ - –æ—Å–Ω–æ–≤–∞ –∫–∞—Ç–∞–ª–æ–≥–∞");
        await loadPartsFromCSV();
        
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–±–æ—Ä–æ–≤...", null, "–ù–∞–±–æ—Ä—ã LEGO");
        await loadSetsFromCSV();
        
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...", null, "–ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏");
        await loadMinifigsFromCSV();
        
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...", null, "–¢–∞–±–ª–∏—Ü–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –∫–æ–¥–æ–≤ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫");
        await loadFigTable();
        
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...", null, "–ó–∞–≥—Ä—É–∑–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π");
        
        // –§–∞–∑–∞ 3: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏, —Ç–∞–∫ –∫–∞–∫ –∑–∞–≤–∏—Å—è—Ç –æ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
        await loadElementsFromCSV();
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –¥–ª—è —Ñ–∞–π–ª–æ–≤-—á–∞—Å—Ç–µ–π
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π...", null, "–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏ –¥–µ—Ç–∞–ª–µ–π...");
        await loadInventoriesFromCSV();
        
        updateLoadingStatus("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏...", null, "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞");
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ CSV
        saveState();
        
        // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        console.log('CSV Data loaded successfully:');
        console.log('- Parts:', Object.keys(PART_MAP).length);
        console.log('- Sets:', Object.keys(SET_MAP).length);
        console.log('- Minifigs:', Object.keys(MINIFIG_MAP).length);
        console.log('- Colors:', Object.keys(COLOR_MAP).length);
        console.log('- Categories:', flatCategories.length);
        console.log('- Themes:', Object.keys(THEME_MAP).length);
        
        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
        console.log('üìÖ Starting global sorting of all data...');
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –Ω–∞–±–æ—Ä—ã –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        if (Object.keys(SET_MAP).length > 0) {
            console.log('üì¶ Sorting all sets by year (newest first)...');
            const allSets = Object.values(SET_MAP);
            allSets.sort((a, b) => {
                const yearA = parseInt(a.year) || 0;
                const yearB = parseInt(b.year) || 0;
                return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
            });
            console.log('‚úÖ All sets sorted by year, newest first');
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        if (Object.keys(MINIFIG_MAP).length > 0) {
            console.log('üë§ Sorting all minifigs by year (newest first)...');
            const allMinifigs = Object.values(MINIFIG_MAP);
            allMinifigs.sort((a, b) => {
                const yearA = parseInt(a.year) || 0;
                const yearB = parseInt(b.year) || 0;
                return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
            });
            console.log('‚úÖ All minifigs sorted by year, newest first');
        }
        
        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (—á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–≤—ã–º–∏)
        if (Object.keys(PART_MAP).length > 0) {
            console.log('üîß Sorting all parts by popularity (most used first)...');
            const allParts = Object.values(PART_MAP);
            allParts.sort((a, b) => {
                const popularityA = parseInt(a.num_sets) || 0;
                const popularityB = parseInt(b.num_sets) || 0;
                return popularityB - popularityA; // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏
            });
        }
        
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –¥–µ—Ç–∞–ª–µ–π –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
        S.totalPartsInCatalog = Object.keys(PART_MAP).length;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö –Ω–∞–±–æ—Ä–æ–≤ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
        S.totalSetsInCatalog = Object.keys(SET_MAP).length;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        S.gridStale = true;
        updateUI();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        if (S.view === 'tools' && S.toolSubView === 'analytics') {
            console.log('üìä –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ CSV –¥–∞–Ω–Ω—ã—Ö...');
            analyzeCollection();
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", 100, "–ö–∞—Ç–∞–ª–æ–≥ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é");
        setTimeout(() => {
            hideLoadingIndicator();
        }, 1000);
        
    } catch (error) {
        console.error('Failed to load CSV data:', error);
        S.err = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ CSV –¥–∞–Ω–Ω—ã—Ö: ${error.message}`;
        
        updateLoadingStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", 0, `–û—à–∏–±–∫–∞: ${error.message}`);
        
        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É API, –µ—Å–ª–∏ CSV –Ω–µ —É–¥–∞–µ—Ç—Å—è
        try {
            updateLoadingStatus("–ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ API...", 50, "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞");
            await Promise.all([fetchAllColors(), fetchCategories(), fetchThemes()]);
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ—Ç–∞–ª–µ–π –∏–∑ API (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
            if (Object.keys(PART_MAP).length > 0) {
                S.totalPartsInCatalog = Object.keys(PART_MAP).length;
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±–æ—Ä–æ–≤ –∏–∑ API (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
            if (Object.keys(SET_MAP).length > 0) {
                S.totalSetsInCatalog = Object.keys(SET_MAP).length;
            }
            
            // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API
            console.log('üìÖ Starting global sorting of API data...');
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –Ω–∞–±–æ—Ä—ã –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
            if (Object.keys(SET_MAP).length > 0) {
                console.log('üì¶ Sorting all API sets by year (newest first)...');
                const allSets = Object.values(SET_MAP);
                allSets.sort((a, b) => {
                    const yearA = parseInt(a.year) || 0;
                    const yearB = parseInt(b.year) || 0;
                    return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
                });
                console.log('‚úÖ All API sets sorted by year, newest first');
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ –≥–æ–¥—É (–Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏)
            if (Object.keys(MINIFIG_MAP).length > 0) {
                console.log('üë§ Sorting all API minifigs by year (newest first)...');
                const allMinifigs = Object.values(MINIFIG_MAP);
                allMinifigs.sort((a, b) => {
                    const yearA = parseInt(a.year) || 0;
                    const yearB = parseInt(b.year) || 0;
                    return yearB - yearA; // –ù–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏
                });
                console.log('‚úÖ All API minifigs sorted by year, newest first');
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏ –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏ (—á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–≤—ã–º–∏)
            if (Object.keys(PART_MAP).length > 0) {
                console.log('üîß Sorting all API parts by popularity (most used first)...');
                const allParts = Object.values(PART_MAP);
                allParts.sort((a, b) => {
                    const popularityA = parseInt(a.num_sets) || 0;
                    const popularityB = parseInt(b.num_sets) || 0;
                    return popularityB - popularityA; // –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–µ—Ä–≤—ã–º–∏
                });
            }
            
            
            updateLoadingStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ API –∑–∞–≤–µ—Ä—à–µ–Ω–∞", 100, "–ö–∞—Ç–∞–ª–æ–≥ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é");
            setTimeout(() => {
                hideLoadingIndicator();
            }, 1000);
        } catch (apiError) {
            console.error('Fallback API loading also failed:', apiError);
            S.err = `${S.err}\n–¢–∞–∫–∂–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ API: ${apiError.message}`;
            updateLoadingStatus("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞", 0, "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–∏ –∏–∑ CSV, –Ω–∏ –∏–∑ API");
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–≤–µ—Ç–æ–≤ –∏–∑ CSV
async function loadColorsFromCSV() {
    try {
        const csvText = await fetchTextWithProgress('./Data/colors.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ —Ü–≤–µ—Ç–æ–≤...', 'colors.csv');
        const lines = csvText.split('\n').slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        
        lines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                const [id, name, rgb, is_trans] = fields;
                if (id && name) {
                    COLOR_MAP[id] = {
                        id: id,
                        name: name,
                        hex: `#${rgb || '000000'}`,
                        isTransparent: is_trans === 'True',
                        rgb: rgb || '000000',
                        is_trans: is_trans === 'True'
                    };
                }
            }
        });
        

    } catch (error) {
        console.error('Failed to load colors from CSV:', error);
        throw error;
    }
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏–∑ CSV
async function loadCategoriesFromCSV() {
    try {
        const csvText = await fetchTextWithProgress('./Data/part_categories.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –¥–µ—Ç–∞–ª–µ–π...', 'part_categories.csv');
        const lines = csvText.split('\n').slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        
        lines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                const [id, name] = fields;
                if (id && name) {
                    flatCategories.push({
                        id: parseInt(id),
                        name: name,
                        parent_id: null
                    });
                }
            }
        });
        
        // –°—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
        S.catTree = buildCategoryTree(flatCategories);
        

    } catch (error) {
        console.error('Failed to load categories from CSV:', error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–µ—Ä–∞—Ä—Ö–∏–∏ —Ç–µ–º
function fixThemeHierarchy(themeMap) {
    // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É—é –∏–µ—Ä–∞—Ä—Ö–∏—é: –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–¥ Advent
    // Advent –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫–∞–ª–µ–Ω–¥–∞—Ä–∏, –∞ –Ω–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã
    
    // –°–ø–∏—Å–æ–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–º, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –ø–æ–¥ Advent (207)
    const mainThemesUnderAdvent = [208, 209, 210, 211, 212, 213, 214, 215, 216, 710, 751, 780]; 
    // City, Star Wars, Belville, Castle, Classic Basic, Clikits, Creator, Pirates, Friends, Harry Potter, Marvel, Disney
    
    // –ü–µ—Ä–µ–º–µ—â–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –∏–∑-–ø–æ–¥ Advent –≤ –∫–æ—Ä–µ–Ω—å (–¥–µ–ª–∞–µ–º –∏—Ö –∫–æ—Ä–Ω–µ–≤—ã–º–∏ —Ç–µ–º–∞–º–∏)
    mainThemesUnderAdvent.forEach(themeId => {
        if (themeMap[themeId] && themeMap[themeId].parent_id === 207) {
            themeMap[themeId].parent_id = null; // –î–µ–ª–∞–µ–º –∫–æ—Ä–Ω–µ–≤–æ–π —Ç–µ–º–æ–π
        }
    });
    
    // –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–ª—è Advent –ø–æ–¥ Seasonal (206)
    if (themeMap[207]) {
        themeMap[207].parent_id = 206; // Seasonal
        themeMap[207].name = 'Advent Calendars';
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –ø–æ–¥ Advent
    const calendarThemes = [227, 228, 229, 230, 231, 232]; // Christmas, Creator, Easter, Halloween, Thanksgiving, Valentine
    calendarThemes.forEach(themeId => {
        if (themeMap[themeId]) {
            themeMap[themeId].parent_id = 207; // Advent Calendars
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–º –∏–∑ CSV
async function loadThemesFromCSV() {
    try {
        const csvText = await fetchTextWithProgress('./Data/themes.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–µ–º –Ω–∞–±–æ—Ä–æ–≤...', 'themes.csv');
        const lines = csvText.split('\n').slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        
        const themeMap = {};
        
        lines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                const [id, name, parent_id] = fields;
                if (id && name) {
                    const theme = {
                        id: parseInt(id),
                        name: name,
                        parent_id: parent_id ? parseInt(parent_id) : null,
                        children: []
                    };
                    themeMap[id] = theme;
                    THEME_MAP[id] = theme;
                }
            }
        });
        
        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –∏–µ—Ä–∞—Ä—Ö–∏—é —Ç–µ–º
        fixThemeHierarchy(themeMap);
        
        // –°—Ç—Ä–æ–∏–º –¥–µ—Ä–µ–≤–æ —Ç–µ–º
        const rootThemes = [];
        Object.values(themeMap).forEach(theme => {
            if (theme.parent_id && themeMap[theme.parent_id]) {
                themeMap[theme.parent_id].children.push(theme);
            } else {
                rootThemes.push(theme);
            }
        });
        
        S.themeTree = rootThemes;
        

    } catch (error) {
        console.error('Failed to load themes from CSV:', error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∏–∑ CSV
async function loadPartsFromCSV() {
    try {
        const csvText = await fetchTextWithProgress('./Data/parts.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π...', 'parts.csv');
        const lines = csvText.split('\n').slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        
        lines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                const [part_num, name, part_cat_id] = fields;
                if (part_num && name) {
                    // –ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–¥–µ—Å—å - –æ–Ω –±—É–¥–µ—Ç –ø–æ–ª—É—á–µ–Ω –∏–∑ inventory_parts.csv
                    PART_MAP[part_num] = {
                        id: part_num,
                        name: name,
                        part_num: part_num,
                        part_cat_id: part_cat_id ? parseInt(part_cat_id) : null,
                        categoryId: part_cat_id ? parseInt(part_cat_id) : null,
                        num_sets: 0, // –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ API, –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è
                        part_img_url: null, // –ë—É–¥–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ inventory_parts.csv
                        rebrickable_img_url: null
                    };
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                    if (PART_MAP[part_num].categoryId && (PART_MAP[part_num].categoryId < 1 || PART_MAP[part_num].categoryId > 1000)) {
                        console.warn('Invalid category ID for part', part_num, ':', PART_MAP[part_num].categoryId);
                        PART_MAP[part_num].categoryId = null;
                        PART_MAP[part_num].part_cat_id = null;
                    }
                }
            }
        });
        

    } catch (error) {
        console.error('Failed to load parts from CSV:', error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è theme_id –∞–¥–≤–µ–Ω—Ç-–∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
function fixAdventCalendarThemes() {
    // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –Ω–∞–±–æ—Ä—ã-–∫–∞–ª–µ–Ω–¥–∞—Ä–∏ –∏ –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –∏—Ö theme_id –Ω–∞ 207 (Advent Calendars)
    Object.values(SET_MAP).forEach(set => {
        if (set.name && set.name.toLowerCase().includes('advent calendar')) {
            set.original_theme_id = set.theme_id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ç–µ–º—É
            set.theme_id = 207; // –ü–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–∞–µ–º –Ω–∞ Advent Calendars
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞–±–æ—Ä–æ–≤ –∏–∑ CSV
async function loadSetsFromCSV() {
    try {
        const csvText = await fetchTextWithProgress('./Data/sets.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞–±–æ—Ä–æ–≤...', 'sets.csv');
        const lines = csvText.split('\n').slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        
        lines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                const [set_num, name, year, theme_id, num_parts, img_url] = fields;
                if (set_num && name) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ CSV, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ, –∏–Ω–∞—á–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
                    let setImgUrl = img_url || `https://cdn.rebrickable.com/media/sets/${set_num}.jpg`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    if (setImgUrl && (!setImgUrl.startsWith('http') || setImgUrl.includes('localhost'))) {
                        console.warn('Invalid image URL detected for set', set_num, ':', setImgUrl);
                        setImgUrl = `https://cdn.rebrickable.com/media/sets/${set_num}.jpg`;
                    }
                    
                    SET_MAP[set_num] = {
                        set_num: set_num,
                        name: name,
                        year: year ? parseInt(year) : null,
                        theme_id: theme_id ? parseInt(theme_id) : null,
                        num_parts: num_parts ? parseInt(num_parts) : null,
                        set_img_url: setImgUrl
                    };
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                    if (SET_MAP[set_num].year && (SET_MAP[set_num].year < 1900 || SET_MAP[set_num].year > 2030)) {
                        console.warn('Invalid year for set', set_num, ':', SET_MAP[set_num].year);
                        SET_MAP[set_num].year = null;
                    }
                    
                    if (SET_MAP[set_num].num_parts && (SET_MAP[set_num].num_parts < 0 || SET_MAP[set_num].num_parts > 10000)) {
                        console.warn('Invalid num_parts for set', set_num, ':', SET_MAP[set_num].num_parts);
                        SET_MAP[set_num].num_parts = null;
                    }
                }
            }
        });
        
        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º theme_id –¥–ª—è –∞–¥–≤–µ–Ω—Ç-–∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π
        fixAdventCalendarThemes();

    } catch (error) {
        console.error('Failed to load sets from CSV:', error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏–∑ CSV
// –ò–°–ü–†–ê–í–õ–ï–ù–û: –¢–µ–ø–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ–ª–µ img_url –∏–∑ CSV –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø–∞—Å–Ω–æ–π URL
async function loadMinifigsFromCSV() {
    try {
        const csvText = await fetchTextWithProgress('./Data/minifigs.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...', 'minifigs.csv');
        const lines = csvText.split('\n').slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        
        lines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                const [fig_num, name, num_parts, img_url] = fields;
                if (fig_num && name) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ CSV, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ, –∏–Ω–∞—á–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
                    let minifigImgUrl = img_url || `https://cdn.rebrickable.com/media/minifigs/${fig_num}.jpg`;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    if (minifigImgUrl && (!minifigImgUrl.startsWith('http') || minifigImgUrl.includes('localhost'))) {
                        console.warn('Invalid image URL detected for minifig', fig_num, ':', minifigImgUrl);
                        minifigImgUrl = `https://cdn.rebrickable.com/media/minifigs/${fig_num}.jpg`;
                    }
                    
                    MINIFIG_MAP[fig_num] = {
                        set_num: fig_num, // –ò—Å–ø–æ–ª—å–∑—É–µ–º set_num –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏
                        name: name,
                        num_parts: num_parts ? parseInt(num_parts) : null,
                        minifig_img_url: minifigImgUrl
                    };
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                    if (MINIFIG_MAP[fig_num].num_parts && (MINIFIG_MAP[fig_num].num_parts < 0 || MINIFIG_MAP[fig_num].num_parts > 100)) {
                        console.warn('Invalid num_parts for minifig', fig_num, ':', MINIFIG_MAP[fig_num].num_parts);
                        MINIFIG_MAP[fig_num].num_parts = null;
                    }
                }
            }
        });
        

        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏–∑ API –¥–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
        await fetchMissingMinifigImages();
    } catch (error) {
        console.error('Failed to load minifigs from CSV:', error);
        throw error;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –∫–æ–¥–æ–≤ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
async function loadFigTable() {
    try {
        const figTableText = await fetchTextWithProgress('./figtable.txt?v=' + Date.now(), '–ó–∞–≥—Ä—É–∑–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...', 'figtable.txt');
        const lines = figTableText.split('\n');
        
        // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –∫–∞—Ä—Ç—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –∫–æ–¥ -> ID –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        window.FIG_CODE_MAP = {};
        
        for (let i = 0; i < lines.length; i += 4) {
            if (i + 3 < lines.length) {
                const codeLine = lines[i].trim();
                const nameLine = lines[i + 1].trim();
                const idLine = lines[i + 2].trim();
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–¥ (–ø–µ—Ä–≤—ã–µ 7 —Ü–∏—Ñ—Ä)
                const codeMatch = codeLine.match(/^(\d{7}):/);
                if (codeMatch) {
                    const code = codeMatch[1];
                    
                    // –ò–∑–≤–ª–µ–∫–∞–µ–º ID –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
                    const idMatch = idLine.match(/i:\s*"([^"]+)"/);
                    if (idMatch) {
                        const minifigId = idMatch[1];
                        window.FIG_CODE_MAP[code] = minifigId;
                    }
                }
            }
        }
        
        console.log('FigTable loaded successfully:', Object.keys(window.FIG_CODE_MAP).length, 'entries');
        console.log('–ü—Ä–∏–º–µ—Ä—ã –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∫–æ–¥–æ–≤:', Object.keys(window.FIG_CODE_MAP).slice(0, 5));
        console.log('–ü—Ä–∏–º–µ—Ä—ã ID –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫:', Object.values(window.FIG_CODE_MAP).slice(0, 5));
        console.log('SET_MAP —Ä–∞–∑–º–µ—Ä:', Object.keys(SET_MAP).length);
        console.log('–ü—Ä–∏–º–µ—Ä—ã –Ω–∞–±–æ—Ä–æ–≤ –≤ SET_MAP:', Object.keys(SET_MAP).slice(0, 5));
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–∞–±–æ—Ä "71050" –≤ SET_MAP
        if (SET_MAP['71050']) {
            console.log('–ù–∞–π–¥–µ–Ω –Ω–∞–±–æ—Ä 71050:', SET_MAP['71050']);
        } else {
            console.log('–ù–∞–±–æ—Ä 71050 –ù–ï –Ω–∞–π–¥–µ–Ω –≤ SET_MAP');
            console.log('–ü–æ–∏—Å–∫ –Ω–∞–±–æ—Ä–æ–≤ —Å 71050:', Object.keys(SET_MAP).filter(key => key.includes('71050')));
        }
    } catch (error) {
        console.error('Failed to load figtable.txt:', error);
        // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        window.FIG_CODE_MAP = {};
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–∞–±–æ—Ä–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ ID –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
function findMinifigSetByFigId(figId) {
    console.log('findMinifigSetByFigId –≤—ã–∑–≤–∞–Ω–∞ —Å figId:', figId);
    
    if (!figId || !window.FIG_CODE_MAP) {
        console.log('–ù–µ—Ç figId –∏–ª–∏ FIG_CODE_MAP –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return null;
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä –Ω–∞–±–æ—Ä–∞ –∏–∑ ID –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "71050-9" -> "71050")
    const setId = figId.split('-')[0];
    console.log('–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π setId:', setId);
    
    // –ò—â–µ–º –Ω–∞–±–æ—Ä –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∞–±–æ—Ä–æ–≤ (SET_MAP)
    const set = SET_MAP[setId];
    console.log('–ù–∞–π–¥–µ–Ω –≤ SET_MAP:', set);
    if (set) {
        return set;
    }
    
    // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –Ω–æ–º–µ—Ä—É –Ω–∞–±–æ—Ä–∞, –ø–æ–ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ –ø–æ–ª–Ω–æ–º—É ID –≤ SET_MAP
    const fullIdSet = SET_MAP[figId];
    console.log('–ù–∞–π–¥–µ–Ω –ø–æ –ø–æ–ª–Ω–æ–º—É ID –≤ SET_MAP:', fullIdSet);
    if (fullIdSet) {
        return fullIdSet;
    }
    
    console.log('–ù–∞–±–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è figId:', figId, '–≤ –∫–∞—Ç–∞–ª–æ–≥–µ –Ω–∞–±–æ—Ä–æ–≤');
    return null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø–æ –∫–æ–¥—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function getMinifigIdFromScanCode(scanCode) {
    console.log('getMinifigIdFromScanCode –≤—ã–∑–≤–∞–Ω–∞ —Å –∫–æ–¥–æ–º:', scanCode);
    
    if (!scanCode || !window.FIG_CODE_MAP) {
        console.log('–ù–µ—Ç –∫–æ–¥–∞ –∏–ª–∏ FIG_CODE_MAP –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
        return null;
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–µ—Ä–≤—ã–µ 7 —Ü–∏—Ñ—Ä –∏–∑ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
    const codeMatch = scanCode.match(/^(\d{7})/);
    console.log('–†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ:', codeMatch);
    
    if (codeMatch) {
        const code = codeMatch[1];
        console.log('–ò–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π –∫–æ–¥ (7 —Ü–∏—Ñ—Ä):', code);
        console.log('–ü–æ–∏—Å–∫ –≤ FIG_CODE_MAP:', window.FIG_CODE_MAP[code]);
        return window.FIG_CODE_MAP[code] || null;
    }
    
    console.log('–ö–æ–¥ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ñ–æ—Ä–º–∞—Ç—É 7 —Ü–∏—Ñ—Ä');
    return null;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞–±–æ—Ä–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
function renderMinifigSetCardForScanner(setData, figId) {
    if (!setData) {
        return `
            <div class="text-center text-gray-400 py-8">
                <div class="text-3xl mb-2">‚ùå</div>
                <p class="text-lg font-medium mb-2">–ù–∞–±–æ—Ä –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
                <p class="text-sm">ID: ${figId}</p>
            </div>
        `;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–æ–ª—è –∏–∑ SET_MAP
    const setId = setData.set_num;
    const setName = setData.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ';
    const imageUrl = setData.set_img_url;
    const numParts = setData.num_parts;
    const year = setData.year;
    
    console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∏–∑ SET_MAP:', { setId, setName, imageUrl, numParts, year });
    
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Ç–æ—á–Ω–æ –∫–∞–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ (–∏—Å–ø–æ–ª—å–∑—É–µ–º renderSetCard)
    return renderSetCard(setData, false, 0);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏—Ö URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –∏–∑ API
async function fetchMissingMinifigImages() {
    const minifigsWithoutImages = Object.values(MINIFIG_MAP).filter(m => !m.minifig_img_url);
    
    if (minifigsWithoutImages.length === 0) {
        return;
    }
    
    for (const minifig of minifigsWithoutImages.slice(0, 10)) { // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 10, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
        if (!minifig || !minifig.set_num) {
            continue;
        }
        
        try {
            const response = await fetchWithProxy(`${REBRICKABLE_API_URL}/minifigs/${minifig.set_num}/?key=${getApiKey()}`);
            if (response.ok) {
                const data = await response.json();
                if (data.results && data.results[0] && data.results[0].set_img_url) {
                    minifig.minifig_img_url = data.results[0].set_img_url;
                    try { markApiStatOnce('images', `minifig:${minifig.set_num}`); } catch {}
                }
            }
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
            await new Promise(resolve => setTimeout(resolve, 100));
        } catch (error) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ CSV
async function loadElementsFromCSV() {
    try {
        const csvText = await fetchTextWithProgress('./Data/elements.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤...', 'elements.csv');
        const lines = csvText.split('\n').slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        
        lines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                const [element_id, part_num, color_id] = fields;
                if (element_id && part_num && color_id) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —ç–ª–µ–º–µ–Ω—Ç–µ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                    if (!PART_MAP[part_num]) {
                        PART_MAP[part_num] = { id: part_num, name: 'Unknown Part' };
                    }
                    if (!COLOR_MAP[color_id]) {
                        COLOR_MAP[color_id] = { id: color_id, name: 'Unknown Color', hex: '#000000' };
                    }
                }
            }
        });
        

    } catch (error) {
        console.error('Failed to load elements from CSV:', error);
        // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
    }
}
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ inventory_parts_part_XXX –∏–∑ parts_info.txt
async function discoverInventoryPartFiles() {
    const baseDir = './Data/inventory_parts_split/';
    const infoUrl = baseDir + 'parts_info.txt';
    try {
        const resp = await fetch(infoUrl, { cache: 'no-cache' });
        if (!resp.ok) throw new Error('parts_info not found');
        const text = await resp.text();
        const files = [];
        const lines = text.split('\n');
        const re = /inventory_parts_part_\d{3}\.csv/;
        for (const line of lines) {
            const m = line.match(re);
            if (m) files.push(m[0]);
        }
        if (files.length > 0) return files.map(name => baseDir + name);
    } catch (e) {
        // fall through to heuristic
    }
    // Fallback: –ø—Ä–æ–±—É–µ–º –¥–æ 50 —á–∞—Å—Ç–µ–π –∏ –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ
    const discovered = [];
    for (let partNum = 1; partNum <= 50; partNum++) {
        const name = `inventory_parts_part_${partNum.toString().padStart(3, '0')}.csv`;
        const url = baseDir + name;
        try {
            const head = await fetch(url, { method: 'HEAD' });
            if (head.ok) discovered.push(url); else break;
        } catch {
            break;
        }
    }
    return discovered;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π –∏–∑ CSV
    async function loadInventoriesFromCSV() {
    try {
        // –ó–∞–≥—Ä—É–∂–∞–µ–º inventory_parts: –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –≤–æ—Ä–∫–µ—Ä–∞ –ø–∞—Ä—Å–∏–º –ø–æ—Ç–æ–∫–æ–≤–æ
        const inventoryPartsLines = [];
        const partFiles = await discoverInventoryPartFiles();
        const maxParts = partFiles.length || 1;
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–∞–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Å —É—á—ë—Ç–æ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —á–∞—Å—Ç–µ–π
        try {
            window.DYNAMIC_PARTS_COUNT = maxParts;
            window.CSV_PROGRESS_PLAN = null;
            initCsvProgressPlan();
        } catch {}
        let loadedParts = 0;
        const useWorker = !!window.Worker;
        let worker = null;
        if (useWorker) {
            try {
                // –°–æ–∑–¥–∞—ë–º –≤–æ—Ä–∫–µ—Ä –Ω–∞ –ª–µ—Ç—É (–±–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–π–ª–æ–≤)
                const workerSrc = `self.onmessage=function(e){var u=e.data.url;var l=e.data.label;function p(t){try{self.postMessage({type:'progress',label:l,bytes:t});}catch(e){}};fetch(u).then(function(r){var reader=r.body&&r.body.getReader?r.body.getReader():null;if(!reader){return r.text().then(function(txt){self.postMessage({type:'batch',rows:txt.split('\\n')});self.postMessage({type:'done'});});}var dec=new TextDecoder();var buf='';function pump(){reader.read().then(function(res){var done=res.done;var value=res.value;if(done){if(buf){self.postMessage({type:'batch',rows:buf.split('\\n')});}self.postMessage({type:'done'});return;}p(value.length);buf+=dec.decode(value,{stream:true});var lastNL=buf.lastIndexOf('\\n');if(lastNL!==-1){var chunk=buf.slice(0,lastNL);buf=buf.slice(lastNL+1);self.postMessage({type:'batch',rows:chunk.split('\\n')});}pump();});}pump();});};`;
                const blob = new Blob([workerSrc], { type: 'application/javascript' });
                const url = URL.createObjectURL(blob);
                worker = new Worker(url);
            } catch (e) {
                worker = null;
            }
        }
        for (let idx = 0; idx < partFiles.length; idx++) {
            const url = partFiles[idx];
            const label = url.substring(url.lastIndexOf('/') + 1);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞-—á–∞—Å—Ç–∏
            const preProgress = calcPlannedProgress(label, 0);
            updateLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π –¥–µ—Ç–∞–ª–µ–π...', preProgress, `–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π –¥–µ—Ç–∞–ª–µ–π...`);
            
            try {
                if (worker) {
                    await new Promise((resolve) => {
                        let isFirstBatch = true;
                        const onMsg = (e) => {
                            if (e.data.type === 'batch') {
                                const rows = e.data.rows;
                                const linesToAdd = isFirstBatch && idx === 0 ? rows.slice(1) : rows; // –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
                                for (let i = 0; i < linesToAdd.length; i++) {
                                    if (linesToAdd[i]) inventoryPartsLines.push(linesToAdd[i]);
                                }
                                isFirstBatch = false;
                            } else if (e.data.type === 'progress') {
                                const totalExpected = window.CSV_MB_PROGRESS.totalExpected || 0;
                                const totalLoaded = window.CSV_MB_PROGRESS.totalBytes;
                                const remaining = totalExpected > 0 ? Math.max(0, totalExpected - totalLoaded) : 0;
                                const details = `–ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏ –¥–µ—Ç–∞–ª–µ–π\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${formatMb(totalLoaded)} MB ‚Ä¢ –í—Å–µ–≥–æ: ${formatMb(totalExpected)} MB ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: ${formatMb(remaining)} MB`;
                                const progressPercent = calcPlannedProgress(label, null);
                                updateLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π –¥–µ—Ç–∞–ª–µ–π...', progressPercent, details);
                            } else if (e.data.type === 'done') {
                                worker.removeEventListener('message', onMsg);
                                resolve();
                            }
                        };
                        worker.addEventListener('message', onMsg);
                        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å –≤ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π URL –¥–ª—è –≤–æ—Ä–∫–µ—Ä–∞ (blob: –∫–æ–Ω—Ç–µ–∫—Å—Ç)
                        const absUrl = (function(){
                            try { return new URL(url, window.location.href).href; } catch (e) { return url; }
                        })();
                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–æ—Ä–∫–µ—Ä–∞ ‚Äî —Ñ–æ–ª–ª–±–µ–∫ –Ω–∞ –æ–±—ã—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É
                        const onErr = () => {
                            try { worker.removeEventListener('message', onMsg); } catch (e) {}
                            resolve();
                        };
                        worker.addEventListener('error', onErr, { once: true });
                        worker.postMessage({ url: absUrl, label });
                    });
                } else {
                    const csvText = await fetchTextWithProgress(url, '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π –¥–µ—Ç–∞–ª–µ–π...', label);
                    const lines = csvText.split('\n');
                    const linesToAdd = idx === 0 ? lines.slice(1) : lines.slice(1);
                    for (let i = 0; i < linesToAdd.length; i++) {
                        inventoryPartsLines.push(linesToAdd[i]);
                    }
                }
                loadedParts++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏-—á–∞—Å—Ç—è–º–∏
                const progressPercent = calcPlannedProgress(label, 1);
                updateLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π –¥–µ—Ç–∞–ª–µ–π...', progressPercent, `–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏ –¥–µ—Ç–∞–ª–µ–π...`);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
                if (idx < partFiles.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                if (S.settingsOpen) {
                    updateSettingsModalStatus(`–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π\n—á–∞—Å—Ç—å ${idx + 1}/${maxParts}`, "info");
                }
            } catch (error) {
                console.error(`Failed to load part ${label}:`, error);
                break;
            }
        }
        

        
        const lines = inventoryPartsLines;
        
        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
        const inventoryPartsMap = {};
        const inventorySetsMap = {};
        const inventoryMinifigsMap = {};
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –¥–µ—Ç–∞–ª–µ–π –∏ –æ–±–Ω–æ–≤–ª—è–µ–º PART_MAP –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö
        let partsWithImagesCount = 0;
        let partsWithColorImagesCount = 0;
        
        let processedLines = 0;
        let skippedLines = 0;
        
        lines.forEach((line, lineIndex) => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                processedLines++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 500 —Å—Ç—Ä–æ–∫ –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
                if (processedLines % 500 === 0) {
                    const progressPercent = calcPlannedProgress('inventory_parts_part_001.csv', 1) + (processedLines / lines.length) * 2;
                    const remaining = lines.length - processedLines;
                    const totalExpected = window.CSV_MB_PROGRESS.totalExpected || 0;
                    const totalLoaded = window.CSV_MB_PROGRESS.totalBytes;
                    updateLoadingStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π...', progressPercent, `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è...\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${formatMb(totalLoaded)} MB ‚Ä¢ –í—Å–µ–≥–æ: ${formatMb(totalExpected)} MB ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${processedLines} —Å—Ç—Ä–æ–∫`);
                }
                
                const [inventory_id, part_num, color_id, quantity, is_spare, img_url] = fields;
                
                if (inventory_id && part_num && color_id && quantity) {
                    if (!inventoryPartsMap[inventory_id]) {
                        inventoryPartsMap[inventory_id] = [];
                    }
                    inventoryPartsMap[inventory_id].push({
                        part_num,
                        color_id: parseInt(color_id),
                        quantity: parseInt(quantity),
                        is_spare: (String(is_spare).trim().toLowerCase() === 't'),
                        img_url: img_url || null
                    });
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª—å-—Ü–≤–µ—Ç (–µ—Å–ª–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
                    if (fields.length > 5 && img_url && img_url.trim() && img_url.startsWith('http')) {
                        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∑–∞–ø–∏—Å—å PART_MAP —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        if (!PART_MAP[part_num]) {
                            PART_MAP[part_num] = { 
                                id: part_num, 
                                name: 'Unknown Part'
                            };
                        }
                        
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º colorImages, –µ—Å–ª–∏ –æ–Ω –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        if (!PART_MAP[part_num].colorImages) {
                            PART_MAP[part_num].colorImages = {};
                        }
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç—Ç–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞
                        PART_MAP[part_num].colorImages[color_id] = img_url;
                        partsWithColorImagesCount++;
                        
                        // –¢–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                        if (!PART_MAP[part_num].part_img_url) {
                            PART_MAP[part_num].part_img_url = img_url;
                            PART_MAP[part_num].rebrickable_img_url = img_url;
                            partsWithImagesCount++;
                        }
                    }
                    
                    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –¥–µ—Ç–∞–ª–∏ –∏ —Ü–≤–µ—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
                    if (!PART_MAP[part_num]) {
                        PART_MAP[part_num] = { 
                            id: part_num, 
                            name: 'Unknown Part'
                        };
                    }
                    if (!COLOR_MAP[color_id]) {
                        COLOR_MAP[color_id] = { 
                            id: color_id, 
                            name: 'Unknown Color', 
                            hex: '#000000' 
                        };
                    }
                } else {
                    skippedLines++;
                }
            }
        });
        

        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º inventories.csv –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å-–Ω–∞–±–æ—Ä
        const inventoriesCsvText = await fetchTextWithProgress('./Data/inventories.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π...', 'inventories.csv');
        const inventoriesLines = inventoriesCsvText.split('\n').slice(1);
        
        const inventoryToSetMap = {};
        inventoriesLines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                const [inventory_id, version, set_num] = fields;
                if (inventory_id && set_num) {
                    inventoryToSetMap[inventory_id] = set_num;
                }
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º inventory_sets —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        updateLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–æ–≤...', null, '–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏ –Ω–∞–±–æ—Ä–æ–≤...');
        const setCsvText = await fetchTextWithProgress('./Data/inventory_sets.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –Ω–∞–±–æ—Ä–æ–≤...', 'inventory_sets.csv');
        const setLines = setCsvText.split('\n').slice(1);
        
        let setProcessedLines = 0;
        setLines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                setProcessedLines++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 100 —Å—Ç—Ä–æ–∫ –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤
                if (setProcessedLines % 100 === 0) {
                    const progressPercent = calcPlannedProgress('inventory_sets.csv', 1) + (setProcessedLines / setLines.length) * 1;
                    const totalExpected = window.CSV_MB_PROGRESS.totalExpected || 0;
                    const totalLoaded = window.CSV_MB_PROGRESS.totalBytes;
                    updateLoadingStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π –Ω–∞–±–æ—Ä–æ–≤...', progressPercent, `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–±–æ—Ä–æ–≤...\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${formatMb(totalLoaded)} MB ‚Ä¢ –í—Å–µ–≥–æ: ${formatMb(totalExpected)} MB ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${setProcessedLines} —Å—Ç—Ä–æ–∫`);
                }
                const [inventory_id, set_num, quantity] = fields;
                if (inventory_id && set_num && quantity) {
                    if (!inventorySetsMap[inventory_id]) {
                        inventorySetsMap[inventory_id] = [];
                    }
                    inventorySetsMap[inventory_id].push({
                        set_num,
                        quantity: parseInt(quantity)
                    });
                }
            }
        });
        
        // –î–æ–ø–æ–ª–Ω—è–µ–º inventorySetsMap –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ inventories.csv
        Object.keys(inventoryToSetMap).forEach(inventoryId => {
            const setNum = inventoryToSetMap[inventoryId];
            if (!inventorySetsMap[inventoryId]) {
                inventorySetsMap[inventoryId] = [];
            }
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞–±–æ—Ä –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
            const exists = inventorySetsMap[inventoryId].some(set => set.set_num === setNum);
            if (!exists) {
                inventorySetsMap[inventoryId].push({
                    set_num: setNum,
                    quantity: 1
                });
            }
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º inventory_minifigs —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º
        updateLoadingStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...', null, '–ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...');
        const minifigCsvText = await fetchTextWithProgress('./Data/inventory_minifigs.csv', '–ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...', 'inventory_minifigs.csv');
        const minifigLines = minifigCsvText.split('\n').slice(1);
        
        let minifigProcessedLines = 0;
        minifigLines.forEach(line => {
            if (line.trim()) {
                const fields = parseCsvLine(line);
                minifigProcessedLines++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 100 —Å—Ç—Ä–æ–∫ –¥–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
                if (minifigProcessedLines % 100 === 0) {
                    const progressPercent = calcPlannedProgress('inventory_minifigs.csv', 1) + (minifigProcessedLines / minifigLines.length) * 1;
                    const totalExpected = window.CSV_MB_PROGRESS.totalExpected || 0;
                    const totalLoaded = window.CSV_MB_PROGRESS.totalBytes;
                    updateLoadingStatus('–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...', progressPercent, `–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${formatMb(totalLoaded)} MB ‚Ä¢ –í—Å–µ–≥–æ: ${formatMb(totalExpected)} MB ‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${minifigProcessedLines} —Å—Ç—Ä–æ–∫`);
                }
                const [inventory_id, fig_num, quantity] = fields;
                if (inventory_id && fig_num && quantity) {
                    if (!inventoryMinifigsMap[inventory_id]) {
                        inventoryMinifigsMap[inventory_id] = [];
                    }
                    inventoryMinifigsMap[inventory_id].push({
                        fig_num,
                        quantity: parseInt(quantity)
                    });
                }
            }
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–Ω–∞—Ö
        window.INVENTORY_DATA = {
            parts: inventoryPartsMap,
            sets: inventorySetsMap,
            minifigs: inventoryMinifigsMap
        };

        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏
        // await fetchMissingImagesFromCSV(); // Moved to initializeApp to ensure proper order
    } catch (error) {
        console.error('Failed to load inventory data from CSV:', error);
        // –ù–µ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
    }
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏
function getLoadingStats() {
    const stats = {
        colors: Object.keys(COLOR_MAP).length,
        categories: flatCategories.length,
        themes: Object.keys(THEME_MAP).length,
        parts: Object.keys(PART_MAP).length,
        sets: Object.keys(SET_MAP).length,
        minifigs: Object.keys(MINIFIG_MAP).length,
        partsWithImages: Object.values(PART_MAP).filter(p => p.part_img_url || p.rebrickable_img_url).length,
        setsWithImages: Object.values(SET_MAP).filter(s => s.set_img_url).length,
        minifigsWithImages: Object.values(MINIFIG_MAP).filter(m => m.minifig_img_url).length
    };
    
            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ API
    const apiStats = getApiLoadingStats();
    
    return {
        ...stats,
        ...apiStats
    };
}
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ API
function getApiLoadingStats() {
    let apiStats = {};
    try {
        apiStats = JSON.parse(localStorage.getItem('legoApiStats') || '{}');
    } catch {}
    // Fallback –Ω–∞ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ localStorage –ø—É—Å—Ç
    if ((!apiStats || Object.keys(apiStats).length === 0) && window.API_STATS) {
        apiStats = window.API_STATS;
    }
    return {
        lastApiUpdate: apiStats.lastUpdate || null
    };
}

// –ö—ç—à –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–µ—Ç–∞–ª–µ–π –ø–æ —Ü–≤–µ—Ç—É –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
window.PARTS_BY_COLOR_CACHE = window.PARTS_BY_COLOR_CACHE || {};
function getPartsWithColorSet(colorId) {
    try {
        if (colorId === undefined || colorId === null) return new Set();
        const id = String(colorId);
        if (window.PARTS_BY_COLOR_CACHE[id]) return window.PARTS_BY_COLOR_CACHE[id];
        const set = new Set();
        const invParts = (window.INVENTORY_DATA && window.INVENTORY_DATA.parts) ? Object.values(window.INVENTORY_DATA.parts) : [];
        for (const inventory of invParts) {
            if (!Array.isArray(inventory)) continue;
            for (const item of inventory) {
                if (!item) continue;
                if (String(item.color_id) === id && item.part_num) set.add(String(item.part_num));
            }
        }
        window.PARTS_BY_COLOR_CACHE[id] = set;
        return set;
    } catch {
        return new Set();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ API
function updateApiLoadingStats(type, count = 1) {
    try {
        const current = JSON.parse(localStorage.getItem('legoApiStats') || '{}');
        const apiStats = {
            colors: Number(current.colors) || 0,
            parts: Number(current.parts) || 0,
            sets: Number(current.sets) || 0,
            minifigs: Number(current.minifigs) || 0,
            images: Number(current.images) || 0,
            lastUpdate: current.lastUpdate || null
        };
        const n = Number(count) || 0;
        if (['colors','parts','sets','minifigs','images'].includes(type)) {
            apiStats[type] += n;
        }
        apiStats.lastUpdate = new Date().toISOString();
        localStorage.setItem('legoApiStats', JSON.stringify(apiStats));
        // –î—É–±–ª–∏—Ä—É–µ–º –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        window.API_STATS = apiStats;
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –º–æ–¥–∞–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫, –æ–±–Ω–æ–≤–∏–º –ø–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (–±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏)
        if (S.settingsOpen) {
            try { refreshSettingsStatsPanel(); } catch {}
        }
    } catch (error) {
        console.error('Failed to update API stats:', error);
    }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ API –æ–¥–∏–Ω —Ä–∞–∑ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç
function markApiStatOnce(type, id) {
    try {
        if (!['colors','parts','sets','minifigs','images'].includes(type)) return;
        if (id === undefined || id === null) return;
        const idStr = String(id);

        // –¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
        const current = JSON.parse(localStorage.getItem('legoApiStats') || '{}');
        const apiStats = {
            colors: Number(current.colors) || 0,
            parts: Number(current.parts) || 0,
            sets: Number(current.sets) || 0,
            minifigs: Number(current.minifigs) || 0,
            images: Number(current.images) || 0,
            lastUpdate: current.lastUpdate || null
        };

        // –ù–∞–±–æ—Ä —É–∂–µ —É—á—Ç–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        let seen = {};
        try { seen = JSON.parse(localStorage.getItem('legoApiSeen') || '{}') || {}; } catch {}
        if (!seen[type]) seen[type] = {};

        // –ï—Å–ª–∏ –µ—â–µ –Ω–µ —É—á–∏—Ç—ã–≤–∞–ª–∏ ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∏ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ —É—á—Ç–µ–Ω–Ω—ã–π
        if (!seen[type][idStr]) {
            apiStats[type] = Number(apiStats[type] || 0) + 1;
            apiStats.lastUpdate = new Date().toISOString();
            seen[type][idStr] = true;
            localStorage.setItem('legoApiStats', JSON.stringify(apiStats));
            localStorage.setItem('legoApiSeen', JSON.stringify(seen));
            try { console.debug('[API stats] +1', type, idStr, apiStats[type]); } catch {}
            window.API_STATS = apiStats;
            if (S.settingsOpen) {
                try { refreshSettingsStatsPanel(); } catch {}
            }
        }
    } catch (error) {
        console.error('Failed to mark API stat once:', error);
    }
}

// –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏ –º–æ–¥–∞–ª–∞
function refreshSettingsStatsPanel() {
    const panel = document.getElementById('settings-stats-panel');
    if (!panel) return;
    const stats = getLoadingStats();
    const lastUpdate = stats.lastApiUpdate ? new Date(stats.lastApiUpdate).toLocaleString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞';
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–Ω–µ–ª–∏
    const isOpen = localStorage.getItem('settingsStatsOpen') === 'true';
    if (isOpen) {
        panel.classList.add('open');
    } else {
        panel.classList.remove('open');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —à–µ–≤—Ä–æ–Ω–∞
    const chevron = document.getElementById('settings-stats-chevron');
    if (chevron) {
        if (isOpen) {
            chevron.classList.add('rotate-180');
        } else {
            chevron.classList.remove('rotate-180');
        }
    }
    
    
    panel.innerHTML = `
        <div class="text-green-400 text-xs mb-2">‚úì –í—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∏–∑ CSV —Ñ–∞–π–ª–æ–≤</div>
        <div class="space-y-1">
            <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                <div class="flex items-center text-gray-300 text-xs">
                    <div class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                    –¶–≤–µ—Ç–∞:
                </div>
                <div class="text-white font-semibold text-xs">${stats.colors}</div>
            </div>
            <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                <div class="flex items-center text-gray-300 text-xs">
                    <div class="w-2 h-2 rounded-full bg-blue-500 mr-2"></div>
                    –ö–∞—Ç–µ–≥–æ—Ä–∏–∏:
                </div>
                <div class="text-white font-semibold text-xs">${stats.categories}</div>
            </div>
            <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                <div class="flex items-center text-gray-300 text-xs">
                    <div class="w-2 h-2 rounded-full bg-green-500 mr-2"></div>
                    –¢–µ–º—ã:
                </div>
                <div class="text-white font-semibold text-xs">${stats.themes}</div>
            </div>
            <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                <div class="flex items-center text-gray-300 text-xs">
                    <div class="w-2 h-2 rounded-full bg-yellow-500 mr-2"></div>
                    –î–µ—Ç–∞–ª–∏:
                </div>
                <div class="text-white font-semibold text-xs">${stats.parts}</div>
            </div>
            <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                <div class="flex items-center text-gray-300 text-xs">
                    <div class="w-2 h-2 rounded-full bg-purple-500 mr-2"></div>
                    –ù–∞–±–æ—Ä—ã:
                </div>
                <div class="text-white font-semibold text-xs">${stats.sets}</div>
            </div>
            <div class="flex items-center justify-between py-1 px-2 rounded bg-gray-800/50">
                <div class="flex items-center text-gray-300 text-xs">
                    <div class="w-2 h-2 rounded-full bg-pink-500 mr-2"></div>
                    –ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏:
                </div>
                <div class="text-white font-semibold text-xs">${stats.minifigs}</div>
            </div>
        </div>
    `;
}

// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò: –ø—Ä–æ–≥—Ä–µ—Å—Å —Å–∫–∞—á–∏–≤–∞–Ω–∏—è CSV –≤ –º–µ–≥–∞–±–∞–π—Ç–∞—Ö (—Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ)
function formatMb(bytes) {
    if (!bytes || isNaN(bytes)) return '0.00';
    return (bytes / (1024 * 1024)).toFixed(2);
}
async function fetchTextWithProgress(url, statusText, label) {
    try {
        const resp = await fetch(url);
        // –ï—Å–ª–∏ –ø–æ—Ç–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
        const reader = resp && resp.body && resp.body.getReader ? resp.body.getReader() : null;
        const contentLengthHeader = resp && resp.headers ? resp.headers.get('content-length') : null;
        const totalForFile = contentLengthHeader ? parseInt(contentLengthHeader, 10) : 0;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä
        if (window.updateTotalExpectedSize && totalForFile > 0) {
            window.updateTotalExpectedSize(totalForFile);
        }
        
        if (!window.CSV_MB_PROGRESS) window.CSV_MB_PROGRESS = { totalBytes: 0, totalExpected: 0 };
        if (!window.CSV_PROGRESS_PLAN) initCsvProgressPlan();
        if (!window.CSV_PROGRESS_STATE) window.CSV_PROGRESS_STATE = { completed: new Set() };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
        const fileStartTime = Date.now();
        window._fileStartTime = fileStartTime; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è calcPlannedProgress
        let lastProgressUpdate = 0;
        
        if (!reader) {
            // Fallback –¥–ª—è —Å–ª—É—á–∞–µ–≤ –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ —á—Ç–µ–Ω–∏—è
            const text = await resp.text();
            try {
                const approxBytes = text.length;
                window.CSV_MB_PROGRESS.totalBytes += approxBytes;
                const progressPercent = calcPlannedProgress(label, 1);
                const totalExpected = window.CSV_MB_PROGRESS.totalExpected || 0;
                const totalLoaded = window.CSV_MB_PROGRESS.totalBytes;
                const remaining = totalExpected > 0 ? Math.max(0, totalExpected - totalLoaded) : 0;
                const details = `${statusText}\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${formatMb(totalLoaded)} MB ‚Ä¢ –í—Å–µ–≥–æ: ${formatMb(totalExpected)} MB ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: ${formatMb(remaining)} MB`;
                updateLoadingStatus(statusText, progressPercent, details);
                window.CSV_PROGRESS_STATE.completed.add(label);
            } catch {}
            return text;
        }
        
        const decoder = new TextDecoder();
        let received = 0;
        let text = '';
        let chunkCount = 0;
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
        const initialProgress = calcPlannedProgress(label, 0);
        updateLoadingStatus(statusText, initialProgress, `–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É...`);
        
        for (;;) {
            const { done, value } = await reader.read();
            if (done) break;
            
            received += value.length;
            window.CSV_MB_PROGRESS.totalBytes += value.length;
            text += decoder.decode(value, { stream: true });
            chunkCount++;
            
            const now = Date.now();
            const timeSinceLastUpdate = now - lastProgressUpdate;
            
            // –î–ª—è —Ñ–∞–π–ª–æ–≤-—á–∞—Å—Ç–µ–π –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —á–∞—â–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
            const updateFrequency = label.includes('inventory_parts_part_') ? 50 : 100;
            const chunkFrequency = label.includes('inventory_parts_part_') ? 5 : 10;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —á–∞—â–µ –¥–ª—è —Ñ–∞–π–ª–æ–≤-—á–∞—Å—Ç–µ–π
            if (timeSinceLastUpdate >= updateFrequency || chunkCount % chunkFrequency === 0) {
                const fileFraction = totalForFile > 0 ? Math.max(0, Math.min(1, received / totalForFile)) : null;
                const progressPercent = calcPlannedProgress(label, fileFraction);
                
                // –î–ª—è —Ñ–∞–π–ª–æ–≤-—á–∞—Å—Ç–µ–π –¥–æ–±–∞–≤–ª—è–µ–º –±–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—É—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é
                let timeVariation = 0;
                if (label.includes('inventory_parts_part_')) {
                    // –ë–æ–ª–µ–µ –∞–∫—Ç–∏–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Ñ–∞–π–ª–æ–≤-—á–∞—Å—Ç–µ–π
                    timeVariation = Math.sin(now / 500) * 0.3 + Math.sin(now / 200) * 0.1;
                } else {
                    timeVariation = Math.sin(now / 1000) * 0.1;
                }
                
                const finalProgress = Math.min(99, progressPercent + timeVariation);
                
                const totalExpected = window.CSV_MB_PROGRESS.totalExpected || 0;
                const totalLoaded = window.CSV_MB_PROGRESS.totalBytes;
                const remaining = totalExpected > 0 ? Math.max(0, totalExpected - totalLoaded) : 0;
                const details = `${statusText}\n–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${formatMb(totalLoaded)} MB ‚Ä¢ –í—Å–µ–≥–æ: ${formatMb(totalExpected)} MB ‚Ä¢ –û—Å—Ç–∞–ª–æ—Å—å: ${formatMb(remaining)} MB`;
                
                updateLoadingStatus(statusText, finalProgress, details);
                lastProgressUpdate = now;
            }
            
            // –î–ª—è —Ñ–∞–π–ª–æ–≤-—á–∞—Å—Ç–µ–π –¥–µ–ª–∞–µ–º –±–æ–ª–µ–µ —á–∞—Å—Ç—ã–µ –ø–∞—É–∑—ã –¥–ª—è UI
            const pauseFrequency = label.includes('inventory_parts_part_') ? 25 : 50;
            if (chunkCount % pauseFrequency === 0) {
                await new Promise(resolve => setTimeout(resolve, 1));
            }
        }
        
        text += decoder.decode();
        
        // –§–∏–Ω–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        try { 
            window.CSV_PROGRESS_STATE.completed.add(label);
            const finalProgress = calcPlannedProgress(label, 1);
            updateLoadingStatus(statusText, finalProgress, `–ó–∞–≤–µ—Ä—à–µ–Ω–æ`);
            
            // –î–ª—è —Ñ–∞–π–ª–æ–≤-—á–∞—Å—Ç–µ–π –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            if (label.includes('inventory_parts_part_')) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏-—á–∞—Å—Ç—è–º–∏
                setTimeout(() => {
                    const nextProgress = calcPlannedProgress(label, 1) + 0.5;
                    updateLoadingStatus(statusText, nextProgress, `–ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ–π...`);
                }, 100);
            }
        } catch {}
        
        return text;
    } catch (e) {
        console.warn(`Error in fetchTextWithProgress for ${label}:`, e);
        // –í —Å–ª—É—á–∞–µ –ª—é–±—ã—Ö –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ—Å—Ç–æ —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
        try {
            const resp = await fetch(url);
            return await resp.text();
        } catch (fallbackError) {
            console.error(`Fallback fetch also failed for ${label}:`, fallbackError);
            throw fallbackError;
        }
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º –¥–≤–∏–∂–µ–Ω–∏–µ–º
(function(){
    if (!window._loadingProgressState) {
        window._loadingProgressState = { 
            current: 0, 
            target: 0, 
            rafId: null,
            lastUpdate: Date.now(),
            isStuck: false,
            stuckTimeout: null,
            minProgress: 0,
            maxProgress: 100
        };
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ü–µ–ª–µ–≤–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    window.setLoadingProgressTarget = function(nextPercent) {
        try {
            const progressElement = document.getElementById('loading-progress');
            if (!progressElement) return;
            
            const clamped = Math.max(0, Math.min(100, Number(nextPercent) || 0));
            const state = window._loadingProgressState;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            state.lastUpdate = Date.now();
            
            // –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ, –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–ª—å
            if (Math.abs(clamped - state.target) < 0.5) return;
            
            // –ú–æ–Ω–æ—Ç–æ–Ω–Ω–æ—Å—Ç—å: –Ω–µ —É–º–µ–Ω—å—à–∞–µ–º —Ü–µ–ª—å
            if (clamped <= state.target) return;
            
            state.target = clamped;
            state.isStuck = false;
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–∞—É—Ç –∑–∞–≤–∏—Å–∞–Ω–∏—è
            if (state.stuckTimeout) {
                clearTimeout(state.stuckTimeout);
                state.stuckTimeout = null;
            }

            if (!state.rafId) {
                const step = () => {
                    const now = Date.now();
                    const timeSinceUpdate = now - state.lastUpdate;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–≤–∏—Å –ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
                    if (timeSinceUpdate > 5000 && state.current < state.target - 1) {
                        if (!state.isStuck) {
                            console.log('‚ö†Ô∏è Progress appears stuck, enabling fallback animation');
                            state.isStuck = true;
                        }
                    }
                    
                    const delta = state.target - state.current;
                    
                    // –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–≤–∏—Å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
                    if (state.isStuck) {
                        state.current += Math.max(0.1, delta * 0.3);
                    } else {
                        // –ü–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ (ease-out)
                        state.current += delta * 0.15;
                    }
                    
                    // –ï—Å–ª–∏ –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ –∫ —Ü–µ–ª–∏, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ—á–Ω–æ
                    if (Math.abs(delta) < 0.1) {
                        state.current = state.target;
                    }
                    
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
                    state.current = Math.max(state.minProgress, Math.min(state.maxProgress, state.current));
                    
                    progressElement.style.width = state.current.toFixed(2) + '%';
                    
                    if (state.current < state.target) {
                        state.rafId = requestAnimationFrame(step);
                    } else {
                        cancelAnimationFrame(state.rafId);
                        state.rafId = null;
                        state.isStuck = false;
                    }
                };
                state.rafId = requestAnimationFrame(step);
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–∞—É—Ç –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
            state.stuckTimeout = setTimeout(() => {
                if (state.current < state.target - 1) {
                    console.log('‚ö†Ô∏è Progress timeout detected, forcing update');
                    state.isStuck = true;
                    if (!state.rafId) {
                        state.rafId = requestAnimationFrame(step);
                    }
                }
            }, 3000);
            
        } catch (error) {
            console.error('Error in setLoadingProgressTarget:', error);
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    window.forceProgressUpdate = function() {
        const state = window._loadingProgressState;
        if (state.rafId) {
            cancelAnimationFrame(state.rafId);
            state.rafId = null;
        }
        state.isStuck = false;
        state.lastUpdate = Date.now();
        
        const progressElement = document.getElementById('loading-progress');
        if (progressElement) {
            progressElement.style.width = state.current.toFixed(2) + '%';
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    window.resetProgress = function() {
        const state = window._loadingProgressState;
        if (state.rafId) {
            cancelAnimationFrame(state.rafId);
            state.rafId = null;
        }
        if (state.stuckTimeout) {
            clearTimeout(state.stuckTimeout);
            state.stuckTimeout = null;
        }
        state.current = 0;
        state.target = 0;
        state.isStuck = false;
        state.lastUpdate = Date.now();
        
        const progressElement = document.getElementById('loading-progress');
        if (progressElement) {
            progressElement.style.width = '0%';
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–∏
    window.forceProgressAdvance = function() {
        const state = window._loadingProgressState;
        if (state.current < 95) {
            state.target = Math.min(95, state.current + 5);
            state.isStuck = false;
            state.lastUpdate = Date.now();
            
            if (!state.rafId) {
                const step = () => {
                    const delta = state.target - state.current;
                    state.current += delta * 0.2;
                    if (Math.abs(delta) < 0.1) state.current = state.target;
                    
                    const progressElement = document.getElementById('loading-progress');
                    if (progressElement) {
                        progressElement.style.width = state.current.toFixed(2) + '%';
                    }
                    
                    if (state.current < state.target) {
                        state.rafId = requestAnimationFrame(step);
                    } else {
                        cancelAnimationFrame(state.rafId);
                        state.rafId = null;
                    }
                };
                state.rafId = requestAnimationFrame(step);
            }
        }
    };
})();

// –ü–ª–∞–Ω —ç—Ç–∞–ø–æ–≤ –∑–∞–≥—Ä—É–∑–∫–∏ CSV —Å –≤–µ—Å–∞–º–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
function initCsvProgressPlan() {
    try {
        const dynamicParts = (typeof window !== 'undefined' && window.DYNAMIC_PARTS_COUNT) ? window.DYNAMIC_PARTS_COUNT : 7;
        const plan = [
            { type: 'single', match: 'part_categories.csv', weight: 3 },
            { type: 'single', match: 'themes.csv', weight: 3 },
            { type: 'single', match: 'colors.csv', weight: 3 },
            { type: 'single', match: 'parts.csv', weight: 10 },
            { type: 'single', match: 'sets.csv', weight: 8 },
            { type: 'single', match: 'minifigs.csv', weight: 6 },
            { type: 'single', match: 'elements.csv', weight: 8 },
            { type: 'group', prefix: 'inventory_parts_part_', count: dynamicParts, weight: 40 },
            { type: 'single', match: 'inventory_sets.csv', weight: 9 },
            { type: 'single', match: 'inventory_minifigs.csv', weight: 10 }
        ];
        const totalWeight = plan.reduce((sum, p) => sum + p.weight, 0) || 100;
        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∫ 100
        plan.forEach(p => p.norm = (p.weight / totalWeight) * 100);
        window.CSV_PROGRESS_PLAN = plan;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—â–∏–π –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä (–ø—Ä–∏–º–µ—Ä–Ω–æ 50-100 MB –¥–ª—è –≤—Å–µ—Ö CSV —Ñ–∞–π–ª–æ–≤)
        if (!window.CSV_MB_PROGRESS.totalExpected) {
            window.CSV_MB_PROGRESS.totalExpected = 80000000; // 80 MB –ø—Ä–∏–º–µ—Ä–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤—Å–µ—Ö CSV —Ñ–∞–π–ª–æ–≤
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–±—â–µ–≥–æ –æ–∂–∏–¥–∞–µ–º–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        window.updateTotalExpectedSize = function(contentLength) {
            if (contentLength && contentLength > 0) {
                window.CSV_MB_PROGRESS.totalExpected = Math.max(window.CSV_MB_PROGRESS.totalExpected, contentLength);
            }
        };
        if (!window.CSV_PROGRESS_STATE) window.CSV_PROGRESS_STATE = { completed: new Set() };
    } catch {}
}

function matchPlanEntry(label) {
    if (!window.CSV_PROGRESS_PLAN) initCsvProgressPlan();
    for (const entry of window.CSV_PROGRESS_PLAN) {
        if (entry.type === 'single' && label === entry.match) return entry;
        if (entry.type === 'group' && label.startsWith(entry.prefix)) return entry;
    }
    return null;
}

function calcPlannedProgress(label, fileFraction) {
    if (!window.CSV_PROGRESS_PLAN) initCsvProgressPlan();
    if (!window.CSV_PROGRESS_STATE) window.CSV_PROGRESS_STATE = { completed: new Set() };
    
    // –°—É–º–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–µ –≤–µ—Å–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —ç—Ç–∞–ø–æ–≤ –¥–æ —Ç–µ–∫—É—â–µ–≥–æ
    let progress = 0;
    let foundCurrent = false;
    
    for (const entry of window.CSV_PROGRESS_PLAN) {
        const isCurrent = (entry.type === 'single' && label === entry.match) || (entry.type === 'group' && label.startsWith(entry.prefix));
        
        if (isCurrent) {
            foundCurrent = true;
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ª—é —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞
            if (entry.type === 'single') {
                let frac;
                if (fileFraction != null) {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Ñ–∞–π–ª–∞
                    frac = Math.max(0, Math.min(1, fileFraction));
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–º–µ—Ä–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é
                    const timeElapsed = Date.now() - (window._fileStartTime || Date.now());
                    frac = Math.min(0.8, timeElapsed / 10000); // –ú–∞–∫—Å–∏–º—É–º 80% –∑–∞ 10 —Å–µ–∫—É–Ω–¥
                }
                progress += entry.norm * frac;
            } else {
                // –ì—Ä—É–ø–ø–∞ —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω—ã–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º
                const completedInGroup = Array.from(window.CSV_PROGRESS_STATE.completed || []).filter(l => l.startsWith(entry.prefix)).length;
                let frac;
                if (fileFraction != null) {
                    frac = Math.max(0, Math.min(1, fileFraction));
                } else {
                    // –î–ª—è –≥—Ä—É–ø–ø—ã —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—É—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é
                    const timeElapsed = Date.now() - (window._fileStartTime || Date.now());
                    // –î–ª—è —Ñ–∞–π–ª–æ–≤-—á–∞—Å—Ç–µ–π –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—É—é –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—é
                    if (label.includes('inventory_parts_part_')) {
                        frac = Math.min(0.8, timeElapsed / 8000); // –ú–∞–∫—Å–∏–º—É–º 80% –∑–∞ 8 —Å–µ–∫—É–Ω–¥
                    } else {
                        frac = Math.min(0.6, timeElapsed / 15000); // –ú–∞–∫—Å–∏–º—É–º 60% –∑–∞ 15 —Å–µ–∫—É–Ω–¥
                    }
                }
                const perFile = entry.norm / (entry.count || 1);
                progress += perFile * (completedInGroup + frac);
            }
            break;
        } else {
            // –ï—Å–ª–∏ —ç—Ç–∞–ø –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî —É—á–∏—Ç—ã–≤–∞–µ–º –µ–≥–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é
            if (entry.type === 'single') {
                if (window.CSV_PROGRESS_STATE.completed && window.CSV_PROGRESS_STATE.completed.has(entry.match)) {
                    progress += entry.norm;
                }
            } else {
                const completedInGroup = Array.from(window.CSV_PROGRESS_STATE.completed || []).filter(l => l.startsWith(entry.prefix)).length;
                const total = entry.count || 1;
                const perFile = entry.norm / total;
                progress += perFile * Math.max(0, Math.min(total, completedInGroup));
            }
        }
    }
    
    // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–ª–∞–Ω–µ, –¥–æ–±–∞–≤–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
    if (!foundCurrent) {
        const baseProgress = Math.min(5, (Date.now() - (window._fileStartTime || Date.now())) / 1000);
        progress += baseProgress;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é —Å–ª—É—á–∞–π–Ω—É—é –≤–∞—Ä–∏–∞—Ü–∏—é –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    let timeVariation = Math.sin(Date.now() / 2000) * 0.5;
    
    // –î–ª—è —Ñ–∞–π–ª–æ–≤-—á–∞—Å—Ç–µ–π –¥–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∞–Ω–∏–º–∞—Ü–∏—é
    if (label.includes('inventory_parts_part_')) {
        timeVariation += Math.sin(Date.now() / 1000) * 0.3;
        timeVariation += Math.sin(Date.now() / 500) * 0.2;
    }
    
    progress += timeVariation;
    
    // –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 100 –¥–æ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —à–∞–≥–∞ —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    return Math.min(99, Math.max(0, Math.floor(progress)));
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
function updateLoadingStatus(status, progress = null, details = null) {
    const statusElement = document.getElementById('loading-status');
    const progressElement = document.getElementById('loading-progress');
    const detailsElement = document.getElementById('loading-details');
    const loadingTipElement = document.getElementById('loading-tip');
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestAnimationFrame –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
    requestAnimationFrame(() => {
        if (statusElement && statusElement.textContent !== status) {
            statusElement.textContent = status;
        }
        
        if (progressElement && progress !== null) {
            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø–ª–∞–≤–Ω—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É —Ü–µ–ª–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            if (window.setLoadingProgressTarget) {
                window.setLoadingProgressTarget(progress);
            } else {
                progressElement.style.width = `${progress}%`;
            }
        }
        
        // if (detailsElement && details !== null && detailsElement.textContent !== details) {
        //     detailsElement.textContent = details;
        // }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        if (loadingTipElement && !loadingTipElement.textContent && window.getRandomLoadingTip && window.animateTipChange) {
            const firstTip = window.getRandomLoadingTip();
            // –î–ª—è –ø–µ—Ä–≤–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
            loadingTipElement.textContent = firstTip;
            loadingTipElement.classList.add('fade-in', 'show');
            setTimeout(() => {
                loadingTipElement.classList.remove('fade-in', 'show');
            }, 600);
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É –≤ –∏—Å—Ç–æ—Ä–∏—é
            if (window.addTipToHistory) {
                window.addTipToHistory(firstTip, 'loading');
            }
        }
    });
}
function hideLoadingIndicator() {
    const loadingContainer = document.getElementById('loading-container');
    if (loadingContainer) {
        try {
            // –î–æ–∂–∏–º–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–æ 100% –ø–µ—Ä–µ–¥ —Å–∫—Ä—ã—Ç–∏–µ–º
            if (window.setLoadingProgressTarget) window.setLoadingProgressTarget(100);
        } catch {}
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏
        if (window.stopLoadingTipRotation) {
            window.stopLoadingTipRotation();
        }
        
        loadingContainer.classList.add('hidden');
        // –£–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        setTimeout(() => {
            if (loadingContainer.parentNode) {
                loadingContainer.parentNode.removeChild(loadingContainer);
            }
            // –ü–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ä–µ–Ω–¥–µ—Ä–∏–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç,
            // —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏
            try { updateUI(); } catch (e) { console.error('Failed to update UI after loading hide:', e); }
        }, 500);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
function updateSettingsModalStatus(status, statusType = 'info') {
    if (!S.settingsOpen || !S.settingsModal) return;
    
    S.settingsModal.status = status;
    S.settingsModal.statusType = statusType;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç —Å—Ç–∞—Ç—É—Å–∞ –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∏
    const statusElement = document.getElementById('import-export-status');
    
    if (statusElement) {
        const statusClass = statusType === 'error' ? 'bg-red-900/50 text-red-300' : 
                           statusType === 'success' ? 'bg-green-900/50 text-green-300' : 
                           'bg-blue-900/50 text-blue-300';
        
        statusElement.className = `px-2 py-1 text-xs rounded-[18px] ${statusClass} text-center flex-shrink-0 cursor-pointer`;
        statusElement.textContent = status;
        statusElement.style.display = 'block';
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è
        statusElement.onclick = () => clearSettingsModalStatus();
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–∫—Ä—ã—Ç–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
        const timeout = statusType === 'error' ? 5000 : statusType === 'success' ? 3000 : 4000;
        setTimeout(() => {
            if (S.settingsOpen && S.settingsModal.status === status) {
                clearSettingsModalStatus();
            }
        }, timeout);
    } else {
        renderSettingsModal();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
function clearSettingsModalStatus() {
    if (!S.settingsOpen || !S.settingsModal) return;
    
    S.settingsModal.status = "";
    S.settingsModal.statusType = "info";
    
    const statusElement = document.getElementById('import-export-status');
    if (statusElement) {
        statusElement.style.display = 'none';
        statusElement.textContent = '';
        statusElement.className = 'px-2 py-1 text-xs rounded-[18px] bg-transparent text-transparent text-center flex-shrink-0';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã
function updateCameraSettingsStatus() {
    const statusElement = document.getElementById('camera-settings-status');
    if (!statusElement) return;
    
    const hasSettings = hasCameraSettings();
    if (hasSettings) {
        statusElement.textContent = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
        statusElement.className = 'text-xs text-green-400 text-center';
    } else {
        statusElement.textContent = '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã';
        statusElement.className = 'text-xs text-gray-400 text-center';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö CSV –≤–º–µ—Å—Ç–æ API
function searchInCSVData(query, type = 'parts') {
    if (!query || query.trim().length < 2) return [];
    
    const searchTerm = query.toLowerCase().trim();
    const results = [];
    
    console.log('searchInCSVData called with:', { query, type, searchTerm });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
    if (type === 'parts' && Object.keys(PART_MAP).length === 0) {
        console.warn('PART_MAP is empty, cannot search parts');
        return [];
    }
    if (type === 'sets' && Object.keys(SET_MAP).length === 0) {
        console.warn('SET_MAP is empty, cannot search sets');
        return [];
    }
    if (type === 'minifigs' && Object.keys(MINIFIG_MAP).length === 0) {
        console.warn('MINIFIG_MAP is empty, cannot search minifigs');
        return [];
    }
    
    switch (type) {
        case 'parts':
            // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –æ–±—ã—á–Ω—ã–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º
            Object.values(PART_MAP).forEach(part => {
                if (part.name && part.name.toLowerCase().includes(searchTerm) ||
                    part.id && part.id.toLowerCase().includes(searchTerm)) {
                    results.push({
                        ...part,
                        type: 'part',
                        searchScore: calculateSearchScore(part, searchTerm)
                    });
                }
            });
            
            // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç, –ø—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏ ID
            if (results.length === 0) {
                console.log(`–û–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –ø—Ä–æ–±—É–µ–º –ø–æ–∏—Å–∫ –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏: ${searchTerm}`);
                
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —á–∏—Å–ª–æ–≤—É—é —á–∞—Å—Ç—å –∏–∑ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                const numericPart = searchTerm.match(/^\d+/);
                if (numericPart) {
                    const numericId = numericPart[0];
                    console.log(`–ò—â–µ–º –¥–µ—Ç–∞–ª–∏, –Ω–∞—á–∏–Ω–∞—é—â–∏–µ—Å—è —Å —Ü–∏—Ñ—Ä: ${numericId}`);
                    
                    Object.values(PART_MAP).forEach(part => {
                        if (part.id && part.id.toLowerCase().startsWith(numericId)) {
                            results.push({
                                ...part,
                                type: 'part',
                                searchScore: calculateSearchScore(part, numericId) + 10 // –ë–æ–Ω—É—Å –∑–∞ —á–∏—Å–ª–æ–≤–æ–π –ø–æ–∏—Å–∫
                            });
                        }
                    });
                    
                    console.log(`–ù–∞–π–¥–µ–Ω–æ ${results.length} –¥–µ—Ç–∞–ª–µ–π –ø–æ —á–∏—Å–ª–æ–≤–æ–π —á–∞—Å—Ç–∏ ${numericId}`);
                }
            }
            break;
            
        case 'sets':
            Object.values(SET_MAP).forEach(set => {
                if (set.name && set.name.toLowerCase().includes(searchTerm) ||
                    set.set_num && set.set_num.toLowerCase().includes(searchTerm)) {
                    results.push({
                        ...set,
                        type: 'set',
                        searchScore: calculateSearchScore(set, searchTerm)
                    });
                }
            });
            break;
            
        case 'minifigs':
            Object.values(MINIFIG_MAP).forEach(minifig => {
                if (minifig.name && minifig.name.toLowerCase().includes(searchTerm) ||
                    minifig.set_num && minifig.set_num.toLowerCase().includes(searchTerm)) {
                    results.push({
                        ...minifig,
                        type: 'minifig',
                        searchScore: calculateSearchScore(minifig, searchTerm)
                    });
                }
            });
            break;
            
        default:
            // –ò—â–µ–º –≤–æ –≤—Å–µ—Ö —Ç–∏–ø–∞—Ö
            searchInCSVData(query, 'parts').forEach(r => results.push(r));
            searchInCSVData(query, 'sets').forEach(r => results.push(r));
            searchInCSVData(query, 'minifigs').forEach(r => results.push(r));
            break;
    }
    
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    return results
        .sort((a, b) => b.searchScore - a.searchScore)
        .slice(0, 50);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞
function calculateSearchScore(item, searchTerm) {
    let score = 0;
    
    // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç –Ω–∞–∏–≤—ã—Å—à–∏–π –±–∞–ª–ª
    if (item.name && item.name.toLowerCase() === searchTerm) score += 100;
    if (item.id && item.id.toLowerCase() === searchTerm) score += 100;
    if (item.set_num && item.set_num.toLowerCase() === searchTerm) score += 100;
    
    // –ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    if (item.name && item.name.toLowerCase().startsWith(searchTerm)) score += 50;
    if (item.id && item.id.toLowerCase().startsWith(searchTerm)) score += 50;
    if (item.set_num && item.set_num.toLowerCase().startsWith(searchTerm)) score += 50;
    
    // –°–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
    if (item.name && item.name.toLowerCase().includes(searchTerm)) score += 25;
    if (item.id && item.id.toLowerCase().includes(searchTerm)) score += 25;
    if (item.set_num && item.set_num.toLowerCase().includes(searchTerm)) score += 25;
    
    // –ë–æ–Ω—É—Å –∑–∞ –∫–æ—Ä–æ—Ç–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–±–æ–ª–µ–µ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ)
    if (item.name && item.name.length < 20) score += 5;
    
    // –ë–æ–Ω—É—Å –∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –Ω–∞–±–æ—Ä–æ–≤)
    if (item.num_sets && item.num_sets > 0) {
        score += Math.min(item.num_sets / 10, 10); // –ú–∞–∫—Å–∏–º—É–º 10 –±–∞–ª–ª–æ–≤ –∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å
    }
    
    // –ü—Ä–∏–∑–Ω–∞–∫ –Ω–µ–¥–∞–≤–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ—Ç–∫–ª—é—á—ë–Ω
    
    return score;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
function generateAutocompleteSuggestions(query, maxSuggestions = 8) {
    if (!query || query.trim().length < 1) return [];
    
    const searchTerm = query.toLowerCase().trim();
    const suggestions = [];
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –≤ –∫–∞–∫–æ–º —Ä–µ–∂–∏–º–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è
    const isCollectionMode = S.view === 'collection';
    const currentSubView = S.subView;
    
    // –î–ª—è –ø–æ–∏—Å–∫–∞ –∏ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –∏—â–µ–º –ø–æ –≤—Å–µ–º —Ç–∏–ø–∞–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    // –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–∂–∏–º–∞ (–ö–∞—Ç–∞–ª–æ–≥/–ö–æ–ª–ª–µ–∫—Ü–∏—è)
    
    // –ü–æ–∏—Å–∫ –≤ –¥–µ—Ç–∞–ª—è—Ö (–≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ –¥–µ—Ç–∞–ª–∏ –µ—Å—Ç—å –≤–µ–∑–¥–µ)
    Object.values(PART_MAP).forEach(part => {
        if ((part.name && part.name.toLowerCase().includes(searchTerm)) || 
            (part.id && part.id.toLowerCase().includes(searchTerm))) {
            // –î–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∂–∏–º–∞
            suggestions.push({
                text: part.name,
                type: 'part',
                id: part.id,
                score: calculateSearchScore(part, searchTerm)
            });
        }
    });
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω—ã–º —Å–ª–æ–≤–∞–º –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
    if (searchTerm.length > 2) {
        const words = searchTerm.split(' ').filter(word => word.length > 1);
        if (words.length > 0) {
            Object.values(PART_MAP).forEach(part => {
                if (part.name && words.some(word => part.name.toLowerCase().includes(word))) {
                    // –î–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –¥–µ—Ç–∞–ª–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∂–∏–º–∞
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω
                    if (!suggestions.some(s => s.id === part.id && s.type === 'part')) {
                        suggestions.push({
                            text: part.name,
                            type: 'part',
                            id: part.id,
                            score: calculateSearchScore(part, searchTerm) * 0.7 // –°–Ω–∏–∂–∞–µ–º —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è —á–∞—Å—Ç–∏—á–Ω—ã—Ö —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
                        });
                    }
                }
            });
        }
    }
    
    // –ü–æ–∏—Å–∫ –≤ –Ω–∞–±–æ—Ä–∞—Ö (–≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º)
    Object.values(SET_MAP).forEach(set => {
        if ((set.name && set.name.toLowerCase().includes(searchTerm)) || 
            (set.set_num && set.set_num.toLowerCase().includes(searchTerm))) {
            // –î–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –Ω–∞–±–æ—Ä—ã, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∂–∏–º–∞
            suggestions.push({
                text: set.name,
                type: 'set',
                id: set.set_num,
                score: calculateSearchScore(set, searchTerm)
            });
        }
    });
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω—ã–º —Å–ª–æ–≤–∞–º –¥–ª—è –Ω–∞–±–æ—Ä–æ–≤
    if (searchTerm.length > 2) {
        const words = searchTerm.split(' ').filter(word => word.length > 1);
        if (words.length > 0) {
            Object.values(SET_MAP).forEach(set => {
                if (set.name && words.some(word => set.name.toLowerCase().includes(word))) {
                    // –î–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –Ω–∞–±–æ—Ä—ã, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∂–∏–º–∞
                    
                    if (!suggestions.some(s => s.id === set.set_num && s.type === 'set')) {
                        suggestions.push({
                            text: set.name,
                            type: 'set',
                            id: set.set_num,
                            score: calculateSearchScore(set, searchTerm) * 0.7
                        });
                    }
                }
            });
        }
    }
    
    // –ü–æ–∏—Å–∫ –≤ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞—Ö (–≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º)
    Object.values(MINIFIG_MAP).forEach(minifig => {
        if ((minifig.name && minifig.name.toLowerCase().includes(searchTerm)) || 
            (minifig.set_num && minifig.set_num.toLowerCase().includes(searchTerm))) {
            // –î–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∂–∏–º–∞
            suggestions.push({
                text: minifig.name,
                type: 'minifig',
                id: minifig.set_num,
                score: calculateSearchScore(minifig, searchTerm)
            });
        }
    });
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –ø–æ —á–∞—Å—Ç–∏—á–Ω—ã–º —Å–ª–æ–≤–∞–º –¥–ª—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫
    if (searchTerm.length > 2) {
        const words = searchTerm.split(' ').filter(word => word.length > 1);
        if (words.length > 0) {
            Object.values(MINIFIG_MAP).forEach(minifig => {
                if (minifig.name && words.some(word => minifig.name.toLowerCase().includes(word))) {
                    // –î–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–µ–∂–∏–º–∞
                    
                    if (!suggestions.some(s => s.id === minifig.set_num && s.type === 'minifig')) {
                        suggestions.push({
                            text: minifig.name,
                            type: 'minifig',
                            id: minifig.set_num,
                            score: calculateSearchScore(minifig, searchTerm) * 0.7
                        });
                    }
                }
            });
        }
    }
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
    return suggestions
        .sort((a, b) => b.score - a.score)
        .slice(0, maxSuggestions);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–æ–≤–ø–∞–¥–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞
function highlightText(text, searchTerm) {
    if (!searchTerm) return text;
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ –¥–ª–∏–Ω–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π
function truncateText(text, maxLength = 50) {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
function showAutocompleteSuggestions(suggestions, searchTerm) {
    const dropdown = document.getElementById('autocomplete-dropdown');
    if (!dropdown) return;
    
    if (suggestions.length === 0) {
        dropdown.classList.add('hidden');
        return;
    }
    
    const items = suggestions.map((suggestion, index) => {
        const truncatedText = truncateText(suggestion.text, 50);
        const highlightedText = highlightText(truncatedText, searchTerm);
        const typeIcons = {
            'part': I_Brick("w-5 h-5"),
            'set': I_Set("w-5 h-5"),
            'minifig': I_Minifig("w-5 h-5")
        };
        
        return `
            <div class="autocomplete-item" data-index="${index}" data-type="${suggestion.type}" data-id="${suggestion.id}">
                <div class="autocomplete-item-icon ${suggestion.type}">${typeIcons[suggestion.type]}</div>
                <div class="autocomplete-item-content">
                    <div class="autocomplete-item-text">${highlightedText}</div>
                    <div class="autocomplete-item-id">${suggestion.id}</div>
                </div>
            </div>
        `;
    }).join('');
    
    dropdown.innerHTML = items;
    dropdown.style.display = 'block';
    
    // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    setupAutocompleteClickHandlers();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
function hideAutocomplete() {
    const dropdown = document.getElementById('autocomplete-dropdown');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ª—é–±–æ–≥–æ —Ç–∏–ø–∞ —ç–ª–µ–º–µ–Ω—Ç–∞
function openElementModal(type, id) {
    console.log(`openElementModal: Opening ${type} with id ${id}`);
    
    switch (type) {
        case 'part':
            const part = PART_MAP[id];
            if (part) {
                const groupId = getGroupId(part.part_num || id);
                openModalForPart(part.id || part.part_num || id, groupId, [part]);
            } else {
                console.warn(`Part with id ${id} not found in PART_MAP`);
            }
            break;
            
        case 'set':
            if (SET_MAP[id]) {
                openModalForSet(id);
            } else {
                console.warn(`Set with id ${id} not found in SET_MAP`);
            }
            break;
            
        case 'minifig':
            if (MINIFIG_MAP[id]) {
                openModalForMinifig(id);
            } else {
                console.warn(`Minifig with id ${id} not found in MINIFIG_MAP`);
            }
            break;
            
        default:
            console.warn(`Unknown element type: ${type}`);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
function searchAndOpenElement(searchTerm) {
    if (!searchTerm || searchTerm.trim().length < 1) return false;
    
    const term = searchTerm.toLowerCase().trim();
    
    // –ü–æ–∏—Å–∫ –ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é ID –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ—Ç–∞–ª–∏
    for (const [id, part] of Object.entries(PART_MAP)) {
        if (part && (
            (part.id && part.id.toLowerCase() === term) ||
            (part.part_num && part.part_num.toLowerCase() === term) ||
            (part.name && part.name.toLowerCase() === term)
        )) {
            openElementModal('part', id);
            return true;
        }
    }
    
    // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–±–æ—Ä—ã
    for (const [id, set] of Object.entries(SET_MAP)) {
        if (set && (
            (set.set_num && set.set_num.toLowerCase() === term) ||
            (set.name && set.name.toLowerCase() === term)
        )) {
            openElementModal('set', id);
            return true;
        }
    }
    
    // –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    for (const [id, minifig] of Object.entries(MINIFIG_MAP)) {
        if (minifig && (
            (minifig.set_num && minifig.set_num.toLowerCase() === term) ||
            (minifig.name && minifig.name.toLowerCase() === term)
        )) {
            openElementModal('minifig', id);
            return true;
        }
    }
    
    return false;
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function searchCollectionElements(searchTerm) {
    if (!searchTerm || searchTerm.trim().length < 1) return { parts: [], sets: [], minifigs: [] };
    
    const term = searchTerm.toLowerCase().trim();
    const results = { parts: [], sets: [], minifigs: [] };
    
    // –ü–æ–∏—Å–∫ –≤ –¥–µ—Ç–∞–ª—è—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    Object.entries(S.coll).forEach(([partId, qty]) => {
        const part = PART_MAP[partId];
        if (part && qty > 0 && (
            (part.name && part.name.toLowerCase().includes(term)) ||
            (part.id && part.id.toLowerCase().includes(term)) ||
            (part.part_num && part.part_num.toLowerCase().includes(term))
        )) {
            results.parts.push(part);
        }
    });
    
    // –ü–æ–∏—Å–∫ –≤ –Ω–∞–±–æ—Ä–∞—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    Object.entries(S.setColl).forEach(([setId, qty]) => {
        const set = SET_MAP[setId];
        if (set && qty > 0 && (
            (set.name && set.name.toLowerCase().includes(term)) ||
            (set.set_num && set.set_num.toLowerCase().includes(term))
        )) {
            results.sets.push(set);
        }
    });
    
    // –ü–æ–∏—Å–∫ –≤ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞—Ö –∫–æ–ª–ª–µ–∫—Ü–∏–∏
    Object.entries(S.minifigColl).forEach(([minifigId, qty]) => {
        const minifig = MINIFIG_MAP[minifigId];
        if (minifig && qty > 0 && (
            (minifig.name && minifig.name.toLowerCase().includes(term)) ||
            (minifig.set_num && minifig.set_num.toLowerCase().includes(term))
        )) {
            results.minifigs.push(minifig);
        }
    });
    
    // –ï—Å–ª–∏ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
    // –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∫–∞–∫ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
    if (results.parts.length === 0 && results.sets.length === 0 && results.minifigs.length === 0) {
        // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã
        return results;
    }
    
    return results;
}

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–º —Ç–∏–ø–∞–º —ç–ª–µ–º–µ–Ω—Ç–æ–≤ (–¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞)
function searchAllElements(searchTerm) {
    if (!searchTerm || searchTerm.trim().length < 1) return { parts: [], sets: [], minifigs: [] };
    
    const term = searchTerm.toLowerCase().trim();
    const results = { parts: [], sets: [], minifigs: [] };
    
    // –ü–æ–∏—Å–∫ –≤ –¥–µ—Ç–∞–ª—è—Ö
    Object.values(PART_MAP).forEach(part => {
        if (part && (
            (part.name && part.name.toLowerCase().includes(term)) ||
            (part.id && part.id.toLowerCase().includes(term)) ||
            (part.part_num && part.part_num.toLowerCase().includes(term))
        )) {
            results.parts.push(part);
        }
    });
    
    // –ü–æ–∏—Å–∫ –≤ –Ω–∞–±–æ—Ä–∞—Ö
    Object.values(SET_MAP).forEach(set => {
        if (set && (
            (set.name && set.name.toLowerCase().includes(term)) ||
            (set.set_num && set.set_num.toLowerCase().includes(term))
        )) {
            results.sets.push(set);
        }
    });
    
    // –ü–æ–∏—Å–∫ –≤ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∞—Ö
    Object.values(MINIFIG_MAP).forEach(minifig => {
        if (minifig && (
            (minifig.name && minifig.name.toLowerCase().includes(term)) ||
            (minifig.set_num && minifig.set_num.toLowerCase().includes(term))
        )) {
            results.minifigs.push(minifig);
        }
    });
    
    return results;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
function renderUniversalSearchResults(searchResults, searchTerm) {
    const { parts, sets, minifigs } = searchResults;
    const totalResults = parts.length + sets.length + minifigs.length;
    
    if (totalResults === 0) {
        return `
            <div class="text-center py-8">
                <div class="text-gray-400 text-lg mb-2">üîç</div>
                <div class="text-gray-300 text-lg font-medium">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                <div class="text-gray-500 text-sm mt-1">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å</div>
            </div>
        `;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–∏—Å–∫–∞
    const searchContext = (S.originalSearchContext || S.view) === "collection" ? "–∫–æ–ª–ª–µ–∫—Ü–∏–∏" : "–∫–∞—Ç–∞–ª–æ–≥–µ";
    
    let html = `
        <div class="space-y-6 px-2 sm:px-4">
            <div class="mb-6">
            </div>
    `;
    
    // –î–µ—Ç–∞–ª–∏
    html += `
        <div class="bg-gray-700/20 rounded-[18px] p-4 mx-2 sm:mx-4">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                ${I_Brick('text-green-500 w-5 h-5')}
                –î–µ—Ç–∞–ª–∏ (${parts.length})
            </h3>
            ${parts.length > 0 ? `
                <div class="grid grid-cols-2 sm:grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4 p-4">
                    ${parts.slice(0, 24).map((part, index) => {
                        const groupId = getGroupId(part.id);
                        return renderPartCard(part, null, 0, false, index);
                    }).join('')}
                </div>
                ${parts.length > 24 ? `<div class="text-center mt-3"><span class="text-gray-400 text-sm">–ò –µ—â–µ ${parts.length - 24} –¥–µ—Ç–∞–ª–µ–π...</span></div>` : ''}
            ` : `
                <div class="text-center py-8">
                    <div class="text-gray-400 text-sm">–í ${searchContext} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–µ—Ç–∞–ª–µ–π –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}"</div>
                </div>
            `}
        </div>
    `;
    
    // –ù–∞–±–æ—Ä—ã
    html += `
        <div class="bg-gray-700/20 rounded-[18px] p-4 mx-2 sm:mx-4">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                ${I_Set('text-blue-500 w-5 h-5')}
                –ù–∞–±–æ—Ä—ã (${sets.length})
            </h3>
            ${sets.length > 0 ? `
                <div class="grid grid-cols-2 sm:grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4 p-4">
                    ${sets.slice(0, 24).map((set, index) => {
                        // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
                        const originalView = S.view;
                        S.view = "catalog";
                        const result = renderSetCard(set, false, index);
                        S.view = originalView;
                        return result;
                    }).join('')}
                </div>
                ${sets.length > 24 ? `<div class="text-center mt-3"><span class="text-gray-400 text-sm">–ò –µ—â–µ ${sets.length - 24} –Ω–∞–±–æ—Ä–æ–≤...</span></div>` : ''}
            ` : `
                <div class="text-center py-8">
                    <div class="text-gray-400 text-sm">–í ${searchContext} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞–±–æ—Ä–æ–≤ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}"</div>
                </div>
            `}
        </div>
    `;
    
    // –ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
    html += `
        <div class="bg-gray-700/20 rounded-[18px] p-4 mx-2 sm:mx-4">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                ${I_Minifig('text-purple-500 w-5 h-5')}
                –ú–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ (${minifigs.length})
            </h3>
            ${minifigs.length > 0 ? `
                <div class="grid grid-cols-2 sm:grid-cols-[repeat(auto-fill,minmax(150px,1fr))] gap-4 p-4">
                    ${minifigs.slice(0, 24).map((minifig, index) => {
                        // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
                        const originalView = S.view;
                        S.view = "catalog";
                        const result = renderMinifigCard(minifig, false, index);
                        S.view = originalView;
                        return result;
                    }).join('')}
                </div>
                ${minifigs.length > 24 ? `<div class="text-center mt-3"><span class="text-gray-400 text-sm">–ò –µ—â–µ ${minifigs.length - 24} –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫...</span></div>` : ''}
            ` : `
                <div class="text-center py-8">
                    <div class="text-gray-400 text-sm">–í ${searchContext} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}"</div>
                </div>
            `}
        </div>
    `;
    
    html += `</div>`;
    return html;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
function selectAutocompleteSuggestion(suggestion) {
    const searchInput = document.getElementById('search-input');
    if (searchInput && suggestion) {
        searchInput.value = suggestion.text;
        S.q = suggestion.text;
        hideAutocomplete();
        
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–ø—Ä—è–º—É—é, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ
        if (suggestion.type && suggestion.id) {
            openElementModal(suggestion.type, suggestion.id);
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä—è–º–æ–≥–æ ID, –≤—ã–ø–æ–ª–Ω—è–µ–º –æ–±—ã—á–Ω—ã–π –ø–æ–∏—Å–∫
            triggerSearch();
        }
    }
}

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–∏
let selectedAutocompleteIndex = -1;

// –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥–∞ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
let autocompleteTimeout = null;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –≤ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–∏
function updateAutocompleteSelection(items) {
    items.forEach((item, index) => {
        if (index === selectedAutocompleteIndex) {
            item.classList.add('selected');
        } else {
            item.classList.remove('selected');
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–ª–∏–∫–∞ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
function setupAutocompleteClickHandlers() {
    const dropdown = document.getElementById('autocomplete-dropdown');
    if (!dropdown) return;
    
    dropdown.addEventListener('click', (e) => {
        const item = e.target.closest('.autocomplete-item');
        if (item) {
            const suggestion = {
                text: item.querySelector('.autocomplete-item-text').textContent,
                type: item.dataset.type,
                id: item.dataset.id
            };
            selectAutocompleteSuggestion(suggestion);
        }
    });
}

// (Removed) Background data check/download functions kept for future use
// Function to fetch missing images from CSV data
async function fetchMissingImagesFromCSV() {
    try {
        console.log('Starting fetchMissingImagesFromCSV...');
        console.log(`PART_MAP size: ${Object.keys(PART_MAP).length}`);
        console.log(`SET_MAP size: ${Object.keys(SET_MAP).length}`);
        console.log(`MINIFIG_MAP size: ${Object.keys(MINIFIG_MAP).length}`);
        
        // Debug: Check some existing parts
        const sampleParts = Object.values(PART_MAP).slice(0, 3);
        console.log('Sample parts:', sampleParts.map(p => ({
            id: p.id,
            name: p.name,
            part_img_url: p.part_img_url,
            rebrickable_img_url: p.rebrickable_img_url
        })));
        
        // Since we now generate image URLs from CSV data, this function mainly ensures
        // that all parts, sets, and minifigs have their image URLs properly set
        
        // Check parts without images
        const partsWithoutImages = Object.values(PART_MAP).filter(p => 
            p && !p.part_img_url && !p.rebrickable_img_url
        );
        
        console.log('Parts without images:', partsWithoutImages.slice(0, 5)); // Show first 5 for debugging
        
        if (partsWithoutImages.length > 0) {
            console.log(`Found ${partsWithoutImages.length} parts without images, attempting to generate URLs`);
            
            // Try to generate image URLs for parts that don't have them
            for (const part of partsWithoutImages) {
                if (part.id) {
                    // Generate standard image URL format for parts
                    const imageUrl = `https://cdn.rebrickable.com/media/parts/${part.id}.jpg`;
                    part.part_img_url = imageUrl;
                    part.rebrickable_img_url = imageUrl; // Also set rebrickable_img_url
                    console.log(`Generated image URL for part ${part.id}: ${imageUrl}`);
                } else {
                    console.warn('Part without id:', part);
                }
            }
        } else {
            console.log('All parts already have image URLs');
        }
        
        // Check sets without images
        const setsWithoutImages = Object.values(SET_MAP).filter(s => 
            s && !s.set_img_url
        );
        
        if (setsWithoutImages.length > 0) {
            console.log(`Found ${setsWithoutImages.length} sets without images, attempting to generate URLs`);
            
            // Try to generate image URLs for sets that don't have them
            for (const set of setsWithoutImages) {
                if (set.set_num) {
                    // Generate standard image URL format for sets
                    const imageUrl = `https://cdn.rebrickable.com/media/sets/${set.set_num}.jpg`;
                    set.set_img_url = imageUrl;
                    console.log(`Generated image URL for set ${set.set_num}: ${imageUrl}`);
                }
            }
        } else {
            console.log('All sets already have image URLs');
        }
        
        // Check minifigs without images
        const minifigsWithoutImages = Object.values(MINIFIG_MAP).filter(s => 
            s && !s.minifig_img_url && !s.set_img_url
        );
        
        if (minifigsWithoutImages.length > 0) {
            console.log(`Found ${minifigsWithoutImages.length} minifigs without images, attempting to generate URLs`);
            
            // Try to generate image URLs for minifigs that don't have them
            for (const minifig of minifigsWithoutImages) {
                if (minifig.fig_num) {
                    // Generate standard image URL format for minifigs
                    const imageUrl = `https://cdn.rebrickable.com/media/minifigs/${minifig.fig_num}.jpg`;
                    minifig.minifig_img_url = imageUrl;
                    console.log(`Generated image URL for minifig ${minifig.fig_num}: ${imageUrl}`);
                }
            }
        } else {
            console.log('All minifigs already have image URLs');
        }
        
        console.log('Image URL generation from CSV completed');
        console.log(`Generated URLs for ${partsWithoutImages.length} parts, ${setsWithoutImages.length} sets, ${minifigsWithoutImages.length} minifigs`);
        
        // Debug: Check final state of some parts
        const finalSampleParts = Object.values(PART_MAP).slice(0, 3);
        console.log('Final sample parts:', finalSampleParts.map(p => ({
            id: p.id,
            name: p.name,
            part_img_url: p.part_img_url,
            rebrickable_img_url: p.rebrickable_img_url
        })));
        
    } catch (error) {
        console.error('Error in fetchMissingImagesFromCSV:', error);
    }
}

// Function to check for new data in background
async function checkForNewDataInBackground() {
    try {
        // This function runs in the background to check for any new data
        // that might be available from the API but not in our CSV files
        
        console.log('Background data check started');
        
        // For now, we'll just log that the check is complete
        // In the future, this could check for new releases or updates
        console.log('Background data check completed');
        
        // Return a resolved promise to indicate completion
        return Promise.resolve();
        
    } catch (error) {
        console.error('Error in background data check:', error);
        // Return a resolved promise even on error to prevent blocking
        return Promise.resolve();
    }
}
// Function to check what data is missing and needs API calls
function checkMissingData() {
    const missing = {
        parts: [],
        sets: [],
        minifigs: [],
        colors: [],
        categories: [],
        themes: []
    };
    
    // Since we now generate image URLs from CSV data, we don't need to check for missing images
    // Only check for data that might be truly missing (e.g., new releases not in CSV)
    
    return missing;
}

// Function to load missing data from API
async function loadMissingDataFromAPI() {
    try {
        const missing = checkMissingData();
        
        if (missing.parts.length === 0 && missing.sets.length === 0 && missing.minifigs.length === 0) {
            return;
        }
        
        // Update loading status
                        updateSettingsModalStatus("–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö\n–¥–∞–Ω–Ω—ã—Ö –∏–∑ API", "info");
        
        // Since we now generate all image URLs from CSV, this function is mainly for future use
        // when new data might be available that's not in our CSV files
        
        const stats = getLoadingStats();
        
        // Update loading status
        updateSettingsModalStatus("–í—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã\n–∏–∑ CSV!", "success");
        
        // Save state after API loading
        saveState();
        
    } catch (error) {
        console.error('Failed to load missing data from API:', error);
    }
}

// Function to force refresh minifig data to avoid #undefined
async function refreshMinifigData() {
    try {
        const minifigsToRefresh = Object.keys(S.minifigColl).filter(figNum => !MINIFIG_MAP[figNum]?.name);
        
        if (minifigsToRefresh.length === 0) {
            return;
        }
        
                        updateSettingsModalStatus("–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö\n–º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫", "info");
        await fetchMissingCollectionMinifigDetails();
        
        // Update UI after refresh
        S.gridStale = true;
        updateUI();
        updateSettingsModalStatus("–î–∞–Ω–Ω—ã–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫\n–æ–±–Ω–æ–≤–ª–µ–Ω—ã!", "success");
    } catch (error) {
        console.error('Failed to refresh minifig data:', error);
    }
}
// Function to force refresh image cache for better performance
async function refreshImageCache() {
    try {
        const cache = await caches.open(CACHE_NAME);
        const requests = await cache.keys();
        
        // Find image requests
        const imageRequests = requests.filter(req => 
            req.url.match(/\.(png|jpg|jpeg|gif|webp|svg)$/i) ||
            req.url.includes('cdn.rebrickable.com') ||
            req.url.includes('m.rebrickable.com')
        );
        
        if (imageRequests.length === 0) {
            return;
        }
        
        // Refresh each image by fetching it again
        for (const request of imageRequests) {
            try {
                const response = await fetch(request.url, { 
                    mode: 'no-cors',
                    cache: 'reload'
                });
                if (response) {
                    await cache.put(request, response);
                }
            } catch (error) {
                // Ignore individual image refresh errors
            }
        }
    } catch (error) {
        console.error('Failed to refresh image cache:', error);
    }
}

// Auto-refresh image cache every 30 minutes for better performance
setInterval(refreshImageCache, 30 * 60 * 1000);

// Function to force save all state data including newly fetched details
function forceSaveState() {
    try {
        saveState();
        
        // Also save any additional data that might have been fetched
        const cache = {
            parts: Object.keys(PART_MAP).length,
            colors: Object.keys(COLOR_MAP).length,
            categories: flatCategories.length,
            themes: Object.keys(THEME_MAP).length,
            sets: Object.keys(SET_MAP).length,
            minifigs: Object.keys(MINIFIG_MAP).length
        };
        
        localStorage.setItem('legoDataCacheStats', JSON.stringify(cache));
    } catch (e) {
        console.error('Failed to force save state:', e);
    }
}

// Function to get color-specific image URL with automatic API fallback
function getColorImageUrl(partNum, colorId, fallbackUrl = null) {
    const part = PART_MAP[partNum];
    if (!part || !part.colorImages) {
        // If no color images cached, trigger fetch
        fetchColorDetailsForPart(partNum).catch(console.error);
        return fallbackUrl || `data:image/svg+xml,${encodeURIComponent(I_Img("w-full h-full text-gray-500"))}`;
    }
    
    const colorImageUrl = part.colorImages[colorId];
    if (!colorImageUrl) {
        // If specific color image not found, trigger fetch
        fetchColorDetailsForPart(partNum).catch(console.error);
        return fallbackUrl || `data:image/svg+xml,${encodeURIComponent(I_Img("w-full h-full text-gray-500"))}`;
    }
    
    return `src="${colorImageUrl}" loading="lazy" decoding="async" onerror="this.onerror=null; this.src='${fallbackUrl || `data:image/svg+xml,${encodeURIComponent(I_Img("w-full h-full text-gray-500"))}`}'; handleColorImageLoadError(this, '${partNum}', '${colorId}', '${colorImageUrl}');"`
}
// Function to handle color image load errors and fetch from API
async function handleColorImageLoadError(imgElement, partNum, colorId, originalUrl) {
    try {
        const key = `${partNum}:${colorId}`;
        if (PART_COLOR_FAILED.has(key)) return; // —É–∂–µ –ø—Ä–æ–≤–∞–ª–∏–≤–∞–ª–æ—Å—å ‚Äî –Ω–µ —Å–ø–∞–º–∏–º
        if (PART_COLOR_FETCHING.has(key)) return; // —É–∂–µ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
        if (API_PART_COLOR_FETCH_COUNT >= API_PART_COLOR_FETCH_LIMIT) return; // –æ–±—â–∏–π –ª–∏–º–∏—Ç
        PART_COLOR_FETCHING.add(key);
        API_PART_COLOR_FETCH_COUNT++;

        // Fetch color details from API to get fresh image URL
        const colorDetails = await fetchPartColorDetailsFromAPI(partNum, colorId);
        if (colorDetails && colorDetails.part_img_url) {
            // Update the image source
            imgElement.src = colorDetails.part_img_url;
            
            // Cache the new color image URL
            if (PART_MAP[partNum] && PART_MAP[partNum].colorImages) {
                PART_MAP[partNum].colorImages[colorId] = colorDetails.part_img_url;
                forceSaveState();
            }
            // –°—á–µ—Ç—á–∏–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–∞—Ä—Ç–æ—á–µ–∫, –Ω–µ –≤ –º–æ–¥–∞–ª–∫–µ
            try { markApiStatOnce('parts', partNum); } catch {}
            

            return;
        }
        
        console.warn(`Could not fetch color image for part ${partNum} color ${colorId}`);
        PART_COLOR_FAILED.add(key);
    } catch (error) {
        console.error('Error handling color image load error:', error);
        const key = `${partNum}:${colorId}`;
        PART_COLOR_FAILED.add(key);
    } finally {
        const key = `${partNum}:${colorId}`;
        PART_COLOR_FETCHING.delete(key);
    }
}
// Helper function to fetch part color details from API
async function fetchPartColorDetailsFromAPI(partNum, colorId) {
    try {
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥
        const now = Date.now();
        const since = now - lastApiRequestTime;
        if (since < API_REQUEST_DELAY) {
            await new Promise(r => setTimeout(r, API_REQUEST_DELAY - since));
        }
        lastApiRequestTime = Date.now();
        const response = await fetchWithProxy(`${REBRICKABLE_API_URL}/parts/${partNum}/colors/${colorId}/`, {
            headers: {
                Authorization: `key ${getApiKey()}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            return data;
        }
    } catch (error) {
        console.error(`Failed to fetch color details for part ${partNum} color ${colorId}:`, error);
    }
    return null;
}
// Function to check for missing images in collection
async function fetchMissingImagesForCollection() {
    try {
        // Check for missing minifig images
        const minifigsWithoutImages = Object.values(MINIFIG_MAP).filter(m => 
            m && !m.minifig_img_url && !m.set_img_url
        );
        
        if (minifigsWithoutImages.length > 0) {
            await fetchMissingMinifigImages();
        }
        
        // Check for missing part images
        const partsWithoutImages = Object.values(PART_MAP).filter(p => 
            p && !p.part_img_url && !p.rebrickable_img_url
        );
        
        if (partsWithoutImages.length > 0) {
            // This will be handled by the existing functions
        }
        
        // Check for missing set images
        const setsWithoutImages = Object.values(SET_MAP).filter(s => 
            s && !s.set_img_url
        );
        
        if (setsWithoutImages.length > 0) {
            // This will be handled by the existing functions
        }
        
    } catch (error) {
        console.error('Error checking missing images:', error);
    }
}

// Function to check images for currently viewed items
async function fetchImagesForViewedItems() {
    try {
        // Check minifig modal
        if (S.selFigNum && MINIFIG_MAP[S.selFigNum]) {
            const minifig = MINIFIG_MAP[S.selFigNum];
            if (!minifig.minifig_img_url && !minifig.set_img_url) {
                await fetchMinifigDetails(S.selFigNum);
            }
        }
        
        // Check part modal
        if (S.selPartId && PART_MAP[S.selPartId]) {
            const part = PART_MAP[S.selPartId];
            if (!part.part_img_url && !part.rebrickable_img_url) {
                // This will be handled by the part modal itself
            }
        }
        
        // Check set modal
        if (S.selSetNum && SET_MAP[S.selSetNum]) {
            const set = SET_MAP[S.selSetNum];
            if (!set.set_img_url) {
                // This will be handled by the set modal itself
            }
        }
        
    } catch (error) {
        console.error('Error checking viewed item images:', error);
    }
}
        


async function fetchMinifigDetailsWithRetry(figNum, retries = 3, delay = 1000) {
    for (let attempt = 0; attempt < retries; attempt++) {
        try {
            await fetchMinifigDetails(figNum);
            return;
        } catch (err) {
            if (err && err.message && err.message.includes('429')) {
                // Too Many Requests, wait and retry
                await new Promise(res => setTimeout(res, delay * (attempt + 1)));
            } else {
                // Other error, do not retry
                break;
            }
        }
    }
}

async function fetchMissingCollectionMinifigDetails() {
    
    
    const allFigNums = Object.keys(S.minifigColl).filter(e => !MINIFIG_MAP[e] || !MINIFIG_MAP[e].name);
    if (allFigNums.length === 0) return;
    try {
        const batchSize = 5;
        for (let i = 0; i < allFigNums.length; i += batchSize) {
            const batch = allFigNums.slice(i, i + batchSize);
            try {
            const results = await Promise.all(batch.map(figNum => fetchMinifigDetailsWithRetry(figNum)));
                // Save state after each batch to avoid data loss
                saveState();
                
                // –°—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ fetchMinifigDetails –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç
            } catch (error) {
                console.error(`Failed to fetch batch ${i}-${i + batchSize}:`, error);
            }
            // Add delay between batches to avoid rate limiting
            if (i + batchSize < allFigNums.length) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }
    } catch (error) {
        console.error('Error in fetchMissingCollectionMinifigDetails:', error);
        // Force save state even after error to persist any successful fetches
        saveState();
    }
}

// Initialize API loading statistics if not exists
function initializeApiStats() {
    if (!localStorage.getItem('legoApiStats')) {
        const initialStats = {
            colors: 0,
            parts: 0,
            sets: 0,
            minifigs: 0,
            images: 0,
            lastUpdate: null
        };
        localStorage.setItem('legoApiStats', JSON.stringify(initialStats));
    }
}

// –í—ã–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
initializeApiStats();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∏ –≤–≤–æ–¥–µ
function updateFilterValue(inputElement, filterKey) {
    if (tempFilters && tempFilters.setFilters) {
        tempFilters.setFilters[filterKey] = inputElement.value;
        console.log('Filter updated via input:', filterKey, '=', inputElement.value);
        console.log('Current tempFilters.setFilters:', tempFilters.setFilters);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        resetRandomMinifigImage();
    }
    
    // –¢–∞–∫–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –¥–µ—Ç–∞–ª–µ–π
    if (tempFilters && tempFilters.filters && filterKey === 'colorIds') {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–≤–µ—Ç–æ–≤—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
        resetRandomMinifigImage();
    }
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à–∏ Escape –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–∞–ø–∫–∏ –ø–æ Esc
        if (colorsModalEl && !colorsModalEl.classList.contains('modal-hidden')) {
            modalManager.closeModal('colors-modal-container');
            e.preventDefault();
            return;
        }
        if (modalManager.getOpenModalsCount() > 0) {
            modalManager.closeLastModal();
            e.preventDefault();
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å sidebar-toggle –ø–æ Escape (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω)
        const activeModal = document.querySelector('[id$="-modal-container"]:not(.modal-hidden)');
        if (!activeModal) {
            hideSidebarHint();
        }
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è modalManager
console.log('modalManager initialized');

// –§–ª–∞–≥ –∏ —Ç–∞–π–º–µ—Ä –¥–ª—è –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
let sidebarHintIntroActive = false;
let sidebarHintAutoTimer = null;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–∫–∞–∑–∞—Ç–µ–ª—è sidebar-toggle
function showSidebarHint() {
    if (!S.showSidebarHint || window.innerWidth >= 1024) return;
    
    const hintEl = document.getElementById('sidebar-hint');
    if (hintEl) {
        hintEl.classList.remove('hidden');
        sidebarHintIntroActive = true;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Å–∞—Ü–∏—é –∫ –∫–Ω–æ–ø–∫–µ sidebar-toggle
        const sidebarToggleBtn = document.getElementById('sidebar-toggle');
        if (sidebarToggleBtn) {
            sidebarToggleBtn.classList.add('pulse');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–∫–∏
            sidebarToggleBtn.style.opacity = '0';
            sidebarToggleBtn.style.transform = 'scale(0.8) rotate(-10deg)';
            
            setTimeout(() => {
                sidebarToggleBtn.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                sidebarToggleBtn.style.opacity = '1';
                sidebarToggleBtn.style.transform = 'scale(1) rotate(0deg)';
            }, 100);
            
            // –£–±–∏—Ä–∞–µ–º –ø—É–ª—å—Å–∞—Ü–∏—é —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                sidebarToggleBtn.classList.remove('pulse');
            }, 5000);
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–∫—Ä—ã–ª —Å–∞–º
        if (sidebarHintAutoTimer) clearTimeout(sidebarHintAutoTimer);
        sidebarHintAutoTimer = setTimeout(() => {
            // –°–Ω–∏–º–∞–µ–º —Ä–µ–∂–∏–º –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ —Å–∫—Ä—ã–≤–∞–µ–º
            sidebarHintIntroActive = false;
            hideSidebarHint(true);
        }, 10000);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —É–∫–∞–∑–∞—Ç–µ–ª—è sidebar-toggle
function hideSidebarHint(force = false) {
    const hintEl = document.getElementById('sidebar-hint');
    if (hintEl) {
        // –í–æ –≤—Ä–µ–º—è –ø–µ—Ä–≤–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–µ –∏–ª–∏ –ø–æ –∞–≤—Ç–æ—Ç–∞–π–º–µ—Ä—É
        if (sidebarHintIntroActive && !force) return;
        if (sidebarHintAutoTimer) { clearTimeout(sidebarHintAutoTimer); sidebarHintAutoTimer = null; }
        hintEl.classList.add('hidden');
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage, —á—Ç–æ —É–∫–∞–∑–∞—Ç–µ–ª—å –±–æ–ª—å—à–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å
        S.showSidebarHint = false;
        try {
            localStorage.setItem('showSidebarHint', 'false');
        } catch {}
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫
function animateButtonsAppearance() {
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
    const buttons = document.querySelectorAll('.sidebar-toggle-btn, .modal-close-btn, .sidebar-hint-close');
    
    buttons.forEach((button, index) => {
        // –°–Ω–∞—á–∞–ª–∞ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        button.style.opacity = '0';
        button.style.transform = 'scale(0.8) rotate(-10deg)';
        
        // –ó–∞—Ç–µ–º –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        setTimeout(() => {
            button.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
            button.style.opacity = '1';
            button.style.transform = 'scale(1) rotate(0deg)';
        }, index * 100);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –∫–ª–∏–∫–µ
function animateCloseButtonClick(button) {
    if (button) {
        button.style.transform = 'scale(0.9) rotate(2deg)';
        setTimeout(() => {
            button.style.transform = 'scale(1) rotate(0deg)';
        }, 150);
    }
}

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è —É–∫–∞–∑–∞—Ç–µ–ª—è –∏ –∫–ª–∏–∫–∞ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    document.addEventListener('click', (e) => {
        if (e.target.id === 'sidebar-hint-close') {
            // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ
            const hintCloseBtn = e.target;
            if (hintCloseBtn) {
                hintCloseBtn.style.transform = 'scale(0.9) rotate(2deg)';
                setTimeout(() => {
                    hintCloseBtn.style.transform = 'scale(1) rotate(0deg)';
                }, 150);
            }
            // –°–Ω–∏–º–∞–µ–º —Ä–µ–∂–∏–º –≤—Å—Ç—É–ø–∏—Ç–µ–ª—å–Ω–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ —Å–∫—Ä—ã–≤–∞–µ–º
            sidebarHintIntroActive = false;
            hideSidebarHint(true);
        } else if (!e.target.closest('#sidebar-hint') && !e.target.closest('.modal-content') && !e.target.closest('[id$="-modal-container"]')) {
            // –°–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –∫–ª–∏–∫–µ –≤ –ª—é–±–æ–º –º–µ—Å—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–∫—Ä–æ–º–µ —Å–∞–º–æ–≥–æ —É–∫–∞–∑–∞—Ç–µ–ª—è –∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω)
            hideSidebarHint(false);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è —É–∫–∞–∑–∞—Ç–µ–ª—è
    window.addEventListener('resize', () => {
        // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        const activeModal = document.querySelector('[id$="-modal-container"]:not(.modal-hidden)');
        if (activeModal) return;
        
        if (window.innerWidth >= 1024) {
            hideSidebarHint(false);
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–∫—Ä—ã—Ç–∏—è —É–∫–∞–∑–∞—Ç–µ–ª—è
    let scrollTimeout;
    window.addEventListener('scroll', () => {
        // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        const activeModal = document.querySelector('[id$="-modal-container"]:not(.modal-hidden)');
        if (activeModal) return;
        
        if (scrollTimeout) {
            clearTimeout(scrollTimeout);
        }
        scrollTimeout = setTimeout(() => {
            hideSidebarHint(false);
        }, 1000);
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ–∫—É—Å–∞ –Ω–∞ –ø–æ–∏—Å–∫–µ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è —É–∫–∞–∑–∞—Ç–µ–ª—è
    document.addEventListener('focusin', (e) => {
        // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º —É–∫–∞–∑–∞—Ç–µ–ª—å –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        const activeModal = document.querySelector('[id$="-modal-container"]:not(.modal-hidden)');
        if (activeModal && activeModal.contains(e.target)) return;
        
        if (e.target.id === 'search-input') {
            hideSidebarHint(false);
        }
    });

    // –°–∏—Å—Ç–µ–º–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
    console.log('üîß –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É–∂–µ –æ–±—ä—è–≤–ª–µ–Ω—ã –≥–ª–æ–±–∞–ª—å–Ω–æ –≤—ã—à–µ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Ö
    inactivityOverlay = document.getElementById('inactivity-overlay');
    inactivityTip = document.getElementById('inactivity-tip');
    inactivityCloseBtn = document.getElementById('inactivity-close');
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π –ø–æ–¥—Å–∫–∞–∑–∫–∏
    let currentTipIndex = 0;

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É
    function showRandomTip() {
        if (!inactivityOverlay) {
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –ø–æ —Ç–µ–∫—É—â–µ–º—É –∏–Ω–¥–µ–∫—Å—É
        inactivityTip.textContent = inactivityTips[currentTipIndex];
        
        inactivityOverlay.classList.remove('hidden');
        document.body.classList.add('inactive');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        setTimeout(() => {
            inactivityOverlay.classList.add('show');
        }, 100);
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        startTipRotation();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫
    function startTipRotation() {
        if (tipRotationTimer) {
            clearInterval(tipRotationTimer);
            tipRotationTimer = null;
        }
        
        tipRotationTimer = setInterval(() => {
            if (inactivityOverlay && inactivityOverlay.classList.contains('show') && inactivityTip) {
                // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–¥—Å–∫–∞–∑–∫–µ
                currentTipIndex = (currentTipIndex + 1) % inactivityTips.length;
                const newTip = inactivityTips[currentTipIndex];
                inactivityTip.textContent = newTip;
            }
        }, 5000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫
    function stopTipRotation() {
        if (tipRotationTimer) {
            clearInterval(tipRotationTimer);
            tipRotationTimer = null;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –ø–æ–¥—Å–∫–∞–∑–∫–∏
    function hideInactivityTip() {
        if (!inactivityOverlay) return;
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫
        stopTipRotation();
        
        inactivityOverlay.classList.remove('show');
        document.body.classList.remove('inactive');
        
        setTimeout(() => {
            inactivityOverlay.classList.add('hidden');
        }, 500);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞
        currentTipIndex = 0;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
        resetInactivityTimer();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ç–∞–π–º–µ—Ä–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    function resetInactivityTimer() {
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
            inactivityTimer = null;
        }
        
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–º–µ–Ω—É –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        stopTipRotation();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 120 —Å–µ–∫—É–Ω–¥
        inactivityTimer = setTimeout(() => {
            showRandomTip();
        }, 120000);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    function initInactivitySystem() {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ —É–∂–µ —Å–∏—Å—Ç–µ–º–∞
        if (document.documentElement.hasAttribute('data-inactivity-initialized')) {
            return;
        }
        
        inactivityOverlay = document.getElementById('inactivity-overlay');
        inactivityTip = document.getElementById('inactivity-tip');
        inactivityCloseBtn = document.getElementById('inactivity-close');
        
        console.log('üîç –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã:', {
            overlay: !!inactivityOverlay,
            tip: !!inactivityTip,
            closeBtn: !!inactivityCloseBtn
        });
        
        if (!inactivityOverlay || !inactivityTip || !inactivityCloseBtn) {
            return;
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
        inactivityCloseBtn.addEventListener('click', hideInactivityTip);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–ª–∏–∫–∞ –ø–æ –æ–≤–µ—Ä–ª–µ—é (–∑–∞–∫—Ä—ã—Ç–∏–µ)
        inactivityOverlay.addEventListener('click', (e) => {
            if (e.target === inactivityOverlay) {
                hideInactivityTip();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const activityEvents = [
            'mousedown', 'mousemove', 'mouseup', 'click', 'dblclick',
            'keydown', 'keyup', 'keypress',
            'scroll', 'wheel',
            'touchstart', 'touchmove', 'touchend',
            'focus', 'blur',
            'resize'
        ];
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        if (!document.documentElement.hasAttribute('data-inactivity-listeners')) {
            document.documentElement.setAttribute('data-inactivity-listeners', 'true');
            
            activityEvents.forEach(event => {
                document.addEventListener(event, (e) => {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏—è –æ—Ç —Å–∞–º–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
                    if (e.target && (
                        e.target.closest('#inactivity-overlay') ||
                        e.target.id === 'inactivity-close' ||
                        e.target.id === 'inactivity-tip'
                    )) {
                        return;
                    }
                    
                    resetInactivityTimer();
                }, { passive: true });
            });
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        resetInactivityTimer();
        
        // –û—Ç–º–µ—á–∞–µ–º, —á—Ç–æ —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞
        document.documentElement.setAttribute('data-inactivity-initialized', 'true');
        
        console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    console.log('üîß –°–∫—Ä–∏–ø—Ç —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∂–µ–Ω');
    console.log('üîß document.readyState:', document.readyState);
    console.log('üîß –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:', new Date().toLocaleTimeString());
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        console.log('üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã');
        initInactivitySystem();
    }, 3000);
    
    if (document.readyState === 'loading') {
        console.log('üîß DOM –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∂–¥–µ–º DOMContentLoaded');
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üîß DOMContentLoaded —Å—Ä–∞–±–æ—Ç–∞–ª');
            initInactivitySystem();
        });
    } else {
        console.log('üîß DOM —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ä–∞–∑—É');
        initInactivitySystem();
    }

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å
    window.enableProxy = () => {
        forceProxy = true;
        console.log('‚úÖ –ü—Ä–æ–∫—Å–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω');
    };
    
    window.disableProxy = () => {
        forceProxy = false;
        console.log('‚ùå –ü—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ');
    };
    
    window.testProxy = async () => {
        console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—Ä–æ–∫—Å–∏...');
        const testUrl = `${REBRICKABLE_API_URL}/colors/?page=1&page_size=1`;
        try {
            const response = await fetchWithProxy(testUrl);
            if (response.status === 401) {
                console.log('üö´ –ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 (–æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)');
            } else {
                console.log('‚úÖ –ü—Ä–æ–∫—Å–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç:', response.status);
            }
        } catch (error) {
            console.error('‚ùå –ü—Ä–æ–∫—Å–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:', error.message);
        }
    };
    
    window.checkProxies = async () => {
        if (!S.proxyEnabled) {
            console.log('üö´ –ü—Ä–æ–∫—Å–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è');
            return false;
        }
        
        console.log('üîç –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤—Å–µ—Ö –ø—Ä–æ–∫—Å–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤...');
        const hasWorkingProxies = await checkAllProxies(false);
        if (hasWorkingProxies) {
            console.log('‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–∞–±–æ—á–∏–µ –ø—Ä–æ–∫—Å–∏ –Ω–∞–π–¥–µ–Ω—ã.');
        } else {
            console.warn('‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –†–∞–±–æ—á–∏–µ –ø—Ä–æ–∫—Å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.');
        }
        return hasWorkingProxies;
    };
    
    
    
    window.resetProxyCache = () => {
        FAILED_PROXIES.clear();
        BLOCKED_IP_CACHE.clear();
        lastBlockedTime = 0;
        PROXY_CONFIG.currentProxyIndex = 0;
        console.log('üîÑ –ö—ç—à –ø—Ä–æ–∫—Å–∏ —Å–±—Ä–æ—à–µ–Ω');
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
    window.testInactivitySystem = () => {
        console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...');
        console.log('üìä –°—Ç–∞—Ç—É—Å —ç–ª–µ–º–µ–Ω—Ç–æ–≤:', {
            overlay: !!inactivityOverlay,
            tip: !!inactivityTip,
            closeBtn: !!inactivityCloseBtn,
            timer: !!inactivityTimer,
            tipRotationTimer: !!tipRotationTimer,
            currentTipIndex: typeof currentTipIndex !== 'undefined' ? currentTipIndex : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞',
            tipsArray: inactivityTips ? inactivityTips.length : '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'
        });
        
        if (inactivityOverlay && inactivityTip) {
            console.log('‚úÖ –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—É—é –ø–æ–¥—Å–∫–∞–∑–∫—É');
            inactivityTip.textContent = 'üß™ –¢–µ—Å—Ç–æ–≤–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ - —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!';
            inactivityOverlay.classList.remove('hidden');
            inactivityOverlay.classList.add('show');
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                inactivityOverlay.classList.remove('show');
                setTimeout(() => {
                    inactivityOverlay.classList.add('hidden');
                }, 500);
                console.log('‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ —Å–∫—Ä—ã—Ç–∞');
            }, 3000);
        } else {
            console.error('‚ùå –≠–ª–µ–º–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
    window.showInactivityTip = () => {
        if (typeof showRandomTip === 'function') {
            showRandomTip();
            console.log('‚úÖ –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–∫–∞–∑–∞–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ');
        } else {
            console.error('‚ùå –§—É–Ω–∫—Ü–∏—è showRandomTip –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        }
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–∞–π–º–µ—Ä–æ–º (10 —Å–µ–∫—É–Ω–¥)
    window.testInactivityQuick = () => {
        console.log('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–∞–π–º–µ—Ä–æ–º (10 —Å–µ–∫)');
        
        if (inactivityTimer) {
            clearTimeout(inactivityTimer);
        }
        
        inactivityTimer = setTimeout(() => {
            console.log('‚è∞ –¢–µ—Å—Ç–æ–≤—ã–π —Ç–∞–π–º–µ—Ä —Å—Ä–∞–±–æ—Ç–∞–ª, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É');
            showRandomTip();
        }, 10000);
        
        console.log('‚úÖ –¢–µ—Å—Ç–æ–≤—ã–π —Ç–∞–π–º–µ—Ä —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ 10 —Å–µ–∫—É–Ω–¥');
    };
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ —Å–∏—Å—Ç–µ–º—ã
    window.checkInactivityStatus = () => {
        console.log('üìä –°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:');
        console.log('  - –¢–∞–π–º–µ—Ä –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:', inactivityTimer ? '–∞–∫—Ç–∏–≤–µ–Ω' : '–Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
        console.log('  - –¢–∞–π–º–µ—Ä —Å–º–µ–Ω—ã –ø–æ–¥—Å–∫–∞–∑–æ–∫:', tipRotationTimer ? '–∞–∫—Ç–∏–≤–µ–Ω' : '–Ω–µ –∞–∫—Ç–∏–≤–µ–Ω');
        console.log('  - –¢–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å –ø–æ–¥—Å–∫–∞–∑–∫–∏:', currentTipIndex);
        console.log('  - Overlay –ø–æ–∫–∞–∑–∞–Ω:', inactivityOverlay?.classList.contains('show') ? '–¥–∞' : '–Ω–µ—Ç');
        console.log('  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥—Å–∫–∞–∑–æ–∫:', inactivityTips.length);
    };
    
    window.proxyStatus = () => {
        const timeSinceBlocked = Date.now() - lastBlockedTime;
        const timeSinceLastTest = Date.now() - PROXY_CONFIG.lastProxyTest;
        const stats = getProxyStats();
        
        console.log('üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ–∫—Å–∏:');
        console.log(`  –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–µ–Ω: ${forceProxy}`);
        console.log(`  IP –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω: ${timeSinceBlocked < 300000 ? '–î–∞' : '–ù–µ—Ç'}`);
        console.log(`  –í—Ä–µ–º—è —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: ${Math.round(timeSinceBlocked / 1000)}—Å`);
        console.log(`  –ù–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–∫—Å–∏: ${FAILED_PROXIES.size}`);
        console.log(`  –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö URL: ${BLOCKED_IP_CACHE.size}`);
        console.log(`  –†–∞–±–æ—á–∏—Ö –ø—Ä–æ–∫—Å–∏: ${PROXY_CONFIG.workingProxies.length}/${PROXY_CONFIG.proxies.length}`);
        console.log(`  –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞: ${Math.round(timeSinceLastTest / 1000)}—Å –Ω–∞–∑–∞–¥`);
        console.log(`  –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: ${stats.totalRequests}`);
        console.log(`  –£—Å–ø–µ—à–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: ${stats.successfulRequests}`);
        console.log(`  –ù–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤: ${stats.failedRequests}`);
        console.log(`  –ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞: ${stats.successRate}`);
        if (PROXY_CONFIG.workingProxies.length > 0) {
            console.log(`  –¢–µ–∫—É—â–∏–π –ø—Ä–æ–∫—Å–∏: ${PROXY_CONFIG.workingProxies[PROXY_CONFIG.currentProxyIndex % PROXY_CONFIG.workingProxies.length]}`);
        }
        console.log(`  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∫—Å–∏:`, stats.proxyUsage);
    };
    
    window.simulateBlock = () => {
        lastBlockedTime = Date.now();
        console.log('üö´ –ò–º–∏—Ç–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ IP –≤–∫–ª—é—á–µ–Ω–∞');
    };

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–∫—Å–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ API –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
    setTimeout(() => {
        console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API...');
        fetch(`${REBRICKABLE_API_URL}/colors/?page=1&page_size=1`)
            .then(response => {
                if (response.ok) {
                    console.log('‚úÖ API –¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–∫—Å–∏ –Ω–µ –Ω—É–∂–µ–Ω');
                } else {
                    if (response.status === 401) {
                        console.log(`üö´ –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401) - –≤–æ–∑–º–æ–∂–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ API –∫–ª—é—á–∞, –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Å–∏`);
                    } else {
                        console.log(`‚ö†Ô∏è API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (${response.status}), –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Å–∏`);
                    }
                    forceProxy = true;
                    lastBlockedTime = Date.now();
                }
            })
            .catch(error => {
                if (error.message.includes('CORS') || error.name === 'TypeError') {
                    console.log('üö´ API –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω CORS, –≤–∫–ª—é—á–∞–µ–º –ø—Ä–æ–∫—Å–∏');
                    forceProxy = true;
                    lastBlockedTime = Date.now();
                } else {
                    console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ API:', error.message);
                }
            });
    }, 2000);

    console.log('üèÅ –ö–û–ù–ï–¶ –°–ö–†–ò–ü–¢–ê –°–ò–°–¢–ï–ú–´ –ù–ï–ê–ö–¢–ò–í–ù–û–°–¢–ò');
    console.log('üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∫—Å–∏:');
    console.log('  enableProxy() - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –≤–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–∫—Å–∏');
    console.log('  disableProxy() - –æ—Ç–∫–ª—é—á–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–∫—Å–∏');
    console.log('  simulateBlock() - –∏–º–∏—Ç–∏—Ä–æ–≤–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫—É IP');
    console.log('  testProxy() - –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏');
    console.log('  resetProxyCache() - —Å–±—Ä–æ—Å–∏—Ç—å –∫—ç—à –ø—Ä–æ–∫—Å–∏');
    console.log('  proxyStatus() - –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å –ø—Ä–æ–∫—Å–∏');


        // ===== –°–ö–ê–ù–ï–† –ú–ò–ù–ò–§–ò–ì–£–†–û–ö =====
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞–Ω–µ—Ä–∞
        let scanner = null;
        let currentStream = null;
        let isScanning = false;
        let scanTimer = null;
        let isProcessingScan = false;
        let isScannerInitialized = false;
        let isMobile = false;
        let isCameraStarting = false;
        let mobileScanner = null;
        let mobileScanInterval = null;
        let scanStats = {
            total: 0,
            successful: 0,
            qr: 0,
            datamatrix: 0
        };
        let lastScannedCode = null;
        let lastScanTime = 0;
        let consoleLogs = [];
        
        // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–ê–°–¢–†–û–ï–ö –ö–ê–ú–ï–†–´ =====
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã DataMatrix –≤ localStorage
        function saveDataMatrixCameraSettings(deviceId, resolution) {
            try {
                const settings = {
                    deviceId: deviceId,
                    resolution: resolution,
                    timestamp: Date.now()
                };
                localStorage.setItem('datamatrix_camera_settings', JSON.stringify(settings));
                console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã DataMatrix —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', settings);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã DataMatrix:', error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã DataMatrix –∏–∑ localStorage
        function loadDataMatrixCameraSettings() {
            try {
                const saved = localStorage.getItem('datamatrix_camera_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–µ (–Ω–µ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
                    const maxAge = 30 * 24 * 60 * 60 * 1000; // 30 –¥–Ω–µ–π –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
                    if (Date.now() - settings.timestamp < maxAge) {
                        console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã DataMatrix –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', settings);
                        return settings;
                    } else {
                        console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã DataMatrix —É—Å—Ç–∞—Ä–µ–ª–∏, —É–¥–∞–ª—è–µ–º');
                        localStorage.removeItem('datamatrix_camera_settings');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã DataMatrix:', error);
            }
            return null;
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞ –≤ localStorage
        function savePhotoCameraSettings(deviceId, resolution) {
            try {
                const settings = {
                    deviceId: deviceId,
                    resolution: resolution,
                    timestamp: Date.now()
                };
                localStorage.setItem('photo_camera_settings', JSON.stringify(settings));
                console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã:', settings);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞:', error);
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞ –∏–∑ localStorage
        function loadPhotoCameraSettings() {
            try {
                const saved = localStorage.getItem('photo_camera_settings');
                if (saved) {
                    const settings = JSON.parse(saved);
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–µ —Å–ª–∏—à–∫–æ–º —Å—Ç–∞—Ä—ã–µ (–Ω–µ —Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
                    const maxAge = 30 * 24 * 60 * 60 * 1000; // 30 –¥–Ω–µ–π –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
                    if (Date.now() - settings.timestamp < maxAge) {
                        console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', settings);
                        return settings;
                    } else {
                        console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞ —É—Å—Ç–∞—Ä–µ–ª–∏, —É–¥–∞–ª—è–µ–º');
                        localStorage.removeItem('photo_camera_settings');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞:', error);
            }
            return null;
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã
        function clearAllCameraSettings() {
            try {
                // –£–¥–∞–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ DataMatrix –∫–∞–º–µ—Ä—ã
                localStorage.removeItem('datamatrix_camera_settings');
                console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã DataMatrix —É–¥–∞–ª–µ–Ω—ã');
                
                // –£–¥–∞–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ AI –ø–æ–∏—Å–∫–∞ –∫–∞–º–µ—Ä—ã
                localStorage.removeItem('photo_camera_settings');
                console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞ —É–¥–∞–ª–µ–Ω—ã');
                
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã:', error);
                return false;
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–º–µ—Ä—ã
        function hasCameraSettings() {
            const datamatrixSettings = localStorage.getItem('datamatrix_camera_settings');
            const photoSettings = localStorage.getItem('photo_camera_settings');
            return !!(datamatrixSettings || photoSettings);
        }
        
        // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function clearAllApplicationData() {
            try {
                console.log('–ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
                
                // 1. –û—á–∏—â–∞–µ–º localStorage
                localStorage.clear();
                console.log('localStorage –æ—á–∏—â–µ–Ω');
                
                // 2. –û—á–∏—â–∞–µ–º sessionStorage
                sessionStorage.clear();
                console.log('sessionStorage –æ—á–∏—â–µ–Ω');
                
                // 3. –û—á–∏—â–∞–µ–º IndexedDB
                if ('indexedDB' in window) {
                    try {
                        // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–∞–∑ –¥–∞–Ω–Ω—ã—Ö
                        const databases = await indexedDB.databases();
                        for (const db of databases) {
                            if (db.name) {
                                indexedDB.deleteDatabase(db.name);
                                console.log(`–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ${db.name} —É–¥–∞–ª–µ–Ω–∞`);
                            }
                        }
                    } catch (error) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ IndexedDB:', error);
                    }
                }
                
                // 4. –û—á–∏—â–∞–µ–º –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(
                            cacheNames.map(cacheName => caches.delete(cacheName))
                        );
                        console.log('–ö—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—á–∏—â–µ–Ω');
                    } catch (error) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫—ç—à–∞:', error);
                    }
                }
                
                // 5. –û—á–∏—â–∞–µ–º Service Worker –∫—ç—à
                if ('serviceWorker' in navigator) {
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        for (const registration of registrations) {
                            await registration.unregister();
                            console.log('Service Worker –æ—Ç–∫–ª—é—á–µ–Ω');
                        }
                    } catch (error) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ Service Worker:', error);
                    }
                }
                
                console.log('–ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                return true;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                return false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–≥–∞–º–∏
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                time: timestamp,
                message: message,
                type: type
            };
            
            consoleLogs.push(logEntry);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª–æ–≥–æ–≤ –¥–æ 100
            if (consoleLogs.length > 100) {
                consoleLogs.shift();
            }
            
            updateConsoleDisplay();
        }
        
        function updateConsoleDisplay() {
            const logsContainer = document.getElementById('console-logs');
            if (!logsContainer) return;
            
            if (consoleLogs.length === 0) {
                logsContainer.innerHTML = '<div class="text-gray-500">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å...</div>';
                return;
            }
            
            const logsHtml = consoleLogs.map(log => {
                const colorClass = {
                    'info': 'text-gray-300',
                    'success': 'text-green-400',
                    'error': 'text-red-400',
                    'warning': 'text-yellow-400',
                    'debug': 'text-blue-400'
                }[log.type] || 'text-gray-300';
                
                return `<div class="mb-1">
                    <span class="text-gray-500">[${log.time}]</span>
                    <span class="${colorClass}">${log.message}</span>
                </div>`;
            }).join('');
            
            logsContainer.innerHTML = logsHtml;
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }
        
        function clearLogs() {
            consoleLogs = [];
            updateConsoleDisplay();
        }
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        function detectMobile() {
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ User Agent
            const isMobileUA = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(userAgent.toLowerCase());
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const isSmallScreen = window.innerWidth <= 768 || window.innerHeight <= 768;
            const isMobileOrientation = window.screen && (window.screen.orientation || window.screen.mozOrientation || window.screen.msOrientation);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–æ–±–∏–ª—å–Ω—ã—Ö API
            const hasMobileAPIs = 'DeviceOrientationEvent' in window || 'DeviceMotionEvent' in window;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —á–µ—Ä–µ–∑ mediaDevices
            const isMobileDevice = navigator.mediaDevices && 
                navigator.mediaDevices.enumerateDevices && 
                navigator.mediaDevices.getUserMedia;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ —Å–æ–≤–æ–∫—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤
            // –ë–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ª–æ–∂–Ω—ã—Ö —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
            isMobile = isMobileUA || (isTouchDevice && isSmallScreen && (hasMobileAPIs || isMobileDevice));
            
            console.log('–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ:', isMobile, 'UA:', isMobileUA, 'Touch:', isTouchDevice, 'Small:', isSmallScreen, 'MobileAPIs:', hasMobileAPIs);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            if (isMobile) {
                updateMobileInterface();
                checkHTTPS();
            }
            
            return isMobile;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function checkHTTPS() {
            if (isMobile && location.protocol !== 'https:' && location.hostname !== 'localhost') {
                console.warn('–¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                const warningDiv = document.createElement('div');
                warningDiv.className = 'fixed top-0 left-0 right-0 bg-red-600 text-white p-4 z-50 text-center';
                warningDiv.innerHTML = `
                    <div class="max-w-4xl mx-auto">
                        <h3 class="font-bold text-lg mb-2">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</h3>
                        <p class="text-sm mb-3">–ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∫–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ HTTPS. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ HTTPS.</p>
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button onclick="location.href='https://' + location.host + location.pathname" 
                                    class="bg-white text-red-600 px-4 py-2 rounded font-medium">
                                –ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ HTTPS
                            </button>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                    class="bg-red-700 text-white px-4 py-2 rounded">
                                –ó–∞–∫—Ä—ã—Ç—å
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(warningDiv);
                
                return false;
            }
            return true;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç–∞—Ä—ã–º API getUserMedia
        function getOldUserMedia(constraints) {
            return new Promise((resolve, reject) => {
                const getUserMedia = navigator.getUserMedia || 
                                   navigator.webkitGetUserMedia || 
                                   navigator.mozGetUserMedia || 
                                   navigator.msGetUserMedia;
                
                if (!getUserMedia) {
                    reject(new Error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è'));
                    return;
                }
                
                getUserMedia.call(navigator, constraints, resolve, reject);
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function updateMobileInterface() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            const mobileTip = document.getElementById('mobile-tip');
            const mobilePlaceholderTip = document.getElementById('mobile-placeholder-tip');
            const fourKOption = document.getElementById('4k-option');
            const httpsWarning = document.getElementById('https-warning');
            
            if (mobileTip) mobileTip.style.display = 'block';
            if (mobilePlaceholderTip) mobilePlaceholderTip.style.display = 'block';
            if (fourKOption) fourKOption.style.display = 'block';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ HTTPS –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (httpsWarning && location.protocol !== 'https:' && location.hostname !== 'localhost') {
                httpsWarning.style.display = 'block';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            const forceBtn = document.getElementById('force-scan');
            if (forceBtn) {
                forceBtn.style.display = 'block';
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const video = document.getElementById('scanner-video');
            if (video) {
                video.classList.add('touch-none'); // –û—Ç–∫–ª—é—á–∞–µ–º touch —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤–∏–¥–µ–æ
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
            window.addEventListener('orientationchange', handleOrientationChange);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∂–µ—Å—Ç–æ–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            addMobileGestures();
            
            console.log('–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞
        function handleOrientationChange() {
            if (isMobile) {
                console.log('–ò–∑–º–µ–Ω–µ–Ω–∏–µ –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞');
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
                setTimeout(() => {
                    // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
                    if (currentStream && isScanning) {
                        console.log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏');
                        stopCamera();
                        setTimeout(() => {
                            startCamera();
                        }, 500);
                    }
                }, 1000);
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∂–µ—Å—Ç–æ–≤ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function addMobileGestures() {
            const video = document.getElementById('scanner-video');
            if (!video) return;
            
            let startX = 0;
            let startY = 0;
            let startTime = 0;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏—è –¥–ª—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏
            video.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                startTime = Date.now();
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –¥–ª—è —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏
            video.addEventListener('touchend', (e) => {
                e.preventDefault();
                const touch = e.changedTouches[0];
                const endX = touch.clientX;
                const endY = touch.clientY;
                const endTime = Date.now();
                
                // –ï—Å–ª–∏ —ç—Ç–æ –∫–æ—Ä–æ—Ç–∫–æ–µ –∫–∞—Å–∞–Ω–∏–µ (—Ç–∞–ø), —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è
                if (endTime - startTime < 300 && 
                    Math.abs(endX - startX) < 10 && 
                    Math.abs(endY - startY) < 10) {
                    focusCamera(endX, endY);
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –∫–∞—Å–∞–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
            let lastTap = 0;
            video.addEventListener('touchend', (e) => {
                e.preventDefault();
                const currentTime = Date.now();
                const tapLength = currentTime - lastTap;
                
                if (tapLength < 500 && tapLength > 0) {
                    // –î–≤–æ–π–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ - –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É
                    switchCamera();
                }
                lastTap = currentTime;
            });
        }
        
        // –§–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ç–æ—á–∫–µ
        function focusCamera(x, y) {
            if (!currentStream || !isMobile) return;
            
            const video = document.getElementById('scanner-video');
            if (!video) return;
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤–∏–¥–µ–æ
            const rect = video.getBoundingClientRect();
            const xPercent = (x - rect.left) / rect.width;
            const yPercent = (y - rect.top) / rect.height;
            
            // –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫—É —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏
            const focusPoint = {
                x: xPercent,
                y: yPercent
            };
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
            showFocusIndicator(x, y);
            
            console.log('–§–æ–∫—É—Å–∏—Ä–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã –≤ —Ç–æ—á–∫–µ:', focusPoint);
        }
        
        // –ü–æ–∫–∞–∑ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏
        function showFocusIndicator(x, y) {
            const video = document.getElementById('scanner-video');
            if (!video) return;
            
            // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏
            const indicator = document.createElement('div');
            indicator.className = 'absolute w-8 h-8 border-2 border-white rounded-full pointer-events-none z-10';
            indicator.style.left = (x - 16) + 'px';
            indicator.style.top = (y - 16) + 'px';
            indicator.style.animation = 'pulse 1s ease-in-out';
            
            video.parentElement.appendChild(indicator);
            
            // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
            setTimeout(() => {
                if (indicator.parentElement) {
                    indicator.parentElement.removeChild(indicator);
                }
            }, 1000);
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∫–∞–º–µ—Ä–∞–º–∏
        function switchCamera() {
            if (!isMobile) return;
            
            const cameraSelect = document.getElementById('camera-select');
            if (!cameraSelect) return;
            
            const options = Array.from(cameraSelect.options);
            const currentIndex = options.findIndex(option => option.value === cameraSelect.value);
            const nextIndex = (currentIndex + 1) % options.length;
            
            if (nextIndex > 0) { // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç (–∑–∞–≥–æ–ª–æ–≤–æ–∫)
                cameraSelect.value = options[nextIndex].value;
                console.log('–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É:', options[nextIndex].textContent);
                
                // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É —Å –Ω–æ–≤–æ–π –∫–∞–º–µ—Ä–æ–π
                if (currentStream) {
                    stopCamera();
                    setTimeout(() => {
                        startCamera();
                    }, 500);
                }
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        function initScanner() {
            if (S.view === 'tools' && S.toolSubView === 'scanner') {
                detectMobile();
                // setupCameraSelect –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ initScannerOnViewChange
                setupScannerEventListeners();
                updateScanStats();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        function initScannerOnViewChange() {
            if (S.view === 'tools' && S.toolSubView === 'scanner') {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞...');
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ DOM
                setTimeout(() => {
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã...');
                    setupCameraSelect();
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π...');
                    setupScannerEventListeners();
                    console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
                    updateScanStats();
                    console.log('–ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∫–∞–º–µ—Ä—ã...');
                    startCameraMonitoring();
                    console.log('–°–∫—Ä—ã—Ç–∏–µ –±–ª–æ–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏...');
                    updateScanResultsVisibility();
                    console.log('–°–∫–∞–Ω–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–∫–∞–º–µ—Ä–∞ –ù–ï –∑–∞–ø—É—â–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)');
                }, 100);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        function initPhotoSearchOnViewChange() {
            if (S.view === 'tools' && S.toolSubView === 'photo-search') {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ...');
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ DOM
                setTimeout(() => {
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ...');
                    setupPhotoSearchCamera();
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ...');
                    setupPhotoSearchEventListeners();
                    console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ API...');
                    console.log('–ü–æ–∏—Å–∫ –ø–æ —Ñ–æ—Ç–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (–∫–∞–º–µ—Ä–∞ –ù–ï –∑–∞–ø—É—â–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)');
                }, 100);
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã
        let isSettingUpCameras = false;
        async function setupCameraSelect() {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
            if (isSettingUpCameras) {
                console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
                return;
            }
            
            isSettingUpCameras = true;
            
            const cameraSelect = document.getElementById('camera-select');
            if (!cameraSelect) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç camera-select –Ω–µ –Ω–∞–π–¥–µ–Ω');
                isSettingUpCameras = false;
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–¥ –ø–æ–ª—É—á–µ–Ω–∏–µ–º —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä
            detectMobile();
            
            try {
                // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    // –ü–æ–ø—Ä–æ–±—É–µ–º —Å—Ç–∞—Ä—ã–π API –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                    if (navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia) {
                        console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π API getUserMedia');
                    } else {
                        throw new Error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö.');
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∏–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ HTTPS
                if (isMobile && location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    throw new Error('–ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö —Ç—Ä–µ–±—É–µ—Ç—Å—è HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ HTTPS.');
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
                let videoDevices = [];
                
                console.log('–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä...');
                addLog('–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä...', 'info');
                
                try {
                    // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
                    if (navigator.mediaDevices && navigator.mediaDevices.enumerateDevices) {
                        console.log('–ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä...');
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        videoDevices = devices.filter(device => device.kind === 'videoinput');
                        console.log('–ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä:', videoDevices.length);
                        
                        // –ï—Å–ª–∏ –∫–∞–º–µ—Ä—ã –Ω–∞–π–¥–µ–Ω—ã, –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ —Å–ø–∏—Å–æ–∫
                        if (videoDevices.length > 0) {
                            console.log('–ö–∞–º–µ—Ä—ã –Ω–∞–π–¥–µ–Ω—ã —á–µ—Ä–µ–∑ enumerateDevices');
                        }
                    }
                } catch (error) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä:', error);
                    addLog(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä: ${error.message}`, 'error');
                }
                
                // –ï—Å–ª–∏ –∫–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
                if (videoDevices.length === 0) {
                    console.log('–°–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É –¥–ª—è –∫–∞–º–µ—Ä—ã');
                    videoDevices = [{ deviceId: 'default', label: '–ö–∞–º–µ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é' }];
                }
                
                cameraSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>';
                
                if (videoDevices.length === 0) {
                    cameraSelect.innerHTML = '<option value="">–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</option>';
                    addLog('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                    return;
                }
                
                // –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–ø—Ä–æ—à–µ–Ω—ã –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã
                
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    let label = device.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–∞–º–µ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    if (isMobile) {
                        if (label.toLowerCase().includes('back') || label.toLowerCase().includes('rear')) {
                            label += ' (–ó–∞–¥–Ω—è—è)';
                        } else if (label.toLowerCase().includes('front') || label.toLowerCase().includes('selfie')) {
                            label += ' (–ü–µ—Ä–µ–¥–Ω—è—è)';
                        }
                    }
                    
                    option.textContent = label;
                    cameraSelect.appendChild(option);
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞—Ç—å –∫–∞–º–µ—Ä—É (–Ω–æ –ù–ï –∑–∞–ø—É—Å–∫–∞—Ç—å –µ—ë)
                if (videoDevices.length > 0) {
                    console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞–º–µ—Ä—ã:', videoDevices.map(d => ({ deviceId: d.deviceId, label: d.label })));
                    addLog(`–ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: ${videoDevices.length}`, 'info');
                    
                    // –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –≤ –ª–æ–≥
                    videoDevices.forEach((device, index) => {
                        addLog(`–ö–∞–º–µ—Ä–∞ ${index}: ${device.label} (ID: ${device.deviceId})`, 'info');
                    });
                    
                    // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏—â–µ–º –∫–∞–º–µ—Ä—É 0
                    addLog(`isMobile: ${isMobile}`, 'info');
                    if (isMobile) {
                        addLog('–ü–æ–∏—Å–∫ –∫–∞–º–µ—Ä—ã 0 –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...', 'info');
                        
                        // –ò—â–µ–º –∫–∞–º–µ—Ä—É —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "camera 0" (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
                        let camera0 = videoDevices.find(device => 
                            device.label.toLowerCase().includes('camera 0')
                        );
                        
                        if (camera0) {
                            addLog(`–ù–∞–π–¥–µ–Ω–∞ –∫–∞–º–µ—Ä–∞ 0 –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é: ${camera0.label}`, 'success');
                        } else {
                            addLog('–ö–∞–º–µ—Ä–∞ 0 –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—â–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã...', 'warning');
                        }
                        
                        // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—â–µ–º –ø–æ deviceId "0"
                        if (!camera0) {
                            camera0 = videoDevices.find(device => device.deviceId === '0');
                            
                            if (camera0) {
                                addLog(`–ù–∞–π–¥–µ–Ω–∞ –∫–∞–º–µ—Ä–∞ —Å deviceId "0": ${camera0.label}`, 'success');
                            }
                        }
                        
                        // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—â–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
                        if (!camera0) {
                            addLog('–ò—â–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É...', 'info');
                            camera0 = videoDevices.find(device => 
                                device.label.toLowerCase().includes('facing back') ||
                                device.label.toLowerCase().includes('back')
                            );
                            
                            if (camera0) {
                                addLog(`–ù–∞–π–¥–µ–Ω–∞ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞: ${camera0.label}`, 'success');
                            }
                        }
                        
                        if (camera0) {
                            cameraSelect.value = camera0.deviceId;
                            console.log('–í—ã–±—Ä–∞–Ω–∞ –∫–∞–º–µ—Ä–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', camera0.label, 'deviceId:', camera0.deviceId);
                            addLog(`‚úì –í—ã–±—Ä–∞–Ω–∞ –∫–∞–º–µ—Ä–∞: ${camera0.label} (ID: ${camera0.deviceId})`, 'success');
                        } else {
                            // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
                            cameraSelect.value = videoDevices[0].deviceId;
                            console.log('–ö–∞–º–µ—Ä–∞ 0 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è:', videoDevices[0].label, 'deviceId:', videoDevices[0].deviceId);
                            addLog(`‚ö† –ö–∞–º–µ—Ä–∞ 0 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è: ${videoDevices[0].label}`, 'warning');
                        }
                        
                        // –ö–∞–º–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –∂–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        addLog('–ö–∞–º–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞, –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ', 'info');
                    } else {
                        addLog('–ù–µ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞–º–µ—Ä—É', 'info');
                        cameraSelect.value = videoDevices[0].deviceId;
                        console.log('–í—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –∫–∞–º–µ—Ä–∞:', videoDevices[0].label);
                        addLog(`–í—ã–±—Ä–∞–Ω–∞ –∫–∞–º–µ—Ä–∞: ${videoDevices[0].label}`, 'info');
                        
                        // –ö–∞–º–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞ –¥–ª—è –ü–ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –∂–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                        addLog('–ö–∞–º–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞, –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ', 'info');
                    }
                }
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞—Ç—å –Ω–∞–∏–ª—É—á—à–µ–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                const resolutionSelect = document.getElementById('resolution-select');
                if (resolutionSelect) {
                    // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    const squareResolutions = ['1280x1280', '1024x1024', '800x800', '640x640'];
                    let selectedResolution = '1280x1280'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    
                    // –í—ã–±–∏—Ä–∞–µ–º –Ω–∞–∏–ª—É—á—à–µ–µ –¥–æ—Å—Ç—É–ø–Ω–æ–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                    for (const resolution of squareResolutions) {
                        const option = resolutionSelect.querySelector(`option[value="${resolution}"]`);
                        if (option) {
                            selectedResolution = resolution;
                            break;
                        }
                    }
                    
                    resolutionSelect.value = selectedResolution;
                    console.log(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: ${selectedResolution}`);
                    addLog(`–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ: ${selectedResolution}`, 'info');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä:', error);
                cameraSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞: ' + error.message + '</option>';
            } finally {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä
                isSettingUpCameras = false;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–º–µ—Ä—É
        async function requestCameraPermission() {
            console.log('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–º–µ—Ä—É...');
            addLog('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–º–µ—Ä—É...', 'info');
            
            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Å –±–∞–∑–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                const constraints = { video: true };
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                if (stream) {
                    console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É –ø–æ–ª—É—á–µ–Ω–æ');
                    addLog('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É –ø–æ–ª—É—á–µ–Ω–æ!', 'success');
                    
                    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫
                    stream.getTracks().forEach(track => track.stop());
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
                    if (!isSettingUpCameras) {
                        await setupCameraSelect();
                    }
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    alert('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É –ø–æ–ª—É—á–µ–Ω–æ! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∫–∞–º–µ—Ä—É –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–º–µ—Ä—É:', error);
                addLog(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: ${error.message}`, 'error');
                
                let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É. ';
                if (error.name === 'NotAllowedError') {
                    errorMessage += '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += '–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += '–ö–∞–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                } else {
                    errorMessage += error.message;
                }
                
                alert(errorMessage);
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π —Å–∫–∞–Ω–µ—Ä–∞
        function setupScannerEventListeners() {
            const startBtn = document.getElementById('start-camera');
            const stopBtn = document.getElementById('stop-camera');
            const captureBtn = document.getElementById('capture-photo');
            const refreshBtn = document.getElementById('refresh-cameras');
            const resetFlagBtn = document.getElementById('reset-camera-flag');
            const testBtn = document.getElementById('test-scan');
            const forceBtn = document.getElementById('force-scan');
            const toggleBtn = document.getElementById('toggle-scan');
            const testMinifigBtn = document.getElementById('test-minifig-scan');
            const clearResultsBtn = document.getElementById('clear-scan-results');
            const cameraSelect = document.getElementById('camera-select');
            const clearLogsBtn = document.getElementById('clear-logs');
            const requestPermissionBtn = document.getElementById('request-permission');
            
            if (startBtn) startBtn.addEventListener('click', startCamera);
            if (stopBtn) stopBtn.addEventListener('click', stopCamera);
            if (captureBtn) captureBtn.addEventListener('click', capturePhoto);
            if (refreshBtn) refreshBtn.addEventListener('click', setupCameraSelect);
            if (resetFlagBtn) resetFlagBtn.addEventListener('click', resetCameraFlag);
            if (clearLogsBtn) clearLogsBtn.addEventListener('click', clearLogs);
            if (testBtn) testBtn.addEventListener('click', testScanning);
            if (forceBtn) forceBtn.addEventListener('click', forceScanning);
            if (toggleBtn) toggleBtn.addEventListener('click', toggleScanning);
            if (testMinifigBtn) testMinifigBtn.addEventListener('click', testMinifigScanning);
            if (clearResultsBtn) clearResultsBtn.addEventListener('click', clearScanResults);
            if (requestPermissionBtn) requestPermissionBtn.addEventListener('click', requestCameraPermission);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã (–∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞)
            if (cameraSelect) {
                cameraSelect.addEventListener('change', (e) => {
                    console.log('–í—ã–±—Ä–∞–Ω–∞ –∫–∞–º–µ—Ä–∞:', e.target.value);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞–º–µ—Ä—ã
                    updateCameraInterface();
                    
                    // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤–æ–π –∫–∞–º–µ—Ä–æ–π
                    if (currentStream) {
                        console.log('–ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤–æ–π –∫–∞–º–µ—Ä–æ–π...');
                        stopCamera();
                        setTimeout(() => {
                            startCamera();
                        }, 500);
                    } else {
                        // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –µ—ë
                        console.log('–ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞...');
                        addLog('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞...', 'info');
                        setTimeout(() => {
                            startCamera();
                        }, 100);
                    }
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ (–¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã)
            if (navigator.mediaDevices && navigator.mediaDevices.addEventListener) {
                navigator.mediaDevices.addEventListener('devicechange', () => {
                    console.log('–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤');
                    addLog('–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤', 'info');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    setTimeout(() => {
                        console.log('–û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤...');
                        addLog('–û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤...', 'info');
                        setupCameraSelect();
                    }, 1000);
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Å–∞–Ω–∏—è –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
            const video = document.getElementById('scanner-video');
            if (video && isMobile) {
                video.addEventListener('touchstart', () => {
                    if (!currentStream && !isCameraStarting) {
                        console.log('–ö–∞—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ...');
                        addLog('–ö–∞—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ...', 'info');
                        showCameraSelectionModal();
                    }
                });
            }
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã
            setupCameraModalHandlers();
        }
        
        // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã
        async function startCamera() {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
            if (isCameraStarting) {
                console.log('–ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
                addLog('–ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...', 'warning');
                return;
            }
            
            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ - –µ—Å–ª–∏ –∫–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞
            if (currentStream) {
                console.log('–ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
                addLog('–ö–∞–º–µ—Ä–∞ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...', 'warning');
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –∫–∞–º–µ—Ä—ã
            detectMobile();
            
            addLog('–ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...', 'info');
            isCameraStarting = true;
            
            const cameraSelect = document.getElementById('camera-select');
            const resolutionSelect = document.getElementById('resolution-select');
            const video = document.getElementById('scanner-video');
            const placeholder = document.getElementById('scanner-placeholder');
            const overlay = document.getElementById('scanner-overlay');
            const startBtn = document.getElementById('start-camera');
            const stopBtn = document.getElementById('stop-camera');
            const captureBtn = document.getElementById('capture-photo');
            
            if (!cameraSelect || !video) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã DOM');
                isCameraStarting = false;
                return;
            }
            
            const deviceId = cameraSelect.value;
            if (!deviceId) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É');
                return;
            }
            
            try {
                // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø–æ—Ç–æ–∫
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                
                // –ü–æ–ª—É—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                const resolution = resolutionSelect ? resolutionSelect.value.split('x') : ['640', '640'];
                const width = parseInt(resolution[0]);
                const height = parseInt(resolution[1]);
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã —Å fallback –º–µ—Ç–æ–¥–∞–º–∏
                let constraints;
                
                if (deviceId === 'environment') {
                    // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —Å environment –∫–∞–º–µ—Ä–æ–π
                    constraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: width },
                            height: { ideal: height },
                            frameRate: { ideal: isMobile ? 30 : 15 },
                            ...(isMobile && {
                                aspectRatio: { ideal: 16/9 },
                                whiteBalanceMode: 'continuous',
                                exposureMode: 'continuous',
                                focusMode: 'continuous',
                                torch: false
                            })
                        }
                    };
                } else if (deviceId === 'default') {
                    // –î–ª—è –∫–∞–º–µ—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                    constraints = {
                        video: {
                            width: { ideal: width },
                            height: { ideal: height },
                            frameRate: { ideal: isMobile ? 30 : 15 },
                            ...(isMobile && {
                                facingMode: 'environment',
                                aspectRatio: { ideal: 16/9 },
                                whiteBalanceMode: 'continuous',
                                exposureMode: 'continuous',
                                focusMode: 'continuous'
                            })
                        }
                    };
                } else {
                    // –î–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞–º–µ—Ä—ã –ø–æ ID
                    constraints = {
                        video: {
                            deviceId: { exact: deviceId },
                            width: { ideal: width },
                            height: { ideal: height },
                            facingMode: isMobile ? 'environment' : 'user',
                            frameRate: { ideal: isMobile ? 30 : 15 },
                            focusMode: isMobile ? 'continuous' : 'single',
                            ...(isMobile && {
                                aspectRatio: { ideal: 16/9 },
                                whiteBalanceMode: 'continuous',
                                exposureMode: 'continuous',
                                focusMode: 'continuous',
                                torch: false
                            })
                        }
                    };
                }
                
                console.log('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:', constraints);
                addLog(`–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã: ${width}x${height}, –º–æ–±–∏–ª—å–Ω–æ–µ: ${isMobile}`, 'info');
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É —Å fallback –º–µ—Ç–æ–¥–∞–º–∏
                try {
                    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                        console.log('–ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API...');
                        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
                    } else {
                        throw new Error('getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
                    }
                } catch (error) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π API:', error);
                    
                    // Fallback 1: –ü—Ä–æ–±—É–µ–º —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                    try {
                        console.log('–ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏...');
                        const simpleConstraints = {
                            video: {
                                width: { ideal: width },
                                height: { ideal: height },
                                ...(isMobile && { facingMode: 'environment' })
                            }
                        };
                        currentStream = await navigator.mediaDevices.getUserMedia(simpleConstraints);
                    } catch (error2) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–º–µ—Ä—ã —Å —É–ø—Ä–æ—â–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:', error2);
                        
                        // Fallback 2: –ü—Ä–æ–±—É–µ–º —Å –±–∞–∑–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                        try {
                            console.log('–ü—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É —Å –±–∞–∑–æ–≤—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏...');
                            const basicConstraints = { video: true };
                            currentStream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                        } catch (error3) {
                            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É –Ω–∏ –æ–¥–Ω–∏–º —Å–ø–æ—Å–æ–±–æ–º:', error3);
                            throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É: ${error3.message}`);
                        }
                    }
                }
                video.srcObject = currentStream;
                
                // –¢–∞–π–º–∞—É—Ç –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–ª–∞–≥–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è)
                const cameraStartTimeout = setTimeout(() => {
                    if (isCameraStarting) {
                        console.warn('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã');
                        addLog('–¢–∞–π–º–∞—É—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã', 'warning');
                        isCameraStarting = false;
                    }
                }, 10000); // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
                
                // –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
                video.onloadedmetadata = () => {
                    // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–∞—É—Ç, —Ç–∞–∫ –∫–∞–∫ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å —É—Å–ø–µ—à–Ω–æ
                    clearTimeout(cameraStartTimeout);
                    
                    console.log('–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, —Ä–∞–∑–º–µ—Ä:', video.videoWidth, 'x', video.videoHeight);
                    addLog(`–í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${video.videoWidth}x${video.videoHeight}`, 'success');
                    
                    if (video.paused) {
                        video.play().catch(e => console.warn('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ:', e));
                    }
                    
                    // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
                    if (isScannerInitialized && isScanning) {
                        console.log('–°–∫–∞–Ω–µ—Ä —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
                        return;
                    }
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–µ–æ –∏ —Å–∫—Ä—ã—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                    video.classList.remove('hidden');
                    if (placeholder) placeholder.classList.add('hidden');
                    if (overlay) {
                        overlay.classList.remove('hidden');
                        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                        const scanStatus = document.getElementById('scan-status');
                        if (scanStatus) scanStatus.classList.remove('hidden');
                    }
                    
                    // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
                    if (startBtn) startBtn.disabled = true;
                    if (stopBtn) stopBtn.disabled = false;
                    if (captureBtn) captureBtn.disabled = false;
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–Ω–æ–ø–∫—É –∏ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    const testBtn = document.getElementById('test-scan');
                    const forceBtn = document.getElementById('force-scan');
                    const toggleBtn = document.getElementById('toggle-scan');
                    if (testBtn) testBtn.disabled = false;
                    if (forceBtn) forceBtn.disabled = false;
                    if (toggleBtn) toggleBtn.disabled = false;
                    
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫–∞–Ω–µ—Ä –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
                    console.log('–ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞ –ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã...');
                    console.log('isMobile:', isMobile, 'isScanning:', isScanning);
                    console.log('isScannerInitialized:', isScannerInitialized);
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä
                    console.log('–ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä...');
                    
                    if (isMobile) {
                        // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
                        console.log('–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞');
                        addLog('–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: –∑–∞–ø—É—Å–∫ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞', 'info');
                        isScanning = true;
                        isScannerInitialized = false;
                        startMobileScanner();
                    } else {
                        // –î–ª—è –ü–ö –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
                        addLog('–ü–ö: –∑–∞–ø—É—Å–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞', 'info');
                        initQRScanner();
                    }
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
                    isCameraStarting = false;
                };
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
                video.onerror = (error) => {
                    clearTimeout(cameraStartTimeout);
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', error);
                    addLog('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ', 'error');
                    isCameraStarting = false;
                };
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
                isCameraStarting = false;
                let errorMessage = '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É.';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã.';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = '–ö–∞–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.';
                }
                
                alert(errorMessage);
            }
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
        function stopCamera() {
            console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã...');
            
            const video = document.getElementById('scanner-video');
            const placeholder = document.getElementById('scanner-placeholder');
            const overlay = document.getElementById('scanner-overlay');
            const startBtn = document.getElementById('start-camera');
            const stopBtn = document.getElementById('stop-camera');
            const captureBtn = document.getElementById('capture-photo');
            
            // –°–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            isScanning = false;
            isScannerInitialized = false;
            
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–∫
            if (currentStream) {
                console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞...');
                currentStream.getTracks().forEach(track => {
                    track.stop();
                    console.log('–¢—Ä–µ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', track.kind);
                });
                currentStream = null;
            }
            
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä
            if (scanner) {
                console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞...');
                try {
                    scanner.reset();
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                }
                scanner = null;
            }
            
            // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–±–∏–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
            if (mobileScanner) {
                console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞...');
                try {
                    mobileScanner.reset();
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                }
                mobileScanner = null;
            }
            
            // –û—á–∏—Å—Ç–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            if (mobileScanInterval) {
                clearInterval(mobileScanInterval);
                mobileScanInterval = null;
            }
            
            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            if (isMobile) {
                console.log('–ú–æ–±–∏–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            }
            
            // –û—á–∏—Å—Ç–∏—Ç—å srcObject –≤–∏–¥–µ–æ
            if (video) {
                video.srcObject = null;
                video.load(); // –°–±—Ä–æ—Å–∏—Ç—å –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
            }
            
            // –°–∫—Ä—ã—Ç—å –≤–∏–¥–µ–æ –∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
            if (video) video.classList.add('hidden');
            if (placeholder) placeholder.classList.remove('hidden');
            if (overlay) {
                // –°–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã
                overlay.classList.add('hidden');
                // –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const scanStatus = document.getElementById('scan-status');
                if (scanStatus) scanStatus.classList.add('hidden');
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –∫–Ω–æ–ø–∫–∏
            if (startBtn) startBtn.disabled = false;
            if (stopBtn) stopBtn.disabled = true;
            if (captureBtn) captureBtn.disabled = true;
            
            // –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∫–Ω–æ–ø–∫—É –∏ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            const testBtn = document.getElementById('test-scan');
            const forceBtn = document.getElementById('force-scan');
            const toggleBtn = document.getElementById('toggle-scan');
            if (testBtn) testBtn.disabled = true;
            if (forceBtn) forceBtn.disabled = true;
            if (toggleBtn) toggleBtn.disabled = true;
            
            console.log('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
            isCameraStarting = false;
        }
        
        // –°–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
        function resetCameraFlag() {
            console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã...');
            addLog('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã...', 'info');
            
            isCameraStarting = false;
            isScanning = false;
            isScannerInitialized = false;
            
            // –û—á–∏—â–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
            if (mobileScanInterval) {
                clearInterval(mobileScanInterval);
                mobileScanInterval = null;
            }
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
            if (scanner) {
                try {
                    scanner.reset();
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                }
            }
            
            // –û—á–∏—â–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
            if (mobileScanner) {
                try {
                    mobileScanner.reset();
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                }
            }
            
            addLog('–§–ª–∞–≥ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã —Å–±—Ä–æ—à–µ–Ω. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É —Å–Ω–æ–≤–∞.', 'success');
        }
        
        // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–º–µ—Ä—ã (–æ—Ç–∫–ª—é—á–µ–Ω - –∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ)
        function startCameraMonitoring() {
            console.log('–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–∞–º–µ—Ä—ã –æ—Ç–∫–ª—é—á–µ–Ω - –∑–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ');
            // –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—Ç–∫–ª—é—á–µ–Ω, —Ç–∞–∫ –∫–∞–∫ –∫–∞–º–µ—Ä–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        function cleanupCamera() {
            console.log('–û—á–∏—Å—Ç–∫–∞ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...');
            addLog('–û—á–∏—Å—Ç–∫–∞ –∫–∞–º–µ—Ä—ã –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤...', 'info');
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            isScanning = false;
            isScannerInitialized = false;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
            if (currentStream) {
                console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞...');
                currentStream.getTracks().forEach(track => {
                    track.stop();
                    console.log('–¢—Ä–µ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', track.kind);
                });
                currentStream = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
            if (photoSearchStream) {
                console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ...');
                photoSearchStream.getTracks().forEach(track => {
                    track.stop();
                    console.log('–¢—Ä–µ–∫ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω:', track.kind);
                });
                photoSearchStream = null;
            }
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä—ã
            if (scanner) {
                try {
                    scanner.reset();
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                }
                scanner = null;
            }
            
            if (mobileScanner) {
                try {
                    mobileScanner.reset();
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                }
                mobileScanner = null;
            }
            
            // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
            if (mobileScanInterval) {
                clearInterval(mobileScanInterval);
                mobileScanInterval = null;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏
            isCameraStarting = false;
            isPhotoCameraStarting = false;
            
            // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç
            const video = document.getElementById('scanner-video');
            if (video) {
                video.srcObject = null;
                video.load();
            }
            
            // –û—á–∏—â–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
            const photoVideo = document.getElementById('photo-search-video');
            if (photoVideo) {
                photoVideo.srcObject = null;
                photoVideo.load();
            }
            
            console.log('–ö–∞–º–µ—Ä–∞ –æ—á–∏—â–µ–Ω–∞');
            addLog('–ö–∞–º–µ—Ä–∞ –æ—á–∏—â–µ–Ω–∞', 'success');
        }
        
        // –ó–∞–ø—É—Å–∫ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ —Å —Ü–∏–∫–ª–æ–º
        function startMobileScanner() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞...');
            console.log('isScanning:', isScanning, 'isMobile:', isMobile);
            addLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞...', 'info');
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Å–∫–∞–Ω–µ—Ä
            if (mobileScanner) {
                try {
                    mobileScanner.reset();
                } catch (e) {
                    console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                }
            }
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (mobileScanInterval) {
                clearInterval(mobileScanInterval);
                mobileScanInterval = null;
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–æ–±–∏–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
            mobileScanner = new ZXing.BrowserMultiFormatReader();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞
            const mobileHints = new Map();
            mobileHints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                ZXing.BarcodeFormat.QR_CODE,
                ZXing.BarcodeFormat.DATA_MATRIX,
                ZXing.BarcodeFormat.CODE_128,
                ZXing.BarcodeFormat.CODE_39
            ]);
            mobileHints.set(ZXing.DecodeHintType.TRY_HARDER, true);
            mobileHints.set(ZXing.DecodeHintType.ALSO_INVERTED, true);
            mobileHints.set(ZXing.DecodeHintType.PURE_BARCODE, false);
            mobileHints.set(ZXing.DecodeHintType.CHARACTER_SET, 'UTF-8');
            
            // –§—É–Ω–∫—Ü–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∫–∞–¥—Ä–∞
            const scanFrame = () => {
                if (!isScanning || !mobileScanner) {
                    console.log('–ú–æ–±–∏–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                    addLog('–ú–æ–±–∏–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'warning');
                    return;
                }
                
                const video = document.getElementById('scanner-video');
                if (!video || video.readyState !== 4) {
                    // –í–∏–¥–µ–æ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–æ, –ø–æ–≤—Ç–æ—Ä—è–µ–º —á–µ—Ä–µ–∑ 100ms
                    setTimeout(scanFrame, 100);
                    return;
                }
                
                try {
                    mobileScanner.decodeFromVideoElement(video, mobileHints).then(result => {
                        if (result && isScanning) {
                            console.log('–ù–∞–π–¥–µ–Ω –∫–æ–¥ (–º–æ–±–∏–ª—å–Ω—ã–π):', result);
                            addLog(`–ù–∞–π–¥–µ–Ω –∫–æ–¥ (–º–æ–±–∏–ª—å–Ω—ã–π): ${result.getText()}`, 'success');
                            handleScanResult(result);
                            
                            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
                            isScanning = false;
                            console.log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
                            addLog('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...', 'info');
                            
                            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                            setTimeout(() => {
                                stopCamera();
                                setTimeout(() => {
                                    startCamera();
                                }, 500);
                            }, 1000);
                        } else {
                            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 200ms
                            setTimeout(scanFrame, 200);
                        }
                    }).catch(error => {
                        if (!(error instanceof ZXing.NotFoundException)) {
                            console.log('–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–º–æ–±–∏–ª—å–Ω—ã–π):', error.name);
                        }
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ 200ms
                        setTimeout(scanFrame, 200);
                    });
                } catch (error) {
                    console.log('–û—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                    setTimeout(scanFrame, 200);
                }
            };
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            console.log('–ó–∞–ø—É—Å–∫ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ü–∏–∫–ª–æ–º...');
            addLog('–ó–∞–ø—É—Å–∫ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ü–∏–∫–ª–æ–º...', 'info');
            scanFrame();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è QR —Å–∫–∞–Ω–µ—Ä–∞
        function initQRScanner() {
            console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è QR —Å–∫–∞–Ω–µ—Ä–∞...');
            
            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
            if (isMobile) {
                console.log('–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: –∑–∞–ø—É—Å–∫ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞');
                startMobileScanner();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ç—å —Å–∫–∞–Ω–µ—Ä –¥–ª—è –ü–ö
            if (isScannerInitialized && scanner && isScanning) {
                console.log('–°–∫–∞–Ω–µ—Ä —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
                return;
            }
            
            if (typeof ZXing === 'undefined') {
                console.error('ZXing library –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
                return;
            }
            
            const video = document.getElementById('scanner-video');
            if (!video) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç video –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            try {
                console.log('–°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–µ—Ä–∞...');
                scanner = new ZXing.BrowserMultiFormatReader();
                isScanning = true;
                isScannerInitialized = true;
                
                console.log('–ó–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º decodeFromVideoDevice —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.QR_CODE,
                    ZXing.BarcodeFormat.DATA_MATRIX,
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.CODE_39,
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.EAN_8,
                    ZXing.BarcodeFormat.UPC_A,
                    ZXing.BarcodeFormat.UPC_E
                ]);
                hints.set(ZXing.DecodeHintType.TRY_HARDER, isMobile ? false : true); // –û—Ç–∫–ª—é—á–∞–µ–º –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                if (isMobile) {
                    // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
                    hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                        ZXing.BarcodeFormat.QR_CODE,
                        ZXing.BarcodeFormat.DATA_MATRIX,
                        ZXing.BarcodeFormat.CODE_128,
                        ZXing.BarcodeFormat.CODE_39
                    ]);
                    hints.set(ZXing.DecodeHintType.ALSO_INVERTED, true);
                    hints.set(ZXing.DecodeHintType.PURE_BARCODE, false);
                    hints.set(ZXing.DecodeHintType.CHARACTER_SET, 'UTF-8');
                }
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - –±–æ–ª–µ–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
                const options = {
                    delayBetweenScanSuccess: isMobile ? 2000 : 3000, // –£–≤–µ–ª–∏—á–∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                    delayBetweenScanAttempts: isMobile ? 500 : 1000, // –£–º–µ–Ω—å—à–∏–ª–∏ —á–∞—Å—Ç–æ—Ç—É —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    tryHarder: !isMobile, // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –æ—Ç–∫–ª—é—á–∞–µ–º –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
                    tryHarderThreshold: isMobile ? 0.7 : 0.8 // –£–≤–µ–ª–∏—á–∏–ª–∏ –ø–æ—Ä–æ–≥ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
                };
                
                // –î–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –º–µ—Ç–æ–¥
                scanner.decodeFromVideoDevice(undefined, video, (result, error) => {
                    if (result && isScanning) {
                        console.log('–ù–∞–π–¥–µ–Ω –∫–æ–¥:', result);
                        handleScanResult(result);
                    }
                    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ NotFoundException - –æ–Ω–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã
                    // –ù–µ –≤—ã–≤–æ–¥–∏–º –∏—Ö –≤ –∫–æ–Ω—Å–æ–ª—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–ø–∞–º–∞
                }, hints, options);
                
                console.log('QR —Å–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω');
                console.log('isScanning:', isScanning, 'isScannerInitialized:', isScannerInitialized);
                
                if (isMobile) {
                    console.log('–ú–æ–±–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º: –∏—Å–ø–æ–ª—å–∑—É–µ–º decodeFromVideoDevice —Å –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏');
                    console.log('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:', Array.from(hints.get(ZXing.DecodeHintType.POSSIBLE_FORMATS)));
                    console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∏:', options);
                    console.log('–í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ:', video.readyState, '–†–∞–∑–º–µ—Ä:', video.videoWidth, 'x', video.videoHeight);
                } else {
                    console.log('–ü–ö —Ä–µ–∂–∏–º: —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è');
                    console.log('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:', Array.from(hints.get(ZXing.DecodeHintType.POSSIBLE_FORMATS)));
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞: ' + error.message);
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function toggleScanning() {
            const toggleBtn = document.getElementById('toggle-scan');
            const scanStatus = document.getElementById('scan-status');
            
            if (isScanning) {
                // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                isScanning = false;
                
                if (scanner) {
                    try {
                        scanner.reset();
                    } catch (e) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                    }
                }
                
                // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–æ–±–∏–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
                if (mobileScanner) {
                    try {
                        mobileScanner.reset();
                    } catch (e) {
                        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                    }
                    mobileScanner = null;
                }
                
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<span>${I_Play("w-4 h-4")}</span><span>–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</span>';
                    toggleBtn.className = 'flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-[18px] transition-colors';
                }
                
                if (scanStatus) {
                    scanStatus.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
                    scanStatus.className = 'absolute top-2 left-2 bg-red-500 text-white px-2 py-1 rounded text-xs font-medium';
                }
                
                console.log('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            } else {
                // –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                isScanning = true;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                if (isMobile) {
                    // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞–ø—É—Å–∫–∞–µ–º –º–æ–±–∏–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
                    startMobileScanner();
                } else {
                    // –î–ª—è –ü–ö –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
                    if (!isScannerInitialized) {
                        initQRScanner();
                    }
                }
                
                if (toggleBtn) {
                    toggleBtn.innerHTML = '<span>${I_Square("w-4 h-4")}</span><span>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</span>';
                    toggleBtn.className = 'flex items-center gap-2 px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-[18px] transition-colors';
                }
                
                if (scanStatus) {
                    scanStatus.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...';
                    scanStatus.className = 'absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded text-xs font-medium';
                }
                
                console.log('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ');
            }
        }
        
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function forceScanning() {
            console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...');
            const video = document.getElementById('scanner-video');
            if (!video || !scanner) {
                alert('–°–∫–∞–Ω–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            try {
                // –°–æ–∑–¥–∞–µ–º canvas –¥–ª—è –∑–∞—Ö–≤–∞—Ç–∞ –∫–∞–¥—Ä–∞
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // –†–∏—Å—É–µ–º –∫–∞–¥—Ä –Ω–∞ canvas
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // –°–æ–∑–¥–∞–µ–º ImageData
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // –°–æ–∑–¥–∞–µ–º LuminanceSource
                const luminanceSource = new ZXing.RGBLuminanceSource(
                    imageData.data,
                    canvas.width,
                    canvas.height
                );
                
                // –°–æ–∑–¥–∞–µ–º BinaryBitmap
                const binaryBitmap = new ZXing.BinaryBitmap(
                    new ZXing.HybridBinarizer(luminanceSource)
                );
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.QR_CODE,
                    ZXing.BarcodeFormat.DATA_MATRIX,
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.CODE_39
                ]);
                hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                hints.set(ZXing.DecodeHintType.ALSO_INVERTED, true);
                hints.set(ZXing.DecodeHintType.PURE_BARCODE, false);
                
                // –ü—ã—Ç–∞–µ–º—Å—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å
                const reader = new ZXing.MultiFormatReader();
                const result = reader.decode(binaryBitmap, hints);
                
                console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ:', result);
                handleScanResult(result);
                
            } catch (error) {
                if (!(error instanceof ZXing.NotFoundException)) {
                    console.log('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:', error.name, error.message);
                    alert('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: ' + error.message);
                } else {
                    console.log('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø—Ä–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏');
                }
            }
        }
        
        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function testScanning() {
            console.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
            const video = document.getElementById('scanner-video');
            if (!video || !scanner) {
                alert('–°–∫–∞–Ω–µ—Ä –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                return;
            }
            
            try {
                // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const hints = new Map();
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                    ZXing.BarcodeFormat.QR_CODE,
                    ZXing.BarcodeFormat.DATA_MATRIX,
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.CODE_39
                ]);
                hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
                
                if (isMobile) {
                    hints.set(ZXing.DecodeHintType.ALSO_INVERTED, true);
                    hints.set(ZXing.DecodeHintType.PURE_BARCODE, false);
                    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–±–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                }
                
                scanner.decodeFromVideoElement(video, hints)
                    .then(result => {
                        console.log('–¢–µ—Å—Ç —É—Å–ø–µ—à–µ–Ω, –Ω–∞–π–¥–µ–Ω –∫–æ–¥:', result);
                        handleScanResult(result);
                    })
                    .catch(error => {
                        if (!(error instanceof ZXing.NotFoundException)) {
                            console.log('–¢–µ—Å—Ç –Ω–µ —É–¥–∞–ª—Å—è:', error.name, error.message);
                            alert('–¢–µ—Å—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
                        } else {
                            console.log('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞)');
                        }
                    });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ' + error.message);
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function handleScanResult(result) {
            if (!isScanning) return;
            
            const resultText = result.getText();
            const currentTime = Date.now();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã - –µ—Å–ª–∏ —Ç–æ—Ç –∂–µ –∫–æ–¥ –±—ã–ª –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω –º–µ–Ω–µ–µ 3 —Å–µ–∫—É–Ω–¥ –Ω–∞–∑–∞–¥
            if (lastScannedCode === resultText && (currentTime - lastScanTime) < 3000) {
                console.log('–î—É–±–ª–∏–∫–∞—Ç –∫–æ–¥–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', resultText);
                addLog(`–î—É–±–ª–∏–∫–∞—Ç –∫–æ–¥–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º: ${resultText}`, 'warning');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–¥–µ
            lastScannedCode = resultText;
            lastScanTime = currentTime;
            
            console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', result);
            addLog(`–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ${resultText}`, 'info');
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—É—é –∏–Ω–¥–∏–∫–∞—Ü–∏—é —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
            const overlay = document.getElementById('scanner-overlay');
            const scanStatus = document.getElementById('scan-status');
            if (overlay) {
                // –ù–∞—Ö–æ–¥–∏–º —Ä–∞–º–∫—É –≤–Ω—É—Ç—Ä–∏ overlay
                const frame = overlay.querySelector('div[class*="border-green-400"]');
                const background = overlay.querySelector('div[class*="bg-green-400"]');
                
                if (frame) {
                    frame.style.borderColor = '#10B981'; // –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç
                }
                if (background) {
                    background.style.backgroundColor = 'rgba(16, 185, 129, 0.3)'; // –ë–æ–ª–µ–µ —è—Ä–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞
                }
            }
            if (scanStatus) {
                scanStatus.textContent = '‚úì –ù–∞–π–¥–µ–Ω–æ!';
                scanStatus.className = 'absolute top-4 left-1/2 transform -translate-x-1/2 px-3 py-1 bg-green-600 text-white text-xs rounded-full font-medium';
            }
            
            setTimeout(() => {
                if (overlay) {
                    const frame = overlay.querySelector('div[class*="border-green-400"]');
                    const background = overlay.querySelector('div[class*="bg-green-400"]');
                    
                    if (frame) {
                        frame.style.borderColor = '#10B981';
                    }
                    if (background) {
                        background.style.backgroundColor = 'rgba(16, 185, 129, 0.2)'; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—ã—á–Ω—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É
                    }
                }
                if (scanStatus) {
                    scanStatus.textContent = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...';
                    scanStatus.className = 'absolute top-4 left-1/2 transform -translate-x-1/2 px-3 py-1 bg-green-600 text-white text-xs rounded-full font-medium hidden';
                }
            }, 2000);
            
            scanStats.total++;
            
            const format = result.getBarcodeFormat();
            
            console.log('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:', resultText, '–§–æ—Ä–º–∞—Ç:', format);
            
            // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –∫–æ–¥–∞
            let codeType = 'unknown';
            if (format === 'QR_CODE') {
                codeType = 'qr';
                scanStats.qr++;
            } else if (format === 'DATA_MATRIX') {
                codeType = 'datamatrix';
                scanStats.datamatrix++;
            }
            
            scanStats.successful++;
            
            // –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            addScanResult(resultText, codeType, format);
            
            // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            updateScanStats();
            
            // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã —É–∂–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –º–æ–±–∏–ª—å–Ω–æ–º —Å–∫–∞–Ω–µ—Ä–µ
            if (!isMobile) {
                // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                isScanning = false;
                
                setTimeout(() => {
                    if (scanner) {
                        console.log('–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');
                        console.log('isMobile:', isMobile, 'isScanning:', isScanning);
                        
                        // –°–Ω–∞—á–∞–ª–∞ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–∫–∞–Ω–µ—Ä
                        try {
                            scanner.reset();
                        } catch (e) {
                            console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ —Å–∫–∞–Ω–µ—Ä–∞:', e);
                        }
                        
                        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥–∏ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
                        isScannerInitialized = false;
                        
                        // –í–∫–ª—é—á–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞—Ç–Ω–æ
                        isScanning = true;
                        
                        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä –¥–ª—è –ü–ö
                        initQRScanner();
                    }
                }, 2000);
            } else {
                console.log('–ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ –º–æ–±–∏–ª—å–Ω–æ–º —Å–∫–∞–Ω–µ—Ä–µ');
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                isCameraStarting = false;
                console.log('–§–ª–∞–≥ isCameraStarting —Å–±—Ä–æ—à–µ–Ω –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        function addScanResult(text, type, format) {
            const resultsContainer = document.getElementById('scan-results');
            if (!resultsContainer) return;
            
            // –£–¥–∞–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –µ—Å–ª–∏ –µ—Å—Ç—å
            const placeholder = resultsContainer.querySelector('.text-center');
            if (placeholder) {
                placeholder.remove();
            }
            
            // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –Ω–∞–±–æ—Ä –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –ø–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∫–æ–¥—É
            console.log('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:', text);
            console.log('FIG_CODE_MAP –¥–æ—Å—Ç—É–ø–µ–Ω:', !!window.FIG_CODE_MAP);
            console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ FIG_CODE_MAP:', window.FIG_CODE_MAP ? Object.keys(window.FIG_CODE_MAP).length : 0);
            
            const figId = getMinifigIdFromScanCode(text);
            let setData = null;
            
            if (figId) {
                setData = findMinifigSetByFigId(figId);
                console.log('–ù–∞–π–¥–µ–Ω ID –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏:', figId, '–ù–∞–±–æ—Ä:', setData);
            } else {
                console.log('ID –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∫–æ–¥–∞:', text);
            }
            
            if (setData) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–µ—Ç–∫–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
                let gridContainer = resultsContainer.querySelector('.sets-minifigs-grid');
                if (!gridContainer) {
                    // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                    gridContainer = document.createElement('div');
                    gridContainer.className = 'sets-minifigs-grid';
                    resultsContainer.appendChild(gridContainer);
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ –Ω–∞—á–∞–ª–æ —Å–µ—Ç–∫–∏
                const cardElement = document.createElement('div');
                cardElement.innerHTML = renderMinifigSetCardForScanner(setData, figId);
                gridContainer.insertBefore(cardElement.firstElementChild, gridContainer.firstChild);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                const card = cardElement.firstElementChild;
                if (card) {
                    card.addEventListener('click', () => {
                        openModalForSet(setData.set_num);
                    });
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
                updateScanResultsVisibility();
            } else {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –Ω–∞–±–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç)
                if (resultsContainer.children.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="text-center text-gray-400 py-8">
                            <div class="text-3xl mb-2">‚ùå</div>
                            <p class="text-lg font-medium mb-2">–ù–∞–±–æ—Ä –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
                            <p class="text-sm">–ö–æ–¥: ${text}</p>
                            <p class="text-xs mt-2">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –∫–æ–¥</p>
                        </div>
                    `;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–∞–±–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
                    updateScanResultsVisibility();
                }
            }
        }
        
        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏
        function testMinifigScanning() {
            console.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–∫–∏...');
            
            // –¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥ –∏–∑ figtable.txt (6568967 -> 71050-9)
            const testCode = '6568967';
            
            console.log('–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥:', testCode);
            console.log('FIG_CODE_MAP –¥–æ—Å—Ç—É–ø–µ–Ω:', !!window.FIG_CODE_MAP);
            console.log('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ FIG_CODE_MAP:', window.FIG_CODE_MAP ? Object.keys(window.FIG_CODE_MAP).length : 0);
            
            if (window.FIG_CODE_MAP && Object.keys(window.FIG_CODE_MAP).length > 0) {
                console.log('–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–æ–≤ –≤ FIG_CODE_MAP:', Object.keys(window.FIG_CODE_MAP).slice(0, 5));
                console.log('–ü–æ–∏—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –∫–æ–¥–∞:', window.FIG_CODE_MAP[testCode]);
                
                // –°–∏–º—É–ª–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                const mockResult = {
                    getText: () => testCode,
                    getBarcodeFormat: () => 'DATA_MATRIX'
                };
                
                addLog(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–æ–¥–æ–º: ${testCode}`, 'info');
                handleScanResult(mockResult);
            } else {
                console.error('FIG_CODE_MAP –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–ª–∏ –ø—É—Å—Ç');
                addLog('–û—à–∏–±–∫–∞: FIG_CODE_MAP –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                alert('–û—à–∏–±–∫–∞: –¢–∞–±–ª–∏—Ü–∞ –º–∏–Ω–∏—Ñ–∏–≥—É—Ä–æ–∫ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            }
        }
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –±–ª–æ–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function updateScanResultsVisibility() {
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è"
            const resultsBlock = Array.from(document.querySelectorAll('h3')).find(h3 => 
                h3.textContent.includes('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è')
            )?.closest('.bg-gradient-to-br');
            
            const resultsContainer = document.getElementById('scan-results');
            
            if (!resultsBlock || !resultsContainer) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–Ω–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä)
            const hasResults = resultsContainer.children.length > 0 && 
                              !resultsContainer.querySelector('.text-center.text-gray-400');
            
            if (hasResults) {
                resultsBlock.style.display = 'block';
            } else {
                resultsBlock.style.display = 'none';
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function clearScanResults() {
            const resultsContainer = document.getElementById('scan-results');
            if (!resultsContainer) return;
            
            resultsContainer.innerHTML = `
                <div class="text-center text-gray-400 py-8">
                    <div class="text-3xl mb-2">${I_Search('w-12 h-12')}</div>
                    <p>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                </div>
            `;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
            updateScanResultsVisibility();
            
            addLog('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ—á–∏—â–µ–Ω—ã', 'info');
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã
        function showCameraSelectionModal() {
            const modal = document.getElementById('camera-selection-modal');
            if (!modal) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
            const savedSettings = loadDataMatrixCameraSettings();
            if (savedSettings && savedSettings.deviceId && savedSettings.resolution) {
                console.log('–ù–∞–π–¥–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã DataMatrix, –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É –Ω–∞–ø—Ä—è–º—É—é');
                addLog('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã', 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                const cameraSelect = document.getElementById('camera-select');
                const resolutionSelect = document.getElementById('resolution-select');
                
                if (cameraSelect && resolutionSelect) {
                    cameraSelect.value = savedSettings.deviceId;
                    resolutionSelect.value = savedSettings.resolution;
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                    setTimeout(() => {
                        startCamera();
                    }, 100);
                    return;
                }
            }
            
            // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            loadCamerasIntoModal();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            modal.classList.remove('modal-hidden');
            document.body.classList.add('overflow-hidden');
            requestAnimationFrame(() => {
                modal.classList.add('visible');
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                setTimeout(() => {
                    if (window.setupCameraScrollProgress) {
                        window.setupCameraScrollProgress();
                    }
                }, 100);
            });
        }
        
        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã
        function hideCameraSelectionModal() {
            const modal = document.getElementById('camera-selection-modal');
            if (!modal) return;
            
            modal.classList.add('modal-hidden');
            modal.classList.remove('visible');
            document.body.classList.remove('overflow-hidden');
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        async function loadCamerasIntoModal() {
            const modalSelect = document.getElementById('modal-camera-select');
            const modalResolutionSelect = document.getElementById('modal-resolution-select');
            
            if (!modalSelect || !modalResolutionSelect) return;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            detectMobile();
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            modalSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</option>';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                modalSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–º–µ—Ä—ã
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    let label = device.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–∞–º–µ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    if (isMobile) {
                        if (label.toLowerCase().includes('back') || label.toLowerCase().includes('rear')) {
                            label += ' (–ó–∞–¥–Ω—è—è)';
                        } else if (label.toLowerCase().includes('front') || label.toLowerCase().includes('selfie')) {
                            label += ' (–ü–µ—Ä–µ–¥–Ω—è—è)';
                        }
                    }
                    
                    option.textContent = label;
                    modalSelect.appendChild(option);
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –∫–∞–º–µ—Ä—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                if (isMobile && videoDevices.length > 0) {
                    // –ò—â–µ–º –∫–∞–º–µ—Ä—É 0
                    let camera0 = videoDevices.find(device => 
                        device.label.toLowerCase().includes('camera 0')
                    );
                    
                    if (!camera0) {
                        camera0 = videoDevices.find(device => device.deviceId === '0');
                    }
                    
                    if (!camera0) {
                        camera0 = videoDevices.find(device => 
                            device.label.toLowerCase().includes('facing back') ||
                            device.label.toLowerCase().includes('back')
                        );
                    }
                    
                    if (camera0) {
                        modalSelect.value = camera0.deviceId;
                        console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', camera0.label);
                    } else {
                        modalSelect.value = videoDevices[0].deviceId;
                        console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', videoDevices[0].label);
                    }
                } else if (videoDevices.length > 0) {
                    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Ç–æ–∂–µ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞–º–µ—Ä—É
                    modalSelect.value = videoDevices[0].deviceId;
                    console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞:', videoDevices[0].label);
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                modalResolutionSelect.value = '1280x1280';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä:', error);
                modalSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä</option>';
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–∞–º–µ—Ä—ã
        function updateCameraInterface() {
            const cameraSelect = document.getElementById('camera-select');
            const resolutionSelect = document.getElementById('resolution-select');
            const video = document.getElementById('scanner-video');
            const placeholder = document.getElementById('scanner-placeholder');
            
            if (cameraSelect && cameraSelect.value) {
                const selectedOption = cameraSelect.options[cameraSelect.selectedIndex];
                const cameraName = selectedOption ? selectedOption.text : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞–º–µ—Ä–∞';
                console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–∞–º–µ—Ä—ã:', cameraName);
                addLog(`–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∫–∞–º–µ—Ä—ã: ${cameraName}`, 'info');
            }
            
            if (resolutionSelect && resolutionSelect.value) {
                console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', resolutionSelect.value);
                addLog(`–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: ${resolutionSelect.value}`, 'info');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞–º–µ—Ä–µ
            if (placeholder) {
                const cameraSelect = document.getElementById('camera-select');
                if (cameraSelect && cameraSelect.value) {
                    const selectedOption = cameraSelect.options[cameraSelect.selectedIndex];
                    const cameraName = selectedOption ? selectedOption.text : '–í—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞';
                    placeholder.innerHTML = `
                        <div class="text-center text-gray-400 px-4">
                            <div class="text-4xl sm:text-5xl mb-3">${I_Scanner('w-12 h-12 mx-auto')}</div>
                            <p class="text-sm sm:text-base font-medium mb-2">–ö–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∑–∞–ø—É—Å–∫—É</p>
                            <p class="text-xs sm:text-sm text-gray-500">${cameraName}</p>
                            <p class="text-xs sm:text-sm text-gray-500">${resolutionSelect ? resolutionSelect.value : '–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ'}</p>
                        </div>
                    `;
                }
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã
        function setupCameraModalHandlers() {
            const modal = document.getElementById('camera-selection-modal');
            const closeBtn = document.getElementById('close-camera-modal');
            const cancelBtn = document.getElementById('modal-cancel');
            const startBtn = document.getElementById('modal-start-camera');
            const modalCameraSelect = document.getElementById('modal-camera-select');
            const modalResolutionSelect = document.getElementById('modal-resolution-select');
            
            if (closeBtn) {
                closeBtn.addEventListener('click', hideCameraSelectionModal);
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideCameraSelectionModal);
            }
            
            if (startBtn) {
                startBtn.addEventListener('click', () => {
                    // –ö–æ–ø–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                    const mainCameraSelect = document.getElementById('camera-select');
                    const mainResolutionSelect = document.getElementById('resolution-select');
                    
                    if (mainCameraSelect && modalCameraSelect.value) {
                        mainCameraSelect.value = modalCameraSelect.value;
                        console.log('–ö–∞–º–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ:', modalCameraSelect.value);
                        addLog(`–ö–∞–º–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞: ${modalCameraSelect.options[modalCameraSelect.selectedIndex].text}`, 'info');
                    }
                    
                    if (mainResolutionSelect && modalResolutionSelect.value) {
                        mainResolutionSelect.value = modalResolutionSelect.value;
                        console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–æ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ:', modalResolutionSelect.value);
                        addLog(`–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–æ: ${modalResolutionSelect.value}`, 'info');
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
                    if (modalCameraSelect.value && modalResolutionSelect.value) {
                        saveDataMatrixCameraSettings(modalCameraSelect.value, modalResolutionSelect.value);
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞–º–µ—Ä—ã
                    updateCameraInterface();
                    
                    // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    hideCameraSelectionModal();
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
                    setTimeout(() => {
                        console.log('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞...');
                        addLog('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫...', 'info');
                        startCamera();
                    }, 100);
                });
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        hideCameraSelectionModal();
                    }
                });
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function updateScanStats() {
            const totalEl = document.getElementById('total-scans');
            const successfulEl = document.getElementById('successful-scans');
            const qrEl = document.getElementById('qr-scans');
            const datamatrixEl = document.getElementById('datamatrix-scans');
            
            if (totalEl) totalEl.textContent = scanStats.total;
            if (successfulEl) successfulEl.textContent = scanStats.successful;
            if (qrEl) qrEl.textContent = scanStats.qr;
            if (datamatrixEl) datamatrixEl.textContent = scanStats.datamatrix;
        }
        
        // –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫
        function capturePhoto() {
            const video = document.getElementById('scanner-video');
            const canvas = document.getElementById('scanner-canvas');
            
            if (!video || !canvas) return;
            
            const context = canvas.getContext('2d');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è canvas
            const size = 320; // –†–∞–∑–º–µ—Ä –∫–≤–∞–¥—Ä–∞—Ç–∞
            canvas.width = size;
            canvas.height = size;
            
            // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è –æ–±—Ä–µ–∑–∫–∏ –≤–∏–¥–µ–æ –¥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞
            const videoAspect = video.videoWidth / video.videoHeight;
            let sourceX = 0;
            let sourceY = 0;
            let sourceWidth = video.videoWidth;
            let sourceHeight = video.videoHeight;
            
            if (videoAspect > 1) {
                // –í–∏–¥–µ–æ —à–∏—Ä–µ, –æ–±—Ä–µ–∑–∞–µ–º –ø–æ –±–æ–∫–∞–º
                sourceWidth = video.videoHeight;
                sourceX = (video.videoWidth - sourceWidth) / 2;
            } else {
                // –í–∏–¥–µ–æ –≤—ã—à–µ, –æ–±—Ä–µ–∑–∞–µ–º —Å–≤–µ—Ä—Ö—É –∏ —Å–Ω–∏–∑—É
                sourceHeight = video.videoWidth;
                sourceY = (video.videoHeight - sourceHeight) / 2;
            }
            
            // –†–∏—Å—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç–Ω—É—é –æ–±–ª–∞—Å—Ç—å –∏–∑ —Ü–µ–Ω—Ç—Ä–∞ –≤–∏–¥–µ–æ
            context.drawImage(video, sourceX, sourceY, sourceWidth, sourceHeight, 0, 0, size, size);
            
            // –ü–æ–∫–∞–∑–∞—Ç—å canvas –∏ —Å–∫—Ä—ã—Ç—å video
            canvas.classList.remove('hidden');
            video.classList.add('hidden');
            
            // –ß–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –≤–µ—Ä–Ω—É—Ç—å video
            setTimeout(() => {
                canvas.classList.add('hidden');
                video.classList.remove('hidden');
            }, 3000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∞–Ω–µ—Ä–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞
        document.addEventListener('DOMContentLoaded', function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∫–∞–Ω–µ—Ä –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            if (S.view === 'tools' && S.toolSubView === 'scanner') {
                setTimeout(initScanner, 100);
            }
            
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ DOM –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∫–∞–Ω–µ—Ä–∞
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        const scannerContent = document.querySelector('#scanner-video');
                        if (scannerContent && S.view === 'tools' && S.toolSubView === 'scanner' && !isScannerInitialized) {
                            setTimeout(initScannerOnViewChange, 100);
                        }
                    }
                });
            });
            
            // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            const mainContainer = document.getElementById('main');
            if (mainContainer) {
                observer.observe(mainContainer, { childList: true, subtree: true });
            }
        });
        
        // ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ü–û–ò–°–ö–ê –î–ï–¢–ê–õ–ï–ô –ü–û –§–û–¢–û ==========
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        let photoSearchStream = null;
        let photoSearchInitialized = false;
        let isPhotoCameraStarting = false;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        async function setupPhotoSearchCamera() {
            const cameraSelect = document.getElementById('photo-camera-select');
            if (!cameraSelect) {
                console.error('–≠–ª–µ–º–µ–Ω—Ç photo-camera-select –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
            detectMobile();
            
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                cameraSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–º–µ—Ä—ã
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    let label = device.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–∞–º–µ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    if (isMobile) {
                        if (label.toLowerCase().includes('back') || label.toLowerCase().includes('rear')) {
                            label += ' (–ó–∞–¥–Ω—è—è)';
                        } else if (label.toLowerCase().includes('front') || label.toLowerCase().includes('selfie')) {
                            label += ' (–ü–µ—Ä–µ–¥–Ω—è—è)';
                        }
                    }
                    
                    option.textContent = label;
                    cameraSelect.appendChild(option);
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –∫–∞–º–µ—Ä—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                if (isMobile && videoDevices.length > 0) {
                    // –ò—â–µ–º –∫–∞–º–µ—Ä—É 0
                    let camera0 = videoDevices.find(device => 
                        device.label.toLowerCase().includes('camera 0')
                    );
                    
                    if (!camera0) {
                        camera0 = videoDevices.find(device => device.deviceId === '0');
                    }
                    
                    if (!camera0) {
                        camera0 = videoDevices.find(device => 
                            device.label.toLowerCase().includes('facing back') ||
                            device.label.toLowerCase().includes('back')
                        );
                    }
                    
                    if (camera0) {
                        cameraSelect.value = camera0.deviceId;
                        console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', camera0.label);
                    } else {
                        cameraSelect.value = videoDevices[0].deviceId;
                        console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', videoDevices[0].label);
                    }
                } else if (videoDevices.length > 0) {
                    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Ç–æ–∂–µ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞–º–µ—Ä—É
                    cameraSelect.value = videoDevices[0].deviceId;
                    console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞:', videoDevices[0].label);
                }
                
                console.log(`–ù–∞–π–¥–µ–Ω–æ ${videoDevices.length} –∫–∞–º–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ`);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä:', error);
            }
        }
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        function setupPhotoSearchEventListeners() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –∫–∞–º–µ—Ä—ã
            const requestPermissionBtn = document.getElementById('photo-request-permission');
            const startCameraBtn = document.getElementById('photo-start-camera');
            const stopCameraBtn = document.getElementById('photo-stop-camera');
            const capturePhotoBtn = document.getElementById('capture-photo');
            const clearResultsBtn = document.getElementById('clear-photo-results');
            
            if (requestPermissionBtn) {
                requestPermissionBtn.addEventListener('click', requestPhotoSearchPermission);
            }
            
            if (startCameraBtn) {
                startCameraBtn.addEventListener('click', startPhotoSearchCamera);
            }
            
            if (stopCameraBtn) {
                stopCameraBtn.addEventListener('click', stopPhotoSearchCamera);
            }
            
            if (capturePhotoBtn) {
                capturePhotoBtn.addEventListener('click', capturePhotoForSearch);
            }
            
            if (clearResultsBtn) {
                clearResultsBtn.addEventListener('click', clearPhotoSearchResults);
            }
            
            if (testApiBtn) {
                testApiBtn.addEventListener('click', testBrickognizeConnection);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const cameraSelect = document.getElementById('photo-camera-select');
            const endpointInput = document.getElementById('brickognize-endpoint');
            const apiKeyInput = document.getElementById('brickognize-api-key');
            
            if (cameraSelect) {
                cameraSelect.addEventListener('change', onPhotoSearchCameraChange);
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Å–∞–Ω–∏—è –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            const video = document.getElementById('photo-search-video');
            if (video) {
                video.addEventListener('touchstart', () => {
                    if (!photoSearchStream && !isPhotoCameraStarting) {
                        console.log('–ö–∞—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ...');
                        showPhotoCameraSelectionModal();
                    }
                });
                
                // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞
                video.addEventListener('click', () => {
                    if (!photoSearchStream && !isPhotoCameraStarting) {
                        console.log('–ö–ª–∏–∫ –ø–æ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç—É, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ...');
                        showPhotoCameraSelectionModal();
                    }
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è placeholder —ç–ª–µ–º–µ–Ω—Ç–∞
            const placeholder = document.getElementById('photo-search-placeholder');
            if (placeholder) {
                placeholder.addEventListener('click', () => {
                    if (!photoSearchStream && !isPhotoCameraStarting) {
                        console.log('–ö–ª–∏–∫ –ø–æ placeholder, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ...');
                        showPhotoCameraSelectionModal();
                    }
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–º–µ—Ä
            const refreshCamerasBtn = document.getElementById('photo-refresh-cameras');
            if (refreshCamerasBtn) {
                refreshCamerasBtn.addEventListener('click', refreshPhotoSearchCameras);
            }
            
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        async function refreshPhotoSearchCameras() {
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ...');
            addLog('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä...', 'info');
            
            try {
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä
                await setupPhotoSearchCamera();
                console.log('–°–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω');
                addLog('–°–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä:', error);
                addLog(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –∫–∞–º–µ—Ä: ${error.message}`, 'error');
            }
        }
        
        // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–º–µ—Ä—É
        async function requestPhotoSearchPermission() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                stream.getTracks().forEach(track => track.stop());
                console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É –ø–æ–ª—É—á–µ–Ω–æ');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä
                await setupPhotoSearchCamera();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', error);
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        async function startPhotoSearchCamera() {
            // –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
            if (isPhotoCameraStarting) {
                console.log('–ö–∞–º–µ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ —É–∂–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º...');
                    return;
                }
                
            isPhotoCameraStarting = true;
            
            const cameraSelect = document.getElementById('photo-camera-select');
            const resolutionSelect = document.getElementById('photo-resolution-select');
            const video = document.getElementById('photo-search-video');
            const placeholder = document.getElementById('photo-search-placeholder');
                
            if (!cameraSelect || !resolutionSelect || !video || !placeholder) {
                console.error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã');
                isPhotoCameraStarting = false;
                return;
            }
                
            const deviceId = cameraSelect.value;
            if (!deviceId) {
                isPhotoCameraStarting = false;
                return;
            }
            
            const resolution = resolutionSelect.value.split('x');
            const width = parseInt(resolution[0]);
            const height = parseInt(resolution[1]);
            
            try {
                const constraints = {
                    video: {
                        deviceId: { exact: deviceId },
                        width: { ideal: width },
                        height: { ideal: height }
                    }
                };
                
                photoSearchStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = photoSearchStream;
                
                video.onloadedmetadata = () => {
                    video.play();
                    video.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å –æ–≤–µ—Ä–ª–µ–π —Å —Ä–∞–º–∫–æ–π
                    const overlay = document.getElementById('photo-search-overlay');
                    if (overlay) {
                        overlay.classList.remove('hidden');
                    }
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∑–∞—Ö–≤–∞—Ç–∞
                const captureBtn = document.getElementById('capture-photo');
                    if (captureBtn) {
                        captureBtn.disabled = false;
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                    updatePhotoSearchButtons(true);
                };
                
                console.log('–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ');
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã:', error);
            } finally {
                isPhotoCameraStarting = false;
            }
        }
        
        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–º–µ—Ä—ã
        function stopPhotoSearchCamera() {
            if (photoSearchStream) {
                photoSearchStream.getTracks().forEach(track => track.stop());
                photoSearchStream = null;
            }
            
            const video = document.getElementById('photo-search-video');
            const placeholder = document.getElementById('photo-search-placeholder');
            const captureBtn = document.getElementById('capture-photo');
            
            if (video) {
                video.classList.add('hidden');
                video.srcObject = null;
            }
            
            if (placeholder) {
                placeholder.classList.remove('hidden');
            }
            
            // –°–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∫–∞–º–µ—Ä—ã
            const overlay = document.getElementById('photo-search-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
            
            if (captureBtn) {
                captureBtn.disabled = true;
            }
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã
            isPhotoCameraStarting = false;
            
            updatePhotoSearchButtons(false);
            console.log('–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫
        function updatePhotoSearchButtons(cameraActive) {
            const startBtn = document.getElementById('photo-start-camera');
            const stopBtn = document.getElementById('photo-stop-camera');
            
            if (startBtn) {
                startBtn.disabled = cameraActive;
            }
            
            if (stopBtn) {
                stopBtn.disabled = !cameraActive;
            }
        }
        
        // ===== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –ü–û–ò–°–ö–ê –ü–û –§–û–¢–û =====
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        function showPhotoCameraSelectionModal() {
            const modal = document.getElementById('photo-camera-selection-modal');
            if (!modal) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
            const savedSettings = loadPhotoCameraSettings();
            if (savedSettings && savedSettings.deviceId && savedSettings.resolution) {
                console.log('–ù–∞–π–¥–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É –Ω–∞–ø—Ä—è–º—É—é');
                addLog('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã AI –ø–æ–∏—Å–∫–∞', 'info');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                const cameraSelect = document.getElementById('photo-camera-select');
                const resolutionSelect = document.getElementById('photo-resolution-select');
                
                if (cameraSelect && resolutionSelect) {
                    cameraSelect.value = savedSettings.deviceId;
                    resolutionSelect.value = savedSettings.resolution;
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                    setTimeout(() => {
                        startPhotoSearchCamera();
                    }, 100);
                    return;
                }
            }
            
            // –ï—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            setupPhotoCameraModalHandlers();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            loadPhotoCamerasIntoModal();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
            modal.classList.remove('modal-hidden');
            document.body.classList.add('overflow-hidden');
            requestAnimationFrame(() => {
                modal.classList.add('visible');
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –ø–æ—Å–ª–µ –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                setTimeout(() => {
                    if (window.setupPhotoCameraScrollProgress) {
                        window.setupPhotoCameraScrollProgress();
                    }
                }, 100);
            });
        }
        
        // –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        function hidePhotoCameraSelectionModal() {
            const modal = document.getElementById('photo-camera-selection-modal');
            if (!modal) return;
            
            modal.classList.add('modal-hidden');
            modal.classList.remove('visible');
            document.body.classList.remove('overflow-hidden');
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –≤ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        async function loadPhotoCamerasIntoModal() {
            const modalSelect = document.getElementById('photo-modal-camera-select');
            const modalResolutionSelect = document.getElementById('photo-modal-resolution-select');
            
            if (!modalSelect || !modalResolutionSelect) return;
            
            // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
            modalSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞–º–µ—Ä...</option>';
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
                modalSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–µ—Ä—É...</option>';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–º–µ—Ä—ã
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    let label = device.label || `–ö–∞–º–µ—Ä–∞ ${index + 1}`;
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–∞–º–µ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                    if (isMobile) {
                        if (label.toLowerCase().includes('back') || label.toLowerCase().includes('rear')) {
                            label += ' (–ó–∞–¥–Ω—è—è)';
                        } else if (label.toLowerCase().includes('front') || label.toLowerCase().includes('selfie')) {
                            label += ' (–ü–µ—Ä–µ–¥–Ω—è—è)';
                        }
                    }
                    
                    option.textContent = label;
                    modalSelect.appendChild(option);
                });
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –∫–∞–º–µ—Ä—É –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                if (isMobile && videoDevices.length > 0) {
                    // –ò—â–µ–º –∫–∞–º–µ—Ä—É 0
                    let camera0 = videoDevices.find(device => 
                        device.label.toLowerCase().includes('camera 0')
                    );
                    
                    if (!camera0) {
                        camera0 = videoDevices.find(device => device.deviceId === '0');
                    }
                    
                    if (!camera0) {
                        camera0 = videoDevices.find(device => 
                            device.label.toLowerCase().includes('facing back') ||
                            device.label.toLowerCase().includes('back')
                        );
                    }
                    
                    if (camera0) {
                        modalSelect.value = camera0.deviceId;
                        console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', camera0.label);
                    } else {
                        modalSelect.value = videoDevices[0].deviceId;
                        console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', videoDevices[0].label);
                    }
                } else if (videoDevices.length > 0) {
                    // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Ç–æ–∂–µ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞–º–µ—Ä—É
                    modalSelect.value = videoDevices[0].deviceId;
                    console.log('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–∞ –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞–º–µ—Ä–∞ –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞:', videoDevices[0].label);
                }
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                modalResolutionSelect.value = '1280x1280';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä:', error);
                modalSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–µ—Ä</option>';
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—ã–±–æ—Ä–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        function setupPhotoCameraModalHandlers() {
            const modal = document.getElementById('photo-camera-selection-modal');
            const closeBtn = document.getElementById('close-photo-camera-modal');
            const startBtn = document.getElementById('photo-modal-start-camera');
            const modalCameraSelect = document.getElementById('photo-modal-camera-select');
            const modalResolutionSelect = document.getElementById('photo-modal-resolution-select');
            
            console.log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ...');
            console.log('Modal:', modal);
            console.log('CloseBtn:', closeBtn);
            console.log('StartBtn:', startBtn);
            
            if (closeBtn) {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                closeBtn.removeEventListener('click', hidePhotoCameraSelectionModal);
                closeBtn.addEventListener('click', hidePhotoCameraSelectionModal);
                console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –¥–æ–±–∞–≤–ª–µ–Ω');
            }
            
            if (startBtn) {
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                startBtn.removeEventListener('click', handlePhotoModalStart);
                startBtn.addEventListener('click', handlePhotoModalStart);
                console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—É—Å–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω');
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
            if (modal) {
                modal.removeEventListener('click', handlePhotoModalBackgroundClick);
                modal.addEventListener('click', handlePhotoModalBackgroundClick);
                console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω');
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function handlePhotoModalStart() {
            const modalCameraSelect = document.getElementById('photo-modal-camera-select');
            const modalResolutionSelect = document.getElementById('photo-modal-resolution-select');
            
            // –ö–æ–ø–∏—Ä—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
            const mainCameraSelect = document.getElementById('photo-camera-select');
            const mainResolutionSelect = document.getElementById('photo-resolution-select');
            
            if (mainCameraSelect && modalCameraSelect && modalCameraSelect.value) {
                mainCameraSelect.value = modalCameraSelect.value;
                console.log('–ö–∞–º–µ—Ä–∞ –≤—ã–±—Ä–∞–Ω–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ:', modalCameraSelect.value);
            }
            
            if (mainResolutionSelect && modalResolutionSelect && modalResolutionSelect.value) {
                mainResolutionSelect.value = modalResolutionSelect.value;
                console.log('–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–æ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ:', modalResolutionSelect.value);
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã
            if (modalCameraSelect && modalCameraSelect.value && modalResolutionSelect && modalResolutionSelect.value) {
                savePhotoCameraSettings(modalCameraSelect.value, modalResolutionSelect.value);
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            hidePhotoCameraSelectionModal();
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∫–∞–º–µ—Ä—É
            setTimeout(() => {
                console.log('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞...');
                startPhotoSearchCamera();
            }, 100);
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ —Ñ–æ–Ω—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function handlePhotoModalBackgroundClick(e) {
            if (e.target.id === 'photo-camera-selection-modal') {
                hidePhotoCameraSelectionModal();
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
        function onPhotoSearchCameraChange() {
            // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –µ—ë —Å –Ω–æ–≤–æ–π –∫–∞–º–µ—Ä–æ–π
            if (photoSearchStream) {
                stopPhotoSearchCamera();
                setTimeout(startPhotoSearchCamera, 100);
            }
        }
        
        // –ó–∞—Ö–≤–∞—Ç —Ñ–æ—Ç–æ –¥–ª—è –ø–æ–∏—Å–∫–∞
        async function capturePhotoForSearch() {
            const video = document.getElementById('photo-search-video');
            const canvas = document.getElementById('photo-search-canvas');
            const overlay = document.getElementById('photo-search-overlay');
            const statusEl = document.getElementById('photo-capture-status');
            
            if (!video || !canvas || !photoSearchStream) {
                return;
            }
            
            try {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å (–æ–≤–µ—Ä–ª–µ–π —É–∂–µ –≤–∏–¥–µ–Ω)
                if (statusEl) {
                    statusEl.classList.remove('hidden');
                    statusEl.textContent = '–ó–∞—Ö–≤–∞—Ç —Ñ–æ—Ç–æ...';
                    statusEl.className = 'absolute top-4 left-1/2 transform -translate-x-1/2 px-3 py-1 bg-blue-600 text-white text-xs rounded-full font-medium';
                }
                
                // –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∫–∞–¥—Ä
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0);
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ base64
                const imageData = canvas.toDataURL('image/jpeg', 0.8);
                
                if (statusEl) {
                    statusEl.textContent = '–ê–Ω–∞–ª–∏–∑...';
                    statusEl.className = 'absolute top-4 left-1/2 transform -translate-x-1/2 px-3 py-1 bg-blue-600 text-white text-xs rounded-full font-medium';
                }
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –∞–Ω–∞–ª–∏–∑
                await searchLegoPartsInPhoto(imageData);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ —Ñ–æ—Ç–æ:', error);
            } finally {
                // –°–∫—Ä—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É, –æ–≤–µ—Ä–ª–µ–π –æ—Å—Ç–∞–≤–ª—è–µ–º –≤–∏–¥–∏–º—ã–º
                setTimeout(() => {
                    if (statusEl) {
                        statusEl.classList.add('hidden');
                        statusEl.className = 'absolute top-4 left-1/2 transform -translate-x-1/2 px-3 py-1 bg-blue-600 text-white text-xs rounded-full font-medium hidden';
                    }
                }, 1000);
            }
        }
        
        // –ü–æ–∏—Å–∫ –¥–µ—Ç–∞–ª–µ–π LEGO –ø–æ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ API Brickognize
        async function searchLegoPartsInPhoto(imageData) {
            const endpoint = document.getElementById('brickognize-endpoint')?.value || 'https://api.brickognize.com';
            const apiKey = document.getElementById('brickognize-api-key')?.value;
            
            try {
                // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å data:image/jpeg;base64,
                const base64Image = imageData.replace(/^data:image\/[a-z]+;base64,/, '');
                
                // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞
                const formData = new FormData();
                
                // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 –≤ Blob
                const byteCharacters = atob(base64Image);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'image/jpeg' });
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª –≤ FormData —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–º–µ–Ω–µ–º –ø–æ–ª—è
                formData.append('query_image', blob, 'photo.jpg');
                
                const headers = {};
                
                // –î–æ–±–∞–≤–ª—è–µ–º API –∫–ª—é—á –µ—Å–ª–∏ –µ—Å—Ç—å
                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }
                
                console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API Brickognize...');
                const response = await fetch(`${endpoint}/predict`, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('–û—à–∏–±–∫–∞ API:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', result);
                
                displayPhotoSearchResults(result);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ñ–æ—Ç–æ:', error);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                displayDemoResults();
            }
        }
        
        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–π –¥–µ—Ç–∞–ª–∏ –≤ —Å—Ç–∏–ª–µ –∫–∞—Ç–∞–ª–æ–≥–∞
        function renderUnknownPartCard(prediction, partNumber, confidence, index = 0) {
            const imageUrl = prediction.img_url || '';
            const partName = prediction.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –¥–µ—Ç–∞–ª—å';
            const category = prediction.category || 'LEGO';
            
            return `
                <div data-part-id="${partNumber}" class="part-card relative bg-gray-800 rounded-[18px] overflow-hidden group cursor-pointer" onclick="searchPartInCatalog('${partNumber}', '${category.replace(/'/g, "\\'")}', '${partName.replace(/'/g, "\\'")}')">
                    <div class="absolute top-3 right-3 bg-green-600 text-white text-xs font-bold rounded-full w-8 h-8 flex items-center justify-center z-10 shadow-md pointer-events-none">
                        ${confidence}%
                    </div>
                    <div class="w-full h-40 bg-gray-700 flex items-center justify-center p-2 rounded-t-lg card-image-container">
                        <div class="w-full h-full bg-white rounded-[18px] flex items-center justify-center overflow-hidden shadow-inner relative">
                            ${imageUrl ? `
                                <img src="${imageUrl}" 
                                     alt="${partName}" 
                                     class="w-full h-full object-contain pointer-events-none" 
                                     loading="lazy"
                                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                            ` : ''}
                            <div class="w-full h-full flex items-center justify-center text-gray-400 text-4xl" style="display: ${imageUrl ? 'none' : 'flex'};">
                                ${I_Brick('w-12 h-12')}
                            </div>
                        </div>
                    </div>
                    <div class="p-4 space-y-1 card-info-container">
                        <h3 class="text-sm font-semibold text-white truncate pointer-events-none card-title">${partName}</h3>
                        <p class="text-xs text-gray-400 pointer-events-none card-info-text">ID: ${partNumber}</p>
                        <p class="text-xs text-gray-500 pointer-events-none card-info-text">${category}</p>
                    </div>
                        </div>
                    `;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
        function displayPhotoSearchResults(results) {
            const resultsContainer = document.getElementById('photo-search-results');
            if (!resultsContainer) return;
            
            console.log('–û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:', results);
            
            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –æ—Ç–≤–µ—Ç–∞ –æ—Ç API
            let predictions = [];
            if (results.predictions) {
                predictions = results.predictions;
            } else if (results.results) {
                predictions = results.results;
            } else if (results.items) {
                predictions = results.items;
            } else if (Array.isArray(results)) {
                predictions = results;
            } else if (results.data && Array.isArray(results.data)) {
                predictions = results.data;
            }
            
            console.log('–ù–∞–π–¥–µ–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π:', predictions.length);
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ (–º–∏–Ω–∏–º—É–º 60%)
            const filteredPredictions = predictions.filter(prediction => {
                const confidence = prediction.confidence || prediction.score || prediction.probability || prediction.accuracy || 0;
                return confidence >= 0.6; // 60%
            });
            
            console.log('–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π (>=60%):', filteredPredictions.length);
            
            if (filteredPredictions.length === 0) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –≤ –ø–æ–ª–µ –∫–∞–º–µ—Ä—ã
                showCameraErrorMessage('–î–µ—Ç–∞–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å–µ—Ç–∫–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            let gridContainer = resultsContainer.querySelector('.sets-minifigs-grid');
            if (!gridContainer) {
                // –°–æ–∑–¥–∞–µ–º —Å–µ—Ç–∫—É –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
                gridContainer = document.createElement('div');
                gridContainer.className = 'sets-minifigs-grid';
                resultsContainer.appendChild(gridContainer);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –Ω–∞—á–∞–ª–æ —Å–µ—Ç–∫–∏ (–∫–∞–∫ –≤ —Å–∫–∞–Ω–µ—Ä–µ)
            filteredPredictions.forEach((prediction, index) => {
                const partNumber = prediction.part_num || prediction.part_number || prediction.part_id || prediction.id || prediction.element_id;
                
                // –ò—â–µ–º –¥–µ—Ç–∞–ª—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
                const partData = PART_MAP[partNumber];
                
                if (partData) {
                    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–µ—Ç–∞–ª–∏
                    const cardElement = document.createElement('div');
                    cardElement.innerHTML = renderPartCard(partData, null, 0, false, index);
                    gridContainer.insertBefore(cardElement.firstElementChild, gridContainer.firstChild);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    const card = cardElement.firstElementChild;
                    if (card) {
                        card.addEventListener('click', () => {
                            openModalForPart(partNumber);
                        });
                    }
                } else {
                    // –ï—Å–ª–∏ –¥–µ—Ç–∞–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ —Å—Ç–∏–ª–µ –∫–∞—Ç–∞–ª–æ–≥–∞
                    const confidence = Math.round((prediction.confidence || prediction.score || prediction.probability || prediction.accuracy || 0) * 100);
                    const cardElement = document.createElement('div');
                    cardElement.innerHTML = renderUnknownPartCard(prediction, partNumber, confidence, index);
                    gridContainer.insertBefore(cardElement.firstElementChild, gridContainer.firstChild);
                }
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            updatePhotoSearchResultsVisibility();
        }
        
        // –î–µ–º–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function displayDemoResults() {
            const demoResults = {
                predictions: [
                    {
                    part_num: '3001',
                        part_name: 'Brick 2 x 4',
                        color: 'Red',
                        color_hex: '#B40000',
                        confidence: 0.89
                    },
                    {
                        part_num: '3003',
                        part_name: 'Brick 2 x 2',
                        color: 'Blue',
                        color_hex: '#0D69AC',
                        confidence: 0.76
                    }
                ]
            };
            
            displayPhotoSearchResults(demoResults);
        }
        
        
        
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç—å—é –±–ª–æ–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
        function updatePhotoSearchResultsVisibility() {
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è"
            const resultsBlock = Array.from(document.querySelectorAll('h3')).find(h3 => 
                h3.textContent.includes('–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è')
            )?.closest('.bg-gradient-to-br');
            
            const resultsContainer = document.getElementById('photo-search-results');
            
            if (!resultsBlock || !resultsContainer) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–≤–∫–ª—é—á–∞—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤)
            const hasResults = resultsContainer.children.length > 0;
            
            if (hasResults) {
                resultsBlock.style.display = 'block';
            } else {
                resultsBlock.style.display = 'none';
            }
        }
        
        // –û—á–∏—Å—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        function clearPhotoSearchResults() {
            const resultsContainer = document.getElementById('photo-search-results');
            if (resultsContainer) {
                // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                resultsContainer.innerHTML = '';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –±–ª–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
            updatePhotoSearchResultsVisibility();
        }
        
        // –¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å API
        async function testBrickognizeConnection() {
            const endpoint = document.getElementById('brickognize-endpoint')?.value || 'https://api.brickognize.com';
            const apiKey = document.getElementById('brickognize-api-key')?.value;
            
            try {
                const headers = {};
                
                if (apiKey) {
                    headers['Authorization'] = `Bearer ${apiKey}`;
                }
                
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ endpoints –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                const testEndpoints = [
                    `${endpoint}/`,
                    `${endpoint}/docs`,
                    `${endpoint}/health`
                ];
                
                let success = false;
                for (const testUrl of testEndpoints) {
                    try {
                        const response = await fetch(testUrl, {
                            method: 'GET',
                            headers: headers
                        });
                        
                        if (response.ok) {
                            success = true;
                            break;
                        }
                    } catch (e) {
                        console.log(`Endpoint ${testUrl} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:`, e.message);
                    }
                }
                
                if (success) {
                } else {
                    throw new Error('–í—Å–µ endpoints –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å API:', error);
            }
        }
        
        
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ DOM –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞ –ø–æ —Ñ–æ—Ç–æ
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        const photoSearchContent = document.querySelector('#photo-search-video');
                        if (photoSearchContent && S.view === 'tools' && S.toolSubView === 'photo-search' && !photoSearchInitialized) {
                            setTimeout(initPhotoSearchOnViewChange, 100);
                            photoSearchInitialized = true;
                        }
                    }
                });
            });
            
            // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ
            const mainContainer = document.getElementById('main');
            if (mainContainer) {
                observer.observe(mainContainer, { childList: true, subtree: true });
            }
        });
        
        // ========== –ö–û–ù–ï–¶ –§–£–ù–ö–¶–ò–ô –î–õ–Ø –ü–û–ò–°–ö–ê –î–ï–¢–ê–õ–ï–ô –ü–û –§–û–¢–û ==========
        
  </script>
  
  <!-- –£–∫–∞–∑–∞—Ç–µ–ª—å –¥–ª—è sidebar-toggle –Ω–∞ –º–∞–ª—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö -->
  <div id="sidebar-hint" class="sidebar-hint hidden">
      <button class="sidebar-hint-close" id="sidebar-hint-close" title="–ó–∞–∫—Ä—ã—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É">√ó</button>
      <div class="sidebar-hint-icon">üì±</div>
      <div class="sidebar-hint-title">–ù–∞–≤–∏–≥–∞—Ü–∏—è</div>
      <div class="sidebar-hint-text">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</div>
  </div>

  <script>
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ hover –¥–ª—è –∫—Ä—É–≥–æ–≤—ã—Ö –¥–∏–∞–≥—Ä–∞–º–º
    function setupPieChartHover() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        const existingGroups = document.querySelectorAll('.pie-sector-group');
        existingGroups.forEach(group => {
            group.replaceWith(group.cloneNode(true));
        });
        
        const sectorGroups = document.querySelectorAll('.pie-sector-group');
        
        
        sectorGroups.forEach((group) => {
            const moveX = parseFloat(group.getAttribute('data-move-x'));
            const moveY = parseFloat(group.getAttribute('data-move-y'));
            const sectorIndex = group.getAttribute('data-sector-index');
            const key = group.getAttribute('data-key');
            
            if (!isNaN(moveX) && !isNaN(moveY) && sectorIndex !== null) {
                // –ù–∞—Ö–æ–¥–∏–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã
                const percentageGroup = document.querySelector(`.percentage-group[data-sector-index="${sectorIndex}"]`);
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ —Å–¥–≤–∏–≥–∏ –ø–æ –Ω–∞–≤–µ–¥–µ–Ω–∏—é ‚Äì –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ –Ω–µ –Ω—É–∂–µ–Ω
                group.onmouseenter = null;
                group.onmouseleave = null;
                
                // –°–≤—è–∑–∫–∞ —Å –ª–µ–≥–µ–Ω–¥–æ–π
                if (key) {
                    const legendItems = document.querySelectorAll(`[data-pie-key="${key}"]`);
                    legendItems.forEach(li => {
                        li.onmouseenter = null;
                        li.onmouseleave = null;
                    });
                }
            }
        });
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É hover-—ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
    document.addEventListener('DOMContentLoaded', setupPieChartHover);
    
    // –¢–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—à–±–æ—Ä–¥–∞
    if (typeof window !== 'undefined') {
        const originalCreateDashboard = window.createDashboard;
        if (originalCreateDashboard) {
            window.createDashboard = function(analytics) {
                const result = originalCreateDashboard(analytics);
                setTimeout(() => {
                    
                    setupPieChartHover();
                }, 100);
                return result;
            };
        }
    }
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    setInterval(() => {
        const sectorGroups = document.querySelectorAll('.pie-sector-group');
        if (sectorGroups.length > 0) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            const hasListeners = sectorGroups[0].onmouseenter !== null;
            if (!hasListeners) {
                
                setupPieChartHover();
            }
        }
    }, 2000);
    
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ–º hover-—ç—Ñ—Ñ–µ–∫—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    setTimeout(() => {
        
        setupPieChartHover();
    }, 1000);
    
    // –¢–∞–∫–∂–µ –∑–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    window.addEventListener('resize', () => {
        setTimeout(() => { setupPieChartHover(); }, 100);
    });
    
    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ hover-—ç—Ñ—Ñ–µ–∫—Ç–æ–≤
    window.setupPieChartHover = setupPieChartHover;
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è remoteStorage –¥–ª—è –æ–±–ª–∞—á–Ω–æ–≥–æ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
    // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
    function initCloudBackup() {
        if (window.remoteStorageAvailable) {
            console.log('üîß Initializing RemoteStorage after library load...');
            // –ù–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ä–∞–∑—É, —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
        } else {
            console.log('üîß RemoteStorage not available, using fallback');
        }
    }
    
    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('load', async () => {
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º RemoteStorage
        await window.loadRemoteStorage();
        // –ó–∞—Ç–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±–ª–∞—á–Ω–æ–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
        initCloudBackup();
    });
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–µ –≤ –ø–æ–ª–µ –∫–∞–º–µ—Ä—ã
    function showCameraErrorMessage(message) {
        const videoContainer = document.querySelector('#photo-search-video').parentElement;
        if (!videoContainer) return;
        
        // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å
        const existingMessage = videoContainer.querySelector('.camera-error-message');
        if (existingMessage) {
            existingMessage.remove();
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        const errorMessage = document.createElement('div');
        errorMessage.className = 'camera-error-message absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-3 py-1.5 rounded-[18px] text-xs font-medium shadow-lg z-10 whitespace-nowrap';
        errorMessage.textContent = message;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–µ–æ
        videoContainer.appendChild(errorMessage);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            if (errorMessage.parentElement) {
                errorMessage.style.opacity = '0';
                errorMessage.style.transition = 'opacity 0.3s ease-out';
                setTimeout(() => {
                    if (errorMessage.parentElement) {
                        errorMessage.remove();
                    }
                }, 300);
            }
        }, 3000);
    }
  </script>

</body>
</html>