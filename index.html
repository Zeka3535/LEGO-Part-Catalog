
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Каталог деталей LEGO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body { font-family: sans-serif; }
    /* Hide scrollbar for Chrome, Safari and Opera */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    /* Hide scrollbar for IE, Edge and Firefox */
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* Checkerboard pattern for transparent parts */
    .checkerboard {
      background-image:
        linear-gradient(45deg, #374151 25%, transparent 25%),
        linear-gradient(-45deg, #374151 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #374151 75%),
        linear-gradient(-45deg, transparent 75%, #374151 75%);
      background-size: 8px 8px;
      background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
    }
    .modal-hidden { display: none !important; }
  </style>
</head>
<body class="bg-gray-900 text-gray-200">

  <!-- Sidebar -->
  <aside id="sidebar-container" class="w-72 bg-gray-800 p-4 flex flex-col h-full border-r border-gray-700 fixed inset-y-0 left-0 z-40 transition-transform duration-300 ease-in-out lg:translate-x-0 -translate-x-full">
    <!-- Sidebar content is rendered by JS -->
  </aside>

  <!-- Backdrop for mobile sidebar -->
  <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-60 z-30 hidden lg:hidden"></div>

  <div class="lg:ml-72 flex flex-col min-h-screen">
    <!-- Header -->
    <header id="header-container" class="bg-gray-800/50 backdrop-blur-sm sticky top-0 z-20 p-4 border-b border-gray-700"></header>
    
    <!-- Main Content -->
    <main id="main-content" class="flex-1 overflow-y-auto no-scrollbar"></main>
  </div>

  <!-- Modal -->
  <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 backdrop-blur-sm modal-hidden"></div>

  <script>
    // --- DATA (from data.js) ---
    const CATEGORIES = [
      { id: 'all', name: 'Все детали' },
      { id: 'brick', name: 'Кирпичи' },
      { id: 'plate', name: 'Пластины' },
      { id: 'tile', name: 'Плитки' },
      { id: 'technic', name: 'Техник' },
      { id: 'window_door', name: 'Окна и двери' },
      { id: 'wheel', name: 'Колёса' },
      { id: 'hinge', name: 'Шарниры' },
      { id: 'minifig', name: 'Минифигурки' },
      { id: 'plant_animal', name: 'Растения и животные' },
    ];

    const CATEGORY_FOLDER_MAP = {
      'brick': 'Кирпичи',
      'plate': 'Пластины',
      'tile': 'Плитки',
      'technic': 'Техник',
      'window_door': 'Окна и Двери',
      'wheel': 'Колёса',
      'hinge': 'Шарниры',
      'minifig': 'Минифигурки',
      'plant_animal': 'Растения и Животные',
    };

    const COLORS = [
      { id: '1', name: 'Синий', hex: '#0055BF' },
      { id: '2', name: 'Зелёный', hex: '#237841' },
      { id: '4', name: 'Красный', hex: '#DA291C' },
      { id: '5', name: 'Тёмно-серый', hex: '#6C6E68' },
      { id: '6', name: 'Светло-серый', hex: '#A0A5A9' },
      { id: '7', name: 'Коричневый', hex: '#583927' },
      { id: '8', name: 'Бежевый', hex: '#E4CD9E' },
      { id: '10', name: 'Белый', hex: '#FFFFFF' },
      { id: '11', name: 'Чёрный', hex: '#05131D' },
      { id: '12', name: 'Жёлтый', hex: '#F2CD37' },
      { id: '13', name: 'Прозрачный', hex: '#FCFCFC', isTransparent: true },
      { id: '14', name: 'Дымчатый', hex: '#635F52', isTransparent: true },
      { id: '15', name: 'Прозрачно-красный', hex: '#C91A09', isTransparent: true },
      { id: '16', name: 'Прозрачно-неоновый зелёный', hex: '#C0F500', isTransparent: true },
      { id: '17', name: 'Прозрачно-голубой', hex: '#AEEFEC', isTransparent: true },
      { id: '18', name: 'Прозрачно-зелёный', hex: '#84B68D', isTransparent: true },
      { id: '19', name: 'Прозрачно-жёлтый', hex: '#F5CD2F', isTransparent: true },
      { id: '20', 'name': 'Прозрачно-тёмно-синий', hex: '#0020A0', isTransparent: true },
      { id: '21', name: 'Лайм', hex: '#97d41e' },
      { id: '34', name: 'Оранжевый', hex: '#FE8A18' },
    ];

    const ALL_PARTS = [
      { id: '3005', name: 'Brick 1 x 1', categoryId: 'brick', availableColorIds: ['1', '2', '4', '5', '6', '10', '11', '12', '21', '34'] },
      { id: '3004', name: 'Brick 1 x 2', categoryId: 'brick', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12', '21', '34'] },
      { id: '3622', name: 'Brick 1 x 3', categoryId: 'brick', availableColorIds: ['1', '2', '4', '6', '10', '11', '12'] },
      { id: '3010', name: 'Brick 1 x 4', categoryId: 'brick', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12', '21'] },
      { id: '3009', name: 'Brick 1 x 6', categoryId: 'brick', availableColorIds: ['1', '2', '4', '5', '6', '10', '11', '12'] },
      { id: '3008', name: 'Brick 1 x 8', categoryId: 'brick', availableColorIds: ['1', '2', '4', '6', '10', '11', '12'] },
      { id: '3001', name: 'Brick 2 x 4', categoryId: 'brick', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12', '21', '34'] },
      { id: '3002', name: 'Brick 2 x 3', categoryId: 'brick', availableColorIds: ['1', '2', '4', '6', '10', '11', '12'] },
      { id: '3003', name: 'Brick 2 x 2', categoryId: 'brick', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12', '21', '34'] },
      { id: '3024', name: 'Plate 1 x 1', categoryId: 'plate', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12', '13', '14', '15', '17', '19', '20'] },
      { id: '3023', name: 'Plate 1 x 2', categoryId: 'plate', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12', '13', '14', '15', '17', '19', '20', '21', '34'] },
      { id: '3623', name: 'Plate 1 x 3', categoryId: 'plate', availableColorIds: ['1', '2', '4', '5', '6', '10', '11', '12'] },
      { id: '3710', name: 'Plate 1 x 4', categoryId: 'plate', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12', '21', '34'] },
      { id: '3666', name: 'Plate 1 x 6', categoryId: 'plate', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12'] },
      { id: '3020', name: 'Plate 2 x 4', categoryId: 'plate', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12', '21'] },
      { id: '3022', name: 'Plate 2 x 2', categoryId: 'plate', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12', '21'] },
      { id: '3795', name: 'Plate 2 x 6', categoryId: 'plate', availableColorIds: ['1', '2', '4', '5', '6', '10', '11', '12'] },
      { id: '3034', name: 'Plate 2 x 8', categoryId: 'plate', availableColorIds: ['1', '2', '4', '6', '10', '11', '12'] },
      { id: '3031', name: 'Plate 4 x 4', categoryId: 'plate', availableColorIds: ['1', '2', '4', '6', '10', '11', '12'] },
      { id: '3811', name: 'Plate 32 x 32 Baseplate', categoryId: 'plate', availableColorIds: ['2', '6', '8'] },
      { id: '3070b', name: 'Tile 1 x 1', categoryId: 'tile', availableColorIds: ['1', '2', '4', '5', '6', '10', '11', '12', '21'] },
      { id: '3069b', name: 'Tile 1 x 2', categoryId: 'tile', availableColorIds: ['1', '2', '4', '5', '6', '7', '8', '10', '11', '12'] },
      { id: '63864', name: 'Tile 1 x 3', categoryId: 'tile', availableColorIds: ['1', '2', '4', '6', '10', '11', '12'] },
      { id: '2431', name: 'Tile 1 x 4', categoryId: 'tile', availableColorIds: ['1', '2', '4', '5', '6', '10', '11', '12'] },
      { id: '3068b', name: 'Tile 2 x 2', categoryId: 'tile', availableColorIds: ['1', '2', '4', '5', '6', '10', '11', '12'] },
      { id: '3245c', name: 'Technic Brick 1 x 2 with Hole', categoryId: 'technic', availableColorIds: ['1', '2', '4', '6', '10', '11', '12'] },
      { id: '2780', name: 'Technic Pin with Friction', categoryId: 'technic', availableColorIds: ['1', '11'] },
      { id: '32062', name: 'Technic Axle 2 Notched', categoryId: 'technic', availableColorIds: ['4', '6', '12'] },
      { id: '3713', name: 'Technic Bush', categoryId: 'technic', availableColorIds: ['4', '6', '12'] },
      { id: '32523', name: 'Technic Beam 1 x 3 Thick', categoryId: 'technic', availableColorIds: ['1', '4', '5', '6', '10', '11', '12'] },
      { id: '60483', name: 'Technic Beam 1 x 2 Thick with Pin Hole', categoryId: 'technic', availableColorIds: ['5', '6', '11'] },
      { id: '6541', name: 'Technic Beam 1 x 1 Thick', categoryId: 'technic', availableColorIds: ['1', '5', '6', '10', '11', '12'] },
      { id: '64782', name: 'Window 1 x 2 x 2', categoryId: 'window_door', availableColorIds: ['1', '4', '7', '8', '10', '11'] },
    ];
    
    // --- APP LOGIC (from index.tsx) ---
    
    // --- DATA MAPS ---
    const COLOR_MAP = COLORS.reduce((acc, color) => {
      acc[color.id] = color;
      return acc;
    }, {});

    const PART_MAP = ALL_PARTS.reduce((acc, part) => {
      acc[part.id] = part;
      return acc;
    }, {});

    // --- ICONS ---
    const CatalogIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>`;
    const CollectionIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polygon points="2 17 12 22 22 17"></polygon><polygon points="2 12 12 17 22 12"></polygon></svg>`;
    const FolderIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2z"></path></svg>`;
    const PlusIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
    const MinusIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>`;
    const XIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`;
    const MenuIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`;
    const UploadIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>`;
    const DownloadIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>`;
    const ImageIcon = (className) => `<svg xmlns="http://www.w3.org/2000/svg" class="${className}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`;

    // --- STATE MANAGEMENT ---
    let state = {
      currentView: 'catalog',
      selectedCategory: 'all',
      searchQuery: '',
      selectedPartId: null,
      isSidebarOpen: window.innerWidth >= 1024,
      modal: {
          selectedColorId: null,
          quantity: 1,
      },
      collection: {},
      importExportStatus: { message: '', type: '' }, // 'success' or 'error'
    };

    function loadState() {
      const savedCollection = localStorage.getItem('legoCollection');
      if (savedCollection) {
        try {
          const parsed = JSON.parse(savedCollection);
          if (typeof parsed === 'object' && parsed !== null) {
            state.collection = parsed;
          } else {
            state.collection = {};
          }
        } catch (e) {
          console.error("Failed to parse lego collection from localStorage", e);
          state.collection = {};
        }
      }
    }

    function saveState() {
      localStorage.setItem('legoCollection', JSON.stringify(state.collection));
    }

    // --- DOM Elements ---
    const sidebarContainer = document.getElementById('sidebar-container');
    const sidebarBackdrop = document.getElementById('sidebar-backdrop');
    const headerContainer = document.getElementById('header-container');
    const mainContent = document.getElementById('main-content');
    const modalContainer = document.getElementById('modal-container');

    // --- RENDER FUNCTIONS ---
    function getPartImageUrl(part, colorId) {
        const categoryFolder = CATEGORY_FOLDER_MAP[part.categoryId];
        if (!categoryFolder) {
            // Fallback for categories without a mapped folder
            const fallbackColor = COLOR_MAP[colorId];
            const displayColorId = fallbackColor && fallbackColor.isTransparent ? '13' : '6';
            const url1 = `https://img.bricklink.com/ItemImage/PN/${displayColorId}/${part.id}.png`;
            const url2 = `https://img.bricklink.com/P/${displayColorId}/${part.id}.gif`;
            return `src="${url1}" onerror="this.onerror=null; this.src='${url2}';"`;
        }
    
        const fileName = `${part.id}-${part.name}.png`;
        const localUrl = `lego_parts/${categoryFolder}/${fileName}`;
    
        // Fallback URLs
        const color = COLOR_MAP[colorId];
        const displayColorId = color && color.isTransparent ? '13' : '6';
        const fallbackUrl1 = `https://img.bricklink.com/ItemImage/PN/${displayColorId}/${part.id}.png`;
        const fallbackUrl2 = `https://img.bricklink.com/P/${displayColorId}/${part.id}.gif`;
        
        // Try local, then fallback1, then fallback2
        const onErrorLogic = `this.onerror=null; this.src='${fallbackUrl1}'; this.onerror=function(){this.onerror=null; this.src='${fallbackUrl2}';};`;
        return `src="${localUrl}" onerror="${onErrorLogic}"`;
    }

    function renderSidebar() {
      const { uniqueModelsCount, totalPartsCount } = Object.keys(state.collection).reduce((acc, partId) => {
        acc.uniqueModelsCount += Object.keys(state.collection[partId] || {}).length;
        acc.totalPartsCount += Object.values(state.collection[partId] || {}).reduce((sum, q) => sum + q, 0);
        return acc;
      }, { uniqueModelsCount: 0, totalPartsCount: 0 });

      const viewButtonStyle = (view) => `w-1/2 flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-md transition-colors duration-150 ${state.currentView === view ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}`;

      sidebarContainer.innerHTML = `
        <div class="flex items-center justify-between mb-4 flex-shrink-0">
          <h1 class="text-xl font-bold text-white">Меню</h1>
          <button id="sidebar-close" class="lg:hidden text-gray-400 hover:text-white p-1">
            ${XIcon('w-6 h-6')}
          </button>
        </div>

        <div class="flex bg-gray-900/70 rounded-lg p-1 mb-4 flex-shrink-0">
          <button data-view="catalog" class="${viewButtonStyle('catalog')}">${CatalogIcon('w-5 h-5 mr-2')} Каталог</button>
          <button data-view="collection" class="${viewButtonStyle('collection')}">${CollectionIcon('w-5 h-5 mr-2')} Коллекция</button>
        </div>
        
        <div class="flex-grow overflow-y-auto no-scrollbar">
          <h2 class="text-lg font-semibold text-white mb-4">Категории</h2>
          <nav>
            <ul id="category-list">
              ${CATEGORIES.map(cat => `
                <li class="mb-2">
                  <button data-category-id="${cat.id}" class="w-full text-left flex items-center px-3 py-2 rounded-md transition-colors duration-150 ${state.selectedCategory === cat.id ? 'bg-blue-600 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'}">
                    ${FolderIcon('w-5 h-5 mr-3')}
                    <span>${cat.name}</span>
                  </button>
                </li>
              `).join('')}
            </ul>
          </nav>
        </div>
        
        <div class="flex-shrink-0 mt-4 border-t border-gray-700 pt-4">
            <h2 class="text-lg font-semibold text-white mb-2">Сводка коллекции</h2>
            ${totalPartsCount === 0 ? '<p class="text-gray-400 text-sm">Ваша коллекция пуста.</p>' : `
              <div class="space-y-2 text-sm">
                  <div class="flex justify-between"><span class="text-gray-400">Уникальные модели:</span><span class="font-bold text-white">${uniqueModelsCount}</span></div>
                  <div class="flex justify-between"><span class="text-gray-400">Всего деталей:</span><span class="font-bold text-white">${totalPartsCount}</span></div>
              </div>
            `}
        </div>

        <div class="flex-shrink-0 mt-4 border-t border-gray-700 pt-4">
            <h2 class="text-lg font-semibold text-white mb-2">Управление данными</h2>
            <div class="space-y-2">
                <button id="import-button" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-md transition-colors duration-150 bg-gray-600 hover:bg-gray-500 text-white">
                    ${UploadIcon('w-5 h-5 mr-2')} Импорт .zip
                </button>
                <input type="file" id="import-zip-input" class="hidden" accept=".zip">
                <button id="export-button" class="w-full flex items-center justify-center px-3 py-2 text-sm font-semibold rounded-md transition-colors duration-150 bg-gray-600 hover:bg-gray-500 text-white ${totalPartsCount === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${totalPartsCount === 0 ? 'disabled' : ''}>
                    ${DownloadIcon('w-5 h-5 mr-2')} Экспорт .zip
                </button>
            </div>
            ${state.importExportStatus.message ? `
              <div id="import-export-status" class="mt-3 p-2 text-sm rounded-md ${state.importExportStatus.type === 'error' ? 'bg-red-900/50 text-red-300' : 'bg-green-900/50 text-green-300'}">
                ${state.importExportStatus.message}
              </div>
            ` : ''}
        </div>
      `;
    }

    function renderHeader() {
        headerContainer.innerHTML = `
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <button id="sidebar-toggle" class="lg:hidden text-gray-300 hover:text-white mr-4 -ml-1 p-1">
                        ${MenuIcon('w-6 h-6')}
                    </button>
                    <h1 class="text-xl font-bold text-white hidden sm:block">LEGO® Part Catalog</h1>
                </div>
                <div class="relative w-full max-w-[150px] sm:max-w-xs">
                    <input id="search-input" type="text" placeholder="Поиск..." value="${state.searchQuery}" class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                </div>
            </div>
        `;
    }

    function renderPartCard(part, color, quantity) {
        return `
            <div data-part-id="${part.id}" class="part-card relative bg-gray-800 rounded-lg overflow-hidden cursor-pointer group transform transition-all duration-300 hover:scale-105 hover:bg-gray-700">
                ${quantity > 0 ? `<div class="absolute top-2 right-2 bg-blue-600 text-white text-xs font-bold rounded-full w-6 h-6 flex items-center justify-center z-10 shadow-md">${quantity}</div>` : ''}
                <div class="w-full h-40 bg-gray-700 flex items-center justify-center p-4 pointer-events-none">
                    <img ${getPartImageUrl(part, color.id)} alt="${part.name}" class="w-full h-full object-contain" loading="lazy" />
                </div>
                <div class="p-4 pointer-events-none">
                    <h3 class="text-sm font-semibold text-white truncate">${part.name}</h3>
                    <p class="text-xs text-gray-400">ID: ${part.id}</p>
                </div>
            </div>
        `;
    }

    function renderGrid() {
        let content = '';
        if (state.currentView === 'catalog') {
            const parts = ALL_PARTS.filter(part => {
                const catMatch = state.selectedCategory === 'all' || part.categoryId === state.selectedCategory;
                const searchMatch = state.searchQuery.trim() === '' || 
                    part.name.toLowerCase().includes(state.searchQuery.toLowerCase()) || 
                    part.id.toLowerCase().includes(state.searchQuery.toLowerCase());
                return catMatch && searchMatch;
            });

            if (parts.length === 0) {
                content = `<div class="flex items-center justify-center h-full p-4 text-center"><p class="text-gray-400">Детали не найдены в каталоге. Попробуйте другой поиск или категорию.</p></div>`;
            } else {
                const defaultColor = COLOR_MAP['6'] || COLOR_MAP['11'];
                content = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 p-4">
                    ${parts.map(p => renderPartCard(p, defaultColor, 0)).join('')}
                </div>`;
            }
        } else { // Collection view
            const items = [];
            for (const partId in state.collection) {
              for (const colorId in state.collection[partId]) {
                const part = PART_MAP[partId];
                const color = COLOR_MAP[colorId];
                const quantity = state.collection[partId][colorId];
                if (part && color && quantity > 0) {
                  items.push({ part, color, quantity });
                }
              }
            }
            
            const filteredItems = items.filter(({ part }) => {
                const catMatch = state.selectedCategory === 'all' || part.categoryId === state.selectedCategory;
                const searchMatch = state.searchQuery.trim() === '' ||
                    part.name.toLowerCase().includes(state.searchQuery.toLowerCase()) ||
                    part.id.toLowerCase().includes(state.searchQuery.toLowerCase());
                return catMatch && searchMatch;
            }).sort((a,b) => a.part.name.localeCompare(b.part.name));

            if (filteredItems.length === 0) {
                content = `<div class="flex items-center justify-center h-full p-4 text-center"><p class="text-gray-400">В вашей коллекции нет деталей, соответствующих фильтру.<br/>Попробуйте изменить поиск или категорию.</p></div>`;
            } else {
                content = `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 2xl:grid-cols-6 gap-4 p-4">
                    ${filteredItems.map(item => renderPartCard(item.part, item.color, item.quantity)).join('')}
                </div>`;
            }
        }
        mainContent.innerHTML = content;
    }

    function renderModal() {
        if (!state.selectedPartId) {
            modalContainer.classList.add('modal-hidden');
            document.body.classList.remove('overflow-hidden');
            modalContainer.innerHTML = '';
            return;
        }

        const part = PART_MAP[state.selectedPartId];
        if (!part) {
            state.selectedPartId = null; // Reset if part not found
            updateUI();
            return;
        }

        const { selectedColorId, quantity } = state.modal;
        const selectedColor = selectedColorId ? COLOR_MAP[selectedColorId] : null;
        const currentInCollection = (state.selectedPartId && selectedColorId && state.collection[state.selectedPartId] && state.collection[state.selectedPartId][selectedColorId]) || 0;
        
        document.body.classList.add('overflow-hidden');
        modalContainer.innerHTML = `
        <div id="modal-content" class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl m-4 flex flex-col md:flex-row relative">
            <button id="modal-close" class="absolute top-3 right-3 text-gray-400 hover:text-white transition-colors z-10">${XIcon('w-6 h-6')}</button>
            
            <div class="md:w-1/2 p-6 bg-gray-700/50 rounded-l-lg flex items-center justify-center">
                <img ${getPartImageUrl(part, selectedColorId || part.availableColorIds[0])} alt="${part.name}" class="max-w-full max-h-64 object-contain">
            </div>
            
            <div class="md:w-1/2 p-6 flex flex-col">
                <h2 class="text-2xl font-bold text-white">${part.name}</h2>
                <p class="text-sm text-gray-400 mb-4">ID: ${part.id}</p>
                
                <div class="flex-grow">
                    <h3 class="text-md font-semibold text-gray-300 mb-2">Доступные цвета</h3>
                    <div id="color-selector" class="grid grid-cols-6 gap-2 mb-4">
                        ${part.availableColorIds.map(cid => {
                            const color = COLOR_MAP[cid];
                            if (!color) return '';
                            const isInCollection = state.collection[part.id] && state.collection[part.id][cid] > 0;
                            return `
                                <button data-color-id="${cid}" title="${color.name}" class="w-10 h-10 rounded-full border-2 transition-transform duration-150 overflow-hidden ${color.isTransparent ? 'checkerboard' : ''} ${selectedColorId === cid ? 'border-blue-500 scale-110' : 'border-gray-600 hover:border-gray-400'}" style="background-color: ${color.hex};">
                                    ${isInCollection ? '<div class="w-2 h-2 bg-white rounded-full m-auto"></div>' : ''}
                                </button>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                ${selectedColor ? `
                    <div class="bg-gray-700/50 rounded-lg p-4 mt-auto">
                        <div class="grid grid-cols-2 gap-x-4 gap-y-3 items-center">
                            <!-- Row 1 -->
                            <p class="text-white font-semibold">${selectedColor.name}</p>
                            <p class="text-sm text-gray-400 text-right">В коллекции: <span class="font-bold text-white">${currentInCollection}</span></p>
                            
                            <!-- Row 2 -->
                            <div class="flex items-center gap-2">
                                <button data-action="decrease-qty" class="p-2 rounded-full bg-gray-600 hover:bg-gray-500 text-white transition-colors">${MinusIcon('w-5 h-5')}</button>
                                <input type="number" value="${quantity}" readonly class="w-12 text-center bg-gray-900 text-white font-bold rounded-md py-1"/>
                                <button data-action="increase-qty" class="p-2 rounded-full bg-gray-600 hover:bg-gray-500 text-white transition-colors">${PlusIcon('w-5 h-5')}</button>
                            </div>
                            <button data-action="update-collection" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                                ${currentInCollection > 0 ? 'Обновить' : 'Добавить'}
                            </button>
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
        `;
        modalContainer.classList.remove('modal-hidden');
    }

    function updateUI() {
        if (!sidebarContainer || !headerContainer || !mainContent || !modalContainer) {
            console.error("One or more main containers are missing from the DOM!");
            return;
        }
        renderSidebar();
        renderHeader();
        renderGrid();
        renderModal();

        const isMobile = window.innerWidth < 1024;
        if (isMobile) {
            if (state.isSidebarOpen) {
                sidebarContainer.classList.remove('-translate-x-full');
                sidebarBackdrop.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            } else {
                sidebarContainer.classList.add('-translate-x-full');
                sidebarBackdrop.classList.add('hidden');
                document.body.style.overflow = '';
            }
        } else {
            sidebarContainer.classList.remove('-translate-x-full');
            sidebarBackdrop.classList.add('hidden');
            document.body.style.overflow = '';
        }
    }

    // --- IMPORT/EXPORT HANDLING ---
    async function handleZipImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        state.importExportStatus = { message: 'Обработка файла...', type: 'success' };
        updateUI();

        try {
            const jszip = new JSZip();
            const zip = await jszip.loadAsync(file);
            const collectionFile = zip.file('collection.json');

            if (!collectionFile) {
                throw new Error("Файл 'collection.json' не найден в архиве.");
            }

            const content = await collectionFile.async('string');
            const importedCollection = JSON.parse(content);

            let mergedCount = 0;
            // Merge logic: add quantities from imported collection
            for (const partId in importedCollection) {
                if (!state.collection[partId]) {
                    state.collection[partId] = {};
                }
                for (const colorId in importedCollection[partId]) {
                    const quantity = importedCollection[partId][colorId];
                    if (typeof quantity === 'number' && quantity > 0) {
                        state.collection[partId][colorId] = (state.collection[partId][colorId] || 0) + quantity;
                        mergedCount++;
                    }
                }
            }
            
            saveState();
            state.importExportStatus = { message: `Импорт успешен! Добавлено ${mergedCount} записей.`, type: 'success' };
        } catch (error) {
            console.error("Import failed:", error);
            state.importExportStatus = { message: `Ошибка импорта: ${error.message}`, type: 'error' };
        } finally {
            event.target.value = ''; // Reset file input
            updateUI();
        }
    }

    async function handleExportCollection() {
        state.importExportStatus = { message: '', type: '' };
        if (Object.keys(state.collection).length === 0) {
            state.importExportStatus = { message: 'Коллекция пуста для экспорта.', type: 'error' };
            updateUI();
            return;
        }

        try {
            const jszip = new JSZip();
            const jsonString = JSON.stringify(state.collection, null, 2);
            jszip.file("collection.json", jsonString);
            
            const blob = await jszip.generateAsync({ type: "blob" });
            
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `lego-collection-${new Date().toISOString().slice(0,10)}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            state.importExportStatus = { message: 'Экспорт начался.', type: 'success' };
        } catch (error) {
            console.error("Export failed:", error);
            state.importExportStatus = { message: `Ошибка экспорта: ${error.message}`, type: 'error' };
        }
        updateUI();
    }

    // --- EVENT HANDLING ---
    function handleUpdateCollection(partId, colorId, quantity) {
        if (!state.collection[partId]) {
            state.collection[partId] = {};
        }
        if (quantity > 0) {
            state.collection[partId][colorId] = quantity;
        } else {
            delete state.collection[partId][colorId];
            if (Object.keys(state.collection[partId]).length === 0) {
                delete state.collection[partId];
            }
        }
        state.importExportStatus = { message: '', type: '' };
        saveState();
        updateUI();
    }
    
    function clearStatusOnClick() {
        if(state.importExportStatus.message) {
            state.importExportStatus = { message: '', type: '' };
            renderSidebar(); // Just re-render sidebar to clear message
        }
    }

    document.addEventListener('click', (e) => {
        if (!(e.target instanceof Element)) {
            return;
        }
        const target = e.target;
        const isMobile = window.innerWidth < 1024;

        if (target.closest('#sidebar-toggle')) {
            clearStatusOnClick();
            state.isSidebarOpen = true;
            updateUI();
            return;
        }
        if (target.closest('#sidebar-close') || target.id === 'sidebar-backdrop') {
            state.isSidebarOpen = false;
            updateUI();
            return;
        }

        const viewButton = target.closest('[data-view]');
        if (viewButton instanceof HTMLElement && viewButton.dataset.view) {
            clearStatusOnClick();
            state.currentView = viewButton.dataset.view;
            if (isMobile) { state.isSidebarOpen = false; }
            updateUI();
            return;
        }
        const categoryButton = target.closest('[data-category-id]');
        if (categoryButton instanceof HTMLElement && categoryButton.dataset.categoryId) {
            clearStatusOnClick();
            state.selectedCategory = categoryButton.dataset.categoryId;
            if (isMobile) { state.isSidebarOpen = false; }
            updateUI();
            return;
        }

        const partCard = target.closest('.part-card');
        if (partCard instanceof HTMLElement && mainContent.contains(partCard) && partCard.dataset.partId) {
            clearStatusOnClick();
            state.selectedPartId = partCard.dataset.partId;
            const part = PART_MAP[state.selectedPartId];
            if (part) {
                state.modal.selectedColorId = part.availableColorIds[0] || null;
                const currentQuantity = (state.modal.selectedColorId && state.collection[part.id] && state.collection[part.id][state.modal.selectedColorId]) || 0;
                state.modal.quantity = currentQuantity > 0 ? currentQuantity : 1;
            }
            updateUI();
            return;
        }
        
        if (target.id === 'modal-container' || target.closest('#modal-close')) {
            state.selectedPartId = null;
            updateUI();
            return;
        }

        if (target.closest('#import-button')) {
            document.getElementById('import-zip-input')?.click();
            return;
        }

        if (target.closest('#export-button')) {
            handleExportCollection();
            return;
        }

        const modalContent = document.getElementById('modal-content');
        if (modalContent && modalContent.contains(target)) {
             const colorButton = target.closest('[data-color-id]');
            if (colorButton instanceof HTMLElement && colorButton.dataset.colorId) {
                state.modal.selectedColorId = colorButton.dataset.colorId;
                let currentQuantity = 0;
                if (state.selectedPartId && state.modal.selectedColorId) {
                    currentQuantity = (state.collection[state.selectedPartId] && state.collection[state.selectedPartId][state.modal.selectedColorId]) || 0;
                }
                state.modal.quantity = currentQuantity > 0 ? currentQuantity : 1;
                renderModal();
                return;
            }

            const actionButton = target.closest('[data-action]');
            if (actionButton instanceof HTMLElement && actionButton.dataset.action) {
                const action = actionButton.dataset.action;
                if (action === 'increase-qty') {
                    state.modal.quantity++;
                } else if (action === 'decrease-qty') {
                    state.modal.quantity = Math.max(0, state.modal.quantity - 1);
                } else if (action === 'update-collection' && state.modal.selectedColorId && state.selectedPartId) {
                    handleUpdateCollection(state.selectedPartId, state.modal.selectedColorId, state.modal.quantity);
                    return;
                }
                renderModal();
            }
        }
    });

    document.addEventListener('input', (e) => {
        if (e.target instanceof HTMLInputElement && e.target.id === 'search-input') {
            clearStatusOnClick();
            state.searchQuery = e.target.value;
            renderGrid();
        }
    });

    document.addEventListener('change', (e) => {
        if (e.target instanceof HTMLInputElement && e.target.id === 'import-zip-input') {
            handleZipImport(e);
        }
    });

    document.addEventListener('keyup', (e) => {
        if (e.target instanceof HTMLInputElement && e.target.id === 'search-input' && e.key === 'Enter') {
            e.target.blur();
        }
    });

    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            const isDesktop = window.innerWidth >= 1024;
            if (isDesktop) {
                state.isSidebarOpen = true;
            }
            updateUI();
        }, 100);
    });

    // --- INITIALIZATION ---
    loadState();
    updateUI();
  </script>
</body>
</html>
